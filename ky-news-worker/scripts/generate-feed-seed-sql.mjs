import fs from "node:fs";
import path from "node:path";

const workerDir = path.resolve(process.cwd());
const repoRoot = path.resolve(workerDir, "..");
const feedsJsonPath = path.join(repoRoot, "feeds.seed.json");
const outPath = path.join(workerDir, "migrations", "0002_seed_feeds.sql");

if (!fs.existsSync(feedsJsonPath)) {
  console.error(`Missing feeds seed file at ${feedsJsonPath}`);
  process.exit(1);
}

const feeds = JSON.parse(fs.readFileSync(feedsJsonPath, "utf8"));
if (!Array.isArray(feeds)) {
  console.error("feeds.seed.json must be an array");
  process.exit(1);
}

function q(value) {
  if (value == null) return "NULL";
  const str = String(value).replace(/'/g, "''");
  return `'${str}'`;
}

const lines = [];
lines.push("-- Auto-generated by scripts/generate-feed-seed-sql.mjs");
lines.push("BEGIN TRANSACTION;");

for (const feed of feeds) {
  lines.push(`
INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  ${q(feed.id)},
  ${q(feed.name)},
  ${q(feed.category)},
  ${q(feed.url)},
  ${q(feed.state_code || "KY")},
  ${q(feed.default_county ?? null)},
  ${q(feed.region_scope || "ky")},
  ${Number(feed.enabled ?? 1)}
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;`);
}

lines.push("COMMIT;");

fs.writeFileSync(outPath, `${lines.join("\n")}\n`, "utf8");
console.log(`Wrote ${outPath} with ${feeds.length} feeds.`);

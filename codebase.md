# .gitignore

```
node_modules
dist
.data
data/*.sqlite
data/*.sqlite-*
data/uploads/
.env

```

# ads.txt

```txt
google.com, pub-9584112930078020, DIRECT, f08c47fec0942fa0

```

# API_DETAILS.md

```md
# API Details

Canonical API documentation:

- `docs/04_API_SPEC.md`
- Weather: `docs/07_WEATHER_SPEC.md`
- Lost and Found: `docs/08_LOST_FOUND_SPEC.md`

```

# apps\api\package.json

```json
{
  "name": "@local-ky-news/api",
  "private": true,
  "type": "module",
  "version": "0.1.0",
  "scripts": {
    "dev": "node --watch src/server.mjs"
  },
  "dependencies": {
    "@fastify/cors": "^10.0.0",
    "better-sqlite3": "^11.0.0",
    "fastify": "^5.0.0",
    "zod": "^3.23.0",
    "@fastify/sensible": "^6.0.0"
  }
}
```

# apps\api\src\db.mjs

```mjs
import path from "node:path";
import { fileURLToPath } from "node:url";
import Database from "better-sqlite3";

const moduleDir = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(moduleDir, "..", "..", "..");

function defaultDbPath() {
  return path.resolve(repoRoot, "data", "dev.sqlite");
}

const DB_PATH = process.env.DB_PATH ? path.resolve(process.env.DB_PATH) : defaultDbPath();

export function openDb() {
  const db = new Database(DB_PATH);
  db.pragma("journal_mode = WAL");
  return db;
}

```

# apps\api\src\lostFound.mjs

```mjs
import path from "node:path";
import fs from "node:fs/promises";
import { randomUUID } from "node:crypto";
import { z } from "zod";
import { ensureSchema } from "./schema.mjs";
import { normalizeCounty } from "./search.mjs";
import {
  decryptText,
  encryptText,
  enforceSubmissionRateLimit,
  getAdminIdentity,
  hashIp,
  insertAdminLog,
  requireAdmin
} from "./security.mjs";

const LOST_FOUND_TYPES = ["lost", "found"];
const LOST_FOUND_STATUSES = ["pending", "approved", "rejected", "published", "resolved"];
const COMMENT_URL_RE = /(?:https?:\/\/|www\.)\S+/gi;
const COMMENT_MAX_URLS = 1;
const COMMENT_RATE_LIMIT = 8;
const COMMENT_RATE_WINDOW_MS = 60 * 60 * 1000;
const MARK_FOUND_RATE_LIMIT = 12;
const MARK_FOUND_RATE_WINDOW_MS = 60 * 60 * 1000;
const COMMENT_BLOCKLIST = [
  /\bfuck(?:ing|ed|er|s)?\b/i,
  /\bshit(?:ty|ting|ted|s)?\b/i,
  /\basshole(?:s)?\b/i,
  /\bbitch(?:es|y)?\b/i,
  /\bbastard(?:s)?\b/i,
  /\bkill\s+yourself\b/i,
  /\bi\s+will\s+kill\s+you\b/i
];
const commentRate = new Map();
const markFoundRate = new Map();

function deriveExt(mimeType) {
  const map = {
    "image/jpeg": "jpg",
    "image/jpg": "jpg",
    "image/png": "png",
    "image/webp": "webp",
    "image/gif": "gif"
  };
  return map[String(mimeType || "").toLowerCase()] || null;
}

function mapLostFoundRow(row, { includeContact = false } = {}) {
  const images = String(row.images_csv || "")
    .split(",")
    .map((v) => v.trim())
    .filter(Boolean);

  const contact_email = includeContact || Number(row.show_contact) === 1 ? decryptText(row.contact_email_encrypted) : null;

  return {
    id: row.id,
    type: row.type,
    title: row.title,
    description: row.description,
    county: row.county,
    state_code: row.state_code,
    status: row.status,
    show_contact: Number(row.show_contact) === 1,
    contact_email,
    submitted_at: row.submitted_at,
    approved_at: row.approved_at,
    rejected_at: row.rejected_at,
    is_resolved: Number(row.is_resolved) === 1,
    resolved_at: row.resolved_at,
    resolved_note: row.resolved_note,
    comment_count: Number(row.comment_count || 0),
    expires_at: row.expires_at,
    moderation_note: row.moderation_note,
    images
  };
}

function mapCommentRow(row) {
  return {
    id: row.id,
    post_id: row.post_id,
    name: row.commenter_name,
    comment: row.comment_text,
    created_at: row.created_at
  };
}

function mapAdminCommentRow(row) {
  return {
    id: row.id,
    post_id: row.post_id,
    post_title: row.post_title || null,
    name: row.commenter_name,
    comment: row.comment_text,
    created_at: row.created_at,
    commenter_email_hash: row.commenter_email_hash,
    commenter_ip_hash: row.commenter_ip_hash
  };
}

function mapCommentBanRow(row) {
  return {
    id: row.id,
    target_type: row.target_type,
    reason: row.reason || null,
    banned_by_email: row.banned_by_email,
    source_comment_id: row.source_comment_id || null,
    created_at: row.created_at
  };
}

function findLostFoundCommentBan(db, emailHash, ipHash) {
  return db
    .prepare(
      `
      SELECT id, target_type, reason
      FROM lost_found_comment_bans
      WHERE (target_type='email' AND target_hash=@emailHash)
         OR (target_type='ip' AND target_hash=@ipHash)
      ORDER BY created_at DESC
      LIMIT 1
      `
    )
    .get({ emailHash, ipHash });
}

function normalizeCommentText(text) {
  return String(text || "").replace(/\s+/g, " ").trim();
}

function countCommentUrls(text) {
  const matches = String(text || "").match(COMMENT_URL_RE);
  return matches ? matches.length : 0;
}

function hasBlockedCommentLanguage(text) {
  const value = String(text || "");
  return COMMENT_BLOCKLIST.some((re) => re.test(value));
}

function enforceCommentRateLimit(ip) {
  const key = String(ip || "unknown");
  const now = Date.now();
  const existing = commentRate.get(key) || [];
  const next = existing.filter((ts) => now - ts < COMMENT_RATE_WINDOW_MS);
  if (next.length >= COMMENT_RATE_LIMIT) {
    commentRate.set(key, next);
    return false;
  }
  next.push(now);
  commentRate.set(key, next);
  return true;
}

function enforceMarkFoundRateLimit(ip) {
  const key = String(ip || "unknown");
  const now = Date.now();
  const existing = markFoundRate.get(key) || [];
  const next = existing.filter((ts) => now - ts < MARK_FOUND_RATE_WINDOW_MS);
  if (next.length >= MARK_FOUND_RATE_LIMIT) {
    markFoundRate.set(key, next);
    return false;
  }
  next.push(now);
  markFoundRate.set(key, next);
  return true;
}

export function registerLostFoundRoutes(app, openDb, uploadDir) {
  app.get("/api/uploads/lost-found/:key", async (req, reply) => {
    const key = decodeURIComponent(String(req.params?.key || ""));
    if (!/^[a-zA-Z0-9/_\-.]+$/.test(key) || key.includes("..")) {
      return app.httpErrors.badRequest("Invalid object key");
    }

    const filePath = path.join(uploadDir, key);
    try {
      const buf = await fs.readFile(filePath);
      const lower = key.toLowerCase();
      const type = lower.endsWith(".png")
        ? "image/png"
        : lower.endsWith(".webp")
          ? "image/webp"
          : lower.endsWith(".gif")
            ? "image/gif"
            : "image/jpeg";
      reply.header("content-type", type);
      return reply.send(buf);
    } catch {
      return app.httpErrors.notFound("Image not found");
    }
  });

  const UploadUrlBody = z.object({
    filename: z.string().min(1).max(180),
    mimeType: z.string().min(3).max(80)
  });

  app.post("/api/uploads/lost-found-url", async (req) => {
    const parsed = UploadUrlBody.safeParse(req.body ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid payload");

    const ext = deriveExt(parsed.data.mimeType);
    if (!ext) return app.httpErrors.badRequest("Unsupported file type");

    const objectKey = `${new Date().toISOString().slice(0, 10)}-${randomUUID()}.${ext}`;
    return {
      objectKey,
      uploadUrl: `/api/uploads/lost-found/${encodeURIComponent(objectKey)}`,
      method: "PUT",
      headers: {
        "content-type": parsed.data.mimeType
      },
      maxBytes: 8 * 1024 * 1024
    };
  });

  app.put("/api/uploads/lost-found/:key", async (req) => {
    const key = decodeURIComponent(String(req.params?.key || ""));
    if (!/^[a-zA-Z0-9/_\-.]+$/.test(key) || key.includes("..")) {
      return app.httpErrors.badRequest("Invalid object key");
    }

    const body = req.body;
    if (!Buffer.isBuffer(body)) {
      return app.httpErrors.badRequest("Binary body required");
    }

    if (body.length > 8 * 1024 * 1024) {
      return app.httpErrors.badRequest("File too large");
    }

    const filePath = path.join(uploadDir, key);
    await fs.mkdir(path.dirname(filePath), { recursive: true });
    await fs.writeFile(filePath, body);

    return { ok: true, objectKey: key, bytes: body.length };
  });

  const LostFoundListQuery = z.object({
    type: z.enum(LOST_FOUND_TYPES).optional(),
    county: z.string().min(2).max(80).optional(),
    status: z.enum(LOST_FOUND_STATUSES).default("published"),
    limit: z.coerce.number().min(1).max(100).default(40)
  });

  app.get("/api/lost-found", async (req) => {
    const parsed = LostFoundListQuery.safeParse(req.query ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

    const admin = getAdminIdentity(req);
    const db = openDb();

    try {
      ensureSchema(db);

      const where = ["datetime(p.expires_at) > datetime('now')"];
      const params = { limit: parsed.data.limit };

      if (!admin && parsed.data.status !== "published") {
        return app.httpErrors.unauthorized("Only published lost-and-found posts are public");
      }

      if (parsed.data.status === "published") {
        where.push("p.status = 'approved'");
        where.push("COALESCE(p.is_resolved, 0) = 0");
      } else if (parsed.data.status === "resolved") {
        where.push("p.status = 'approved'");
        where.push("COALESCE(p.is_resolved, 0) = 1");
      } else {
        where.push("p.status = @status");
        params.status = parsed.data.status;
      }

      if (parsed.data.type) {
        where.push("p.type = @type");
        params.type = parsed.data.type;
      }

      if (parsed.data.county) {
        where.push("p.county = @county");
        params.county = normalizeCounty(parsed.data.county);
      }

      const rows = db
        .prepare(
          `
          SELECT
            p.*,
            (
              SELECT group_concat(i.r2_key)
              FROM lost_found_images i
              WHERE i.post_id = p.id
            ) AS images_csv,
            (
              SELECT COUNT(1)
              FROM lost_found_comments c
              WHERE c.post_id = p.id
            ) AS comment_count
          FROM lost_found_posts p
          WHERE ${where.join(" AND ")}
          ORDER BY p.submitted_at DESC
          LIMIT @limit
        `
        )
        .all(params);

      return {
        posts: rows.map((r) => mapLostFoundRow(r, { includeContact: Boolean(admin) })),
        status: parsed.data.status,
        county: parsed.data.county ? normalizeCounty(parsed.data.county) : null
      };
    } finally {
      db.close();
    }
  });

  const LostFoundCommentListQuery = z.object({
    limit: z.coerce.number().min(1).max(200).default(80)
  });

  app.get("/api/lost-found/:id/comments", async (req) => {
    const id = String(req.params?.id || "");
    const parsed = LostFoundCommentListQuery.safeParse(req.query ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

    const db = openDb();
    try {
      ensureSchema(db);
      const post = db
        .prepare(
          `
          SELECT id
          FROM lost_found_posts
          WHERE id=? AND status='approved' AND datetime(expires_at) > datetime('now')
          LIMIT 1
          `
        )
        .get(id);
      if (!post) return app.httpErrors.notFound("Post not found");

      const rows = db
        .prepare(
          `
          SELECT id, post_id, commenter_name, comment_text, created_at
          FROM lost_found_comments
          WHERE post_id=@postId
          ORDER BY created_at ASC
          LIMIT @limit
          `
        )
        .all({ postId: id, limit: parsed.data.limit });

      return { comments: rows.map((row) => mapCommentRow(row)) };
    } finally {
      db.close();
    }
  });

  const LostFoundCommentBody = z.object({
    name: z.string().min(2).max(80),
    email: z.string().email(),
    comment: z.string().min(2).max(1500),
    acceptTerms: z.literal(true)
  });

  app.post("/api/lost-found/:id/comments", async (req) => {
    const id = String(req.params?.id || "");
    const parsed = LostFoundCommentBody.safeParse(req.body ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid payload");

    const email = parsed.data.email.trim().toLowerCase();
    const emailHash = hashIp(email);
    const ipHash = hashIp(req.ip);

    if (!enforceCommentRateLimit(req.ip)) {
      return app.httpErrors.tooManyRequests("Comment rate limit exceeded. Try again later.");
    }

    const name = normalizeCommentText(parsed.data.name);
    const comment = normalizeCommentText(parsed.data.comment);
    if (!name || !comment) {
      return app.httpErrors.badRequest("Name and comment are required");
    }
    if (hasBlockedCommentLanguage(name) || hasBlockedCommentLanguage(comment)) {
      return app.httpErrors.badRequest("Comment violates the community policy.");
    }

    const urlCount = countCommentUrls(comment);
    if (urlCount > COMMENT_MAX_URLS) {
      return app.httpErrors.badRequest(`Comments are limited to ${COMMENT_MAX_URLS} URL.`);
    }

    const db = openDb();
    try {
      ensureSchema(db);
      const ban = findLostFoundCommentBan(db, emailHash, ipHash);
      if (ban) return app.httpErrors.forbidden("You are not allowed to comment at this time.");

      const post = db
        .prepare(
          `
          SELECT id
          FROM lost_found_posts
          WHERE id=? AND status='approved' AND datetime(expires_at) > datetime('now')
          LIMIT 1
          `
        )
        .get(id);
      if (!post) return app.httpErrors.notFound("Post not found");

      const commentId = randomUUID();
      db.prepare(
        `
        INSERT INTO lost_found_comments (
          id, post_id, commenter_name, commenter_email_encrypted, commenter_email_hash,
          comment_text, url_count, commenter_ip_hash
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        `
      ).run(commentId, id, name, encryptText(email), emailHash, comment, urlCount, ipHash);

      const row = db
        .prepare(
          `
          SELECT id, post_id, commenter_name, comment_text, created_at
          FROM lost_found_comments
          WHERE id=?
          LIMIT 1
          `
        )
        .get(commentId);
      return { ok: true, comment: mapCommentRow(row) };
    } finally {
      db.close();
    }
  });

  const LostFoundSubmissionBody = z.object({
    type: z.enum(LOST_FOUND_TYPES),
    title: z.string().min(2).max(120),
    description: z.string().min(4).max(2000),
    county: z.string().min(2).max(80),
    state: z.string().length(2).default("KY"),
    contactEmail: z.string().email(),
    showContact: z.boolean().default(false),
    imageKeys: z.array(z.string().min(1).max(320)).max(5).default([]),
    turnstileToken: z.string().optional()
  });

  app.post("/api/lost-found/submissions", async (req) => {
    const parsed = LostFoundSubmissionBody.safeParse(req.body ?? {});
    if (!parsed.success) {
      return app.httpErrors.badRequest({
        error: "Invalid payload",
        details: parsed.error.flatten()
      });
    }

    if (process.env.REQUIRE_TURNSTILE === "1" && !parsed.data.turnstileToken) {
      return app.httpErrors.badRequest("Turnstile token is required");
    }

    const contactEmail = parsed.data.contactEmail.trim().toLowerCase();
    const emailHash = hashIp(contactEmail);
    const ipHash = hashIp(req.ip);

    if (!enforceSubmissionRateLimit(req.ip)) {
      return app.httpErrors.tooManyRequests("Rate limit exceeded. Try again later.");
    }

    if (String(parsed.data.state).toUpperCase() !== "KY") {
      return app.httpErrors.badRequest("Only KY submissions are accepted at this time");
    }

    const db = openDb();
    try {
      ensureSchema(db);
      const ban = findLostFoundCommentBan(db, emailHash, ipHash);
      if (ban) return app.httpErrors.forbidden("You are not allowed to submit listings at this time.");

      const id = randomUUID();
      const county = normalizeCounty(parsed.data.county);

      db.prepare(
        `
        INSERT INTO lost_found_posts (
          id, type, title, description, county, state_code,
          contact_email_encrypted, show_contact, status, expires_at
        ) VALUES (
          @id, @type, @title, @description, @county, 'KY',
          @contact, @showContact, 'pending', datetime('now', '+30 days')
        )
      `
      ).run({
        id,
        type: parsed.data.type,
        title: parsed.data.title.trim(),
        description: parsed.data.description.trim(),
        county,
        contact: encryptText(contactEmail),
        showContact: parsed.data.showContact ? 1 : 0
      });

      const insImage = db.prepare("INSERT INTO lost_found_images (id, post_id, r2_key) VALUES (?, ?, ?)");
      for (const imageKey of parsed.data.imageKeys) {
        insImage.run(randomUUID(), id, imageKey);
      }

      return { ok: true, id, status: "pending" };
    } finally {
      db.close();
    }
  });

  const LostFoundReportBody = z.object({
    reason: z.string().min(4).max(400)
  });

  app.post("/api/lost-found/:id/report", async (req) => {
    const id = String(req.params?.id || "");
    const parsed = LostFoundReportBody.safeParse(req.body ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid payload");

    const db = openDb();
    try {
      ensureSchema(db);

      const exists = db.prepare("SELECT id FROM lost_found_posts WHERE id=?").get(id);
      if (!exists) return app.httpErrors.notFound("Post not found");

      db.prepare(
        "INSERT INTO lost_found_reports (id, post_id, reason, reporter_ip_hash) VALUES (?, ?, ?, ?)"
      ).run(randomUUID(), id, parsed.data.reason.trim(), hashIp(req.ip));

      return { ok: true };
    } finally {
      db.close();
    }
  });

  const LostFoundMarkFoundBody = z.object({
    contactEmail: z.string().email(),
    note: z.string().max(500).optional()
  });

  app.post("/api/lost-found/:id/mark-found", async (req) => {
    const id = String(req.params?.id || "");
    const parsed = LostFoundMarkFoundBody.safeParse(req.body ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid payload");

    if (!enforceMarkFoundRateLimit(req.ip)) {
      return app.httpErrors.tooManyRequests("Rate limit exceeded. Try again later.");
    }

    const db = openDb();
    try {
      ensureSchema(db);
      const post = db
        .prepare(
          `
          SELECT id, type, status, is_resolved, contact_email_encrypted
          FROM lost_found_posts
          WHERE id=? AND datetime(expires_at) > datetime('now')
          LIMIT 1
          `
        )
        .get(id);

      if (!post) {
        const exists = db.prepare("SELECT id FROM lost_found_posts WHERE id=?").get(id);
        if (!exists) return app.httpErrors.notFound("Post not found");
        return app.httpErrors.badRequest("This listing has expired");
      }

      if (post.type !== "lost" || post.status !== "approved") {
        return app.httpErrors.badRequest("Only active lost posts can be marked found");
      }
      if (Number(post.is_resolved || 0) === 1) {
        return { ok: true, id, status: "resolved" };
      }

      const submittedEmail = parsed.data.contactEmail.trim().toLowerCase();
      const ownerEmail = String(decryptText(post.contact_email_encrypted) || "")
        .trim()
        .toLowerCase();
      if (!ownerEmail || ownerEmail !== submittedEmail) {
        return app.httpErrors.unauthorized("Contact email verification failed");
      }

      const info = db
        .prepare(
          `
          UPDATE lost_found_posts
          SET
            is_resolved=1,
            resolved_at=datetime('now'),
            resolved_note=?
          WHERE id=? AND status='approved' AND COALESCE(is_resolved, 0)=0
          `
        )
        .run(parsed.data.note || null, id);

      if (!info.changes) {
        return { ok: true, id, status: "resolved" };
      }
      return { ok: true, id, status: "resolved" };
    } finally {
      db.close();
    }
  });

  const AdminLostFoundQuery = z.object({
    status: z.enum(["pending", "approved", "rejected", "resolved", "all"]).default("pending"),
    limit: z.coerce.number().min(1).max(200).default(100)
  });
  const AdminCommentListQuery = z.object({
    postId: z.string().min(1).optional(),
    limit: z.coerce.number().min(1).max(300).default(200)
  });
  const AdminBanBody = z.object({
    banUser: z.boolean().default(true),
    banIp: z.boolean().default(true),
    reason: z.string().max(300).optional()
  });
  const AdminBanListQuery = z.object({
    limit: z.coerce.number().min(1).max(300).default(200)
  });

  app.get("/api/admin/lost-found", async (req) => {
    const admin = requireAdmin(app, req);
    const parsed = AdminLostFoundQuery.safeParse(req.query ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

    const db = openDb();
    try {
      ensureSchema(db);
      const where = [];
      const params = { limit: parsed.data.limit };

      if (parsed.data.status === "resolved") {
        where.push("p.status = 'approved'");
        where.push("COALESCE(p.is_resolved, 0) = 1");
      } else if (parsed.data.status !== "all") {
        where.push("p.status = @status");
        params.status = parsed.data.status;
      }

      const rows = db
        .prepare(
          `
          SELECT
            p.*,
            (
              SELECT group_concat(i.r2_key)
              FROM lost_found_images i
              WHERE i.post_id = p.id
            ) AS images_csv,
            (
              SELECT COUNT(1)
              FROM lost_found_comments c
              WHERE c.post_id = p.id
            ) AS comment_count
          FROM lost_found_posts p
          ${where.length ? `WHERE ${where.join(" AND ")}` : ""}
          ORDER BY p.submitted_at DESC
          LIMIT @limit
        `
        )
        .all(params);

      return {
        admin: admin.email,
        posts: rows.map((r) => mapLostFoundRow(r, { includeContact: true }))
      };
    } finally {
      db.close();
    }
  });

  const ApproveBody = z.object({
    showContact: z.boolean().optional(),
    note: z.string().max(500).optional()
  });

  app.post("/api/admin/lost-found/:id/approve", async (req) => {
    const admin = requireAdmin(app, req);
    const id = String(req.params?.id || "");
    const parsed = ApproveBody.safeParse(req.body ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid payload");

    const db = openDb();
    try {
      ensureSchema(db);

      const info = db
        .prepare(
          `
          UPDATE lost_found_posts
          SET
            status='approved',
            approved_at=datetime('now'),
            rejected_at=NULL,
            show_contact=COALESCE(@showContact, show_contact),
            moderation_note=@note
          WHERE id=@id AND status='pending'
        `
        )
        .run({
          id,
          showContact: parsed.data.showContact == null ? null : parsed.data.showContact ? 1 : 0,
          note: parsed.data.note || null
        });

      if (!info.changes) return app.httpErrors.notFound("Pending post not found");

      insertAdminLog(db, admin.email, "lost_found.approve", "lost_found_post", id, parsed.data);
      return { ok: true, id, status: "approved" };
    } finally {
      db.close();
    }
  });

  const RejectBody = z.object({
    reason: z.string().min(3).max(500)
  });

  app.post("/api/admin/lost-found/:id/reject", async (req) => {
    const admin = requireAdmin(app, req);
    const id = String(req.params?.id || "");
    const parsed = RejectBody.safeParse(req.body ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid payload");

    const db = openDb();
    try {
      ensureSchema(db);

      const info = db
        .prepare(
          `
          UPDATE lost_found_posts
          SET
            status='rejected',
            rejected_at=datetime('now'),
            moderation_note=@reason
          WHERE id=@id AND status='pending'
        `
        )
        .run({ id, reason: parsed.data.reason.trim() });

      if (!info.changes) return app.httpErrors.notFound("Pending post not found");

      insertAdminLog(db, admin.email, "lost_found.reject", "lost_found_post", id, parsed.data);
      return { ok: true, id, status: "rejected" };
    } finally {
      db.close();
    }
  });

  app.delete("/api/admin/lost-found/:id", async (req) => {
    const admin = requireAdmin(app, req);
    const id = String(req.params?.id || "");

    const db = openDb();
    try {
      ensureSchema(db);
      const row = db
        .prepare(
          `
          SELECT
            p.id,
            (
              SELECT group_concat(i.r2_key)
              FROM lost_found_images i
              WHERE i.post_id = p.id
            ) AS images_csv
          FROM lost_found_posts p
          WHERE p.id=?
          LIMIT 1
          `
        )
        .get(id);
      if (!row) return app.httpErrors.notFound("Post not found");

      const imageKeys = String(row.images_csv || "")
        .split(",")
        .map((v) => v.trim())
        .filter(Boolean);

      db.prepare("DELETE FROM lost_found_images WHERE post_id=?").run(id);
      db.prepare("DELETE FROM lost_found_reports WHERE post_id=?").run(id);
      db.prepare("DELETE FROM lost_found_comments WHERE post_id=?").run(id);
      db.prepare("DELETE FROM lost_found_posts WHERE id=?").run(id);

      let deletedImages = 0;
      for (const key of imageKeys) {
        try {
          await fs.unlink(path.join(uploadDir, key));
          deletedImages += 1;
        } catch {
          // ignore missing local files
        }
      }

      insertAdminLog(db, admin.email, "lost_found.delete", "lost_found_post", id, {
        deleted_images: deletedImages
      });
      return { ok: true, id, deletedImages };
    } finally {
      db.close();
    }
  });

  app.get("/api/admin/lost-found/comments", async (req) => {
    requireAdmin(app, req);
    const parsed = AdminCommentListQuery.safeParse(req.query ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

    const db = openDb();
    try {
      ensureSchema(db);
      const where = [];
      const params = { limit: parsed.data.limit };
      if (parsed.data.postId) {
        where.push("c.post_id = @postId");
        params.postId = parsed.data.postId;
      }

      const rows = db
        .prepare(
          `
          SELECT
            c.id,
            c.post_id,
            c.commenter_name,
            c.comment_text,
            c.commenter_email_hash,
            c.commenter_ip_hash,
            c.created_at,
            p.title AS post_title
          FROM lost_found_comments c
          JOIN lost_found_posts p ON p.id = c.post_id
          ${where.length ? `WHERE ${where.join(" AND ")}` : ""}
          ORDER BY c.created_at DESC
          LIMIT @limit
          `
        )
        .all(params);

      return { comments: rows.map((row) => mapAdminCommentRow(row)) };
    } finally {
      db.close();
    }
  });

  app.post("/api/admin/lost-found/comments/:commentId/ban", async (req) => {
    const admin = requireAdmin(app, req);
    const commentId = String(req.params?.commentId || "");
    const parsed = AdminBanBody.safeParse(req.body ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid payload");
    if (!parsed.data.banUser && !parsed.data.banIp) {
      return app.httpErrors.badRequest("At least one ban target is required");
    }

    const db = openDb();
    try {
      ensureSchema(db);
      const comment = db
        .prepare(
          `
          SELECT id, post_id, commenter_email_hash, commenter_ip_hash
          FROM lost_found_comments
          WHERE id=?
          LIMIT 1
          `
        )
        .get(commentId);
      if (!comment) return app.httpErrors.notFound("Comment not found");

      const targets = [];
      if (parsed.data.banUser && String(comment.commenter_email_hash || "").trim()) {
        targets.push({ targetType: "email", targetHash: String(comment.commenter_email_hash) });
      }
      if (parsed.data.banIp && String(comment.commenter_ip_hash || "").trim()) {
        targets.push({ targetType: "ip", targetHash: String(comment.commenter_ip_hash) });
      }
      if (!targets.length) return app.httpErrors.badRequest("Unable to derive ban target from this comment");

      const reason = parsed.data.reason?.trim() || null;
      const upsert = db.prepare(
        `
        INSERT INTO lost_found_comment_bans (
          id, target_type, target_hash, reason, banned_by_email, source_comment_id
        ) VALUES (?, ?, ?, ?, ?, ?)
        ON CONFLICT(target_type, target_hash) DO UPDATE SET
          reason=excluded.reason,
          banned_by_email=excluded.banned_by_email,
          source_comment_id=excluded.source_comment_id,
          created_at=datetime('now')
        `
      );
      for (const target of targets) {
        upsert.run(randomUUID(), target.targetType, target.targetHash, reason, admin.email, commentId);
      }

      insertAdminLog(db, admin.email, "lost_found.comment.ban", "lost_found_comment", commentId, {
        banUser: parsed.data.banUser,
        banIp: parsed.data.banIp,
        reason
      });
      return { ok: true, id: commentId, bansApplied: targets.length };
    } finally {
      db.close();
    }
  });

  app.get("/api/admin/lost-found/bans", async (req) => {
    requireAdmin(app, req);
    const parsed = AdminBanListQuery.safeParse(req.query ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

    const db = openDb();
    try {
      ensureSchema(db);
      const rows = db
        .prepare(
          `
          SELECT id, target_type, reason, banned_by_email, source_comment_id, created_at
          FROM lost_found_comment_bans
          ORDER BY created_at DESC
          LIMIT @limit
          `
        )
        .all({ limit: parsed.data.limit });

      return { bans: rows.map((row) => mapCommentBanRow(row)) };
    } finally {
      db.close();
    }
  });

  app.delete("/api/admin/lost-found/bans/:banId", async (req) => {
    const admin = requireAdmin(app, req);
    const banId = String(req.params?.banId || "");

    const db = openDb();
    try {
      ensureSchema(db);
      const row = db
        .prepare("SELECT id, target_type, source_comment_id FROM lost_found_comment_bans WHERE id=? LIMIT 1")
        .get(banId);
      if (!row) return app.httpErrors.notFound("Ban not found");

      db.prepare("DELETE FROM lost_found_comment_bans WHERE id=?").run(banId);
      insertAdminLog(db, admin.email, "lost_found.comment.unban", "lost_found_comment_ban", banId, {
        target_type: row.target_type,
        source_comment_id: row.source_comment_id
      });
      return { ok: true, id: banId };
    } finally {
      db.close();
    }
  });

  app.delete("/api/admin/lost-found/comments/:commentId", async (req) => {
    const admin = requireAdmin(app, req);
    const commentId = String(req.params?.commentId || "");

    const db = openDb();
    try {
      ensureSchema(db);
      const row = db.prepare("SELECT id, post_id FROM lost_found_comments WHERE id=? LIMIT 1").get(commentId);
      if (!row) return app.httpErrors.notFound("Comment not found");

      db.prepare("DELETE FROM lost_found_comments WHERE id=?").run(commentId);
      insertAdminLog(db, admin.email, "lost_found.comment.delete", "lost_found_comment", commentId, {
        post_id: row.post_id
      });
      return { ok: true, id: commentId };
    } finally {
      db.close();
    }
  });
}

```

# apps\api\src\schema.mjs

```mjs
export function columnExists(db, table, column) {
  const rows = db.prepare(`PRAGMA table_info(${table})`).all();
  return rows.some((r) => r.name === column);
}

export function ensureSchema(db) {
  if (!columnExists(db, "feeds", "region_scope")) {
    db.prepare("ALTER TABLE feeds ADD COLUMN region_scope TEXT NOT NULL DEFAULT 'ky'").run();
  }
  if (!columnExists(db, "feeds", "default_county")) {
    db.prepare("ALTER TABLE feeds ADD COLUMN default_county TEXT").run();
  }
  if (!columnExists(db, "feeds", "fetch_mode")) {
    db.prepare("ALTER TABLE feeds ADD COLUMN fetch_mode TEXT NOT NULL DEFAULT 'rss'").run();
  }
  if (!columnExists(db, "feeds", "scraper_id")) {
    db.prepare("ALTER TABLE feeds ADD COLUMN scraper_id TEXT").run();
  }
  db.prepare("UPDATE feeds SET fetch_mode='rss' WHERE fetch_mode IS NULL OR trim(fetch_mode)=''").run();

  if (!columnExists(db, "items", "region_scope")) {
    db.prepare("ALTER TABLE items ADD COLUMN region_scope TEXT NOT NULL DEFAULT 'ky'").run();
  }
  if (!columnExists(db, "items", "fetched_at")) {
    db.prepare("ALTER TABLE items ADD COLUMN fetched_at TEXT").run();
  }
  db.prepare("UPDATE items SET fetched_at=datetime('now') WHERE fetched_at IS NULL OR trim(fetched_at)=''").run();
  if (!columnExists(db, "items", "article_fetch_status")) {
    db.prepare("ALTER TABLE items ADD COLUMN article_fetch_status TEXT").run();
  }
  if (!columnExists(db, "items", "article_text_excerpt")) {
    db.prepare("ALTER TABLE items ADD COLUMN article_text_excerpt TEXT").run();
  }
  if (!columnExists(db, "items", "ai_summary")) {
    db.prepare("ALTER TABLE items ADD COLUMN ai_summary TEXT").run();
  }
  if (!columnExists(db, "lost_found_posts", "is_resolved")) {
    db.prepare("ALTER TABLE lost_found_posts ADD COLUMN is_resolved INTEGER NOT NULL DEFAULT 0").run();
  }
  if (!columnExists(db, "lost_found_posts", "resolved_at")) {
    db.prepare("ALTER TABLE lost_found_posts ADD COLUMN resolved_at TEXT").run();
  }
  if (!columnExists(db, "lost_found_posts", "resolved_note")) {
    db.prepare("ALTER TABLE lost_found_posts ADD COLUMN resolved_note TEXT").run();
  }

  db.exec(`
    CREATE TABLE IF NOT EXISTS weather_forecasts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      state_code TEXT NOT NULL,
      county TEXT NOT NULL,
      forecast_json TEXT NOT NULL,
      fetched_at TEXT NOT NULL DEFAULT (datetime('now')),
      expires_at TEXT NOT NULL
    );

    CREATE INDEX IF NOT EXISTS idx_weather_forecasts_county ON weather_forecasts(state_code, county, fetched_at);

    CREATE TABLE IF NOT EXISTS weather_alerts (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      alert_id TEXT NOT NULL,
      state_code TEXT NOT NULL,
      county TEXT NOT NULL,
      severity TEXT,
      event TEXT,
      headline TEXT,
      starts_at TEXT,
      ends_at TEXT,
      raw_json TEXT NOT NULL,
      fetched_at TEXT NOT NULL DEFAULT (datetime('now'))
    );

    CREATE INDEX IF NOT EXISTS idx_weather_alerts_state_county ON weather_alerts(state_code, county, fetched_at);
    CREATE INDEX IF NOT EXISTS idx_weather_alerts_alert_id ON weather_alerts(alert_id);

    CREATE TABLE IF NOT EXISTS lost_found_posts (
      id TEXT PRIMARY KEY,
      type TEXT NOT NULL CHECK (type IN ('lost', 'found')),
      title TEXT NOT NULL,
      description TEXT NOT NULL,
      county TEXT NOT NULL,
      state_code TEXT NOT NULL DEFAULT 'KY',
      contact_email_encrypted TEXT NOT NULL,
      show_contact INTEGER NOT NULL DEFAULT 0,
      status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
      submitted_at TEXT NOT NULL DEFAULT (datetime('now')),
      approved_at TEXT,
      rejected_at TEXT,
      is_resolved INTEGER NOT NULL DEFAULT 0,
      resolved_at TEXT,
      resolved_note TEXT,
      expires_at TEXT NOT NULL,
      moderation_note TEXT
    );

    CREATE INDEX IF NOT EXISTS idx_lost_found_posts_status ON lost_found_posts(status, submitted_at);
    CREATE INDEX IF NOT EXISTS idx_lost_found_posts_county ON lost_found_posts(state_code, county, status);

    CREATE TABLE IF NOT EXISTS lost_found_images (
      id TEXT PRIMARY KEY,
      post_id TEXT NOT NULL,
      r2_key TEXT NOT NULL,
      width INTEGER,
      height INTEGER,
      created_at TEXT NOT NULL DEFAULT (datetime('now')),
      FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_lost_found_images_post_id ON lost_found_images(post_id);

    CREATE TABLE IF NOT EXISTS lost_found_reports (
      id TEXT PRIMARY KEY,
      post_id TEXT NOT NULL,
      reason TEXT NOT NULL,
      reporter_ip_hash TEXT NOT NULL,
      created_at TEXT NOT NULL DEFAULT (datetime('now')),
      FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_lost_found_reports_post_id ON lost_found_reports(post_id, created_at);

    CREATE TABLE IF NOT EXISTS lost_found_comments (
      id TEXT PRIMARY KEY,
      post_id TEXT NOT NULL,
      commenter_name TEXT NOT NULL,
      commenter_email_encrypted TEXT NOT NULL,
      commenter_email_hash TEXT NOT NULL,
      comment_text TEXT NOT NULL,
      url_count INTEGER NOT NULL DEFAULT 0,
      commenter_ip_hash TEXT NOT NULL,
      created_at TEXT NOT NULL DEFAULT (datetime('now')),
      FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_lost_found_comments_post_created ON lost_found_comments(post_id, created_at);
    CREATE INDEX IF NOT EXISTS idx_lost_found_comments_ip_created ON lost_found_comments(commenter_ip_hash, created_at);

    CREATE TABLE IF NOT EXISTS lost_found_comment_bans (
      id TEXT PRIMARY KEY,
      target_type TEXT NOT NULL CHECK (target_type IN ('email', 'ip')),
      target_hash TEXT NOT NULL,
      reason TEXT,
      banned_by_email TEXT NOT NULL,
      source_comment_id TEXT,
      created_at TEXT NOT NULL DEFAULT (datetime('now')),
      UNIQUE(target_type, target_hash),
      FOREIGN KEY (source_comment_id) REFERENCES lost_found_comments(id) ON DELETE SET NULL
    );

    CREATE INDEX IF NOT EXISTS idx_lost_found_comment_bans_created ON lost_found_comment_bans(created_at);

    CREATE TABLE IF NOT EXISTS admin_audit_log (
      id TEXT PRIMARY KEY,
      actor_email TEXT NOT NULL,
      action TEXT NOT NULL,
      entity_type TEXT NOT NULL,
      entity_id TEXT NOT NULL,
      payload_json TEXT,
      created_at TEXT NOT NULL DEFAULT (datetime('now'))
    );

    CREATE INDEX IF NOT EXISTS idx_admin_audit_created ON admin_audit_log(created_at);

    CREATE TABLE IF NOT EXISTS feed_run_metrics (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      run_id INTEGER,
      feed_id TEXT NOT NULL,
      source TEXT,
      status TEXT NOT NULL,
      http_status INTEGER,
      duration_ms INTEGER,
      items_seen INTEGER NOT NULL DEFAULT 0,
      items_upserted INTEGER NOT NULL DEFAULT 0,
      error_message TEXT,
      checked_at TEXT NOT NULL DEFAULT (datetime('now'))
    );

    CREATE INDEX IF NOT EXISTS idx_feed_run_metrics_feed_checked ON feed_run_metrics(feed_id, checked_at);
    CREATE INDEX IF NOT EXISTS idx_feed_run_metrics_status_checked ON feed_run_metrics(status, checked_at);

    CREATE INDEX IF NOT EXISTS idx_items_region_scope ON items(region_scope);
    CREATE INDEX IF NOT EXISTS idx_feeds_region_scope ON feeds(region_scope);
    CREATE INDEX IF NOT EXISTS idx_feeds_fetch_mode_enabled ON feeds(fetch_mode, enabled);
  `);

  if (!columnExists(db, "admin_audit_log", "payload_json")) {
    db.prepare("ALTER TABLE admin_audit_log ADD COLUMN payload_json TEXT").run();
  }
  if (!columnExists(db, "feed_run_metrics", "run_id")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN run_id INTEGER").run();
  }
  if (!columnExists(db, "feed_run_metrics", "source")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN source TEXT").run();
  }
  if (!columnExists(db, "feed_run_metrics", "status")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN status TEXT").run();
  }
  if (!columnExists(db, "feed_run_metrics", "http_status")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN http_status INTEGER").run();
  }
  if (!columnExists(db, "feed_run_metrics", "duration_ms")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN duration_ms INTEGER").run();
  }
  if (!columnExists(db, "feed_run_metrics", "items_seen")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN items_seen INTEGER NOT NULL DEFAULT 0").run();
  }
  if (!columnExists(db, "feed_run_metrics", "items_upserted")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN items_upserted INTEGER NOT NULL DEFAULT 0").run();
  }
  if (!columnExists(db, "feed_run_metrics", "error_message")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN error_message TEXT").run();
  }
  if (!columnExists(db, "feed_run_metrics", "checked_at")) {
    db.prepare("ALTER TABLE feed_run_metrics ADD COLUMN checked_at TEXT").run();
  }
  db.prepare("UPDATE feed_run_metrics SET checked_at=datetime('now') WHERE checked_at IS NULL OR trim(checked_at)=''").run();
}

```

# apps\api\src\search.mjs

```mjs
import kyCounties from "../../ingester/src/ky-counties.json" with { type: "json" };

const COUNTY_NAME_BY_NORMALIZED = new Map(
  (Array.isArray(kyCounties) ? kyCounties : [])
    .map((row) => String(row?.name || "").trim())
    .filter(Boolean)
    .map((name) => [
      name.toLowerCase().replace(/\s+county$/i, "").replace(/[^a-z0-9]+/g, " ").trim(),
      name
    ])
);

export function csvToArray(csv) {
  if (!csv) return [];
  return String(csv)
    .split(",")
    .map((x) => x.trim())
    .filter(Boolean);
}

export function mapItemRow(row) {
  const states = csvToArray(row.states_csv);
  const counties = csvToArray(row.counties_csv);
  const { states_csv, counties_csv, ...rest } = row;
  return { ...rest, states, counties };
}

export function escapeLike(input) {
  return String(input).replace(/[\\%_]/g, "\\$&");
}

export function parseSearchQuery(input) {
  const q = String(input || "");
  const tokens = [];
  let i = 0;

  while (i < q.length) {
    while (i < q.length && /\s/.test(q[i])) i++;
    if (i >= q.length) break;

    let negated = false;
    if (q[i] === "-") {
      negated = true;
      i++;
      while (i < q.length && /\s/.test(q[i])) i++;
    }

    if (i >= q.length) break;

    let value = "";
    let quoted = false;
    if (q[i] === '"') {
      quoted = true;
      i++;
      const start = i;
      while (i < q.length && q[i] !== '"') i++;
      value = q.slice(start, i);
      if (i < q.length && q[i] === '"') i++;
    } else {
      const start = i;
      while (i < q.length && !/\s/.test(q[i])) i++;
      value = q.slice(start, i);
    }

    value = value.trim();
    if (!value) continue;

    if (!quoted && !negated) {
      const upper = value.toUpperCase();
      if (upper === "AND" || upper === "OR") {
        tokens.push({ kind: "op", op: upper });
        continue;
      }
    }

    tokens.push({ kind: "term", value, negated });
  }

  const groups = [{ include: [], exclude: [] }];
  for (const token of tokens) {
    const current = groups[groups.length - 1];
    if (token.kind === "op") {
      if (token.op === "OR") {
        if (current.include.length || current.exclude.length) groups.push({ include: [], exclude: [] });
      }
      continue;
    }

    if (token.negated) current.exclude.push(token.value);
    else current.include.push(token.value);
  }

  return groups.filter((g) => g.include.length || g.exclude.length);
}

export function buildSearchClause(rawQuery, params) {
  const searchableDoc = "LOWER(COALESCE(i.title, '') || ' ' || COALESCE(i.summary, '') || ' ' || COALESCE(i.content, ''))";
  const groups = parseSearchQuery(rawQuery);
  if (!groups.length) return "1=0";

  const orBlocks = groups.map((g, gIdx) => {
    const andParts = [];

    for (let i = 0; i < g.include.length; i++) {
      const key = `q_i_${gIdx}_${i}`;
      params[key] = `%${escapeLike(g.include[i].toLowerCase())}%`;
      andParts.push(`${searchableDoc} LIKE @${key} ESCAPE '\\'`);
    }

    for (let i = 0; i < g.exclude.length; i++) {
      const key = `q_x_${gIdx}_${i}`;
      params[key] = `%${escapeLike(g.exclude[i].toLowerCase())}%`;
      andParts.push(`${searchableDoc} NOT LIKE @${key} ESCAPE '\\'`);
    }

    if (!andParts.length) return null;
    return `(${andParts.join(" AND ")})`;
  });

  const filtered = orBlocks.filter(Boolean);
  if (!filtered.length) return "1=0";
  return `(${filtered.join(" OR ")})`;
}

export function normalizeCounty(county) {
  const base = String(county || "")
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ")
    .replace(/\s+county$/i, "")
    .trim();
  if (!base) return "";

  const key = base.toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
  return COUNTY_NAME_BY_NORMALIZED.get(key) || base;
}

export function isKy(stateCode) {
  return String(stateCode || "").toUpperCase() === "KY";
}

export function safeJsonParse(input, fallback) {
  try {
    return JSON.parse(input);
  } catch {
    return fallback;
  }
}

```

# apps\api\src\security.mjs

```mjs
import { createHash, createCipheriv, createDecipheriv, randomBytes, randomUUID } from "node:crypto";

const ENCRYPTION_KEY = createHash("sha256")
  .update(process.env.LOCAL_DATA_ENCRYPTION_KEY || "dev-only-change-me")
  .digest();

export function encryptText(value) {
  const iv = randomBytes(12);
  const cipher = createCipheriv("aes-256-gcm", ENCRYPTION_KEY, iv);
  const encrypted = Buffer.concat([cipher.update(String(value), "utf8"), cipher.final()]);
  const tag = cipher.getAuthTag();
  return Buffer.concat([iv, tag, encrypted]).toString("base64");
}

export function decryptText(cipherText) {
  if (!cipherText) return null;
  try {
    const data = Buffer.from(String(cipherText), "base64");
    if (data.length < 28) return null;
    const iv = data.subarray(0, 12);
    const tag = data.subarray(12, 28);
    const encrypted = data.subarray(28);
    const decipher = createDecipheriv("aes-256-gcm", ENCRYPTION_KEY, iv);
    decipher.setAuthTag(tag);
    return Buffer.concat([decipher.update(encrypted), decipher.final()]).toString("utf8");
  } catch {
    return null;
  }
}

export function hashIp(ip) {
  return createHash("sha256").update(String(ip || "")).digest("hex");
}

const submissionRate = new Map();

function cleanupRateWindow() {
  const now = Date.now();
  for (const [key, list] of submissionRate.entries()) {
    const next = list.filter((ts) => now - ts < 60 * 60 * 1000);
    if (!next.length) submissionRate.delete(key);
    else submissionRate.set(key, next);
  }
}

export function enforceSubmissionRateLimit(ip) {
  cleanupRateWindow();
  const key = String(ip || "unknown");
  const now = Date.now();
  const list = submissionRate.get(key) || [];
  const next = list.filter((ts) => now - ts < 60 * 60 * 1000);
  if (next.length >= 5) return false;
  next.push(now);
  submissionRate.set(key, next);
  return true;
}

export function getAdminIdentity(req) {
  const cfEmail = req.headers["cf-access-authenticated-user-email"];
  if (cfEmail) {
    return { email: String(cfEmail), source: "cloudflare-access" };
  }

  const adminToken = process.env.ADMIN_TOKEN;
  const headerToken = req.headers["x-admin-token"];
  if (adminToken && headerToken && String(headerToken) === adminToken) {
    return { email: process.env.ADMIN_EMAIL || "local-admin", source: "admin-token" };
  }

  return null;
}

export function requireAdmin(app, req) {
  const identity = getAdminIdentity(req);
  if (!identity) {
    throw app.httpErrors.unauthorized("Admin authentication required");
  }
  return identity;
}

export function insertAdminLog(db, actorEmail, action, entityType, entityId, payload = null) {
  try {
    db.prepare(
      "INSERT INTO admin_audit_log (id, actor_email, action, entity_type, entity_id, payload_json) VALUES (?, ?, ?, ?, ?, ?)"
    ).run(randomUUID(), actorEmail, action, entityType, entityId, payload ? JSON.stringify(payload) : null);
  } catch (err) {
    console.warn("admin.audit.log_failed", {
      action,
      entityType,
      entityId,
      error: err instanceof Error ? err.message : String(err)
    });
  }
}

```

# apps\api\src\seo.mjs

```mjs
import { normalizeCounty } from "./search.mjs";
import { ensureSchema } from "./schema.mjs";

const SITE_ORIGIN = process.env.SITE_ORIGIN || "https://localkynews.com";

// ── XML / date helpers ────────────────────────────────────────────────────────

export function escapeXml(str) {
  return String(str ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&apos;");
}

export function toYYYYMMDD(isoStr) {
  const d = isoStr ? new Date(isoStr) : new Date();
  if (isNaN(d.getTime())) return new Date().toISOString().slice(0, 10);
  return d.toISOString().slice(0, 10);
}

const RFC822_DAYS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
const RFC822_MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

export function toRfc822(isoStr) {
  const d = isoStr ? new Date(isoStr) : new Date();
  if (isNaN(d.getTime())) return new Date().toUTCString();
  const dd = String(d.getUTCDate()).padStart(2, "0");
  const hh = String(d.getUTCHours()).padStart(2, "0");
  const mm = String(d.getUTCMinutes()).padStart(2, "0");
  const ss = String(d.getUTCSeconds()).padStart(2, "0");
  return `${RFC822_DAYS[d.getUTCDay()]}, ${dd} ${RFC822_MONTHS[d.getUTCMonth()]} ${d.getUTCFullYear()} ${hh}:${mm}:${ss} GMT`;
}

export function countySlug(name) {
  return String(name ?? "")
    .toLowerCase()
    .replace(/\s+/g, "-");
}

function xmlDecl() {
  return '<?xml version="1.0" encoding="UTF-8"?>\n';
}

function seoHeaders(reply) {
  reply.header("Cache-Control", "public, max-age=300");
  reply.header("Access-Control-Allow-Origin", "*");
}

function displayCountyName(county) {
  return String(county || "")
    .split(" ")
    .map((w) => (w ? w.charAt(0).toUpperCase() + w.slice(1) : w))
    .join(" ");
}

// ── RSS item builder (shared by /rss.xml and /rss/:county.xml) ────────────────

function buildRssItem(row) {
  const pub = toRfc822(row.published_at);
  const desc = escapeXml(row.ai_summary || row.summary || "");
  const lines = [
    "    <item>",
    `      <title>${escapeXml(row.title)}</title>`,
    `      <link>${escapeXml(row.url)}</link>`,
    `      <guid isPermaLink="false">${escapeXml(String(row.id))}</guid>`,
    `      <pubDate>${pub}</pubDate>`,
    `      <description>${desc}</description>`
  ];
  if (row.author) {
    lines.push(`      <author>${escapeXml(row.author)}</author>`);
  }
  if (row.image_url) {
    lines.push(`      <enclosure url="${escapeXml(row.image_url)}" length="0" type="image/jpeg"/>`);
  }
  lines.push("    </item>");
  return lines.join("\n");
}

// ── Route registration ────────────────────────────────────────────────────────

export function registerSeoRoutes(app, openDb) {
  // robots.txt is served centrally in server.mjs to avoid route duplication.

  // ── 1. sitemap-index.xml ─────────────────────────────────────────────────
  app.get("/sitemap-index.xml", async (_req, reply) => {
    seoHeaders(reply);
    reply.header("Content-Type", "application/xml");
    const today = toYYYYMMDD(new Date().toISOString());
    const xml = [
      xmlDecl(),
      '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">',
      `  <sitemap><loc>${SITE_ORIGIN}/sitemap-news.xml</loc><lastmod>${today}</lastmod></sitemap>`,
      `  <sitemap><loc>${SITE_ORIGIN}/sitemap-counties.xml</loc><lastmod>${today}</lastmod></sitemap>`,
      `  <sitemap><loc>${SITE_ORIGIN}/sitemap-lost-found.xml</loc><lastmod>${today}</lastmod></sitemap>`,
      `  <sitemap><loc>${SITE_ORIGIN}/sitemap-static.xml</loc><lastmod>${today}</lastmod></sitemap>`,
      "</sitemapindex>"
    ].join("\n");
    return reply.send(xml);
  });

  // ── 2. sitemap-news.xml (Google News format) ─────────────────────────────
  app.get("/sitemap-news.xml", async (_req, reply) => {
    seoHeaders(reply);
    reply.header("Content-Type", "application/xml");
    const db = openDb();
    try {
      ensureSchema(db);
      const rows = db
        .prepare(
          `SELECT id, title, published_at
           FROM items
           WHERE published_at >= datetime('now', '-48 hours')
             AND region_scope = 'ky'
             AND article_fetch_status = 'ok'
           ORDER BY published_at DESC
           LIMIT 1000`
        )
        .all();

      const urlBlocks = rows
        .map((row) => {
          const pubIso = row.published_at
            ? new Date(row.published_at).toISOString()
            : new Date().toISOString();
          return [
            "  <url>",
            `    <loc>${SITE_ORIGIN}/news/${escapeXml(String(row.id))}</loc>`,
            `    <lastmod>${toYYYYMMDD(row.published_at)}</lastmod>`,
            "    <news:news>",
            "      <news:publication>",
            "        <news:name>Kentucky Local News</news:name>",
            "        <news:language>en</news:language>",
            "      </news:publication>",
            `      <news:publication_date>${escapeXml(pubIso)}</news:publication_date>`,
            `      <news:title>${escapeXml(row.title)}</news:title>`,
            "    </news:news>",
            "  </url>"
          ].join("\n");
        })
        .join("\n");

      const xml = [
        xmlDecl(),
        '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"',
        '        xmlns:news="http://www.google.com/schemas/sitemap-news/0.9">',
        urlBlocks,
        "</urlset>"
      ].join("\n");
      return reply.send(xml);
    } catch (err) {
      reply.status(500);
      return reply.send(`Internal error: ${String(err?.message ?? err)}`);
    } finally {
      db.close();
    }
  });

  // ── 3. sitemap-counties.xml ──────────────────────────────────────────────
  app.get("/sitemap-counties.xml", async (_req, reply) => {
    seoHeaders(reply);
    reply.header("Content-Type", "application/xml");
    const db = openDb();
    try {
      ensureSchema(db);
      const rows = db
        .prepare(
          `SELECT il.county, MAX(COALESCE(i.published_at, i.fetched_at)) AS latest
           FROM item_locations il
           JOIN items i ON i.id = il.item_id
           WHERE il.state_code = 'KY'
             AND il.county != ''
             AND i.region_scope = 'ky'
             AND COALESCE(i.published_at, i.fetched_at) >= datetime('now', '-7 days')
           GROUP BY il.county
           ORDER BY il.county`
        )
        .all();

      const urlBlocks = rows
        .map((row) => {
          const slug = countySlug(row.county);
          return [
            "  <url>",
            `    <loc>${SITE_ORIGIN}/county/${escapeXml(slug)}</loc>`,
            `    <lastmod>${toYYYYMMDD(row.latest)}</lastmod>`,
            "    <changefreq>hourly</changefreq>",
            "    <priority>0.8</priority>",
            "  </url>"
          ].join("\n");
        })
        .join("\n");

      const xml = [
        xmlDecl(),
        '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">',
        urlBlocks,
        "</urlset>"
      ].join("\n");
      return reply.send(xml);
    } catch (err) {
      reply.status(500);
      return reply.send(`Internal error: ${String(err?.message ?? err)}`);
    } finally {
      db.close();
    }
  });

  // ── 4. sitemap-lost-found.xml ────────────────────────────────────────────
  app.get("/sitemap-lost-found.xml", async (_req, reply) => {
    seoHeaders(reply);
    reply.header("Content-Type", "application/xml");
    const db = openDb();
    try {
      ensureSchema(db);
      const rows = db
        .prepare(
          `SELECT id, approved_at, submitted_at
           FROM lost_found_posts
           WHERE status = 'approved'
             AND expires_at > datetime('now')
           ORDER BY COALESCE(approved_at, submitted_at) DESC`
        )
        .all();

      const urlBlocks = rows
        .map((row) => {
          const dateStr = toYYYYMMDD(row.approved_at || row.submitted_at);
          return [
            "  <url>",
            `    <loc>${SITE_ORIGIN}/lost-found/${escapeXml(String(row.id))}</loc>`,
            `    <lastmod>${dateStr}</lastmod>`,
            "    <changefreq>weekly</changefreq>",
            "    <priority>0.5</priority>",
            "  </url>"
          ].join("\n");
        })
        .join("\n");

      const xml = [
        xmlDecl(),
        '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">',
        urlBlocks,
        "</urlset>"
      ].join("\n");
      return reply.send(xml);
    } catch (err) {
      reply.status(500);
      return reply.send(`Internal error: ${String(err?.message ?? err)}`);
    } finally {
      db.close();
    }
  });

  // ── 5. sitemap-static.xml ────────────────────────────────────────────────
  app.get("/sitemap-static.xml", async (_req, reply) => {
    seoHeaders(reply);
    reply.header("Content-Type", "application/xml");
    const today = toYYYYMMDD(new Date().toISOString());
    const staticPages = [
      { loc: "/", changefreq: "hourly", priority: "1.0" },
      { loc: "/lost-found", changefreq: "daily", priority: "0.7" },
      { loc: "/weather", changefreq: "hourly", priority: "0.6" },
      { loc: "/search", changefreq: "daily", priority: "0.5" }
    ];

    const urlBlocks = staticPages
      .map((p) =>
        [
          "  <url>",
          `    <loc>${SITE_ORIGIN}${p.loc}</loc>`,
          `    <lastmod>${today}</lastmod>`,
          `    <changefreq>${p.changefreq}</changefreq>`,
          `    <priority>${p.priority}</priority>`,
          "  </url>"
        ].join("\n")
      )
      .join("\n");

    const xml = [
      xmlDecl(),
      '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">',
      urlBlocks,
      "</urlset>"
    ].join("\n");
    return reply.send(xml);
  });

  // ── 6. rss.xml – global KY feed ──────────────────────────────────────────
  app.get("/rss.xml", async (_req, reply) => {
    reply.header("Cache-Control", "public, max-age=300");
    reply.header("Access-Control-Allow-Origin", "*");
    reply.header("Content-Type", "application/rss+xml; charset=utf-8");
    const db = openDb();
    try {
      ensureSchema(db);
      const rows = db
        .prepare(
          `SELECT id, title, url, author, published_at, summary, ai_summary, image_url
           FROM items
           WHERE region_scope = 'ky'
             AND COALESCE(published_at, fetched_at) >= datetime('now', '-72 hours')
           ORDER BY COALESCE(published_at, fetched_at) DESC
           LIMIT 50`
        )
        .all();

      const buildDate = toRfc822(new Date().toISOString());
      const itemsXml = rows.map((r) => buildRssItem(r)).join("\n");

      const xml = [
        xmlDecl(),
        '<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">',
        "  <channel>",
        "    <title>Kentucky Local News</title>",
        `    <link>${SITE_ORIGIN}</link>`,
        "    <description>Local news from across Kentucky&#x27;s 120 counties</description>",
        "    <language>en-us</language>",
        `    <lastBuildDate>${buildDate}</lastBuildDate>`,
        `    <atom:link href="${SITE_ORIGIN}/rss.xml" rel="self" type="application/rss+xml"/>`,
        itemsXml,
        "  </channel>",
        "</rss>"
      ].join("\n");
      return reply.send(xml);
    } catch (err) {
      reply.status(500);
      return reply.send(`Internal error: ${String(err?.message ?? err)}`);
    } finally {
      db.close();
    }
  });

  // ── 7. /rss/:county.xml – per-county RSS feed ────────────────────────────
  // Fastify match: /rss/jefferson.xml → params.county = "jefferson"
  app.get("/rss/:county.xml", async (req, reply) => {
    reply.header("Cache-Control", "public, max-age=300");
    reply.header("Access-Control-Allow-Origin", "*");
    reply.header("Content-Type", "application/rss+xml; charset=utf-8");

    const rawCounty = decodeURIComponent(String(req.params?.county ?? ""));
    const county = normalizeCounty(rawCounty);
    if (!county) {
      reply.status(404);
      return reply.send("Not found");
    }

    const db = openDb();
    try {
      ensureSchema(db);
      const rows = db
        .prepare(
          `SELECT i.id, i.title, i.url, i.author, i.published_at, i.summary, i.ai_summary, i.image_url
           FROM items i
           JOIN item_locations il ON il.item_id = i.id
           WHERE il.state_code = 'KY'
             AND il.county = @county
             AND i.region_scope = 'ky'
             AND COALESCE(i.published_at, i.fetched_at) >= datetime('now', '-72 hours')
           ORDER BY COALESCE(i.published_at, i.fetched_at) DESC
           LIMIT 50`
        )
        .all({ county });

      if (!rows.length) {
        reply.status(404);
        return reply.send("Not found");
      }

      const buildDate = toRfc822(new Date().toISOString());
      const displayName = displayCountyName(county);
      const feedUrl = `${SITE_ORIGIN}/rss/${encodeURIComponent(county)}.xml`;
      const itemsXml = rows.map((r) => buildRssItem(r)).join("\n");

      const xml = [
        xmlDecl(),
        '<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">',
        "  <channel>",
        `    <title>${escapeXml(`${displayName} County, Kentucky – Local News`)}</title>`,
        `    <link>${SITE_ORIGIN}/county/${countySlug(county)}</link>`,
        `    <description>${escapeXml(`Local news from ${displayName} County, Kentucky`)}</description>`,
        "    <language>en-us</language>",
        `    <lastBuildDate>${buildDate}</lastBuildDate>`,
        `    <atom:link href="${escapeXml(feedUrl)}" rel="self" type="application/rss+xml"/>`,
        itemsXml,
        "  </channel>",
        "</rss>"
      ].join("\n");
      return reply.send(xml);
    } catch (err) {
      reply.status(500);
      return reply.send(`Internal error: ${String(err?.message ?? err)}`);
    } finally {
      db.close();
    }
  });

  // ── 8. GET /api/structured-data/item/:id ─────────────────────────────────
  app.get("/api/structured-data/item/:id", async (req, reply) => {
    reply.header("Access-Control-Allow-Origin", "*");
    const id = req.params?.id;
    const db = openDb();
    try {
      ensureSchema(db);
      const row = db
        .prepare(
          `SELECT id, title, url, author, published_at, fetched_at,
                  summary, ai_summary, image_url, article_text_excerpt
           FROM items
           WHERE id = ?`
        )
        .get(id);

      if (!row) return app.httpErrors.notFound("Item not found");

      const description = row.ai_summary || row.summary || "";
      const articleBody = row.article_text_excerpt
        ? String(row.article_text_excerpt).slice(0, 500)
        : "";
      const datePublished = row.published_at || row.fetched_at || "";
      const dateModified = row.fetched_at || row.published_at || "";

      const jsonLd = {
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        headline: row.title || "",
        url: `${SITE_ORIGIN}/news/${row.id}`,
        datePublished,
        dateModified,
        publisher: {
          "@type": "Organization",
          name: "Kentucky Local News",
          url: SITE_ORIGIN
        },
        description,
        articleBody
      };

      if (row.author) {
        jsonLd.author = { "@type": "Person", name: row.author };
      }
      if (row.image_url) {
        jsonLd.image = row.image_url;
      }

      reply.header("Content-Type", "application/ld+json");
      return reply.send(JSON.stringify(jsonLd, null, 2));
    } catch (err) {
      return app.httpErrors.internalServerError(String(err?.message ?? err));
    } finally {
      db.close();
    }
  });

  // ── 9. GET /api/structured-data/county/:county ──────────────────────────
  app.get("/api/structured-data/county/:county", async (req, reply) => {
    reply.header("Access-Control-Allow-Origin", "*");
    const rawCounty = decodeURIComponent(String(req.params?.county ?? ""));
    const county = normalizeCounty(rawCounty);
    if (!county) return app.httpErrors.badRequest("Invalid county");

    const db = openDb();
    try {
      ensureSchema(db);
      const rows = db
        .prepare(
          `SELECT i.id, i.title
           FROM items i
           JOIN item_locations il ON il.item_id = i.id
           WHERE il.state_code = 'KY'
             AND il.county = @county
             AND i.region_scope = 'ky'
             AND COALESCE(i.published_at, i.fetched_at) >= datetime('now', '-7 days')
           ORDER BY COALESCE(i.published_at, i.fetched_at) DESC
           LIMIT 20`
        )
        .all({ county });

      const displayName = displayCountyName(county);
      const slug = countySlug(county);

      const jsonLd = {
        "@context": "https://schema.org",
        "@type": "ItemList",
        name: `${displayName} County News`,
        description: `Latest local news from ${displayName} County, Kentucky`,
        url: `${SITE_ORIGIN}/county/${slug}`,
        numberOfItems: rows.length,
        itemListElement: rows.map((row, idx) => ({
          "@type": "ListItem",
          position: idx + 1,
          url: `${SITE_ORIGIN}/news/${row.id}`,
          name: row.title || ""
        }))
      };

      reply.header("Content-Type", "application/ld+json");
      return reply.send(JSON.stringify(jsonLd, null, 2));
    } catch (err) {
      return app.httpErrors.internalServerError(String(err?.message ?? err));
    } finally {
      db.close();
    }
  });
}

```

# apps\api\src\server.mjs

```mjs
import Fastify from "fastify";
import cors from "@fastify/cors";
import sensible from "@fastify/sensible";
import { z } from "zod";
import path from "node:path";
import fs from "node:fs/promises";
import { spawn } from "node:child_process";
import { fileURLToPath } from "node:url";
import { openDb } from "./db.mjs";
import { ensureSchema } from "./schema.mjs";
import { buildSearchClause, isKy, mapItemRow, normalizeCounty } from "./search.mjs";
import { insertAdminLog, requireAdmin } from "./security.mjs";
import { registerWeatherRoutes } from "./weather.mjs";
import { registerLostFoundRoutes } from "./lostFound.mjs";
import { registerSeoRoutes } from "./seo.mjs";
import kyCounties from "../../ingester/src/ky-counties.json" with { type: "json" };
import kyCityCounty from "../../ingester/src/ky-city-county.json" with { type: "json" };

const app = Fastify({ logger: true, bodyLimit: 10 * 1024 * 1024 });

await app.register(cors, {
  origin: [/^http:\/\/localhost:5173$/, /^http:\/\/127\.0\.0\.1:5173$/, /^http:\/\/\[::1\]:5173$/],
  credentials: false
});

await app.register(sensible);

app.addContentTypeParser(/^image\/.*/, { parseAs: "buffer" }, (_req, body, done) => {
  done(null, body);
});

app.addContentTypeParser("application/octet-stream", { parseAs: "buffer" }, (_req, body, done) => {
  done(null, body);
});

const moduleDir = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(moduleDir, "..", "..", "..");
const uploadDir = path.resolve(repoRoot, "data", "uploads", "lost-found");
const ingesterScript = path.resolve(repoRoot, "apps", "ingester", "src", "ingester.mjs");

await fs.mkdir(uploadDir, { recursive: true });

{
  const db = openDb();
  ensureSchema(db);
  db.close();
}

app.get("/api/health", async () => ({ ok: true, now: new Date().toISOString() }));

app.get("/sitemap.xml", async (_req, reply) => {
  const siteUrl = getSiteUrl();

  const staticRoutes = [
    { path: "/", changefreq: "daily", priority: 1.0 },
    { path: "/local", changefreq: "weekly", priority: 0.4 },
    { path: "/weather", changefreq: "weekly", priority: 0.4 },
    { path: "/lost-found", changefreq: "weekly", priority: 0.4 }
  ];

  const db = openDb();
  let articleRows = [];
  let lostFoundRows = [];
  try {
    ensureSchema(db);
    articleRows = db
      .prepare(
        `
        SELECT id, COALESCE(published_at, fetched_at) AS lastmod
        FROM items
        ORDER BY COALESCE(published_at, fetched_at) DESC
        LIMIT 500
      `
      )
      .all();

    lostFoundRows = db
      .prepare(
        `
        SELECT id, submitted_at
        FROM lost_found_posts
        WHERE status = 'approved'
          AND COALESCE(is_resolved, 0) = 0
        ORDER BY submitted_at DESC
        LIMIT 500
      `
      )
      .all();
  } finally {
    db.close();
  }

  const urlTags = [];

  for (const entry of staticRoutes) {
    urlTags.push(
      buildSitemapUrlTag({
        loc: `${siteUrl}${entry.path}`,
        changefreq: entry.changefreq,
        priority: entry.priority
      })
    );
  }

  for (const slug of KY_COUNTY_SLUGS) {
    urlTags.push(
      buildSitemapUrlTag({
        loc: `${siteUrl}/news/${encodeURIComponent(slug)}`,
        changefreq: "daily",
        priority: 0.8
      })
    );
  }

  for (const row of articleRows) {
    const lastmod = parseIso(row.lastmod);
    urlTags.push(
      buildSitemapUrlTag({
        loc: `${siteUrl}/item/${encodeURIComponent(String(row.id || ""))}`,
        lastmod: lastmod || undefined,
        changefreq: "monthly",
        priority: 0.6
      })
    );
  }

  for (const row of lostFoundRows) {
    const lastmod = parseIso(row.submitted_at);
    urlTags.push(
      buildSitemapUrlTag({
        loc: `${siteUrl}/lost-found?post=${encodeURIComponent(String(row.id || ""))}`,
        lastmod: lastmod || undefined,
        changefreq: "weekly",
        priority: 0.4
      })
    );
  }

  const xml = [
    '<?xml version="1.0" encoding="UTF-8"?>',
    '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">',
    ...urlTags,
    "</urlset>"
  ].join("\n");

  reply.header("content-type", "application/xml; charset=utf-8");
  return reply.send(xml);
});

app.get("/robots.txt", async (_req, reply) => {
  const siteUrl = getSiteUrl();
  const body = [
    "User-agent: *",
    "Allow: /",
    "Disallow: /admin",
    "Disallow: /api/",
    `Sitemap: ${siteUrl}/sitemap.xml`
  ].join("\n");
  reply.header("content-type", "text/plain; charset=utf-8");
  return reply.send(body);
});

const NEWS_SCOPES = ["ky", "national", "all"];
const PAID_SOURCE_DOMAINS = [
  "bizjournals.com",
  "courier-journal.com",
  "dailyindependent.com",
  "franklinfavorite.com",
  "kentucky.com",
  "kentuckynewera.com",
  "messenger-inquirer.com",
  "news-expressky.com",
  "paducahsun.com",
  "richmondregister.com",
  "salyersvilleindependent.com",
  "state-journal.com",
  "thenewsenterprise.com",
  "timesleader.net"
];
const HEAVY_DEPRIORITIZED_PAID_DOMAINS = ["dailyindependent.com"];
const PAID_FALLBACK_LIMIT = 2;
const PAID_FALLBACK_WHEN_EMPTY_LIMIT = 3;
const MIN_ITEM_WORDS = 50;
const DEFAULT_SITE_URL = "https://localky.news";

function normLocationText(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/&amp;/g, "&")
    .replace(/[^a-z0-9]+/g, " ")
    .trim();
}

function getSiteUrl() {
  return String(process.env.SITE_URL || DEFAULT_SITE_URL).replace(/\/+$/g, "");
}

function countyNameToSlug(name) {
  const normalized = String(name || "")
    .trim()
    .replace(/\s+county$/i, "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-+|-+$/g, "");
  if (!normalized) return "";
  return `${normalized}-county`;
}

const KY_COUNTY_SLUGS = Array.from(
  new Set(
    (Array.isArray(kyCounties) ? kyCounties : [])
      .map((row) => countyNameToSlug(row?.name))
      .filter(Boolean)
  )
);

function xmlEscape(value) {
  return String(value || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&apos;");
}

function parseIso(value) {
  const d = new Date(String(value || ""));
  if (Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}

function buildSitemapUrlTag({ loc, changefreq, priority, lastmod }) {
  const lines = ["  <url>", `    <loc>${xmlEscape(loc)}</loc>`];
  if (lastmod) lines.push(`    <lastmod>${xmlEscape(lastmod)}</lastmod>`);
  if (changefreq) lines.push(`    <changefreq>${xmlEscape(changefreq)}</changefreq>`);
  if (priority != null) lines.push(`    <priority>${Number(priority).toFixed(1)}</priority>`);
  lines.push("  </url>");
  return lines.join("\n");
}

const KY_COUNTY_PATTERNS = (() => {
  const names = (kyCounties || []).map((c) => c.name).filter(Boolean);
  names.sort((a, b) => b.length - a.length);
  return names.map((name) => {
    const n = normLocationText(name);
    const re = new RegExp(`\\b${n.replace(/\\s+/g, "\\s+")}\\s+(county|co\\.?)(\\b|\\s|,|\\.)`, "i");
    return { name, re };
  });
})();

const KY_CITY_PATTERNS = (() => {
  const rows = Array.isArray(kyCityCounty) ? kyCityCounty : [];
  const cities = rows
    .map((r) => ({ city: String(r.city || "").trim(), county: String(r.county || "").trim() }))
    .filter((r) => r.city && r.county);
  cities.sort((a, b) => b.city.length - a.city.length);
  return cities.map(({ city, county }) => {
    const n = normLocationText(city);
    const re = new RegExp(`\\b${n.replace(/\\s+/g, "\\s+")}\\b`, "i");
    return { city, county, re };
  });
})();

const KY_QUERY_COUNTY_PATTERNS = (() => {
  const names = (kyCounties || []).map((c) => c.name).filter(Boolean);
  names.sort((a, b) => b.length - a.length);
  return names.map((name) => {
    const n = normLocationText(name);
    const re = new RegExp(`\\b${n.replace(/\\s+/g, "\\s+")}(?:\\s+(?:county|co\\.?))?\\b`, "i");
    return { name, re };
  });
})();

const OTHER_STATE_NAME_PATTERNS = [
  "Alabama",
  "Alaska",
  "Arizona",
  "Arkansas",
  "California",
  "Colorado",
  "Connecticut",
  "Delaware",
  "Florida",
  "Georgia",
  "Hawaii",
  "Idaho",
  "Illinois",
  "Indiana",
  "Iowa",
  "Kansas",
  "Louisiana",
  "Maine",
  "Maryland",
  "Massachusetts",
  "Michigan",
  "Minnesota",
  "Mississippi",
  "Missouri",
  "Montana",
  "Nebraska",
  "Nevada",
  "New Hampshire",
  "New Jersey",
  "New Mexico",
  "New York",
  "North Carolina",
  "North Dakota",
  "Ohio",
  "Oklahoma",
  "Oregon",
  "Pennsylvania",
  "Rhode Island",
  "South Carolina",
  "South Dakota",
  "Tennessee",
  "Texas",
  "Utah",
  "Vermont",
  "Virginia",
  "Washington",
  "West Virginia",
  "Wisconsin",
  "Wyoming",
  "District of Columbia"
].map((name) => ({
  name,
  re: new RegExp(`\\b${normLocationText(name).replace(/\\s+/g, "\\s+")}\\b`, "i")
}));

function detectOtherStateNames(text) {
  const t = normLocationText(text);
  if (!t) return [];
  const out = [];
  for (const { name, re } of OTHER_STATE_NAME_PATTERNS) {
    if (re.test(t)) out.push(name);
  }
  return Array.from(new Set(out));
}

function detectKyCounties(text) {
  const t = normLocationText(text);
  if (!t) return [];

  const out = [];
  const raw = String(text || "");
  const hasKyContext = /\bkentucky\b/i.test(raw) || /\bky\b/i.test(raw);

  for (const { name, re } of KY_COUNTY_PATTERNS) {
    if (re.test(t)) out.push(name);
  }

  if (hasKyContext) {
    for (const { county, re } of KY_CITY_PATTERNS) {
      if (re.test(t)) out.push(county);
    }
  }

  return Array.from(new Set(out));
}

function hasKySignal(text, counties) {
  if (counties.length) return true;
  const raw = String(text || "");
  return /\bkentucky\b/i.test(raw) || /\bky\b/i.test(raw);
}

function detectKyQueryCounties(text) {
  const t = normLocationText(text);
  if (!t) return [];

  const out = [];
  for (const { name, re } of KY_QUERY_COUNTY_PATTERNS) {
    if (re.test(t)) out.push(name);
  }

  for (const { city, county, re } of KY_CITY_PATTERNS) {
    if (city.length < 4) continue;
    if (re.test(t)) out.push(county);
  }

  return Array.from(new Set(out));
}

function parseCountyList(input) {
  if (!input) return [];
  const raw = Array.isArray(input) ? input : String(input).split(",");
  const out = [];
  for (const value of raw) {
    const county = normalizeCounty(value);
    if (!county) continue;
    if (!out.includes(county)) out.push(county);
  }
  return out;
}

function parseItemsCursor(cursor) {
  if (!cursor) return null;
  const raw = String(cursor);
  const [ts, id] = raw.split("|");
  if (!ts) return null;
  return { ts, id: id || null };
}

function sourceHost(url) {
  try {
    return new URL(String(url || "")).hostname.replace(/^www\./, "").toLowerCase();
  } catch {
    return "";
  }
}

function canonicalUrl(url) {
  try {
    const u = new URL(String(url || ""));
    for (const key of [...u.searchParams.keys()]) {
      if (/^(utm_|fbclid$|gclid$|mc_eid$|mkt_tok$)/i.test(key)) {
        u.searchParams.delete(key);
      }
    }
    u.hash = "";
    const pathname = u.pathname.replace(/\/+$/, "");
    u.pathname = pathname || "/";
    return u.toString();
  } catch {
    return "";
  }
}

function isPaidSource(url) {
  const host = sourceHost(url);
  if (!host) return false;
  return PAID_SOURCE_DOMAINS.some((d) => host === d || host.endsWith(`.${d}`));
}

function isHeavyDeprioritizedPaidSource(url) {
  const host = sourceHost(url);
  if (!host) return false;
  return HEAVY_DEPRIORITIZED_PAID_DOMAINS.some((d) => host === d || host.endsWith(`.${d}`));
}

function countWords(input) {
  return String(input || "")
    .trim()
    .split(/\s+/)
    .filter(Boolean).length;
}

function itemHasMinimumWords(item) {
  const summaryWords = countWords(item.summary);
  const contentWords = countWords(item.content);
  return Math.max(summaryWords, contentWords) >= MIN_ITEM_WORDS;
}

function titleFingerprint(title) {
  return String(title || "")
    .toLowerCase()
    .replace(/[^a-z0-9 ]+/g, " ")
    .replace(/\b(the|a|an|and|or|for|to|of|in|on|at|from|with)\b/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function rankAndFilterItems(items, limit) {
  const ranked = items.map((item) => ({
    ...item,
    _isPaid: isPaidSource(item.url),
    _isHeavyPaid: isHeavyDeprioritizedPaidSource(item.url),
    _fp: titleFingerprint(item.title),
    _canonicalUrl: canonicalUrl(item.url),
    _source: sourceHost(item.url),
    _sortTs: String(item.sort_ts || "")
  }));

  ranked.sort((a, b) => {
    if (a._isPaid !== b._isPaid) return a._isPaid ? 1 : -1;
    if (a._isHeavyPaid !== b._isHeavyPaid) return a._isHeavyPaid ? 1 : -1;
    return b._sortTs.localeCompare(a._sortTs);
  });

  const nonPaidFingerprints = new Set(ranked.filter((x) => !x._isPaid && x._fp).map((x) => x._fp));
  const seenTitle = new Set();
  const seenCanonicalUrl = new Set();
  const seenSourceTitle = new Set();
  const filtered = [];
  for (const item of ranked) {
    if (!itemHasMinimumWords(item)) continue;
    if (item._isPaid && item._fp && nonPaidFingerprints.has(item._fp)) continue;
    if (item._canonicalUrl && seenCanonicalUrl.has(item._canonicalUrl)) continue;
    if (item._fp && seenTitle.has(item._fp)) continue;
    const sourceTitleKey = item._fp ? `${item._fp}|${item._source}` : item.id;
    if (seenSourceTitle.has(sourceTitleKey)) continue;
    if (item._canonicalUrl) seenCanonicalUrl.add(item._canonicalUrl);
    if (item._fp) seenTitle.add(item._fp);
    seenSourceTitle.add(sourceTitleKey);
    filtered.push(item);
  }
  const nonPaid = filtered.filter((item) => !item._isPaid);
  const paid = filtered.filter((item) => item._isPaid && !item._isHeavyPaid);
  const heavyPaid = filtered.filter((item) => item._isHeavyPaid);
  const pickedNonPaid = nonPaid.slice(0, limit);
  const paidAllowance =
    pickedNonPaid.length === 0
      ? Math.min(limit, PAID_FALLBACK_WHEN_EMPTY_LIMIT)
      : Math.min(PAID_FALLBACK_LIMIT, Math.max(1, Math.floor(limit * 0.1)));
  const pickedPaid = paid.slice(0, paidAllowance);
  const heavyPaidAllowance = pickedNonPaid.length === 0 && pickedPaid.length === 0 ? Math.min(1, limit) : 0;
  const pickedHeavyPaid = heavyPaid.slice(0, heavyPaidAllowance);

  return [...pickedNonPaid, ...pickedPaid, ...pickedHeavyPaid]
    .slice(0, limit)
    .map(({ _isPaid, _isHeavyPaid, _fp, _canonicalUrl, _source, _sortTs, ...rest }) => rest);
}

function isPrivateHost(hostname) {
  const host = String(hostname || "").toLowerCase();
  if (!host) return true;
  if (host === "localhost" || host === "127.0.0.1" || host === "::1") return true;
  if (host.startsWith("10.") || host.startsWith("192.168.")) return true;
  if (/^172\.(1[6-9]|2\d|3[0-1])\./.test(host)) return true;
  return false;
}

function stripExecutableHtml(html) {
  return String(html || "")
    .replace(/<script[\s\S]*?<\/script>/gi, "")
    .replace(/<noscript[\s\S]*?<\/noscript>/gi, "")
    .replace(/<style[\s\S]*?<\/style>/gi, "")
    .replace(/<iframe[\s\S]*?<\/iframe>/gi, "")
    .replace(/<object[\s\S]*?<\/object>/gi, "")
    .replace(/<embed[\s\S]*?>/gi, "")
    .replace(/<link[^>]+rel=["'][^"']*stylesheet[^"']*["'][^>]*>/gi, "")
    .replace(/<meta[^>]+http-equiv=["']content-security-policy["'][^>]*>/gi, "")
    .replace(/\son\w+="[^"]*"/gi, "")
    .replace(/\son\w+='[^']*'/gi, "");
}

app.get("/api/feeds", async (req) => {
  const parsed = z
    .object({ scope: z.enum(NEWS_SCOPES).default("all") })
    .safeParse(req.query ?? {});

  if (!parsed.success) return app.httpErrors.badRequest("Invalid query");
  const { scope } = parsed.data;

  const db = openDb();
  try {
    ensureSchema(db);
    const rows = db
      .prepare(
        `
        SELECT id, name, category, url, state_code, region_scope, enabled
        FROM feeds
        WHERE enabled=1
          AND (@scope='all' OR region_scope=@scope)
        ORDER BY CASE region_scope WHEN 'ky' THEN 0 ELSE 1 END, category, name
      `
      )
      .all({ scope });
    return { feeds: rows };
  } finally {
    db.close();
  }
});

const ItemsQuery = z.object({
  feedId: z.string().optional(),
  category: z.string().min(1).max(80).optional(),
  scope: z.enum(NEWS_SCOPES).default("ky"),
  state: z.string().length(2).optional(),
  county: z.string().min(1).max(80).optional(),
  counties: z.union([z.string(), z.array(z.string())]).optional(),
  unfiltered: z.string().optional(),
  hours: z.coerce.number().min(0).max(24 * 365).default(2),
  cursor: z.string().optional(),
  limit: z.coerce.number().min(1).max(100).default(30)
});

const handleItemsRoute = async (req) => {
  const parsed = ItemsQuery.safeParse(req.query ?? {});
  if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

  const { feedId, category, scope, state, county, counties, unfiltered, hours, cursor, limit } = parsed.data;
  const countyList = county ? [normalizeCounty(county)] : parseCountyList(counties);
  const includeUnfiltered = ["1", "true", "yes"].includes(String(unfiltered || "").toLowerCase());

  if ((state || countyList.length) && scope === "national") {
    return app.httpErrors.badRequest("State/county filters only apply to KY scope");
  }

  const db = openDb();
  try {
    ensureSchema(db);

    const where = [];
    const params = { limit: includeUnfiltered ? limit : Math.min(limit * 4, 400) };

    if (hours > 0) {
      where.push("COALESCE(i.published_at, i.fetched_at) >= datetime('now', @since)");
      params.since = `-${hours} hours`;
    }

    if (scope !== "all") {
      where.push("i.region_scope = @scope");
      params.scope = scope;
    }

    const needsFi = Boolean(feedId || category);
    if (feedId) {
      where.push("fi.feed_id = @feedId");
      params.feedId = feedId;
    }
    if (category) {
      where.push("f.category = @category");
      params.category = category;
    }

    const stateCode = (state || "KY").toUpperCase();
    const needsLoc = scope !== "national" && Boolean(state || countyList.length);

    if (needsLoc) {
      where.push("i.region_scope = 'ky'");
      params.stateCode = stateCode;
      if (countyList.length) {
        const placeholders = countyList.map((_, idx) => `@county${idx}`);
        where.push(`il.state_code = @stateCode AND il.county IN (${placeholders.join(", ")})`);
        countyList.forEach((c, idx) => {
          params[`county${idx}`] = c;
        });
      } else {
        where.push("il.state_code = @stateCode AND il.county = ''");
      }
    }

    const parsedCursor = parseItemsCursor(cursor);
    if (parsedCursor) {
      if (parsedCursor.id) {
        where.push(
          "(COALESCE(i.published_at, i.fetched_at) < @cursorTs OR (COALESCE(i.published_at, i.fetched_at) = @cursorTs AND i.id < @cursorId))"
        );
        params.cursorTs = parsedCursor.ts;
        params.cursorId = parsedCursor.id;
      } else {
        where.push("COALESCE(i.published_at, i.fetched_at) < @cursorTs");
        params.cursorTs = parsedCursor.ts;
      }
    }

    const whereSql = where.length ? where.join(" AND ") : "1=1";

    const sql = `
      SELECT DISTINCT
        i.id, i.title, i.url, i.author, i.region_scope, i.published_at, i.summary, i.content, i.image_url,
        COALESCE(i.published_at, i.fetched_at) AS sort_ts,
        (
          SELECT group_concat(DISTINCT ilx.state_code)
          FROM item_locations ilx
          WHERE ilx.item_id = i.id AND ilx.county = ''
        ) AS states_csv,
        (
          SELECT group_concat(DISTINCT ily.county)
          FROM item_locations ily
          WHERE ily.item_id = i.id AND ily.county != ''
        ) AS counties_csv
      FROM items i
      ${needsFi ? "JOIN feed_items fi ON fi.item_id = i.id" : ""}
      ${category ? "JOIN feeds f ON f.id = fi.feed_id" : ""}
      ${needsLoc ? "JOIN item_locations il ON il.item_id = i.id" : ""}
      WHERE ${whereSql}
      ORDER BY sort_ts DESC, i.id DESC
      LIMIT @limit
    `;

    const itemsRaw = db.prepare(sql).all(params);
    const mappedItems = itemsRaw.map(mapItemRow);
    const items = includeUnfiltered ? mappedItems.slice(0, limit) : rankAndFilterItems(mappedItems, limit);
    const nextCursor = items.length ? `${items[items.length - 1].sort_ts}|${items[items.length - 1].id}` : null;
    return { items, nextCursor };
  } finally {
    db.close();
  }
};

app.get("/api/items", handleItemsRoute);
app.get("/api/articles", handleItemsRoute);

const CountiesQuery = z.object({
  state: z.string().length(2).default("KY"),
  hours: z.coerce.number().min(0).max(24 * 365).default(2)
});

app.get("/api/counties", async (req) => {
  const parsed = CountiesQuery.safeParse(req.query ?? {});
  if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

  const { state, hours } = parsed.data;
  if (!isKy(state)) return app.httpErrors.badRequest("Only KY county counts are supported currently");

  const db = openDb();
  try {
    ensureSchema(db);
    const where = [
      "il.state_code = @stateCode",
      "il.county != ''",
      "i.region_scope = 'ky'"
    ];
    const params = { stateCode: state.toUpperCase() };
    if (hours > 0) {
      where.push("COALESCE(i.published_at, i.fetched_at) >= datetime('now', @since)");
      params.since = `-${hours} hours`;
    }

    const rows = db
      .prepare(
        `
        SELECT il.county AS county, COUNT(DISTINCT il.item_id) AS count
        FROM item_locations il
        JOIN items i ON i.id = il.item_id
        WHERE ${where.join(" AND ")}
        GROUP BY il.county
        ORDER BY il.county
      `
      )
      .all(params);

    return { state: state.toUpperCase(), hours, counties: rows };
  } finally {
    db.close();
  }
});

const SearchQuery = z.object({
  q: z.string().min(1).max(200),
  scope: z.enum(NEWS_SCOPES).default("ky"),
  state: z.string().length(2).optional(),
  county: z.string().min(1).max(80).optional(),
  counties: z.union([z.string(), z.array(z.string())]).optional(),
  hours: z.coerce.number().min(1).max(24 * 365).optional(),
  sort: z.enum(["newest", "oldest"]).default("newest"),
  cursor: z.string().optional(),
  limit: z.coerce.number().min(1).max(100).default(30)
});

app.get("/api/search", async (req) => {
  const parsed = SearchQuery.safeParse(req.query ?? {});
  if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

  const { q, scope, state, county, counties, hours, sort, cursor, limit } = parsed.data;
  const countyList = county ? [normalizeCounty(county)] : parseCountyList(counties);

  if ((state || countyList.length) && scope === "national") {
    return app.httpErrors.badRequest("State/county filters only apply to KY scope");
  }

  const db = openDb();
  try {
    ensureSchema(db);

    const where = [];
    const params = { limit: Math.min(limit * 4, 400) };

    const searchClause = buildSearchClause(q, params);
    const hintedCounties =
      scope === "national"
        ? []
        : Array.from(new Set(detectKyQueryCounties(q).map((x) => normalizeCounty(x)).filter(Boolean)));
    if (hintedCounties.length) {
      const hintPlaceholders = hintedCounties.map((_, idx) => `@hintCounty${idx}`);
      where.push(`(${searchClause} OR EXISTS (
        SELECT 1
        FROM item_locations ilh
        WHERE ilh.item_id = i.id
          AND ilh.state_code = 'KY'
          AND ilh.county IN (${hintPlaceholders.join(", ")})
      ))`);
      hintedCounties.forEach((countyName, idx) => {
        params[`hintCounty${idx}`] = countyName;
      });
    } else {
      where.push(searchClause);
    }
    if (hours != null) {
      where.push("COALESCE(i.published_at, i.fetched_at) >= datetime('now', @since)");
      params.since = `-${hours} hours`;
    }

    if (scope !== "all") {
      where.push("i.region_scope = @scope");
      params.scope = scope;
    }

    const needsLoc = scope !== "national" && Boolean(state || countyList.length);
    if (needsLoc) {
      params.stateCode = (state || "KY").toUpperCase();
      where.push("i.region_scope = 'ky'");
      if (countyList.length) {
        const placeholders = countyList.map((_, idx) => `@county${idx}`);
        where.push(`il.state_code = @stateCode AND il.county IN (${placeholders.join(", ")})`);
        countyList.forEach((c, idx) => {
          params[`county${idx}`] = c;
        });
      } else {
        where.push("il.state_code = @stateCode AND il.county = ''");
      }
    }

    if (cursor) {
      where.push(`COALESCE(i.published_at, i.fetched_at) ${sort === "oldest" ? ">" : "<"} @cursor`);
      params.cursor = cursor;
    }

    const sql = `
      SELECT DISTINCT
        i.id, i.title, i.url, i.author, i.region_scope, i.published_at, i.summary, i.content, i.image_url,
        COALESCE(i.published_at, i.fetched_at) AS sort_ts,
        (
          SELECT group_concat(DISTINCT ilx.state_code)
          FROM item_locations ilx
          WHERE ilx.item_id = i.id AND ilx.county = ''
        ) AS states_csv,
        (
          SELECT group_concat(DISTINCT ily.county)
          FROM item_locations ily
          WHERE ily.item_id = i.id AND ily.county != ''
        ) AS counties_csv
      FROM items i
      ${needsLoc ? "JOIN item_locations il ON il.item_id = i.id" : ""}
      WHERE ${where.join(" AND ")}
      ORDER BY sort_ts ${sort === "oldest" ? "ASC" : "DESC"}
      LIMIT @limit
    `;

    const itemsRaw = db.prepare(sql).all(params);
    const items = rankAndFilterItems(itemsRaw.map(mapItemRow), limit);
    const nextCursor = items.length ? items[items.length - 1].sort_ts : null;

    return { items, nextCursor };
  } finally {
    db.close();
  }
});

app.get("/api/items/:id", async (req) => {
  const id = req.params?.id;
  const db = openDb();
  try {
    ensureSchema(db);
    const itemRaw = db
      .prepare(
        "SELECT id, title, url, author, region_scope, published_at, summary, content, image_url, (SELECT group_concat(DISTINCT state_code) FROM item_locations WHERE item_id=items.id AND county='') AS states_csv, (SELECT group_concat(DISTINCT county) FROM item_locations WHERE item_id=items.id AND county!='') AS counties_csv FROM items WHERE id=?"
      )
      .get(id);

    if (!itemRaw) return app.httpErrors.notFound("Not found");
    return { item: mapItemRow(itemRaw) };
  } finally {
    db.close();
  }
});

const OpenProxyQuery = z.object({
  url: z.string().url()
});

app.get("/api/open-proxy", async (req) => {
  const parsed = OpenProxyQuery.safeParse(req.query ?? {});
  if (!parsed.success) return app.httpErrors.badRequest("Invalid URL");

  let target;
  try {
    target = new URL(parsed.data.url);
  } catch {
    return app.httpErrors.badRequest("Invalid URL");
  }

  if (!["http:", "https:"].includes(target.protocol)) {
    return app.httpErrors.badRequest("Only HTTP(S) URLs are allowed");
  }
  if (isPrivateHost(target.hostname)) {
    return app.httpErrors.badRequest("Private/local hosts are not allowed");
  }

  const ctrl = new AbortController();
  const timeout = setTimeout(() => ctrl.abort(), 15000);
  try {
    const upstream = await fetch(target.toString(), {
      redirect: "follow",
      signal: ctrl.signal,
      headers: {
        "user-agent": "Mozilla/5.0 (compatible; KentuckyNewsApp/1.0)",
        accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
      }
    });

    if (!upstream.ok) {
      return app.httpErrors.badGateway(`Upstream returned ${upstream.status}`);
    }

    const contentType = (upstream.headers.get("content-type") || "").toLowerCase();
    if (!contentType.includes("text/html") && !contentType.includes("application/xhtml")) {
      return app.httpErrors.unsupportedMediaType("Upstream content is not HTML");
    }

    const finalUrl = upstream.url || target.toString();
    let html = await upstream.text();
    if (html.length > 1_500_000) html = html.slice(0, 1_500_000);

    const safeHtml = stripExecutableHtml(html);
    const titleMatch = safeHtml.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
    const title = titleMatch ? titleMatch[1].replace(/\s+/g, " ").trim() : "";

    const framedHtml = [
      "<!doctype html><html><head>",
      `<base href="${finalUrl.replace(/"/g, "&quot;")}">`,
      "<meta charset=\"utf-8\"/>",
      "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"/>",
      "<style>html,body{margin:0;padding:0;background:#fff;color:#111;font-family:Roboto,Arial,sans-serif}img,video,iframe{max-width:100%;height:auto}body{padding:10px}</style>",
      "</head><body>",
      safeHtml,
      "</body></html>"
    ].join("");

    return { url: target.toString(), finalUrl, title, html: framedHtml };
  } catch (err) {
    return app.httpErrors.badGateway(String(err?.message || err));
  } finally {
    clearTimeout(timeout);
  }
});

registerWeatherRoutes(app, openDb);
registerLostFoundRoutes(app, openDb, uploadDir);
registerSeoRoutes(app, openDb);

async function runIngestOnce() {
  return new Promise((resolve, reject) => {
    const child = spawn(process.execPath, [ingesterScript, "--once"], {
      cwd: repoRoot,
      env: { ...process.env, INGEST_ONCE: "1" }
    });

    let stdout = "";
    let stderr = "";
    const timeout = setTimeout(() => child.kill("SIGTERM"), 180000);

    child.stdout.on("data", (buf) => {
      stdout += String(buf);
      if (stdout.length > 12000) stdout = stdout.slice(-12000);
    });

    child.stderr.on("data", (buf) => {
      stderr += String(buf);
      if (stderr.length > 12000) stderr = stderr.slice(-12000);
    });

    child.on("error", (err) => {
      clearTimeout(timeout);
      reject(err);
    });

    child.on("close", (code) => {
      clearTimeout(timeout);
      resolve({ code, stdout, stderr });
    });
  });
}

app.post("/api/admin/feeds/reload", async (req) => {
  const admin = requireAdmin(app, req);
  const run = await runIngestOnce();
  const ok = Number(run.code) === 0;

  const db = openDb();
  try {
    ensureSchema(db);
    insertAdminLog(db, admin.email, "feeds.reload", "ingester", "manual", {
      code: run.code,
      stderr: run.stderr.slice(-500)
    });
  } finally {
    db.close();
  }

  if (!ok) {
    return app.httpErrors.internalServerError({
      ok: false,
      code: run.code,
      stderr: run.stderr,
      stdout: run.stdout
    });
  }

  return {
    ok: true,
    code: run.code,
    stdout: run.stdout,
    stderr: run.stderr
  };
});

const RevalidateItemsBody = z.object({
  hours: z.coerce.number().min(1).max(24 * 90).default(72),
  limit: z.coerce.number().min(1).max(3000).default(800),
  minWords: z.coerce.number().min(1).max(1000).default(50),
  dryRun: z.boolean().default(true),
  includeNational: z.boolean().default(false)
});

function chunkArray(values, chunkSize) {
  const size = Math.max(1, Math.floor(Number(chunkSize) || 1));
  const out = [];
  for (let i = 0; i < values.length; i += size) {
    out.push(values.slice(i, i + size));
  }
  return out;
}

function locationSet(rows) {
  return new Set(
    rows.map((row) => `${String(row.state_code || "").toUpperCase()}|${normalizeCounty(row.county || "")}`)
  );
}

function sameSet(a, b) {
  if (a.size !== b.size) return false;
  for (const value of a) {
    if (!b.has(value)) return false;
  }
  return true;
}

function tableHasColumn(db, table, column) {
  try {
    const rows = db.prepare(`PRAGMA table_info(${table})`).all();
    return rows.some((row) => String(row?.name || "") === column);
  } catch {
    return false;
  }
}

app.post("/api/admin/items/revalidate", async (req) => {
  const admin = requireAdmin(app, req);
  const parsed = RevalidateItemsBody.safeParse(req.body ?? {});
  if (!parsed.success) {
    return app.httpErrors.badRequest("Invalid payload");
  }

  const options = parsed.data;
  const db = openDb();
  try {
    ensureSchema(db);
    const hasArticleExcerpt = tableHasColumn(db, "items", "article_text_excerpt");
    const hasRegionScope = tableHasColumn(db, "items", "region_scope");
    const excerptSelect = hasArticleExcerpt
      ? "i.article_text_excerpt AS article_text_excerpt"
      : "'' AS article_text_excerpt";
    const scopeWhere = options.includeNational || !hasRegionScope ? "" : "AND i.region_scope='ky'";
    const rows = db
      .prepare(
        `
        SELECT
          i.id,
          i.title,
          i.summary,
          i.content,
          ${excerptSelect}
        FROM items i
        WHERE COALESCE(i.published_at, i.fetched_at) >= datetime('now', @window)
          ${scopeWhere}
        ORDER BY COALESCE(i.published_at, i.fetched_at) DESC
        LIMIT @limit
        `
      )
      .all({
        window: `-${options.hours} hours`,
        limit: options.limit
      });

    const summary = {
      scanned: rows.length,
      dryRun: options.dryRun,
      hours: options.hours,
      limit: options.limit,
      minWords: options.minWords,
      includeNational: options.includeNational,
      unchanged: 0,
      wouldRetag: 0,
      retagged: 0,
      wouldPrune: 0,
      pruned: 0,
      prunedFeedLinks: 0,
      samples: []
    };

    if (!rows.length) {
      insertAdminLog(db, admin.email, "items.revalidate", "items", "batch", summary);
      return { ok: true, summary };
    }

    const ids = rows.map((r) => String(r.id || "")).filter(Boolean);
    const tags = [];
    for (const batch of chunkArray(ids, 200)) {
      if (!batch.length) continue;
      const partial = db
        .prepare(
          `
          SELECT item_id, state_code, county
          FROM item_locations
          WHERE item_id IN (${batch.map(() => "?").join(",")})
          `
        )
        .all(...batch);
      tags.push(...partial);
    }

    const tagsByItem = new Map();
    for (const row of tags) {
      const id = String(row.item_id || "");
      if (!id) continue;
      const list = tagsByItem.get(id) || [];
      list.push({
        state_code: String(row.state_code || "").toUpperCase(),
        county: normalizeCounty(row.county || "")
      });
      tagsByItem.set(id, list);
    }

    const countFeedRefsStmt = db.prepare("SELECT COUNT(1) AS refs FROM feed_items WHERE item_id=?");
    const delFeedRefsStmt = db.prepare("DELETE FROM feed_items WHERE item_id=?");
    const delTagsStmt = db.prepare("DELETE FROM item_locations WHERE item_id=?");
    const delItemStmt = db.prepare("DELETE FROM items WHERE id=?");
    const delKyTagsStmt = db.prepare("DELETE FROM item_locations WHERE item_id=? AND state_code='KY'");
    const insStateStmt = db.prepare(
      "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, 'KY', '')"
    );
    const insCountyStmt = db.prepare(
      "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, 'KY', ?)"
    );

    for (const row of rows) {
      const itemId = String(row.id || "");
      if (!itemId) continue;

      const title = String(row.title || "");
      const summaryText = String(row.summary || "");
      const content = String(row.content || "");
      const excerpt = String(row.article_text_excerpt || "");
      const articleText = excerpt || content || "";
      const qualityText = articleText || summaryText || "";
      const words = countWords(qualityText);

      if (words < options.minWords) {
        summary.wouldPrune += 1;
        if (summary.samples.length < 20) {
          summary.samples.push({ item_id: itemId, action: "prune", words, title });
        }
        if (!options.dryRun) {
          const refs = countFeedRefsStmt.get(itemId);
          delFeedRefsStmt.run(itemId);
          delTagsStmt.run(itemId);
          delItemStmt.run(itemId);
          summary.pruned += 1;
          summary.prunedFeedLinks += Number(refs?.refs || 0);
        }
        continue;
      }

      const fullText = articleText;
      const titleCounties = detectKyCounties(title);
      const bodyCounties = detectKyCounties(fullText);
      const taggedCounties = new Set([...titleCounties, ...bodyCounties].map((x) => normalizeCounty(x)).filter(Boolean));
      const titleKySignal = hasKySignal(title, titleCounties);
      const bodyKySignal = hasKySignal(fullText, bodyCounties);
      const hasStrongKySignal = titleKySignal || bodyKySignal || taggedCounties.size > 0;
      const titleOtherStates = detectOtherStateNames(title);
      const bodyOtherStates = detectOtherStateNames(fullText);
      const hasTitleOutOfStateSignal = titleOtherStates.length > 0 && !titleKySignal && titleCounties.length === 0;
      const hasPrimaryOutOfStateSignal = bodyOtherStates.length > 0 && !bodyKySignal && bodyCounties.length === 0;
      const shouldTagAsKy =
        hasStrongKySignal &&
        !hasTitleOutOfStateSignal &&
        !hasPrimaryOutOfStateSignal;

      const existing = tagsByItem.get(itemId) || [];
      const nonKy = existing.filter((t) => t.state_code !== "KY");
      const desired = [...nonKy];
      if (shouldTagAsKy) {
        desired.push({ state_code: "KY", county: "" });
        for (const county of Array.from(taggedCounties).sort((a, b) => a.localeCompare(b))) {
          desired.push({ state_code: "KY", county });
        }
      }

      const currentSet = locationSet(existing);
      const desiredSet = locationSet(desired);
      if (sameSet(currentSet, desiredSet)) {
        summary.unchanged += 1;
        continue;
      }

      summary.wouldRetag += 1;
      if (summary.samples.length < 20) {
        summary.samples.push({
          item_id: itemId,
          action: "retag",
          title,
          counties: Array.from(taggedCounties).sort((a, b) => a.localeCompare(b)),
          should_tag_ky: shouldTagAsKy
        });
      }

      if (!options.dryRun) {
        delKyTagsStmt.run(itemId);
        if (shouldTagAsKy) {
          insStateStmt.run(itemId);
          for (const county of Array.from(taggedCounties)) {
            insCountyStmt.run(itemId, county);
          }
        }
        summary.retagged += 1;
      }
    }

    insertAdminLog(db, admin.email, "items.revalidate", "items", "batch", summary);
    return { ok: true, summary };
  } finally {
    db.close();
  }
});

const port = Number(process.env.PORT || 8787);
const host = process.env.HOST || "127.0.0.1";
app.listen({ port, host });

```

# apps\api\src\weather.mjs

```mjs
import { z } from "zod";
import { ensureSchema } from "./schema.mjs";
import { normalizeCounty, safeJsonParse } from "./search.mjs";

const WEATHER_STATES = ["KY"];
const NWS_USER_AGENT = process.env.NWS_USER_AGENT || "EasternKentuckyNews/1.0 (local-dev@example.com)";
let kyZoneCache = { loadedAt: 0, zones: new Map() };

async function nwsFetchJson(url) {
  const res = await fetch(url, {
    headers: {
      Accept: "application/geo+json",
      "User-Agent": NWS_USER_AGENT
    }
  });

  if (!res.ok) {
    const body = await res.text().catch(() => "");
    throw new Error(`NWS request failed (${res.status}): ${body.slice(0, 240)}`);
  }

  return res.json();
}

async function getKyCountyZoneMap() {
  const now = Date.now();
  if (now - kyZoneCache.loadedAt < 6 * 60 * 60 * 1000 && kyZoneCache.zones.size) {
    return kyZoneCache.zones;
  }

  const zones = new Map();
  let nextUrl = "https://api.weather.gov/zones?type=county&area=KY";
  let guard = 0;

  while (nextUrl && guard < 10) {
    guard += 1;
    const payload = await nwsFetchJson(nextUrl);
    const features = Array.isArray(payload?.features) ? payload.features : [];

    for (const feature of features) {
      const props = feature?.properties || {};
      const zoneId = props.id;
      const zoneName = normalizeCounty(props.name || "");
      if (!zoneId || !zoneName) continue;
      zones.set(zoneName.toLowerCase(), zoneId);
    }

    nextUrl = payload?.pagination?.next || null;
  }

  kyZoneCache = { loadedAt: now, zones };
  return zones;
}

async function fetchCountyForecast(county) {
  const countyKey = normalizeCounty(county).toLowerCase();
  if (!countyKey) throw new Error("County is required");

  const zones = await getKyCountyZoneMap();
  const countyZoneId = zones.get(countyKey);
  if (!countyZoneId) throw new Error(`No NWS county zone found for ${county}`);

  const countyZone = await nwsFetchJson(`https://api.weather.gov/zones/county/${countyZoneId}`);
  const geometry = countyZone?.geometry;
  const centroid = getGeometryCentroid(geometry);
  if (!centroid) throw new Error(`No geometry centroid for county zone ${countyZoneId}`);

  const points = await nwsFetchJson(
    `https://api.weather.gov/points/${centroid.lat.toFixed(4)},${centroid.lon.toFixed(4)}`
  );
  const forecastUrl = String(points?.properties?.forecast || "");
  if (!forecastUrl) throw new Error(`No forecast URL returned for county zone ${countyZoneId}`);

  const forecastZoneUri = String(points?.properties?.forecastZone || "");
  const forecastZoneId = forecastZoneUri.split("/").filter(Boolean).pop() || countyZoneId;
  const payload = await nwsFetchJson(forecastUrl);
  const props = payload?.properties || {};
  const periodsRaw = Array.isArray(props.periods) ? props.periods : [];

  const periods = periodsRaw.slice(0, 14).map((p) => ({
    name: p.name,
    startTime: p.startTime,
    endTime: p.endTime,
    temperature: p.temperature,
    temperatureUnit: p.temperatureUnit,
    windSpeed: p.windSpeed,
    windDirection: p.windDirection,
    shortForecast: p.shortForecast,
    detailedForecast: p.detailedForecast,
    icon: p.icon
  }));

  return {
    state: "KY",
    county: normalizeCounty(county),
    zoneId: forecastZoneId,
    countyZoneId,
    updatedAt: props.updated || new Date().toISOString(),
    periods,
    source: "api.weather.gov"
  };
}

function getGeometryCentroid(geometry) {
  const points = [];

  if (!geometry || !geometry.type || !Array.isArray(geometry.coordinates)) return null;

  if (geometry.type === "Polygon") {
    for (const ring of geometry.coordinates) {
      for (const pair of ring) points.push(pair);
    }
  }

  if (geometry.type === "MultiPolygon") {
    for (const polygon of geometry.coordinates) {
      for (const ring of polygon) {
        for (const pair of ring) points.push(pair);
      }
    }
  }

  const valid = points.filter((pair) => Array.isArray(pair) && pair.length >= 2);
  if (!valid.length) return null;

  let lon = 0;
  let lat = 0;
  for (const pair of valid) {
    lon += Number(pair[0]);
    lat += Number(pair[1]);
  }

  return { lon: lon / valid.length, lat: lat / valid.length };
}

async function fetchCountyAlerts(stateCode, county) {
  const payload = await nwsFetchJson(`https://api.weather.gov/alerts/active?area=${encodeURIComponent(stateCode)}`);
  const features = Array.isArray(payload?.features) ? payload.features : [];
  const countyFilter = county ? normalizeCounty(county).toLowerCase() : null;

  const alerts = [];
  for (const feature of features) {
    const props = feature?.properties || {};
    const areaDesc = String(props.areaDesc || "").toLowerCase();
    if (countyFilter && !areaDesc.includes(countyFilter)) continue;

    alerts.push({
      id: String(feature.id || props.id || ""),
      event: props.event || "Unknown",
      severity: props.severity || "Unknown",
      headline: props.headline || props.event || "Alert",
      description: props.description || "",
      instruction: props.instruction || "",
      starts_at: props.onset || props.effective || null,
      ends_at: props.ends || props.expires || null,
      sent_at: props.sent || null,
      status: props.status || null,
      url: props.url || null,
      area_desc: props.areaDesc || ""
    });
  }

  return alerts;
}

export function registerWeatherRoutes(app, openDb) {
  const WeatherForecastQuery = z.object({
    state: z.string().length(2).default("KY"),
    county: z.string().min(2).max(80)
  });

  app.get("/api/weather/forecast", async (req) => {
    const parsed = WeatherForecastQuery.safeParse(req.query ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

    const { state, county } = parsed.data;
    if (!WEATHER_STATES.includes(state.toUpperCase())) {
      return app.httpErrors.badRequest("Weather forecast currently supports KY only");
    }

    const normalizedCounty = normalizeCounty(county);
    const db = openDb();

    try {
      ensureSchema(db);

      const cached = db
        .prepare(
          `
          SELECT forecast_json, fetched_at, expires_at
          FROM weather_forecasts
          WHERE state_code=@stateCode AND county=@county
          ORDER BY fetched_at DESC
          LIMIT 1
        `
        )
        .get({ stateCode: "KY", county: normalizedCounty });

      const nowIso = new Date().toISOString();
      if (cached && cached.expires_at > nowIso) {
        return {
          ...safeJsonParse(cached.forecast_json, {}),
          fetchedAt: cached.fetched_at,
          expiresAt: cached.expires_at,
          cached: true
        };
      }

      const live = await fetchCountyForecast(normalizedCounty);
      const expiresAt = new Date(Date.now() + 60 * 60 * 1000).toISOString();

      db.prepare(
        "INSERT INTO weather_forecasts (state_code, county, forecast_json, expires_at) VALUES (?, ?, ?, ?)"
      ).run("KY", normalizedCounty, JSON.stringify(live), expiresAt);

      db.prepare("DELETE FROM weather_forecasts WHERE fetched_at < datetime('now', '-7 days')").run();

      return {
        ...live,
        fetchedAt: new Date().toISOString(),
        expiresAt,
        cached: false
      };
    } catch (err) {
      const fallback = db
        .prepare(
          `
          SELECT forecast_json, fetched_at, expires_at
          FROM weather_forecasts
          WHERE state_code=@stateCode AND county=@county
          ORDER BY fetched_at DESC
          LIMIT 1
        `
        )
        .get({ stateCode: "KY", county: normalizedCounty });

      if (fallback) {
        return {
          ...safeJsonParse(fallback.forecast_json, {}),
          fetchedAt: fallback.fetched_at,
          expiresAt: fallback.expires_at,
          cached: true,
          stale: true,
          warning: String(err?.message || err)
        };
      }

      throw app.httpErrors.badGateway(String(err?.message || err));
    } finally {
      db.close();
    }
  });

  const WeatherAlertsQuery = z.object({
    state: z.string().length(2).default("KY"),
    county: z.string().min(2).max(80).optional()
  });

  app.get("/api/weather/alerts", async (req) => {
    const parsed = WeatherAlertsQuery.safeParse(req.query ?? {});
    if (!parsed.success) return app.httpErrors.badRequest("Invalid query");

    const { state, county } = parsed.data;
    const stateCode = state.toUpperCase();
    const normalizedCounty = county ? normalizeCounty(county) : "";

    if (!WEATHER_STATES.includes(stateCode)) {
      return app.httpErrors.badRequest("Weather alerts currently support KY only");
    }

    const db = openDb();
    try {
      ensureSchema(db);

      const liveAlerts = await fetchCountyAlerts(stateCode, normalizedCounty || null);

      db.prepare("DELETE FROM weather_alerts WHERE state_code=@stateCode AND county=@county").run({
        stateCode,
        county: normalizedCounty
      });

      const insert = db.prepare(
        `
        INSERT INTO weather_alerts (
          alert_id, state_code, county, severity, event, headline, starts_at, ends_at, raw_json
        ) VALUES (
          @alert_id, @state_code, @county, @severity, @event, @headline, @starts_at, @ends_at, @raw_json
        )
      `
      );

      for (const alert of liveAlerts) {
        insert.run({
          alert_id: alert.id,
          state_code: stateCode,
          county: normalizedCounty,
          severity: alert.severity,
          event: alert.event,
          headline: alert.headline,
          starts_at: alert.starts_at,
          ends_at: alert.ends_at,
          raw_json: JSON.stringify(alert)
        });
      }

      db.prepare("DELETE FROM weather_alerts WHERE fetched_at < datetime('now', '-48 hours')").run();

      return {
        state: stateCode,
        county: normalizedCounty || null,
        alerts: liveAlerts,
        fetchedAt: new Date().toISOString(),
        source: "api.weather.gov"
      };
    } catch (err) {
      const rows = db
        .prepare(
          `
          SELECT raw_json
          FROM weather_alerts
          WHERE state_code=@stateCode AND county=@county
          ORDER BY fetched_at DESC
          LIMIT 100
        `
        )
        .all({ stateCode, county: normalizedCounty });

      if (rows.length) {
        return {
          state: stateCode,
          county: normalizedCounty || null,
          alerts: rows.map((r) => safeJsonParse(r.raw_json, null)).filter(Boolean),
          stale: true,
          warning: String(err?.message || err)
        };
      }

      throw app.httpErrors.badGateway(String(err?.message || err));
    } finally {
      db.close();
    }
  });
}

```

# apps\ingester\package.json

```json
{
  "name": "@local-ky-news/ingester",
  "private": true,
  "type": "module",
  "version": "0.1.0",
  "scripts": {
    "dev": "node src/ingester.mjs"
  },
  "dependencies": {
    "better-sqlite3": "^11.0.0",
    "node-cron": "^3.0.3",
    "rss-parser": "^3.13.0",
    "undici": "^6.19.8",
    "cheerio": "^1.0.0-rc.12"
  }
}

```

# apps\ingester\src\db.mjs

```mjs
import path from "node:path";
import { fileURLToPath } from "node:url";
import Database from "better-sqlite3";

const moduleDir = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(moduleDir, "..", "..", "..");

function defaultDbPath() {
  return path.resolve(repoRoot, "data", "dev.sqlite");
}

const DB_PATH = process.env.DB_PATH ? path.resolve(process.env.DB_PATH) : defaultDbPath();

export function openDb() {
  const db = new Database(DB_PATH);
  db.pragma("journal_mode = WAL");
  return db;
}

```

# apps\ingester\src\ingester.mjs

```mjs
import cron from "node-cron";
import Parser from "rss-parser";
import { fetch } from "undici";
import * as cheerio from "cheerio";
import { openDb } from "./db.mjs";
import { makeItemId, pickImage, stableHash, toIsoOrNull } from "./util.mjs";
import kyCounties from "./ky-counties.json" with { type: "json" };
import kyCityCounty from "./ky-city-county.json" with { type: "json" };

const parser = new Parser({
  customFields: {
    item: [
      ["media:content", "media:content"],
      ["media:thumbnail", "media:thumbnail"],
      ["itunes:image", "itunes:image"]
    ]
  }
});

const INTERVAL_MINUTES = Number(process.env.INGEST_INTERVAL_MINUTES || 15);
const FEED_TIMEOUT_MS = Number(process.env.FEED_TIMEOUT_MS || 15000);
const ARTICLE_TIMEOUT_MS = Number(process.env.ARTICLE_TIMEOUT_MS || 12000);
const ARTICLE_MAX_CHARS = Number(process.env.ARTICLE_MAX_CHARS || 2_000_000); // HTML chars
const EXCERPT_MAX_CHARS = Number(process.env.ARTICLE_EXCERPT_MAX_CHARS || 10_000);
const MIN_ARTICLE_WORDS = Number(process.env.MIN_ARTICLE_WORDS || 50);

// Simple text normalization for matching
function norm(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/&amp;/g, "&")
    .replace(/[^a-z0-9]+/g, " ")
    .trim();
}

function textWordCount(input) {
  return String(input || "")
    .trim()
    .split(/\s+/)
    .filter(Boolean).length;
}

const KY_COUNTY_PATTERNS = (() => {
  const names = (kyCounties || []).map((c) => c.name).filter(Boolean);
  names.sort((a, b) => b.length - a.length);
  return names.map((name) => {
    const n = norm(name);
    // Match "X county", "X co", "X co.", etc.
    const re = new RegExp(`\\b${n.replace(/\s+/g, "\\s+")}\\s+(county|co\\.?)(\\b|\\s|,|\\.)`, "i");
    return { name, re };
  });
})();


const KY_CITY_PATTERNS = (() => {
  const rows = Array.isArray(kyCityCounty) ? kyCityCounty : [];
  // Longer first to avoid partial matches ("Fort Thomas" before "Thomas")
  const cities = rows
    .map((r) => ({ city: String(r.city || "").trim(), county: String(r.county || "").trim() }))
    .filter((r) => r.city && r.county);
  cities.sort((a, b) => b.city.length - a.city.length);

  return cities.map(({ city, county }) => {
    const n = norm(city);
    // Match city name as a whole phrase (word boundaries), allowing whitespace between words.
    const re = new RegExp(`\\b${n.replace(/\\s+/g, "\\s+")}\\b`, "i");
    return { city, county, re };
  });
})();

const OTHER_STATE_NAME_PATTERNS = (() => {
  const names = [
    "Alabama",
    "Alaska",
    "Arizona",
    "Arkansas",
    "California",
    "Colorado",
    "Connecticut",
    "Delaware",
    "Florida",
    "Georgia",
    "Hawaii",
    "Idaho",
    "Illinois",
    "Indiana",
    "Iowa",
    "Kansas",
    "Louisiana",
    "Maine",
    "Maryland",
    "Massachusetts",
    "Michigan",
    "Minnesota",
    "Mississippi",
    "Missouri",
    "Montana",
    "Nebraska",
    "Nevada",
    "New Hampshire",
    "New Jersey",
    "New Mexico",
    "New York",
    "North Carolina",
    "North Dakota",
    "Ohio",
    "Oklahoma",
    "Oregon",
    "Pennsylvania",
    "Rhode Island",
    "South Carolina",
    "South Dakota",
    "Tennessee",
    "Texas",
    "Utah",
    "Vermont",
    "Virginia",
    "Washington",
    "West Virginia",
    "Wisconsin",
    "Wyoming",
    "District of Columbia"
  ];
  return names.map((name) => ({
    name,
    re: new RegExp(`\\b${norm(name).replace(/\s+/g, "\\s+")}\\b`, "i")
  }));
})();

function hasKySignal(text, counties) {
  if (counties.length) return true;
  const raw = String(text || "");
  return /\bkentucky\b/i.test(raw) || /\bky\b/i.test(raw);
}

function detectOtherStateNames(text) {
  const t = norm(text);
  if (!t) return [];
  const out = [];
  for (const { name, re } of OTHER_STATE_NAME_PATTERNS) {
    if (re.test(t)) out.push(name);
  }
  return Array.from(new Set(out));
}



function detectKyCounties(text) {
  const t = norm(text);
  if (!t) return [];
  const out = [];
  const raw = String(text || "");
  const hasKyContext = /\bkentucky\b/i.test(raw) || /\bky\b/i.test(raw);

  // Direct county mentions: "X County" / "X Co."
  for (const { name, re } of KY_COUNTY_PATTERNS) {
    if (re.test(t)) out.push(name);
  }

  // City names are highly ambiguous across states; require explicit Kentucky context.
  if (hasKyContext) {
    for (const { county, re } of KY_CITY_PATTERNS) {
      if (re.test(t)) out.push(county);
    }
  }

  return Array.from(new Set(out));
}

function extractReadableText(html) {
  const $ = cheerio.load(html, { decodeEntities: true });

  // Remove obvious non-content
  $("script,style,noscript,iframe,svg,canvas,form,header,footer,nav,aside,button").remove();

  // Prefer semantic containers when present
  let text = $("article").text() || $("main").text() || $("#main").text() || $("body").text() || "";
  text = text
    .replace(/\s+/g, " ")
    .replace(/\u00a0/g, " ")
    .trim();

  if (text.length > EXCERPT_MAX_CHARS) text = text.slice(0, EXCERPT_MAX_CHARS);
  return text;
}

function pickOgImage(html) {
  try {
    const $ = cheerio.load(html, { decodeEntities: true });
    const og =
      $('meta[property="og:image"]').attr("content") ||
      $('meta[name="og:image"]').attr("content") ||
      $('meta[property="twitter:image"]').attr("content") ||
      $('meta[name="twitter:image"]').attr("content") ||
      null;
    if (og && /^https?:\/\//i.test(og)) return og;
  } catch {
    // ignore
  }
  return null;
}

function pickInlineImage(html, pageUrl) {
  try {
    const $ = cheerio.load(html, { decodeEntities: true });
    const imgs = $("article img, main img, .entry-content img, .post-content img, img").toArray();
    for (const el of imgs) {
      const src =
        $(el).attr("src") ||
        $(el).attr("data-src") ||
        $(el).attr("data-lazy-src") ||
        $(el).attr("data-original");
      if (!src) continue;
      const lower = String(src).toLowerCase();
      if (lower.startsWith("data:")) continue;
      if (/\b(sprite|logo|icon|avatar)\b/i.test(lower)) continue;

      let abs = "";
      try {
        abs = new URL(src, pageUrl).toString();
      } catch {
        abs = "";
      }
      if (!/^https?:\/\//i.test(abs)) continue;
      return abs;
    }
  } catch {
    // ignore
  }
  return null;
}

async function fetchArticle(url) {
  if (!url || !/^https?:\/\//i.test(url)) return { status: "skip", text: "", ogImage: null };

  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), ARTICLE_TIMEOUT_MS);

  try {
    const res = await fetch(url, {
      redirect: "follow",
      signal: ctrl.signal,
      headers: {
        // Gentle headers; many sites respond better with a UA.
        "user-agent": "Mozilla/5.0 (compatible; LocalKYNews/1.0; +https://localkynews.com)",
        "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
      }
    });

    if (res.status < 200 || res.status >= 300) return { status: `http_${res.status}`, text: "", ogImage: null };

    const ct = (res.headers.get("content-type") || "").toLowerCase();
    if (!ct.includes("text/html") && !ct.includes("application/xhtml")) {
      return { status: "non_html", text: "", ogImage: null };
    }

    let html = await res.text();
    if (html.length > ARTICLE_MAX_CHARS) html = html.slice(0, ARTICLE_MAX_CHARS);

    const ogImage = pickOgImage(html) || pickInlineImage(html, url);
    const text = extractReadableText(html);
    return { status: "ok", text, ogImage };
  } catch (e) {
    return { status: "error", text: "", ogImage: null };
  } finally {
    clearTimeout(t);
  }
}

function ensureSchema(db) {
  // Add optional columns for article fetching (safe to run repeatedly)
  const itemCols = db.prepare("PRAGMA table_info(items)").all().map((r) => r.name);
  const feedCols = db.prepare("PRAGMA table_info(feeds)").all().map((r) => r.name);
  const add = (name, type) => {
    if (!itemCols.includes(name)) {
      db.prepare(`ALTER TABLE items ADD COLUMN ${name} ${type}`).run();
    }
  };
  const addFeed = (name, type) => {
    if (!feedCols.includes(name)) {
      db.prepare(`ALTER TABLE feeds ADD COLUMN ${name} ${type}`).run();
    }
  };
  addFeed("region_scope", "TEXT NOT NULL DEFAULT 'ky'");
  addFeed("default_county", "TEXT");
  add("region_scope", "TEXT NOT NULL DEFAULT 'ky'");
  add("article_checked_at", "TEXT");
  add("article_fetch_status", "TEXT");
  add("article_text_excerpt", "TEXT");
}

function recordError(db, feedId, err) {
  db.prepare("INSERT INTO fetch_errors (feed_id, at, error) VALUES (?, datetime('now'), ?)").run(
    feedId,
    String(err?.stack || err)
  );
}

function startRun(db) {
  const stmt = db.prepare("INSERT INTO fetch_runs (started_at, status) VALUES (datetime('now'), 'running')");
  const info = stmt.run();
  return info.lastInsertRowid;
}

function finishRun(db, runId, status) {
  db.prepare("UPDATE fetch_runs SET finished_at=datetime('now'), status=? WHERE id=?").run(status, runId);
}

async function fetchWithConditional(url, etag, lastModified) {
  const headers = {};
  if (etag) headers["If-None-Match"] = etag;
  if (lastModified) headers["If-Modified-Since"] = lastModified;

  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), FEED_TIMEOUT_MS);

  try {
    const res = await fetch(url, { headers, redirect: "follow", signal: ctrl.signal });

    if (res.status === 304) return { status: 304, etag, lastModified, text: null };
    if (res.status < 200 || res.status >= 300) {
      const body = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} for ${url} :: ${body.slice(0, 200)}`);
    }

    const newEtag = res.headers.get("etag") || etag || null;
    const newLast = res.headers.get("last-modified") || lastModified || null;
    const text = await res.text();
    return { status: res.status, etag: newEtag, lastModified: newLast, text };
  } finally {
    clearTimeout(t);
  }
}

function upsertItemAndLink(db, feedId, row) {
  const insertItem = db.prepare(`
    INSERT INTO items (id, title, url, guid, author, region_scope, published_at, summary, content, image_url, hash)
    VALUES (@id, @title, @url, @guid, @author, @region_scope, @published_at, @summary, @content, @image_url, @hash)
    ON CONFLICT(id) DO UPDATE SET
      title=excluded.title,
      author=excluded.author,
      region_scope=excluded.region_scope,
      published_at=excluded.published_at,
      summary=excluded.summary,
      content=excluded.content,
      image_url=excluded.image_url,
      hash=excluded.hash
  `);

  const linkFeedItem = db.prepare(`INSERT OR IGNORE INTO feed_items (feed_id, item_id) VALUES (?, ?)`);

  insertItem.run(row);
  linkFeedItem.run(feedId, row.id);
}

function removeLowWordItem(db, feedId, itemId) {
  db.prepare("DELETE FROM feed_items WHERE feed_id=? AND item_id=?").run(feedId, itemId);
  const refs = db.prepare("SELECT COUNT(1) AS refs FROM feed_items WHERE item_id=?").get(itemId);
  if (Number(refs?.refs || 0) <= 0) {
    db.prepare("DELETE FROM items WHERE id=?").run(itemId);
  }
}

async function tagItemLocations(db, itemId, stateCode, parts, url) {
  const st = (stateCode || "KY").toUpperCase();

  const del = db.prepare("DELETE FROM item_locations WHERE item_id=? AND state_code=?");
  const ins = db.prepare(
    "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, ?, ?)"
  );

  del.run(itemId, st);

  const titleText = String(parts?.[0] || "");
  const seedArticleText = textOnly(parts.slice(1).filter(Boolean).join(" \n "));

  const meta = db
    .prepare("SELECT article_checked_at, article_fetch_status, image_url FROM items WHERE id=?")
    .get(itemId);

  const alreadyChecked = Boolean(meta?.article_checked_at);
  const needsImage = !String(meta?.image_url || "").trim();

  let excerpt = "";
  if ((needsImage || !seedArticleText) && !alreadyChecked) {
    const fetched = await fetchArticle(url);
    excerpt = fetched.text || "";

    const update = db.prepare(`
      UPDATE items
      SET
        article_checked_at = datetime('now'),
        article_fetch_status = @status,
        article_text_excerpt = @excerpt,
        content = COALESCE(content, @excerpt),
        image_url = COALESCE(image_url, @ogImage)
      WHERE id=@id
    `);
    update.run({
      id: itemId,
      status: fetched.status,
      excerpt: excerpt || null,
      ogImage: fetched.ogImage || null
    });
  }

  const articleText = textOnly(excerpt || seedArticleText);
  const titleCounties = detectKyCounties(titleText);
  const bodyCounties = detectKyCounties(articleText);
  const taggedCounties = new Set([...titleCounties, ...bodyCounties].map((county) => normalizeCounty(county)).filter(Boolean));
  const titleKySignal = st !== "KY" ? true : hasKySignal(titleText, titleCounties);
  const bodyKySignal = st !== "KY" ? true : hasKySignal(articleText, bodyCounties);

  const hasTitleOutOfStateSignal =
    st === "KY" &&
    detectOtherStateNames(titleText).length > 0 &&
    !titleKySignal &&
    titleCounties.length === 0;
  const hasPrimaryOutOfStateSignal =
    st === "KY" &&
    detectOtherStateNames(articleText).length > 0 &&
    !bodyKySignal &&
    bodyCounties.length === 0;
  if (st === "KY" && (hasTitleOutOfStateSignal || hasPrimaryOutOfStateSignal)) {
    return;
  }

  const hasStrongKySignal =
    st !== "KY" ||
    titleKySignal ||
    bodyKySignal ||
    taggedCounties.size > 0;
  const shouldTagAsKy = st !== "KY" || hasStrongKySignal;
  if (!shouldTagAsKy) return;

  // Keep a state-level marker for valid in-state content.
  ins.run(itemId, st, "");

  if (st === "KY") {
    for (const county of taggedCounties) ins.run(itemId, st, county);
  }
}

async function ingestOnce() {
  const db = openDb();
  ensureSchema(db);
  const runId = startRun(db);

  try {
    const feeds = db
      .prepare(
        "SELECT id, url, etag, last_modified, state_code, region_scope, default_county FROM feeds WHERE enabled=1 ORDER BY name"
      )
      .all();

    const updateFeedMeta = db.prepare(`
      UPDATE feeds
      SET etag=@etag, last_modified=@last_modified, last_checked_at=datetime('now')
      WHERE id=@id
    `);

    const tx = db.transaction((fn) => fn());

    for (const f of feeds) {
      try {
        const { status, etag, lastModified, text } = await fetchWithConditional(f.url, f.etag, f.last_modified);
        updateFeedMeta.run({ id: f.id, etag, last_modified: lastModified });

        if (status === 304 || !text) continue;

        const feed = await parser.parseString(text);
        const items = feed.items || [];

        for (const it of items) {
          const published_at = toIsoOrNull(it.isoDate || it.pubDate);
          const url = it.link || it.guid || "";
          const title = (it.title || "").trim() || "(untitled)";
          const summary = (it.contentSnippet || "").trim() || null;
          const content = (it.content || "").trim() || null;
          const author = (it.creator || it.author || "").trim() || null;
          const image_url = pickImage(it);

          const id = makeItemId({ url, guid: it.guid, title, published_at });
          const hash = stableHash([title, url, summary || "", content || "", author || "", published_at || ""].join("|"));

          // Upsert item + link in a quick transaction
          tx(() => {
            upsertItemAndLink(db, f.id, {
              id,
              title,
              url,
              guid: it.guid || null,
              author,
              region_scope: f.region_scope === "national" ? "national" : "ky",
              published_at,
              summary,
              content,
              image_url,
              hash
            });
          });

          // Only Kentucky feeds participate in state/county tagging.
          if ((f.region_scope || "ky") === "ky") {
            await tagItemLocations(
              db,
              id,
              f.state_code || "KY",
              [title, content || ""],
              url
            );
          }

          const quality = db
            .prepare("SELECT article_text_excerpt, content, summary FROM items WHERE id=? LIMIT 1")
            .get(id);
          const qualityText = String(quality?.article_text_excerpt || quality?.content || quality?.summary || "");
          if (textWordCount(qualityText) < MIN_ARTICLE_WORDS) {
            removeLowWordItem(db, f.id, id);
          }
        }
      } catch (err) {
        recordError(db, f.id, err);
        // keep going
      }
    }

    finishRun(db, runId, "ok");
  } catch (err) {
    finishRun(db, runId, "failed");
    throw err;
  } finally {
    db.close();
  }
}

function log(msg) {
  const ts = new Date().toISOString();
  console.log(`[ingester] ${ts} ${msg}`);
}

async function main() {
  const runOnce = process.argv.includes("--once") || process.env.INGEST_ONCE === "1";
  log(`Starting ingester. Interval: ${INTERVAL_MINUTES} minutes`);

  // Run once at startup
  await ingestOnce().catch((e) => log(`Initial ingest failed: ${String(e?.message || e)}`));

  if (runOnce) {
    log("Ingest once complete, exiting.");
    return;
  }

  // Then on schedule
  cron.schedule(`*/${INTERVAL_MINUTES} * * * *`, async () => {
    log("Ingest tick");
    await ingestOnce().catch((e) => log(`Ingest failed: ${String(e?.message || e)}`));
  });
}

main();

```

# apps\ingester\src\ky-city-county.json

```json
[
  {
    "city": "Columbia",
    "county": "Adair"
  },
  {
    "city": "Scottsville",
    "county": "Allen"
  },
  {
    "city": "Lawrenceburg",
    "county": "Anderson"
  },
  {
    "city": "Barlow",
    "county": "Ballard"
  },
  {
    "city": "Blandville",
    "county": "Ballard"
  },
  {
    "city": "Kevil",
    "county": "Ballard"
  },
  {
    "city": "La Center",
    "county": "Ballard"
  },
  {
    "city": "Wickliffe",
    "county": "Ballard"
  },
  {
    "city": "Cave City",
    "county": "Barren"
  },
  {
    "city": "Glasgow",
    "county": "Barren"
  },
  {
    "city": "Park City",
    "county": "Barren"
  },
  {
    "city": "Owingsville",
    "county": "Bath"
  },
  {
    "city": "Salt Lick",
    "county": "Bath"
  },
  {
    "city": "Sharpsburg",
    "county": "Bath"
  },
  {
    "city": "Middlesboro",
    "county": "Bell"
  },
  {
    "city": "Pineville",
    "county": "Bell"
  },
  {
    "city": "Florence",
    "county": "Boone"
  },
  {
    "city": "Union",
    "county": "Boone"
  },
  {
    "city": "Walton",
    "county": "Boone"
  },
  {
    "city": "Millersburg",
    "county": "Bourbon"
  },
  {
    "city": "North Middletown",
    "county": "Bourbon"
  },
  {
    "city": "Paris",
    "county": "Bourbon"
  },
  {
    "city": "Ashland",
    "county": "Boyd"
  },
  {
    "city": "Catlettsburg",
    "county": "Boyd"
  },
  {
    "city": "Danville",
    "county": "Boyle"
  },
  {
    "city": "Junction City",
    "county": "Boyle"
  },
  {
    "city": "Perryville",
    "county": "Boyle"
  },
  {
    "city": "Augusta",
    "county": "Bracken"
  },
  {
    "city": "Brooksville",
    "county": "Bracken"
  },
  {
    "city": "Germantown",
    "county": "Bracken"
  },
  {
    "city": "Jackson",
    "county": "Breathitt"
  },
  {
    "city": "Cloverport",
    "county": "Breckinridge"
  },
  {
    "city": "Hardinsburg",
    "county": "Breckinridge"
  },
  {
    "city": "Irvington",
    "county": "Breckinridge"
  },
  {
    "city": "Fox Chase",
    "county": "Bullitt"
  },
  {
    "city": "Hebron Estates",
    "county": "Bullitt"
  },
  {
    "city": "Hillview",
    "county": "Bullitt"
  },
  {
    "city": "Huntertown",
    "county": "Bullitt"
  },
  {
    "city": "Lebanon Junction",
    "county": "Bullitt"
  },
  {
    "city": "Mount Washington",
    "county": "Bullitt"
  },
  {
    "city": "Pioneer Village",
    "county": "Bullitt"
  },
  {
    "city": "Shepherdsville",
    "county": "Bullitt"
  },
  {
    "city": "Morgantown",
    "county": "Butler"
  },
  {
    "city": "Rochester",
    "county": "Butler"
  },
  {
    "city": "Woodbury",
    "county": "Butler"
  },
  {
    "city": "Fredonia",
    "county": "Caldwell"
  },
  {
    "city": "Princeton",
    "county": "Caldwell"
  },
  {
    "city": "Hazel",
    "county": "Calloway"
  },
  {
    "city": "Murray",
    "county": "Calloway"
  },
  {
    "city": "Alexandria",
    "county": "Campbell"
  },
  {
    "city": "Bellevue",
    "county": "Campbell"
  },
  {
    "city": "California",
    "county": "Campbell"
  },
  {
    "city": "Cold Spring",
    "county": "Campbell"
  },
  {
    "city": "Crestview",
    "county": "Campbell"
  },
  {
    "city": "Dayton",
    "county": "Campbell"
  },
  {
    "city": "Fort Thomas",
    "county": "Campbell"
  },
  {
    "city": "Highland Heights",
    "county": "Campbell"
  },
  {
    "city": "Melbourne",
    "county": "Campbell"
  },
  {
    "city": "Mentor",
    "county": "Campbell"
  },
  {
    "city": "Newport",
    "county": "Campbell"
  },
  {
    "city": "Silver Grove",
    "county": "Campbell"
  },
  {
    "city": "Southgate",
    "county": "Campbell"
  },
  {
    "city": "Wilder",
    "county": "Campbell"
  },
  {
    "city": "Woodlawn",
    "county": "Campbell"
  },
  {
    "city": "Arlington",
    "county": "Carlisle"
  },
  {
    "city": "Bardwell",
    "county": "Carlisle"
  },
  {
    "city": "Carrollton",
    "county": "Carroll"
  },
  {
    "city": "Ghent",
    "county": "Carroll"
  },
  {
    "city": "Prestonville",
    "county": "Carroll"
  },
  {
    "city": "Sanders",
    "county": "Carroll"
  },
  {
    "city": "Worthville",
    "county": "Carroll"
  },
  {
    "city": "Grayson",
    "county": "Carter"
  },
  {
    "city": "Olive Hill",
    "county": "Carter"
  },
  {
    "city": "Liberty",
    "county": "Casey"
  },
  {
    "city": "Crofton",
    "county": "Christian"
  },
  {
    "city": "Hopkinsville",
    "county": "Christian"
  },
  {
    "city": "Lafayette",
    "county": "Christian"
  },
  {
    "city": "Oak Grove",
    "county": "Christian"
  },
  {
    "city": "Pembroke",
    "county": "Christian"
  },
  {
    "city": "Winchester",
    "county": "Clark"
  },
  {
    "city": "Manchester",
    "county": "Clay"
  },
  {
    "city": "Albany",
    "county": "Clinton"
  },
  {
    "city": "Marion",
    "county": "Crittenden"
  },
  {
    "city": "Burkesville",
    "county": "Cumberland"
  },
  {
    "city": "Owensboro",
    "county": "Daviess"
  },
  {
    "city": "Whitesville",
    "county": "Daviess"
  },
  {
    "city": "Brownsville",
    "county": "Edmonson"
  },
  {
    "city": "Sandy Hook",
    "county": "Elliott"
  },
  {
    "city": "Irvine",
    "county": "Estill"
  },
  {
    "city": "Ravenna",
    "county": "Estill"
  },
  {
    "city": "Lexington",
    "county": "Fayette"
  },
  {
    "city": "Ewing",
    "county": "Fleming"
  },
  {
    "city": "Flemingsburg",
    "county": "Fleming"
  },
  {
    "city": "Nepton",
    "county": "Fleming"
  },
  {
    "city": "Allen",
    "county": "Floyd"
  },
  {
    "city": "Martin",
    "county": "Floyd"
  },
  {
    "city": "Prestonsburg",
    "county": "Floyd"
  },
  {
    "city": "Wayland",
    "county": "Floyd"
  },
  {
    "city": "Wheelwright",
    "county": "Floyd"
  },
  {
    "city": "Frankfort",
    "county": "Franklin"
  },
  {
    "city": "Fulton",
    "county": "Fulton"
  },
  {
    "city": "Hickman",
    "county": "Fulton"
  },
  {
    "city": "Glencoe",
    "county": "Gallatin"
  },
  {
    "city": "Sparta",
    "county": "Gallatin"
  },
  {
    "city": "Warsaw",
    "county": "Gallatin"
  },
  {
    "city": "Lancaster",
    "county": "Garrard"
  },
  {
    "city": "Corinth",
    "county": "Grant"
  },
  {
    "city": "Crittenden",
    "county": "Grant"
  },
  {
    "city": "Dry Ridge",
    "county": "Grant"
  },
  {
    "city": "Williamstown",
    "county": "Grant"
  },
  {
    "city": "Mayfield",
    "county": "Graves"
  },
  {
    "city": "Water Valley",
    "county": "Graves"
  },
  {
    "city": "Wingo",
    "county": "Graves"
  },
  {
    "city": "Caneyville",
    "county": "Grayson"
  },
  {
    "city": "Clarkson",
    "county": "Grayson"
  },
  {
    "city": "Leitchfield",
    "county": "Grayson"
  },
  {
    "city": "Greensburg",
    "county": "Green"
  },
  {
    "city": "Bellefonte",
    "county": "Greenup"
  },
  {
    "city": "Flatwoods",
    "county": "Greenup"
  },
  {
    "city": "Greenup",
    "county": "Greenup"
  },
  {
    "city": "Raceland",
    "county": "Greenup"
  },
  {
    "city": "Russell",
    "county": "Greenup"
  },
  {
    "city": "South Shore",
    "county": "Greenup"
  },
  {
    "city": "Wurtland",
    "county": "Greenup"
  },
  {
    "city": "Hawesville",
    "county": "Hancock"
  },
  {
    "city": "Lewisport",
    "county": "Hancock"
  },
  {
    "city": "Elizabethtown",
    "county": "Hardin"
  },
  {
    "city": "Radcliff",
    "county": "Hardin"
  },
  {
    "city": "Sonora",
    "county": "Hardin"
  },
  {
    "city": "Upton",
    "county": "Hardin"
  },
  {
    "city": "Vine Grove",
    "county": "Hardin"
  },
  {
    "city": "West Point",
    "county": "Hardin"
  },
  {
    "city": "Benham",
    "county": "Harlan"
  },
  {
    "city": "Cumberland",
    "county": "Harlan"
  },
  {
    "city": "Evarts",
    "county": "Harlan"
  },
  {
    "city": "Harlan",
    "county": "Harlan"
  },
  {
    "city": "Loyall",
    "county": "Harlan"
  },
  {
    "city": "Wallins Creek",
    "county": "Harlan"
  },
  {
    "city": "Berry",
    "county": "Harrison"
  },
  {
    "city": "Cynthiana",
    "county": "Harrison"
  },
  {
    "city": "Horse Cave",
    "county": "Hart"
  },
  {
    "city": "Munfordville",
    "county": "Hart"
  },
  {
    "city": "Corydon",
    "county": "Henderson"
  },
  {
    "city": "Henderson",
    "county": "Henderson"
  },
  {
    "city": "Robards",
    "county": "Henderson"
  },
  {
    "city": "Campbellsburg",
    "county": "Henry"
  },
  {
    "city": "Eminence",
    "county": "Henry"
  },
  {
    "city": "New Castle",
    "county": "Henry"
  },
  {
    "city": "Pleasureville",
    "county": "Henry"
  },
  {
    "city": "Smithfield",
    "county": "Henry"
  },
  {
    "city": "Clinton",
    "county": "Hickman"
  },
  {
    "city": "Columbus",
    "county": "Hickman"
  },
  {
    "city": "Dawson Springs",
    "county": "Hopkins"
  },
  {
    "city": "Earlington",
    "county": "Hopkins"
  },
  {
    "city": "Hanson",
    "county": "Hopkins"
  },
  {
    "city": "Madisonville",
    "county": "Hopkins"
  },
  {
    "city": "Mortons Gap",
    "county": "Hopkins"
  },
  {
    "city": "Nebo",
    "county": "Hopkins"
  },
  {
    "city": "Nortonville",
    "county": "Hopkins"
  },
  {
    "city": "St. Charles",
    "county": "Hopkins"
  },
  {
    "city": "White Plains",
    "county": "Hopkins"
  },
  {
    "city": "McKee",
    "county": "Jackson"
  },
  {
    "city": "Louisville",
    "county": "Jefferson"
  },
  {
    "city": "Anchorage",
    "county": "Jefferson"
  },
  {
    "city": "Audubon Park",
    "county": "Jefferson"
  },
  {
    "city": "Bancroft",
    "county": "Jefferson"
  },
  {
    "city": "Barbourmeade",
    "county": "Jefferson"
  },
  {
    "city": "Beechwood",
    "county": "Jefferson"
  },
  {
    "city": "Bellemeade",
    "county": "Jefferson"
  },
  {
    "city": "Bellewood",
    "county": "Jefferson"
  },
  {
    "city": "Blue Ridge Manor",
    "county": "Jefferson"
  },
  {
    "city": "Briarwood",
    "county": "Jefferson"
  },
  {
    "city": "Broeck Pointe",
    "county": "Jefferson"
  },
  {
    "city": "Brownsboro Farm",
    "county": "Jefferson"
  },
  {
    "city": "Brownsboro Village",
    "county": "Jefferson"
  },
  {
    "city": "Cambridge",
    "county": "Jefferson"
  },
  {
    "city": "Coldstream",
    "county": "Jefferson"
  },
  {
    "city": "Creekside",
    "county": "Jefferson"
  },
  {
    "city": "Crossgate",
    "county": "Jefferson"
  },
  {
    "city": "Douglass Hills",
    "county": "Jefferson"
  },
  {
    "city": "Druid Hills",
    "county": "Jefferson"
  },
  {
    "city": "Fincastle",
    "county": "Jefferson"
  },
  {
    "city": "Forest Hills",
    "county": "Jefferson"
  },
  {
    "city": "Glenview",
    "county": "Jefferson"
  },
  {
    "city": "Glenview Hills",
    "county": "Jefferson"
  },
  {
    "city": "Glenview Manor",
    "county": "Jefferson"
  },
  {
    "city": "Goose Creek",
    "county": "Jefferson"
  },
  {
    "city": "Graymoor-Devondale",
    "county": "Jefferson"
  },
  {
    "city": "Green Spring",
    "county": "Jefferson"
  },
  {
    "city": "Heritage Creek",
    "county": "Jefferson"
  },
  {
    "city": "Hickory Hill",
    "county": "Jefferson"
  },
  {
    "city": "Hills and Dales",
    "county": "Jefferson"
  },
  {
    "city": "Hollow Creek",
    "county": "Jefferson"
  },
  {
    "city": "Hollyvilla",
    "county": "Jefferson"
  },
  {
    "city": "Houston Acres",
    "county": "Jefferson"
  },
  {
    "city": "Hurstbourne",
    "county": "Jefferson"
  },
  {
    "city": "Hurstbourne Acres",
    "county": "Jefferson"
  },
  {
    "city": "Indian Hills",
    "county": "Jefferson"
  },
  {
    "city": "Jeffersontown",
    "county": "Jefferson"
  },
  {
    "city": "Kingsley",
    "county": "Jefferson"
  },
  {
    "city": "Langdon Place",
    "county": "Jefferson"
  },
  {
    "city": "Lincolnshire",
    "county": "Jefferson"
  },
  {
    "city": "Lyndon",
    "county": "Jefferson"
  },
  {
    "city": "Lynnview",
    "county": "Jefferson"
  },
  {
    "city": "Manor Creek",
    "county": "Jefferson"
  },
  {
    "city": "Maryhill Estates",
    "county": "Jefferson"
  },
  {
    "city": "Meadow Vale",
    "county": "Jefferson"
  },
  {
    "city": "Meadowbrook Farm",
    "county": "Jefferson"
  },
  {
    "city": "Meadowview Estates",
    "county": "Jefferson"
  },
  {
    "city": "Middletown",
    "county": "Jefferson"
  },
  {
    "city": "Mockingbird Valley",
    "county": "Jefferson"
  },
  {
    "city": "Moorland",
    "county": "Jefferson"
  },
  {
    "city": "Murray Hill",
    "county": "Jefferson"
  },
  {
    "city": "Norbourne Estates",
    "county": "Jefferson"
  },
  {
    "city": "Northfield",
    "county": "Jefferson"
  },
  {
    "city": "Norwood",
    "county": "Jefferson"
  },
  {
    "city": "Old Brownsboro Place",
    "county": "Jefferson"
  },
  {
    "city": "Parkway Village",
    "county": "Jefferson"
  },
  {
    "city": "Plantation",
    "county": "Jefferson"
  },
  {
    "city": "Poplar Hills",
    "county": "Jefferson"
  },
  {
    "city": "Prospect",
    "county": "Jefferson"
  },
  {
    "city": "Richlawn",
    "county": "Jefferson"
  },
  {
    "city": "Riverwood",
    "county": "Jefferson"
  },
  {
    "city": "Rolling Fields",
    "county": "Jefferson"
  },
  {
    "city": "Rolling Hills",
    "county": "Jefferson"
  },
  {
    "city": "St. Matthews",
    "county": "Jefferson"
  },
  {
    "city": "St. Regis Park",
    "county": "Jefferson"
  },
  {
    "city": "Seneca Gardens",
    "county": "Jefferson"
  },
  {
    "city": "Shively",
    "county": "Jefferson"
  },
  {
    "city": "South Park View",
    "county": "Jefferson"
  },
  {
    "city": "Spring Mill",
    "county": "Jefferson"
  },
  {
    "city": "Spring Valley",
    "county": "Jefferson"
  },
  {
    "city": "Strathmoor Manor",
    "county": "Jefferson"
  },
  {
    "city": "Strathmoor Village",
    "county": "Jefferson"
  },
  {
    "city": "Sycamore",
    "county": "Jefferson"
  },
  {
    "city": "Ten Broeck",
    "county": "Jefferson"
  },
  {
    "city": "Thornhill",
    "county": "Jefferson"
  },
  {
    "city": "Watterson Park",
    "county": "Jefferson"
  },
  {
    "city": "Wellington",
    "county": "Jefferson"
  },
  {
    "city": "West Buechel",
    "county": "Jefferson"
  },
  {
    "city": "Westwood",
    "county": "Jefferson"
  },
  {
    "city": "Wildwood",
    "county": "Jefferson"
  },
  {
    "city": "Windy Hills",
    "county": "Jefferson"
  },
  {
    "city": "Woodland Hills",
    "county": "Jefferson"
  },
  {
    "city": "Woodlawn Park",
    "county": "Jefferson"
  },
  {
    "city": "Worthington Hills",
    "county": "Jefferson"
  },
  {
    "city": "Keene",
    "county": "Jessamine"
  },
  {
    "city": "Nicholasville",
    "county": "Jessamine"
  },
  {
    "city": "Wilmore",
    "county": "Jessamine"
  },
  {
    "city": "Paintsville",
    "county": "Johnson"
  },
  {
    "city": "Bromley",
    "county": "Kenton"
  },
  {
    "city": "Covington",
    "county": "Kenton"
  },
  {
    "city": "Crescent Springs",
    "county": "Kenton"
  },
  {
    "city": "Crestview Hills",
    "county": "Kenton"
  },
  {
    "city": "Edgewood",
    "county": "Kenton"
  },
  {
    "city": "Elsmere",
    "county": "Kenton"
  },
  {
    "city": "Erlanger",
    "county": "Kenton"
  },
  {
    "city": "Fairview",
    "county": "Kenton"
  },
  {
    "city": "Fort Mitchell",
    "county": "Kenton"
  },
  {
    "city": "Fort Wright",
    "county": "Kenton"
  },
  {
    "city": "Independence",
    "county": "Kenton"
  },
  {
    "city": "Kenton Vale",
    "county": "Kenton"
  },
  {
    "city": "Lakeside Park",
    "county": "Kenton"
  },
  {
    "city": "Ludlow",
    "county": "Kenton"
  },
  {
    "city": "Park Hills",
    "county": "Kenton"
  },
  {
    "city": "Ryland Heights",
    "county": "Kenton"
  },
  {
    "city": "Taylor Mill",
    "county": "Kenton"
  },
  {
    "city": "Villa Hills",
    "county": "Kenton"
  },
  {
    "city": "Walton",
    "county": "Kenton"
  },
  {
    "city": "Hindman",
    "county": "Knott"
  },
  {
    "city": "Pippa Passes",
    "county": "Knott"
  },
  {
    "city": "Vicco",
    "county": "Knott"
  },
  {
    "city": "Barbourville",
    "county": "Knox"
  },
  {
    "city": "Corbin",
    "county": "Knox"
  },
  {
    "city": "Hodgenville",
    "county": "LaRue"
  },
  {
    "city": "Upton",
    "county": "LaRue"
  },
  {
    "city": "Corbin",
    "county": "Laurel"
  },
  {
    "city": "London",
    "county": "Laurel"
  },
  {
    "city": "Blaine",
    "county": "Lawrence"
  },
  {
    "city": "Louisa",
    "county": "Lawrence"
  },
  {
    "city": "Beattyville",
    "county": "Lee"
  },
  {
    "city": "Hyden",
    "county": "Leslie"
  },
  {
    "city": "Blackey",
    "county": "Letcher"
  },
  {
    "city": "Fleming-Neon",
    "county": "Letcher"
  },
  {
    "city": "Jenkins",
    "county": "Letcher"
  },
  {
    "city": "Whitesburg",
    "county": "Letcher"
  },
  {
    "city": "Concord",
    "county": "Lewis"
  },
  {
    "city": "Vanceburg",
    "county": "Lewis"
  },
  {
    "city": "Crab Orchard",
    "county": "Lincoln"
  },
  {
    "city": "Hustonville",
    "county": "Lincoln"
  },
  {
    "city": "Stanford",
    "county": "Lincoln"
  },
  {
    "city": "Carrsville",
    "county": "Livingston"
  },
  {
    "city": "Grand Rivers",
    "county": "Livingston"
  },
  {
    "city": "Salem",
    "county": "Livingston"
  },
  {
    "city": "Smithland",
    "county": "Livingston"
  },
  {
    "city": "Adairville",
    "county": "Logan"
  },
  {
    "city": "Auburn",
    "county": "Logan"
  },
  {
    "city": "Lewisburg",
    "county": "Logan"
  },
  {
    "city": "Russellville",
    "county": "Logan"
  },
  {
    "city": "Eddyville",
    "county": "Lyon"
  },
  {
    "city": "Kuttawa",
    "county": "Lyon"
  },
  {
    "city": "Berea",
    "county": "Madison"
  },
  {
    "city": "Richmond",
    "county": "Madison"
  },
  {
    "city": "Salyersville",
    "county": "Magoffin"
  },
  {
    "city": "Bradfordsville",
    "county": "Marion"
  },
  {
    "city": "Lebanon",
    "county": "Marion"
  },
  {
    "city": "Loretto",
    "county": "Marion"
  },
  {
    "city": "Raywick",
    "county": "Marion"
  },
  {
    "city": "St. Mary",
    "county": "Marion"
  },
  {
    "city": "Benton",
    "county": "Marshall"
  },
  {
    "city": "Calvert City",
    "county": "Marshall"
  },
  {
    "city": "Hardin",
    "county": "Marshall"
  },
  {
    "city": "Inez",
    "county": "Martin"
  },
  {
    "city": "Warfield",
    "county": "Martin"
  },
  {
    "city": "Dover",
    "county": "Mason"
  },
  {
    "city": "Germantown",
    "county": "Mason"
  },
  {
    "city": "Maysville",
    "county": "Mason"
  },
  {
    "city": "Sardis",
    "county": "Mason"
  },
  {
    "city": "Paducah",
    "county": "McCracken"
  },
  {
    "city": "Calhoun",
    "county": "McLean"
  },
  {
    "city": "Island",
    "county": "McLean"
  },
  {
    "city": "Livermore",
    "county": "McLean"
  },
  {
    "city": "Sacramento",
    "county": "McLean"
  },
  {
    "city": "Brandenburg",
    "county": "Meade"
  },
  {
    "city": "Ekron",
    "county": "Meade"
  },
  {
    "city": "Muldraugh",
    "county": "Meade"
  },
  {
    "city": "Frenchburg",
    "county": "Menifee"
  },
  {
    "city": "Burgin",
    "county": "Mercer"
  },
  {
    "city": "Harrodsburg",
    "county": "Mercer"
  },
  {
    "city": "Edmonton",
    "county": "Metcalfe"
  },
  {
    "city": "Fountain Run",
    "county": "Monroe"
  },
  {
    "city": "Gamaliel",
    "county": "Monroe"
  },
  {
    "city": "Tompkinsville",
    "county": "Monroe"
  },
  {
    "city": "Camargo",
    "county": "Montgomery"
  },
  {
    "city": "Jeffersonville",
    "county": "Montgomery"
  },
  {
    "city": "Mount Sterling",
    "county": "Montgomery"
  },
  {
    "city": "West Liberty",
    "county": "Morgan"
  },
  {
    "city": "Bremen",
    "county": "Muhlenberg"
  },
  {
    "city": "Central City",
    "county": "Muhlenberg"
  },
  {
    "city": "Drakesboro",
    "county": "Muhlenberg"
  },
  {
    "city": "Greenville",
    "county": "Muhlenberg"
  },
  {
    "city": "Powderly",
    "county": "Muhlenberg"
  },
  {
    "city": "South Carrollton",
    "county": "Muhlenberg"
  },
  {
    "city": "Bardstown",
    "county": "Nelson"
  },
  {
    "city": "Bloomfield",
    "county": "Nelson"
  },
  {
    "city": "Fairfield",
    "county": "Nelson"
  },
  {
    "city": "New Haven",
    "county": "Nelson"
  },
  {
    "city": "Carlisle",
    "county": "Nicholas"
  },
  {
    "city": "Beaver Dam",
    "county": "Ohio"
  },
  {
    "city": "Centertown",
    "county": "Ohio"
  },
  {
    "city": "Fordsville",
    "county": "Ohio"
  },
  {
    "city": "Hartford",
    "county": "Ohio"
  },
  {
    "city": "McHenry",
    "county": "Ohio"
  },
  {
    "city": "Rockport",
    "county": "Ohio"
  },
  {
    "city": "Crestwood",
    "county": "Oldham"
  },
  {
    "city": "Goshen",
    "county": "Oldham"
  },
  {
    "city": "La Grange",
    "county": "Oldham"
  },
  {
    "city": "Orchard Grass Hills",
    "county": "Oldham"
  },
  {
    "city": "Pewee Valley",
    "county": "Oldham"
  },
  {
    "city": "Prospect",
    "county": "Oldham"
  },
  {
    "city": "River Bluff",
    "county": "Oldham"
  },
  {
    "city": "Gratz",
    "county": "Owen"
  },
  {
    "city": "Monterey",
    "county": "Owen"
  },
  {
    "city": "Owenton",
    "county": "Owen"
  },
  {
    "city": "Sparta",
    "county": "Owen"
  },
  {
    "city": "Booneville",
    "county": "Owsley"
  },
  {
    "city": "Butler",
    "county": "Pendleton"
  },
  {
    "city": "Falmouth",
    "county": "Pendleton"
  },
  {
    "city": "Buckhorn",
    "county": "Perry"
  },
  {
    "city": "Hazard",
    "county": "Perry"
  },
  {
    "city": "Vicco",
    "county": "Perry"
  },
  {
    "city": "Coal Run Village",
    "county": "Pike"
  },
  {
    "city": "Elkhorn City",
    "county": "Pike"
  },
  {
    "city": "Pikeville",
    "county": "Pike"
  },
  {
    "city": "Clay City",
    "county": "Powell"
  },
  {
    "city": "Stanton",
    "county": "Powell"
  },
  {
    "city": "Burnside",
    "county": "Pulaski"
  },
  {
    "city": "Eubank",
    "county": "Pulaski"
  },
  {
    "city": "Ferguson",
    "county": "Pulaski"
  },
  {
    "city": "Science Hill",
    "county": "Pulaski"
  },
  {
    "city": "Somerset",
    "county": "Pulaski"
  },
  {
    "city": "Mount Olivet",
    "county": "Robertson"
  },
  {
    "city": "Brodhead",
    "county": "Rockcastle"
  },
  {
    "city": "Livingston",
    "county": "Rockcastle"
  },
  {
    "city": "Mount Vernon",
    "county": "Rockcastle"
  },
  {
    "city": "Morehead",
    "county": "Rowan"
  },
  {
    "city": "Jamestown",
    "county": "Russell"
  },
  {
    "city": "Russell Springs",
    "county": "Russell"
  },
  {
    "city": "Georgetown",
    "county": "Scott"
  },
  {
    "city": "Sadieville",
    "county": "Scott"
  },
  {
    "city": "Stamping Ground",
    "county": "Scott"
  },
  {
    "city": "Pleasureville",
    "county": "Shelby"
  },
  {
    "city": "Shelbyville",
    "county": "Shelby"
  },
  {
    "city": "Simpsonville",
    "county": "Shelby"
  },
  {
    "city": "Franklin",
    "county": "Simpson"
  },
  {
    "city": "Taylorsville",
    "county": "Spencer"
  },
  {
    "city": "Campbellsville",
    "county": "Taylor"
  },
  {
    "city": "Elkton",
    "county": "Todd"
  },
  {
    "city": "Guthrie",
    "county": "Todd"
  },
  {
    "city": "Trenton",
    "county": "Todd"
  },
  {
    "city": "Cadiz",
    "county": "Trigg"
  },
  {
    "city": "Bedford",
    "county": "Trimble"
  },
  {
    "city": "Milton",
    "county": "Trimble"
  },
  {
    "city": "Morganfield",
    "county": "Union"
  },
  {
    "city": "Sturgis",
    "county": "Union"
  },
  {
    "city": "Uniontown",
    "county": "Union"
  },
  {
    "city": "Waverly",
    "county": "Union"
  },
  {
    "city": "Bowling Green",
    "county": "Warren"
  },
  {
    "city": "Oakland",
    "county": "Warren"
  },
  {
    "city": "Plum Springs",
    "county": "Warren"
  },
  {
    "city": "Smiths Grove",
    "county": "Warren"
  },
  {
    "city": "Woodburn",
    "county": "Warren"
  },
  {
    "city": "Mackville",
    "county": "Washington"
  },
  {
    "city": "Springfield",
    "county": "Washington"
  },
  {
    "city": "Willisburg",
    "county": "Washington"
  },
  {
    "city": "Monticello",
    "county": "Wayne"
  },
  {
    "city": "Clay",
    "county": "Webster"
  },
  {
    "city": "Dixon",
    "county": "Webster"
  },
  {
    "city": "Providence",
    "county": "Webster"
  },
  {
    "city": "Sebree",
    "county": "Webster"
  },
  {
    "city": "Slaughters",
    "county": "Webster"
  },
  {
    "city": "Wheatcroft",
    "county": "Webster"
  },
  {
    "city": "Corbin",
    "county": "Whitley"
  },
  {
    "city": "Williamsburg",
    "county": "Whitley"
  },
  {
    "city": "Campton",
    "county": "Wolfe"
  },
  {
    "city": "Midway",
    "county": "Woodford"
  },
  {
    "city": "Versailles",
    "county": "Woodford"
  }
]

```

# apps\ingester\src\ky-counties.json

```json
[
  {
    "name": "Adair",
    "full": "Adair County",
    "fips": "21001"
  },
  {
    "name": "Allen",
    "full": "Allen County",
    "fips": "21003"
  },
  {
    "name": "Anderson",
    "full": "Anderson County",
    "fips": "21005"
  },
  {
    "name": "Ballard",
    "full": "Ballard County",
    "fips": "21007"
  },
  {
    "name": "Barren",
    "full": "Barren County",
    "fips": "21009"
  },
  {
    "name": "Bath",
    "full": "Bath County",
    "fips": "21011"
  },
  {
    "name": "Bell",
    "full": "Bell County",
    "fips": "21013"
  },
  {
    "name": "Boone",
    "full": "Boone County",
    "fips": "21015"
  },
  {
    "name": "Bourbon",
    "full": "Bourbon County",
    "fips": "21017"
  },
  {
    "name": "Boyd",
    "full": "Boyd County",
    "fips": "21019"
  },
  {
    "name": "Boyle",
    "full": "Boyle County",
    "fips": "21021"
  },
  {
    "name": "Bracken",
    "full": "Bracken County",
    "fips": "21023"
  },
  {
    "name": "Breathitt",
    "full": "Breathitt County",
    "fips": "21025"
  },
  {
    "name": "Breckinridge",
    "full": "Breckinridge County",
    "fips": "21027"
  },
  {
    "name": "Bullitt",
    "full": "Bullitt County",
    "fips": "21029"
  },
  {
    "name": "Butler",
    "full": "Butler County",
    "fips": "21031"
  },
  {
    "name": "Caldwell",
    "full": "Caldwell County",
    "fips": "21033"
  },
  {
    "name": "Calloway",
    "full": "Calloway County",
    "fips": "21035"
  },
  {
    "name": "Campbell",
    "full": "Campbell County",
    "fips": "21037"
  },
  {
    "name": "Carlisle",
    "full": "Carlisle County",
    "fips": "21039"
  },
  {
    "name": "Carroll",
    "full": "Carroll County",
    "fips": "21041"
  },
  {
    "name": "Carter",
    "full": "Carter County",
    "fips": "21043"
  },
  {
    "name": "Casey",
    "full": "Casey County",
    "fips": "21045"
  },
  {
    "name": "Christian",
    "full": "Christian County",
    "fips": "21047"
  },
  {
    "name": "Clark",
    "full": "Clark County",
    "fips": "21049"
  },
  {
    "name": "Clay",
    "full": "Clay County",
    "fips": "21051"
  },
  {
    "name": "Clinton",
    "full": "Clinton County",
    "fips": "21053"
  },
  {
    "name": "Crittenden",
    "full": "Crittenden County",
    "fips": "21055"
  },
  {
    "name": "Cumberland",
    "full": "Cumberland County",
    "fips": "21057"
  },
  {
    "name": "Daviess",
    "full": "Daviess County",
    "fips": "21059"
  },
  {
    "name": "Edmonson",
    "full": "Edmonson County",
    "fips": "21061"
  },
  {
    "name": "Elliott",
    "full": "Elliott County",
    "fips": "21063"
  },
  {
    "name": "Estill",
    "full": "Estill County",
    "fips": "21065"
  },
  {
    "name": "Fayette",
    "full": "Fayette County",
    "fips": "21067"
  },
  {
    "name": "Fleming",
    "full": "Fleming County",
    "fips": "21069"
  },
  {
    "name": "Floyd",
    "full": "Floyd County",
    "fips": "21071"
  },
  {
    "name": "Franklin",
    "full": "Franklin County",
    "fips": "21073"
  },
  {
    "name": "Fulton",
    "full": "Fulton County",
    "fips": "21075"
  },
  {
    "name": "Gallatin",
    "full": "Gallatin County",
    "fips": "21077"
  },
  {
    "name": "Garrard",
    "full": "Garrard County",
    "fips": "21079"
  },
  {
    "name": "Grant",
    "full": "Grant County",
    "fips": "21081"
  },
  {
    "name": "Graves",
    "full": "Graves County",
    "fips": "21083"
  },
  {
    "name": "Grayson",
    "full": "Grayson County",
    "fips": "21085"
  },
  {
    "name": "Green",
    "full": "Green County",
    "fips": "21087"
  },
  {
    "name": "Greenup",
    "full": "Greenup County",
    "fips": "21089"
  },
  {
    "name": "Hancock",
    "full": "Hancock County",
    "fips": "21091"
  },
  {
    "name": "Hardin",
    "full": "Hardin County",
    "fips": "21093"
  },
  {
    "name": "Harlan",
    "full": "Harlan County",
    "fips": "21095"
  },
  {
    "name": "Harrison",
    "full": "Harrison County",
    "fips": "21097"
  },
  {
    "name": "Hart",
    "full": "Hart County",
    "fips": "21099"
  },
  {
    "name": "Henderson",
    "full": "Henderson County",
    "fips": "21101"
  },
  {
    "name": "Henry",
    "full": "Henry County",
    "fips": "21103"
  },
  {
    "name": "Hickman",
    "full": "Hickman County",
    "fips": "21105"
  },
  {
    "name": "Hopkins",
    "full": "Hopkins County",
    "fips": "21107"
  },
  {
    "name": "Jackson",
    "full": "Jackson County",
    "fips": "21109"
  },
  {
    "name": "Jefferson",
    "full": "Jefferson County",
    "fips": "21111"
  },
  {
    "name": "Jessamine",
    "full": "Jessamine County",
    "fips": "21113"
  },
  {
    "name": "Johnson",
    "full": "Johnson County",
    "fips": "21115"
  },
  {
    "name": "Kenton",
    "full": "Kenton County",
    "fips": "21117"
  },
  {
    "name": "Knott",
    "full": "Knott County",
    "fips": "21119"
  },
  {
    "name": "Knox",
    "full": "Knox County",
    "fips": "21121"
  },
  {
    "name": "Larue",
    "full": "Larue County",
    "fips": "21123"
  },
  {
    "name": "Laurel",
    "full": "Laurel County",
    "fips": "21125"
  },
  {
    "name": "Lawrence",
    "full": "Lawrence County",
    "fips": "21127"
  },
  {
    "name": "Lee",
    "full": "Lee County",
    "fips": "21129"
  },
  {
    "name": "Leslie",
    "full": "Leslie County",
    "fips": "21131"
  },
  {
    "name": "Letcher",
    "full": "Letcher County",
    "fips": "21133"
  },
  {
    "name": "Lewis",
    "full": "Lewis County",
    "fips": "21135"
  },
  {
    "name": "Lincoln",
    "full": "Lincoln County",
    "fips": "21137"
  },
  {
    "name": "Livingston",
    "full": "Livingston County",
    "fips": "21139"
  },
  {
    "name": "Logan",
    "full": "Logan County",
    "fips": "21141"
  },
  {
    "name": "Lyon",
    "full": "Lyon County",
    "fips": "21143"
  },
  {
    "name": "Madison",
    "full": "Madison County",
    "fips": "21151"
  },
  {
    "name": "Magoffin",
    "full": "Magoffin County",
    "fips": "21153"
  },
  {
    "name": "Marion",
    "full": "Marion County",
    "fips": "21155"
  },
  {
    "name": "Marshall",
    "full": "Marshall County",
    "fips": "21157"
  },
  {
    "name": "Martin",
    "full": "Martin County",
    "fips": "21159"
  },
  {
    "name": "Mason",
    "full": "Mason County",
    "fips": "21161"
  },
  {
    "name": "McCracken",
    "full": "McCracken County",
    "fips": "21145"
  },
  {
    "name": "McCreary",
    "full": "McCreary County",
    "fips": "21147"
  },
  {
    "name": "McLean",
    "full": "McLean County",
    "fips": "21149"
  },
  {
    "name": "Meade",
    "full": "Meade County",
    "fips": "21163"
  },
  {
    "name": "Menifee",
    "full": "Menifee County",
    "fips": "21165"
  },
  {
    "name": "Mercer",
    "full": "Mercer County",
    "fips": "21167"
  },
  {
    "name": "Metcalfe",
    "full": "Metcalfe County",
    "fips": "21169"
  },
  {
    "name": "Monroe",
    "full": "Monroe County",
    "fips": "21171"
  },
  {
    "name": "Montgomery",
    "full": "Montgomery County",
    "fips": "21173"
  },
  {
    "name": "Morgan",
    "full": "Morgan County",
    "fips": "21175"
  },
  {
    "name": "Muhlenberg",
    "full": "Muhlenberg County",
    "fips": "21177"
  },
  {
    "name": "Nelson",
    "full": "Nelson County",
    "fips": "21179"
  },
  {
    "name": "Nicholas",
    "full": "Nicholas County",
    "fips": "21181"
  },
  {
    "name": "Ohio",
    "full": "Ohio County",
    "fips": "21183"
  },
  {
    "name": "Oldham",
    "full": "Oldham County",
    "fips": "21185"
  },
  {
    "name": "Owen",
    "full": "Owen County",
    "fips": "21187"
  },
  {
    "name": "Owsley",
    "full": "Owsley County",
    "fips": "21189"
  },
  {
    "name": "Pendleton",
    "full": "Pendleton County",
    "fips": "21191"
  },
  {
    "name": "Perry",
    "full": "Perry County",
    "fips": "21193"
  },
  {
    "name": "Pike",
    "full": "Pike County",
    "fips": "21195"
  },
  {
    "name": "Powell",
    "full": "Powell County",
    "fips": "21197"
  },
  {
    "name": "Pulaski",
    "full": "Pulaski County",
    "fips": "21199"
  },
  {
    "name": "Robertson",
    "full": "Robertson County",
    "fips": "21201"
  },
  {
    "name": "Rockcastle",
    "full": "Rockcastle County",
    "fips": "21203"
  },
  {
    "name": "Rowan",
    "full": "Rowan County",
    "fips": "21205"
  },
  {
    "name": "Russell",
    "full": "Russell County",
    "fips": "21207"
  },
  {
    "name": "Scott",
    "full": "Scott County",
    "fips": "21209"
  },
  {
    "name": "Shelby",
    "full": "Shelby County",
    "fips": "21211"
  },
  {
    "name": "Simpson",
    "full": "Simpson County",
    "fips": "21213"
  },
  {
    "name": "Spencer",
    "full": "Spencer County",
    "fips": "21215"
  },
  {
    "name": "Taylor",
    "full": "Taylor County",
    "fips": "21217"
  },
  {
    "name": "Todd",
    "full": "Todd County",
    "fips": "21219"
  },
  {
    "name": "Trigg",
    "full": "Trigg County",
    "fips": "21221"
  },
  {
    "name": "Trimble",
    "full": "Trimble County",
    "fips": "21223"
  },
  {
    "name": "Union",
    "full": "Union County",
    "fips": "21225"
  },
  {
    "name": "Warren",
    "full": "Warren County",
    "fips": "21227"
  },
  {
    "name": "Washington",
    "full": "Washington County",
    "fips": "21229"
  },
  {
    "name": "Wayne",
    "full": "Wayne County",
    "fips": "21231"
  },
  {
    "name": "Webster",
    "full": "Webster County",
    "fips": "21233"
  },
  {
    "name": "Whitley",
    "full": "Whitley County",
    "fips": "21235"
  },
  {
    "name": "Wolfe",
    "full": "Wolfe County",
    "fips": "21237"
  },
  {
    "name": "Woodford",
    "full": "Woodford County",
    "fips": "21239"
  }
]
```

# apps\ingester\src\util.mjs

```mjs
import crypto from "node:crypto";

export function stableHash(input) {
  return crypto.createHash("sha256").update(input).digest("hex");
}

export function makeItemId({ url, guid, title, published_at }) {
  // Prefer URL (canonical). Fallback to guid, then title+date.
  const base = url || guid || `${title || ""}__${published_at || ""}`;
  return stableHash(base).slice(0, 24);
}

export function pickImage(item) {
  // Best-effort; many feeds differ.
  // rss-parser may expose enclosure, itunes:image, media:content, etc.
  const enc = item.enclosure?.url;
  if (enc && /^https?:\/\//i.test(enc)) return enc;

  const media = item["media:content"]?.url || item["media:thumbnail"]?.url;
  if (media && /^https?:\/\//i.test(media)) return media;

  const itunes = item["itunes:image"]?.href;
  if (itunes && /^https?:\/\//i.test(itunes)) return itunes;

  // Try to find img in content snippet (lightweight)
  const html = item.content || item.contentSnippet || "";
  const m = html.match(/<img[^>]+src=["']([^"']+)["']/i);
  if (m?.[1]) return m[1];

  return null;
}

export function toIsoOrNull(dateLike) {
  if (!dateLike) return null;
  const d = new Date(dateLike);
  if (Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}

```

# apps\web\functions\api\[[path]].js

```js
export async function onRequest(context) {
  const workerOrigin = context.env.API_ORIGIN || "https://ky-news-worker.jamesbrock25.workers.dev";

  const rawPath = context.params?.path;
  const path = Array.isArray(rawPath) ? rawPath.join("/") : String(rawPath || "");

  const incomingUrl = new URL(context.request.url);
  const upstreamUrl = new URL(`/api/${path}`, workerOrigin);
  upstreamUrl.search = incomingUrl.search;

  const headers = new Headers(context.request.headers);
  headers.set("x-forwarded-host", incomingUrl.host);
  headers.set("x-forwarded-proto", incomingUrl.protocol.replace(":", ""));

  const init = {
    method: context.request.method,
    headers,
    redirect: "follow"
  };

  if (context.request.method !== "GET" && context.request.method !== "HEAD") {
    init.body = context.request.body;
  }

  const upstream = await fetch(upstreamUrl.toString(), init);

  const responseHeaders = new Headers(upstream.headers);
  responseHeaders.set("x-api-proxy", "pages-function");

  return new Response(upstream.body, {
    status: upstream.status,
    statusText: upstream.statusText,
    headers: responseHeaders
  });
}

```

# apps\web\index.html

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="fragment" content="!" />
    <meta name="description" content="Your source for local Kentucky news, county by county." />
    <title>Kentucky News — Local KY News</title>
    <link rel="icon" href="/favicon.svg" />
    <!-- PWA / installable icons: use the project logo so everything stays synced -->
    <link rel="icon" type="image/png" sizes="192x192" href="/logo.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/logo.png" />
    <link rel="apple-touch-icon" href="/logo.png" />
    <link rel="manifest" href="/manifest.json" />

    <link rel="preconnect" href="https://ky-news-worker.jamesbrock25.workers.dev" crossorigin />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

```

# apps\web\package.json

```json
{
  "name": "@local-ky-news/web",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "dexie": "^4.0.10",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-helmet-async": "^2.0.5",
    "react-router-dom": "^6.26.2"
  },
  "devDependencies": {
    "@types/react": "^18.3.4",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^4.3.1",
    "typescript": "^5.5.4",
    "vite": "^5.4.2"
  }
}

```

# apps\web\public\_headers

```
/*
  Cache-Control: public, max-age=0, must-revalidate

/assets/*
  Cache-Control: public, max-age=31536000, immutable

/main.js
  Cache-Control: public, max-age=31536000, immutable

/logo.png
  Cache-Control: public, max-age=31536000, immutable

/pwa-192.png
  Cache-Control: public, max-age=31536000, immutable

/pwa-512.png
  Cache-Control: public, max-age=31536000, immutable

/favicon.svg
  Cache-Control: public, max-age=31536000, immutable

/manifest.json
  Cache-Control: public, max-age=31536000, immutable

```

# apps\web\public\favicon.svg

This is a file of the type: SVG Image

# apps\web\public\logo.png

This is a binary file of the type: Image

# apps\web\public\logo.svg

This is a file of the type: SVG Image

# apps\web\public\manifest.json

```json
{
  "name": "Local KY News",
  "short_name": "KY News",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#ffffff",
  "icons": [
    {
      "src": "/logo.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/logo.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

# apps\web\public\pwa-192.png

This is a binary file of the type: Image

# apps\web\public\pwa-512.png

This is a binary file of the type: Image

# apps\web\public\robots.txt

```txt
User-agent: *
Allow: /

Sitemap: https://ky-news-worker.jamesbrock25.workers.dev/sitemap.xml

```

# apps\web\src\data\api.ts

```ts
export type NewsScope = "ky" | "national" | "all";

export type Feed = {
  id: string;
  name: string;
  category: string;
  url: string;
  state_code?: string;
  region_scope?: NewsScope;
  enabled: number;
};

export type Item = {
  id: string;
  title: string;
  url: string;
  author?: string | null;
  region_scope?: "ky" | "national";
  published_at?: string | null;
  summary?: string | null;
  seo_description?: string | null;
  content?: string | null;
  image_url?: string | null;
  states?: string[];
  counties?: string[];
};

export type CountyCount = { county: string; count: number };

export type WeatherForecastPeriod = {
  name: string;
  startTime: string;
  endTime: string;
  temperature: number;
  temperatureUnit: string;
  shortForecast: string;
  detailedForecast: string;
  windSpeed?: string;
  windDirection?: string;
  icon?: string;
};

export type WeatherForecast = {
  state: string;
  county: string;
  zoneId: string;
  updatedAt: string;
  periods: WeatherForecastPeriod[];
  source: string;
  fetchedAt?: string;
  expiresAt?: string;
  cached?: boolean;
  stale?: boolean;
  warning?: string;
};

export type WeatherAlert = {
  id: string;
  event: string;
  severity: string;
  headline: string;
  description: string;
  instruction: string;
  starts_at?: string | null;
  ends_at?: string | null;
  sent_at?: string | null;
  status?: string | null;
  url?: string | null;
  area_desc?: string;
};

export type LostFoundType = "lost" | "found";

export type LostFoundPost = {
  id: string;
  type: LostFoundType;
  title: string;
  description: string;
  county: string;
  state_code: string;
  status: "pending" | "approved" | "rejected";
  is_resolved?: boolean;
  show_contact: boolean;
  contact_email?: string | null;
  submitted_at: string;
  approved_at?: string | null;
  rejected_at?: string | null;
  resolved_at?: string | null;
  resolved_note?: string | null;
  comment_count?: number;
  expires_at: string;
  moderation_note?: string | null;
  images: string[];
};

export type LostFoundComment = {
  id: string;
  post_id: string;
  name: string;
  comment: string;
  created_at: string;
};

export type AdminLostFoundComment = LostFoundComment & {
  post_title?: string | null;
  commenter_email_hash?: string;
  commenter_ip_hash?: string;
};

export type AdminLostFoundCommentBan = {
  id: string;
  target_type: "email" | "ip";
  reason?: string | null;
  banned_by_email: string;
  source_comment_id?: string | null;
  created_at: string;
};

export type AdminIngestionLog = {
  id: number;
  started_at: string;
  finished_at?: string | null;
  status: string;
  source?: string | null;
  feed_errors: number;
  details?: {
    feedsProcessed?: number;
    feedsUpdated?: number;
    itemsSeen?: number;
    itemsUpserted?: number;
    summariesGenerated?: number;
    imagesMirrored?: number;
    errors?: number;
  } | null;
};

export type AdminFeedHealth = {
  id: string;
  name: string;
  url: string;
  category: string;
  region_scope?: string | null;
  enabled: boolean;
  last_checked_at?: string | null;
  last_metric_at?: string | null;
  last_status?: string | null;
  last_duration_ms: number;
  last_items_upserted: number;
  recent_items: number;
  checks_window: number;
  errors_window: number;
  error_rate: number;
  health_status: "healthy" | "degraded" | "critical" | "unknown";
};

export type AdminItemRevalidateSummary = {
  scanned: number;
  dryRun: boolean;
  hours: number;
  limit: number;
  minWords: number;
  includeNational: boolean;
  unchanged: number;
  wouldRetag: number;
  retagged: number;
  wouldPrune: number;
  pruned: number;
  prunedFeedLinks: number;
  samples: Array<Record<string, unknown>>;
};

async function fetchJson<T>(url: string, init?: RequestInit): Promise<T> {
  const res = await fetch(url, init);
  if (!res.ok) {
    const text = await res.text().catch(() => "");
    if (text) {
      try {
        const parsed = JSON.parse(text);
        const msg = parsed?.message || parsed?.error || text;
        throw new Error(typeof msg === "string" ? msg : JSON.stringify(msg));
      } catch {
        throw new Error(text || `Request failed: ${res.status}`);
      }
    }
    throw new Error(`Request failed: ${res.status}`);
  }
  return res.json() as Promise<T>;
}

function isInvalidQueryError(err: unknown) {
  const msg = String((err as any)?.message || err || "");
  return /invalid query/i.test(msg);
}

function withLegacyHoursFallback(url: string) {
  return url.replace(/([?&])hours=0(?=(&|$))/g, "$1hours=8760");
}

async function fetchJsonWithHoursFallback<T>(url: string, init?: RequestInit): Promise<T> {
  try {
    return await fetchJson<T>(url, init);
  } catch (err) {
    // Backward compatibility: some deployed API versions reject hours=0.
    // Retry with the widest accepted window (1 year) so local pages still function.
    if (!/[?&]hours=0(?:&|$)/.test(url) || !isInvalidQueryError(err)) throw err;
    return fetchJson<T>(withLegacyHoursFallback(url), init);
  }
}

export async function getFeeds(opts: { scope?: NewsScope } = {}): Promise<Feed[]> {
  const params = new URLSearchParams();
  if (opts.scope) params.set("scope", opts.scope);
  const qs = params.toString();
  const data = await fetchJson<{ feeds: Feed[] }>(`/api/feeds${qs ? `?${qs}` : ""}`);
  return data.feeds;
}

export async function getItems(
  opts: {
    feedId?: string;
    category?: string;
    scope?: NewsScope;
    state?: string;
    county?: string;
    counties?: string[];
    unfiltered?: boolean;
    includeAll?: boolean;
    hours?: number;
    cursor?: string | null;
    limit?: number;
  } = {}
) {
  const params = new URLSearchParams();
  if (opts.feedId) params.set("feedId", opts.feedId);
  if (opts.category) params.set("category", opts.category);
  if (opts.scope) params.set("scope", opts.scope);
  if (opts.state) params.set("state", opts.state);
  if (opts.county) params.set("county", opts.county);
  if (opts.counties?.length) {
    for (const county of opts.counties) params.append("counties", county);
  }
  if (opts.unfiltered) params.set("unfiltered", "1");
  if (opts.includeAll) params.set("includeAll", "1");
  if (opts.hours != null) params.set("hours", String(opts.hours));
  if (opts.cursor) params.set("cursor", opts.cursor);
  params.set("limit", String(opts.limit ?? 30));
  return fetchJsonWithHoursFallback<{ items: (Item & { sort_ts?: string })[]; nextCursor: string | null }>(`/api/items?${params.toString()}`);
}

export async function searchItems(
  q: string,
  opts: {
    scope?: NewsScope;
    state?: string;
    county?: string;
    counties?: string[];
    hours?: number;
    sort?: "newest" | "oldest";
    cursor?: string | null;
    limit?: number;
  } = {}
) {
  const params = new URLSearchParams();
  params.set("q", q);
  if (opts.scope) params.set("scope", opts.scope);
  if (opts.state) params.set("state", opts.state);
  if (opts.county) params.set("county", opts.county);
  if (opts.counties?.length) {
    for (const county of opts.counties) params.append("counties", county);
  }
  if (opts.hours != null) params.set("hours", String(opts.hours));
  if (opts.sort) params.set("sort", opts.sort);
  if (opts.cursor) params.set("cursor", opts.cursor);
  params.set("limit", String(opts.limit ?? 30));
  return fetchJson<{ items: (Item & { sort_ts?: string })[]; nextCursor: string | null }>(`/api/search?${params.toString()}`);
}

export async function getItem(id: string): Promise<Item> {
  const data = await fetchJson<{ item: Item }>(`/api/items/${encodeURIComponent(id)}`);
  return data.item;
}

export async function getCounties(opts: { state?: string; hours?: number } = {}) {
  const params = new URLSearchParams();
  params.set("state", (opts.state ?? "KY").toUpperCase());
  if (opts.hours != null) params.set("hours", String(opts.hours));
  return fetchJsonWithHoursFallback<{ state: string; hours: number; counties: CountyCount[] }>(`/api/counties?${params.toString()}`);
}

export async function getWeatherForecast(county: string, state = "KY") {
  const params = new URLSearchParams();
  params.set("state", state.toUpperCase());
  params.set("county", county);
  return fetchJson<WeatherForecast>(`/api/weather/forecast?${params.toString()}`);
}

export async function getWeatherAlerts(opts: { county?: string; state?: string } = {}) {
  const params = new URLSearchParams();
  params.set("state", (opts.state ?? "KY").toUpperCase());
  if (opts.county) params.set("county", opts.county);
  return fetchJson<{ state: string; county?: string | null; alerts: WeatherAlert[]; stale?: boolean; warning?: string }>(
    `/api/weather/alerts?${params.toString()}`
  );
}

export async function listLostFound(opts: { type?: LostFoundType; county?: string; status?: "published" | "pending" | "approved" | "rejected" | "resolved"; limit?: number } = {}) {
  const params = new URLSearchParams();
  if (opts.type) params.set("type", opts.type);
  if (opts.county) params.set("county", opts.county);
  if (opts.status) params.set("status", opts.status);
  if (opts.limit != null) params.set("limit", String(opts.limit));
  return fetchJson<{ posts: LostFoundPost[]; status: string; county?: string | null }>(`/api/lost-found?${params.toString()}`);
}

export async function listLostFoundComments(postId: string, limit = 80) {
  const params = new URLSearchParams();
  params.set("limit", String(limit));
  return fetchJson<{ comments: LostFoundComment[] }>(
    `/api/lost-found/${encodeURIComponent(postId)}/comments?${params.toString()}`
  );
}

export async function submitLostFoundComment(input: {
  postId: string;
  name: string;
  email: string;
  comment: string;
  acceptTerms: boolean;
}) {
  return fetchJson<{ ok: boolean; comment: LostFoundComment }>(
    `/api/lost-found/${encodeURIComponent(input.postId)}/comments`,
    {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({
        name: input.name,
        email: input.email,
        comment: input.comment,
        acceptTerms: Boolean(input.acceptTerms)
      })
    }
  );
}

function adminHeaders(token?: string): HeadersInit {
  const headers: Record<string, string> = {};
  if (token?.trim()) headers["x-admin-token"] = token.trim();
  return headers;
}

export async function getLostFoundUploadUrl(filename: string, mimeType: string) {
  return fetchJson<{ objectKey: string; uploadUrl: string; method: "PUT"; headers: Record<string, string>; maxBytes: number }>(
    "/api/uploads/lost-found-url",
    {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ filename, mimeType })
    }
  );
}

export async function uploadLostFoundImage(uploadUrl: string, file: File, headers: Record<string, string>) {
  const res = await fetch(uploadUrl, {
    method: "PUT",
    headers,
    body: file
  });
  if (!res.ok) throw new Error("Image upload failed");
  return res.json() as Promise<{ ok: boolean; objectKey: string; bytes: number }>;
}

export async function submitLostFound(input: {
  type: LostFoundType;
  title: string;
  description: string;
  county: string;
  state?: string;
  contactEmail: string;
  showContact?: boolean;
  imageKeys?: string[];
}) {
  return fetchJson<{ ok: boolean; id: string; status: string }>("/api/lost-found/submissions", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({
      ...input,
      state: (input.state ?? "KY").toUpperCase(),
      showContact: input.showContact ?? false,
      imageKeys: input.imageKeys ?? []
    })
  });
}

export async function markLostFoundAsFound(input: {
  id: string;
  contactEmail: string;
  note?: string;
}) {
  return fetchJson<{ ok: boolean; id: string; status: string }>(`/api/lost-found/${encodeURIComponent(input.id)}/mark-found`, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({
      contactEmail: input.contactEmail,
      note: input.note?.trim() || undefined
    })
  });
}

export async function listAdminLostFound(input: {
  token?: string;
  status?: "pending" | "approved" | "rejected" | "resolved" | "all";
  limit?: number;
} = {}) {
  const params = new URLSearchParams();
  params.set("status", input.status || "all");
  params.set("limit", String(input.limit ?? 120));
  return fetchJson<{ admin: string; posts: LostFoundPost[] }>(`/api/admin/lost-found?${params.toString()}`, {
    headers: adminHeaders(input.token)
  });
}

export async function deleteAdminLostFound(input: { token?: string; id: string }) {
  return fetchJson<{ ok: boolean; id: string; deletedImages: number }>(`/api/admin/lost-found/${encodeURIComponent(input.id)}`, {
    method: "DELETE",
    headers: adminHeaders(input.token)
  });
}

export async function listAdminLostFoundComments(input: { token?: string; postId?: string; limit?: number } = {}) {
  const params = new URLSearchParams();
  params.set("limit", String(input.limit ?? 200));
  if (input.postId) params.set("postId", input.postId);
  return fetchJson<{ comments: AdminLostFoundComment[] }>(`/api/admin/lost-found/comments?${params.toString()}`, {
    headers: adminHeaders(input.token)
  });
}

export async function deleteAdminLostFoundComment(input: { token?: string; id: string }) {
  return fetchJson<{ ok: boolean; id: string }>(`/api/admin/lost-found/comments/${encodeURIComponent(input.id)}`, {
    method: "DELETE",
    headers: adminHeaders(input.token)
  });
}

export async function banAdminLostFoundComment(input: {
  token?: string;
  commentId: string;
  banUser?: boolean;
  banIp?: boolean;
  reason?: string;
}) {
  return fetchJson<{ ok: boolean; id: string; bansApplied: number }>(
    `/api/admin/lost-found/comments/${encodeURIComponent(input.commentId)}/ban`,
    {
      method: "POST",
      headers: {
        ...adminHeaders(input.token),
        "content-type": "application/json"
      },
      body: JSON.stringify({
        banUser: input.banUser ?? true,
        banIp: input.banIp ?? true,
        reason: input.reason?.trim() || undefined
      })
    }
  );
}

export async function listAdminLostFoundCommentBans(input: { token?: string; limit?: number } = {}) {
  const params = new URLSearchParams();
  params.set("limit", String(input.limit ?? 200));
  return fetchJson<{ bans: AdminLostFoundCommentBan[] }>(`/api/admin/lost-found/bans?${params.toString()}`, {
    headers: adminHeaders(input.token)
  });
}

export async function deleteAdminLostFoundCommentBan(input: { token?: string; id: string }) {
  return fetchJson<{ ok: boolean; id: string }>(`/api/admin/lost-found/bans/${encodeURIComponent(input.id)}`, {
    method: "DELETE",
    headers: adminHeaders(input.token)
  });
}

export async function approveAdminLostFound(input: {
  token?: string;
  id: string;
  showContact?: boolean;
  note?: string;
}) {
  return fetchJson<{ ok: boolean; id: string; status: string }>(
    `/api/admin/lost-found/${encodeURIComponent(input.id)}/approve`,
    {
      method: "POST",
      headers: {
        ...adminHeaders(input.token),
        "content-type": "application/json"
      },
      body: JSON.stringify({
        showContact: input.showContact,
        note: input.note?.trim() || undefined
      })
    }
  );
}

export async function rejectAdminLostFound(input: {
  token?: string;
  id: string;
  reason: string;
}) {
  return fetchJson<{ ok: boolean; id: string; status: string }>(
    `/api/admin/lost-found/${encodeURIComponent(input.id)}/reject`,
    {
      method: "POST",
      headers: {
        ...adminHeaders(input.token),
        "content-type": "application/json"
      },
      body: JSON.stringify({
        reason: input.reason
      })
    }
  );
}

export async function getAdminIngestionLogs(input: {
  token?: string;
  limit?: number;
  cursor?: number;
} = {}) {
  const params = new URLSearchParams();
  params.set("limit", String(input.limit ?? 20));
  if (input.cursor) params.set("cursor", String(input.cursor));
  return fetchJson<{ logs: AdminIngestionLog[]; nextCursor: number | null }>(`/api/admin/ingestion/logs?${params.toString()}`, {
    headers: adminHeaders(input.token)
  });
}

export async function getAdminFeedHealth(input: {
  token?: string;
  hours?: number;
  limit?: number;
} = {}) {
  const params = new URLSearchParams();
  params.set("hours", String(input.hours ?? 48));
  params.set("limit", String(input.limit ?? 300));
  return fetchJson<{ hours: number; feeds: AdminFeedHealth[] }>(`/api/admin/feeds/health?${params.toString()}`, {
    headers: adminHeaders(input.token)
  });
}

export async function runAdminFeedReload(input: { token?: string } = {}) {
  return fetchJson<{
    ok: boolean;
    accepted?: boolean;
    runId?: string;
    message?: string;
    code?: number;
    stdout?: string;
    stderr?: string;
  }>("/api/admin/feeds/reload", {
    method: "POST",
    headers: adminHeaders(input.token)
  });
}

export async function runAdminItemsRevalidate(input: {
  token?: string;
  hours?: number;
  limit?: number;
  minWords?: number;
  dryRun?: boolean;
  includeNational?: boolean;
} = {}) {
  return fetchJson<{ ok: boolean; summary: AdminItemRevalidateSummary }>("/api/admin/items/revalidate", {
    method: "POST",
    headers: {
      ...adminHeaders(input.token),
      "content-type": "application/json"
    },
    body: JSON.stringify({
      hours: input.hours ?? 72,
      limit: input.limit ?? 800,
      minWords: input.minWords ?? 50,
      dryRun: input.dryRun ?? true,
      includeNational: input.includeNational ?? false
    })
  });
}

export async function getOpenProxy(url: string) {
  const params = new URLSearchParams();
  params.set("url", url);
  return fetchJson<{ url: string; finalUrl: string; title: string; html: string }>(`/api/open-proxy?${params.toString()}`);
}

```

# apps\web\src\data\countySlug.ts

```ts
import kyCounties from "./ky-counties.json";

type CountyRow = { name?: string };

const COUNTY_NAMES = (kyCounties as CountyRow[])
  .map((row) => String(row?.name || "").trim())
  .filter(Boolean);

const COUNTY_NAME_BY_LOWER = new Map(COUNTY_NAMES.map((name) => [name.toLowerCase(), name]));
const COUNTY_NAME_BY_SLUG = new Map(COUNTY_NAMES.map((name) => [countyNameToSlug(name), name]));

function normalizeCountyName(value: string): string {
  return String(value || "")
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ")
    .replace(/\s+county$/i, "");
}

function titleCaseWords(value: string): string {
  return value
    .split(" ")
    .map((word) => word.trim())
    .filter(Boolean)
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(" ");
}

export function countyNameToSlug(name: string): string {
  const normalized = normalizeCountyName(name)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-+|-+$/g, "");

  if (!normalized) return "";
  return `${normalized}-county`;
}

export function countySlugToName(slug: string): string | null {
  const normalizedSlug = String(slug || "")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9-]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-+|-+$/g, "");
  if (!normalizedSlug) return null;

  const exact = COUNTY_NAME_BY_SLUG.get(normalizedSlug);
  if (exact) return exact;

  const base = normalizedSlug.replace(/-county$/i, "");
  if (!base) return null;

  const guessedName = titleCaseWords(base.replace(/-/g, " "));
  const canonicalGuess = COUNTY_NAME_BY_LOWER.get(guessedName.toLowerCase());
  if (canonicalGuess) return canonicalGuess;

  const canonicalBySlug = COUNTY_NAME_BY_SLUG.get(countyNameToSlug(guessedName));
  return canonicalBySlug || null;
}

export function countySlugToDisplayName(slug: string): string {
  const known = countySlugToName(slug);
  if (known) return known;
  const cleaned = String(slug || "")
    .trim()
    .replace(/-county$/i, "")
    .replace(/-/g, " ");
  const title = titleCaseWords(cleaned);
  return title || "Kentucky";
}

```

# apps\web\src\data\ky-city-county.json

```json
[
  {
    "city": "Columbia",
    "county": "Adair"
  },
  {
    "city": "Scottsville",
    "county": "Allen"
  },
  {
    "city": "Lawrenceburg",
    "county": "Anderson"
  },
  {
    "city": "Barlow",
    "county": "Ballard"
  },
  {
    "city": "Blandville",
    "county": "Ballard"
  },
  {
    "city": "Kevil",
    "county": "Ballard"
  },
  {
    "city": "La Center",
    "county": "Ballard"
  },
  {
    "city": "Wickliffe",
    "county": "Ballard"
  },
  {
    "city": "Cave City",
    "county": "Barren"
  },
  {
    "city": "Glasgow",
    "county": "Barren"
  },
  {
    "city": "Park City",
    "county": "Barren"
  },
  {
    "city": "Owingsville",
    "county": "Bath"
  },
  {
    "city": "Salt Lick",
    "county": "Bath"
  },
  {
    "city": "Sharpsburg",
    "county": "Bath"
  },
  {
    "city": "Middlesboro",
    "county": "Bell"
  },
  {
    "city": "Pineville",
    "county": "Bell"
  },
  {
    "city": "Florence",
    "county": "Boone"
  },
  {
    "city": "Union",
    "county": "Boone"
  },
  {
    "city": "Walton",
    "county": "Boone"
  },
  {
    "city": "Millersburg",
    "county": "Bourbon"
  },
  {
    "city": "North Middletown",
    "county": "Bourbon"
  },
  {
    "city": "Paris",
    "county": "Bourbon"
  },
  {
    "city": "Ashland",
    "county": "Boyd"
  },
  {
    "city": "Catlettsburg",
    "county": "Boyd"
  },
  {
    "city": "Danville",
    "county": "Boyle"
  },
  {
    "city": "Junction City",
    "county": "Boyle"
  },
  {
    "city": "Perryville",
    "county": "Boyle"
  },
  {
    "city": "Augusta",
    "county": "Bracken"
  },
  {
    "city": "Brooksville",
    "county": "Bracken"
  },
  {
    "city": "Germantown",
    "county": "Bracken"
  },
  {
    "city": "Jackson",
    "county": "Breathitt"
  },
  {
    "city": "Cloverport",
    "county": "Breckinridge"
  },
  {
    "city": "Hardinsburg",
    "county": "Breckinridge"
  },
  {
    "city": "Irvington",
    "county": "Breckinridge"
  },
  {
    "city": "Fox Chase",
    "county": "Bullitt"
  },
  {
    "city": "Hebron Estates",
    "county": "Bullitt"
  },
  {
    "city": "Hillview",
    "county": "Bullitt"
  },
  {
    "city": "Huntertown",
    "county": "Bullitt"
  },
  {
    "city": "Lebanon Junction",
    "county": "Bullitt"
  },
  {
    "city": "Mount Washington",
    "county": "Bullitt"
  },
  {
    "city": "Pioneer Village",
    "county": "Bullitt"
  },
  {
    "city": "Shepherdsville",
    "county": "Bullitt"
  },
  {
    "city": "Morgantown",
    "county": "Butler"
  },
  {
    "city": "Rochester",
    "county": "Butler"
  },
  {
    "city": "Woodbury",
    "county": "Butler"
  },
  {
    "city": "Fredonia",
    "county": "Caldwell"
  },
  {
    "city": "Princeton",
    "county": "Caldwell"
  },
  {
    "city": "Hazel",
    "county": "Calloway"
  },
  {
    "city": "Murray",
    "county": "Calloway"
  },
  {
    "city": "Alexandria",
    "county": "Campbell"
  },
  {
    "city": "Bellevue",
    "county": "Campbell"
  },
  {
    "city": "California",
    "county": "Campbell"
  },
  {
    "city": "Cold Spring",
    "county": "Campbell"
  },
  {
    "city": "Crestview",
    "county": "Campbell"
  },
  {
    "city": "Dayton",
    "county": "Campbell"
  },
  {
    "city": "Fort Thomas",
    "county": "Campbell"
  },
  {
    "city": "Highland Heights",
    "county": "Campbell"
  },
  {
    "city": "Melbourne",
    "county": "Campbell"
  },
  {
    "city": "Mentor",
    "county": "Campbell"
  },
  {
    "city": "Newport",
    "county": "Campbell"
  },
  {
    "city": "Silver Grove",
    "county": "Campbell"
  },
  {
    "city": "Southgate",
    "county": "Campbell"
  },
  {
    "city": "Wilder",
    "county": "Campbell"
  },
  {
    "city": "Woodlawn",
    "county": "Campbell"
  },
  {
    "city": "Arlington",
    "county": "Carlisle"
  },
  {
    "city": "Bardwell",
    "county": "Carlisle"
  },
  {
    "city": "Carrollton",
    "county": "Carroll"
  },
  {
    "city": "Ghent",
    "county": "Carroll"
  },
  {
    "city": "Prestonville",
    "county": "Carroll"
  },
  {
    "city": "Sanders",
    "county": "Carroll"
  },
  {
    "city": "Worthville",
    "county": "Carroll"
  },
  {
    "city": "Grayson",
    "county": "Carter"
  },
  {
    "city": "Olive Hill",
    "county": "Carter"
  },
  {
    "city": "Liberty",
    "county": "Casey"
  },
  {
    "city": "Crofton",
    "county": "Christian"
  },
  {
    "city": "Hopkinsville",
    "county": "Christian"
  },
  {
    "city": "Lafayette",
    "county": "Christian"
  },
  {
    "city": "Oak Grove",
    "county": "Christian"
  },
  {
    "city": "Pembroke",
    "county": "Christian"
  },
  {
    "city": "Winchester",
    "county": "Clark"
  },
  {
    "city": "Manchester",
    "county": "Clay"
  },
  {
    "city": "Albany",
    "county": "Clinton"
  },
  {
    "city": "Marion",
    "county": "Crittenden"
  },
  {
    "city": "Burkesville",
    "county": "Cumberland"
  },
  {
    "city": "Owensboro",
    "county": "Daviess"
  },
  {
    "city": "Whitesville",
    "county": "Daviess"
  },
  {
    "city": "Brownsville",
    "county": "Edmonson"
  },
  {
    "city": "Sandy Hook",
    "county": "Elliott"
  },
  {
    "city": "Irvine",
    "county": "Estill"
  },
  {
    "city": "Ravenna",
    "county": "Estill"
  },
  {
    "city": "Lexington",
    "county": "Fayette"
  },
  {
    "city": "Ewing",
    "county": "Fleming"
  },
  {
    "city": "Flemingsburg",
    "county": "Fleming"
  },
  {
    "city": "Nepton",
    "county": "Fleming"
  },
  {
    "city": "Allen",
    "county": "Floyd"
  },
  {
    "city": "Martin",
    "county": "Floyd"
  },
  {
    "city": "Prestonsburg",
    "county": "Floyd"
  },
  {
    "city": "Wayland",
    "county": "Floyd"
  },
  {
    "city": "Wheelwright",
    "county": "Floyd"
  },
  {
    "city": "Frankfort",
    "county": "Franklin"
  },
  {
    "city": "Fulton",
    "county": "Fulton"
  },
  {
    "city": "Hickman",
    "county": "Fulton"
  },
  {
    "city": "Glencoe",
    "county": "Gallatin"
  },
  {
    "city": "Sparta",
    "county": "Gallatin"
  },
  {
    "city": "Warsaw",
    "county": "Gallatin"
  },
  {
    "city": "Lancaster",
    "county": "Garrard"
  },
  {
    "city": "Corinth",
    "county": "Grant"
  },
  {
    "city": "Crittenden",
    "county": "Grant"
  },
  {
    "city": "Dry Ridge",
    "county": "Grant"
  },
  {
    "city": "Williamstown",
    "county": "Grant"
  },
  {
    "city": "Mayfield",
    "county": "Graves"
  },
  {
    "city": "Water Valley",
    "county": "Graves"
  },
  {
    "city": "Wingo",
    "county": "Graves"
  },
  {
    "city": "Caneyville",
    "county": "Grayson"
  },
  {
    "city": "Clarkson",
    "county": "Grayson"
  },
  {
    "city": "Leitchfield",
    "county": "Grayson"
  },
  {
    "city": "Greensburg",
    "county": "Green"
  },
  {
    "city": "Bellefonte",
    "county": "Greenup"
  },
  {
    "city": "Flatwoods",
    "county": "Greenup"
  },
  {
    "city": "Greenup",
    "county": "Greenup"
  },
  {
    "city": "Raceland",
    "county": "Greenup"
  },
  {
    "city": "Russell",
    "county": "Greenup"
  },
  {
    "city": "South Shore",
    "county": "Greenup"
  },
  {
    "city": "Wurtland",
    "county": "Greenup"
  },
  {
    "city": "Hawesville",
    "county": "Hancock"
  },
  {
    "city": "Lewisport",
    "county": "Hancock"
  },
  {
    "city": "Elizabethtown",
    "county": "Hardin"
  },
  {
    "city": "Radcliff",
    "county": "Hardin"
  },
  {
    "city": "Sonora",
    "county": "Hardin"
  },
  {
    "city": "Upton",
    "county": "Hardin"
  },
  {
    "city": "Vine Grove",
    "county": "Hardin"
  },
  {
    "city": "West Point",
    "county": "Hardin"
  },
  {
    "city": "Benham",
    "county": "Harlan"
  },
  {
    "city": "Cumberland",
    "county": "Harlan"
  },
  {
    "city": "Evarts",
    "county": "Harlan"
  },
  {
    "city": "Harlan",
    "county": "Harlan"
  },
  {
    "city": "Loyall",
    "county": "Harlan"
  },
  {
    "city": "Wallins Creek",
    "county": "Harlan"
  },
  {
    "city": "Berry",
    "county": "Harrison"
  },
  {
    "city": "Cynthiana",
    "county": "Harrison"
  },
  {
    "city": "Horse Cave",
    "county": "Hart"
  },
  {
    "city": "Munfordville",
    "county": "Hart"
  },
  {
    "city": "Corydon",
    "county": "Henderson"
  },
  {
    "city": "Henderson",
    "county": "Henderson"
  },
  {
    "city": "Robards",
    "county": "Henderson"
  },
  {
    "city": "Campbellsburg",
    "county": "Henry"
  },
  {
    "city": "Eminence",
    "county": "Henry"
  },
  {
    "city": "New Castle",
    "county": "Henry"
  },
  {
    "city": "Pleasureville",
    "county": "Henry"
  },
  {
    "city": "Smithfield",
    "county": "Henry"
  },
  {
    "city": "Clinton",
    "county": "Hickman"
  },
  {
    "city": "Columbus",
    "county": "Hickman"
  },
  {
    "city": "Dawson Springs",
    "county": "Hopkins"
  },
  {
    "city": "Earlington",
    "county": "Hopkins"
  },
  {
    "city": "Hanson",
    "county": "Hopkins"
  },
  {
    "city": "Madisonville",
    "county": "Hopkins"
  },
  {
    "city": "Mortons Gap",
    "county": "Hopkins"
  },
  {
    "city": "Nebo",
    "county": "Hopkins"
  },
  {
    "city": "Nortonville",
    "county": "Hopkins"
  },
  {
    "city": "St. Charles",
    "county": "Hopkins"
  },
  {
    "city": "White Plains",
    "county": "Hopkins"
  },
  {
    "city": "McKee",
    "county": "Jackson"
  },
  {
    "city": "Louisville",
    "county": "Jefferson"
  },
  {
    "city": "Anchorage",
    "county": "Jefferson"
  },
  {
    "city": "Audubon Park",
    "county": "Jefferson"
  },
  {
    "city": "Bancroft",
    "county": "Jefferson"
  },
  {
    "city": "Barbourmeade",
    "county": "Jefferson"
  },
  {
    "city": "Beechwood",
    "county": "Jefferson"
  },
  {
    "city": "Bellemeade",
    "county": "Jefferson"
  },
  {
    "city": "Bellewood",
    "county": "Jefferson"
  },
  {
    "city": "Blue Ridge Manor",
    "county": "Jefferson"
  },
  {
    "city": "Briarwood",
    "county": "Jefferson"
  },
  {
    "city": "Broeck Pointe",
    "county": "Jefferson"
  },
  {
    "city": "Brownsboro Farm",
    "county": "Jefferson"
  },
  {
    "city": "Brownsboro Village",
    "county": "Jefferson"
  },
  {
    "city": "Cambridge",
    "county": "Jefferson"
  },
  {
    "city": "Coldstream",
    "county": "Jefferson"
  },
  {
    "city": "Creekside",
    "county": "Jefferson"
  },
  {
    "city": "Crossgate",
    "county": "Jefferson"
  },
  {
    "city": "Douglass Hills",
    "county": "Jefferson"
  },
  {
    "city": "Druid Hills",
    "county": "Jefferson"
  },
  {
    "city": "Fincastle",
    "county": "Jefferson"
  },
  {
    "city": "Forest Hills",
    "county": "Jefferson"
  },
  {
    "city": "Glenview",
    "county": "Jefferson"
  },
  {
    "city": "Glenview Hills",
    "county": "Jefferson"
  },
  {
    "city": "Glenview Manor",
    "county": "Jefferson"
  },
  {
    "city": "Goose Creek",
    "county": "Jefferson"
  },
  {
    "city": "Graymoor-Devondale",
    "county": "Jefferson"
  },
  {
    "city": "Green Spring",
    "county": "Jefferson"
  },
  {
    "city": "Heritage Creek",
    "county": "Jefferson"
  },
  {
    "city": "Hickory Hill",
    "county": "Jefferson"
  },
  {
    "city": "Hills and Dales",
    "county": "Jefferson"
  },
  {
    "city": "Hollow Creek",
    "county": "Jefferson"
  },
  {
    "city": "Hollyvilla",
    "county": "Jefferson"
  },
  {
    "city": "Houston Acres",
    "county": "Jefferson"
  },
  {
    "city": "Hurstbourne",
    "county": "Jefferson"
  },
  {
    "city": "Hurstbourne Acres",
    "county": "Jefferson"
  },
  {
    "city": "Indian Hills",
    "county": "Jefferson"
  },
  {
    "city": "Jeffersontown",
    "county": "Jefferson"
  },
  {
    "city": "Kingsley",
    "county": "Jefferson"
  },
  {
    "city": "Langdon Place",
    "county": "Jefferson"
  },
  {
    "city": "Lincolnshire",
    "county": "Jefferson"
  },
  {
    "city": "Lyndon",
    "county": "Jefferson"
  },
  {
    "city": "Lynnview",
    "county": "Jefferson"
  },
  {
    "city": "Manor Creek",
    "county": "Jefferson"
  },
  {
    "city": "Maryhill Estates",
    "county": "Jefferson"
  },
  {
    "city": "Meadow Vale",
    "county": "Jefferson"
  },
  {
    "city": "Meadowbrook Farm",
    "county": "Jefferson"
  },
  {
    "city": "Meadowview Estates",
    "county": "Jefferson"
  },
  {
    "city": "Middletown",
    "county": "Jefferson"
  },
  {
    "city": "Mockingbird Valley",
    "county": "Jefferson"
  },
  {
    "city": "Moorland",
    "county": "Jefferson"
  },
  {
    "city": "Murray Hill",
    "county": "Jefferson"
  },
  {
    "city": "Norbourne Estates",
    "county": "Jefferson"
  },
  {
    "city": "Northfield",
    "county": "Jefferson"
  },
  {
    "city": "Norwood",
    "county": "Jefferson"
  },
  {
    "city": "Old Brownsboro Place",
    "county": "Jefferson"
  },
  {
    "city": "Parkway Village",
    "county": "Jefferson"
  },
  {
    "city": "Plantation",
    "county": "Jefferson"
  },
  {
    "city": "Poplar Hills",
    "county": "Jefferson"
  },
  {
    "city": "Prospect",
    "county": "Jefferson"
  },
  {
    "city": "Richlawn",
    "county": "Jefferson"
  },
  {
    "city": "Riverwood",
    "county": "Jefferson"
  },
  {
    "city": "Rolling Fields",
    "county": "Jefferson"
  },
  {
    "city": "Rolling Hills",
    "county": "Jefferson"
  },
  {
    "city": "St. Matthews",
    "county": "Jefferson"
  },
  {
    "city": "St. Regis Park",
    "county": "Jefferson"
  },
  {
    "city": "Seneca Gardens",
    "county": "Jefferson"
  },
  {
    "city": "Shively",
    "county": "Jefferson"
  },
  {
    "city": "South Park View",
    "county": "Jefferson"
  },
  {
    "city": "Spring Mill",
    "county": "Jefferson"
  },
  {
    "city": "Spring Valley",
    "county": "Jefferson"
  },
  {
    "city": "Strathmoor Manor",
    "county": "Jefferson"
  },
  {
    "city": "Strathmoor Village",
    "county": "Jefferson"
  },
  {
    "city": "Sycamore",
    "county": "Jefferson"
  },
  {
    "city": "Ten Broeck",
    "county": "Jefferson"
  },
  {
    "city": "Thornhill",
    "county": "Jefferson"
  },
  {
    "city": "Watterson Park",
    "county": "Jefferson"
  },
  {
    "city": "Wellington",
    "county": "Jefferson"
  },
  {
    "city": "West Buechel",
    "county": "Jefferson"
  },
  {
    "city": "Westwood",
    "county": "Jefferson"
  },
  {
    "city": "Wildwood",
    "county": "Jefferson"
  },
  {
    "city": "Windy Hills",
    "county": "Jefferson"
  },
  {
    "city": "Woodland Hills",
    "county": "Jefferson"
  },
  {
    "city": "Woodlawn Park",
    "county": "Jefferson"
  },
  {
    "city": "Worthington Hills",
    "county": "Jefferson"
  },
  {
    "city": "Keene",
    "county": "Jessamine"
  },
  {
    "city": "Nicholasville",
    "county": "Jessamine"
  },
  {
    "city": "Wilmore",
    "county": "Jessamine"
  },
  {
    "city": "Paintsville",
    "county": "Johnson"
  },
  {
    "city": "Bromley",
    "county": "Kenton"
  },
  {
    "city": "Covington",
    "county": "Kenton"
  },
  {
    "city": "Crescent Springs",
    "county": "Kenton"
  },
  {
    "city": "Crestview Hills",
    "county": "Kenton"
  },
  {
    "city": "Edgewood",
    "county": "Kenton"
  },
  {
    "city": "Elsmere",
    "county": "Kenton"
  },
  {
    "city": "Erlanger",
    "county": "Kenton"
  },
  {
    "city": "Fairview",
    "county": "Kenton"
  },
  {
    "city": "Fort Mitchell",
    "county": "Kenton"
  },
  {
    "city": "Fort Wright",
    "county": "Kenton"
  },
  {
    "city": "Independence",
    "county": "Kenton"
  },
  {
    "city": "Kenton Vale",
    "county": "Kenton"
  },
  {
    "city": "Lakeside Park",
    "county": "Kenton"
  },
  {
    "city": "Ludlow",
    "county": "Kenton"
  },
  {
    "city": "Park Hills",
    "county": "Kenton"
  },
  {
    "city": "Ryland Heights",
    "county": "Kenton"
  },
  {
    "city": "Taylor Mill",
    "county": "Kenton"
  },
  {
    "city": "Villa Hills",
    "county": "Kenton"
  },
  {
    "city": "Walton",
    "county": "Kenton"
  },
  {
    "city": "Hindman",
    "county": "Knott"
  },
  {
    "city": "Pippa Passes",
    "county": "Knott"
  },
  {
    "city": "Vicco",
    "county": "Knott"
  },
  {
    "city": "Barbourville",
    "county": "Knox"
  },
  {
    "city": "Corbin",
    "county": "Knox"
  },
  {
    "city": "Hodgenville",
    "county": "LaRue"
  },
  {
    "city": "Upton",
    "county": "LaRue"
  },
  {
    "city": "Corbin",
    "county": "Laurel"
  },
  {
    "city": "London",
    "county": "Laurel"
  },
  {
    "city": "Blaine",
    "county": "Lawrence"
  },
  {
    "city": "Louisa",
    "county": "Lawrence"
  },
  {
    "city": "Beattyville",
    "county": "Lee"
  },
  {
    "city": "Hyden",
    "county": "Leslie"
  },
  {
    "city": "Blackey",
    "county": "Letcher"
  },
  {
    "city": "Fleming-Neon",
    "county": "Letcher"
  },
  {
    "city": "Jenkins",
    "county": "Letcher"
  },
  {
    "city": "Whitesburg",
    "county": "Letcher"
  },
  {
    "city": "Concord",
    "county": "Lewis"
  },
  {
    "city": "Vanceburg",
    "county": "Lewis"
  },
  {
    "city": "Crab Orchard",
    "county": "Lincoln"
  },
  {
    "city": "Hustonville",
    "county": "Lincoln"
  },
  {
    "city": "Stanford",
    "county": "Lincoln"
  },
  {
    "city": "Carrsville",
    "county": "Livingston"
  },
  {
    "city": "Grand Rivers",
    "county": "Livingston"
  },
  {
    "city": "Salem",
    "county": "Livingston"
  },
  {
    "city": "Smithland",
    "county": "Livingston"
  },
  {
    "city": "Adairville",
    "county": "Logan"
  },
  {
    "city": "Auburn",
    "county": "Logan"
  },
  {
    "city": "Lewisburg",
    "county": "Logan"
  },
  {
    "city": "Russellville",
    "county": "Logan"
  },
  {
    "city": "Eddyville",
    "county": "Lyon"
  },
  {
    "city": "Kuttawa",
    "county": "Lyon"
  },
  {
    "city": "Berea",
    "county": "Madison"
  },
  {
    "city": "Richmond",
    "county": "Madison"
  },
  {
    "city": "Salyersville",
    "county": "Magoffin"
  },
  {
    "city": "Bradfordsville",
    "county": "Marion"
  },
  {
    "city": "Lebanon",
    "county": "Marion"
  },
  {
    "city": "Loretto",
    "county": "Marion"
  },
  {
    "city": "Raywick",
    "county": "Marion"
  },
  {
    "city": "St. Mary",
    "county": "Marion"
  },
  {
    "city": "Benton",
    "county": "Marshall"
  },
  {
    "city": "Calvert City",
    "county": "Marshall"
  },
  {
    "city": "Hardin",
    "county": "Marshall"
  },
  {
    "city": "Inez",
    "county": "Martin"
  },
  {
    "city": "Warfield",
    "county": "Martin"
  },
  {
    "city": "Dover",
    "county": "Mason"
  },
  {
    "city": "Germantown",
    "county": "Mason"
  },
  {
    "city": "Maysville",
    "county": "Mason"
  },
  {
    "city": "Sardis",
    "county": "Mason"
  },
  {
    "city": "Paducah",
    "county": "McCracken"
  },
  {
    "city": "Calhoun",
    "county": "McLean"
  },
  {
    "city": "Island",
    "county": "McLean"
  },
  {
    "city": "Livermore",
    "county": "McLean"
  },
  {
    "city": "Sacramento",
    "county": "McLean"
  },
  {
    "city": "Brandenburg",
    "county": "Meade"
  },
  {
    "city": "Ekron",
    "county": "Meade"
  },
  {
    "city": "Muldraugh",
    "county": "Meade"
  },
  {
    "city": "Frenchburg",
    "county": "Menifee"
  },
  {
    "city": "Burgin",
    "county": "Mercer"
  },
  {
    "city": "Harrodsburg",
    "county": "Mercer"
  },
  {
    "city": "Edmonton",
    "county": "Metcalfe"
  },
  {
    "city": "Fountain Run",
    "county": "Monroe"
  },
  {
    "city": "Gamaliel",
    "county": "Monroe"
  },
  {
    "city": "Tompkinsville",
    "county": "Monroe"
  },
  {
    "city": "Camargo",
    "county": "Montgomery"
  },
  {
    "city": "Jeffersonville",
    "county": "Montgomery"
  },
  {
    "city": "Mount Sterling",
    "county": "Montgomery"
  },
  {
    "city": "West Liberty",
    "county": "Morgan"
  },
  {
    "city": "Bremen",
    "county": "Muhlenberg"
  },
  {
    "city": "Central City",
    "county": "Muhlenberg"
  },
  {
    "city": "Drakesboro",
    "county": "Muhlenberg"
  },
  {
    "city": "Greenville",
    "county": "Muhlenberg"
  },
  {
    "city": "Powderly",
    "county": "Muhlenberg"
  },
  {
    "city": "South Carrollton",
    "county": "Muhlenberg"
  },
  {
    "city": "Bardstown",
    "county": "Nelson"
  },
  {
    "city": "Bloomfield",
    "county": "Nelson"
  },
  {
    "city": "Fairfield",
    "county": "Nelson"
  },
  {
    "city": "New Haven",
    "county": "Nelson"
  },
  {
    "city": "Carlisle",
    "county": "Nicholas"
  },
  {
    "city": "Beaver Dam",
    "county": "Ohio"
  },
  {
    "city": "Centertown",
    "county": "Ohio"
  },
  {
    "city": "Fordsville",
    "county": "Ohio"
  },
  {
    "city": "Hartford",
    "county": "Ohio"
  },
  {
    "city": "McHenry",
    "county": "Ohio"
  },
  {
    "city": "Rockport",
    "county": "Ohio"
  },
  {
    "city": "Crestwood",
    "county": "Oldham"
  },
  {
    "city": "Goshen",
    "county": "Oldham"
  },
  {
    "city": "La Grange",
    "county": "Oldham"
  },
  {
    "city": "Orchard Grass Hills",
    "county": "Oldham"
  },
  {
    "city": "Pewee Valley",
    "county": "Oldham"
  },
  {
    "city": "Prospect",
    "county": "Oldham"
  },
  {
    "city": "River Bluff",
    "county": "Oldham"
  },
  {
    "city": "Gratz",
    "county": "Owen"
  },
  {
    "city": "Monterey",
    "county": "Owen"
  },
  {
    "city": "Owenton",
    "county": "Owen"
  },
  {
    "city": "Sparta",
    "county": "Owen"
  },
  {
    "city": "Booneville",
    "county": "Owsley"
  },
  {
    "city": "Butler",
    "county": "Pendleton"
  },
  {
    "city": "Falmouth",
    "county": "Pendleton"
  },
  {
    "city": "Buckhorn",
    "county": "Perry"
  },
  {
    "city": "Hazard",
    "county": "Perry"
  },
  {
    "city": "Vicco",
    "county": "Perry"
  },
  {
    "city": "Coal Run Village",
    "county": "Pike"
  },
  {
    "city": "Elkhorn City",
    "county": "Pike"
  },
  {
    "city": "Pikeville",
    "county": "Pike"
  },
  {
    "city": "Clay City",
    "county": "Powell"
  },
  {
    "city": "Stanton",
    "county": "Powell"
  },
  {
    "city": "Burnside",
    "county": "Pulaski"
  },
  {
    "city": "Eubank",
    "county": "Pulaski"
  },
  {
    "city": "Ferguson",
    "county": "Pulaski"
  },
  {
    "city": "Science Hill",
    "county": "Pulaski"
  },
  {
    "city": "Somerset",
    "county": "Pulaski"
  },
  {
    "city": "Mount Olivet",
    "county": "Robertson"
  },
  {
    "city": "Brodhead",
    "county": "Rockcastle"
  },
  {
    "city": "Livingston",
    "county": "Rockcastle"
  },
  {
    "city": "Mount Vernon",
    "county": "Rockcastle"
  },
  {
    "city": "Morehead",
    "county": "Rowan"
  },
  {
    "city": "Jamestown",
    "county": "Russell"
  },
  {
    "city": "Russell Springs",
    "county": "Russell"
  },
  {
    "city": "Georgetown",
    "county": "Scott"
  },
  {
    "city": "Sadieville",
    "county": "Scott"
  },
  {
    "city": "Stamping Ground",
    "county": "Scott"
  },
  {
    "city": "Pleasureville",
    "county": "Shelby"
  },
  {
    "city": "Shelbyville",
    "county": "Shelby"
  },
  {
    "city": "Simpsonville",
    "county": "Shelby"
  },
  {
    "city": "Franklin",
    "county": "Simpson"
  },
  {
    "city": "Taylorsville",
    "county": "Spencer"
  },
  {
    "city": "Campbellsville",
    "county": "Taylor"
  },
  {
    "city": "Elkton",
    "county": "Todd"
  },
  {
    "city": "Guthrie",
    "county": "Todd"
  },
  {
    "city": "Trenton",
    "county": "Todd"
  },
  {
    "city": "Cadiz",
    "county": "Trigg"
  },
  {
    "city": "Bedford",
    "county": "Trimble"
  },
  {
    "city": "Milton",
    "county": "Trimble"
  },
  {
    "city": "Morganfield",
    "county": "Union"
  },
  {
    "city": "Sturgis",
    "county": "Union"
  },
  {
    "city": "Uniontown",
    "county": "Union"
  },
  {
    "city": "Waverly",
    "county": "Union"
  },
  {
    "city": "Bowling Green",
    "county": "Warren"
  },
  {
    "city": "Oakland",
    "county": "Warren"
  },
  {
    "city": "Plum Springs",
    "county": "Warren"
  },
  {
    "city": "Smiths Grove",
    "county": "Warren"
  },
  {
    "city": "Woodburn",
    "county": "Warren"
  },
  {
    "city": "Mackville",
    "county": "Washington"
  },
  {
    "city": "Springfield",
    "county": "Washington"
  },
  {
    "city": "Willisburg",
    "county": "Washington"
  },
  {
    "city": "Monticello",
    "county": "Wayne"
  },
  {
    "city": "Clay",
    "county": "Webster"
  },
  {
    "city": "Dixon",
    "county": "Webster"
  },
  {
    "city": "Providence",
    "county": "Webster"
  },
  {
    "city": "Sebree",
    "county": "Webster"
  },
  {
    "city": "Slaughters",
    "county": "Webster"
  },
  {
    "city": "Wheatcroft",
    "county": "Webster"
  },
  {
    "city": "Corbin",
    "county": "Whitley"
  },
  {
    "city": "Williamsburg",
    "county": "Whitley"
  },
  {
    "city": "Campton",
    "county": "Wolfe"
  },
  {
    "city": "Midway",
    "county": "Woodford"
  },
  {
    "city": "Versailles",
    "county": "Woodford"
  }
]

```

# apps\web\src\data\ky-counties.json

```json
[
  {
    "name": "Adair",
    "full": "Adair County",
    "fips": "21001"
  },
  {
    "name": "Allen",
    "full": "Allen County",
    "fips": "21003"
  },
  {
    "name": "Anderson",
    "full": "Anderson County",
    "fips": "21005"
  },
  {
    "name": "Ballard",
    "full": "Ballard County",
    "fips": "21007"
  },
  {
    "name": "Barren",
    "full": "Barren County",
    "fips": "21009"
  },
  {
    "name": "Bath",
    "full": "Bath County",
    "fips": "21011"
  },
  {
    "name": "Bell",
    "full": "Bell County",
    "fips": "21013"
  },
  {
    "name": "Boone",
    "full": "Boone County",
    "fips": "21015"
  },
  {
    "name": "Bourbon",
    "full": "Bourbon County",
    "fips": "21017"
  },
  {
    "name": "Boyd",
    "full": "Boyd County",
    "fips": "21019"
  },
  {
    "name": "Boyle",
    "full": "Boyle County",
    "fips": "21021"
  },
  {
    "name": "Bracken",
    "full": "Bracken County",
    "fips": "21023"
  },
  {
    "name": "Breathitt",
    "full": "Breathitt County",
    "fips": "21025"
  },
  {
    "name": "Breckinridge",
    "full": "Breckinridge County",
    "fips": "21027"
  },
  {
    "name": "Bullitt",
    "full": "Bullitt County",
    "fips": "21029"
  },
  {
    "name": "Butler",
    "full": "Butler County",
    "fips": "21031"
  },
  {
    "name": "Caldwell",
    "full": "Caldwell County",
    "fips": "21033"
  },
  {
    "name": "Calloway",
    "full": "Calloway County",
    "fips": "21035"
  },
  {
    "name": "Campbell",
    "full": "Campbell County",
    "fips": "21037"
  },
  {
    "name": "Carlisle",
    "full": "Carlisle County",
    "fips": "21039"
  },
  {
    "name": "Carroll",
    "full": "Carroll County",
    "fips": "21041"
  },
  {
    "name": "Carter",
    "full": "Carter County",
    "fips": "21043"
  },
  {
    "name": "Casey",
    "full": "Casey County",
    "fips": "21045"
  },
  {
    "name": "Christian",
    "full": "Christian County",
    "fips": "21047"
  },
  {
    "name": "Clark",
    "full": "Clark County",
    "fips": "21049"
  },
  {
    "name": "Clay",
    "full": "Clay County",
    "fips": "21051"
  },
  {
    "name": "Clinton",
    "full": "Clinton County",
    "fips": "21053"
  },
  {
    "name": "Crittenden",
    "full": "Crittenden County",
    "fips": "21055"
  },
  {
    "name": "Cumberland",
    "full": "Cumberland County",
    "fips": "21057"
  },
  {
    "name": "Daviess",
    "full": "Daviess County",
    "fips": "21059"
  },
  {
    "name": "Edmonson",
    "full": "Edmonson County",
    "fips": "21061"
  },
  {
    "name": "Elliott",
    "full": "Elliott County",
    "fips": "21063"
  },
  {
    "name": "Estill",
    "full": "Estill County",
    "fips": "21065"
  },
  {
    "name": "Fayette",
    "full": "Fayette County",
    "fips": "21067"
  },
  {
    "name": "Fleming",
    "full": "Fleming County",
    "fips": "21069"
  },
  {
    "name": "Floyd",
    "full": "Floyd County",
    "fips": "21071"
  },
  {
    "name": "Franklin",
    "full": "Franklin County",
    "fips": "21073"
  },
  {
    "name": "Fulton",
    "full": "Fulton County",
    "fips": "21075"
  },
  {
    "name": "Gallatin",
    "full": "Gallatin County",
    "fips": "21077"
  },
  {
    "name": "Garrard",
    "full": "Garrard County",
    "fips": "21079"
  },
  {
    "name": "Grant",
    "full": "Grant County",
    "fips": "21081"
  },
  {
    "name": "Graves",
    "full": "Graves County",
    "fips": "21083"
  },
  {
    "name": "Grayson",
    "full": "Grayson County",
    "fips": "21085"
  },
  {
    "name": "Green",
    "full": "Green County",
    "fips": "21087"
  },
  {
    "name": "Greenup",
    "full": "Greenup County",
    "fips": "21089"
  },
  {
    "name": "Hancock",
    "full": "Hancock County",
    "fips": "21091"
  },
  {
    "name": "Hardin",
    "full": "Hardin County",
    "fips": "21093"
  },
  {
    "name": "Harlan",
    "full": "Harlan County",
    "fips": "21095"
  },
  {
    "name": "Harrison",
    "full": "Harrison County",
    "fips": "21097"
  },
  {
    "name": "Hart",
    "full": "Hart County",
    "fips": "21099"
  },
  {
    "name": "Henderson",
    "full": "Henderson County",
    "fips": "21101"
  },
  {
    "name": "Henry",
    "full": "Henry County",
    "fips": "21103"
  },
  {
    "name": "Hickman",
    "full": "Hickman County",
    "fips": "21105"
  },
  {
    "name": "Hopkins",
    "full": "Hopkins County",
    "fips": "21107"
  },
  {
    "name": "Jackson",
    "full": "Jackson County",
    "fips": "21109"
  },
  {
    "name": "Jefferson",
    "full": "Jefferson County",
    "fips": "21111"
  },
  {
    "name": "Jessamine",
    "full": "Jessamine County",
    "fips": "21113"
  },
  {
    "name": "Johnson",
    "full": "Johnson County",
    "fips": "21115"
  },
  {
    "name": "Kenton",
    "full": "Kenton County",
    "fips": "21117"
  },
  {
    "name": "Knott",
    "full": "Knott County",
    "fips": "21119"
  },
  {
    "name": "Knox",
    "full": "Knox County",
    "fips": "21121"
  },
  {
    "name": "Larue",
    "full": "Larue County",
    "fips": "21123"
  },
  {
    "name": "Laurel",
    "full": "Laurel County",
    "fips": "21125"
  },
  {
    "name": "Lawrence",
    "full": "Lawrence County",
    "fips": "21127"
  },
  {
    "name": "Lee",
    "full": "Lee County",
    "fips": "21129"
  },
  {
    "name": "Leslie",
    "full": "Leslie County",
    "fips": "21131"
  },
  {
    "name": "Letcher",
    "full": "Letcher County",
    "fips": "21133"
  },
  {
    "name": "Lewis",
    "full": "Lewis County",
    "fips": "21135"
  },
  {
    "name": "Lincoln",
    "full": "Lincoln County",
    "fips": "21137"
  },
  {
    "name": "Livingston",
    "full": "Livingston County",
    "fips": "21139"
  },
  {
    "name": "Logan",
    "full": "Logan County",
    "fips": "21141"
  },
  {
    "name": "Lyon",
    "full": "Lyon County",
    "fips": "21143"
  },
  {
    "name": "Madison",
    "full": "Madison County",
    "fips": "21151"
  },
  {
    "name": "Magoffin",
    "full": "Magoffin County",
    "fips": "21153"
  },
  {
    "name": "Marion",
    "full": "Marion County",
    "fips": "21155"
  },
  {
    "name": "Marshall",
    "full": "Marshall County",
    "fips": "21157"
  },
  {
    "name": "Martin",
    "full": "Martin County",
    "fips": "21159"
  },
  {
    "name": "Mason",
    "full": "Mason County",
    "fips": "21161"
  },
  {
    "name": "McCracken",
    "full": "McCracken County",
    "fips": "21145"
  },
  {
    "name": "McCreary",
    "full": "McCreary County",
    "fips": "21147"
  },
  {
    "name": "McLean",
    "full": "McLean County",
    "fips": "21149"
  },
  {
    "name": "Meade",
    "full": "Meade County",
    "fips": "21163"
  },
  {
    "name": "Menifee",
    "full": "Menifee County",
    "fips": "21165"
  },
  {
    "name": "Mercer",
    "full": "Mercer County",
    "fips": "21167"
  },
  {
    "name": "Metcalfe",
    "full": "Metcalfe County",
    "fips": "21169"
  },
  {
    "name": "Monroe",
    "full": "Monroe County",
    "fips": "21171"
  },
  {
    "name": "Montgomery",
    "full": "Montgomery County",
    "fips": "21173"
  },
  {
    "name": "Morgan",
    "full": "Morgan County",
    "fips": "21175"
  },
  {
    "name": "Muhlenberg",
    "full": "Muhlenberg County",
    "fips": "21177"
  },
  {
    "name": "Nelson",
    "full": "Nelson County",
    "fips": "21179"
  },
  {
    "name": "Nicholas",
    "full": "Nicholas County",
    "fips": "21181"
  },
  {
    "name": "Ohio",
    "full": "Ohio County",
    "fips": "21183"
  },
  {
    "name": "Oldham",
    "full": "Oldham County",
    "fips": "21185"
  },
  {
    "name": "Owen",
    "full": "Owen County",
    "fips": "21187"
  },
  {
    "name": "Owsley",
    "full": "Owsley County",
    "fips": "21189"
  },
  {
    "name": "Pendleton",
    "full": "Pendleton County",
    "fips": "21191"
  },
  {
    "name": "Perry",
    "full": "Perry County",
    "fips": "21193"
  },
  {
    "name": "Pike",
    "full": "Pike County",
    "fips": "21195"
  },
  {
    "name": "Powell",
    "full": "Powell County",
    "fips": "21197"
  },
  {
    "name": "Pulaski",
    "full": "Pulaski County",
    "fips": "21199"
  },
  {
    "name": "Robertson",
    "full": "Robertson County",
    "fips": "21201"
  },
  {
    "name": "Rockcastle",
    "full": "Rockcastle County",
    "fips": "21203"
  },
  {
    "name": "Rowan",
    "full": "Rowan County",
    "fips": "21205"
  },
  {
    "name": "Russell",
    "full": "Russell County",
    "fips": "21207"
  },
  {
    "name": "Scott",
    "full": "Scott County",
    "fips": "21209"
  },
  {
    "name": "Shelby",
    "full": "Shelby County",
    "fips": "21211"
  },
  {
    "name": "Simpson",
    "full": "Simpson County",
    "fips": "21213"
  },
  {
    "name": "Spencer",
    "full": "Spencer County",
    "fips": "21215"
  },
  {
    "name": "Taylor",
    "full": "Taylor County",
    "fips": "21217"
  },
  {
    "name": "Todd",
    "full": "Todd County",
    "fips": "21219"
  },
  {
    "name": "Trigg",
    "full": "Trigg County",
    "fips": "21221"
  },
  {
    "name": "Trimble",
    "full": "Trimble County",
    "fips": "21223"
  },
  {
    "name": "Union",
    "full": "Union County",
    "fips": "21225"
  },
  {
    "name": "Warren",
    "full": "Warren County",
    "fips": "21227"
  },
  {
    "name": "Washington",
    "full": "Washington County",
    "fips": "21229"
  },
  {
    "name": "Wayne",
    "full": "Wayne County",
    "fips": "21231"
  },
  {
    "name": "Webster",
    "full": "Webster County",
    "fips": "21233"
  },
  {
    "name": "Whitley",
    "full": "Whitley County",
    "fips": "21235"
  },
  {
    "name": "Wolfe",
    "full": "Wolfe County",
    "fips": "21237"
  },
  {
    "name": "Woodford",
    "full": "Woodford County",
    "fips": "21239"
  }
]
```

# apps\web\src\data\localDb.ts

```ts
import Dexie, { type Table } from "dexie";

export type LocalReadState = {
  id: string;        // itemId
  readAt: string;    // ISO
};

export type LocalSavedState = {
  id: string;        // itemId
  savedAt: string;   // ISO
};

export type LocalSavedItem = {
  id: string;          // itemId
  savedAt: string;     // ISO
  title: string;
  url: string;
  author?: string | null;
  published_at?: string | null;
  summary?: string | null;
  content?: string | null;
  image_url?: string | null;
  source?: string | null;
};

export type LocalCachedItem = {
  id: string;          // itemId
  cachedAt: string;    // ISO
  title: string;
  url: string;
  author?: string | null;
  published_at?: string | null;
  summary?: string | null;
  content?: string | null;
  image_url?: string | null;
  source?: string | null;
};

export type LocalSavedPage = {
  id: string;        // page key
  savedAt: string;   // ISO
  title: string;
  url: string;
  source?: string | null;
  countySlug?: string | null;
};

class LocalDB extends Dexie {
  read!: Table<LocalReadState, string>;
  saved!: Table<LocalSavedState, string>;
  savedItems!: Table<LocalSavedItem, string>;
  cached!: Table<LocalCachedItem, string>;
  savedPages!: Table<LocalSavedPage, string>;

  constructor() {
    super("feedreader_local");
    this.version(3).stores({
      read: "id, readAt",
      saved: "id, savedAt",
      savedItems: "id, savedAt",
      cached: "id, cachedAt",
      savedPages: "id, savedAt, countySlug"
    });
  }
}

export const localDb = new LocalDB();

export async function markRead(id: string) {
  await localDb.read.put({ id, readAt: new Date().toISOString() });
}

export async function markUnread(id: string) {
  await localDb.read.delete(id);
}

export async function isRead(id: string) {
  const row = await localDb.read.get(id);
  return !!row;
}

export async function toggleSaved(item: {
  id: string;
  title: string;
  url: string;
  author?: string | null;
  published_at?: string | null;
  summary?: string | null;
  content?: string | null;
  image_url?: string | null;
  source?: string | null;
}) {
  const existing = await localDb.savedItems.get(item.id);
  if (existing) {
    await localDb.savedItems.delete(item.id);
    await localDb.saved.delete(item.id);
    return false;
  }
  const savedAt = new Date().toISOString();
  await localDb.saved.put({ id: item.id, savedAt });
  await localDb.savedItems.put({ ...item, savedAt });
  return true;
}

export async function isSaved(id: string) {
  return !!(await localDb.savedItems.get(id) || await localDb.saved.get(id));
}

export async function listSavedItems(limit = 200) {
  return localDb.savedItems.orderBy("savedAt").reverse().limit(limit).toArray();
}

export async function toggleSavedPage(page: {
  id: string;
  title: string;
  url: string;
  source?: string | null;
  countySlug?: string | null;
}) {
  const existing = await localDb.savedPages.get(page.id);
  if (existing) {
    await localDb.savedPages.delete(page.id);
    return false;
  }

  const savedAt = new Date().toISOString();
  await localDb.savedPages.put({ ...page, savedAt });
  return true;
}

export async function isSavedPage(id: string) {
  return !!(await localDb.savedPages.get(id));
}

export async function cacheLastOpened(item: Omit<LocalCachedItem, "cachedAt">, maxItems = 30) {
  await localDb.cached.put({ ...item, cachedAt: new Date().toISOString() });

  // keep last N by cachedAt
  const all = await localDb.cached.orderBy("cachedAt").reverse().toArray();
  if (all.length > maxItems) {
    const toDelete = all.slice(maxItems);
    await localDb.cached.bulkDelete(toDelete.map((x) => x.id));
  }
}

export async function getCachedItem(id: string) {
  return localDb.cached.get(id);
}

export async function bulkIsRead(ids: string[]) {
  if (!ids.length) return new Map<string, boolean>();
  const rows = await localDb.read.bulkGet(ids);
  const m = new Map<string, boolean>();
  ids.forEach((id, i) => m.set(id, !!rows[i]));
  return m;
}

```

# apps\web\src\main.tsx

```tsx
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import { HelmetProvider } from "react-helmet-async";
import App from "./ui/App";
import stylesText from "./ui/styles.css?inline";

if (typeof document !== "undefined" && !document.querySelector("style[data-app-styles='1']")) {
  const styleEl = document.createElement("style");
  styleEl.setAttribute("data-app-styles", "1");
  styleEl.textContent = stylesText;
  document.head.appendChild(styleEl);
}

if (typeof window !== "undefined" && "serviceWorker" in navigator) {
  // Clean up old PWA registrations so stale bundles do not keep controlling the app.
  window.addEventListener("load", () => {
    void navigator.serviceWorker.getRegistrations().then((registrations) => {
      for (const registration of registrations) {
        void registration.unregister();
      }
    });

    if ("caches" in window) {
      void caches.keys().then((keys) => {
        for (const key of keys) {
          if (/workbox|pwa|image-cache|api-cache/i.test(key)) {
            void caches.delete(key);
          }
        }
      });
    }
  });
}

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <HelmetProvider>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </HelmetProvider>
  </React.StrictMode>
);

```

# apps\web\src\ui\App.tsx

```tsx
import React, { useEffect, useMemo, useRef, useState } from "react";
import { Navigate, Route, Routes, useLocation, useNavigate, useParams } from "react-router-dom";
import {
  getFeeds,
  getItems,
  getCounties,
  getOpenProxy,
  searchItems,
  getWeatherForecast,
  getWeatherAlerts,
  listLostFound,
  listLostFoundComments,
  submitLostFound,
  submitLostFoundComment,
  getLostFoundUploadUrl,
  uploadLostFoundImage,
  markLostFoundAsFound,
  listAdminLostFound,
  listAdminLostFoundComments,
  listAdminLostFoundCommentBans,
  deleteAdminLostFound,
  deleteAdminLostFoundComment,
  deleteAdminLostFoundCommentBan,
  banAdminLostFoundComment,
  approveAdminLostFound,
  rejectAdminLostFound,
  getAdminIngestionLogs,
  getAdminFeedHealth,
  runAdminFeedReload,
  runAdminItemsRevalidate,
  type AdminFeedHealth,
  type AdminLostFoundComment,
  type AdminLostFoundCommentBan,
  type AdminItemRevalidateSummary,
  type AdminIngestionLog,
  type Feed,
  type Item,
  type LostFoundPost,
  type LostFoundComment,
  type LostFoundType,
  type WeatherAlert,
  type WeatherForecast
} from "../data/api";
import { bulkIsRead, isSaved, isSavedPage, listSavedItems, markRead, toggleSaved, toggleSavedPage } from "../data/localDb";
import Reader from "./Reader";
import { IconHeart, IconMapPin, IconMenu, IconSearch, IconSettings, IconShare, IconToday } from "./icons";
import kyCounties from "../data/ky-counties.json";
import { countyNameToSlug, countySlugToDisplayName, countySlugToName } from "../data/countySlug";
import { SeoMeta, StructuredData, absoluteUrl, getSiteUrl, type SeoJsonLd } from "./Seo";

function sourceFromUrl(url: string) {
  try {
    const u = new URL(url);
    return u.hostname.replace(/^www\./, "");
  } catch {
    return "";
  }
}

function formatPublishedDate(iso?: string | null) {
  if (!iso) return "Published date unavailable";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "Published date unavailable";
  return d.toLocaleString(undefined, {
    month: "short",
    day: "numeric",
    year: "numeric",
    hour: "numeric",
    minute: "2-digit"
  });
}

function stripHtml(input?: string | null) {
  if (!input) return "";
  return input.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
}

function summarySnippet(item: Item, maxWords = 24) {
  const clean = stripHtml(item.summary || item.content || "");
  if (!clean) return "Tap to open the full story.";
  const words = clean.split(" ");
  if (words.length <= maxWords) return clean;
  return words.slice(0, maxWords).join(" ") + "...";
}

function formatFromNow(iso?: string | null) {
  if (!iso) return "Unknown time";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "Unknown time";

  const diffMs = Date.now() - d.getTime();
  const diffMinutes = Math.max(1, Math.floor(diffMs / 60000));
  if (diffMinutes < 60) return `${diffMinutes}m ago`;
  const diffHours = Math.floor(diffMinutes / 60);
  if (diffHours < 24) return `${diffHours}h ago`;
  const diffDays = Math.floor(diffHours / 24);
  if (diffDays < 7) return `${diffDays}d ago`;
  return formatPublishedDate(iso);
}

function truncateText(value: string, maxChars = 420): string {
  const text = stripHtml(value).trim();
  if (!text) return "";
  if (text.length <= maxChars) return text;
  return `${text.slice(0, Math.max(0, maxChars - 1)).trimEnd()}...`;
}

function normalizeTitleForDedupe(title?: string | null): string {
  return String(title || "")
    .toLowerCase()
    .replace(/[^a-z0-9 ]+/g, " ")
    .replace(/\b(the|a|an|and|or|for|to|of|in|on|at|from|with|by|as|is|was|are|were)\b/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function mergeUniqueItems(prev: Item[], incoming: Item[]): Item[] {
  const seenIds = new Set(prev.map((i) => i.id));
  const seenUrls = new Set(prev.map((i) => i.url));
  const seenTitles = new Set(prev.map((i) => normalizeTitleForDedupe(i.title)));
  const merged = [...prev];

  for (const item of incoming) {
    const titleKey = normalizeTitleForDedupe(item.title);
    if (seenIds.has(item.id) || seenUrls.has(item.url) || (titleKey && seenTitles.has(titleKey))) continue;
    merged.push(item);
    seenIds.add(item.id);
    seenUrls.add(item.url);
    if (titleKey) seenTitles.add(titleKey);
  }

  return merged;
}

const SPORTS_CONTENT_RE =
  /\b(sports?|football|basketball|baseball|soccer|volleyball|wrestling|athletic(?:s)?|nfl|nba|mlb|nhl|ncaa|hockey|olympics?|olympic|swimming|swimmer|tennis|golf|golfer|gymnastics?|gymnast|cycling|cyclist|lacrosse|softball|rugby|rowing|track\s+and\s+field|medal|athlete|tournament|championship|semifinal|quarterfinal)\b/i;

function isLikelySportsItem(item: Item): boolean {
  // Also check URL path — many sports articles have /sports/ in the URL
  try {
    if (/\/sports\//.test(new URL(item.url || "").pathname)) return true;
  } catch { /* ignore malformed URLs */ }
  const haystack = `${item.title || ""} ${item.summary || ""} ${item.content || ""}`;
  return SPORTS_CONTENT_RE.test(haystack);
}

const COVERAGE_TABS = [
  { id: "today", label: "TODAY", path: "/today" },
  { id: "national", label: "NATIONAL", path: "/national" },
  { id: "sports", label: "SPORTS", path: "/sports" },
  { id: "weather", label: "WEATHER", path: "/weather" },
  { id: "schools", label: "SCHOOLS", path: "/schools" },
  { id: "obituaries", label: "OBITUARIES", path: "/obituaries" },
  { id: "lost-found", label: "LOST & FOUND", path: "/lost-found" }
];

const LOCAL_PREF_KEY = "my_local_county";
const SELECTED_COUNTIES_PREF_KEY = "selected_counties";
const SELECTED_COUNTIES_CHANGED_EVENT = "selected-counties:changed";
const THEME_PREF_KEY = "ui_theme";
const OWNER_ADMIN_TOKEN_KEY = "owner_admin_token";
const OWNER_ADMIN_ROUTE = "/owner-panel-ky-news";
const TODAY_LOOKBACK_HOURS = 72;
// Smaller page chunks reduce initial API latency and first-render network payload.
const FEED_PAGE_SIZE = 20;
const COUNTY_PAGE_SIZE = 20;
// Users expect cards with available images to show thumbnails in-feed.
const MAX_INLINE_CARD_IMAGES = Number.MAX_SAFE_INTEGER;
const SPORTS_LOOKBACK_HOURS = 24 * 14;
const MIN_COUNTY_STORIES = 5;
const OBITUARY_LOOKBACK_HOURS = 24 * 365;
const OBITUARY_FALLBACK_QUERY = "\"obituary\" OR \"obituaries\" OR \"passed away\" OR \"in loving memory\" OR \"funeral home\" OR \"memorial service\"";
function isObituaryItem(item: Item) {
  const title = (item.title || "").toLowerCase();
  const url = (item.url || "").toLowerCase();
  // Check all text fields: summary, content, and the legacy description field
  const summary = (item.summary || "").toLowerCase();
  const content = (item.content || "").toLowerCase();
  const seoDesc = (item.seo_description || "").toLowerCase();
  const fullText = `${title} ${url} ${summary} ${content} ${seoDesc}`;

  // Strong signals in any field
  if (fullText.includes("obituar")) return true;
  if (fullText.includes("passed away")) return true;
  if (fullText.includes("in loving memory")) return true;
  if (fullText.includes("in memory of")) return true;
  if (fullText.includes("in memoriam")) return true;
  if (fullText.includes("survived by")) return true;
  if (fullText.includes("predeceased")) return true;
  if (fullText.includes("laid to rest")) return true;
  if (fullText.includes("celebration of life")) return true;
  if (fullText.includes("death notice")) return true;
  if (fullText.includes("funeral arrangements")) return true;
  if (fullText.includes("memorial service for")) return true;
  if (fullText.includes("graveside service")) return true;
  if (fullText.includes("condolences to the family")) return true;
  // URL-based signals (funeral home notice pages, obit directories)
  if (url.includes("/notice/") && (url.includes("funeral") || url.includes("dignit") || url.includes("legacy"))) return true;
  if (url.includes("funeralhome") || url.includes("funeral-home")) return true;
  return false;
}
const SPORTS_QUERY =
  "\"sports\" OR \"sport\" OR \"football\" OR \"basketball\" OR \"baseball\" OR \"soccer\" OR \"volleyball\" OR \"softball\" OR \"wrestling\" OR \"tennis\" OR \"golf\" OR \"track\" OR \"swimming\" OR \"lacrosse\" OR \"cross country\" OR \"cheerleading\" OR \"athletics\" OR \"game\" OR \"playoff\" OR \"tournament\" OR \"championship\" OR \"coach\" OR \"wildcats\" OR \"cardinals\" OR \"tigers\" OR \"bulldogs\" OR \"eagles\" OR \"Warriors\" OR \"hawks\"";
const routeScrollPositions = new Map<string, number>();
const FEED_SCROLL_STORAGE_PREFIX = "feed_scroll_pos:";
const routeFeedSnapshots = new Map<string, RouteFeedSnapshot>();
const FEED_STATE_STORAGE_PREFIX = "feed_state:";
const FEED_STATE_MAX_AGE_MS = 6 * 60 * 60 * 1000;
type ThemeMode = "light" | "dark";

type RouteFeedSnapshot = {
  items: Item[];
  cursor: string | null;
  meta?: Record<string, unknown>;
  savedAt: number;
};

type RouteFeedSnapshotInput = {
  items: Item[];
  cursor: string | null;
  meta?: Record<string, unknown>;
};

function compactSnapshotItem(item: Item): Item {
  return {
    id: item.id,
    title: item.title,
    url: item.url,
    author: item.author ?? null,
    region_scope: item.region_scope,
    published_at: item.published_at ?? null,
    summary: item.summary ? String(item.summary).slice(0, 2400) : null,
    seo_description: item.seo_description ?? null,
    content: item.content ? String(item.content).slice(0, 1200) : null,
    image_url: item.image_url ?? null,
    states: Array.isArray(item.states) ? item.states : [],
    counties: Array.isArray(item.counties) ? item.counties : []
  };
}

function parseRouteFeedSnapshot(raw: unknown): RouteFeedSnapshot | null {
  if (!raw || typeof raw !== "object") return null;
  const row = raw as Record<string, unknown>;
  if (!Array.isArray(row.items)) return null;
  const cursor = row.cursor == null ? null : String(row.cursor);
  const savedAt = Number(row.savedAt);
  if (!Number.isFinite(savedAt) || savedAt <= 0) return null;
  if (Date.now() - savedAt > FEED_STATE_MAX_AGE_MS) return null;
  const meta = row.meta && typeof row.meta === "object" ? (row.meta as Record<string, unknown>) : undefined;
  return {
    items: row.items as Item[],
    cursor,
    meta,
    savedAt
  };
}

function persistRouteFeedSnapshot(routeKey: string, input: RouteFeedSnapshotInput) {
  const snapshot: RouteFeedSnapshot = {
    items: input.items.map(compactSnapshotItem),
    cursor: input.cursor ?? null,
    meta: input.meta,
    savedAt: Date.now()
  };
  routeFeedSnapshots.set(routeKey, snapshot);
  try {
    sessionStorage.setItem(`${FEED_STATE_STORAGE_PREFIX}${routeKey}`, JSON.stringify(snapshot));
  } catch {
    // ignore
  }
}

function readRouteFeedSnapshot(routeKey: string): RouteFeedSnapshot | null {
  const inMemory = parseRouteFeedSnapshot(routeFeedSnapshots.get(routeKey));
  if (inMemory) return inMemory;
  try {
    const raw = sessionStorage.getItem(`${FEED_STATE_STORAGE_PREFIX}${routeKey}`);
    if (!raw) return null;
    const parsed = parseRouteFeedSnapshot(JSON.parse(raw));
    if (!parsed) {
      sessionStorage.removeItem(`${FEED_STATE_STORAGE_PREFIX}${routeKey}`);
      return null;
    }
    routeFeedSnapshots.set(routeKey, parsed);
    return parsed;
  } catch {
    return null;
  }
}

function persistRouteScroll(routeKey: string, scrollTop: number) {
  routeScrollPositions.set(routeKey, scrollTop);
  try {
    sessionStorage.setItem(`${FEED_SCROLL_STORAGE_PREFIX}${routeKey}`, String(scrollTop));
  } catch {
    // ignore
  }
}

function readRouteScroll(routeKey: string): number {
  const inMemory = routeScrollPositions.get(routeKey);
  if (typeof inMemory === "number" && Number.isFinite(inMemory)) return inMemory;
  try {
    const raw = sessionStorage.getItem(`${FEED_SCROLL_STORAGE_PREFIX}${routeKey}`);
    const parsed = Number(raw);
    if (Number.isFinite(parsed) && parsed >= 0) return parsed;
  } catch {
    // ignore
  }
  return 0;
}

function captureActiveContentScroll(routeKey: string) {
  if (typeof document === "undefined") return;
  const node = document.querySelector("main.content");
  const top =
    node instanceof HTMLElement
      ? node.scrollTop
      : typeof window !== "undefined"
        ? window.scrollY
        : 0;
  persistRouteScroll(routeKey, Math.max(0, top || 0));
}

function useOpenItemNavigation(getSnapshot?: () => RouteFeedSnapshotInput | null, snapshotKey?: string) {
  const nav = useNavigate();
  const loc = useLocation();
  return (id: string) => {
    const routeKey = snapshotKey || `${loc.pathname}${loc.search}`;
    const snapshot = getSnapshot?.() || null;
    if (snapshot) {
      persistRouteFeedSnapshot(routeKey, snapshot);
    }
    captureActiveContentScroll(routeKey);
    nav(`/item/${id}`);
  };
}

function getMyLocalCounty(): string {
  try {
    return (localStorage.getItem(LOCAL_PREF_KEY) || "").trim();
  } catch {
    return "";
  }
}

function setMyLocalCounty(county: string) {
  try {
    localStorage.setItem(LOCAL_PREF_KEY, county);
  } catch {
    // ignore
  }
}

function getSelectedCounties(): string[] {
  try {
    const raw = localStorage.getItem(SELECTED_COUNTIES_PREF_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];
    const all = new Set((kyCounties as { name: string }[]).map((c) => c.name));
    return parsed
      .map((x) => String(x || "").trim())
      .filter((x) => all.has(x));
  } catch {
    return [];
  }
}

function setSelectedCounties(counties: string[]) {
  try {
    localStorage.setItem(SELECTED_COUNTIES_PREF_KEY, JSON.stringify(counties));
    if (typeof window !== "undefined") {
      window.dispatchEvent(new Event(SELECTED_COUNTIES_CHANGED_EVENT));
    }
  } catch {
    // ignore
  }
}

function useSelectedCountyPreferences(): string[] {
  const [selected, setSelected] = useState<string[]>(() => getSelectedCounties());

  useEffect(() => {
    if (typeof window === "undefined") return;

    const refresh = () => setSelected(getSelectedCounties());
    const onStorage = (event: StorageEvent) => {
      if (!event.key || event.key === SELECTED_COUNTIES_PREF_KEY) {
        refresh();
      }
    };

    window.addEventListener("storage", onStorage);
    window.addEventListener(SELECTED_COUNTIES_CHANGED_EVENT, refresh);
    return () => {
      window.removeEventListener("storage", onStorage);
      window.removeEventListener(SELECTED_COUNTIES_CHANGED_EVENT, refresh);
    };
  }, []);

  return selected;
}

function getThemeMode(): ThemeMode {
  try {
    return localStorage.getItem(THEME_PREF_KEY) === "dark" ? "dark" : "light";
  } catch {
    return "light";
  }
}

function setThemeMode(mode: ThemeMode) {
  try {
    localStorage.setItem(THEME_PREF_KEY, mode);
  } catch {
    // ignore
  }
}

function getOwnerAdminToken(): string {
  try {
    return (localStorage.getItem(OWNER_ADMIN_TOKEN_KEY) || "").trim();
  } catch {
    return "";
  }
}

function setOwnerAdminToken(token: string) {
  try {
    const normalized = token.trim();
    if (normalized) {
      localStorage.setItem(OWNER_ADMIN_TOKEN_KEY, normalized);
    } else {
      localStorage.removeItem(OWNER_ADMIN_TOKEN_KEY);
    }
  } catch {
    // ignore
  }
}

function applyThemeMode(mode: ThemeMode) {
  if (typeof document === "undefined") return;
  document.documentElement.setAttribute("data-theme", mode);
}

function countyPageSaveId(slug: string) {
  return `county-page:${slug}`;
}

function countyPageUrl(slug: string) {
  if (typeof window === "undefined") return `/news/${slug}`;
  return new URL(`/news/${slug}`, window.location.origin).toString();
}

export default function App() {
  const [themeMode, setThemeModeState] = useState<ThemeMode>(() => getThemeMode());
  const siteUrl = getSiteUrl();

  const organizationSchema: SeoJsonLd = {
    "@context": "https://schema.org",
    "@type": "Organization",
    name: "Local KY News",
    url: siteUrl,
    // use the project logo so that search engines and social previews
    // see the most up‑to‑date branding
    logo: absoluteUrl("/logo.png")
  };

  useEffect(() => {
    applyThemeMode(themeMode);
    setThemeMode(themeMode);
  }, [themeMode]);

  return (
    <>
      <StructuredData jsonLd={organizationSchema} />
      {/* SSR priority: county listing pages and article pages should be rendered server-side first in any SSR/SSG migration. */}
      <Routes>
        <Route path="/" element={<Navigate to="/today" replace />} />
        <Route path="/today" element={<TodayScreen />} />
        <Route path="/national" element={<NationalScreen />} />
        <Route path="/sports" element={<SportsScreen />} />
        <Route path="/open" element={<ExternalWebViewScreen />} />
        <Route path="/weather" element={<WeatherScreen />} />
        <Route path="/schools" element={<SchoolsScreen />} />
        <Route path="/obituaries" element={<ObituariesScreen />} />
        <Route path="/lost-found" element={<LostFoundScreen />} />
        <Route path="/my-local" element={<MyLocalScreen />} />
        <Route path="/local" element={<Navigate to="/my-local" replace />} />
        <Route path="/news/:countySlug" element={<CountyPage />} />
        <Route path="/read-later" element={<ReadLaterScreen />} />
        <Route path="/search" element={<SearchScreen />} />
        <Route path="/preferences" element={<Navigate to="/settings" replace />} />
        <Route path={OWNER_ADMIN_ROUTE} element={<OwnerAdminScreen />} />
        <Route
          path="/settings"
          element={
            <SettingsScreen
              themeMode={themeMode}
              onToggleDarkTheme={(enabled) => setThemeModeState(enabled ? "dark" : "light")}
            />
          }
        />
        <Route path="/local-settings" element={<Navigate to="/my-local" replace />} />
        <Route path="/feed/:feedId" element={<FeedScreen />} />
        <Route path="/item/:id" element={<Reader />} />
        <Route path="*" element={<NotFoundScreen />} />
      </Routes>
    </>
  );
}

/** Shell: topbar + drawer + bottom nav */
function AppShell({
  title,
  children,
  seo
}: {
  title: string;
  children: React.ReactNode;
  seo?: {
    title?: string;
    description?: string;
    path?: string;
    url?: string;
    type?: "website" | "article";
    image?: string;
    publishedTime?: string;
    robots?: string;
    jsonLd?: SeoJsonLd | SeoJsonLd[];
  };
}) {
  const nav = useNavigate();
  const loc = useLocation();

  const [drawerOpen, setDrawerOpen] = useState(false);
  const contentRef = useRef<HTMLElement | null>(null);
  const routeKey = `${loc.pathname}${loc.search}`;

  const active = (path: string) => loc.pathname === path || loc.pathname.startsWith(path + "/");
  const onTodayView = loc.pathname === "/today";
  const onLocalView = active("/my-local") || loc.pathname.startsWith("/news/");
  const seoTitle = seo?.title || `${title} — Local KY News`;
  const seoDescription = seo?.description || `${title} coverage from across Kentucky.`;

  useEffect(() => {
    setDrawerOpen(false);
  }, [loc.pathname, loc.search]);

  useEffect(() => {
    const node = contentRef.current;
    if (!node) return;
    const target = readRouteScroll(routeKey);
    if (target <= 0) {
      node.scrollTop = 0;
      return;
    }

    let cancelled = false;

    const tryScroll = () => {
      if (cancelled) return;
      node.scrollTop = target;
    };

    // Attempt immediately
    tryScroll();

    // Re-attempt whenever the DOM inside the scroll container changes (handles async data loading).
    // We use MutationObserver (not ResizeObserver) because the scroll container has a fixed height
    // set by flex layout — its element dimensions don't change when children are added, only its
    // scrollHeight does. MutationObserver fires on any child DOM mutation so scroll is reliably
    // restored once items have actually rendered.
    let mo: MutationObserver | null = null;
    if (typeof MutationObserver !== "undefined") {
      mo = new MutationObserver(() => {
        if (!cancelled && node.scrollTop < target - 2) tryScroll();
      });
      mo.observe(node, { childList: true, subtree: true });
    }

    // Final fallback safety net after 5 seconds
    const fallbackTimer = window.setTimeout(() => { if (!cancelled) tryScroll(); }, 5000);

    return () => {
      cancelled = true;
      mo?.disconnect();
      window.clearTimeout(fallbackTimer);
    };
  }, [routeKey]);

  useEffect(() => {
    const node = contentRef.current;
    if (!node) return;

    const save = () => {
      persistRouteScroll(routeKey, node.scrollTop);
    };

    node.addEventListener("scroll", save, { passive: true });
    save();
    return () => {
      save();
      node.removeEventListener("scroll", save);
    };
  }, [routeKey]);

  function open(path: string) {
    setDrawerOpen(false);
    nav(path);
  }

  return (
    <div className="app">
      <SeoMeta
        title={seoTitle}
        description={seoDescription}
        path={seo?.path || `${loc.pathname}${loc.search}`}
        url={seo?.url}
        type={seo?.type || "website"}
        image={seo?.image}
        publishedTime={seo?.publishedTime}
        robots={seo?.robots}
        jsonLd={seo?.jsonLd}
      />
      <header className="topbar">
        <button className="iconBtn topMenuBtn" aria-label="Menu" onClick={() => setDrawerOpen(true)}>
          <IconMenu className="navIcon" />
        </button>

        <div className="title brandTitle">
          <img className="brandLogo" src="/logo.png" alt="Local KY News" loading="eager" decoding="async" />
          <span>{title}</span>
        </div>
        <div className="topbarSpacer" />
      </header>

      {drawerOpen ? (
        <>
          <div className="drawerOverlay" onClick={() => setDrawerOpen(false)} />
          <div className="drawer" role="dialog" aria-label="Navigation">
            <div className="drawerHeader">
              Local KY News
              <div style={{ marginLeft: "auto" }}>
                <button className="iconBtn closeBtn" onClick={() => setDrawerOpen(false)} aria-label="Close">
                  ✕
                </button>
              </div>
            </div>

            <div className="drawerList drawerNav">
              <div
                className={"drawerItem " + (onTodayView ? "active" : "")}
                onClick={() => open("/today")}
              >
                <div className="drawerLabel">Home</div>
              </div>

              <div
                className={"drawerItem " + (active("/search") ? "active" : "")}
                onClick={() => open("/search")}
              >
                <div className="drawerLabel">Search</div>
              </div>

              <div
                className={"drawerItem " + (onLocalView ? "active" : "")}
                onClick={() => open("/my-local")}
              >
                <div className="drawerLabel">Local News</div>
              </div>

              <div
                className={"drawerItem " + (active("/read-later") ? "active" : "")}
                onClick={() => open("/read-later")}
              >
                <div className="drawerLabel">Saved</div>
              </div>

              <div
                className={"drawerItem " + (active("/settings") ? "active" : "")}
                onClick={() => open("/settings")}
              >
                <div className="drawerLabel">Settings</div>
              </div>
            </div>
          </div>
        </>
      ) : null}

      <div className="appFrame">
        <main className="content" ref={contentRef}>{children}</main>
      </div>

      <div className="bottomNav">
        <button
          className={"navBtn " + (onTodayView ? "active" : "")}
          onClick={() => nav("/today")}
          aria-label="Home"
        >
          <IconToday className="navIcon" />
          <span className="navLabel">Home</span>
        </button>
        <button
          className={"navBtn " + (active("/search") ? "active" : "")}
          onClick={() => nav("/search")}
          aria-label="Search"
        >
          <IconSearch className="navIcon" />
          <span className="navLabel">Search</span>
        </button>
        <button
          className={"navBtn " + (onLocalView ? "active" : "")}
          onClick={() => nav("/my-local")}
          aria-label="Local News"
        >
          <IconMapPin className="navIcon" />
          <span className="navLabel">Local</span>
        </button>
        <button
          className={"navBtn " + (active("/read-later") ? "active" : "")}
          onClick={() => nav("/read-later")}
          aria-label="Saved"
        >
          <IconHeart className="navIcon" />
          <span className="navLabel">Saved</span>
        </button>
        <button className={"navBtn " + (active("/settings") ? "active" : "")} onClick={() => nav("/settings")} aria-label="Settings">
          <IconSettings className="navIcon" />
          <span className="navLabel">Settings</span>
        </button>
      </div>
    </div>
  );
}

function CoverageTabs() {
  const nav = useNavigate();
  const loc = useLocation();
  const isActive = (path: string) => loc.pathname === path;

  return (
    <div className="tabs">
      {COVERAGE_TABS.map((tab) => (
        <button
          key={tab.id}
          className={"tab " + (isActive(tab.path) ? "active" : "")}
          onClick={() => nav(tab.path)}
          type="button"
        >
          {tab.label}
        </button>
      ))}
    </div>
  );
}

function ItemCard({ item, onOpen, showImage = true }: { item: Item; onOpen: () => void; showImage?: boolean }) {
  const [readMap, setReadMap] = useState<Map<string, boolean>>(new Map());
  const [saved, setSaved] = useState(false);
  const [imageFailed, setImageFailed] = useState(false);

  useEffect(() => {
    let mounted = true;
    (async () => {
      const map = await bulkIsRead([item.id]);
      const s = await isSaved(item.id);
      if (!mounted) return;
      setReadMap(map);
      setSaved(s);
    })();
    return () => {
      mounted = false;
    };
  }, [item.id]);
  useEffect(() => {
    setImageFailed(false);
  }, [item.id, item.image_url]);

  const unread = !readMap.get(item.id);
  const src = sourceFromUrl(item.url);
  const regionChip = item.region_scope === "national" ? "National" : "Kentucky";
  const stateChips = Array.from(new Set((item.states || []).map((s) => s.toUpperCase()))).filter(
    (s) => !(item.region_scope === "ky" && s === "KY")
  );

  async function openAndMark() {
    await markRead(item.id);
    setReadMap(new Map([[item.id, true]]));
    onOpen();
  }

  async function save(e: React.MouseEvent) {
    e.stopPropagation();
    const next = await toggleSaved({
      id: item.id,
      title: item.title,
      url: item.url,
      author: item.author ?? null,
      published_at: item.published_at ?? null,
      summary: item.summary ?? null,
      content: item.content ?? null,
      image_url: item.image_url ?? null,
      source: src
    });
    setSaved(next);
  }

  return (
    <div
      className={"card postCard " + (unread ? "unread" : "")}
      onClick={openAndMark}
      onKeyDown={(e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          void openAndMark();
        }
      }}
      role="button"
      tabIndex={0}
    >
      {showImage && item.image_url && !imageFailed ? (
        <img
          className="postImage"
          src={item.image_url}
          alt=""
          loading="lazy"
          fetchPriority="low"
          decoding="async"
          width={640}
          height={360}
          onError={() => setImageFailed(true)}
        />
      ) : (
        <div className="postImage postImageFallback">
          <div className="postImageFallbackText">{(src || "Local News").toUpperCase()}</div>
        </div>
      )}
      <div className="postBody">
        <div className="source">{src || "Source"}</div>
        <div className="chips">
          {item.region_scope ? <span className="chip">{regionChip}</span> : null}
          {stateChips.map((s) => (
            <span key={s} className="chip">{s}</span>
          ))}
          {(item.counties || []).slice(0, 3).map((c) => (
            <span key={c} className="chip">{c}</span>
          ))}
          {item.counties && item.counties.length > 3 ? <span className="chip">+{item.counties.length - 3}</span> : null}
        </div>
        <h3 className="postTitle">{item.title}</h3>
        <p className="postSummary">{summarySnippet(item)}</p>
        <div className="postFooter">
          <span className="postTime" title={item.published_at || ""}>{formatFromNow(item.published_at)}</span>
          <div className="postActions">
            <button className={"iconAction " + (saved ? "active" : "")} onClick={save} aria-label={saved ? "Saved" : "Save article"}>
              <IconHeart className="postActionIcon" />
            </button>
            <button
              className="iconAction"
              onClick={(e) => {
                e.stopPropagation();
                window.open(item.url, "_blank", "noopener,noreferrer");
              }}
              aria-label="Open source"
            >
              <IconShare className="postActionIcon" />
            </button>
          </div>
        </div>
        <div className="meta">
          <span>{formatPublishedDate(item.published_at)}</span>
        </div>
      </div>
    </div>
  );
}

function FeaturedItemCard({
  item,
  onOpen,
  prioritizeImage = true
}: {
  item: Item;
  onOpen: () => void;
  prioritizeImage?: boolean;
}) {
  const [readMap, setReadMap] = useState<Map<string, boolean>>(new Map());
  const [imageFailed, setImageFailed] = useState(false);

  useEffect(() => {
    let mounted = true;
    (async () => {
      const map = await bulkIsRead([item.id]);
      if (!mounted) return;
      setReadMap(map);
    })();
    return () => {
      mounted = false;
    };
  }, [item.id]);
  useEffect(() => {
    setImageFailed(false);
  }, [item.id, item.image_url]);

  const unread = !readMap.get(item.id);
  const source = sourceFromUrl(item.url) || "Top story";

  async function openAndMark() {
    await markRead(item.id);
    setReadMap(new Map([[item.id, true]]));
    onOpen();
  }

  return (
    <div
      className={"featuredCard " + (unread ? "unread" : "")}
      onClick={openAndMark}
      onKeyDown={(e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          void openAndMark();
        }
      }}
      role="button"
      tabIndex={0}
    >
      {item.image_url && !imageFailed ? (
        <img
          className="featuredImage"
          src={item.image_url}
          alt=""
          loading={prioritizeImage ? "eager" : "lazy"}
          fetchPriority={prioritizeImage ? "high" : "auto"}
          decoding="async"
          width={1280}
          height={720}
          onError={() => setImageFailed(true)}
        />
      ) : (
        <div className="featuredImage featuredFallback" />
      )}
      <div className="featuredOverlay" />
      <div className="featuredContent">
        <div className="featuredSource">{source}</div>
        <h2 className="featuredTitle">{item.title}</h2>
        <p className="featuredSummary">{summarySnippet(item, 28)}</p>
        <div className="featuredReadMore">Continue reading...</div>
      </div>
    </div>
  );
}

function StoryDeck({
  items,
  onOpen,
  emptyMessage = "No stories yet.",
  prioritizeFeaturedImage = true
}: {
  items: Item[];
  onOpen: (id: string) => void;
  emptyMessage?: string;
  prioritizeFeaturedImage?: boolean;
}) {
  if (!items.length) {
    return <div className="card emptyState">{emptyMessage}</div>;
  }

  const [featured, ...rest] = items;
  return (
    <>
      <FeaturedItemCard item={featured} onOpen={() => onOpen(featured.id)} prioritizeImage={prioritizeFeaturedImage} />
      {rest.length ? (
        <div className="postGrid">
          {rest.map((it, index) => (
            // All cards should render thumbnails when available.
            <ItemCard key={it.id} item={it} showImage={index < MAX_INLINE_CARD_IMAGES} onOpen={() => onOpen(it.id)} />
          ))}
        </div>
      ) : null}
    </>
  );
}

function InfinitePager({
  hasMore,
  loading,
  onLoadMore
}: {
  hasMore: boolean;
  loading: boolean;
  onLoadMore: () => void | Promise<void>;
}) {
  const ref = useRef<HTMLDivElement | null>(null);
  const onLoadRef = useRef(onLoadMore);

  useEffect(() => {
    onLoadRef.current = onLoadMore;
  }, [onLoadMore]);

  useEffect(() => {
    if (!hasMore || loading) return;
    const node = ref.current;
    if (!node) return;

    const observer = new IntersectionObserver(
      (entries) => {
        if (entries.some((entry) => entry.isIntersecting)) {
          void onLoadRef.current();
        }
      },
      { rootMargin: "480px 0px" }
    );

    observer.observe(node);
    return () => observer.disconnect();
  }, [hasMore, loading]);

  if (!hasMore) {
    return <div className="listStatus">No more stories</div>;
  }

  return (
    <div ref={ref} className="listStatus">
      {loading ? "Loading more..." : "Scroll for more"}
    </div>
  );
}

function TodayScreen() {
  const nav = useNavigate();
  const loc = useLocation();
  const q = new URLSearchParams(loc.search);
  const state = (q.get("state") || "").toUpperCase();
  const county = q.get("county") || "";
  const selectedCountyPrefs = useSelectedCountyPreferences();
  const selectedCounties = state || county ? [] : selectedCountyPrefs;
  const countyFilter = county ? [county] : selectedCounties;
  const routeStateKey = useMemo(
    () =>
      `${loc.pathname}${loc.search}|state=${state}|county=${county}|counties=${[...selectedCounties].sort().join(",")}`,
    [loc.pathname, loc.search, state, county, selectedCounties]
  );
  const restoredFeed = useMemo(() => readRouteFeedSnapshot(routeStateKey), [routeStateKey]);

  const [items, setItems] = useState<Item[]>(() => restoredFeed?.items || []);
  const [cursor, setCursor] = useState<string | null>(() => restoredFeed?.cursor ?? null);
  const [loading, setLoading] = useState<boolean>(() => !(restoredFeed?.items?.length));
  const [statewideFallback, setStatewideFallback] = useState<boolean>(
    () => Boolean((restoredFeed?.meta as Record<string, unknown> | undefined)?.statewideFallback)
  );
  const openItem = useOpenItemNavigation(
    () => ({
      items,
      cursor,
      meta: { statewideFallback }
    }),
    routeStateKey
  );
  const websiteSchema: SeoJsonLd = {
    "@context": "https://schema.org",
    "@type": "WebSite",
    name: "Local KY News",
    url: absoluteUrl("/"),
    potentialAction: {
      "@type": "SearchAction",
      target: `${getSiteUrl()}/search?q={search_term_string}`,
      "query-input": "required name=search_term_string"
    }
  };

  useEffect(() => {
    let cancelled = false;
    (async () => {
      const cached = readRouteFeedSnapshot(routeStateKey);
      if (cached?.items?.length) {
        if (cancelled) return;
        setItems(cached.items);
        setCursor(cached.cursor ?? null);
        setStatewideFallback(Boolean((cached.meta as Record<string, unknown> | undefined)?.statewideFallback));
        setLoading(false);
        return;
      }
      setLoading(true);
      try {
        const primary = await getItems({
          state: state || undefined,
          county: county || undefined,
          counties: !county ? selectedCounties : undefined,
          hours: TODAY_LOOKBACK_HOURS,
          limit: FEED_PAGE_SIZE
        });

        if (cancelled) return;
        const shouldFallback = !state && !county && selectedCounties.length > 0 && !primary.items.length;

        if (shouldFallback) {
          const fallback = await getItems({
            scope: "ky",
            hours: TODAY_LOOKBACK_HOURS,
            limit: FEED_PAGE_SIZE
          });
          if (cancelled) return;
          setItems(fallback.items);
          setCursor(fallback.nextCursor);
          setStatewideFallback(true);
        } else {
          setItems(primary.items);
          setCursor(primary.nextCursor);
          setStatewideFallback(false);
        }
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [state, county, selectedCounties, routeStateKey]);

  async function loadMore() {
    if (!cursor || loading) return;
    setLoading(true);
    try {
      const res = statewideFallback
        ? await getItems({
            scope: "ky",
            hours: TODAY_LOOKBACK_HOURS,
            cursor,
            limit: FEED_PAGE_SIZE
          })
        : await getItems({
            state: state || undefined,
            county: county || undefined,
            counties: !county ? selectedCounties : undefined,
            hours: TODAY_LOOKBACK_HOURS,
            cursor,
            limit: FEED_PAGE_SIZE
          });
      setItems((prev) => {
        const seenUrls = new Set(prev.map((i) => i.url));
        return [...prev, ...res.items.filter((i) => !seenUrls.has(i.url))];
      });
      setCursor(res.nextCursor);
    } finally {
      setLoading(false);
    }
  }

  const locationLabel = county
    ? `${county}, KY`
    : state === "KY"
      ? "Kentucky"
      : countyFilter.length
        ? `My Counties (${countyFilter.length})`
        : "";

  return (
    <AppShell
      title="Local KY News"
      seo={{
        title: "Kentucky News — Local KY News",
        description: "Your source for local Kentucky news, county by county.",
        path: "/",
        jsonLd: websiteSchema
      }}
    >
      <CoverageTabs />

      <div className="section">
        {statewideFallback ? (
          <div className="locationBanner">No recent stories in your selected counties. Showing statewide coverage.</div>
        ) : null}
        {locationLabel ? <div className="locationBanner">Coverage: {locationLabel}</div> : null}

        {loading && !items.length ? (
          <div className="card emptyState">Loading stories...</div>
        ) : (
          <>
            <StoryDeck
              items={items}
              onOpen={openItem}
              emptyMessage="No stories right now."
            />
            {items.length ? <InfinitePager hasMore={Boolean(cursor)} loading={loading} onLoadMore={loadMore} /> : null}
          </>
        )}
      </div>
    </AppShell>
  );
}

function NationalScreen() {
  const nav = useNavigate();
  const loc = useLocation();
  const routeStateKey = `${loc.pathname}${loc.search}`;
  const restoredFeed = useMemo(() => readRouteFeedSnapshot(routeStateKey), [routeStateKey]);
  const [items, setItems] = useState<Item[]>(() => restoredFeed?.items || []);
  const [cursor, setCursor] = useState<string | null>(() => restoredFeed?.cursor ?? null);
  const [loading, setLoading] = useState<boolean>(() => !(restoredFeed?.items?.length));
  const openItem = useOpenItemNavigation(
    () => ({
      items,
      cursor
    }),
    routeStateKey
  );

  useEffect(() => {
    let cancelled = false;
    (async () => {
      const cached = readRouteFeedSnapshot(routeStateKey);
      if (cached?.items?.length) {
        if (cancelled) return;
        setItems(cached.items);
        setCursor(cached.cursor ?? null);
        setLoading(false);
        return;
      }
      setLoading(true);
      try {
        // scope:"all" shows every article (both KY and national) — not just national-scoped feeds.
        const res = await getItems({ scope: "all", includeAll: true, hours: 24 * 30, limit: FEED_PAGE_SIZE });
        if (cancelled) return;
        setItems(res.items);
        setCursor(res.nextCursor);
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [routeStateKey]);

  async function loadMore() {
    if (!cursor || loading) return;
    setLoading(true);
    try {
      // scope:"all" shows every article (both KY and national).
      const res = await getItems({ scope: "all", includeAll: true, hours: 24 * 30, cursor, limit: FEED_PAGE_SIZE });
      setItems((prev) => mergeUniqueItems(prev, res.items));
      setCursor(res.nextCursor);
    } finally {
      setLoading(false);
    }
  }

  return (
    <AppShell title="National">
      <CoverageTabs />
      <div className="section">
        {loading && !items.length ? (
          <div className="card emptyState">Loading stories...</div>
        ) : (
          <>
            <StoryDeck items={items} onOpen={openItem} />
            {items.length ? <InfinitePager hasMore={Boolean(cursor)} loading={loading} onLoadMore={loadMore} /> : null}
          </>
        )}
      </div>
    </AppShell>
  );
}

function SportsScreen() {
  const nav = useNavigate();
  const loc = useLocation();
  const selectedCounties = useSelectedCountyPreferences();
  const routeStateKey = useMemo(
    () => `${loc.pathname}${loc.search}|counties=${[...selectedCounties].sort().join(",")}`,
    [loc.pathname, loc.search, selectedCounties]
  );
  const restoredFeed = useMemo(() => readRouteFeedSnapshot(routeStateKey), [routeStateKey]);
  const [items, setItems] = useState<Item[]>(() => restoredFeed?.items || []);
  const [cursor, setCursor] = useState<string | null>(() => restoredFeed?.cursor ?? null);
  const [loading, setLoading] = useState<boolean>(() => !(restoredFeed?.items?.length));
  const openItem = useOpenItemNavigation(
    () => ({
      items,
      cursor
    }),
    routeStateKey
  );

  useEffect(() => {
    let cancelled = false;
    (async () => {
      const cached = readRouteFeedSnapshot(routeStateKey);
      if (cached?.items?.length) {
        if (cancelled) return;
        setItems(cached.items);
        setCursor(cached.cursor ?? null);
        setLoading(false);
        return;
      }
      setLoading(true);
      try {
        const res = await searchItems(SPORTS_QUERY, {
          scope: selectedCounties.length ? "ky" : "all",
          state: selectedCounties.length ? "KY" : undefined,
          counties: selectedCounties.length ? selectedCounties : undefined,
          hours: SPORTS_LOOKBACK_HOURS,
          limit: FEED_PAGE_SIZE
        });
        if (cancelled) return;
        setItems(res.items);
        setCursor(res.nextCursor);
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [selectedCounties, routeStateKey]);

  async function loadMore() {
    if (!cursor || loading) return;
    setLoading(true);
    try {
      const res = await searchItems(SPORTS_QUERY, {
        scope: selectedCounties.length ? "ky" : "all",
        state: selectedCounties.length ? "KY" : undefined,
        counties: selectedCounties.length ? selectedCounties : undefined,
        hours: SPORTS_LOOKBACK_HOURS,
        cursor,
        limit: FEED_PAGE_SIZE
      });
      setItems((prev) => {
        const seenUrls = new Set(prev.map((i) => i.url));
        return [...prev, ...res.items.filter((i) => !seenUrls.has(i.url))];
      });
      setCursor(res.nextCursor);
    } finally {
      setLoading(false);
    }
  }

  return (
    <AppShell title="Sports">
      <CoverageTabs />
      <div className="section">
        {loading && !items.length ? (
          <div className="card emptyState">Loading sports stories...</div>
        ) : (
          <>
            <StoryDeck items={items} onOpen={openItem} emptyMessage="No sports stories right now." />
            {items.length ? <InfinitePager hasMore={Boolean(cursor)} loading={loading} onLoadMore={loadMore} /> : null}
          </>
        )}
      </div>
    </AppShell>
  );
}

function FeedScreen() {
  const nav = useNavigate();
  const loc = useLocation();
  const { feedId } = useParams();
  const routeStateKey = `${loc.pathname}${loc.search}`;
  const restoredFeed = useMemo(() => readRouteFeedSnapshot(routeStateKey), [routeStateKey]);
  const [feed, setFeed] = useState<Feed | null>(null);
  const [items, setItems] = useState<Item[]>(() => restoredFeed?.items || []);
  const [cursor, setCursor] = useState<string | null>(() => restoredFeed?.cursor ?? null);
  const [loading, setLoading] = useState<boolean>(() => !(restoredFeed?.items?.length));
  const openItem = useOpenItemNavigation(
    () => ({
      items,
      cursor
    }),
    routeStateKey
  );

  useEffect(() => {
    let cancelled = false;
    (async () => {
      const cached = readRouteFeedSnapshot(routeStateKey);
      if (cached?.items?.length) {
        if (cancelled) return;
        setItems(cached.items);
        setCursor(cached.cursor ?? null);
        setLoading(false);
        return;
      }
      setLoading(true);
      const feeds = await getFeeds().catch(() => []);
      const f = feeds.find((x) => x.id === feedId) || null;
      if (!cancelled) setFeed(f);

      try {
        const res = await getItems({ feedId: feedId || undefined, limit: FEED_PAGE_SIZE });
        if (cancelled) return;
        setItems(res.items);
        setCursor(res.nextCursor);
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [feedId, routeStateKey]);

  async function loadMore() {
    if (!cursor || loading) return;
    setLoading(true);
    try {
      const res = await getItems({ feedId: feedId || undefined, cursor, limit: FEED_PAGE_SIZE });
      setItems((prev) => {
        const seenUrls = new Set(prev.map((i) => i.url));
        return [...prev, ...res.items.filter((i) => !seenUrls.has(i.url))];
      });
      setCursor(res.nextCursor);
    } finally {
      setLoading(false);
    }
  }

  return (
    <AppShell title={feed?.name || "Feed"}>
      <div className="section">
        {loading && !items.length ? (
          <div className="card emptyState">Loading stories...</div>
        ) : (
          <>
            <StoryDeck items={items} onOpen={openItem} />
            {items.length ? <InfinitePager hasMore={Boolean(cursor)} loading={loading} onLoadMore={loadMore} /> : null}
          </>
        )}
      </div>
    </AppShell>
  );
}

function ExternalWebViewScreen() {
  const nav = useNavigate();
  const loc = useLocation();
  const q = new URLSearchParams(loc.search);
  const rawUrl = (q.get("url") || "").trim();
  const [loading, setLoading] = useState(false);
  const [proxyHtml, setProxyHtml] = useState("");
  const [proxyTitle, setProxyTitle] = useState("");
  const [proxyError, setProxyError] = useState("");

  let frameUrl = "";
  try {
    const parsed = new URL(rawUrl);
    if (parsed.protocol === "http:" || parsed.protocol === "https:") {
      frameUrl = parsed.toString();
    }
  } catch {
    frameUrl = "";
  }

  useEffect(() => {
    let cancelled = false;
    if (!frameUrl) return;
    (async () => {
      setLoading(true);
      setProxyError("");
      setProxyHtml("");
      try {
        const res = await getOpenProxy(frameUrl);
        if (cancelled) return;
        setProxyHtml(res.html || "");
        setProxyTitle(res.title || "");
      } catch (err: any) {
        if (!cancelled) setProxyError(String(err?.message || err));
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [frameUrl]);

  return (
    <AppShell title="Original">
      <div className="section">
        {!frameUrl ? (
          <div className="card" style={{ padding: 14 }}>
            <div style={{ fontWeight: 900, marginBottom: 8 }}>Invalid article URL</div>
            <button className="btn" onClick={() => nav(-1)}>
              Back
            </button>
          </div>
        ) : (
          <div className="card webviewCard">
            <div className="webviewTop">
              <div className="webviewActions">
                <button className="btn" onClick={() => nav(-1)}>
                  Back
                </button>
                <a className="btn" href={frameUrl} target="_blank" rel="noreferrer">
                  Open Original
                </a>
              </div>
            </div>
            {loading ? <div className="card emptyState">Loading article in app...</div> : null}
            {!loading && proxyHtml ? (
              <>
                {proxyTitle ? <div className="webviewHint">In-app view: {proxyTitle}</div> : null}
                <iframe
                  title="Original article"
                  srcDoc={proxyHtml}
                  className="webviewFrame"
                  referrerPolicy="no-referrer"
                />
              </>
            ) : null}

            {!loading && !proxyHtml ? (
              <>
                <iframe title="Original article" src={frameUrl} className="webviewFrame" referrerPolicy="no-referrer" />
                <div className="webviewHint">
                  {proxyError
                    ? `Proxy view unavailable: ${proxyError}. Showing direct frame when possible.`
                    : 'Some publishers block embedded viewing. Use "Open Original" if this page does not load.'}
                </div>
              </>
            ) : null}
          </div>
        )}
      </div>
    </AppShell>
  );
}

function ReadLaterScreen() {
  const nav = useNavigate();
  const openItem = useOpenItemNavigation();
  const [saved, setSaved] = useState<Item[]>([]);
  const [loading, setLoading] = useState(true);
  const [reviewedCount, setReviewedCount] = useState(0);

  async function refresh() {
    setLoading(true);
    try {
      const rows = await listSavedItems(200);
      // Convert to Item shape
      const items: Item[] = rows.map((r) => ({
        id: r.id,
        title: r.title,
        url: r.url,
        author: r.author ?? null,
        published_at: r.published_at ?? null,
        summary: r.summary ?? null,
        content: r.content ?? null,
        image_url: r.image_url ?? null
      }));
      setSaved(items);
      const readMap = await bulkIsRead(items.map((x) => x.id));
      let reviewed = 0;
      for (const x of items) {
        if (readMap.get(x.id)) reviewed++;
      }
      setReviewedCount(reviewed);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    void refresh();
  }, []);

  async function markAllRead() {
    await Promise.all(saved.map((it) => markRead(it.id)));
    await refresh();
  }

  return (
    <AppShell title="Read Later">
      <div className="section">
        <div style={{ textAlign: "center", color: "var(--muted)", margin: "14px 0" }}>
          {loading ? "Loading…" : `You've reviewed ${reviewedCount} article${reviewedCount === 1 ? "" : "s"}`}
        </div>

        {loading ? (
          <div className="card emptyState">Loading saved stories...</div>
        ) : (
          <StoryDeck items={saved} onOpen={openItem} emptyMessage="No saved articles yet." />
        )}

        <button className="btn block" onClick={markAllRead} disabled={!saved.length}>
          Mark All as Read
        </button>
      </div>
    </AppShell>
  );
}

function SettingsScreen({
  themeMode,
  onToggleDarkTheme
}: {
  themeMode: ThemeMode;
  onToggleDarkTheme: (enabled: boolean) => void;
}) {
  const nav = useNavigate();
  const [selectedCounties, setSelectedCountiesState] = useState<string[]>(() => getSelectedCounties());
  const allCounties = useMemo(() => (kyCounties as { name: string }[]).map((c) => c.name), []);

  function toggleCounty(name: string) {
    setSelectedCountiesState((prev) => {
      const next = prev.includes(name) ? prev.filter((c) => c !== name) : [...prev, name];
      setSelectedCounties(next);
      return next;
    });
  }

  function clearCountyPrefs() {
    setSelectedCountiesState([]);
    setSelectedCounties([]);
  }

  return (
    <AppShell title="Settings">
      <div className="section">
        <div className="card prefCard">
          <div className="prefHeading">Appearance</div>
          <div className="prefRow themeRow">
            <div className="prefRowMeta">
              <div className="drawerLabel">Dark Mode</div>
              <div className="prefHint">Enable dark appearance</div>
            </div>
            <label className="themeSwitch" aria-label="Dark mode toggle">
              <input
                className="themeInput"
                type="checkbox"
                checked={themeMode === "dark"}
                onChange={(e) => onToggleDarkTheme(e.target.checked)}
              />
              <span className="themeSlider" />
            </label>
          </div>
        </div>

        <div className="card prefCard">
          <div className="prefHeading">Shortcuts</div>
          <div className="prefRow" onClick={() => nav("/my-local")}>
            <div className="prefRowMeta">
              <div className="drawerLabel">Local News</div>
              <div className="prefHint">Set your local county</div>
            </div>
          </div>
          <div className="prefRow" onClick={() => nav("/today")}>
            <div className="prefRowMeta">
              <div className="drawerLabel">Home Feed</div>
              <div className="prefHint">View Today with current filters</div>
            </div>
          </div>
          <div className="prefRow" onClick={() => nav("/read-later")}>
            <div className="drawerLabel">Saved Articles</div>
          </div>
        </div>

        <div className="card prefCard">
          <div className="prefHeading">County Feed Filters</div>
          <div className="prefHint" style={{ marginBottom: 10 }}>
            Select one or more counties. Home feed will show only matching county stories.
          </div>
          <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
            <button className="btn" onClick={clearCountyPrefs} disabled={!selectedCounties.length}>
              Clear Selection
            </button>
            <button className="btn" onClick={() => nav("/today")}>
              View Home Feed
            </button>
          </div>
          <div className="countyPills">
            {allCounties.map((name) => {
              const active = selectedCounties.includes(name);
              return (
                <button
                  key={name}
                  type="button"
                  className={"countyPill " + (active ? "active" : "")}
                  onClick={() => toggleCounty(name)}
                >
                  {name}
                </button>
              );
            })}
          </div>
        </div>
      </div>
    </AppShell>
  );
}

function MyLocalScreen() {
  const nav = useNavigate();
  const loc = useLocation();
  const [counts, setCounts] = useState<Record<string, number>>({});
  const [loadingCounties, setLoadingCounties] = useState(true);
  const [selected, setSelected] = useState(() => getMyLocalCounty());
  const pickerMode = useMemo(() => new URLSearchParams(loc.search).get("picker") === "1", [loc.search]);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      setLoadingCounties(true);
      try {
        const res = await getCounties({ state: "KY", hours: 0 });
        const map: Record<string, number> = {};
        for (const row of res.counties) map[row.county] = row.count;
        if (!cancelled) setCounts(map);
      } catch {
        if (!cancelled) setCounts({});
      } finally {
        if (!cancelled) setLoadingCounties(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, []);

  useEffect(() => {
    if (!selected || pickerMode) return;
    nav(`/news/${countyNameToSlug(selected)}`, { replace: true });
  }, [selected, pickerMode, nav]);

  const all = (kyCounties as { name: string }[]).map((c) => c.name);
  const selectedSlug = countyNameToSlug(selected);

  function choose(name: string) {
    setSelected(name);
    setMyLocalCounty(name);
    if (name) nav(`/news/${countyNameToSlug(name)}`);
  }

  return (
    <AppShell
      title="Local News"
      seo={{
        title: "Local Counties — Local KY News",
        description: "Explore local coverage for every Kentucky county.",
        path: pickerMode ? "/my-local?picker=1" : "/my-local"
      }}
    >
      <CoverageTabs />
      <div className="section">
        <div className="card" style={{ padding: 12 }}>
          <div style={{ fontSize: 13, opacity: 0.75, marginBottom: 8 }}>Select Local County</div>
          <select
            className="searchInput"
            value={selected}
            onChange={(e) => choose(e.target.value)}
          >
            <option value="">Select county...</option>
            {all.map((name) => (
              <option key={name} value={name}>
                {name}
              </option>
            ))}
          </select>
          {selected ? (
            <div style={{ marginTop: 8, fontSize: 12, color: "var(--muted)" }}>
              {loadingCounties ? "Loading count..." : `${counts[selected] ?? 0} local article(s) available`}
            </div>
          ) : null}
          {selectedSlug ? (
            <div style={{ marginTop: 10 }}>
              <button className="btn" type="button" onClick={() => nav(`/news/${selectedSlug}`)}>
                Open {selected} County News
              </button>
            </div>
          ) : null}
        </div>

        <div style={{ marginTop: 12 }}>
          {!selected ? <div className="card emptyState">Choose a county to open its dedicated local page.</div> : null}
        </div>
      </div>
    </AppShell>
  );
}

function CountyPage() {
  const nav = useNavigate();
  const loc = useLocation();
  const { countySlug = "" } = useParams();
  const routeStateKey = `${loc.pathname}${loc.search}`;
  const restoredFeed = useMemo(() => readRouteFeedSnapshot(routeStateKey), [routeStateKey]);
  const restoredMeta = restoredFeed?.meta as Record<string, unknown> | undefined;

  const countyName = useMemo(() => countySlugToName(countySlug), [countySlug]);
  const displayCountyName = useMemo(
    () => (countyName ? countyName : countySlugToDisplayName(countySlug)),
    [countyName, countySlug]
  );
  const canonicalSlug = useMemo(() => (countyName ? countyNameToSlug(countyName) : ""), [countyName]);

  const [items, setItems] = useState<Item[]>(() => restoredFeed?.items || []);
  const [cursor, setCursor] = useState<string | null>(() => restoredFeed?.cursor ?? null);
  const [loadingMore, setLoadingMore] = useState(false);
  const [statewideItems, setStatewideItems] = useState<Item[]>(() =>
    Array.isArray(restoredMeta?.statewideItems) ? (restoredMeta?.statewideItems as Item[]) : []
  );
  const [loading, setLoading] = useState<boolean>(() => !(restoredFeed?.items?.length));
  const [error, setError] = useState<string>(() => String(restoredMeta?.error || ""));
  const [saved, setSaved] = useState(false);
  const [shareMessage, setShareMessage] = useState("");
  const openItem = useOpenItemNavigation(
    () => ({
      items,
      cursor,
      meta: {
        statewideItems,
        error
      }
    }),
    routeStateKey
  );

  const pageTitle = `${displayCountyName} County, KY News — Local KY News`;
  const pageDescription = `The latest news from ${displayCountyName} County, Kentucky.`;
  const countyPath = `/news/${canonicalSlug || countySlug}`;
  const countySchema: SeoJsonLd = useMemo(
    () => ({
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      name: `${displayCountyName} County, KY News`,
      description: pageDescription,
      url: absoluteUrl(countyPath)
    }),
    [displayCountyName, pageDescription, countyPath]
  );

  useEffect(() => {
    if (!countyName || !canonicalSlug || canonicalSlug === countySlug) return;
    nav(`/news/${canonicalSlug}`, { replace: true });
  }, [countyName, canonicalSlug, countySlug, nav]);

  useEffect(() => {
    let mounted = true;
    (async () => {
      if (!canonicalSlug) {
        setSaved(false);
        return;
      }
      const next = await isSavedPage(countyPageSaveId(canonicalSlug));
      if (mounted) setSaved(next);
    })();
    return () => {
      mounted = false;
    };
  }, [canonicalSlug]);

  useEffect(() => {
    let cancelled = false;
    setShareMessage("");

    (async () => {
      const cached = readRouteFeedSnapshot(routeStateKey);
      if (cached?.items?.length) {
        if (cancelled) return;
        const meta = cached.meta as Record<string, unknown> | undefined;
        setItems(cached.items);
        setCursor(cached.cursor ?? null);
        setStatewideItems(Array.isArray(meta?.statewideItems) ? (meta?.statewideItems as Item[]) : []);
        setError(String(meta?.error || ""));
        setLoading(false);
        return;
      }
      setLoading(true);
      setError("");
      setItems([]);
      setCursor(null);
      setStatewideItems([]);

      try {
        if (!countyName) {
          setError("Unknown county. Showing statewide Kentucky coverage.");
          const fallback = await getItems({ scope: "ky", hours: 0, limit: FEED_PAGE_SIZE });
          if (cancelled) return;
          setStatewideItems(fallback.items.slice(0, MIN_COUNTY_STORIES));
          return;
        }

        setMyLocalCounty(countyName);

        const primary = await getItems({
          state: "KY",
          county: countyName,
          hours: 0,
          limit: COUNTY_PAGE_SIZE
        });
        if (cancelled) return;
        setItems(primary.items);
        setCursor(primary.nextCursor);
      } catch (err: any) {
        if (!cancelled) setError(String(err?.message || err));
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [countyName, countySlug, routeStateKey]);

  useEffect(() => {
    let cancelled = false;
    const shouldLoadFallback = !loading && !cursor && items.length < MIN_COUNTY_STORIES && countyName && !statewideItems.length;
    if (!shouldLoadFallback) return;

    (async () => {
      const fallback = await getItems({ scope: "ky", hours: 0, limit: FEED_PAGE_SIZE });
      if (cancelled) return;
      const needed = MIN_COUNTY_STORIES - items.length;
      const seen = new Set(items.map((item) => item.url));
      const fillers = fallback.items.filter((item) => !seen.has(item.url)).slice(0, needed);
      setStatewideItems(fillers);
    })();

    return () => {
      cancelled = true;
    };
  }, [loading, cursor, items, countyName, statewideItems.length]);

  async function loadMoreCountyStories() {
    if (!cursor || loadingMore) return;
    setLoadingMore(true);
    try {
      const res = await getItems({
        state: "KY",
        county: countyName || countySlug,
        hours: 0,
        cursor,
        limit: COUNTY_PAGE_SIZE
      });
      setItems((prev) => mergeUniqueItems(prev, res.items));
      setCursor(res.nextCursor);
    } finally {
      setLoadingMore(false);
    }
  }

  async function saveCountyPage() {
    if (!canonicalSlug) return;
    const next = await toggleSavedPage({
      id: countyPageSaveId(canonicalSlug),
      title: `${displayCountyName} County, KY News`,
      url: countyPageUrl(canonicalSlug),
      source: "county-page",
      countySlug: canonicalSlug
    });
    setSaved(next);
  }

  async function shareCountyPage() {
    if (!canonicalSlug || typeof window === "undefined") return;
    setShareMessage("");
    const url = countyPageUrl(canonicalSlug);

    try {
      if (navigator.share) {
        await navigator.share({
          title: pageTitle,
          text: pageTitle,
          url
        });
        return;
      }
    } catch (err: any) {
      if (String(err?.name || "") === "AbortError") return;
    }

    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(url);
        setShareMessage("Link copied.");
        return;
      }
    } catch {
      // ignore
    }

    setShareMessage("Share is unavailable on this device.");
  }

  return (
    <AppShell
      title={`${displayCountyName} County`}
      seo={{
        title: pageTitle,
        description: pageDescription,
        path: countyPath,
        jsonLd: countySchema
      }}
    >
      <CoverageTabs />
      <div className="section">
        <div className="card" style={{ padding: 12, marginBottom: 12 }}>
          <div
            style={{
              display: "flex",
              alignItems: "center",
              justifyContent: "space-between",
              gap: 10,
              flexWrap: "wrap"
            }}
          >
            <button className="btn" type="button" onClick={() => nav("/my-local?picker=1")}>
              ← All Counties
            </button>
            <div className="postActions">
              <button
                type="button"
                className={"iconAction " + (saved ? "active" : "")}
                onClick={saveCountyPage}
                disabled={!canonicalSlug}
                aria-label={saved ? "Saved county page" : "Save county page"}
              >
                <IconHeart className="postActionIcon" />
              </button>
              <button
                type="button"
                className="iconAction"
                onClick={shareCountyPage}
                disabled={!canonicalSlug}
                aria-label="Share county page"
              >
                <IconShare className="postActionIcon" />
              </button>
            </div>
          </div>

          <div style={{ marginTop: 10, fontSize: 12, opacity: 0.75 }}>County Coverage</div>
          <div style={{ marginTop: 6, fontSize: 24, fontWeight: 700 }}>{displayCountyName} County, KY</div>
          <div style={{ marginTop: 4, color: "var(--muted)", fontSize: 13 }}>
            The latest local reporting from {displayCountyName} County.
          </div>
          {shareMessage ? <div className="meta" style={{ marginTop: 8 }}>{shareMessage}</div> : null}
        </div>

        {loading ? (
          <div className="card emptyState">Loading county stories...</div>
        ) : (
          <>
            {error ? (
              <div className="card" style={{ padding: 12, marginBottom: 12, color: "#b91c1c" }}>
                {error}
              </div>
            ) : null}

            <StoryDeck
              items={items}
              onOpen={openItem}
              emptyMessage={`No local stories in ${displayCountyName} County right now.`}
            />
            {items.length ? (
              <InfinitePager hasMore={Boolean(cursor)} loading={loadingMore} onLoadMore={loadMoreCountyStories} />
            ) : null}

            {!cursor && items.length < MIN_COUNTY_STORIES ? (
              <div style={{ marginTop: 14 }}>
                <div
                  style={{
                    marginBottom: 10,
                    paddingTop: 10,
                    borderTop: "1px solid var(--border)",
                    fontSize: 12,
                    fontWeight: 700,
                    letterSpacing: "0.06em",
                    textTransform: "uppercase",
                    color: "var(--muted)"
                  }}
                >
                  More from Kentucky
                </div>
                <StoryDeck
                  items={statewideItems}
                  onOpen={openItem}
                  prioritizeFeaturedImage={false}
                  emptyMessage="No additional statewide stories right now."
                />
              </div>
            ) : null}
          </>
        )}
      </div>
    </AppShell>
  );
}

function weatherGlyph(text: string) {
  const s = String(text || "").toLowerCase();
  if (s.includes("thunder")) return "⛈";
  if (s.includes("snow") || s.includes("sleet")) return "❄";
  if (s.includes("rain") || s.includes("shower")) return "🌧";
  if (s.includes("cloud")) return "☁";
  if (s.includes("fog") || s.includes("mist")) return "🌫";
  return "☀";
}

function WeatherScreen() {
  const nav = useNavigate();
  const [county, setCounty] = useState(() => getMyLocalCounty());
  const [forecast, setForecast] = useState<WeatherForecast | null>(null);
  const [alerts, setAlerts] = useState<WeatherAlert[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [weatherArticles, setWeatherArticles] = useState<Item[]>([]);
  const allCounties = useMemo(() => (kyCounties as { name: string }[]).map((c) => c.name), []);
  const openWeatherItem = useOpenItemNavigation(() => ({ items: weatherArticles, cursor: null }), `/weather-articles|${county}`);

  useEffect(() => {
    let cancelled = false;
    if (!county) {
      setLoading(false);
      return;
    }

    (async () => {
      setLoading(true);
      setError("");
      try {
        const [forecastRes, alertRes] = await Promise.all([
          getWeatherForecast(county, "KY"),
          getWeatherAlerts({ state: "KY", county })
        ]);
        if (cancelled) return;
        setForecast(forecastRes);
        setAlerts(alertRes.alerts || []);
      } catch (err: any) {
        if (!cancelled) setError(String(err?.message || err));
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [county]);

  useEffect(() => {
    if (!county) { setWeatherArticles([]); return; }
    let cancelled = false;
    (async () => {
      try {
        const catRes = await getItems({
          scope: "ky",
          category: "Kentucky - Weather",
          county,
          hours: 24 * 14,
          limit: 10
        });
        if (!cancelled) setWeatherArticles(catRes.items);
      } catch {
        if (!cancelled) setWeatherArticles([]);
      }
    })();
    return () => { cancelled = true; };
  }, [county]);

  return (
    <AppShell
      title="Weather"
      seo={{
        title: "Kentucky Weather — Local KY News",
        description: "Local weather forecasts for every Kentucky county.",
        path: "/weather"
      }}
    >
      <CoverageTabs />
      <div className="section">
        {!county ? (
          <div className="card" style={{ padding: 14 }}>
            <div style={{ fontWeight: 800, marginBottom: 10 }}>Choose your county first</div>
            <select
              className="searchInput"
              value={county}
              onChange={(e) => {
                const next = e.target.value;
                setCounty(next);
                if (next) setMyLocalCounty(next);
              }}
              style={{ marginBottom: 8 }}
            >
              <option value="">Select county...</option>
              {allCounties.map((name) => (
                <option key={name} value={name}>
                  {name}
                </option>
              ))}
            </select>
            <div style={{ color: "var(--muted)", fontSize: 12 }}>
              Weather updates stay on this page. Selecting a county does not redirect you.
            </div>
          </div>
        ) : null}

        {county ? (
          <div className="card weatherWidget" style={{ marginBottom: 12 }}>
            <div className="weatherTop">
              <div>
                <div className="weatherCounty">{county} County, KY</div>
                <div className="weatherSub">
                  {forecast?.periods?.[0]?.name || "Current"} {forecast?.periods?.[0]?.temperature ?? "--"}°
                  {forecast?.periods?.[0]?.temperatureUnit || "F"}
                </div>
              </div>
              <div className="weatherGlyph">{weatherGlyph(forecast?.periods?.[0]?.shortForecast || "")}</div>
            </div>
            <div className="weatherSummary">{forecast?.periods?.[0]?.shortForecast || "Forecast loading..."}</div>
            <div className="weatherActions">
              <select
                className="searchInput"
                value={county}
                onChange={(e) => {
                  const next = e.target.value;
                  setCounty(next);
                  if (next) setMyLocalCounty(next);
                }}
                style={{ maxWidth: 200 }}
              >
                {allCounties.map((name) => (
                  <option key={name} value={name}>
                    {name}
                  </option>
                ))}
              </select>
              <button className="btn" onClick={() => setCounty(getMyLocalCounty())}>
                Refresh
              </button>
            </div>
          </div>
        ) : null}

        {loading ? (
          <div className="card" style={{ padding: 14, color: "var(--muted)" }}>
            Loading weather...
          </div>
        ) : null}

        {error ? (
          <div className="card" style={{ padding: 14, color: "#b91c1c", marginBottom: 12 }}>
            {error}
          </div>
        ) : null}

        {county ? (
          <div className="card" style={{ padding: 10, marginBottom: 12, background: "#1e3a5f", borderColor: "#1e3a5f", display: "flex", alignItems: "center", justifyContent: "space-between", gap: 10 }}>
            <div style={{ color: "#fff", fontSize: 13, fontWeight: 700 }}>
              Sign up for official Kentucky emergency alerts (severe weather, Amber alerts, etc.)
            </div>
            <a
              href="https://goky.ky.gov"
              target="_blank"
              rel="noreferrer"
              style={{
                display: "inline-block",
                background: "#f59e0b",
                color: "#1a1a1a",
                fontWeight: 900,
                fontSize: 13,
                padding: "6px 14px",
                borderRadius: 6,
                textDecoration: "none",
                whiteSpace: "nowrap"
              }}
            >
              Activate Alerts →
            </a>
          </div>
        ) : null}

        {alerts.length ? (
          <div className="card" style={{ padding: 14, marginBottom: 12, borderColor: "#f59e0b" }}>
            <div style={{ fontWeight: 900, marginBottom: 10 }}>Active Alerts</div>
            {alerts.map((a) => (
              <div key={a.id} style={{ marginBottom: 12 }}>
                <div style={{ fontWeight: 800 }}>{a.headline}</div>
                <div style={{ fontSize: 13, color: "var(--muted)", marginBottom: 6 }}>
                  {a.event} • {a.severity}
                  {a.starts_at || a.ends_at ? (
                    <>
                      {" "}
                      •{" "}
                      {a.starts_at ? `Starts ${formatPublishedDate(a.starts_at)}` : "In effect now"}
                      {a.ends_at ? ` | Ends ${formatPublishedDate(a.ends_at)}` : ""}
                    </>
                  ) : null}
                </div>
                <div style={{ fontSize: 13, lineHeight: 1.45, marginBottom: a.instruction ? 6 : 0 }}>
                  {truncateText(
                    a.description ||
                      a.instruction ||
                      "The National Weather Service has not published additional narrative text for this alert yet. Stay weather-aware and monitor updates.",
                    500
                  )}
                </div>
                {a.instruction ? (
                  <div style={{ fontSize: 13, fontWeight: 700, color: "#92400e" }}>
                    Action: {truncateText(a.instruction, 320)}
                  </div>
                ) : null}
                {a.url ? (
                  <a
                    href={a.url}
                    target="_blank"
                    rel="noreferrer"
                    style={{ display: "inline-block", marginTop: 6, fontSize: 12, color: "#92400e", fontWeight: 700 }}
                  >
                    Read full NWS alert
                  </a>
                ) : null}
              </div>
            ))}
          </div>
        ) : null}

        {forecast ? (
          <div className="card" style={{ padding: 14 }}>
            <div style={{ fontWeight: 900, marginBottom: 10 }}>Forecast</div>
            <div className="weatherPeriodGrid">
              {forecast.periods.slice(0, 14).map((p) => (
                <div key={p.name + p.startTime} className="weatherPeriodCard">
                  <div className="weatherPeriodHead">{p.name}</div>
                  <div className="weatherPeriodTemp">{p.temperature}°{p.temperatureUnit}</div>
                  <div className="weatherPeriodText">{p.shortForecast}</div>
                </div>
              ))}
            </div>
          </div>
        ) : null}

        {weatherArticles.length > 0 ? (
          <div className="card" style={{ padding: 14, marginTop: 12 }}>
            <div style={{ fontWeight: 900, marginBottom: 10 }}>Local Weather News{county ? ` — ${county} County` : ""}</div>
            <StoryDeck items={weatherArticles} onOpen={openWeatherItem} emptyMessage="" />
          </div>
        ) : null}
      </div>
    </AppShell>
  );
}

function ObituariesScreen() {
  const nav = useNavigate();
  const loc = useLocation();
  const selectedCounties = useSelectedCountyPreferences();
  const routeStateKey = useMemo(
    () => `${loc.pathname}${loc.search}|counties=${[...selectedCounties].sort().join(",")}`,
    [loc.pathname, loc.search, selectedCounties]
  );
  const restoredFeed = useMemo(() => readRouteFeedSnapshot(routeStateKey), [routeStateKey]);
  const [items, setItems] = useState<Item[]>(() => restoredFeed?.items || []);
  const [cursor, setCursor] = useState<string | null>(() => restoredFeed?.cursor ?? null);
  const [loading, setLoading] = useState<boolean>(() => !(restoredFeed?.items?.length));
  const openItem = useOpenItemNavigation(
    () => ({
      items,
      cursor
    }),
    routeStateKey
  );

  useEffect(() => {
    let cancelled = false;
    (async () => {
      const cached = readRouteFeedSnapshot(routeStateKey);
      if (cached?.items?.length) {
        if (cancelled) return;
        setItems(cached.items);
        setCursor(cached.cursor ?? null);
        setLoading(false);
        return;
      }
      setLoading(true);
      try {
        const categoryFeed = await getItems({
          scope: "ky",
          category: "Kentucky - Obituaries",
          counties: selectedCounties.length ? selectedCounties : undefined,
          hours: OBITUARY_LOOKBACK_HOURS,
          limit: FEED_PAGE_SIZE
        });
        if (cancelled) return;
        // Apply isObituaryItem as a secondary client-side safeguard to filter out
        // non-obituary content that may arrive from funeral home RSS feeds.
        const filtered = categoryFeed.items.filter(isObituaryItem);
        if (filtered.length > 0) {
          setItems(filtered);
          setCursor(categoryFeed.nextCursor);
        } else {
          // Fallback: keyword search when category filter returns no matching obituaries.
          const fallback = await getItems({
            scope: "ky",
            counties: selectedCounties.length ? selectedCounties : undefined,
            hours: OBITUARY_LOOKBACK_HOURS,
            limit: FEED_PAGE_SIZE
          });
          if (cancelled) return;
          setItems(fallback.items.filter(isObituaryItem));
          setCursor(fallback.nextCursor);
        }
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [selectedCounties, routeStateKey]);

  async function loadMore() {
    if (!cursor || loading) return;
    setLoading(true);
    try {
      const res = await getItems({
        scope: "ky",
        category: "Kentucky - Obituaries",
        counties: selectedCounties.length ? selectedCounties : undefined,
        hours: OBITUARY_LOOKBACK_HOURS,
        cursor,
        limit: FEED_PAGE_SIZE
      });
      setItems((prev) => mergeUniqueItems(prev, res.items.filter(isObituaryItem)));
      setCursor(res.nextCursor);
    } finally {
      setLoading(false);
    }
  }

  return (
    <AppShell title="Obituaries">
      <CoverageTabs />
      <div className="section">
        {selectedCounties.length ? (
          <div className="locationBanner">Filtered to My Counties ({selectedCounties.length}).</div>
        ) : null}
        {loading && !items.length ? (
          <div className="card emptyState">Loading obituary stories...</div>
        ) : (
          <>
            <StoryDeck items={items} onOpen={openItem} emptyMessage="No obituary stories right now." />
            {items.length ? <InfinitePager hasMore={Boolean(cursor)} loading={loading} onLoadMore={loadMore} /> : null}
          </>
        )}
      </div>
    </AppShell>
  );
}

function SchoolsScreen() {
  const nav = useNavigate();
  const loc = useLocation();
  const selectedCounties = useSelectedCountyPreferences();
  const routeStateKey = useMemo(
    () => `${loc.pathname}${loc.search}|counties=${[...selectedCounties].sort().join(",")}`,
    [loc.pathname, loc.search, selectedCounties]
  );
  const restoredFeed = useMemo(() => readRouteFeedSnapshot(routeStateKey), [routeStateKey]);
  const [items, setItems] = useState<Item[]>(() => restoredFeed?.items || []);
  const [cursor, setCursor] = useState<string | null>(() => restoredFeed?.cursor ?? null);
  const [loading, setLoading] = useState<boolean>(() => !(restoredFeed?.items?.length));
  const [fallbackSearch, setFallbackSearch] = useState(false);
  const openItem = useOpenItemNavigation(
    () => ({
      items,
      cursor
    }),
    routeStateKey
  );

  const schoolQuery = "\"school\" OR \"schools\" OR \"district\" OR \"classroom\" OR \"student\" OR \"teacher\" OR \"university\" OR \"college\" OR \"graduation\" OR \"enrollment\" OR \"school sports\" OR \"high school\" OR \"middle school\" OR \"elementary school\" OR \"board of education\" OR \"superintendent\"";

  useEffect(() => {
    let cancelled = false;
    (async () => {
      const cached = readRouteFeedSnapshot(routeStateKey);
      if (cached?.items?.length) {
        if (cancelled) return;
        setItems(cached.items);
        setCursor(cached.cursor ?? null);
        setLoading(false);
        return;
      }
      setLoading(true);
      try {
        // Try category feed first (Facebook school pages)
        const categoryRes = await getItems({
          scope: "ky",
          category: "Kentucky - Schools",
          counties: selectedCounties.length ? selectedCounties : undefined,
          hours: 24 * 14,
          limit: FEED_PAGE_SIZE
        });
        if (cancelled) return;
        if (categoryRes.items.length) {
          setItems(categoryRes.items);
          setCursor(categoryRes.nextCursor);
          setFallbackSearch(false);
          return;
        }
        // Fallback to keyword search
        const res = await searchItems(schoolQuery, {
          scope: "ky",
          counties: selectedCounties.length ? selectedCounties : undefined,
          hours: 24 * 14,
          limit: FEED_PAGE_SIZE
        });
        if (cancelled) return;
        setItems(res.items);
        setCursor(res.nextCursor);
        setFallbackSearch(true);
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [selectedCounties, routeStateKey]);

  async function loadMore() {
    if (!cursor || loading) return;
    setLoading(true);
    try {
      const res = fallbackSearch
        ? await searchItems(schoolQuery, {
            scope: "ky",
            counties: selectedCounties.length ? selectedCounties : undefined,
            hours: 24 * 14,
            cursor,
            limit: FEED_PAGE_SIZE
          })
        : await getItems({
            scope: "ky",
            category: "Kentucky - Schools",
            counties: selectedCounties.length ? selectedCounties : undefined,
            hours: 24 * 14,
            cursor,
            limit: FEED_PAGE_SIZE
          });
      setItems((prev) => mergeUniqueItems(prev, res.items));
      setCursor(res.nextCursor);
    } finally {
      setLoading(false);
    }
  }

  return (
    <AppShell title="Schools">
      <CoverageTabs />
      <div className="section">
        {loading && !items.length ? (
          <div className="card emptyState">Loading school stories...</div>
        ) : (
          <>
            <StoryDeck items={items} onOpen={openItem} emptyMessage="No school stories right now." />
            {items.length ? <InfinitePager hasMore={Boolean(cursor)} loading={loading} onLoadMore={loadMore} /> : null}
          </>
        )}
      </div>
    </AppShell>
  );
}

function LostFoundScreen() {
  const [posts, setPosts] = useState<LostFoundPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [type, setType] = useState<LostFoundType>("lost");
  const [title, setTitle] = useState("");
  const [description, setDescription] = useState("");
  const [formCounty, setFormCounty] = useState(() => getMyLocalCounty());
  const [listCounty, setListCounty] = useState("");
  const [contactEmail, setContactEmail] = useState("");
  const [showContact, setShowContact] = useState(false);
  const [file, setFile] = useState<File | null>(null);
  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const [message, setMessage] = useState("");
  const [markingId, setMarkingId] = useState<string | null>(null);
  const [markEmail, setMarkEmail] = useState("");
  const [markNote, setMarkNote] = useState("");
  const [markSubmitting, setMarkSubmitting] = useState(false);
  const [markMessage, setMarkMessage] = useState("");
  const [commentOpenByPost, setCommentOpenByPost] = useState<Record<string, boolean>>({});
  const [commentLoadingByPost, setCommentLoadingByPost] = useState<Record<string, boolean>>({});
  const [commentSubmittingByPost, setCommentSubmittingByPost] = useState<Record<string, boolean>>({});
  const [commentMessagesByPost, setCommentMessagesByPost] = useState<Record<string, string>>({});
  const [commentListByPost, setCommentListByPost] = useState<Record<string, LostFoundComment[]>>({});
  const [commentDraftByPost, setCommentDraftByPost] = useState<
    Record<string, { name: string; email: string; comment: string; acceptTerms: boolean }>
  >({});
  const lostFoundSchema = useMemo<SeoJsonLd>(
    () => ({
      "@context": "https://schema.org",
      "@type": "ItemList",
      name: "Kentucky Lost and Found Listings",
      itemListElement: posts.map((post, idx) => ({
        "@type": "ListItem",
        position: idx + 1,
        url: absoluteUrl(`/lost-found?post=${encodeURIComponent(post.id)}`),
        name: post.title
      }))
    }),
    [posts]
  );

  async function refresh() {
    setLoading(true);
    try {
      const res = await listLostFound({ status: "published", county: listCounty || undefined, limit: 80 });
      setPosts(res.posts);
    } catch {
      setPosts([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    void refresh();
  }, [listCounty]);

  function getCommentDraft(postId: string) {
    return (
      commentDraftByPost[postId] || {
        name: "",
        email: "",
        comment: "",
        acceptTerms: false
      }
    );
  }

  function updateCommentDraft(
    postId: string,
    patch: Partial<{ name: string; email: string; comment: string; acceptTerms: boolean }>
  ) {
    setCommentDraftByPost((prev) => {
      const current = prev[postId] || {
        name: "",
        email: "",
        comment: "",
        acceptTerms: false
      };
      return {
        ...prev,
        [postId]: { ...current, ...patch }
      };
    });
  }

  async function loadComments(postId: string, force = false) {
    if (commentLoadingByPost[postId]) return;
    if (!force && commentListByPost[postId]) return;
    setCommentLoadingByPost((prev) => ({ ...prev, [postId]: true }));
    setCommentMessagesByPost((prev) => ({ ...prev, [postId]: "" }));
    try {
      const res = await listLostFoundComments(postId, 100);
      setCommentListByPost((prev) => ({ ...prev, [postId]: res.comments || [] }));
    } catch (err: any) {
      setCommentMessagesByPost((prev) => ({ ...prev, [postId]: String(err?.message || err) }));
    } finally {
      setCommentLoadingByPost((prev) => ({ ...prev, [postId]: false }));
    }
  }

  async function toggleComments(postId: string) {
    const opening = !commentOpenByPost[postId];
    setCommentOpenByPost((prev) => ({ ...prev, [postId]: opening }));
    if (opening) {
      await loadComments(postId);
    }
  }

  async function submitComment(postId: string) {
    const draft = getCommentDraft(postId);
    if (!draft.name.trim() || !draft.email.trim() || !draft.comment.trim()) {
      setCommentMessagesByPost((prev) => ({ ...prev, [postId]: "Name, email, and comment are required." }));
      return;
    }
    if (!draft.acceptTerms) {
      setCommentMessagesByPost((prev) => ({
        ...prev,
        [postId]: "You must accept the Terms of Use and Comment Policy."
      }));
      return;
    }

    setCommentSubmittingByPost((prev) => ({ ...prev, [postId]: true }));
    setCommentMessagesByPost((prev) => ({ ...prev, [postId]: "" }));
    try {
      const res = await submitLostFoundComment({
        postId,
        name: draft.name.trim(),
        email: draft.email.trim(),
        comment: draft.comment.trim(),
        acceptTerms: true
      });
      const inserted = res.comment;
      setCommentListByPost((prev) => ({
        ...prev,
        [postId]: [...(prev[postId] || []), inserted]
      }));
      setCommentDraftByPost((prev) => ({
        ...prev,
        [postId]: {
          ...draft,
          comment: "",
          acceptTerms: false
        }
      }));
      setPosts((prev) =>
        prev.map((post) =>
          post.id === postId
            ? {
                ...post,
                comment_count: Number(post.comment_count || 0) + 1
              }
            : post
        )
      );
      setCommentMessagesByPost((prev) => ({ ...prev, [postId]: "Comment posted." }));
    } catch (err: any) {
      setCommentMessagesByPost((prev) => ({ ...prev, [postId]: String(err?.message || err) }));
    } finally {
      setCommentSubmittingByPost((prev) => ({ ...prev, [postId]: false }));
    }
  }

  async function submit() {
    if (!title.trim() || !description.trim() || !formCounty.trim() || !contactEmail.trim()) {
      setMessage("Please complete all required fields.");
      return;
    }

    setSubmitting(true);
    setMessage("");
    try {
      const imageKeys: string[] = [];
      if (file) {
        const upload = await getLostFoundUploadUrl(file.name, file.type || "application/octet-stream");
        await uploadLostFoundImage(upload.uploadUrl, file, upload.headers);
        imageKeys.push(upload.objectKey);
      }

      const submitted = await submitLostFound({
        type,
        title: title.trim(),
        description: description.trim(),
        county: formCounty.trim(),
        contactEmail: contactEmail.trim(),
        showContact,
        imageKeys
      });

      setTitle("");
      setDescription("");
      setContactEmail("");
      setShowContact(false);
      setFile(null);
      if (fileInputRef.current) fileInputRef.current.value = "";
      setMessage(submitted.status === "approved" ? "Listing published." : "Submission received and pending moderation.");
      await refresh();
    } catch (err: any) {
      setMessage(String(err?.message || err));
    } finally {
      setSubmitting(false);
    }
  }

  function startMarkFound(postId: string) {
    setMarkingId(postId);
    setMarkEmail("");
    setMarkNote("");
    setMarkMessage("");
  }

  async function submitMarkFound(postId: string) {
    if (!markEmail.trim()) {
      setMarkMessage("Enter the same contact email used when you created this listing.");
      return;
    }

    setMarkSubmitting(true);
    setMarkMessage("");
    try {
      await markLostFoundAsFound({
        id: postId,
        contactEmail: markEmail.trim(),
        note: markNote.trim() || undefined
      });
      setMarkMessage("Listing marked as found.");
      setMarkingId(null);
      await refresh();
    } catch (err: any) {
      setMarkMessage(String(err?.message || err));
    } finally {
      setMarkSubmitting(false);
    }
  }

  return (
    <AppShell
      title="Lost & Found"
      seo={{
        title: "Lost & Found Kentucky — Local KY News",
        description: "Post or find lost and found items across Kentucky counties.",
        path: "/lost-found",
        jsonLd: lostFoundSchema
      }}
    >
      <CoverageTabs />
      <div className="section">
        <div className="card" style={{ padding: 14, marginBottom: 12 }}>
          <div style={{ fontWeight: 900, marginBottom: 10 }}>Submit a Listing</div>
          <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
            <button className={"btn " + (type === "lost" ? "primary" : "")} onClick={() => setType("lost")}>
              Lost
            </button>
            <button className={"btn " + (type === "found" ? "primary" : "")} onClick={() => setType("found")}>
              Found
            </button>
          </div>
          <input
            className="searchInput"
            style={{ marginBottom: 8 }}
            placeholder="Title"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
          />
          <textarea
            className="searchInput"
            style={{ marginBottom: 8, minHeight: 90 }}
            placeholder="Description"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
          />
          <input
            className="searchInput"
            style={{ marginBottom: 8 }}
            placeholder="County"
            value={formCounty}
            onChange={(e) => setFormCounty(e.target.value)}
          />
          <input
            className="searchInput"
            style={{ marginBottom: 8 }}
            type="email"
            placeholder="Contact Email"
            value={contactEmail}
            onChange={(e) => setContactEmail(e.target.value)}
          />
          <label style={{ display: "flex", gap: 8, alignItems: "center", marginBottom: 8, color: "var(--muted)", fontSize: 13 }}>
            <input type="checkbox" checked={showContact} onChange={(e) => setShowContact(e.target.checked)} />
            Show contact email after approval
          </label>
          <input
            ref={fileInputRef}
            className="hiddenFileInput"
            type="file"
            accept="image/*"
            onChange={(e) => setFile(e.target.files?.[0] || null)}
          />
          <div className="filePickerRow">
            <button className="btn" type="button" onClick={() => fileInputRef.current?.click()}>
              Choose Screenshot
            </button>
            <div className="filePickerName">{file ? file.name : "No screenshot selected"}</div>
            {file ? (
              <button
                className="btn"
                type="button"
                onClick={() => {
                  setFile(null);
                  if (fileInputRef.current) fileInputRef.current.value = "";
                }}
              >
                Remove
              </button>
            ) : null}
          </div>
          <button className="btn primary" type="button" onClick={submit} disabled={submitting}>
            {submitting ? "Submitting..." : "Submit"}
          </button>
          {message ? <div style={{ marginTop: 10, color: "var(--muted)" }}>{message}</div> : null}
        </div>

        <div className="card lostFoundPolicyCard">
          <div className="lostFoundPolicyHeading">Terms of Use</div>
          <div className="lostFoundPolicyText">
            By submitting or commenting in Lost &amp; Found, you confirm your post is truthful, lawful, and does not
            violate anyone&apos;s rights.
          </div>
          <div className="lostFoundPolicyHeading" style={{ marginTop: 12 }}>Comment Policy</div>
          <ul className="lostFoundPolicyList">
            <li>No hate speech.</li>
            <li>No defamation.</li>
            <li>No threats.</li>
            <li>Comments may be removed at any time for policy violations or moderation concerns.</li>
            <li>Publishing defamatory comments can create legal liability depending on jurisdiction.</li>
          </ul>
        </div>

        <div className="card" style={{ padding: 14 }}>
          <div style={{ fontWeight: 900, marginBottom: 8 }}>Published Listings</div>
          <div style={{ display: "flex", gap: 8, marginBottom: 8 }}>
            <input
              className="searchInput"
              placeholder="Filter listings by county (optional)"
              value={listCounty}
              onChange={(e) => setListCounty(e.target.value)}
            />
            <button className="btn" onClick={() => setListCounty("")} type="button">
              Clear
            </button>
          </div>
          <div style={{ fontSize: 12, color: "var(--muted)", marginBottom: 10 }}>
            New submissions may remain hidden until approved.
          </div>
          {markMessage ? <div style={{ marginBottom: 10, color: "var(--muted)" }}>{markMessage}</div> : null}
          {loading ? <div style={{ color: "var(--muted)" }}>Loading...</div> : null}
          {!loading && !posts.length ? <div style={{ color: "var(--muted)" }}>No listings found.</div> : null}
          {posts.map((p) => (
            <div key={p.id} className="lostFoundPostCard">
              <div style={{ fontWeight: 800 }}>
                {p.type === "lost" ? "Lost" : "Found"}: {p.title}
              </div>
              <div style={{ fontSize: 13, color: "var(--muted)", marginBottom: 4 }}>
                {p.county}, {p.state_code}
              </div>
              <div style={{ fontSize: 14 }}>{p.description}</div>
              {p.contact_email ? (
                <div style={{ marginTop: 6, fontSize: 13, color: "var(--muted)" }}>Contact: {p.contact_email}</div>
              ) : null}
              {p.images[0] ? (
                <img
                  src={`/api/uploads/lost-found/${encodeURIComponent(p.images[0])}`}
                  alt=""
                  className="lostFoundImage"
                  loading="lazy"
                  decoding="async"
                />
              ) : null}
              {p.type === "lost" && !p.is_resolved ? (
                <div style={{ marginTop: 8 }}>
                  {markingId === p.id ? (
                    <div style={{ border: "1px solid var(--border)", borderRadius: 8, padding: 10 }}>
                      <div style={{ fontSize: 12, color: "var(--muted)", marginBottom: 6 }}>
                        Confirm with the contact email used at submit time.
                      </div>
                      <input
                        className="searchInput"
                        type="email"
                        placeholder="Contact email"
                        value={markEmail}
                        onChange={(e) => setMarkEmail(e.target.value)}
                        style={{ marginBottom: 8 }}
                      />
                      <textarea
                        className="searchInput"
                        placeholder="Optional note"
                        value={markNote}
                        onChange={(e) => setMarkNote(e.target.value)}
                        style={{ marginBottom: 8, minHeight: 72 }}
                      />
                      <div style={{ display: "flex", gap: 8 }}>
                        <button
                          className="btn primary"
                          type="button"
                          disabled={markSubmitting}
                          onClick={() => submitMarkFound(p.id)}
                        >
                          {markSubmitting ? "Updating..." : "Mark Found"}
                        </button>
                        <button
                          className="btn"
                          type="button"
                          disabled={markSubmitting}
                          onClick={() => setMarkingId(null)}
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <button className="btn" type="button" onClick={() => startMarkFound(p.id)}>
                      I found this item
                    </button>
                  )}
                </div>
              ) : null}
              <div className="lostFoundCommentHeader">
                <div className="lostFoundCommentCount">
                  {Number(commentListByPost[p.id]?.length ?? p.comment_count ?? 0)} comment
                  {Number(commentListByPost[p.id]?.length ?? p.comment_count ?? 0) === 1 ? "" : "s"}
                </div>
                <button className="btn" type="button" onClick={() => void toggleComments(p.id)}>
                  {commentOpenByPost[p.id] ? "Hide Comments" : "Show Comments"}
                </button>
              </div>
              {commentOpenByPost[p.id] ? (
                <div className="lostFoundComments">
                  {commentLoadingByPost[p.id] ? <div className="lostFoundCommentMuted">Loading comments...</div> : null}
                  {!commentLoadingByPost[p.id] && !(commentListByPost[p.id] || []).length ? (
                    <div className="lostFoundCommentMuted">No comments yet.</div>
                  ) : null}
                  {(commentListByPost[p.id] || []).map((comment) => (
                    <div key={comment.id} className="lostFoundCommentItem">
                      <div className="lostFoundCommentMeta">
                        <span className="lostFoundCommentAuthor">{comment.name}</span>
                        <span>{formatFromNow(comment.created_at)}</span>
                      </div>
                      <div className="lostFoundCommentBody">{comment.comment}</div>
                    </div>
                  ))}
                  <div className="lostFoundCommentForm">
                    <input
                      className="searchInput"
                      placeholder="Your name"
                      value={getCommentDraft(p.id).name}
                      onChange={(e) => updateCommentDraft(p.id, { name: e.target.value })}
                    />
                    <input
                      className="searchInput"
                      type="email"
                      placeholder="Your email"
                      value={getCommentDraft(p.id).email}
                      onChange={(e) => updateCommentDraft(p.id, { email: e.target.value })}
                    />
                    <textarea
                      className="searchInput"
                      placeholder="Write your comment"
                      value={getCommentDraft(p.id).comment}
                      onChange={(e) => updateCommentDraft(p.id, { comment: e.target.value })}
                      style={{ minHeight: 80 }}
                    />
                    <label className="lostFoundCommentTerms">
                      <input
                        type="checkbox"
                        checked={getCommentDraft(p.id).acceptTerms}
                        onChange={(e) => updateCommentDraft(p.id, { acceptTerms: e.target.checked })}
                      />
                      I agree to the Terms of Use and Comment Policy.
                    </label>
                    <button
                      className="btn primary"
                      type="button"
                      disabled={Boolean(commentSubmittingByPost[p.id])}
                      onClick={() => void submitComment(p.id)}
                    >
                      {commentSubmittingByPost[p.id] ? "Posting..." : "Post Comment"}
                    </button>
                    {commentMessagesByPost[p.id] ? (
                      <div className="lostFoundCommentMuted">{commentMessagesByPost[p.id]}</div>
                    ) : null}
                  </div>
                </div>
              ) : null}
            </div>
          ))}
        </div>
      </div>
    </AppShell>
  );
}

function OwnerAdminScreen() {
  const [tokenInput, setTokenInput] = useState(() => getOwnerAdminToken());
  const [token, setToken] = useState(() => getOwnerAdminToken());
  const [loading, setLoading] = useState(false);
  const [runningIngest, setRunningIngest] = useState(false);
  const [runningRevalidate, setRunningRevalidate] = useState(false);
  const [revalidateHours, setRevalidateHours] = useState(72);
  const [revalidateLimit, setRevalidateLimit] = useState(800);
  const [revalidateResult, setRevalidateResult] = useState<AdminItemRevalidateSummary | null>(null);
  const [statusFilter, setStatusFilter] = useState<"pending" | "approved" | "rejected" | "resolved" | "all">("all");
  const [error, setError] = useState("");
  const [notice, setNotice] = useState("");
  const [logs, setLogs] = useState<AdminIngestionLog[]>([]);
  const [feedHealth, setFeedHealth] = useState<AdminFeedHealth[]>([]);
  const [posts, setPosts] = useState<LostFoundPost[]>([]);
  const [comments, setComments] = useState<AdminLostFoundComment[]>([]);
  const [bans, setBans] = useState<AdminLostFoundCommentBan[]>([]);

  async function refreshAll(activeToken = token) {
    if (!activeToken.trim()) {
      setError("Enter your admin token.");
      return;
    }

    setLoading(true);
    setError("");
    setNotice("");
    try {
      const [logRes, healthRes, lostRes, commentRes, banRes] = await Promise.all([
        getAdminIngestionLogs({ token: activeToken, limit: 15 }),
        getAdminFeedHealth({ token: activeToken, hours: 48, limit: 200 }),
        listAdminLostFound({ token: activeToken, status: statusFilter, limit: 200 }),
        listAdminLostFoundComments({ token: activeToken, limit: 200 }),
        listAdminLostFoundCommentBans({ token: activeToken, limit: 200 })
      ]);
      setLogs(logRes.logs || []);
      setFeedHealth(healthRes.feeds || []);
      setPosts(lostRes.posts || []);
      setComments(commentRes.comments || []);
      setBans(banRes.bans || []);
    } catch (err: any) {
      setError(String(err?.message || err));
      setLogs([]);
      setFeedHealth([]);
      setPosts([]);
      setComments([]);
      setBans([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (!token.trim()) return;
    void refreshAll(token);
  }, [token, statusFilter]);

  async function saveTokenAndLoad() {
    const normalized = tokenInput.trim();
    setOwnerAdminToken(normalized);
    setToken(normalized);
    if (normalized) {
      await refreshAll(normalized);
    } else {
      setLogs([]);
      setFeedHealth([]);
      setPosts([]);
      setComments([]);
      setBans([]);
    }
  }

  async function runIngestNow() {
    if (!token.trim()) {
      setError("Enter your admin token.");
      return;
    }

    setRunningIngest(true);
    setNotice("");
    setError("");
    try {
      const res = await runAdminFeedReload({ token });
      if (!res.ok) {
        setError(res.stderr || "Manual ingestion failed");
      } else {
        setNotice(res.message || "Ingestion started. Refresh logs in a moment for progress.");
      }
      await refreshAll(token);
    } catch (err: any) {
      setError(String(err?.message || err));
    } finally {
      setRunningIngest(false);
    }
  }

  async function runRevalidate(dryRun: boolean) {
    if (!token.trim()) {
      setError("Enter your admin token.");
      return;
    }

    setRunningRevalidate(true);
    setError("");
    setNotice("");
    try {
      const res = await runAdminItemsRevalidate({
        token,
        hours: revalidateHours,
        limit: revalidateLimit,
        minWords: 50,
        dryRun,
        includeNational: false
      });
      setRevalidateResult(res.summary);
      if (dryRun) {
        setNotice(
          `Dry run complete: ${res.summary.wouldRetag} items would be re-tagged, ${res.summary.wouldPrune} items would be pruned.`
        );
      } else {
        setNotice(
          `Revalidate complete: ${res.summary.retagged} items re-tagged, ${res.summary.pruned} items pruned (${res.summary.prunedFeedLinks} feed links removed).`
        );
      }
    } catch (err: any) {
      setError(String(err?.message || err));
    } finally {
      setRunningRevalidate(false);
    }
  }

  async function deletePost(postId: string) {
    if (!token.trim()) {
      setError("Enter your admin token.");
      return;
    }
    const confirmed = window.confirm("Delete this listing permanently?");
    if (!confirmed) return;

    setNotice("");
    setError("");
    try {
      await deleteAdminLostFound({ token, id: postId });
      setPosts((prev) => prev.filter((post) => post.id !== postId));
      setNotice("Listing deleted.");
    } catch (err: any) {
      setError(String(err?.message || err));
    }
  }

  async function approvePost(postId: string) {
    if (!token.trim()) {
      setError("Enter your admin token.");
      return;
    }
    setNotice("");
    setError("");
    try {
      await approveAdminLostFound({ token, id: postId });
      setNotice("Listing approved.");
      await refreshAll(token);
    } catch (err: any) {
      setError(String(err?.message || err));
    }
  }

  async function rejectPost(postId: string) {
    if (!token.trim()) {
      setError("Enter your admin token.");
      return;
    }
    const reason = window.prompt("Reason for rejection (required):", "Policy violation");
    if (!reason || !reason.trim()) return;

    setNotice("");
    setError("");
    try {
      await rejectAdminLostFound({ token, id: postId, reason: reason.trim() });
      setNotice("Listing rejected.");
      await refreshAll(token);
    } catch (err: any) {
      setError(String(err?.message || err));
    }
  }

  async function deleteComment(commentId: string) {
    if (!token.trim()) {
      setError("Enter your admin token.");
      return;
    }
    const confirmed = window.confirm("Delete this comment?");
    if (!confirmed) return;

    setNotice("");
    setError("");
    try {
      await deleteAdminLostFoundComment({ token, id: commentId });
      setComments((prev) => prev.filter((comment) => comment.id !== commentId));
      setNotice("Comment deleted.");
    } catch (err: any) {
      setError(String(err?.message || err));
    }
  }

  async function banComment(commentId: string, mode: "user" | "ip" | "both") {
    if (!token.trim()) {
      setError("Enter your admin token.");
      return;
    }

    const reasonInput = window.prompt("Optional ban reason:", "Policy violation");
    if (reasonInput === null) return;

    setNotice("");
    setError("");
    try {
      await banAdminLostFoundComment({
        token,
        commentId,
        banUser: mode === "user" || mode === "both",
        banIp: mode === "ip" || mode === "both",
        reason: reasonInput.trim() || undefined
      });
      setNotice("Ban applied.");
      await refreshAll(token);
    } catch (err: any) {
      setError(String(err?.message || err));
    }
  }

  async function unbanEntry(banId: string) {
    if (!token.trim()) {
      setError("Enter your admin token.");
      return;
    }

    setNotice("");
    setError("");
    try {
      await deleteAdminLostFoundCommentBan({ token, id: banId });
      setBans((prev) => prev.filter((ban) => ban.id !== banId));
      setNotice("Ban removed.");
    } catch (err: any) {
      setError(String(err?.message || err));
    }
  }

  const criticalFeeds = feedHealth.filter((f) => f.health_status === "critical");
  const degradedFeeds = feedHealth.filter((f) => f.health_status === "degraded");

  return (
    <AppShell title="Owner Admin">
      <div className="section">
        <div className="card" style={{ padding: 14, marginBottom: 12 }}>
          <div style={{ fontWeight: 900, marginBottom: 8 }}>Private Owner Panel</div>
          <div style={{ fontSize: 12, color: "var(--muted)", marginBottom: 8 }}>
            This route is not linked in the app. Keep the URL and token private.
          </div>
          <input
            className="searchInput"
            type="password"
            placeholder="Admin token"
            value={tokenInput}
            onChange={(e) => setTokenInput(e.target.value)}
            style={{ marginBottom: 8 }}
          />
          <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
            <button className="btn primary" type="button" onClick={saveTokenAndLoad} disabled={loading}>
              Save Token + Load
            </button>
            <button className="btn" type="button" onClick={() => void refreshAll(token)} disabled={loading || !token.trim()}>
              Refresh
            </button>
            <button className="btn" type="button" onClick={runIngestNow} disabled={runningIngest || !token.trim()}>
              {runningIngest ? "Running..." : "Run Ingestion Now"}
            </button>
          </div>
          <div style={{ marginTop: 12, display: "grid", gap: 8 }}>
            <div style={{ fontSize: 12, color: "var(--muted)" }}>
              Re-tag/revalidate recent KY items without full ingestion.
            </div>
            <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
              <input
                className="searchInput"
                type="number"
                min={1}
                max={24 * 90}
                value={revalidateHours}
                onChange={(e) => setRevalidateHours(Math.max(1, Number(e.target.value || 72)))}
                style={{ maxWidth: 120 }}
                placeholder="Hours"
              />
              <input
                className="searchInput"
                type="number"
                min={1}
                max={3000}
                value={revalidateLimit}
                onChange={(e) => setRevalidateLimit(Math.max(1, Number(e.target.value || 800)))}
                style={{ maxWidth: 120 }}
                placeholder="Limit"
              />
              <button
                className="btn"
                type="button"
                onClick={() => void runRevalidate(true)}
                disabled={runningRevalidate || !token.trim()}
              >
                {runningRevalidate ? "Running..." : "Dry Run Revalidate"}
              </button>
              <button
                className="btn"
                type="button"
                onClick={() => void runRevalidate(false)}
                disabled={runningRevalidate || !token.trim()}
              >
                {runningRevalidate ? "Running..." : "Apply Revalidate"}
              </button>
            </div>
            {revalidateResult ? (
              <div style={{ fontSize: 12, color: "var(--muted)" }}>
                Last result: scanned {revalidateResult.scanned}, unchanged {revalidateResult.unchanged}, wouldRetag {revalidateResult.wouldRetag}, wouldPrune {revalidateResult.wouldPrune}.
              </div>
            ) : null}
          </div>
          {error ? <div style={{ color: "#b91c1c", marginTop: 8 }}>{error}</div> : null}
          {notice ? <div style={{ color: "var(--muted)", marginTop: 8 }}>{notice}</div> : null}
        </div>

        <div className="card" style={{ padding: 14, marginBottom: 12 }}>
          <div style={{ fontWeight: 900, marginBottom: 8 }}>Ingestion Status</div>
          <div style={{ fontSize: 13, color: "var(--muted)", marginBottom: 8 }}>
            Critical feeds: {criticalFeeds.length} | Degraded feeds: {degradedFeeds.length} | Total checked: {feedHealth.length}
          </div>
          {!logs.length ? (
            <div style={{ color: "var(--muted)" }}>No ingestion logs loaded yet.</div>
          ) : (
            logs.slice(0, 8).map((log) => (
              <div key={log.id} style={{ borderTop: "1px solid var(--border)", paddingTop: 8, marginTop: 8 }}>
                <div style={{ fontWeight: 700 }}>
                  Run #{log.id} • {log.status} • {log.source || "cron/manual"}
                </div>
                <div style={{ fontSize: 12, color: "var(--muted)" }}>
                  Started {formatPublishedDate(log.started_at)} | Finished {log.finished_at ? formatPublishedDate(log.finished_at) : "running"}
                </div>
                <div style={{ fontSize: 12, color: "var(--muted)" }}>
                  Feeds {log.details?.feedsProcessed ?? 0}, New items {log.details?.itemsUpserted ?? 0}, Summaries {log.details?.summariesGenerated ?? 0}, Errors {log.feed_errors}
                </div>
              </div>
            ))
          )}
        </div>

        <div className="card" style={{ padding: 14, marginBottom: 12 }}>
          <div style={{ fontWeight: 900, marginBottom: 8 }}>Feed Health (48h)</div>
          {!feedHealth.length ? (
            <div style={{ color: "var(--muted)" }}>No feed health data loaded yet.</div>
          ) : (
            feedHealth
              .sort((a, b) => {
                const rank = (x: string) => (x === "critical" ? 0 : x === "degraded" ? 1 : x === "healthy" ? 2 : 3);
                return rank(a.health_status) - rank(b.health_status);
              })
              .slice(0, 25)
              .map((feed) => (
                <div key={feed.id} style={{ borderTop: "1px solid var(--border)", paddingTop: 8, marginTop: 8 }}>
                  <div style={{ fontWeight: 700 }}>
                    {feed.name} ({feed.health_status})
                  </div>
                  <div style={{ fontSize: 12, color: "var(--muted)" }}>
                    {feed.category} | Last check {feed.last_metric_at ? formatPublishedDate(feed.last_metric_at) : "never"} | Recent items {feed.recent_items} | Error rate {(feed.error_rate * 100).toFixed(0)}%
                  </div>
                </div>
              ))
          )}
        </div>

        <div className="card" style={{ padding: 14 }}>
          <div style={{ display: "flex", gap: 8, alignItems: "center", marginBottom: 8 }}>
            <div style={{ fontWeight: 900 }}>Lost & Found Listings</div>
            <select
              className="searchInput"
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value as typeof statusFilter)}
              style={{ maxWidth: 180 }}
            >
              <option value="all">All</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="resolved">Resolved</option>
            </select>
          </div>
          {!posts.length ? (
            <div style={{ color: "var(--muted)" }}>No listings found for this filter.</div>
          ) : (
            posts.map((post) => (
              <div key={post.id} style={{ borderTop: "1px solid var(--border)", paddingTop: 8, marginTop: 8 }}>
                <div style={{ fontWeight: 700 }}>
                  {post.type.toUpperCase()} • {post.status}
                  {post.is_resolved ? " • resolved" : ""}
                </div>
                <div>{post.title}</div>
                <div style={{ fontSize: 12, color: "var(--muted)" }}>
                  {post.county}, {post.state_code} | Submitted {formatPublishedDate(post.submitted_at)}
                </div>
                <div style={{ marginTop: 6, display: "flex", gap: 8, flexWrap: "wrap" }}>
                  {post.status === "pending" ? (
                    <>
                      <button className="btn primary" type="button" onClick={() => void approvePost(post.id)}>
                        Approve
                      </button>
                      <button className="btn" type="button" onClick={() => void rejectPost(post.id)}>
                        Reject
                      </button>
                    </>
                  ) : null}
                  <button className="btn" type="button" onClick={() => void deletePost(post.id)}>
                    Delete
                  </button>
                </div>
              </div>
            ))
          )}
        </div>

        <div className="card" style={{ padding: 14, marginTop: 12 }}>
          <div style={{ fontWeight: 900, marginBottom: 8 }}>Lost & Found Comments</div>
          {!comments.length ? (
            <div style={{ color: "var(--muted)" }}>No comments loaded.</div>
          ) : (
            comments.map((comment) => (
              <div key={comment.id} style={{ borderTop: "1px solid var(--border)", paddingTop: 8, marginTop: 8 }}>
                <div style={{ fontWeight: 700 }}>{comment.name}</div>
                <div style={{ fontSize: 12, color: "var(--muted)" }}>
                  {comment.post_title || "Post"} | {formatPublishedDate(comment.created_at)}
                </div>
                <div style={{ marginTop: 4, whiteSpace: "pre-wrap" }}>{comment.comment}</div>
                <div style={{ marginTop: 6, display: "flex", gap: 8, flexWrap: "wrap" }}>
                  <button className="btn" type="button" onClick={() => void deleteComment(comment.id)}>
                    Delete Comment
                  </button>
                  <button className="btn" type="button" onClick={() => void banComment(comment.id, "user")}>
                    Ban User
                  </button>
                  <button className="btn" type="button" onClick={() => void banComment(comment.id, "ip")}>
                    Ban IP
                  </button>
                  <button className="btn" type="button" onClick={() => void banComment(comment.id, "both")}>
                    Ban Both
                  </button>
                </div>
              </div>
            ))
          )}
        </div>

        <div className="card" style={{ padding: 14, marginTop: 12 }}>
          <div style={{ fontWeight: 900, marginBottom: 8 }}>Banned Users/IPs</div>
          {!bans.length ? (
            <div style={{ color: "var(--muted)" }}>No bans configured.</div>
          ) : (
            bans.map((ban) => (
              <div key={ban.id} style={{ borderTop: "1px solid var(--border)", paddingTop: 8, marginTop: 8 }}>
                <div style={{ fontWeight: 700 }}>
                  {ban.target_type === "email" ? "User (email hash)" : "IP address"} ban
                </div>
                <div style={{ fontSize: 12, color: "var(--muted)" }}>
                  Added by {ban.banned_by_email} on {formatPublishedDate(ban.created_at)}
                </div>
                {ban.reason ? <div style={{ marginTop: 4 }}>{ban.reason}</div> : null}
                <div style={{ marginTop: 6 }}>
                  <button className="btn" type="button" onClick={() => void unbanEntry(ban.id)}>
                    Remove Ban
                  </button>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </AppShell>
  );
}

function SearchScreen() {
  const loc = useLocation();
  const routeStateKey = `${loc.pathname}${loc.search}`;
  const restoredFeed = useMemo(() => readRouteFeedSnapshot(routeStateKey), [routeStateKey]);
  const restoredMeta = restoredFeed?.meta as Record<string, unknown> | undefined;
  const [q, setQ] = useState<string>(() => String(restoredMeta?.q || ""));
  const [sortOrder, setSortOrder] = useState<"newest" | "oldest">(() =>
    restoredMeta?.sortOrder === "oldest" ? "oldest" : "newest"
  );
  const [items, setItems] = useState<Item[]>(() => restoredFeed?.items || []);
  const [cursor, setCursor] = useState<string | null>(() => restoredFeed?.cursor ?? null);
  const [loading, setLoading] = useState(false);
  const skipInitialSortRefreshRef = useRef(Boolean(restoredFeed?.items?.length));
  const openItem = useOpenItemNavigation(
    () => ({
      items,
      cursor,
      meta: {
        q,
        sortOrder
      }
    }),
    routeStateKey
  );

  async function runSearch(nextCursor?: string | null) {
    if (!q.trim()) return;
    if (nextCursor && loading) return;
    setLoading(true);
    try {
      const res = await searchItems(q.trim(), {
        scope: "all",
        sort: sortOrder,
        cursor: nextCursor ?? undefined,
        limit: FEED_PAGE_SIZE
      });
      setItems((prev) => (nextCursor ? [...prev, ...res.items] : res.items));
      setCursor(res.nextCursor);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (skipInitialSortRefreshRef.current) {
      skipInitialSortRefreshRef.current = false;
      return;
    }
    if (!q.trim()) return;
    void runSearch(null);
  }, [sortOrder]);

  return (
    <AppShell title="Search">
      <div className="section">
        <input
          className="pill"
          style={{ width: "100%", padding: "12px 12px", borderRadius: 12, border: "1px solid var(--border)" }}
          placeholder="Search Local KY News stories..."
          value={q}
          onChange={(e) => setQ(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === "Enter") void runSearch(null);
          }}
        />

        <div style={{ marginTop: 12 }}>
          <label htmlFor="search-sort-order" style={{ display: "block", fontSize: 12, color: "var(--muted)", marginBottom: 6 }}>
            Sort
          </label>
          <select
            id="search-sort-order"
            className="searchInput"
            value={sortOrder}
            onChange={(e) => setSortOrder(e.target.value as "newest" | "oldest")}
          >
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
          </select>
        </div>

        <div style={{ marginTop: 14 }}>
          <button className="btn block primary" onClick={() => runSearch(null)} disabled={loading || !q.trim()}>
            {loading ? "Searching…" : "Search"}
          </button>

          <div style={{ height: 12 }} />

          <StoryDeck items={items} onOpen={openItem} />

          {items.length ? <InfinitePager hasMore={Boolean(cursor)} loading={loading} onLoadMore={() => runSearch(cursor)} /> : null}
          {!loading && q.trim() && !items.length ? <div className="listStatus">No results found</div> : null}
        </div>
      </div>
    </AppShell>
  );
}

function NotFoundScreen() {
  const nav = useNavigate();
  return (
    <AppShell
      title="Not Found"
      seo={{
        title: "Page Not Found — Local KY News",
        description: "The page you requested could not be found.",
        path: "/404"
      }}
    >
      <div className="section">
        <div className="card" style={{ padding: 14 }}>
          <div style={{ fontWeight: 900, marginBottom: 8 }}>Page Not Found</div>
          <div style={{ color: "var(--muted)", marginBottom: 12 }}>
            The page you requested is unavailable or may have moved.
          </div>
          <button className="btn" onClick={() => nav("/today")}>
            Return Home
          </button>
        </div>
      </div>
    </AppShell>
  );
}

```

# apps\web\src\ui\icons.tsx

```tsx
import React from "react";

type Props = { className?: string };

export function IconMenu({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
    </svg>
  );
}

export function IconBookmark({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path d="M7 4h10a1 1 0 0 1 1 1v16l-6-3-6 3V5a1 1 0 0 1 1-1Z" stroke="currentColor" strokeWidth="2" strokeLinejoin="round"/>
    </svg>
  );
}

export function IconToday({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path d="M7 3v3M17 3v3" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
      <path d="M4 8h16" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
      <path d="M6 6h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2Z" stroke="currentColor" strokeWidth="2"/>
      <path d="M8 12h4M8 16h8" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
    </svg>
  );
}

export function IconRss({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path d="M6 18a2 2 0 1 0 0.001 0Z" stroke="currentColor" strokeWidth="2"/>
      <path d="M5 11a8 8 0 0 1 8 8" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
      <path d="M5 5a14 14 0 0 1 14 14" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
    </svg>
  );
}

export function IconSearch({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" strokeWidth="2"/>
      <path d="M16.5 16.5 21 21" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
    </svg>
  );
}

export function IconMore({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path d="M5 12h.01M12 12h.01M19 12h.01" stroke="currentColor" strokeWidth="3" strokeLinecap="round"/>
    </svg>
  );
}

export function IconChevronDown({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path d="m6 9 6 6 6-6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
    </svg>
  );
}

export function IconMapPin({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path
        d="M12 21s6-5.7 6-11a6 6 0 1 0-12 0c0 5.3 6 11 6 11Z"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinejoin="round"
      />
      <circle cx="12" cy="10" r="2.5" stroke="currentColor" strokeWidth="2" />
    </svg>
  );
}

export function IconHeart({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path
        d="M12 21s-6.8-4.6-9.2-8.5c-2.5-4 0.3-9 4.7-9 2 0 3.5 1 4.5 2.4C13 4.5 14.5 3.5 16.5 3.5c4.4 0 7.2 5 4.7 9C18.8 16.4 12 21 12 21Z"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinejoin="round"
      />
    </svg>
  );
}

export function IconShare({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path d="M15 6h5v5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path d="M20 6 11 15" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      <path
        d="M20 13v4a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4"
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
      />
    </svg>
  );
}

export function IconSettings({ className }: Props) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none">
      <path
        d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"
        stroke="currentColor"
        strokeWidth="2"
      />
      <path
        d="m19.4 15.5.3-1.5-1.4-.8a6.7 6.7 0 0 0 0-2.4l1.4-.8-.3-1.5-1.6-.3a6.8 6.8 0 0 0-1.4-1.4l.3-1.6-1.5-.3-.8 1.4a6.7 6.7 0 0 0-2.4 0l-.8-1.4-1.5.3.3 1.6a6.8 6.8 0 0 0-1.4 1.4l-1.6.3-.3 1.5 1.4.8a6.7 6.7 0 0 0 0 2.4l-1.4.8.3 1.5 1.6.3a6.8 6.8 0 0 0 1.4 1.4l-.3 1.6 1.5.3.8-1.4a6.7 6.7 0 0 0 2.4 0l.8 1.4 1.5-.3-.3-1.6a6.8 6.8 0 0 0 1.4-1.4l1.6-.3Z"
        stroke="currentColor"
        strokeWidth="1.6"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
    </svg>
  );
}

```

# apps\web\src\ui\Reader.tsx

```tsx
import React, { useEffect, useMemo, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";
import { getItem, type Item } from "../data/api";
import { cacheLastOpened, getCachedItem, isSaved, markRead, toggleSaved } from "../data/localDb";
import { IconHeart, IconShare } from "./icons";
import { SeoMeta, absoluteUrl, metaDescription, type SeoJsonLd } from "./Seo";

function htmlToText(html: string | null | undefined) {
  if (!html) return "";
  return String(html)
    .replace(/<script[\s\S]*?<\/script>/gi, "")
    .replace(/<style[\s\S]*?<\/style>/gi, "")
    .replace(/<\/(p|div|section|article|blockquote|h[1-6]|li)>/gi, "\n\n")
    .replace(/<br\s*\/?>/gi, "\n")
    .replace(/<li[^>]*>/gi, "\n- ")
    .replace(/<[^>]+>/g, "")
    .replace(/\r/g, "\n")
    .replace(/[ \t]+\n/g, "\n")
    .replace(/\n[ \t]+/g, "\n")
    .replace(/[ \t]{2,}/g, " ")
    .trim();
}

function splitLongParagraph(paragraph: string): string[] {
  const text = paragraph.trim();
  if (!text) return [];
  if (text.length < 420) return [text];

  const sentences = (text.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [])
    .map((x) => x.trim())
    .filter(Boolean);
  if (sentences.length < 4) return [text];

  const out: string[] = [];
  let bucket: string[] = [];
  for (const sentence of sentences) {
    bucket.push(sentence);
    const joined = bucket.join(" ").trim();
    if (joined.length >= 320 || bucket.length >= 3) {
      out.push(joined);
      bucket = [];
    }
  }
  if (bucket.length) out.push(bucket.join(" ").trim());
  return out.filter(Boolean);
}

function toParagraphs(html: string | null | undefined): string[] {
  const clean = htmlToText(html);
  if (!clean) return [];
  const base = clean
    .split(/\n{2,}/)
    .map((x) => x.replace(/\s+/g, " ").trim())
    .filter(Boolean);
  if (!base.length) return [];
  return base.flatMap((paragraph) => splitLongParagraph(paragraph));
}

/**
 * Normalise a stored summary string so that paragraph breaks introduced by the AI
 * (e.g. "The U.\n\nS. team") are collapsed back into a single paragraph of prose.
 * This is a client-side safety net for summaries already persisted in the database
 * before the server-side prompt fix was deployed.
 */
function normaliseSummaryText(text: string | null | undefined): string {
  if (!text) return "";
  // Collapse every sequence of newlines (including \n\n from broken abbreviations) to a space.
  return text.replace(/\n+/g, " ").replace(/[ \t]{2,}/g, " ").trim();
}

function sourceFromUrl(url: string) {
  try {
    const u = new URL(url);
    return u.hostname.replace(/^www\./, "");
  } catch {
    return "";
  }
}

export default function Reader() {
  const nav = useNavigate();
  const { id } = useParams();
  const [item, setItem] = useState<Item | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [saved, setSaved] = useState<boolean>(false);
  const [fromCache, setFromCache] = useState<boolean>(false);
  const [heroImageFailed, setHeroImageFailed] = useState<boolean>(false);
  const [shareMessage, setShareMessage] = useState<string>("");

  useEffect(() => {
    let cancelled = false;

    (async () => {
      if (!id) return;
      setError(null);
      setFromCache(false);

      const cached = await getCachedItem(id);
      if (cached && !cancelled) {
        setItem(cached);
        setFromCache(true);
      }

      try {
        const fresh = await getItem(id);
        if (cancelled) return;
        setItem(fresh);
        setFromCache(false);

        await cacheLastOpened({
          id: fresh.id,
          title: fresh.title,
          url: fresh.url,
          author: fresh.author ?? null,
          published_at: fresh.published_at ?? null,
          summary: fresh.summary ?? null,
          content: fresh.content ?? null,
          image_url: fresh.image_url ?? null,
          source: sourceFromUrl(fresh.url)
        });

        await markRead(id);
      } catch (e: any) {
        if (cached) return;
        if (cancelled) return;
        setError(String(e?.message || e));
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [id]);

  useEffect(() => {
    let mounted = true;
    (async () => {
      if (!id) return;
      const s = await isSaved(id);
      if (mounted) setSaved(s);
    })();
    return () => {
      mounted = false;
    };
  }, [id]);

  useEffect(() => {
    setHeroImageFailed(false);
    setShareMessage("");
  }, [item?.id, item?.image_url]);

  async function toggle() {
    if (!id || !item) return;
    const next = await toggleSaved({
      id: item.id,
      title: item.title,
      url: item.url,
      author: item.author ?? null,
      published_at: item.published_at ?? null,
      summary: item.summary ?? null,
      content: item.content ?? null,
      image_url: item.image_url ?? null,
      source: sourceFromUrl(item.url)
    });
    setSaved(next);
  }

  async function share() {
    if (!item?.url) return;
    setShareMessage("");

    try {
      if (navigator.share) {
        await navigator.share({
          title: item.title,
          text: item.title,
          url: item.url
        });
        return;
      }
    } catch (err: any) {
      if (String(err?.name || "") === "AbortError") return;
    }

    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(item.url);
        setShareMessage("Link copied.");
        return;
      }
    } catch {
      // fall through to direct open
    }

    window.open(item.url, "_blank", "noopener,noreferrer");
  }

  const dt = item?.published_at ? new Date(item.published_at) : null;
  const dateStr = dt ? dt.toLocaleString() : "-";
  // Normalise the summary first to collapse any AI-generated mid-sentence newlines
  // (e.g. "The U.\n\nS. team") present in summaries stored before the server fix.
  const normalisedSummary = normaliseSummaryText(item?.summary);
  const summaryParagraphs = useMemo(() => toParagraphs(normalisedSummary || null), [normalisedSummary]);
  const contentParagraphs = useMemo(() => toParagraphs(item?.content), [item?.content]);
  const summaryFingerprint = summaryParagraphs.join(" ").toLowerCase();
  const contentFingerprint = contentParagraphs.join(" ").toLowerCase();
  // Only show the raw content ("Article Content") if there is NO AI summary.
  // When a summary exists it already captures the key information; showing the
  // original feed excerpt alongside it is redundant and confusing to readers.
  const showContent = contentParagraphs.length > 0 && !summaryParagraphs.length && contentFingerprint !== summaryFingerprint;
  const canonicalPath = id ? `/item/${id}` : "/item";
  const seoDescription = metaDescription(
    item?.seo_description || item?.summary || item?.content || item?.title || "Read this Kentucky news article."
  );
  const seoTitle = item?.title ? `${item.title} — Local KY News` : "Article — Local KY News";
  const articleSchema: SeoJsonLd | undefined = item
    ? {
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        headline: item.title,
        description: seoDescription,
        datePublished: item.published_at || undefined,
        author: {
          "@type": "Organization",
          name: sourceFromUrl(item.url) || "Local KY News"
        },
        image: item.image_url ? [absoluteUrl(item.image_url)] : undefined,
        mainEntityOfPage: absoluteUrl(canonicalPath),
        url: absoluteUrl(canonicalPath)
      }
    : undefined;

  return (
    <div className="app">
      <SeoMeta
        title={seoTitle}
        description={seoDescription}
        path={canonicalPath}
        type="article"
        image={item?.image_url || undefined}
        publishedTime={item?.published_at || undefined}
        jsonLd={articleSchema}
      />
      <header className="topbar">
        <button className="iconBtn" onClick={() => nav(-1)} aria-label="Back">
          ←
        </button>

        <div className="title">Article</div>
        <div className="topbarSpacer" />
      </header>

      <div className="appFrame">
        <div className="content">
          <div className="section">
            {error ? (
              <div className="card" style={{ padding: 14 }}>
                <div style={{ fontWeight: 900 }}>Error</div>
                <div style={{ color: "var(--muted)", marginTop: 8 }}>{error}</div>
              </div>
            ) : null}

            {item ? (
              <div className="card readerPad">
                <div className="readerMeta">
                  <span className="pill">{fromCache ? "offline cache" : "live"}</span>
                  <span className="pill">{item.author || "-"}</span>
                  <span className="pill">{dateStr}</span>
                </div>

                <div className="readerTitle">{item.title}</div>

                {item.image_url && !heroImageFailed ? (
                  <img className="hero" src={item.image_url} alt="" onError={() => setHeroImageFailed(true)} />
                ) : null}

                <div className="readerBody">
                  {summaryParagraphs.length ? (
                    <>
                      <div style={{ fontWeight: 800, marginBottom: 6 }}>Summary</div>
                      {summaryParagraphs.map((paragraph, idx) => (
                        <p key={`summary-${idx}`}>{paragraph}</p>
                      ))}
                    </>
                  ) : null}
                  {showContent ? (
                    <>
                      <div style={{ fontWeight: 800, marginBottom: 6, marginTop: 12 }}>Article Content</div>
                      {contentParagraphs.map((paragraph, idx) => (
                        <p key={`content-${idx}`}>{paragraph}</p>
                      ))}
                    </>
                  ) : null}
                  {!summaryParagraphs.length && !contentParagraphs.length ? (
                    <p style={{ color: "var(--muted)" }}>This feed did not provide enough text for an in-app summary yet.</p>
                  ) : null}
                </div>

                <div className="readerBottomActions">
                  <button
                    className={"iconAction readerIconAction " + (saved ? "active" : "")}
                    onClick={toggle}
                    aria-label={saved ? "Saved" : "Save article"}
                  >
                    <IconHeart className="postActionIcon" />
                  </button>
                  <button className="iconAction readerIconAction" onClick={share} disabled={!item.url} aria-label="Share article">
                    <IconShare className="postActionIcon" />
                  </button>
                  {item.url ? (
                    <a className="btn readerOpenOriginalBtn" href={item.url} target="_blank" rel="noreferrer">
                      Open Original
                    </a>
                  ) : null}
                </div>
                {shareMessage ? <div className="meta" style={{ marginTop: 8 }}>{shareMessage}</div> : null}
              </div>
            ) : (
              <div className="card" style={{ padding: 14, color: "var(--muted)" }}>
                Loading...
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

```

# apps\web\src\ui\Seo.tsx

```tsx
import React from "react";
import { Helmet } from "react-helmet-async";

const DEFAULT_SITE_URL = String(import.meta.env.VITE_SITE_URL || "https://localky.news").replace(/\/+$/g, "");

export type SeoJsonLd = Record<string, unknown>;

export type SeoMetaProps = {
  title: string;
  description: string;
  path?: string;
  url?: string;
  type?: "website" | "article";
  image?: string;
  publishedTime?: string;
  robots?: string;
  jsonLd?: SeoJsonLd | SeoJsonLd[];
};

export function getSiteUrl() {
  return DEFAULT_SITE_URL;
}

export function absoluteUrl(pathOrUrl?: string): string {
  if (pathOrUrl && /^https?:\/\//i.test(pathOrUrl)) return pathOrUrl;

  const fallbackPath = pathOrUrl || "/";
  if (typeof window !== "undefined") {
    const base = window.location.origin;
    try {
      return new URL(fallbackPath || `${window.location.pathname}${window.location.search}`, base).toString();
    } catch {
      return new URL("/", base).toString();
    }
  }

  try {
    return new URL(fallbackPath, DEFAULT_SITE_URL).toString();
  } catch {
    return `${DEFAULT_SITE_URL}/`;
  }
}

export function stripHtml(input?: string | null) {
  if (!input) return "";
  return String(input)
    .replace(/<[^>]+>/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

export function metaDescription(input?: string | null, maxLength = 155) {
  const text = stripHtml(input || "");
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return `${text.slice(0, Math.max(0, maxLength - 1)).trimEnd()}…`;
}

export function StructuredData({ jsonLd }: { jsonLd: SeoJsonLd | SeoJsonLd[] }) {
  const entries = Array.isArray(jsonLd) ? jsonLd : [jsonLd];
  return (
    <Helmet>
      {entries.map((entry, idx) => (
        <script key={`ld-json-${idx}`} type="application/ld+json">
          {JSON.stringify(entry)}
        </script>
      ))}
    </Helmet>
  );
}

export function SeoMeta({
  title,
  description,
  path,
  url,
  type = "website",
  image,
  publishedTime,
  robots = "index, follow",
  jsonLd
}: SeoMetaProps) {
  const canonical = absoluteUrl(url || path);
  const ogImage = image ? absoluteUrl(image) : undefined;
  const entries = jsonLd ? (Array.isArray(jsonLd) ? jsonLd : [jsonLd]) : [];

  return (
    <Helmet>
      <title>{title}</title>
      <meta name="description" content={description} />
      <meta name="robots" content={robots} />
      <link rel="canonical" href={canonical} />
      <meta property="og:title" content={title} />
      <meta property="og:description" content={description} />
      <meta property="og:url" content={canonical} />
      <meta property="og:type" content={type} />
      {ogImage ? <meta property="og:image" content={ogImage} /> : null}
      {type === "article" && publishedTime ? <meta property="article:published_time" content={publishedTime} /> : null}
      {entries.map((entry, idx) => (
        <script key={`seo-ld-json-${idx}`} type="application/ld+json">
          {JSON.stringify(entry)}
        </script>
      ))}
    </Helmet>
  );
}

```

# apps\web\src\ui\styles.css

```css
:root {
  color-scheme: light;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --bg: #f3f4f6;
  --surface: #ffffff;
  --surface-soft: #f9fafb;
  --text: #111827;
  --muted: #6b7280;
  --border: #e5e7eb;
  --accent: #ff9800;
  --accent-soft: rgba(255, 152, 0, 0.14);
  --nav-bg: #ffffff;
  --nav-bg-soft: #f8fafc;
  --nav-text: #111827;
  --banner-bg: #fff7ed;
  --banner-border: #fed7aa;
  --banner-text: #9a3412;
  --shadow: 0 10px 24px rgba(17, 24, 39, 0.12);
}

[data-theme="dark"] {
  color-scheme: dark;
  --bg: #1f2126;
  --surface: #2a2d32;
  --surface-soft: #343840;
  --text: #f3f4f6;
  --muted: #b5bac3;
  --border: #434752;
  --accent: #ffb020;
  --accent-soft: rgba(255, 176, 32, 0.18);
  --nav-bg: #14161a;
  --nav-bg-soft: #1f2227;
  --nav-text: #f3f4f6;
  --banner-bg: rgba(255, 176, 32, 0.18);
  --banner-border: rgba(255, 176, 32, 0.35);
  --banner-text: #ffd089;
  --shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
}

* {
  box-sizing: border-box;
}

html,
body {
  height: 100%;
}

body {
  margin: 0;
  font-family: Roboto, "Helvetica Neue", Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  background: var(--bg);
  color: var(--text);
}

a {
  color: inherit;
  text-decoration: none;
}

button,
input,
textarea,
select {
  font: inherit;
}

.app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.topbar {
  position: sticky;
  top: 0;
  z-index: 30;
  min-height: calc(56px + var(--safe-top));
  display: flex;
  align-items: center;
  gap: 12px;
  padding: calc(var(--safe-top) + 2px) 14px 0;
  background: linear-gradient(90deg, var(--nav-bg) 0%, var(--nav-bg-soft) 55%, var(--nav-bg) 100%);
  border-bottom: 1px solid var(--border);
}

.topbar .title {
  flex: 1;
  min-width: 0;
  text-align: center;
  color: var(--nav-text);
  font-size: 28px;
  font-weight: 500;
}

.brandTitle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.brandTitle span {
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.brandLogo {
  width: 52px;
  height: 52px;
  object-fit: contain;
  flex: 0 0 auto;
}

.topbarSpacer {
  width: 40px;
}

.iconBtn {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  border: 1px solid transparent;
  background: transparent;
  color: var(--nav-text);
  display: grid;
  place-items: center;
  cursor: pointer;
}

.iconBtn:hover {
  background: var(--accent-soft);
}

.closeBtn {
  color: var(--text);
}

.appFrame {
  width: min(1160px, 100%);
  margin: 0 auto;
  flex: 1;
  min-height: 0;
  display: flex;
}

.content {
  width: 100%;
  overflow: auto;
  padding-top: 12px;
  padding-bottom: calc(84px + var(--safe-bottom));
}

.section {
  padding: 14px;
}

.tabs {
  display: flex;
  align-items: center;
  gap: 2px;
  padding: 0 8px;
  background: #ffffff;
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
}

.tab {
  padding: 12px 16px 11px;
  color: #6b7280;
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  cursor: pointer;
  white-space: nowrap;
  border: 0;
  border-bottom: 3px solid transparent;
  background: transparent;
}

.tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.tabTail {
  margin-left: auto;
  color: #6b7280;
  font-size: 21px;
  line-height: 1;
  padding: 0 10px 2px;
}

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: var(--shadow);
}

.emptyState {
  padding: 14px;
  color: var(--muted);
}

.locationBanner {
  margin-bottom: 12px;
  border: 1px solid var(--banner-border);
  background: var(--banner-bg);
  color: var(--banner-text);
  border-radius: 8px;
  padding: 8px 11px;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.prefCard {
  padding: 12px;
  margin-bottom: 12px;
}

.prefHeading {
  margin-bottom: 10px;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #4b5563;
}

.prefHint {
  font-size: 12px;
  color: var(--muted);
}

.prefRow {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid transparent;
  cursor: pointer;
}

.prefRow:hover {
  background: #f3f4f6;
}

.prefRow.active {
  background: var(--accent-soft);
  border-color: rgba(255, 152, 0, 0.3);
}

.themeRow {
  cursor: default;
}

.themeRow:hover {
  background: transparent;
}

.themeSwitch {
  position: relative;
  width: 44px;
  height: 24px;
  display: inline-flex;
  align-items: center;
}

.themeInput {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.themeSlider {
  width: 100%;
  height: 100%;
  border-radius: 999px;
  background: #d1d5db;
  border: 1px solid #c2c8d1;
  position: relative;
  transition: background-color 140ms ease, border-color 140ms ease;
}

.themeSlider::after {
  content: "";
  position: absolute;
  top: 2px;
  left: 2px;
  width: 18px;
  height: 18px;
  border-radius: 999px;
  background: #fff;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
  transition: transform 140ms ease;
}

.themeInput:checked + .themeSlider {
  background: var(--accent);
  border-color: var(--accent);
}

.themeInput:checked + .themeSlider::after {
  transform: translateX(19px);
}

.prefRowMeta {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.prefSubList {
  margin: 4px 0 8px;
  border: 1px solid var(--border);
  border-radius: 8px;
  max-height: 240px;
  overflow: auto;
}

.prefSubItem {
  border-radius: 0;
}

.countyPills {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  max-height: 300px;
  overflow: auto;
  padding: 2px 0;
}

.countyPill {
  border: 1px solid #d1d5db;
  border-radius: 999px;
  background: #fff;
  color: #374151;
  padding: 7px 12px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
}

.countyPill:hover {
  background: #f9fafb;
}

.countyPill.active {
  border-color: rgba(255, 152, 0, 0.55);
  background: var(--accent-soft);
  color: #9a3412;
}

.drawerSectionTitle {
  padding: 8px 12px 6px;
  color: #6b7280;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.drawerLabel {
  color: var(--text);
  font-weight: 500;
}

.drawerCount {
  color: #374151;
  font-size: 13px;
  font-weight: 600;
}

.drawerBadge {
  display: inline-block;
  margin-left: 8px;
  border: 1px solid rgba(255, 152, 0, 0.35);
  background: rgba(255, 152, 0, 0.2);
  color: #9a3412;
  border-radius: 999px;
  padding: 2px 6px;
  font-size: 11px;
}

.featuredCard {
  position: relative;
  min-height: clamp(250px, 47vh, 420px);
  margin-bottom: 14px;
  border-radius: 8px;
  border: 1px solid var(--border);
  overflow: hidden;
  cursor: pointer;
  background: #222;
}

.featuredImage {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center top;
}

.featuredFallback {
  background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
}

.featuredOverlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(105deg, rgba(0, 0, 0, 0.72) 0%, rgba(0, 0, 0, 0.52) 42%, rgba(0, 0, 0, 0.18) 100%);
}

.featuredContent {
  position: absolute;
  left: clamp(16px, 3.5vw, 44px);
  right: clamp(16px, 3.5vw, 44px);
  bottom: clamp(16px, 3.3vw, 38px);
  z-index: 2;
  max-width: 760px;
  max-height: calc(100% - 28px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}

.featuredSource {
  margin-bottom: 8px;
  color: rgba(255, 255, 255, 0.82);
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.featuredTitle {
  margin: 0 0 10px;
  color: #f8fafc;
  font-size: clamp(31px, 4.3vw, 56px);
  line-height: 1.12;
  padding-top: 2px;
  font-weight: 500;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.featuredSummary {
  margin: 0;
  max-width: 720px;
  color: #f3f4f6;
  font-size: clamp(19px, 2vw, 32px);
  line-height: 1.2;
  font-weight: 600;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.featuredReadMore {
  margin-top: 14px;
  color: var(--accent);
  font-size: 15px;
  font-weight: 700;
  text-transform: uppercase;
}

.postGrid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
}

.postCard {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 130ms ease, box-shadow 130ms ease;
}

.postCard:hover {
  transform: translateY(-2px);
  box-shadow: 0 18px 28px rgba(17, 24, 39, 0.16);
}

.postCard:focus-visible,
.featuredCard:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.postImage {
  width: 100%;
  height: 170px;
  object-fit: cover;
  border-bottom: 1px solid var(--border);
  background: #e5e7eb;
}

.postImageFallback {
  background: linear-gradient(140deg, #d1d5db 0%, #e5e7eb 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

.postImageFallbackText {
  font-size: 12px;
  font-weight: 800;
  letter-spacing: 0.08em;
  color: #4b5563;
  text-transform: uppercase;
  text-align: center;
  padding: 0 10px;
}

.postBody {
  padding: 10px 12px 12px;
}

.source {
  color: #1d4ed8;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 6px;
}

.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 8px;
}

.chip {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  padding: 3px 8px;
  border: 1px solid #d1d5db;
  color: #4b5563;
  font-size: 11px;
  line-height: 1;
}

.postTitle {
  margin: 0 0 8px;
  color: var(--text);
  font-size: 25px;
  line-height: 1.2;
  font-weight: 500;
}

.postSummary {
  margin: 0 0 10px;
  color: #374151;
  font-size: 14px;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.postFooter {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.postTime {
  color: #4b5563;
  font-size: 13px;
  font-style: italic;
  font-weight: 700;
}

.postActions {
  display: flex;
  align-items: center;
  gap: 6px;
}

.iconAction {
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid transparent;
  background: transparent;
  color: #6b7280;
  display: grid;
  place-items: center;
  cursor: pointer;
}

.iconAction:hover {
  border-color: #d1d5db;
  background: #f9fafb;
}

.iconAction.active {
  color: var(--accent);
}

.postActionIcon {
  width: 18px;
  height: 18px;
}

.meta {
  margin-top: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  color: var(--muted);
  font-size: 12px;
}

.btn {
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  border-radius: 8px;
  padding: 9px 12px;
  font-weight: 600;
  cursor: pointer;
}

.btn:hover:not(:disabled) {
  background: var(--surface-soft);
}

.btn.primary {
  border-color: rgba(255, 152, 0, 0.55);
  background: var(--accent-soft);
  color: #9a3412;
}

.btn.block {
  width: 100%;
}

.btn:disabled {
  opacity: 0.55;
  cursor: not-allowed;
}

.pill {
  display: inline-flex;
  align-items: center;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  padding: 7px 11px;
  font-size: 12px;
  color: #374151;
  background: #fff;
}

.searchInput {
  width: 100%;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #fff;
  color: var(--text);
  padding: 10px 11px;
}

.searchInput::placeholder {
  color: #9ca3af;
}

.hiddenFileInput {
  display: none;
}

.filePickerRow {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.filePickerName {
  color: var(--muted);
  font-size: 12px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100%;
}

.lostFoundPolicyCard {
  padding: 14px;
  margin-bottom: 12px;
}

.lostFoundPolicyHeading {
  font-size: 13px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #4b5563;
}

.lostFoundPolicyText {
  margin-top: 6px;
  font-size: 13px;
  color: var(--muted);
}

.lostFoundPolicyList {
  margin: 8px 0 0;
  padding-left: 20px;
  color: var(--muted);
  font-size: 13px;
  line-height: 1.45;
}

.lostFoundPostCard {
  margin-bottom: 14px;
  border-top: 1px solid var(--border);
  padding-top: 12px;
}

.lostFoundImage {
  width: 100%;
  height: auto;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #f9fafb;
  object-fit: contain;
  display: block;
}

.lostFoundCommentHeader {
  margin-top: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.lostFoundCommentCount {
  font-size: 12px;
  color: var(--muted);
}

.lostFoundComments {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px;
  background: var(--surface-soft);
}

.lostFoundCommentItem {
  border-top: 1px solid var(--border);
  padding-top: 8px;
  margin-top: 8px;
}

.lostFoundCommentItem:first-child {
  border-top: 0;
  padding-top: 0;
  margin-top: 0;
}

.lostFoundCommentMeta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 4px;
}

.lostFoundCommentAuthor {
  font-weight: 700;
  color: var(--text);
}

.lostFoundCommentBody {
  font-size: 14px;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-word;
}

.lostFoundCommentForm {
  margin-top: 10px;
  display: grid;
  gap: 8px;
}

.lostFoundCommentTerms {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--muted);
}

.lostFoundCommentMuted {
  font-size: 12px;
  color: var(--muted);
}

.listStatus {
  text-align: center;
  color: var(--muted);
  font-size: 12px;
  padding: 14px 0 22px;
}

.bottomNav {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 45;
  height: calc(72px + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  background: var(--nav-bg);
  border-top: 1px solid var(--border);
}

.navBtn {
  border: 0;
  background: transparent;
  color: #6b7280;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  cursor: pointer;
}

.navBtn.active {
  color: var(--accent);
}

.navIcon {
  width: 20px;
  height: 20px;
}

.navLabel {
  font-size: 11px;
  line-height: 1;
  font-weight: 600;
}

.drawerOverlay {
  position: fixed;
  inset: 0;
  z-index: 40;
  background: rgba(0, 0, 0, 0.42);
}

.drawer {
  position: fixed;
  z-index: 41;
  top: 0;
  left: 0;
  bottom: 0;
  width: min(86vw, 340px);
  background: #fff;
  border-right: 1px solid #d1d5db;
  box-shadow: 0 20px 34px rgba(0, 0, 0, 0.25);
  display: flex;
  flex-direction: column;
}

.drawerHeader {
  min-height: 56px;
  display: flex;
  align-items: center;
  padding: 0 14px;
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  border-bottom: 1px solid var(--border);
}

.drawerList {
  overflow: auto;
  padding: 8px 0 14px;
}

.drawerNav .drawerItem {
  margin: 2px 10px;
  border-radius: 8px;
}

.drawerItem {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 11px 12px;
  cursor: pointer;
  border: 1px solid transparent;
}

.drawerItem:hover {
  background: #f3f4f6;
}

.drawerItem.active {
  background: var(--accent-soft);
  border-color: rgba(255, 152, 0, 0.3);
}

.drawerLabel {
  flex: 1;
}

.webviewCard {
  padding: 12px;
}

.webviewTop {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 10px;
}

.webviewUrl {
  color: var(--muted);
  font-size: 12px;
  word-break: break-word;
}

.webviewActions {
  display: flex;
  gap: 8px;
}

.webviewFrame {
  width: 100%;
  height: 65vh;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: #fff;
}

.webviewHint {
  margin-top: 10px;
  color: var(--muted);
  font-size: 12px;
}

.weatherWidget {
  padding: 14px;
  background: linear-gradient(150deg, #f8fbff 0%, #ffffff 65%);
}

.weatherTop {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
}

.weatherCounty {
  font-size: 24px;
  font-weight: 800;
  line-height: 1.1;
}

.weatherSub {
  margin-top: 4px;
  color: var(--muted);
  font-size: 13px;
}

.weatherGlyph {
  font-size: 38px;
  line-height: 1;
}

.weatherSummary {
  margin-top: 10px;
  font-size: 14px;
  color: #1f2937;
}

.weatherActions {
  margin-top: 12px;
  display: flex;
  gap: 8px;
}

.weatherPeriodGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
}

.weatherPeriodCard {
  border: 1px solid var(--border);
  border-radius: 8px;
  background: #f9fafb;
  padding: 10px;
}

.weatherPeriodHead {
  font-size: 12px;
  color: #6b7280;
  margin-bottom: 4px;
}

.weatherPeriodTemp {
  font-size: 18px;
  font-weight: 800;
  margin-bottom: 4px;
}

.weatherPeriodText {
  font-size: 12px;
  color: #374151;
  line-height: 1.3;
}

.readerPad {
  padding: 14px;
}

.readerMeta {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 8px;
}

.readerTitle {
  margin: 8px 0 10px;
  color: var(--text);
  font-size: 28px;
  line-height: 1.2;
  font-weight: 700;
}

.readerUrl {
  color: var(--muted);
  font-size: 12px;
  word-break: break-word;
}

.readerBody {
  margin-top: 12px;
  line-height: 1.6;
  font-size: 15px;
  color: #111827;
}

.readerBody p {
  margin: 0 0 12px;
}

.readerBottomActions {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid var(--border);
}

.readerIconAction {
  width: 38px;
  height: 38px;
}

.readerOpenOriginalBtn {
  margin-left: auto;
}

.hero {
  width: 100%;
  border-radius: 8px;
  border: 1px solid var(--border);
  object-fit: cover;
}

.cardRow {
  border-radius: 8px;
}

.unread .postTitle,
.unread .featuredTitle {
  font-weight: 700;
}

@media (min-width: 768px) {
  .postGrid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (min-width: 1040px) {
  .postGrid {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}

@media (min-width: 992px) {
  .topbar .title {
    font-size: 32px;
  }

  .content {
    padding-bottom: 18px;
  }

  .bottomNav {
    display: none;
  }
}

@media (max-width: 640px) {
  .topbar .title {
    font-size: 21px;
  }

  .brandLogo {
    width: 40px;
    height: 40px;
  }

  .section {
    padding: 10px;
  }

  .featuredTitle {
    font-size: clamp(26px, 9.2vw, 40px);
  }

  .featuredCard {
    min-height: clamp(220px, 48vh, 340px);
  }

  .featuredSummary {
    font-size: clamp(17px, 5vw, 25px);
    -webkit-line-clamp: 3;
  }

  .featuredReadMore {
    font-size: 13px;
  }

  .postTitle {
    font-size: 23px;
  }

  .postSummary {
    font-size: 14px;
  }

  .postTime {
    font-size: 13px;
  }
}

```

# apps\web\src\vite-env.d.ts

```ts
/// <reference types="vite/client" />
/// <reference types="vite-plugin-pwa/client" />

```

# apps\web\tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "Bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true
  },
  "include": ["src"]
}

```

# apps\web\vite.config.ts

```ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    host: "127.0.0.1",
    port: 5173,
    strictPort: true,
    proxy: {
      "/api": "http://localhost:8787"
    }
  }
});

```

# cloudflare\README.md

```md
# Cloudflare Bootstrap

This folder contains starter config for Worker migration.

- `wrangler.example.toml` is a template.
- Full migration plan is documented in `docs/09_CLOUDFLARE_DEPLOYMENT.md`.

```

# cloudflare\wrangler.example.toml

```toml
name = "ekn-api"
main = "src/index.ts"
compatibility_date = "2026-02-20"

[vars]
NWS_USER_AGENT = "EasternKentuckyNews/1.0 (admin@example.com)"

[[d1_databases]]
binding = "DB"
database_name = "ekn-prod"
database_id = "REPLACE_ME"

[[r2_buckets]]
binding = "LOST_FOUND_BUCKET"
bucket_name = "ekn-lost-found-prod"

```

# County School Facebook and Websites.md

```md
Adair County — Adair County Schools — Facebook: https://www.facebook.com/adaircoschools/
 .
Official site: https://www.adair.kyschools.us/
 .

Allen County — Allen County-Scottsville High School (district presence on site; school Facebook used where district FB not prominent) — Facebook (high school): https://www.facebook.com/allencountyscottsvillehighschool/
 .
Official site (district): https://www.allen.kyschools.us/
 .

Anderson County — Anderson County Schools — Facebook: https://www.facebook.com/acboe/
 .
Official site: https://www.anderson.k12.ky.us/
 .

Ballard County — Ballard County Schools — Facebook: https://www.facebook.com/100063755730159/
 .
Official site: https://ballard.kyschools.us/
 .

Barren County — Barren County Schools — Facebook: https://www.facebook.com/barrenschools/
 .
Official site: https://www.barren.kyschools.us/
 .

Bath County — Bath County Schools — Facebook: https://www.facebook.com/BathCountySchoolsKY/
 .
Official site: https://www.bath.k12.ky.us/
 .

Bell County — Bell County School District — Facebook: https://www.facebook.com/BellCountySchoolDistrict/
 .
Official site: https://www.bell.kyschools.us/
 .

Boone County — The Boone County Schools — Facebook: https://www.facebook.com/TheBooneCountySchools/
 .
Official site: https://www.boone.kyschools.us/
 .

Bourbon County — Bourbon County School District — Facebook: https://www.facebook.com/BourbonCountySchools/
 .
Official site: https://www.bourbon.kyschools.us/
 .

Boyd County — Boyd County Public School District — Facebook: https://www.facebook.com/100065164023982/
 (official district page / mentions).
Official site: https://www.boyd.kyschools.us/
 .

Boyle County — Boyle County Schools — Facebook: https://www.facebook.com/boylecounty/
 .
Official site: https://www.boyle.kyschools.us/
 .

Bracken County — Bracken County Community Schools — Facebook: https://www.facebook.com/61556398710103/
 (district page) and https://www.facebook.com/BrackenCountySchools/
 .
(District site link commonly shown on FB pages.)

Breathitt County — Breathitt County Schools — Facebook: https://www.facebook.com/BreathittCountySchools/
 .
(Also many school-level pages like Breathitt Elementary.)

Breckinridge County — Breckinridge County School District — Facebook: https://www.facebook.com/breckinridgecountyschools/
 .
Official site: https://www.breck.kyschools.us/
 .

Bullitt County — Bullitt County Public Schools — Facebook (district & school pages exist; sample school pages: Bullitt Central, North Bullitt): e.g. https://www.facebook.com/KYSCHOOLSAFETY/posts/bullitt-county-public-schools/929401269335737/
 (district posts) and school pages like https://www.facebook.com/NBHSEagles/
 (North Bullitt).
Official site: https://www.bullitt.k12.ky.us/
 .

Butler County — Butler County Schools — Facebook: https://www.facebook.com/ButlerCountySchools/
 .
(District site available via district listing pages.)

Caldwell County — Caldwell County Schools — Facebook: https://www.facebook.com/CaldwellCountySchools/
 .
Official site: https://www.caldwellschools.com/
 .

Calloway County — Calloway County Schools — Facebook: https://www.facebook.com/callowaycoschools/
 .
Official site: https://www.calloway.kyschools.us/
 .

Campbell County — Campbell County Schools (KY) — Facebook: https://www.facebook.com/ccschoo1s/
 (official district page presence).
Official site: https://www.campbell.kyschools.us/
 .

Carlisle County — Carlisle County Public Schools — Facebook: https://www.facebook.com/carlislecountypublicschools/
 .
Official site: https://www.carlisle.kyschools.us/
 .

 Carroll County — Carroll County Schools (KY)
Facebook: https://www.facebook.com/CarrollCountySchoolsKY/

Website: https://www.carroll.kyschools.us/

Carter County — Carter County Schools
Facebook: https://www.facebook.com/CarterCountySchoolsKY/

Website: https://www.carter.kyschools.us/

Casey County — Casey County Schools
Facebook: https://www.facebook.com/CaseyCountySchools/

Website: https://www.casey.kyschools.us/

Christian County — Christian County Public Schools
Facebook: https://www.facebook.com/ChristianCountyPublicSchools/

Website: https://www.christian.kyschools.us/

Clark County — Clark County Public Schools (KY)
Facebook: https://www.facebook.com/ClarkCountyPublicSchoolsKY/

Website: https://www.clarkschools.net/

Clay County — Clay County Public Schools
Facebook: https://www.facebook.com/ClayCountyPublicSchools/

Website: https://www.clay.kyschools.us/

Clinton County — Clinton County Schools
Facebook: https://www.facebook.com/ClintonCountySchoolsKY/

Website: https://www.clinton.kyschools.us/

Crittenden County — Crittenden County Schools
Facebook: https://www.facebook.com/CrittendenCountySchools/

Website: https://www.crittenden.kyschools.us/

Cumberland County — Cumberland County Schools (KY)
Facebook: https://www.facebook.com/CumberlandCountySchoolsKY/

Website: https://www.cumberland.kyschools.us/

Daviess County — Daviess County Public Schools
Facebook: https://www.facebook.com/DCPSchools/

Website: https://www.dcps.org/

Edmonson County — Edmonson County Schools
Facebook: https://www.facebook.com/EdmonsonCoSchools/

Website: https://www.edmonson.kyschools.us/

Elliott County — Elliott County Schools
Facebook: https://www.facebook.com/ElliottCoSchools/

Website: https://www.elliott.kyschools.us/

Estill County — Estill County Schools
Facebook: https://www.facebook.com/EstillCountySchools/

Website: https://www.estill.k12.ky.us/

Fayette County — Fayette County Public Schools (FCPS)
Facebook: https://www.facebook.com/fayettecountyschools/

Website: https://www.fcps.net/

Fleming County — Fleming County Schools
Facebook: https://www.facebook.com/FlemingCountySchools/

Website: https://www.fleming.kyschools.us/

Floyd County — Floyd County Schools
Facebook: https://www.facebook.com/floydcountyschools/

Website: https://www.floyd.kyschools.us/

Franklin County — Franklin County Public Schools
Facebook: https://www.facebook.com/FranklinCountySchoolsKY/

Website: https://www.franklin.kyschools.us/

Fulton County — Fulton County Public Schools
Facebook: https://www.facebook.com/FultonCountySchoolDistrict/

Website: https://www.fulton.kyschools.us/

Gallatin County — Gallatin County Schools
Facebook: https://www.facebook.com/GallatinCountySchoolsKY/

Website: https://www.gallatin.kyschools.us/

Garrard County — Garrard County Schools
Facebook: https://www.facebook.com/GarrardCountySchools/

Website: https://www.garrard.kyschools.us/

Grant County — Grant County Schools (KY)
Facebook: https://www.facebook.com/GrantCountySchoolsKY/

Website: https://www.grant.kyschools.us/

Graves County — Graves County Schools
Facebook: https://www.facebook.com/GravesCountySchoolsKY/

Website: https://www.graves.kyschools.us/

Grayson County — Grayson County Schools
Facebook: https://www.facebook.com/GraysonCountySchools/

Website: https://www.grayson.kyschools.us/

Green County — Green County Schools
Facebook: https://www.facebook.com/GreenCountySchoolsKY/

Website: https://www.green.kyschools.us/

Greenup County — Greenup County Schools
Facebook: https://www.facebook.com/GreenupCountySchoolsKY/

Website: https://www.greenup.kyschools.us/

Hancock County — Hancock County Schools
Facebook: https://www.facebook.com/HancockCoSchoolsKY/

Website: https://www.hancock.kyschools.us/

Hardin County — Hardin County Schools
📘 Facebook: https://www.facebook.com/HardinCountySchoolsKY/

🌐 Website: https://www.hardin.kyschools.us/

Harlan County — Harlan County Public Schools
📘 Facebook: https://www.facebook.com/HarlanCountyPublicSchools/

🌐 Website: https://www.harlan.kyschools.us/

Harrison County — Harrison County Schools
📘 Facebook: https://www.facebook.com/HarrisonCountySchoolsKY/

🌐 Website: https://www.harrison.kyschools.us/

Hart County — Hart County Schools
📘 Facebook: https://www.facebook.com/HartCountySchoolsKY/

🌐 Website: https://www.hart.kyschools.us/

Henderson County — Henderson County Schools
📘 Facebook: https://www.facebook.com/HendersonCountySchoolsKY/

🌐 Website: https://www.henderson.kyschools.us/

Henry County — Henry County Schools
📘 Facebook: https://www.facebook.com/HenryCountySchools/

🌐 Website: https://www.henry.kyschools.us/

Hickman County — Hickman County Schools
📘 Facebook: https://www.facebook.com/HickmanCountySchoolsKY/

🌐 Website: https://www.hickman.kyschools.us/

Hopkins County — Hopkins County Schools
📘 Facebook: https://www.facebook.com/hopkinscountyschools/

🌐 Website: https://www.hopkins.kyschools.us/

Jackson County — Jackson County Public Schools
📘 Facebook: https://www.facebook.com/JacksonCountyPublicSchoolsKY/

🌐 Website: https://www.jackson.kyschools.us/

Jefferson County — Jefferson County Public Schools (JCPS)
📘 Facebook: https://www.facebook.com/JCPSKY/

🌐 Website: https://www.jefferson.kyschools.us/

Jessamine County — Jessamine County Schools
📘 Facebook: https://www.facebook.com/JessamineCountyKY/

🌐 Website: https://www.jessamine.kyschools.us/

Johnson County — Johnson County Schools
📘 Facebook: https://www.facebook.com/JohnsonCountySchoolsKY/

🌐 Website: https://www.johnson.kyschools.us/

Kenton County — Kenton County School District (KCSD)
📘 Facebook: https://www.facebook.com/KentonCountySchoolDistrict/

🌐 Website: https://www.kenton.kyschools.us/

Knott County — Knott County Schools
📘 Facebook: https://www.facebook.com/KnottCountySchools/

🌐 Website: https://www.knott.kyschools.us/

Knox County — Knox County Schools
📘 Facebook: https://www.facebook.com/KnoxCountySchoolDistrictKY/

🌐 Website: https://www.knox.kyschools.us/

LaRue County — LaRue County Schools
📘 Facebook: https://www.facebook.com/LaRueCountySchools/

🌐 Website: https://www.larue.kyschools.us/

Laurel County — Laurel County Public Schools
📘 Facebook: https://www.facebook.com/LaurelCountyPublicSchoolsKY/

🌐 Website: https://www.laurel.kyschools.us/

Lawrence County — Lawrence County Schools
📘 Facebook: https://www.facebook.com/LawrenceCountySchoolsKY/

🌐 Website: https://www.lawrence.kyschools.us/

Lee County — Lee County Schools
📘 Facebook: https://www.facebook.com/LeeCountySchoolsKY/

🌐 Website: https://www.leecounty.k12.ky.us/

Leslie County — Leslie County Schools
📘 Facebook: https://www.facebook.com/LeslieCountySchools/

🌐 Website: https://www.leslie.kyschools.us/

Letcher County — Letcher County Schools
📘 Facebook: https://www.facebook.com/LetcherCountySchools/

🌐 Website: https://www.letcher.k12.ky.us/

Lewis County — Lewis County Schools
📘 Facebook: https://www.facebook.com/LewisCoSchools/

🌐 Website: https://www.lewis.kyschools.us/

Lincoln County — Lincoln County Schools
📘 Facebook: https://www.facebook.com/LincolnCountySchoolsKY/

🌐 Website: https://www.lincoln.kyschools.us/

Livingston County — Livingston County Schools
📘 Facebook: https://www.facebook.com/LivingstonCountyKY/

🌐 Website: https://www.livingston.kyschools.us/

Logan County — Logan County Schools
📘 Facebook: https://www.facebook.com/LoganCountySchoolsKY/

🌐 Website: https://www.logan.kyschools.us/

Lyon County — Lyon County Schools
📘 Facebook: https://www.facebook.com/LyonCountySchoolsKY/

🌐 Website: https://www.lyon.kyschools.us/

McCracken County — McCracken County Public Schools
📘 Facebook: https://www.facebook.com/McCrackenCountyPublicSchools/

🌐 Website: https://www.mccracken.kyschools.us/

McCreary County — McCreary County Schools
📘 Facebook: https://www.facebook.com/McCrearyCountySchools/

🌐 Website: https://www.mccreary.kyschools.us/

Metcalfe County — Metcalfe County Schools
📘 Facebook: https://www.facebook.com/MetcalfeCountySchoolsKY/

🌐 Website: https://www.metcalfe.kyschools.us/

Monroe County — Monroe County Schools (KY)
📘 Facebook: https://www.facebook.com/MonroeCountySchoolsKY/

🌐 Website: https://www.monroe.kyschools.us/

Montgomery County — Montgomery County Schools
📘 Facebook: https://www.facebook.com/MontgomeryCountyKYSchools/

🌐 Website: https://www.montgomery.kyschools.us/

Morgan County — Morgan County Schools
📘 Facebook: https://www.facebook.com/MorganCountySchoolsKY/

🌐 Website: https://www.morgan.kyschools.us/

Muhlenberg County — Muhlenberg County Schools
📘 Facebook: https://www.facebook.com/MuhlenbergCountySchools/

🌐 Website: https://www.muhlenberg.kyschools.us/

Nelson County — Nelson County Schools
📘 Facebook: https://www.facebook.com/NelsonCountyKySchools/

🌐 Website: https://www.nelson.kyschools.us/

Nicholas County — Nicholas County Schools
📘 Facebook: https://www.facebook.com/NicholasCountySchoolsKY/

🌐 Website: https://www.nicholas.kyschools.us/

Ohio County — Ohio County Schools
📘 Facebook: https://www.facebook.com/OhioCountySchoolsKY/

🌐 Website: https://www.ohio.kyschools.us/

Oldham County — Oldham County Schools
📘 Facebook: https://www.facebook.com/OldhamCountySchools/

🌐 Website: https://www.oldham.kyschools.us/

Owen County — Owen County Schools
📘 Facebook: https://www.facebook.com/OwenCountySchoolsKY/

🌐 Website: https://www.owen.kyschools.us/

Owsley County — Owsley County Schools
📘 Facebook: https://www.facebook.com/OwsleyCountySchoolsKY/

🌐 Website: https://www.owsley.kyschools.us/

Pendleton County — Pendleton County Schools
📘 Facebook: https://www.facebook.com/PendletonCountySchoolsKY/

🌐 Website: https://www.pendleton.kyschools.us/

Perry County — Perry County Schools
📘 Facebook: https://www.facebook.com/PerryCountySchoolsKY/

🌐 Website: https://www.perry.kyschools.us/

Pike County — Pike County Schools
📘 Facebook: https://www.facebook.com/PikeCountySchoolsKY/

🌐 Website: https://www.pike.kyschools.us/

Powell County — Powell County Schools
📘 Facebook: https://www.facebook.com/PowellCountySchoolsKY/

🌐 Website: https://www.powell.kyschools.us/

Pulaski County — Pulaski County Schools
📘 Facebook: https://www.facebook.com/pulaskicountyschools/

🌐 Website: https://www.pulaski.kyschools.us/

Robertson County — Robertson County Schools
📘 Facebook: https://www.facebook.com/RobertsonCountySchools/

🌐 Website: https://www.robertson.kyschools.us/

Rockcastle County — Rockcastle County Schools
📘 Facebook: https://www.facebook.com/RockcastleCountySchoolsKY/

🌐 Website: https://www.rockcastle.kyschools.us/

Rowan County — Rowan County Schools
📘 Facebook: https://www.facebook.com/RowanCountySchoolsKY/

🌐 Website: https://www.rowan.kyschools.us/

Russell County — Russell County Schools
📘 Facebook: https://www.facebook.com/RussellCountySchoolsKY/

🌐 Website: https://www.russell.kyschools.us/

Scott County — Scott County Schools
📘 Facebook: https://www.facebook.com/scottcountyschools/

🌐 Website: https://www.scott.kyschools.us/

Shelby County — Shelby County Schools
📘 Facebook: https://www.facebook.com/ShelbyCountyPublicSchoolsKY/

🌐 Website: https://www.shelby.kyschools.us/

Simpson County — Simpson County Schools
📘 Facebook: https://www.facebook.com/SimpsonCountySchoolsKY/

🌐 Website: https://www.simpson.kyschools.us/

Spencer County — Spencer County Schools
📘 Facebook: https://www.facebook.com/SpencerCoKYSchools/

🌐 Website: https://www.spencer.kyschools.us/

Taylor County — Taylor County Schools
📘 Facebook: https://www.facebook.com/TaylorCountySchoolsKY/

🌐 Website: https://www.taylor.kyschools.us/

Todd County — Todd County Schools
📘 Facebook: https://www.facebook.com/toddcountyschools/

🌐 Website: https://www.todd.kyschools.us/

Trigg County — Trigg County Schools
📘 Facebook: https://www.facebook.com/TriggCountySchools/

🌐 Website: https://www.trigg.kyschools.us/

Trimble County — Trimble County Schools
📘 Facebook: https://www.facebook.com/TrimbleCountySchoolsKY/

🌐 Website: https://www.trimble.kyschools.us/

Union County — Union County Schools
📘 Facebook: https://www.facebook.com/UnionCountySchoolDistrict/

🌐 Website: https://www.union.kyschools.us/

Warren County — Warren County Public Schools
📘 Facebook: https://www.facebook.com/WarrenCountySchools/

🌐 Website: https://www.warren.kyschools.us/

Washington County — Washington County Schools
📘 Facebook: https://www.facebook.com/WashingtonCountyKYSchools/

🌐 Website: https://www.washington.kyschools.us/

Wayne County — Wayne County Schools
📘 Facebook: https://www.facebook.com/WayneCountySchoolDistrict/

🌐 Website: https://www.wayne.kyschools.us/

Webster County — Webster County Schools
📘 Facebook: https://www.facebook.com/WebsterCountySchoolsKY/

🌐 Website: https://www.webster.kyschools.us/

Whitley County — Whitley County School District
📘 Facebook: https://www.facebook.com/WhitleyCountySchoolDistrict/

🌐 Website: https://www.whitley.kyschools.us/

Wolfe County — Wolfe County Schools
📘 Facebook: https://www.facebook.com/WolfeCountyKYSchools/

🌐 Website: https://www.wolfe.kyschools.us/

Woodford County — Woodford County Schools
📘 Facebook: https://www.facebook.com/WoodfordCountySchools/

🌐 Website: https://www.woodford.kyschools.us/
```

# data\county-coverage-latest.json

```json
[
  {
    "county": "Adair",
    "articles_all_time": 179,
    "articles_last_7_days": 4
  },
  {
    "county": "Allen",
    "articles_all_time": 106,
    "articles_last_7_days": 24
  },
  {
    "county": "Anderson",
    "articles_all_time": 104,
    "articles_last_7_days": 12
  },
  {
    "county": "Ballard",
    "articles_all_time": 77,
    "articles_last_7_days": 0
  },
  {
    "county": "Barren",
    "articles_all_time": 135,
    "articles_last_7_days": 15
  },
  {
    "county": "Bath",
    "articles_all_time": 94,
    "articles_last_7_days": 0
  },
  {
    "county": "Bell",
    "articles_all_time": 113,
    "articles_last_7_days": 20
  },
  {
    "county": "Boone",
    "articles_all_time": 190,
    "articles_last_7_days": 15
  },
  {
    "county": "Bourbon",
    "articles_all_time": 132,
    "articles_last_7_days": 31
  },
  {
    "county": "Boyd",
    "articles_all_time": 137,
    "articles_last_7_days": 23
  },
  {
    "county": "Boyle",
    "articles_all_time": 124,
    "articles_last_7_days": 12
  },
  {
    "county": "Bracken",
    "articles_all_time": 92,
    "articles_last_7_days": 1
  },
  {
    "county": "Breathitt",
    "articles_all_time": 188,
    "articles_last_7_days": 26
  },
  {
    "county": "Breckinridge",
    "articles_all_time": 87,
    "articles_last_7_days": 0
  },
  {
    "county": "Bullitt",
    "articles_all_time": 128,
    "articles_last_7_days": 3
  },
  {
    "county": "Butler",
    "articles_all_time": 96,
    "articles_last_7_days": 2
  },
  {
    "county": "Caldwell",
    "articles_all_time": 124,
    "articles_last_7_days": 11
  },
  {
    "county": "Calloway",
    "articles_all_time": 156,
    "articles_last_7_days": 40
  },
  {
    "county": "Campbell",
    "articles_all_time": 109,
    "articles_last_7_days": 11
  },
  {
    "county": "Carlisle",
    "articles_all_time": 94,
    "articles_last_7_days": 1
  },
  {
    "county": "Carroll",
    "articles_all_time": 92,
    "articles_last_7_days": 4
  },
  {
    "county": "Carter",
    "articles_all_time": 113,
    "articles_last_7_days": 19
  },
  {
    "county": "Casey",
    "articles_all_time": 96,
    "articles_last_7_days": 4
  },
  {
    "county": "Christian",
    "articles_all_time": 125,
    "articles_last_7_days": 17
  },
  {
    "county": "Clark",
    "articles_all_time": 107,
    "articles_last_7_days": 11
  },
  {
    "county": "Clay",
    "articles_all_time": 98,
    "articles_last_7_days": 3
  },
  {
    "county": "Clinton",
    "articles_all_time": 97,
    "articles_last_7_days": 3
  },
  {
    "county": "Crittenden",
    "articles_all_time": 94,
    "articles_last_7_days": 1
  },
  {
    "county": "Cumberland",
    "articles_all_time": 86,
    "articles_last_7_days": 0
  },
  {
    "county": "Daviess",
    "articles_all_time": 171,
    "articles_last_7_days": 35
  },
  {
    "county": "Edmonson",
    "articles_all_time": 107,
    "articles_last_7_days": 13
  },
  {
    "county": "Elliott",
    "articles_all_time": 105,
    "articles_last_7_days": 0
  },
  {
    "county": "Estill",
    "articles_all_time": 89,
    "articles_last_7_days": 0
  },
  {
    "county": "Fayette",
    "articles_all_time": 727,
    "articles_last_7_days": 70
  },
  {
    "county": "Fleming",
    "articles_all_time": 94,
    "articles_last_7_days": 2
  },
  {
    "county": "Floyd",
    "articles_all_time": 114,
    "articles_last_7_days": 3
  },
  {
    "county": "Franklin",
    "articles_all_time": 220,
    "articles_last_7_days": 72
  },
  {
    "county": "Fulton",
    "articles_all_time": 81,
    "articles_last_7_days": 3
  },
  {
    "county": "Gallatin",
    "articles_all_time": 109,
    "articles_last_7_days": 0
  },
  {
    "county": "Garrard",
    "articles_all_time": 106,
    "articles_last_7_days": 0
  },
  {
    "county": "Grant",
    "articles_all_time": 100,
    "articles_last_7_days": 0
  },
  {
    "county": "Graves",
    "articles_all_time": 121,
    "articles_last_7_days": 19
  },
  {
    "county": "Grayson",
    "articles_all_time": 94,
    "articles_last_7_days": 10
  },
  {
    "county": "Green",
    "articles_all_time": 90,
    "articles_last_7_days": 0
  },
  {
    "county": "Greenup",
    "articles_all_time": 99,
    "articles_last_7_days": 3
  },
  {
    "county": "Hancock",
    "articles_all_time": 94,
    "articles_last_7_days": 12
  },
  {
    "county": "Hardin",
    "articles_all_time": 112,
    "articles_last_7_days": 20
  },
  {
    "county": "Harlan",
    "articles_all_time": 142,
    "articles_last_7_days": 13
  },
  {
    "county": "Harrison",
    "articles_all_time": 110,
    "articles_last_7_days": 1
  },
  {
    "county": "Hart",
    "articles_all_time": 115,
    "articles_last_7_days": 2
  },
  {
    "county": "Henderson",
    "articles_all_time": 112,
    "articles_last_7_days": 6
  },
  {
    "county": "Henry",
    "articles_all_time": 98,
    "articles_last_7_days": 0
  },
  {
    "county": "Hickman",
    "articles_all_time": 88,
    "articles_last_7_days": 1
  },
  {
    "county": "Hopkins",
    "articles_all_time": 122,
    "articles_last_7_days": 6
  },
  {
    "county": "Jackson",
    "articles_all_time": 106,
    "articles_last_7_days": 4
  },
  {
    "county": "Jefferson",
    "articles_all_time": 303,
    "articles_last_7_days": 73
  },
  {
    "county": "Jessamine",
    "articles_all_time": 117,
    "articles_last_7_days": 15
  },
  {
    "county": "Johnson",
    "articles_all_time": 106,
    "articles_last_7_days": 3
  },
  {
    "county": "Kenton",
    "articles_all_time": 132,
    "articles_last_7_days": 12
  },
  {
    "county": "Knott",
    "articles_all_time": 104,
    "articles_last_7_days": 10
  },
  {
    "county": "Knox",
    "articles_all_time": 119,
    "articles_last_7_days": 10
  },
  {
    "county": "Larue",
    "articles_all_time": 103,
    "articles_last_7_days": 4
  },
  {
    "county": "Laurel",
    "articles_all_time": 119,
    "articles_last_7_days": 25
  },
  {
    "county": "Lawrence",
    "articles_all_time": 100,
    "articles_last_7_days": 2
  },
  {
    "county": "Lee",
    "articles_all_time": 92,
    "articles_last_7_days": 0
  },
  {
    "county": "Leslie",
    "articles_all_time": 103,
    "articles_last_7_days": 13
  },
  {
    "county": "Letcher",
    "articles_all_time": 99,
    "articles_last_7_days": 1
  },
  {
    "county": "Lewis",
    "articles_all_time": 118,
    "articles_last_7_days": 16
  },
  {
    "county": "Lincoln",
    "articles_all_time": 112,
    "articles_last_7_days": 13
  },
  {
    "county": "Livingston",
    "articles_all_time": 96,
    "articles_last_7_days": 4
  },
  {
    "county": "Logan",
    "articles_all_time": 114,
    "articles_last_7_days": 17
  },
  {
    "county": "Lyon",
    "articles_all_time": 120,
    "articles_last_7_days": 11
  },
  {
    "county": "Madison",
    "articles_all_time": 167,
    "articles_last_7_days": 64
  },
  {
    "county": "Magoffin",
    "articles_all_time": 108,
    "articles_last_7_days": 16
  },
  {
    "county": "Marion",
    "articles_all_time": 150,
    "articles_last_7_days": 0
  },
  {
    "county": "Marshall",
    "articles_all_time": 179,
    "articles_last_7_days": 24
  },
  {
    "county": "Martin",
    "articles_all_time": 114,
    "articles_last_7_days": 13
  },
  {
    "county": "Mason",
    "articles_all_time": 125,
    "articles_last_7_days": 6
  },
  {
    "county": "McCracken",
    "articles_all_time": 195,
    "articles_last_7_days": 69
  },
  {
    "county": "McCreary",
    "articles_all_time": 96,
    "articles_last_7_days": 5
  },
  {
    "county": "McLean",
    "articles_all_time": 94,
    "articles_last_7_days": 1
  },
  {
    "county": "Meade",
    "articles_all_time": 96,
    "articles_last_7_days": 1
  },
  {
    "county": "Menifee",
    "articles_all_time": 77,
    "articles_last_7_days": 0
  },
  {
    "county": "Mercer",
    "articles_all_time": 94,
    "articles_last_7_days": 6
  },
  {
    "county": "Metcalfe",
    "articles_all_time": 100,
    "articles_last_7_days": 6
  },
  {
    "county": "Monroe",
    "articles_all_time": 105,
    "articles_last_7_days": 1
  },
  {
    "county": "Montgomery",
    "articles_all_time": 102,
    "articles_last_7_days": 3
  },
  {
    "county": "Morgan",
    "articles_all_time": 96,
    "articles_last_7_days": 1
  },
  {
    "county": "Muhlenberg",
    "articles_all_time": 104,
    "articles_last_7_days": 6
  },
  {
    "county": "Nelson",
    "articles_all_time": 112,
    "articles_last_7_days": 6
  },
  {
    "county": "Nicholas",
    "articles_all_time": 98,
    "articles_last_7_days": 1
  },
  {
    "county": "Ohio",
    "articles_all_time": 103,
    "articles_last_7_days": 6
  },
  {
    "county": "Oldham",
    "articles_all_time": 113,
    "articles_last_7_days": 4
  },
  {
    "county": "Owen",
    "articles_all_time": 105,
    "articles_last_7_days": 1
  },
  {
    "county": "Owsley",
    "articles_all_time": 106,
    "articles_last_7_days": 1
  },
  {
    "county": "Pendleton",
    "articles_all_time": 96,
    "articles_last_7_days": 0
  },
  {
    "county": "Perry",
    "articles_all_time": 117,
    "articles_last_7_days": 6
  },
  {
    "county": "Pike",
    "articles_all_time": 144,
    "articles_last_7_days": 27
  },
  {
    "county": "Powell",
    "articles_all_time": 110,
    "articles_last_7_days": 2
  },
  {
    "county": "Pulaski",
    "articles_all_time": 118,
    "articles_last_7_days": 11
  },
  {
    "county": "Robertson",
    "articles_all_time": 97,
    "articles_last_7_days": 0
  },
  {
    "county": "Rockcastle",
    "articles_all_time": 108,
    "articles_last_7_days": 5
  },
  {
    "county": "Rowan",
    "articles_all_time": 129,
    "articles_last_7_days": 15
  },
  {
    "county": "Russell",
    "articles_all_time": 116,
    "articles_last_7_days": 12
  },
  {
    "county": "Scott",
    "articles_all_time": 106,
    "articles_last_7_days": 5
  },
  {
    "county": "Shelby",
    "articles_all_time": 104,
    "articles_last_7_days": 2
  },
  {
    "county": "Simpson",
    "articles_all_time": 105,
    "articles_last_7_days": 7
  },
  {
    "county": "Spencer",
    "articles_all_time": 95,
    "articles_last_7_days": 7
  },
  {
    "county": "Taylor",
    "articles_all_time": 113,
    "articles_last_7_days": 2
  },
  {
    "county": "Todd",
    "articles_all_time": 103,
    "articles_last_7_days": 8
  },
  {
    "county": "Trigg",
    "articles_all_time": 112,
    "articles_last_7_days": 14
  },
  {
    "county": "Trimble",
    "articles_all_time": 99,
    "articles_last_7_days": 4
  },
  {
    "county": "Union",
    "articles_all_time": 97,
    "articles_last_7_days": 2
  },
  {
    "county": "Warren",
    "articles_all_time": 166,
    "articles_last_7_days": 35
  },
  {
    "county": "Washington",
    "articles_all_time": 100,
    "articles_last_7_days": 1
  },
  {
    "county": "Wayne",
    "articles_all_time": 112,
    "articles_last_7_days": 1
  },
  {
    "county": "Webster",
    "articles_all_time": 111,
    "articles_last_7_days": 2
  },
  {
    "county": "Whitley",
    "articles_all_time": 126,
    "articles_last_7_days": 16
  },
  {
    "county": "Wolfe",
    "articles_all_time": 101,
    "articles_last_7_days": 3
  },
  {
    "county": "Woodford",
    "articles_all_time": 133,
    "articles_last_7_days": 33
  }
]
```

# data\dev.sqlite

This is a binary file of the type: Binary

# data\kypress-home-feeds.json

```json
[
  {
    "county": "Boyd",
    "paper": "Greater Ashland Beacon",
    "site": "https://www.ashlandbeacon.com",
    "feedUrl": "https://www.ashlandbeacon.com/blog-feed.xml",
    "finalUrl": "https://www.ashlandbeacon.com/blog-feed.xml",
    "status": 200
  },
  {
    "county": "Kenton",
    "paper": "LINK nky",
    "site": "https://www.linknky.com",
    "feedUrl": "https://linknky.com/feed/",
    "finalUrl": "https://linknky.com/feed/",
    "status": 200
  },
  {
    "county": "Whitley",
    "paper": "Corbin/Whitley News Journal",
    "site": "https://www.thenewsjournal.net",
    "feedUrl": "https://thenewsjournal.net/feed/",
    "finalUrl": "https://thenewsjournal.net/feed/",
    "status": 200
  },
  {
    "county": "Ohio",
    "paper": "Ohio County Times-News",
    "site": "https://www.octimesnews.com",
    "feedUrl": "https://www.octimesnews.com/feed/",
    "finalUrl": "https://www.octimesnews.com/feed/",
    "status": 200
  },
  {
    "county": "LaRue",
    "paper": "LaRue County Herald News",
    "site": "https://www.laruecountyherald.com",
    "feedUrl": "http://www.pmg-ky2.com/search/?f=rss&amp;t=article&amp;c=larue&amp;l=50&amp;s=start_time&amp;sd=desc",
    "finalUrl": "https://www.pmg-ky2.com/search/?f=rss&amp;t=article&amp;c=larue&amp;l=50&amp;s=start_time&amp;sd=desc",
    "status": 200
  },
  {
    "county": "Adair",
    "paper": "Adair Progress",
    "site": "https://www.adairprogress.com",
    "feedUrl": "https://www.adairprogress.com/feed/",
    "finalUrl": "https://www.adairprogress.com/feed/",
    "status": 200
  },
  {
    "county": "Warren",
    "paper": "College Heights Herald",
    "site": "https://www.wkuherald.com",
    "feedUrl": "https://wkuherald.com/feed/",
    "finalUrl": "https://wkuherald.com/feed/",
    "status": 200
  },
  {
    "county": "Marion",
    "paper": "Lebanon Enterprise",
    "site": "https://www.lebanonenterprise.com",
    "feedUrl": "http://www.pmg-ky2.com/search/?f=rss&amp;t=article&amp;c=lebanon&amp;l=50&amp;s=start_time&amp;sd=desc",
    "finalUrl": "https://www.pmg-ky2.com/search/?f=rss&amp;t=article&amp;c=lebanon&amp;l=50&amp;s=start_time&amp;sd=desc",
    "status": 200
  },
  {
    "county": "Campbell",
    "paper": "The Northerner",
    "site": "https://www.thenortherner.com",
    "feedUrl": "https://www.thenortherner.com/feed/",
    "finalUrl": "https://www.thenortherner.com/feed/",
    "status": 200
  },
  {
    "county": "Jefferson",
    "paper": "Forward Kentucky",
    "site": "https://www.forwardky.com",
    "feedUrl": "https://www.forwardky.com/latest/rss/",
    "finalUrl": "https://www.forwardky.com/latest/rss/",
    "status": 200
  },
  {
    "county": "Green",
    "paper": "Greensburg Record Herald",
    "site": "https://www.record-herald.com",
    "feedUrl": "https://www.record-herald.com/feed/",
    "finalUrl": "https://www.record-herald.com/feed/",
    "status": 200
  },
  {
    "county": "Lawrence",
    "paper": "The Big Sandy News",
    "site": "https://www.thebigsandynews.com",
    "feedUrl": "https://thebigsandynews.com/index-rally?format=rss",
    "finalUrl": "https://thebigsandynews.com/index-rally?format=rss",
    "status": 200
  },
  {
    "county": "Fulton",
    "paper": "The Current",
    "site": "https://www.thecurrent.press",
    "feedUrl": "https://www.thecurrent.press/feed.atom",
    "finalUrl": "https://www.thecurrent.press/feed.atom",
    "status": 200
  },
  {
    "county": "Carter",
    "paper": "Carter County Times",
    "site": "https://www.cartercountytimes.com",
    "feedUrl": "https://cartercountytimes.com/feed/",
    "finalUrl": "https://cartercountytimes.com/feed/",
    "status": 200
  },
  {
    "county": "Daviess",
    "paper": "Owensboro Times",
    "site": "https://www.owensborotimes.com",
    "feedUrl": "https://www.owensborotimes.com/feed/",
    "finalUrl": "https://www.owensborotimes.com/feed/",
    "status": 200
  },
  {
    "county": "Fayette",
    "paper": "Kentucky Kernel",
    "site": "https://www.kykernel.com",
    "feedUrl": "https://kykernel.com/feed/",
    "finalUrl": "https://kykernel.com/feed/",
    "status": 200
  },
  {
    "county": "Calloway",
    "paper": "The Murray Sentinel",
    "site": "https://www.themurraysentinel.org",
    "feedUrl": "https://themurraysentinel.org/feed/",
    "finalUrl": "https://themurraysentinel.org/feed/",
    "status": 200
  },
  {
    "county": "Edmonson",
    "paper": "Edmonson News",
    "site": "https://www.jpinews.com",
    "feedUrl": "https://www.jpinews.com/feed/",
    "finalUrl": "https://www.jpinews.com/feed/",
    "status": 200
  },
  {
    "county": "Woodford",
    "paper": "Woodford Sun",
    "site": "https://www.woodfordsun.com",
    "feedUrl": "https://www.woodfordsun.com/blog-feed.xml",
    "finalUrl": "https://www.woodfordsun.com/blog-feed.xml",
    "status": 200
  },
  {
    "county": "Wayne",
    "paper": "Wayne Weekly",
    "site": "https://www.thewayneweekly.com",
    "feedUrl": "https://www.thewayneweekly.com/feed/",
    "finalUrl": "https://www.thewayneweekly.com/feed/",
    "status": 200
  },
  {
    "county": "Bourbon",
    "paper": "Bourbon County Citizen",
    "site": "https://www.bourboncountycitizen.com",
    "feedUrl": "https://www.bourboncountycitizen.com/feed/",
    "finalUrl": "https://www.bourboncountycitizen.com/feed/",
    "status": 200
  },
  {
    "county": "Webster",
    "paper": "Sebree Banner",
    "site": "https://www.cpcnewspapers.com",
    "feedUrl": "https://www.cpcnewspapers.com/feed/",
    "finalUrl": "https://www.cpcnewspapers.com/feed/",
    "status": 200
  },
  {
    "county": "Hancock",
    "paper": "Hancock Clarion",
    "site": "https://www.hancockclarion.com",
    "feedUrl": "https://www.hancockclarion.com/feed/",
    "finalUrl": "https://www.hancockclarion.com/feed/",
    "status": 200
  },
  {
    "county": "Monroe",
    "paper": "Tompkinsville News",
    "site": "https://www.tompkinsvillenews.com",
    "feedUrl": "https://www.tompkinsvillenews.com/feed/",
    "finalUrl": "https://www.tompkinsvillenews.com/feed/",
    "status": 200
  },
  {
    "county": "Lewis",
    "paper": "The Lewis County Herald",
    "site": "https://www.lewiscountyherald.com",
    "feedUrl": "https://lewiscountyherald.com/feed/",
    "finalUrl": "https://lewiscountyherald.com/feed/",
    "status": 200
  },
  {
    "county": "Magoffin",
    "paper": "Salyersville Independent",
    "site": "https://www.salyersvilleindependent.com",
    "feedUrl": "https://salyersvilleindependent.com/feed/",
    "finalUrl": "https://salyersvilleindependent.com/feed/",
    "status": 200
  },
  {
    "county": "Martin",
    "paper": "Mountain Citizen",
    "site": "https://www.mountaincitizen.com",
    "feedUrl": "https://mountaincitizen.com/feed/",
    "finalUrl": "https://mountaincitizen.com/feed/",
    "status": 200
  }
]
```

# data\kypress-valid-feeds.json

```json
[
  {
    "county": "Adair",
    "paper": "Adair Progress",
    "site": "https://www.adairprogress.com",
    "feedUrl": "https://www.adairprogress.com/rss",
    "finalUrl": "https://www.adairprogress.com/feed/",
    "status": 200
  },
  {
    "county": "Bell",
    "paper": "Middlesboro News",
    "site": "https://www.middlesboronews.com",
    "feedUrl": "https://www.middlesboronews.com/rss",
    "finalUrl": "https://middlesboronews.com/feed/",
    "status": 200
  },
  {
    "county": "Bourbon",
    "paper": "Bourbon County Citizen",
    "site": "https://www.bourboncountycitizen.com",
    "feedUrl": "https://www.bourboncountycitizen.com/rss",
    "finalUrl": "https://www.bourboncountycitizen.com/feed/",
    "status": 200
  },
  {
    "county": "Boyd",
    "paper": "Ashland Daily Independent",
    "site": "https://www.dailyindependent.com",
    "feedUrl": "https://www.dailyindependent.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "finalUrl": "https://www.dailyindependent.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "status": 200
  },
  {
    "county": "Boyle",
    "paper": "Advocate Messenger",
    "site": "https://www.amnews.com",
    "feedUrl": "https://www.amnews.com/rss",
    "finalUrl": "https://amnews.com/feed/",
    "status": 200
  },
  {
    "county": "Caldwell",
    "paper": "Princeton Times Leader",
    "site": "https://www.timesleader.net",
    "feedUrl": "https://www.timesleader.net/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "finalUrl": "https://www.timesleader.net/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "status": 200
  },
  {
    "county": "Calloway",
    "paper": "The Murray Sentinel",
    "site": "https://www.themurraysentinel.org",
    "feedUrl": "https://www.themurraysentinel.org/rss",
    "finalUrl": "https://themurraysentinel.org/feed/",
    "status": 200
  },
  {
    "county": "Campbell",
    "paper": "The Northerner",
    "site": "https://www.thenortherner.com",
    "feedUrl": "https://www.thenortherner.com/rss",
    "finalUrl": "https://www.thenortherner.com/feed/",
    "status": 200
  },
  {
    "county": "Carter",
    "paper": "Carter County Times",
    "site": "https://www.cartercountytimes.com",
    "feedUrl": "https://www.cartercountytimes.com/rss",
    "finalUrl": "https://cartercountytimes.com/feed/",
    "status": 200
  },
  {
    "county": "Christian",
    "paper": "Kentucky New Era",
    "site": "https://www.kentuckynewera.com",
    "feedUrl": "https://www.kentuckynewera.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "finalUrl": "https://www.kentuckynewera.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "status": 200
  },
  {
    "county": "Clark",
    "paper": "Winchester Sun",
    "site": "https://www.winchestersun.com",
    "feedUrl": "https://www.winchestersun.com/rss",
    "finalUrl": "https://winchestersun.com/feed/",
    "status": 200
  },
  {
    "county": "Daviess",
    "paper": "Owensboro Times",
    "site": "https://www.owensborotimes.com",
    "feedUrl": "https://www.owensborotimes.com/rss",
    "finalUrl": "https://www.owensborotimes.com/feed/",
    "status": 200
  },
  {
    "county": "Edmonson",
    "paper": "Edmonson News",
    "site": "https://www.jpinews.com",
    "feedUrl": "https://www.jpinews.com/rss",
    "finalUrl": "https://www.jpinews.com/feed/",
    "status": 200
  },
  {
    "county": "Fayette",
    "paper": "Kentucky Kernel",
    "site": "https://www.kykernel.com",
    "feedUrl": "https://www.kykernel.com/rss",
    "finalUrl": "https://kykernel.com/feed/",
    "status": 200
  },
  {
    "county": "Floyd",
    "paper": "Floyd County Chronicle and Times",
    "site": "https://www.floydct.com",
    "feedUrl": "https://www.floydct.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "finalUrl": "https://www.floydct.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "status": 200
  },
  {
    "county": "Franklin",
    "paper": "Frankfort State Journal",
    "site": "https://www.state-journal.com",
    "feedUrl": "https://www.state-journal.com/rss",
    "finalUrl": "https://state-journal.com/feed/",
    "status": 200
  },
  {
    "county": "Green",
    "paper": "Greensburg Record Herald",
    "site": "https://www.record-herald.com",
    "feedUrl": "https://www.record-herald.com/rss",
    "finalUrl": "https://www.record-herald.com/feed/",
    "status": 200
  },
  {
    "county": "Hancock",
    "paper": "Hancock Clarion",
    "site": "https://www.hancockclarion.com",
    "feedUrl": "https://www.hancockclarion.com/rss",
    "finalUrl": "https://www.hancockclarion.com/feed/",
    "status": 200
  },
  {
    "county": "Harlan",
    "paper": "Harlan Enterprise",
    "site": "https://www.harlanenterprise.net",
    "feedUrl": "https://www.harlanenterprise.net/rss",
    "finalUrl": "https://harlanenterprise.net/feed/",
    "status": 200
  },
  {
    "county": "Jefferson",
    "paper": "Forward Kentucky",
    "site": "https://www.forwardky.com",
    "feedUrl": "https://www.forwardky.com/rss",
    "finalUrl": "https://www.forwardky.com/latest/rss/",
    "status": 200
  },
  {
    "county": "Jessamine",
    "paper": "Jessamine Journal",
    "site": "https://www.jessaminejournal.com",
    "feedUrl": "https://www.jessaminejournal.com/rss",
    "finalUrl": "https://jessaminejournal.com/feed/",
    "status": 200
  },
  {
    "county": "Kenton",
    "paper": "LINK nky",
    "site": "https://www.linknky.com",
    "feedUrl": "https://www.linknky.com/rss",
    "finalUrl": "https://linknky.com/feed/",
    "status": 200
  },
  {
    "county": "Knott",
    "paper": "Troublesome Creek Times",
    "site": "https://www.troublesomecreektimes.com",
    "feedUrl": "https://www.troublesomecreektimes.com/rss",
    "finalUrl": "https://www.troublesomecreektimes.com/feed/",
    "status": 200
  },
  {
    "county": "Lewis",
    "paper": "The Lewis County Herald",
    "site": "https://www.lewiscountyherald.com",
    "feedUrl": "https://www.lewiscountyherald.com/rss",
    "finalUrl": "https://lewiscountyherald.com/feed/",
    "status": 200
  },
  {
    "county": "Lincoln",
    "paper": "Interior Journal",
    "site": "https://www.theinteriorjournal.com",
    "feedUrl": "https://www.theinteriorjournal.com/rss",
    "finalUrl": "https://theinteriorjournal.com/feed/",
    "status": 200
  },
  {
    "county": "Madison",
    "paper": "Richmond Register",
    "site": "https://www.richmondregister.com",
    "feedUrl": "https://www.richmondregister.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "finalUrl": "https://www.richmondregister.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "status": 200
  },
  {
    "county": "Magoffin",
    "paper": "Salyersville Independent",
    "site": "https://www.salyersvilleindependent.com",
    "feedUrl": "https://www.salyersvilleindependent.com/rss",
    "finalUrl": "https://salyersvilleindependent.com/feed/",
    "status": 200
  },
  {
    "county": "Marshall",
    "paper": "The Lake News",
    "site": "https://www.thelakenews.com",
    "feedUrl": "https://www.thelakenews.com/rss",
    "finalUrl": "https://www.thelakenews.com/feed/",
    "status": 200
  },
  {
    "county": "Martin",
    "paper": "Mountain Citizen",
    "site": "https://www.mountaincitizen.com",
    "feedUrl": "https://www.mountaincitizen.com/rss",
    "finalUrl": "https://mountaincitizen.com/feed/",
    "status": 200
  },
  {
    "county": "McCracken",
    "paper": "Paducah Sun",
    "site": "https://www.paducahsun.com",
    "feedUrl": "https://www.paducahsun.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "finalUrl": "https://www.paducahsun.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "status": 200
  },
  {
    "county": "Monroe",
    "paper": "Tompkinsville News",
    "site": "https://www.tompkinsvillenews.com",
    "feedUrl": "https://www.tompkinsvillenews.com/rss",
    "finalUrl": "https://www.tompkinsvillenews.com/feed/",
    "status": 200
  },
  {
    "county": "Ohio",
    "paper": "Ohio County Times-News",
    "site": "https://www.octimesnews.com",
    "feedUrl": "https://www.octimesnews.com/rss",
    "finalUrl": "https://www.octimesnews.com/feed/",
    "status": 200
  },
  {
    "county": "Simpson",
    "paper": "Franklin Favorite",
    "site": "https://www.franklinfavorite.com",
    "feedUrl": "https://www.franklinfavorite.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "finalUrl": "https://www.franklinfavorite.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "status": 200
  },
  {
    "county": "Warren",
    "paper": "Bowling Green Daily News",
    "site": "https://www.bgdailynews.com",
    "feedUrl": "https://www.bgdailynews.com/rss",
    "finalUrl": "https://bgdailynews.com/feed/",
    "status": 200
  },
  {
    "county": "Warren",
    "paper": "College Heights Herald",
    "site": "https://www.wkuherald.com",
    "feedUrl": "https://www.wkuherald.com/rss",
    "finalUrl": "https://wkuherald.com/feed/",
    "status": 200
  },
  {
    "county": "Wayne",
    "paper": "Wayne Weekly",
    "site": "https://www.thewayneweekly.com",
    "feedUrl": "https://www.thewayneweekly.com/rss",
    "finalUrl": "https://www.thewayneweekly.com/feed/",
    "status": 200
  },
  {
    "county": "Webster",
    "paper": "Sebree Banner",
    "site": "https://www.cpcnewspapers.com",
    "feedUrl": "https://www.cpcnewspapers.com/rss",
    "finalUrl": "https://www.cpcnewspapers.com/feed/",
    "status": 200
  },
  {
    "county": "Whitley",
    "paper": "Corbin/Whitley News Journal",
    "site": "https://www.thenewsjournal.net",
    "feedUrl": "https://www.thenewsjournal.net/rss",
    "finalUrl": "https://thenewsjournal.net/feed/",
    "status": 200
  }
]
```

# data\uploads\lost-found\2026-02-20-d9661780-d681-4bb8-901e-080f898ae8f2.png

This is a binary file of the type: Image

# data\uploads\lost-found\2026-02-21-acabb21e-803e-42fc-8e3e-35971cd2ae4b.png

This is a binary file of the type: Image

# docs\00_PROJECT_OVERVIEW.md

```md
# Project Overview

## Product Mission
Build the go-to mobile-first source for Kentucky news and weather, with a separate national lane, using a Feedly-style reading experience and curated sources only.

## Audience
- Kentucky residents who need county-level awareness.
- Kentucky professionals tracking local government, schools, and weather impacts.
- Readers who want a no-account, low-friction news app.

## Core Value Proposition
- Fast, clean, Feedly-like reading flow.
- County-level Kentucky sorting (state + all counties).
- Reliable weather alerts and forecast context.
- Optional community utility via moderated lost-and-found.

## In Scope (MVP to Launch)
- Curated RSS ingestion (no user-submitted RSS feeds).
- Kentucky local lane (default) with county filters and My County preference.
- Separate National lane.
- Search, Reader, Read Later, local offline support.
- Weather section backed by NOAA/NWS forecast + alerts.
- Lost-and-found submissions with moderation queue.
- Cloudflare-ready architecture (Pages + Workers + D1 + R2).

## Out of Scope (Launch)
- End-user account system.
- Personalized recommendation engine.
- Paid content/paywall bypass.
- Native mobile apps.
- Public posting without moderation.

## North-Star Metrics
- Daily active readers (DAR).
- 7-day return rate.
- Median time-to-first-contentful-item on Today screen.
- County coverage freshness (new KY items in last 2 hours).
- Weather alert delivery freshness.

## Product Principles
- No account required for reading.
- Kentucky-first always wins in prioritization.
- Trust and safety over raw posting speed.
- Performance and reliability over feature sprawl.

```

# docs\01_PRODUCT_REQUIREMENTS.md

```md
# Product Requirements

## Screens and Behaviors

### Today
- Default route `/today`.
- Shows Kentucky stories by recency.
- Supports optional query filters: `state=KY`, `county=<name>`.
- Infinite paging via cursor.

### Kentucky Local
- Drawer access to Kentucky state view and all counties.
- County counts shown from `/api/counties`.
- My Local county preference stored in localStorage.

### National
- Dedicated route `/national`.
- Only stories with `region_scope=national`.
- No county drilldown in National.

### Weather
- Route `/weather`.
- Uses My Local county by default.
- Forecast periods from NWS.
- Active alert list with severity and event.

### Search
- Route `/search`.
- Query syntax supports quoted phrases, `AND`, `OR`, `-exclude`.
- Scope picker: Kentucky, National, Both.

### Reader
- Route `/item/:id`.
- Displays cleaned content with source link.
- Supports offline fallback from local cache.

### Read Later
- Route `/read-later`.
- Device-local saved state with mark-all-read.

### Lost & Found
- Route `/lost-found`.
- Public listing shows approved posts only.
- Submission form requires: type, title, description, county, contact email.
- Optional image upload and optional contact visibility after approval.

## Interaction Requirements
- Mobile-first layout with drawer nav + bottom nav.
- Quick county switching and persistent My County setting.
- Clear loading/error states for all data-heavy screens.

## Reliability Requirements
- App remains usable if some feeds fail.
- Weather endpoint can return stale cached data if NWS is temporarily unavailable.
- Lost-and-found submission rate-limited per IP.

## Security Requirements
- Admin endpoints protected by Cloudflare Access header in production.
- Local admin fallback supported via `ADMIN_TOKEN`.
- Contact email encrypted at rest.

## Non-Functional Targets
- Initial content load under 2.5s on typical mobile 4G.
- API P95 under 600ms for core feed endpoints (excluding upstream weather latency).
- Ingestion cadence every 15 minutes.

```

# docs\02_INFORMATION_ARCHITECTURE.md

```md
# Information Architecture

## Route Map
- `/today`
- `/today?state=KY`
- `/today?state=KY&county=<county>`
- `/national`
- `/weather`
- `/read-later`
- `/search`
- `/lost-found`
- `/local-settings`
- `/feed/:feedId`
- `/item/:id`

## Navigation Model
- Drawer: Today, Read Later, National, Weather, Lost & Found, Local tools, Feed categories.
- Bottom nav: Menu, Read Later, Today, My Local, Search.
- Local county selector is reachable from drawer and Weather view.

## Content Taxonomy
- `region_scope=ky`: County-aware Kentucky content.
- `region_scope=national`: National lane only.
- `state_code` used for KY location tagging and weather.
- `county` only used for KY local filtering.

## Locality Hierarchy
1. My Local County (personal quick-access)
2. County views (all Kentucky counties)
3. Kentucky state aggregate
4. National lane

## Lost-and-Found Taxonomy
- Type: `lost` | `found`
- Status: `pending` | `approved` | `rejected`
- Visibility: public only when `approved`

## Weather Taxonomy
- State: `KY` (MVP)
- County forecast context
- Active alerts with severity and event

```

# docs\03_DATA_MODEL.md

```md
# Data Model

## Core Tables

### feeds
- `id TEXT PRIMARY KEY`
- `name TEXT NOT NULL`
- `category TEXT NOT NULL`
- `url TEXT NOT NULL`
- `state_code TEXT NOT NULL DEFAULT 'KY'`
- `region_scope TEXT NOT NULL DEFAULT 'ky'`
- `enabled INTEGER NOT NULL DEFAULT 1`
- `etag`, `last_modified`, `last_checked_at`, `created_at`

### items
- `id TEXT PRIMARY KEY`
- `title`, `url`, `guid`, `author`
- `region_scope TEXT NOT NULL DEFAULT 'ky'`
- `published_at`, `summary`, `content`, `image_url`
- `fetched_at`, `hash`
- article enrichment fields: `article_checked_at`, `article_fetch_status`, `article_text_excerpt`

### feed_items
- `(feed_id, item_id) PRIMARY KEY`

### item_locations
- `(item_id, state_code, county) PRIMARY KEY`
- `county=''` represents state-level tag

## Operational Tables
- `fetch_runs`
- `fetch_errors`

## Weather Tables

### weather_forecasts
- `id INTEGER PK`
- `state_code`, `county`
- `forecast_json`
- `fetched_at`, `expires_at`

### weather_alerts
- `id INTEGER PK`
- `alert_id`, `state_code`, `county`
- `severity`, `event`, `headline`
- `starts_at`, `ends_at`
- `raw_json`, `fetched_at`

## Lost & Found Tables

### lost_found_posts
- `id TEXT PK`
- `type ('lost'|'found')`
- `title`, `description`
- `county`, `state_code`
- `contact_email_encrypted`
- `show_contact`
- `status ('pending'|'approved'|'rejected')`
- `submitted_at`, `approved_at`, `rejected_at`
- `expires_at`, `moderation_note`

### lost_found_images
- `id TEXT PK`
- `post_id FK -> lost_found_posts`
- `r2_key`, `width`, `height`, `created_at`

### lost_found_reports
- `id TEXT PK`
- `post_id FK -> lost_found_posts`
- `reason`, `reporter_ip_hash`, `created_at`

### admin_audit_log
- `id TEXT PK`
- `actor_email`
- `action`, `entity_type`, `entity_id`
- `payload_json`, `created_at`

## Retention Defaults
- Forecast cache: 7 days
- Alert cache: 48 hours
- Lost-and-found post expiry: 30 days unless renewed
- Ingestion logs retained until manual cleanup policy introduced

```

# docs\04_API_SPEC.md

```md
# API Specification

Base URL (local): `http://127.0.0.1:8787`

## Public Endpoints

### GET /api/health
- Returns service liveness.

### GET /api/feeds
- Query: `scope=ky|national|all` (default `all`)
- Returns enabled feed definitions including `region_scope`.

### GET /api/items
- Query:
  - `scope=ky|national|all` (default `ky`)
  - `feedId?`, `state?`, `county?`, `hours?`, `cursor?`, `limit?`
- Notes:
  - `state/county` filters are valid only for KY scope.

### GET /api/items/:id
- Returns one item.

### GET /api/counties
- Query: `state=KY`, `hours?`
- Returns county counts for KY stories.

### GET /api/search
- Query:
  - `q` required
  - `scope=ky|national|all`
  - `state?`, `county?`, `hours?`, `cursor?`, `limit?`

### GET /api/weather/forecast
- Query: `state=KY`, `county` required
- Returns county forecast periods.

### GET /api/weather/alerts
- Query: `state=KY`, `county?`
- Returns active alerts list.

### GET /api/lost-found
- Query: `type?`, `county?`, `status?`, `limit?`
- Public callers can only access published (`approved`) listings.

### POST /api/lost-found/submissions
- Body:
  - `type`, `title`, `description`, `county`, `state=KY`, `contactEmail`
  - `showContact?`, `imageKeys?`, `turnstileToken?`
- Creates `pending` post.

### POST /api/lost-found/:id/report
- Body: `reason`
- Creates abuse/safety report.

### POST /api/uploads/lost-found-url
- Body: `filename`, `mimeType`
- Returns one-time upload target metadata.

### PUT /api/uploads/lost-found/:key
- Binary upload endpoint for image bytes.

### GET /api/uploads/lost-found/:key
- Returns uploaded image bytes.

## Admin Endpoints

Authentication:
- Production: Cloudflare Access header `cf-access-authenticated-user-email`.
- Local fallback: `x-admin-token` matching `ADMIN_TOKEN`.

### GET /api/admin/lost-found
- Query: `status=pending|approved|rejected`, `limit?`
- Returns moderation queue.

### POST /api/admin/lost-found/:id/approve
- Body: `showContact?`, `note?`

### POST /api/admin/lost-found/:id/reject
- Body: `reason`

### POST /api/admin/feeds/reload
- Triggers one-off ingester run.

## Error Model
- `400` invalid query/payload
- `401` admin auth required
- `404` not found
- `429` rate-limited
- `502` upstream weather error
- `500` internal server error

```

# docs\05_INGESTION_PIPELINE.md

```md
# Ingestion Pipeline

## Runtime
- Service: `apps/ingester/src/ingester.mjs`
- Schedule: every 15 minutes (configurable via `INGEST_INTERVAL_MINUTES`).
- Local one-shot: `npm run ingest:once`

## Flow
1. Load enabled feeds from `feeds`.
2. Fetch each feed with conditional headers (`If-None-Match`, `If-Modified-Since`).
3. Parse RSS items.
4. Build deterministic item ID and hash.
5. Upsert item and link `feed_items`.
6. If feed is KY scope:
   - Tag item with state-level location.
   - Attempt county detection from title/summary/content.
   - If no county found, fetch article body and retry county detection.
7. Record run status and errors.

## Dedupe Strategy
- Primary ID from URL/guid/title+date hash.
- Upsert by item ID prevents duplicate rows across runs.
- `feed_items` join tracks feed-source mapping.

## Scope Strategy
- Feed `region_scope` drives item `region_scope`.
- KY items are location-tagged.
- National items are not inserted into county-tag tables.

## Failure Handling
- Per-feed errors are logged to `fetch_errors`; pipeline continues.
- Top-level run status written to `fetch_runs`.
- Endpoint `/api/admin/feeds/reload` allows manual recovery trigger.

## Planned Improvements
- Health score per feed source.
- Failure streak alerts.
- Dead feed auto-disable policy (manual confirmation).
- Enhanced content extraction for weak RSS summaries.

```

# docs\06_PWA_SPEC.md

```md
# PWA Specification

## Stack
- Vite + React + `vite-plugin-pwa`
- Service Worker generated via Workbox.

## Installability
- Manifest served at `manifest.webmanifest`.
- Standalone display mode.
- Icons: 192 and 512 PNG.

## Caching Strategy
- API routes (`/api/*`): `NetworkFirst`, 1-hour TTL.
- Images: `StaleWhileRevalidate`, 7-day TTL.
- Static assets precached by Workbox.

## Offline Behavior
- Reader uses local Dexie cache for last-opened items.
- Read and saved state stored locally (no account sync).
- Previously fetched lists/images remain available based on SW cache.

## Update UX
- `registerSW` uses prompt mode.
- App emits `pwa:need-refresh` and `pwa:offline-ready` events.
- UI can present refresh/ready banners.

## Performance Budgets
- Mobile LCP target: < 2.5s
- JS bundle baseline monitored each build.
- API list endpoint target: P95 < 600ms local/network permitting.

## Hardening Checklist
- Add explicit update banner UI.
- Add stale content timestamp in Today/National lists.
- Add cache bust strategy for image corruption edge cases.
- Validate offline-first behavior on iOS Safari and Android Chrome.

```

# docs\07_WEATHER_SPEC.md

```md
# Weather Specification

## Source of Truth
- NOAA / National Weather Service API (`api.weather.gov`).

## Forecast Flow
1. Resolve KY county zone by name.
2. Resolve county geometry centroid.
3. Fetch point metadata from `/points/{lat},{lon}`.
4. Use forecast URL from points response.
5. Cache normalized forecast in `weather_forecasts`.

## Alert Flow
1. Fetch active alerts for KY from `/alerts/active?area=KY`.
2. Filter by county name (if county provided).
3. Cache alert payloads in `weather_alerts`.
4. Purge old alerts (>48h).

## API Contracts
- `GET /api/weather/forecast?state=KY&county=<county>`
- `GET /api/weather/alerts?state=KY&county=<county>`

## UX Rules
- Weather defaults to My Local county.
- Display active alert cards above forecast blocks.
- If live fetch fails and cache exists, return stale payload with warning.

## Refresh Cadence
- On-demand via route requests (current implementation).
- Planned scheduled refresh every 10 minutes in cloud runtime.

## Known Constraints
- County matching is string-based; naming mismatches can cause misses.
- NWS latency can vary; stale fallback is required for resilience.

```

# docs\08_LOST_FOUND_SPEC.md

```md
# Lost and Found Specification

## Goals
- Provide a practical community utility without requiring user accounts.
- Prevent abuse through mandatory moderation and basic anti-spam controls.

## Submission Workflow
1. User fills form: `type`, `title`, `description`, `county`, `contactEmail`.
2. Optional image uploaded via upload URL handshake.
3. Submission saved as `pending` in `lost_found_posts`.
4. Contact email encrypted at rest.

## Moderation Workflow
1. Admin opens queue (`/api/admin/lost-found?status=pending`).
2. Admin approves or rejects each post.
3. Approved posts become publicly visible.
4. Rejected posts remain private with moderation note.
5. All actions logged to `admin_audit_log`.

## Visibility Rules
- Public listing endpoint returns approved posts only.
- Contact email shown publicly only when `show_contact=1`.
- Admin queue always sees decrypted contact email.

## Abuse Controls
- Submission rate limit: 5 per IP per hour.
- Public reporting endpoint for problematic posts.
- Optional Turnstile enforcement gate (`REQUIRE_TURNSTILE=1`).

## Media Handling
- Upload metadata via `/api/uploads/lost-found-url`.
- Binary image upload via `PUT /api/uploads/lost-found/:key`.
- Local dev stores files under `data/uploads/lost-found`.
- Cloud target: R2 object storage with signed URLs.

## Lifecycle
- Default expiry: 30 days from submission.
- Future enhancement: admin renew/archive actions.

```

# docs\09_CLOUDFLARE_DEPLOYMENT.md

```md
# Cloudflare Deployment

## Target Topology
- Cloudflare Pages: web frontend (`apps/web` build output).
- Cloudflare Workers:
  - API worker (Fastify-equivalent route contracts).
  - Scheduled ingest worker.
- D1: relational data store.
- R2: lost-and-found images.
- Cloudflare Access: protect `/admin` routes.

## Environments
- `local`: Node + SQLite + local file uploads.
- `staging`: Pages + Workers + D1 (staging DB) + R2 (staging bucket).
- `production`: Pages + Workers + D1 (prod DB) + R2 (prod bucket).

## Required Secrets/Vars
- `NWS_USER_AGENT`
- `LOCAL_DATA_ENCRYPTION_KEY` (worker equivalent secret)
- `ADMIN_EMAIL` (optional local fallback)
- `TURNSTILE_SECRET` (when enabled)
- D1 binding names and R2 bucket bindings

## Migration Plan
1. Export SQLite schema as D1 SQL migration.
2. Implement API worker route parity with existing Node API.
3. Implement ingest worker with cron trigger (every 15 minutes).
4. Implement weather refresh cron (every 10 minutes).
5. Wire image upload flow from local disk to R2 signed uploads.
6. Switch Pages API proxy to worker domain.

## Access Control
- Use Cloudflare Access policy (email/org restrictions).
- Worker validates Access identity header for admin endpoints.

## Rollout Checklist
- Staging smoke tests pass for all primary routes.
- Ingestion and weather schedules confirmed in logs.
- Lost-and-found upload and moderation verified end-to-end.
- PWA install/update validated on staging domain.
- Production cutover with rollback path documented.

```

# docs\10_ROADMAP.md

```md
# Roadmap

## Timeline (Single Developer)

| Milestone | Target | Build Scope | Exit Criteria |
|---|---|---|---|
| M0 Baseline | Week 1 | Canonical app paths, schema alignment, docs baseline | One canonical web/API path, no structural blockers |
| M1 Kentucky Core | Weeks 2-3 | KY nav polish, list reliability, reader/read-later hardening | KY browsing stable on mobile |
| M2 National Lane | Week 4 | National feeds + dedicated `/national` lane | National stories visible without polluting KY filters |
| M3 Weather Hub | Week 5 | NWS forecast + alerts + weather screen | County weather and alerts operational |
| M4 Lost & Found MVP | Weeks 6-7 | Submission, media upload, moderation endpoints | Submit -> moderate -> publish works |
| M5 PWA Hardening | Week 8 | Offline and update UX polish, cache tuning | PWA installable and resilient offline |
| M6 Cloudflare Migration | Weeks 9-10 | Worker + D1 + R2 parity | Staging cloud parity achieved |
| M7 Launch Readiness | Week 11 | Runbooks, dashboards, QA, content governance | Soft launch go/no-go checklist complete |

## Priority Queue
1. Stabilize all new endpoints with basic smoke tests.
2. Add weather severity banner on Today/Kentucky.
3. Add admin UI shell for moderation and feed diagnostics.
4. Implement Cloudflare worker parity and deployment automation.
5. Complete policy pages and legal/compliance baseline.

## Definition of Done (Launch)
- KY + National + Weather + Lost & Found are functional in production.
- Ingestion and weather jobs are monitored and alerting.
- Moderation SLA and escalation process documented.
- PWA install/update behavior validated on major mobile browsers.

```

# docs\11_OPERATIONS_RUNBOOK.md

```md
# Operations Runbook

## Daily Checks
- Verify ingest success in latest `fetch_runs` row.
- Review `fetch_errors` for repeated feed failures.
- Verify weather endpoints return current data.
- Check pending lost-and-found moderation queue size.

## Incident Playbooks

### Ingestion Failure Spike
1. Trigger manual reload: `POST /api/admin/feeds/reload`.
2. Inspect `fetch_errors` for top failing feeds.
3. Disable broken feeds temporarily if needed.
4. Confirm new items flowing again.

### Weather API Outage
1. Confirm endpoint returns stale fallback, not hard failure.
2. Notify operators that data may be stale.
3. Monitor NWS recovery and clear warning status.

### Moderation Backlog
1. Prioritize posts older than 2 hours.
2. Reject obvious spam/unsafe submissions first.
3. Log unusual abuse patterns and add blocks/rate rules.

### Abuse Report Surge
1. Query `lost_found_reports` grouped by `post_id`.
2. Unpublish or reject affected post(s).
3. Document action in `admin_audit_log`.

## Monitoring Metrics
- Ingest success rate.
- New items in last 2 hours (KY and National).
- API route latency and error rate.
- Weather endpoint freshness.
- Lost-and-found queue age.

## Alert Thresholds
- No successful ingest in > 30 minutes.
- API 5xx > 2% for 5 minutes.
- Weather fetch failures for > 30 minutes.
- Pending moderation older than 2 hours.

## Backup and Recovery
- Local: periodic copy of `data/dev.sqlite`.
- Cloud: D1 export schedule + R2 lifecycle policy.
- Validate restore process quarterly.

## Governance
- Keep moderation policy, privacy policy, and terms current.
- Maintain takedown contact and escalation owner.

```

# docs\README.md

```md
# Documentation Index

- `00_PROJECT_OVERVIEW.md`
- `01_PRODUCT_REQUIREMENTS.md`
- `02_INFORMATION_ARCHITECTURE.md`
- `03_DATA_MODEL.md`
- `04_API_SPEC.md`
- `05_INGESTION_PIPELINE.md`
- `06_PWA_SPEC.md`
- `07_WEATHER_SPEC.md`
- `08_LOST_FOUND_SPEC.md`
- `09_CLOUDFLARE_DEPLOYMENT.md`
- `10_ROADMAP.md`
- `11_OPERATIONS_RUNBOOK.md`

```

# feeds.seed.json

```json
[
  {
    "id": "ky-wlky-top",
    "name": "WLKY Top Stories",
    "category": "Kentucky - TV",
    "url": "https://www.wlky.com/topstories-rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-lex18",
    "name": "LEX18 Headlines",
    "category": "Kentucky - TV",
    "url": "https://www.lex18.com/index.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wtvq-local",
    "name": "ABC36 (WTVQ) Local News",
    "category": "Kentucky - TV",
    "url": "https://www.wtvq.com/category/local-news/feed",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-spectrum-lou",
    "name": "Spectrum News Louisville Headlines",
    "category": "Kentucky - Local",
    "url": "https://spectrumlocalnews.com/services/contentfeed.ky%7Clouisville%7Cnews.landing.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wdrb-search",
    "name": "WDRB News",
    "category": "Kentucky - Local",
    "url": "https://www.wdrb.com/news/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wpsd-search",
    "name": "WPSD Local 6 (RSS Search)",
    "category": "Kentucky - Local",
    "url": "https://www.wpsdlocal6.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-kentuckylantern-politics",
    "name": "Kentucky Lantern Politics",
    "category": "Kentucky - Politics",
    "url": "https://kentuckylantern.com/category/politics/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-forwardky",
    "name": "ForwardKY Latest",
    "category": "Kentucky - Politics",
    "url": "https://www.forwardky.com/latest/rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-uknow-campus",
    "name": "UKNow Campus News",
    "category": "Kentucky - Education",
    "url": "https://uknow.uky.edu/feeds/section/347/rss.xml",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-uknow-happenings",
    "name": "UKNow Happenings",
    "category": "Kentucky - Events",
    "url": "https://uknow.uky.edu/feeds/section/426/rss.xml",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-lex18-news",
    "name": "LEX18 News",
    "category": "Kentucky - TV",
    "url": "https://www.lex18.com/news.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-lex18-weather",
    "name": "LEX18 Weather",
    "category": "Kentucky - Weather",
    "url": "https://www.lex18.com/weather.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wtvq-weather",
    "name": "ABC36 (WTVQ) Weather",
    "category": "Kentucky - Weather",
    "url": "https://www.wtvq.com/category/weather/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-whas-news",
    "name": "WHAS11 News",
    "category": "Kentucky - TV",
    "url": "https://www.whas11.com/feeds/syndication/rss/news",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-whas-weather",
    "name": "WHAS11 Weather",
    "category": "Kentucky - Weather",
    "url": "https://www.whas11.com/feeds/syndication/rss/weather",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wfpl",
    "name": "WFPL Louisville",
    "category": "Kentucky - Radio",
    "url": "https://wfpl.org/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-kentuckytoday",
    "name": "Kentucky Today",
    "category": "Kentucky - Statewide",
    "url": "https://www.kentuckytoday.com/feed",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-kentuckynewera",
    "name": "Kentucky New Era",
    "category": "Kentucky - Local",
    "url": "https://www.kentuckynewera.com/news/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-timesleader",
    "name": "The Times Leader",
    "category": "Kentucky - Local",
    "url": "https://www.timesleader.net/feed",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-dailyindependent",
    "name": "Daily Independent",
    "category": "Kentucky - Local",
    "url": "https://www.dailyindependent.com/news/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wcpo-state",
    "name": "WCPO Kentucky",
    "category": "Kentucky - Regional",
    "url": "https://www.wcpo.com/news/state/state-kentucky.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wowk-kentucky",
    "name": "WOWK Kentucky",
    "category": "Kentucky - Regional",
    "url": "https://www.wowktv.com/news/kentucky/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "nat-nyt-home",
    "name": "New York Times - Home Page",
    "category": "National - General",
    "url": "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml",
    "state_code": "US",
    "region_scope": "national",
    "enabled": 1
  },
  {
    "id": "nat-npr-news",
    "name": "NPR - News",
    "category": "National - General",
    "url": "https://feeds.npr.org/1001/rss.xml",
    "state_code": "US",
    "region_scope": "national",
    "enabled": 1
  },
  {
    "id": "nat-bbc-us-canada",
    "name": "BBC - US and Canada",
    "category": "National - General",
    "url": "https://feeds.bbci.co.uk/news/world/us_and_canada/rss.xml",
    "state_code": "US",
    "region_scope": "national",
    "enabled": 1
  },
  {
    "id": "nat-cnn-top",
    "name": "AP News - Top Stories",
    "category": "National - General",
    "url": "https://feeds.apnews.com/rss/apf-topnews",
    "state_code": "US",
    "region_scope": "national",
    "enabled": 1
  },
  {
    "id": "nat-cbs-main",
    "name": "CBS News - Top",
    "category": "National - General",
    "url": "https://www.cbsnews.com/latest/rss/main",
    "state_code": "US",
    "region_scope": "national",
    "enabled": 1
  },
  {
    "id": "ky-county-adair-adair-progress",
    "name": "Adair Progress",
    "category": "Kentucky - County Papers",
    "url": "https://www.adairprogress.com/feed",
    "state_code": "KY",
    "default_county": "Adair",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-bell-middlesboro-news",
    "name": "Middlesboro News",
    "category": "Kentucky - County Papers",
    "url": "https://middlesboronews.com/feed",
    "state_code": "KY",
    "default_county": "Bell",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-bourbon-bourbon-county-citizen",
    "name": "Bourbon County Citizen",
    "category": "Kentucky - County Papers",
    "url": "https://www.bourboncountycitizen.com/feed",
    "state_code": "KY",
    "default_county": "Bourbon",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-boyle-advocate-messenger",
    "name": "Advocate Messenger",
    "category": "Kentucky - County Papers",
    "url": "https://amnews.com/feed",
    "state_code": "KY",
    "default_county": "Boyle",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-calloway-the-murray-sentinel",
    "name": "The Murray Sentinel",
    "category": "Kentucky - County Papers",
    "url": "https://themurraysentinel.org/feed",
    "state_code": "KY",
    "default_county": "Calloway",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-campbell-the-northerner",
    "name": "The Northerner",
    "category": "Kentucky - County Papers",
    "url": "https://www.thenortherner.com/feed",
    "state_code": "KY",
    "default_county": "Campbell",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-carter-carter-county-times",
    "name": "Carter County Times",
    "category": "Kentucky - County Papers",
    "url": "https://cartercountytimes.com/feed",
    "state_code": "KY",
    "default_county": "Carter",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-clark-winchester-sun",
    "name": "Winchester Sun",
    "category": "Kentucky - County Papers",
    "url": "https://winchestersun.com/feed",
    "state_code": "KY",
    "default_county": "Clark",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-daviess-owensboro-times",
    "name": "Owensboro Times",
    "category": "Kentucky - County Papers",
    "url": "https://www.owensborotimes.com/feed",
    "state_code": "KY",
    "default_county": "Daviess",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-edmonson-edmonson-news",
    "name": "Edmonson News",
    "category": "Kentucky - County Papers",
    "url": "https://www.jpinews.com/feed",
    "state_code": "KY",
    "default_county": "Edmonson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-fayette-kentucky-kernel",
    "name": "Kentucky Kernel",
    "category": "Kentucky - County Papers",
    "url": "https://kykernel.com/feed",
    "state_code": "KY",
    "default_county": "Fayette",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-floyd-floyd-county-chronicle",
    "name": "Floyd County Chronicle and Times",
    "category": "Kentucky - County Papers",
    "url": "https://www.floydct.com/news/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Floyd",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-franklin-frankfort-state-journa",
    "name": "Frankfort State Journal",
    "category": "Kentucky - County Papers",
    "url": "https://state-journal.com/feed",
    "state_code": "KY",
    "default_county": "Franklin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-green-greensburg-record-hera",
    "name": "Greensburg Record Herald",
    "category": "Kentucky - County Papers",
    "url": "https://www.record-herald.com/feed",
    "state_code": "KY",
    "default_county": "Green",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-hancock-hancock-clarion",
    "name": "Hancock Clarion",
    "category": "Kentucky - County Papers",
    "url": "https://www.hancockclarion.com/feed",
    "state_code": "KY",
    "default_county": "Hancock",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-harlan-harlan-enterprise",
    "name": "Harlan Enterprise",
    "category": "Kentucky - County Papers",
    "url": "https://harlanenterprise.net/feed",
    "state_code": "KY",
    "default_county": "Harlan",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-jessamine-jessamine-journal",
    "name": "Jessamine Journal",
    "category": "Kentucky - County Papers",
    "url": "https://jessaminejournal.com/feed",
    "state_code": "KY",
    "default_county": "Jessamine",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-kenton-link-nky",
    "name": "LINK nky",
    "category": "Kentucky - County Papers",
    "url": "https://linknky.com/feed",
    "state_code": "KY",
    "default_county": "Kenton",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-knott-troublesome-creek-time",
    "name": "Troublesome Creek Times",
    "category": "Kentucky - County Papers",
    "url": "https://www.troublesomecreektimes.com/feed",
    "state_code": "KY",
    "default_county": "Knott",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-lewis-the-lewis-county-heral",
    "name": "The Lewis County Herald",
    "category": "Kentucky - County Papers",
    "url": "https://lewiscountyherald.com/feed",
    "state_code": "KY",
    "default_county": "Lewis",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-lincoln-interior-journal",
    "name": "Interior Journal",
    "category": "Kentucky - County Papers",
    "url": "https://theinteriorjournal.com/feed",
    "state_code": "KY",
    "default_county": "Lincoln",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-madison-richmond-register",
    "name": "Richmond Register",
    "category": "Kentucky - County Papers",
    "url": "https://www.richmondregister.com/news/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Madison",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-magoffin-salyersville-independe",
    "name": "Salyersville Independent",
    "category": "Kentucky - County Papers",
    "url": "https://salyersvilleindependent.com/feed",
    "state_code": "KY",
    "default_county": "Magoffin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-marshall-the-lake-news",
    "name": "The Lake News",
    "category": "Kentucky - County Papers",
    "url": "https://www.thelakenews.com/feed",
    "state_code": "KY",
    "default_county": "Marshall",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-martin-mountain-citizen",
    "name": "Mountain Citizen",
    "category": "Kentucky - County Papers",
    "url": "https://mountaincitizen.com/feed",
    "state_code": "KY",
    "default_county": "Martin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-mccracken-paducah-sun",
    "name": "Paducah Sun",
    "category": "Kentucky - County Papers",
    "url": "https://www.paducahsun.com/news/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "McCracken",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-monroe-tompkinsville-news",
    "name": "Tompkinsville News",
    "category": "Kentucky - County Papers",
    "url": "https://www.tompkinsvillenews.com/feed",
    "state_code": "KY",
    "default_county": "Monroe",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-ohio-ohio-county-times-news",
    "name": "Ohio County Times-News",
    "category": "Kentucky - County Papers",
    "url": "https://www.octimesnews.com/feed",
    "state_code": "KY",
    "default_county": "Ohio",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-simpson-franklin-favorite",
    "name": "Franklin Favorite",
    "category": "Kentucky - County Papers",
    "url": "https://www.franklinfavorite.com/feed",
    "state_code": "KY",
    "default_county": "Simpson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-warren-bowling-green-daily-ne",
    "name": "Bowling Green Daily News",
    "category": "Kentucky - County Papers",
    "url": "https://bgdailynews.com/feed",
    "state_code": "KY",
    "default_county": "Warren",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-warren-college-heights-herald",
    "name": "College Heights Herald",
    "category": "Kentucky - County Papers",
    "url": "https://wkuherald.com/feed",
    "state_code": "KY",
    "default_county": "Warren",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-wayne-wayne-weekly",
    "name": "Wayne Weekly",
    "category": "Kentucky - County Papers",
    "url": "https://www.thewayneweekly.com/feed",
    "state_code": "KY",
    "default_county": "Wayne",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-webster-sebree-banner",
    "name": "Sebree Banner",
    "category": "Kentucky - County Papers",
    "url": "https://www.cpcnewspapers.com/feed",
    "state_code": "KY",
    "default_county": "Webster",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-whitley-corbin-whitley-news-jo",
    "name": "Corbin/Whitley News Journal",
    "category": "Kentucky - County Papers",
    "url": "https://thenewsjournal.net/feed",
    "state_code": "KY",
    "default_county": "Whitley",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-boyd-greater-ashland-beacon",
    "name": "Greater Ashland Beacon",
    "category": "Kentucky - County Papers",
    "url": "https://www.ashlandbeacon.com/blog-feed.xml",
    "state_code": "KY",
    "default_county": "Boyd",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-larue-larue-county-herald-ne",
    "name": "LaRue County Herald News",
    "category": "Kentucky - County Papers",
    "url": "https://www.laruecountyheraldnews.com/feed",
    "state_code": "KY",
    "default_county": "LaRue",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-marion-lebanon-enterprise",
    "name": "Lebanon Enterprise",
    "category": "Kentucky - County Papers",
    "url": "https://www.lebanonenternews.com/feed",
    "state_code": "KY",
    "default_county": "Marion",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-lawrence-the-big-sandy-news",
    "name": "The Big Sandy News",
    "category": "Kentucky - County Papers",
    "url": "https://thebigsandynews.com/index-rally?format=rss",
    "state_code": "KY",
    "default_county": "Lawrence",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-fulton-the-current",
    "name": "The Current",
    "category": "Kentucky - County Papers",
    "url": "https://www.thecurrent.press/feed.atom",
    "state_code": "KY",
    "default_county": "Fulton",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-woodford-woodford-sun",
    "name": "Woodford Sun",
    "category": "Kentucky - County Papers",
    "url": "https://www.woodfordsun.com/blog-feed.xml",
    "state_code": "KY",
    "default_county": "Woodford",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-adair",
    "name": "Adair County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Adair%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Adair",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-allen",
    "name": "Allen County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Allen%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Allen",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-anderson",
    "name": "Anderson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Anderson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Anderson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-ballard",
    "name": "Ballard County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Ballard%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Ballard",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-barren",
    "name": "Barren County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Barren%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Barren",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-bath",
    "name": "Bath County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Bath%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Bath",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-bell",
    "name": "Bell County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Bell%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Bell",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-boone",
    "name": "Boone County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Boone%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Boone",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-bourbon",
    "name": "Bourbon County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Bourbon%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Bourbon",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-boyd",
    "name": "Boyd County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Boyd%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Boyd",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-boyle",
    "name": "Boyle County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Boyle%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Boyle",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-bracken",
    "name": "Bracken County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Bracken%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Bracken",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-breathitt",
    "name": "Breathitt County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Breathitt%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Breathitt",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-breckinridge",
    "name": "Breckinridge County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Breckinridge%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Breckinridge",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-bullitt",
    "name": "Bullitt County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Bullitt%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Bullitt",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-butler",
    "name": "Butler County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Butler%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Butler",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-caldwell",
    "name": "Caldwell County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Caldwell%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Caldwell",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-calloway",
    "name": "Calloway County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Calloway%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Calloway",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-campbell",
    "name": "Campbell County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Campbell%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Campbell",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-carlisle",
    "name": "Carlisle County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Carlisle%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Carlisle",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-carroll",
    "name": "Carroll County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Carroll%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Carroll",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-carter",
    "name": "Carter County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Carter%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Carter",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-casey",
    "name": "Casey County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Casey%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Casey",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-christian",
    "name": "Christian County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Christian%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Christian",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-clark",
    "name": "Clark County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Clark%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Clark",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-clay",
    "name": "Clay County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Clay%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Clay",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-clinton",
    "name": "Clinton County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Clinton%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Clinton",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-crittenden",
    "name": "Crittenden County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Crittenden%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Crittenden",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-cumberland",
    "name": "Cumberland County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Cumberland%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Cumberland",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-daviess",
    "name": "Daviess County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Daviess%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Daviess",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-edmonson",
    "name": "Edmonson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Edmonson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Edmonson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-elliott",
    "name": "Elliott County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Elliott%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Elliott",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-estill",
    "name": "Estill County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Estill%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Estill",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-fayette",
    "name": "Fayette County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Fayette%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Fayette",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-fleming",
    "name": "Fleming County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Fleming%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Fleming",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-floyd",
    "name": "Floyd County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Floyd%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Floyd",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-franklin",
    "name": "Franklin County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Franklin%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Franklin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-fulton",
    "name": "Fulton County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Fulton%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Fulton",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-gallatin",
    "name": "Gallatin County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Gallatin%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Gallatin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-garrard",
    "name": "Garrard County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Garrard%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Garrard",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-grant",
    "name": "Grant County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Grant%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Grant",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-graves",
    "name": "Graves County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Graves%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Graves",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-grayson",
    "name": "Grayson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Grayson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Grayson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-green",
    "name": "Green County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Green%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Green",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-greenup",
    "name": "Greenup County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Greenup%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Greenup",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-hancock",
    "name": "Hancock County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Hancock%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Hancock",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-hardin",
    "name": "Hardin County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Hardin%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Hardin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-harlan",
    "name": "Harlan County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Harlan%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Harlan",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-harrison",
    "name": "Harrison County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Harrison%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Harrison",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-hart",
    "name": "Hart County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Hart%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Hart",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-henderson",
    "name": "Henderson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Henderson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Henderson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-henry",
    "name": "Henry County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Henry%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Henry",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-hickman",
    "name": "Hickman County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Hickman%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Hickman",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-hopkins",
    "name": "Hopkins County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Hopkins%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Hopkins",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-jackson",
    "name": "Jackson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Jackson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Jackson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-jefferson",
    "name": "Jefferson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Jefferson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Jefferson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-jessamine",
    "name": "Jessamine County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Jessamine%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Jessamine",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-johnson",
    "name": "Johnson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Johnson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Johnson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-kenton",
    "name": "Kenton County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Kenton%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Kenton",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-knott",
    "name": "Knott County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Knott%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Knott",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-knox",
    "name": "Knox County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Knox%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Knox",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-larue",
    "name": "Larue County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Larue%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Larue",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-laurel",
    "name": "Laurel County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Laurel%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Laurel",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-lawrence",
    "name": "Lawrence County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Lawrence%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Lawrence",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-lee",
    "name": "Lee County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Lee%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Lee",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-leslie",
    "name": "Leslie County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Leslie%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Leslie",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-letcher",
    "name": "Letcher County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Letcher%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Letcher",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-lewis",
    "name": "Lewis County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Lewis%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Lewis",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-lincoln",
    "name": "Lincoln County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Lincoln%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Lincoln",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-livingston",
    "name": "Livingston County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Livingston%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Livingston",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-logan",
    "name": "Logan County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Logan%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Logan",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-lyon",
    "name": "Lyon County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Lyon%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Lyon",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-madison",
    "name": "Madison County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Madison%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Madison",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-magoffin",
    "name": "Magoffin County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Magoffin%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Magoffin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-marion",
    "name": "Marion County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Marion%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Marion",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-marshall",
    "name": "Marshall County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Marshall%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Marshall",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-martin",
    "name": "Martin County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Martin%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Martin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-mason",
    "name": "Mason County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Mason%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Mason",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-mccracken",
    "name": "McCracken County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=McCracken%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "McCracken",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-mccreary",
    "name": "McCreary County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=McCreary%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "McCreary",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-mclean",
    "name": "McLean County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=McLean%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "McLean",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-meade",
    "name": "Meade County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Meade%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Meade",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-menifee",
    "name": "Menifee County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Menifee%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Menifee",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-mercer",
    "name": "Mercer County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Mercer%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Mercer",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-metcalfe",
    "name": "Metcalfe County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Metcalfe%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Metcalfe",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-monroe",
    "name": "Monroe County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Monroe%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Monroe",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-montgomery",
    "name": "Montgomery County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Montgomery%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Montgomery",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-morgan",
    "name": "Morgan County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Morgan%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Morgan",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-muhlenberg",
    "name": "Muhlenberg County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Muhlenberg%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Muhlenberg",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-nelson",
    "name": "Nelson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Nelson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Nelson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-nicholas",
    "name": "Nicholas County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Nicholas%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Nicholas",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-ohio",
    "name": "Ohio County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Ohio%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Ohio",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-oldham",
    "name": "Oldham County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Oldham%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Oldham",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-owen",
    "name": "Owen County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Owen%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Owen",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-owsley",
    "name": "Owsley County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Owsley%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Owsley",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-pendleton",
    "name": "Pendleton County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Pendleton%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Pendleton",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-perry",
    "name": "Perry County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Perry%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Perry",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-pike",
    "name": "Pike County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Pike%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Pike",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-powell",
    "name": "Powell County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Powell%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Powell",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-pulaski",
    "name": "Pulaski County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Pulaski%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Pulaski",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-robertson",
    "name": "Robertson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Robertson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Robertson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-rockcastle",
    "name": "Rockcastle County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Rockcastle%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Rockcastle",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-rowan",
    "name": "Rowan County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Rowan%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Rowan",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-russell",
    "name": "Russell County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Russell%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Russell",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-scott",
    "name": "Scott County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Scott%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Scott",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-shelby",
    "name": "Shelby County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Shelby%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Shelby",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-simpson",
    "name": "Simpson County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Simpson%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Simpson",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-spencer",
    "name": "Spencer County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Spencer%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Spencer",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-taylor",
    "name": "Taylor County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Taylor%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Taylor",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-todd",
    "name": "Todd County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Todd%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Todd",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-trigg",
    "name": "Trigg County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Trigg%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Trigg",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-trimble",
    "name": "Trimble County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Trimble%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Trimble",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-union",
    "name": "Union County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Union%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Union",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-warren",
    "name": "Warren County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Warren%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Warren",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-washington",
    "name": "Washington County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Washington%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Washington",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-wayne",
    "name": "Wayne County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Wayne%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Wayne",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-webster",
    "name": "Webster County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Webster%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Webster",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-whitley",
    "name": "Whitley County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Whitley%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Whitley",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-wolfe",
    "name": "Wolfe County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Wolfe%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Wolfe",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-woodford",
    "name": "Woodford County Watch",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Woodford%20County%20Kentucky&format=rss",
    "state_code": "KY",
    "default_county": "Woodford",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-kentuckylantern-latest",
    "name": "Kentucky Lantern Latest",
    "category": "Kentucky - Statewide",
    "url": "https://kentuckylantern.com/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wave3-arc",
    "name": "WAVE 3 News",
    "category": "Kentucky - TV",
    "url": "https://www.wave3.com/arc/outboundfeeds/rss/?outputType=xml",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wkyt-arc",
    "name": "WKYT News",
    "category": "Kentucky - TV",
    "url": "https://www.wkyt.com/arc/outboundfeeds/rss/?outputType=xml",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wymt-arc",
    "name": "WYMT News",
    "category": "Kentucky - Regional",
    "url": "https://www.wymt.com/arc/outboundfeeds/rss/?outputType=xml",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wbko-arc",
    "name": "WBKO News",
    "category": "Kentucky - TV",
    "url": "https://www.wbko.com/arc/outboundfeeds/rss/?outputType=xml",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wkms-regional-news",
    "name": "WKMS Regional News",
    "category": "Kentucky - Radio",
    "url": "https://www.wkms.org/rss.xml",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-nkytribune",
    "name": "NKyTribune",
    "category": "Kentucky - Local",
    "url": "https://www.nkytribune.com/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-lane-report",
    "name": "Lane Report",
    "category": "Kentucky - Business",
    "url": "https://www.lanereport.com/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-kentuckycom-homepage",
    "name": "Kentucky.com Headlines",
    "category": "Kentucky - Statewide",
    "url": "https://www.kentucky.com/latest-news/rss/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-messenger-inquirer",
    "name": "Messenger-Inquirer",
    "category": "Kentucky - Local",
    "url": "https://www.messenger-inquirer.com/news/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-shelby-sentinel-news",
    "name": "Sentinel-News",
    "category": "Kentucky - County Papers",
    "url": "https://www.pmg-ky1.com/search/?f=rss&t=article&c=sentinel_news&l=50&s=start_time&sd=desc",
    "state_code": "KY",
    "default_county": "Shelby",
    "region_scope": "ky",
    "enabled": 0
  },
  {
    "id": "ky-county-oldham-oldham-era",
    "name": "Oldham Era",
    "category": "Kentucky - County Papers",
    "url": "https://www.oldhamera.com/feed/",
    "state_code": "KY",
    "default_county": "Oldham",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-grant-grant-county-news",
    "name": "Grant County News",
    "category": "Kentucky - County Papers",
    "url": "https://www.pmg-ky3.com/search/?f=rss&t=article&c=grantco&l=50&s=start_time&sd=desc",
    "state_code": "KY",
    "default_county": "Grant",
    "region_scope": "ky",
    "enabled": 0
  },
  {
    "id": "ky-county-pike-appalachian-news-express",
    "name": "Appalachian News-Express",
    "category": "Kentucky - County Papers",
    "url": "https://www.news-expressky.com/news/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Pike",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wsaz-arc",
    "name": "WSAZ Tri-State News",
    "category": "Kentucky - Regional",
    "url": "https://www.wsaz.com/arc/outboundfeeds/rss/?outputType=xml",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-lpm-news-rss",
    "name": "LPM News",
    "category": "Kentucky - Radio",
    "url": "https://www.lpm.org/news.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-county-trigg-cadiz-record",
    "name": "Cadiz Record",
    "category": "Kentucky - County Papers",
    "url": "https://www.kentuckynewera.com/cadiz_record/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Trigg",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-obits-statewide-watch",
    "name": "Kentucky Obituaries Watch",
    "category": "Kentucky - Obituaries",
    "url": "https://www.bing.com/news/search?q=Kentucky%20obituaries&format=rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-obits-dailyindependent",
    "name": "Daily Independent Obituaries",
    "category": "Kentucky - Obituaries",
    "url": "https://www.dailyindependent.com/obituaries/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Boyd",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-obits-paducahsun",
    "name": "Paducah Sun Obituaries",
    "category": "Kentucky - Obituaries",
    "url": "https://www.paducahsun.com/obituaries/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "McCracken",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-obits-newsenterprise",
    "name": "News-Enterprise Obituaries",
    "category": "Kentucky - Obituaries",
    "url": "https://www.thenewsenterprise.com/obituaries/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Hardin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-obits-messenger-inquirer",
    "name": "Messenger-Inquirer Obituaries",
    "category": "Kentucky - Obituaries",
    "url": "https://www.messenger-inquirer.com/obituaries/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Daviess",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-obits-kentuckynewera",
    "name": "Kentucky New Era Obituaries",
    "category": "Kentucky - Obituaries",
    "url": "https://www.kentuckynewera.com/obituaries/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Christian",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-obits-richmondregister",
    "name": "Richmond Register Obituaries",
    "category": "Kentucky - Obituaries",
    "url": "https://www.richmondregister.com/obituaries/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Madison",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-obits-news-expressky",
    "name": "News-Express Obituaries",
    "category": "Kentucky - Obituaries",
    "url": "https://www.news-expressky.com/obituaries/",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "state_code": "KY",
    "default_county": "Pike",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-ballard-wickliffe",
    "name": "Ballard County Watch (Wickliffe)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Wickliffe%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Ballard",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-elliott-sandy-hook",
    "name": "Elliott County Watch (Sandy Hook)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Sandy%20Hook%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Elliott",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-gallatin-warsaw",
    "name": "Gallatin County Watch (Warsaw)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Warsaw%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Gallatin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-garrard-lancaster",
    "name": "Garrard County Watch (Lancaster)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Lancaster%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Garrard",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-marion-lebanon",
    "name": "Marion County Watch (Lebanon)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Lebanon%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Marion",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-trimble-bedford",
    "name": "Trimble County Watch (Bedford)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Bedford%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Trimble",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-ballard-lacenter",
    "name": "Ballard County Watch (La Center)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=La%20Center%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Ballard",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-elliott-isonville",
    "name": "Elliott County Watch (Isonville)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Isonville%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Elliott",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-gallatin-sparta",
    "name": "Gallatin County Watch (Sparta)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Sparta%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Gallatin",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-watch-garrard-paint-lick",
    "name": "Garrard County Watch (Paint Lick)",
    "category": "Kentucky - County Watch",
    "url": "https://www.bing.com/news/search?q=Paint%20Lick%20Kentucky%20news&format=rss",
    "state_code": "KY",
    "default_county": "Garrard",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wbontv",
    "name": "WBONTV Local News",
    "category": "Kentucky - Local",
    "url": "https://wbontv.com/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-mclean-county-journal",
    "name": "McLean County Journal",
    "category": "Kentucky - County Papers",
    "url": "https://www.messenger-inquirer.com/search/?f=rss&t=article&c=mclean_county&l=50&s=start_time&sd=desc",
    "state_code": "KY",
    "default_county": "McLean",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-business-lexington",
    "name": "Business Lexington",
    "category": "Kentucky - Business",
    "url": "https://smileypete.com/business/index.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-leo-weekly",
    "name": "LEO Weekly",
    "category": "Kentucky - Culture",
    "url": "https://www.leoweekly.com/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-hazard-herald",
    "name": "Hazard Herald",
    "category": "Kentucky - Local",
    "url": "https://www.hazard-herald.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc&k%5B%5D=%23topstory",
    "state_code": "KY",
    "default_county": "Perry",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-weku-news",
    "name": "WEKU News",
    "category": "Kentucky - Radio",
    "url": "https://www.weku.org/news.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-wnky-news",
    "name": "WNKY News",
    "category": "Kentucky - TV",
    "url": "https://www.wnky.com/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-sports-lex18",
    "name": "LEX18 Sports",
    "category": "Kentucky - Sports",
    "url": "https://www.lex18.com/sports.rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-sports-abc36",
    "name": "ABC36 Sports",
    "category": "Kentucky - Sports",
    "url": "https://www.wtvq.com/category/sports/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-sports-ukathletics",
    "name": "UK Athletics",
    "category": "Kentucky - Sports",
    "url": "https://ukathletics.com/feed/",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "ky-sports-gocards",
    "name": "Louisville Cardinals Athletics",
    "category": "Kentucky - Sports",
    "url": "https://gocards.com/rss",
    "state_code": "KY",
    "region_scope": "ky",
    "enabled": 1
  },
  {
    "id": "nat-sports-espn",
    "name": "ESPN Headlines",
    "category": "National - Sports",
    "url": "https://www.espn.com/espn/rss/news",
    "state_code": "US",
    "region_scope": "national",
    "enabled": 1
  },
  {
    "id": "nat-sports-cbssports",
    "name": "CBS Sports Headlines",
    "category": "National - Sports",
    "url": "https://www.cbssports.com/rss/headlines/",
    "state_code": "US",
    "region_scope": "national",
    "enabled": 1
  },
  {
    "id": "nat-sports-yahoo",
    "name": "Yahoo Sports",
    "category": "National - Sports",
    "url": "https://sports.yahoo.com/rss/",
    "state_code": "US",
    "region_scope": "national",
    "enabled": 1
  },
  {
    "id": "ky-courier-journal-news-scrape",
    "name": "Courier Journal News (Scrape)",
    "category": "Kentucky - Statewide",
    "url": "https://www.courier-journal.com/news/",
    "state_code": "KY",
    "region_scope": "ky",
    "fetch_mode": "scrape",
    "scraper_id": "gannett-story",
    "enabled": 1
  },
  {
    "id": "ky-courier-journal-politics-scrape",
    "name": "Courier Journal Politics (Scrape)",
    "category": "Kentucky - Politics",
    "url": "https://www.courier-journal.com/news/politics/",
    "state_code": "KY",
    "region_scope": "ky",
    "fetch_mode": "scrape",
    "scraper_id": "gannett-story",
    "enabled": 1
  },
  {
    "id": "ky-commonwealth-journal-scrape",
    "name": "Commonwealth Journal (Scrape)",
    "category": "Kentucky - Local",
    "url": "https://www.somerset-kentucky.com/news/",
    "state_code": "KY",
    "default_county": "Pulaski",
    "region_scope": "ky",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "enabled": 1
  },
  {
    "id": "ky-kentucky-standard-scrape",
    "name": "Kentucky Standard (Scrape)",
    "category": "Kentucky - Local",
    "url": "https://www.kystandard.com/news/",
    "state_code": "KY",
    "default_county": "Nelson",
    "region_scope": "ky",
    "fetch_mode": "scrape",
    "scraper_id": "townnews-article",
    "enabled": 1
  },
  {
    "id": "ky-kentuckycom-news-scrape",
    "name": "Kentucky.com News (Scrape)",
    "category": "Kentucky - Statewide",
    "url": "https://www.kentucky.com/news/",
    "state_code": "KY",
    "region_scope": "ky",
    "fetch_mode": "scrape",
    "scraper_id": "mcclatchy-article",
    "enabled": 0
  },
  { "id": "ky-fb-school-adair", "name": "Adair County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/adaircoschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Adair", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-allen", "name": "Allen County-Scottsville High School", "category": "Kentucky - Schools", "url": "https://www.facebook.com/allencountyscottsvillehighschool/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Allen", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-anderson", "name": "Anderson County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/acboe/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Anderson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-ballard", "name": "Ballard County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/100063755730159/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Ballard", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-barren", "name": "Barren County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/barrenschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Barren", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-bath", "name": "Bath County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/BathCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Bath", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-bell", "name": "Bell County School District", "category": "Kentucky - Schools", "url": "https://www.facebook.com/BellCountySchoolDistrict/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Bell", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-boone", "name": "Boone County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/TheBooneCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Boone", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-bourbon", "name": "Bourbon County School District", "category": "Kentucky - Schools", "url": "https://www.facebook.com/BourbonCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Bourbon", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-boyd", "name": "Boyd County Public School District", "category": "Kentucky - Schools", "url": "https://www.facebook.com/100065164023982/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Boyd", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-boyle", "name": "Boyle County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/boylecounty/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Boyle", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-bracken", "name": "Bracken County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/BrackenCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Bracken", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-breathitt", "name": "Breathitt County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/BreathittCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Breathitt", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-breckinridge", "name": "Breckinridge County School District", "category": "Kentucky - Schools", "url": "https://www.facebook.com/breckinridgecountyschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Breckinridge", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-butler", "name": "Butler County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/ButlerCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Butler", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-caldwell", "name": "Caldwell County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/CaldwellCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Caldwell", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-calloway", "name": "Calloway County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/callowaycoschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Calloway", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-campbell", "name": "Campbell County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/ccschoo1s/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Campbell", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-carlisle", "name": "Carlisle County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/carlislecountypublicschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Carlisle", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-carroll", "name": "Carroll County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/CarrollCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Carroll", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-carter", "name": "Carter County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/CarterCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Carter", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-casey", "name": "Casey County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/CaseyCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Casey", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-christian", "name": "Christian County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/ChristianCountyPublicSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Christian", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-clark", "name": "Clark County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/ClarkCountyPublicSchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Clark", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-clay", "name": "Clay County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/ClayCountyPublicSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Clay", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-clinton", "name": "Clinton County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/ClintonCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Clinton", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-crittenden", "name": "Crittenden County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/CrittendenCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Crittenden", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-cumberland", "name": "Cumberland County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/CumberlandCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Cumberland", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-daviess", "name": "Daviess County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/DCPSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Daviess", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-edmonson", "name": "Edmonson County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/EdmonsonCoSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Edmonson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-elliott", "name": "Elliott County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/ElliottCoSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Elliott", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-estill", "name": "Estill County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/EstillCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Estill", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-fayette", "name": "Fayette County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/fayettecountyschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Fayette", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-fleming", "name": "Fleming County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/FlemingCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Fleming", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-floyd", "name": "Floyd County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/floydcountyschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Floyd", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-franklin", "name": "Franklin County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/FranklinCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Franklin", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-fulton", "name": "Fulton County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/FultonCountySchoolDistrict/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Fulton", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-gallatin", "name": "Gallatin County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/GallatinCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Gallatin", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-garrard", "name": "Garrard County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/GarrardCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Garrard", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-grant", "name": "Grant County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/GrantCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Grant", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-graves", "name": "Graves County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/GravesCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Graves", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-grayson", "name": "Grayson County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/GraysonCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Grayson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-green", "name": "Green County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/GreenCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Green", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-greenup", "name": "Greenup County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/GreenupCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Greenup", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-hancock", "name": "Hancock County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/HancockCoSchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Hancock", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-hardin", "name": "Hardin County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/HardinCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Hardin", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-harlan", "name": "Harlan County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/HarlanCountyPublicSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Harlan", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-harrison", "name": "Harrison County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/HarrisonCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Harrison", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-hart", "name": "Hart County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/HartCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Hart", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-henderson", "name": "Henderson County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/HendersonCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Henderson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-henry", "name": "Henry County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/HenryCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Henry", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-hickman", "name": "Hickman County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/HickmanCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Hickman", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-hopkins", "name": "Hopkins County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/hopkinscountyschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Hopkins", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-jackson", "name": "Jackson County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/JacksonCountyPublicSchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Jackson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-jefferson", "name": "Jefferson County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/JCPSKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Jefferson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-jessamine", "name": "Jessamine County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/JessamineCountyKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Jessamine", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-johnson", "name": "Johnson County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/JohnsonCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Johnson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-kenton", "name": "Kenton County School District", "category": "Kentucky - Schools", "url": "https://www.facebook.com/KentonCountySchoolDistrict/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Kenton", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-knott", "name": "Knott County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/KnottCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Knott", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-knox", "name": "Knox County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/KnoxCountySchoolDistrictKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Knox", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-larue", "name": "LaRue County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LaRueCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Larue", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-laurel", "name": "Laurel County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LaurelCountyPublicSchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Laurel", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-lawrence", "name": "Lawrence County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LawrenceCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Lawrence", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-lee", "name": "Lee County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LeeCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Lee", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-leslie", "name": "Leslie County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LeslieCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Leslie", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-letcher", "name": "Letcher County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LetcherCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Letcher", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-lewis", "name": "Lewis County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LewisCoSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Lewis", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-lincoln", "name": "Lincoln County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LincolnCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Lincoln", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-livingston", "name": "Livingston County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LivingstonCountyKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Livingston", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-logan", "name": "Logan County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LoganCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Logan", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-lyon", "name": "Lyon County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/LyonCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Lyon", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-mccracken", "name": "McCracken County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/McCrackenCountyPublicSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "McCracken", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-mccreary", "name": "McCreary County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/McCrearyCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "McCreary", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-metcalfe", "name": "Metcalfe County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MetcalfeCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Metcalfe", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-monroe", "name": "Monroe County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MonroeCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Monroe", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-montgomery", "name": "Montgomery County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MontgomeryCountyKYSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Montgomery", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-morgan", "name": "Morgan County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MorganCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Morgan", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-muhlenberg", "name": "Muhlenberg County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MuhlenbergCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Muhlenberg", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-nelson", "name": "Nelson County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/NelsonCountyKySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Nelson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-nicholas", "name": "Nicholas County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/NicholasCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Nicholas", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-ohio", "name": "Ohio County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/OhioCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Ohio", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-oldham", "name": "Oldham County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/OldhamCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Oldham", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-owen", "name": "Owen County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/OwenCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Owen", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-owsley", "name": "Owsley County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/OwsleyCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Owsley", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-pendleton", "name": "Pendleton County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/PendletonCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Pendleton", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-perry", "name": "Perry County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/PerryCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Perry", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-pike", "name": "Pike County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/PikeCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Pike", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-powell", "name": "Powell County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/PowellCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Powell", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-pulaski", "name": "Pulaski County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/pulaskicountyschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Pulaski", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-robertson", "name": "Robertson County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/RobertsonCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Robertson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-rockcastle", "name": "Rockcastle County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/RockcastleCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Rockcastle", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-rowan", "name": "Rowan County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/RowanCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Rowan", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-russell", "name": "Russell County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/RussellCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Russell", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-scott", "name": "Scott County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/scottcountyschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Scott", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-shelby", "name": "Shelby County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/ShelbyCountyPublicSchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Shelby", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-simpson", "name": "Simpson County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/SimpsonCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Simpson", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-spencer", "name": "Spencer County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/SpencerCoKYSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Spencer", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-taylor", "name": "Taylor County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/TaylorCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Taylor", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-todd", "name": "Todd County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/toddcountyschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Todd", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-trigg", "name": "Trigg County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/TriggCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Trigg", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-trimble", "name": "Trimble County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/TrimbleCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Trimble", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-union", "name": "Union County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/UnionCountySchoolDistrict/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Union", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-warren", "name": "Warren County Public Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/WarrenCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Warren", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-washington", "name": "Washington County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/WashingtonCountyKYSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Washington", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-wayne", "name": "Wayne County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/WayneCountySchoolDistrict/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Wayne", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-webster", "name": "Webster County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/WebsterCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Webster", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-whitley", "name": "Whitley County School District", "category": "Kentucky - Schools", "url": "https://www.facebook.com/WhitleyCountySchoolDistrict/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Whitley", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-wolfe", "name": "Wolfe County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/WolfeCountyKYSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Wolfe", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-woodford", "name": "Woodford County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/WoodfordCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Woodford", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-bullitt", "name": "Bullitt County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/BullittCountySchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Bullitt", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-madison", "name": "Madison County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/madisoncoschools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Madison", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-magoffin", "name": "Magoffin County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MagoffinCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Magoffin", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-marion", "name": "Marion County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MarionCountyKYSchools/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Marion", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-marshall", "name": "Marshall County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MarshallCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Marshall", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-martin", "name": "Martin County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MartinCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Martin", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-mason", "name": "Mason County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MasonCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Mason", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-mclean", "name": "McLean County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/McLeanCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "McLean", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-meade", "name": "Meade County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MeadeCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Meade", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-menifee", "name": "Menifee County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MenifeeCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Menifee", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-school-mercer", "name": "Mercer County Schools", "category": "Kentucky - Schools", "url": "https://www.facebook.com/MercerCountySchoolsKY/", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Mercer", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-fb-perry-advocate", "name": "Perry Advocate", "category": "Kentucky - Local", "url": "https://www.facebook.com/perryadvocate", "fetch_mode": "facebook-page", "state_code": "KY", "default_county": "Perry", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-wymt-leslie", "name": "WYMT Leslie County News", "category": "Kentucky - Regional", "url": "https://www.wymt.com/arc/outboundfeeds/rss/tag/leslie-county/?outputType=xml", "state_code": "KY", "default_county": "Leslie", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-wymt-leslie-search", "name": "WYMT Leslie County Search", "category": "Kentucky - Regional", "url": "https://www.bing.com/news/search?q=site%3Awymt.com%20%22Leslie%20County%22&format=rss", "state_code": "KY", "default_county": "Leslie", "region_scope": "ky", "enabled": 1 },
  { "id": "ky-leslie-county-news", "name": "Leslie County News (Hyden)", "category": "Kentucky - County Watch", "url": "https://www.bing.com/news/search?q=%22Hyden%22%20Kentucky%20news&format=rss", "state_code": "KY", "default_county": "Leslie", "region_scope": "ky", "enabled": 1 }
]

```

# FULL_ARCHITECTURE.md

```md
# Full Architecture

Canonical architecture docs:

- `docs/02_INFORMATION_ARCHITECTURE.md`
- `docs/03_DATA_MODEL.md`
- `docs/09_CLOUDFLARE_DEPLOYMENT.md`
- `docs/11_OPERATIONS_RUNBOOK.md`

```

# functions\api\[[path]].js

```js
export async function onRequest(context) {
  const workerOrigin = context.env.API_ORIGIN || "https://ky-news-worker.jamesbrock25.workers.dev";

  const rawPath = context.params?.path;
  const path = Array.isArray(rawPath) ? rawPath.join("/") : String(rawPath || "");

  const incomingUrl = new URL(context.request.url);
  const upstreamUrl = new URL(`/api/${path}`, workerOrigin);
  upstreamUrl.search = incomingUrl.search;

  const headers = new Headers(context.request.headers);
  headers.set("x-forwarded-host", incomingUrl.host);
  headers.set("x-forwarded-proto", incomingUrl.protocol.replace(":", ""));

  const init = {
    method: context.request.method,
    headers,
    redirect: "follow"
  };

  if (context.request.method !== "GET" && context.request.method !== "HEAD") {
    init.body = context.request.body;
  }

  const upstream = await fetch(upstreamUrl.toString(), init);

  const responseHeaders = new Headers(upstream.headers);
  responseHeaders.set("x-api-proxy", "pages-function");

  return new Response(upstream.body, {
    status: upstream.status,
    statusText: upstream.statusText,
    headers: responseHeaders
  });
}

```

# index.html

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>FeedReader Workspace</title>
    <style>
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: #f6f7f9;
        color: #111827;
      }
      .wrap {
        max-width: 760px;
        margin: 56px auto;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
      }
      h1 { margin: 0 0 10px; font-size: 22px; }
      p { margin: 8px 0; line-height: 1.45; }
      code {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <h1>FeedReader local workspace</h1>
      <p>The active frontend is the Vite app in <code>apps/web</code>.</p>
      <p>Start everything with <code>npm run dev</code> and open <code>http://localhost:5173</code>.</p>
      <p>This root page intentionally does not run an app to avoid dual-frontend confusion.</p>
    </main>
  </body>
</html>

```

# INGESTER_PIPELINE.md

```md
# Ingester Pipeline

Pipeline documentation moved to:

- `docs/05_INGESTION_PIPELINE.md`

Implementation:
- `apps/ingester/src/ingester.mjs`
- `apps/ingester/src/util.mjs`

```

# Kentucky News Master Database

```
# Kentucky News Master Database
Comprehensive list of news websites that have published articles about:
- Kentucky (state)
- Kentucky counties
- Kentucky cities

Includes:
- Newspapers
- TV station news sites
- Digital-only outlets
- Radio/NPR news
- University publications
- Regional/national coverage

---

# STATEWIDE NEWS

https://kentuckylantern.com
https://www.kentucky.com
https://www.courier-journal.com
https://www.lpm.org
https://wfpl.org
https://www.weku.org
https://www.wuky.org
https://ket.org/news
https://kycir.org
https://www.kentuckyhealthnews.com

---

# MAJOR TV NEWS SITES

## Louisville
https://www.whas11.com
https://www.wdrb.com
https://www.wlky.com
https://spectrumnews1.com/ky/louisville

## Lexington
https://www.wkyt.com
https://www.lex18.com
https://www.wtvq.com

## Eastern Kentucky
https://www.wymt.com
https://www.wsaz.com

## Western Kentucky
https://www.wpsdlocal6.com
https://www.kfvs12.com

---

# MAJOR NEWSPAPERS

## Louisville Metro
https://www.courier-journal.com
https://www.voice-tribune.com
https://www.leoweekly.com

## Lexington Area
https://www.kentucky.com
https://www.lanereport.com
https://businesslexington.com

## Northern Kentucky
https://www.nkytribune.com
https://linknky.com
https://rivercitynews.com

---

# EASTERN KENTUCKY NEWSPAPERS

https://www.themountaineagle.com
https://www.thehazardherald.com
https://www.paintsvilleherald.com
https://www.thelevisalancer.com
https://www.themanchesterenterprise.com
https://www.floydcountytimes.com
https://www.dailyindependent.com
https://www.news-expressky.com

---

# CENTRAL KENTUCKY

https://www.amnews.com
https://www.state-journal.com
https://www.richmondregister.com
https://www.sentinel-echo.com
https://www.theinteriorjournal.com

---

# WESTERN KENTUCKY

https://www.paducahsun.com
https://www.kentuckynewera.com
https://www.messenger-inquirer.com
https://www.murrayledger.com
https://www.hendersongleaner.com

---

# SOUTHERN KENTUCKY

https://www.bgdailynews.com
https://www.somerset-kentucky.com
https://www.timestribune.com
https://www.themonroecountyreporter.com

---

# SMALL LOCAL WEEKLIES

https://www.graysonrecord.com
https://www.campbellsville.com
https://www.harlanenterprise.net
https://www.clintonnews.net
https://www.cumberlandtimes.com
https://www.owentonnewsherald.com
https://www.falmouthoutlook.com
https://www.harrisonnewsherald.com

---

# UNIVERSITY NEWS

https://kykernel.com
https://easternprogress.com
https://collegeheightsherald.com
https://thenewsenterprise.com

---

# RADIO NEWS

https://kypublicradio.org
https://wfpl.org
https://weku.org
https://wuky.org
https://wkms.org

---

# DIGITAL-ONLY LOCAL NEWS

https://www.nkytribune.com
https://rivercitynews.com
https://www.lanereport.com
https://businesslexington.com

---

# REGIONAL NEWS (FREQUENT KY COVERAGE)

https://apnews.com/hub/kentucky
https://www.reuters.com/world/us
https://www.cnn.com
https://www.nbcnews.com
https://www.foxnews.com
https://abcnews.go.com
https://www.usnews.com

---

# NEWSPAPER DIRECTORY SOURCES

https://kypress.com
https://newspaperlists.com/kentucky
https://libraries.uky.edu/newspapers

---

# NOTES

This master database combines:
- 175+ Kentucky newspapers
- 40+ TV station news sites
- 20+ radio/NPR sources
- Digital-only investigative outlets
- National coverage sources

Total potential source universe: 500+ when including all weekly local papers and national outlets.
```

# Kentucky_Counties_and_Cities.md

```md
# Kentucky Counties and Incorporated Cities

**Adair County:** Columbia

**Allen County:** Scottsville

**Anderson County:** Lawrenceburg

**Ballard County:** Barlow, Blandville, Kevil, La Center, Wickliffe

**Barren County:** Cave City, Glasgow, Park City

**Bath County:** Owingsville, Salt Lick, Sharpsburg

**Bell County:** Middlesboro, Pineville

**Boone County:** Florence, Union, Walton *(partially in Kenton)*

**Bourbon County:** Millersburg, North Middletown, Paris

**Boyd County:** Ashland, Catlettsburg

**Boyle County:** Danville, Junction City, Perryville

**Bracken County:** Augusta, Brooksville, Germantown *(partially in Mason)*

**Breathitt County:** Jackson

**Breckinridge County:** Cloverport, Hardinsburg, Irvington

**Bullitt County:** Fox Chase, Hebron Estates, Hillview, Huntertown, Lebanon Junction, Mount Washington, Pioneer Village, Shepherdsville

**Butler County:** Morgantown, Rochester, Woodbury

**Caldwell County:** Fredonia, Princeton

**Calloway County:** Hazel, Murray

**Campbell County:** Alexandria, Bellevue, California, Cold Spring, Crestview, Dayton, Fort Thomas, Highland Heights, Melbourne, Mentor, Newport, Silver Grove, Southgate, Wilder, Woodlawn

**Carlisle County:** Arlington, Bardwell

**Carroll County:** Carrollton, Ghent, Prestonville, Sanders, Worthville

**Carter County:** Grayson, Olive Hill

**Casey County:** Liberty

**Christian County:** Crofton, Hopkinsville, Lafayette, Oak Grove, Pembroke

**Clark County:** Winchester

**Clay County:** Manchester

**Clinton County:** Albany

**Crittenden County:** Marion

**Cumberland County:** Burkesville

**Daviess County:** Owensboro, Whitesville

**Edmonson County:** Brownsville

**Elliott County:** Sandy Hook

**Estill County:** Irvine, Ravenna

**Fayette County:** Lexington *(Consolidated City-County)*

**Fleming County:** Ewing, Flemingsburg, Nepton

**Floyd County:** Allen, Martin, Prestonsburg, Wayland, Wheelwright

**Franklin County:** Frankfort

**Fulton County:** Fulton, Hickman

**Gallatin County:** Glencoe, Sparta *(partially in Owen)*, Warsaw

**Garrard County:** Lancaster

**Grant County:** Corinth *(partially in Scott)*, Crittenden, Dry Ridge, Williamstown *(partially in Pendleton)*

**Graves County:** Mayfield, Water Valley, Wingo

**Grayson County:** Caneyville, Clarkson, Leitchfield

**Green County:** Greensburg

**Greenup County:** Bellefonte, Flatwoods, Greenup, Raceland, Russell, South Shore, Wurtland

**Hancock County:** Hawesville, Lewisport

**Hardin County:** Elizabethtown, Radcliff, Sonora, Upton *(partially in LaRue)*, Vine Grove, West Point

**Harlan County:** Benham, Cumberland, Evarts, Harlan, Loyall, Wallins Creek

**Harrison County:** Berry, Cynthiana

**Hart County:** Horse Cave, Munfordville

**Henderson County:** Corydon, Henderson, Robards

**Henry County:** Campbellsburg, Eminence, New Castle, Pleasureville *(partially in Shelby)*, Smithfield

**Hickman County:** Clinton, Columbus

**Hopkins County:** Dawson Springs *(partially in Caldwell)*, Earlington, Hanson, Madisonville, Mortons Gap, Nebo, Nortonville, St. Charles, White Plains

**Jackson County:** McKee

**Jefferson County:** Louisville *(Consolidated)*, Anchorage, Audubon Park, Bancroft, Barbourmeade, Beechwood, Bellemeade, Bellewood, Blue Ridge Manor, Briarwood, Broeck Pointe, Brownsboro Farm, Brownsboro Village, Cambridge, Coldstream, Creekside, Crossgate, Douglass Hills, Druid Hills, Fincastle, Forest Hills, Glenview, Glenview Hills, Glenview Manor, Goose Creek, Graymoor-Devondale, Green Spring, Heritage Creek, Hickory Hill, Hills and Dales, Hollow Creek, Hollyvilla, Houston Acres, Hurstbourne, Hurstbourne Acres, Indian Hills, Jeffersontown, Kingsley, Langdon Place, Lincolnshire, Lyndon, Lynnview, Manor Creek, Maryhill Estates, Meadow Vale, Meadowbrook Farm, Meadowview Estates, Middletown, Mockingbird Valley, Moorland, Murray Hill, Norbourne Estates, Northfield, Norwood, Old Brownsboro Place, Parkway Village, Plantation, Poplar Hills, Prospect *(partially in Oldham)*, Richlawn, Riverwood, Rolling Fields, Rolling Hills, St. Matthews, St. Regis Park, Seneca Gardens, Shively, South Park View, Spring Mill, Spring Valley, Strathmoor Manor, Strathmoor Village, Sycamore, Ten Broeck, Thornhill, Watterson Park, Wellington, West Buechel, Westwood, Wildwood, Windy Hills, Woodland Hills, Woodlawn Park, Worthington Hills

**Jessamine County:** Keene, Nicholasville, Wilmore

**Johnson County:** Paintsville

**Kenton County:** Bromley, Covington, Crescent Springs, Crestview Hills, Edgewood, Elsmere, Erlanger, Fairview, Fort Mitchell, Fort Wright, Independence, Kenton Vale, Lakeside Park, Ludlow, Park Hills, Ryland Heights, Taylor Mill, Villa Hills, Walton *(partially in Boone)*

**Knott County:** Hindman, Pippa Passes, Vicco *(partially in Perry)*

**Knox County:** Barbourville, Corbin *(partially in Whitley and Laurel)*

**LaRue County:** Hodgenville, Upton *(partially in Hardin)*

**Laurel County:** Corbin *(partially in Whitley and Knox)*, London

**Lawrence County:** Blaine, Louisa

**Lee County:** Beattyville

**Leslie County:** Hyden

**Letcher County:** Blackey, Fleming-Neon, Jenkins, Whitesburg

**Lewis County:** Concord, Vanceburg

**Lincoln County:** Crab Orchard, Hustonville, Stanford

**Livingston County:** Carrsville, Grand Rivers, Salem, Smithland

**Logan County:** Adairville, Auburn, Lewisburg, Russellville

**Lyon County:** Eddyville, Kuttawa

**Madison County:** Berea, Richmond

**Magoffin County:** Salyersville

**Marion County:** Bradfordsville, Lebanon, Loretto, Raywick, St. Mary

**Marshall County:** Benton, Calvert City, Hardin

**Martin County:** Inez, Warfield

**Mason County:** Dover, Germantown *(partially in Bracken)*, Maysville, Sardis

**McCracken County:** Paducah

**McCreary County:** *(No incorporated cities. Places like Whitley City, Pine Knot, and Stearns are unincorporated census-designated places.)*

**McLean County:** Calhoun, Island, Livermore, Sacramento

**Meade County:** Brandenburg, Ekron, Muldraugh

**Menifee County:** Frenchburg

**Mercer County:** Burgin, Harrodsburg

**Metcalfe County:** Edmonton

**Monroe County:** Fountain Run, Gamaliel, Tompkinsville

**Montgomery County:** Camargo, Jeffersonville, Mount Sterling

**Morgan County:** West Liberty

**Muhlenberg County:** Bremen, Central City, Drakesboro, Greenville, Powderly, South Carrollton

**Nelson County:** Bardstown, Bloomfield, Fairfield, New Haven

**Nicholas County:** Carlisle

**Ohio County:** Beaver Dam, Centertown, Fordsville, Hartford, McHenry, Rockport

**Oldham County:** Crestwood, Goshen, La Grange, Orchard Grass Hills, Pewee Valley, Prospect *(partially in Jefferson)*, River Bluff

**Owen County:** Gratz, Monterey, Owenton, Sparta *(partially in Gallatin)*

**Owsley County:** Booneville

**Pendleton County:** Butler, Falmouth

**Perry County:** Buckhorn, Hazard, Vicco *(partially in Knott)*

**Pike County:** Coal Run Village, Elkhorn City, Pikeville

**Powell County:** Clay City, Stanton

**Pulaski County:** Burnside, Eubank *(partially in Lincoln)*, Ferguson, Science Hill, Somerset

**Robertson County:** Mount Olivet

**Rockcastle County:** Brodhead, Livingston, Mount Vernon

**Rowan County:** Morehead

**Russell County:** Jamestown, Russell Springs

**Scott County:** Georgetown, Sadieville, Stamping Ground

**Shelby County:** Pleasureville *(partially in Henry)*, Shelbyville, Simpsonville

**Simpson County:** Franklin

**Spencer County:** Taylorsville

**Taylor County:** Campbellsville

**Todd County:** Elkton, Guthrie, Trenton

**Trigg County:** Cadiz

**Trimble County:** Bedford, Milton

**Union County:** Morganfield, Sturgis, Uniontown, Waverly

**Warren County:** Bowling Green, Oakland, Plum Springs, Smiths Grove, Woodburn

**Washington County:** Mackville, Springfield, Willisburg

**Wayne County:** Monticello

**Webster County:** Clay, Dixon, Providence, Sebree, Slaughters, Wheatcroft

**Whitley County:** Corbin *(partially in Knox and Laurel)*, Williamsburg

**Wolfe County:** Campton

**Woodford County:** Midway, Versailles

```

# ky-news-worker\.editorconfig

```
# http://editorconfig.org
root = true

[*]
indent_style = tab
end_of_line = lf
charset = utf-8
trim_trailing_whitespace = true
insert_final_newline = true

[*.yml]
indent_style = space

```

# ky-news-worker\.gitignore

```
# Logs

logs
_.log
npm-debug.log_
yarn-debug.log*
yarn-error.log*
lerna-debug.log*
.pnpm-debug.log*

# Diagnostic reports (https://nodejs.org/api/report.html)

report.[0-9]_.[0-9]_.[0-9]_.[0-9]_.json

# Runtime data

pids
_.pid
_.seed
\*.pid.lock

# Directory for instrumented libs generated by jscoverage/JSCover

lib-cov

# Coverage directory used by tools like istanbul

coverage
\*.lcov

# nyc test coverage

.nyc_output

# Grunt intermediate storage (https://gruntjs.com/creating-plugins#storing-task-files)

.grunt

# Bower dependency directory (https://bower.io/)

bower_components

# node-waf configuration

.lock-wscript

# Compiled binary addons (https://nodejs.org/api/addons.html)

build/Release

# Dependency directories

node_modules/
jspm_packages/

# Snowpack dependency directory (https://snowpack.dev/)

web_modules/

# TypeScript cache

\*.tsbuildinfo

# Optional npm cache directory

.npm

# Optional eslint cache

.eslintcache

# Optional stylelint cache

.stylelintcache

# Microbundle cache

.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history

.node_repl_history

# Output of 'npm pack'

\*.tgz

# Yarn Integrity file

.yarn-integrity

# parcel-bundler cache (https://parceljs.org/)

.cache
.parcel-cache

# Next.js build output

.next
out

# Nuxt.js build / generate output

.nuxt
dist

# Gatsby files

.cache/

# Comment in the public line in if your project uses Gatsby and not Next.js

# https://nextjs.org/blog/next-9-1#public-directory-support

# public

# vuepress build output

.vuepress/dist

# vuepress v2.x temp and cache directory

.temp
.cache

# Docusaurus cache and generated files

.docusaurus

# Serverless directories

.serverless/

# FuseBox cache

.fusebox/

# DynamoDB Local files

.dynamodb/

# TernJS port file

.tern-port

# Stores VSCode versions used for testing VSCode extensions

.vscode-test

# yarn v2

.yarn/cache
.yarn/unplugged
.yarn/build-state.yml
.yarn/install-state.gz
.pnp.\*

# wrangler project

.dev.vars*
!.dev.vars.example
.env*
!.env.example
.wrangler/

```

# ky-news-worker\.prettierrc

```
{
	"printWidth": 140,
	"singleQuote": true,
	"semi": true,
	"useTabs": true
}

```

# ky-news-worker\.vscode\settings.json

```json
{
	"files.associations": {
		"wrangler.json": "jsonc"
	}
}
```

# ky-news-worker\.wrangler\state\v3\d1\miniflare-D1DatabaseObject\3dae10976fee6a61d73a1049be74ce0c06e82dc45d152fcd2b5dc3ba923a0c33.sqlite

This is a binary file of the type: Binary

# ky-news-worker\.wrangler\state\v3\d1\miniflare-D1DatabaseObject\3dae10976fee6a61d73a1049be74ce0c06e82dc45d152fcd2b5dc3ba923a0c33.sqlite-shm

This is a binary file of the type: Binary

# ky-news-worker\.wrangler\state\v3\d1\miniflare-D1DatabaseObject\3dae10976fee6a61d73a1049be74ce0c06e82dc45d152fcd2b5dc3ba923a0c33.sqlite-wal

This is a binary file of the type: Binary

# ky-news-worker\ads.txt

```txt
google.com, pub-9584112930078020, DIRECT, f08c47fec0942fa0

```

# ky-news-worker\AGENTS.md

```md
# Cloudflare Workers

STOP. Your knowledge of Cloudflare Workers APIs and limits may be outdated. Always retrieve current documentation before any Workers, KV, R2, D1, Durable Objects, Queues, Vectorize, AI, or Agents SDK task.

## Docs

- https://developers.cloudflare.com/workers/
- MCP: `https://docs.mcp.cloudflare.com/mcp`

For all limits and quotas, retrieve from the product's `/platform/limits/` page. eg. `/workers/platform/limits`

## Commands

| Command | Purpose |
|---------|---------|
| `npx wrangler dev` | Local development |
| `npx wrangler deploy` | Deploy to Cloudflare |
| `npx wrangler types` | Generate TypeScript types |

Run `wrangler types` after changing bindings in wrangler.jsonc.

## Node.js Compatibility

https://developers.cloudflare.com/workers/runtime-apis/nodejs/

## Errors

- **Error 1102** (CPU/Memory exceeded): Retrieve limits from `/workers/platform/limits/`
- **All errors**: https://developers.cloudflare.com/workers/observability/errors/

## Product Docs

Retrieve API references and limits from:
`/kv/` · `/r2/` · `/d1/` · `/durable-objects/` · `/queues/` · `/vectorize/` · `/workers-ai/` · `/agents/`

```

# ky-news-worker\migrations.zip

This is a binary file of the type: Compressed Archive

# ky-news-worker\migrations\0001_initial.sql

```sql
PRAGMA foreign_keys = ON;

CREATE TABLE IF NOT EXISTS feeds (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  category TEXT NOT NULL,
  url TEXT NOT NULL,
  state_code TEXT NOT NULL DEFAULT 'KY',
  default_county TEXT,
  region_scope TEXT NOT NULL DEFAULT 'ky',
  enabled INTEGER NOT NULL DEFAULT 1,
  etag TEXT,
  last_modified TEXT,
  last_checked_at TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS items (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  url TEXT NOT NULL,
  guid TEXT,
  author TEXT,
  region_scope TEXT NOT NULL DEFAULT 'ky',
  published_at TEXT,
  summary TEXT,
  content TEXT,
  image_url TEXT,
  fetched_at TEXT NOT NULL DEFAULT (datetime('now')),
  hash TEXT,
  article_checked_at TEXT,
  article_fetch_status TEXT,
  article_text_excerpt TEXT
);

CREATE TABLE IF NOT EXISTS feed_items (
  feed_id TEXT NOT NULL,
  item_id TEXT NOT NULL,
  PRIMARY KEY (feed_id, item_id),
  FOREIGN KEY (feed_id) REFERENCES feeds(id) ON DELETE CASCADE,
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS item_locations (
  item_id TEXT NOT NULL,
  state_code TEXT NOT NULL,
  county TEXT NOT NULL DEFAULT '',
  PRIMARY KEY (item_id, state_code, county),
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS fetch_runs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  started_at TEXT NOT NULL,
  finished_at TEXT,
  status TEXT NOT NULL,
  source TEXT,
  details_json TEXT
);

CREATE TABLE IF NOT EXISTS fetch_errors (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  feed_id TEXT,
  at TEXT NOT NULL,
  error TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS weather_forecasts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  state_code TEXT NOT NULL,
  county TEXT NOT NULL,
  forecast_json TEXT NOT NULL,
  fetched_at TEXT NOT NULL DEFAULT (datetime('now')),
  expires_at TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS weather_alerts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  alert_id TEXT NOT NULL,
  state_code TEXT NOT NULL,
  county TEXT NOT NULL,
  severity TEXT,
  event TEXT,
  headline TEXT,
  starts_at TEXT,
  ends_at TEXT,
  raw_json TEXT NOT NULL,
  fetched_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS lost_found_posts (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL CHECK (type IN ('lost', 'found')),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  county TEXT NOT NULL,
  state_code TEXT NOT NULL DEFAULT 'KY',
  contact_email_encrypted TEXT NOT NULL,
  show_contact INTEGER NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  submitted_at TEXT NOT NULL DEFAULT (datetime('now')),
  approved_at TEXT,
  rejected_at TEXT,
  expires_at TEXT NOT NULL,
  moderation_note TEXT
);

CREATE TABLE IF NOT EXISTS lost_found_images (
  id TEXT PRIMARY KEY,
  post_id TEXT NOT NULL,
  r2_key TEXT NOT NULL,
  width INTEGER,
  height INTEGER,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS lost_found_reports (
  id TEXT PRIMARY KEY,
  post_id TEXT NOT NULL,
  reason TEXT NOT NULL,
  reporter_ip_hash TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS admin_audit_log (
  id TEXT PRIMARY KEY,
  actor_email TEXT NOT NULL,
  action TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  payload_json TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS item_ai_summaries (
  item_id TEXT PRIMARY KEY,
  summary TEXT NOT NULL,
  model TEXT,
  source_hash TEXT,
  generated_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS item_media (
  item_id TEXT PRIMARY KEY,
  source_url TEXT NOT NULL,
  r2_key TEXT NOT NULL,
  content_type TEXT,
  bytes INTEGER,
  updated_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_feeds_region_scope ON feeds(region_scope);
CREATE INDEX IF NOT EXISTS idx_feeds_enabled_scope ON feeds(enabled, region_scope);
CREATE INDEX IF NOT EXISTS idx_items_published_at ON items(published_at);
CREATE INDEX IF NOT EXISTS idx_items_fetched_at ON items(fetched_at);
CREATE INDEX IF NOT EXISTS idx_items_region_scope ON items(region_scope);
CREATE INDEX IF NOT EXISTS idx_items_url ON items(url);
CREATE INDEX IF NOT EXISTS idx_feed_items_feed ON feed_items(feed_id);
CREATE INDEX IF NOT EXISTS idx_feed_items_item ON feed_items(item_id);
CREATE INDEX IF NOT EXISTS idx_item_locations_state ON item_locations(state_code);
CREATE INDEX IF NOT EXISTS idx_item_locations_county ON item_locations(state_code, county);
CREATE INDEX IF NOT EXISTS idx_item_locations_item ON item_locations(item_id);
CREATE INDEX IF NOT EXISTS idx_fetch_runs_started ON fetch_runs(started_at);
CREATE INDEX IF NOT EXISTS idx_fetch_errors_feed_at ON fetch_errors(feed_id, at);
CREATE INDEX IF NOT EXISTS idx_weather_forecasts_county ON weather_forecasts(state_code, county, fetched_at);
CREATE INDEX IF NOT EXISTS idx_weather_alerts_state_county ON weather_alerts(state_code, county, fetched_at);
CREATE INDEX IF NOT EXISTS idx_weather_alerts_alert_id ON weather_alerts(alert_id);
CREATE INDEX IF NOT EXISTS idx_lost_found_posts_status ON lost_found_posts(status, submitted_at);
CREATE INDEX IF NOT EXISTS idx_lost_found_posts_county ON lost_found_posts(state_code, county, status);
CREATE INDEX IF NOT EXISTS idx_lost_found_images_post_id ON lost_found_images(post_id);
CREATE INDEX IF NOT EXISTS idx_lost_found_reports_post_id ON lost_found_reports(post_id, created_at);
CREATE INDEX IF NOT EXISTS idx_admin_audit_created ON admin_audit_log(created_at);
CREATE INDEX IF NOT EXISTS idx_item_ai_generated ON item_ai_summaries(generated_at);

```

# ky-news-worker\migrations\0002_seed_feeds.sql

```sql
-- Auto-generated by scripts/generate-feed-seed-sql.mjs

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wlky-top',
  'WLKY Top Stories',
  'Kentucky - TV',
  'https://www.wlky.com/topstories-rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-lex18',
  'LEX18 Headlines',
  'Kentucky - TV',
  'https://www.lex18.com/index.rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wtvq-local',
  'ABC36 (WTVQ) Local News',
  'Kentucky - TV',
  'https://www.wtvq.com/category/local-news/feed',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-spectrum-lou',
  'Spectrum News Louisville Headlines',
  'Kentucky - Local',
  'https://spectrumlocalnews.com/services/contentfeed.ky%7Clouisville%7Cnews.landing.rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wdrb-search',
  'WDRB News (RSS Search)',
  'Kentucky - Local',
  'https://www.wdrb.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wpsd-search',
  'WPSD Local 6 (RSS Search)',
  'Kentucky - Local',
  'https://www.wpsdlocal6.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-kentuckylantern-politics',
  'Kentucky Lantern Politics',
  'Kentucky - Politics',
  'https://kentuckylantern.com/category/politics/feed/',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-forwardky',
  'ForwardKY Latest',
  'Kentucky - Politics',
  'https://www.forwardky.com/latest/rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-uknow-campus',
  'UKNow Campus News',
  'Kentucky - Education',
  'https://uknow.uky.edu/feeds/section/347/rss.xml',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-uknow-happenings',
  'UKNow Happenings',
  'Kentucky - Events',
  'https://uknow.uky.edu/feeds/section/426/rss.xml',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-lex18-news',
  'LEX18 News',
  'Kentucky - TV',
  'https://www.lex18.com/news.rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-lex18-weather',
  'LEX18 Weather',
  'Kentucky - Weather',
  'https://www.lex18.com/weather.rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wtvq-weather',
  'ABC36 (WTVQ) Weather',
  'Kentucky - Weather',
  'https://www.wtvq.com/category/weather/feed/',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-whas-news',
  'WHAS11 News',
  'Kentucky - TV',
  'https://www.whas11.com/feeds/syndication/rss/news',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-whas-weather',
  'WHAS11 Weather',
  'Kentucky - Weather',
  'https://www.whas11.com/feeds/syndication/rss/weather',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wfpl',
  'WFPL Louisville',
  'Kentucky - Radio',
  'https://wfpl.org/feed/',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-kentuckytoday',
  'Kentucky Today',
  'Kentucky - Statewide',
  'https://www.kentuckytoday.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-kentuckynewera',
  'Kentucky New Era',
  'Kentucky - Local',
  'https://www.kentuckynewera.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-timesleader',
  'The Times Leader',
  'Kentucky - Local',
  'https://www.timesleader.net/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-dailyindependent',
  'Daily Independent',
  'Kentucky - Local',
  'https://www.dailyindependent.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wcpo-state',
  'WCPO Kentucky',
  'Kentucky - Regional',
  'https://www.wcpo.com/news/state/state-kentucky.rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wowk-kentucky',
  'WOWK Kentucky',
  'Kentucky - Regional',
  'https://www.wowktv.com/news/kentucky/feed/',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'nat-nyt-home',
  'New York Times - Home Page',
  'National - General',
  'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml',
  'US',
  NULL,
  'national',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'nat-npr-news',
  'NPR - News',
  'National - General',
  'https://feeds.npr.org/1001/rss.xml',
  'US',
  NULL,
  'national',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'nat-bbc-us-canada',
  'BBC - US and Canada',
  'National - General',
  'https://feeds.bbci.co.uk/news/world/us_and_canada/rss.xml',
  'US',
  NULL,
  'national',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'nat-cnn-top',
  'CNN - Top Stories',
  'National - General',
  'https://rss.cnn.com/rss/edition.rss',
  'US',
  NULL,
  'national',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'nat-cbs-main',
  'CBS News - Top',
  'National - General',
  'https://www.cbsnews.com/latest/rss/main',
  'US',
  NULL,
  'national',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-adair-adair-progress',
  'Adair Progress',
  'Kentucky - County Papers',
  'https://www.adairprogress.com/feed',
  'KY',
  'Adair',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-bell-middlesboro-news',
  'Middlesboro News',
  'Kentucky - County Papers',
  'https://middlesboronews.com/feed',
  'KY',
  'Bell',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-bourbon-bourbon-county-citizen',
  'Bourbon County Citizen',
  'Kentucky - County Papers',
  'https://www.bourboncountycitizen.com/feed',
  'KY',
  'Bourbon',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-boyle-advocate-messenger',
  'Advocate Messenger',
  'Kentucky - County Papers',
  'https://amnews.com/feed',
  'KY',
  'Boyle',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-calloway-the-murray-sentinel',
  'The Murray Sentinel',
  'Kentucky - County Papers',
  'https://themurraysentinel.org/feed',
  'KY',
  'Calloway',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-campbell-the-northerner',
  'The Northerner',
  'Kentucky - County Papers',
  'https://www.thenortherner.com/feed',
  'KY',
  'Campbell',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-carter-carter-county-times',
  'Carter County Times',
  'Kentucky - County Papers',
  'https://cartercountytimes.com/feed',
  'KY',
  'Carter',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-clark-winchester-sun',
  'Winchester Sun',
  'Kentucky - County Papers',
  'https://winchestersun.com/feed',
  'KY',
  'Clark',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-daviess-owensboro-times',
  'Owensboro Times',
  'Kentucky - County Papers',
  'https://www.owensborotimes.com/feed',
  'KY',
  'Daviess',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-edmonson-edmonson-news',
  'Edmonson News',
  'Kentucky - County Papers',
  'https://www.jpinews.com/feed',
  'KY',
  'Edmonson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-fayette-kentucky-kernel',
  'Kentucky Kernel',
  'Kentucky - County Papers',
  'https://kykernel.com/feed',
  'KY',
  'Fayette',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-floyd-floyd-county-chronicle',
  'Floyd County Chronicle and Times',
  'Kentucky - County Papers',
  'https://www.floydct.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  'Floyd',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-franklin-frankfort-state-journa',
  'Frankfort State Journal',
  'Kentucky - County Papers',
  'https://state-journal.com/feed',
  'KY',
  'Franklin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-green-greensburg-record-hera',
  'Greensburg Record Herald',
  'Kentucky - County Papers',
  'https://www.record-herald.com/feed',
  'KY',
  'Green',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-hancock-hancock-clarion',
  'Hancock Clarion',
  'Kentucky - County Papers',
  'https://www.hancockclarion.com/feed',
  'KY',
  'Hancock',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-harlan-harlan-enterprise',
  'Harlan Enterprise',
  'Kentucky - County Papers',
  'https://harlanenterprise.net/feed',
  'KY',
  'Harlan',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-jessamine-jessamine-journal',
  'Jessamine Journal',
  'Kentucky - County Papers',
  'https://jessaminejournal.com/feed',
  'KY',
  'Jessamine',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-kenton-link-nky',
  'LINK nky',
  'Kentucky - County Papers',
  'https://linknky.com/feed',
  'KY',
  'Kenton',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-knott-troublesome-creek-time',
  'Troublesome Creek Times',
  'Kentucky - County Papers',
  'https://www.troublesomecreektimes.com/feed',
  'KY',
  'Knott',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-lewis-the-lewis-county-heral',
  'The Lewis County Herald',
  'Kentucky - County Papers',
  'https://lewiscountyherald.com/feed',
  'KY',
  'Lewis',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-lincoln-interior-journal',
  'Interior Journal',
  'Kentucky - County Papers',
  'https://theinteriorjournal.com/feed',
  'KY',
  'Lincoln',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-madison-richmond-register',
  'Richmond Register',
  'Kentucky - County Papers',
  'https://www.richmondregister.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  'Madison',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-magoffin-salyersville-independe',
  'Salyersville Independent',
  'Kentucky - County Papers',
  'https://salyersvilleindependent.com/feed',
  'KY',
  'Magoffin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-marshall-the-lake-news',
  'The Lake News',
  'Kentucky - County Papers',
  'https://www.thelakenews.com/feed',
  'KY',
  'Marshall',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-martin-mountain-citizen',
  'Mountain Citizen',
  'Kentucky - County Papers',
  'https://mountaincitizen.com/feed',
  'KY',
  'Martin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-mccracken-paducah-sun',
  'Paducah Sun',
  'Kentucky - County Papers',
  'https://www.paducahsun.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  'McCracken',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-monroe-tompkinsville-news',
  'Tompkinsville News',
  'Kentucky - County Papers',
  'https://www.tompkinsvillenews.com/feed',
  'KY',
  'Monroe',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-ohio-ohio-county-times-news',
  'Ohio County Times-News',
  'Kentucky - County Papers',
  'https://www.octimesnews.com/feed',
  'KY',
  'Ohio',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-simpson-franklin-favorite',
  'Franklin Favorite',
  'Kentucky - County Papers',
  'https://www.franklinfavorite.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  'Simpson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-warren-bowling-green-daily-ne',
  'Bowling Green Daily News',
  'Kentucky - County Papers',
  'https://bgdailynews.com/feed',
  'KY',
  'Warren',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-warren-college-heights-herald',
  'College Heights Herald',
  'Kentucky - County Papers',
  'https://wkuherald.com/feed',
  'KY',
  'Warren',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-wayne-wayne-weekly',
  'Wayne Weekly',
  'Kentucky - County Papers',
  'https://www.thewayneweekly.com/feed',
  'KY',
  'Wayne',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-webster-sebree-banner',
  'Sebree Banner',
  'Kentucky - County Papers',
  'https://www.cpcnewspapers.com/feed',
  'KY',
  'Webster',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-whitley-corbin-whitley-news-jo',
  'Corbin/Whitley News Journal',
  'Kentucky - County Papers',
  'https://thenewsjournal.net/feed',
  'KY',
  'Whitley',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-boyd-greater-ashland-beacon',
  'Greater Ashland Beacon',
  'Kentucky - County Papers',
  'https://www.ashlandbeacon.com/blog-feed.xml',
  'KY',
  'Boyd',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-larue-larue-county-herald-ne',
  'LaRue County Herald News',
  'Kentucky - County Papers',
  'https://www.pmg-ky2.com/search/?f=rss&t=article&c=larue&l=50&s=start_time&sd=desc',
  'KY',
  'LaRue',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-marion-lebanon-enterprise',
  'Lebanon Enterprise',
  'Kentucky - County Papers',
  'https://www.pmg-ky2.com/search/?f=rss&t=article&c=lebanon&l=50&s=start_time&sd=desc',
  'KY',
  'Marion',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-lawrence-the-big-sandy-news',
  'The Big Sandy News',
  'Kentucky - County Papers',
  'https://thebigsandynews.com/index-rally?format=rss',
  'KY',
  'Lawrence',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-fulton-the-current',
  'The Current',
  'Kentucky - County Papers',
  'https://www.thecurrent.press/feed.atom',
  'KY',
  'Fulton',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-woodford-woodford-sun',
  'Woodford Sun',
  'Kentucky - County Papers',
  'https://www.woodfordsun.com/blog-feed.xml',
  'KY',
  'Woodford',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-adair',
  'Adair County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Adair%20County%20Kentucky&format=rss',
  'KY',
  'Adair',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-allen',
  'Allen County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Allen%20County%20Kentucky&format=rss',
  'KY',
  'Allen',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-anderson',
  'Anderson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Anderson%20County%20Kentucky&format=rss',
  'KY',
  'Anderson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-ballard',
  'Ballard County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Ballard%20County%20Kentucky&format=rss',
  'KY',
  'Ballard',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-barren',
  'Barren County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Barren%20County%20Kentucky&format=rss',
  'KY',
  'Barren',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-bath',
  'Bath County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Bath%20County%20Kentucky&format=rss',
  'KY',
  'Bath',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-bell',
  'Bell County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Bell%20County%20Kentucky&format=rss',
  'KY',
  'Bell',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-boone',
  'Boone County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Boone%20County%20Kentucky&format=rss',
  'KY',
  'Boone',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-bourbon',
  'Bourbon County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Bourbon%20County%20Kentucky&format=rss',
  'KY',
  'Bourbon',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-boyd',
  'Boyd County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Boyd%20County%20Kentucky&format=rss',
  'KY',
  'Boyd',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-boyle',
  'Boyle County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Boyle%20County%20Kentucky&format=rss',
  'KY',
  'Boyle',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-bracken',
  'Bracken County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Bracken%20County%20Kentucky&format=rss',
  'KY',
  'Bracken',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-breathitt',
  'Breathitt County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Breathitt%20County%20Kentucky&format=rss',
  'KY',
  'Breathitt',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-breckinridge',
  'Breckinridge County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Breckinridge%20County%20Kentucky&format=rss',
  'KY',
  'Breckinridge',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-bullitt',
  'Bullitt County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Bullitt%20County%20Kentucky&format=rss',
  'KY',
  'Bullitt',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-butler',
  'Butler County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Butler%20County%20Kentucky&format=rss',
  'KY',
  'Butler',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-caldwell',
  'Caldwell County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Caldwell%20County%20Kentucky&format=rss',
  'KY',
  'Caldwell',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-calloway',
  'Calloway County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Calloway%20County%20Kentucky&format=rss',
  'KY',
  'Calloway',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-campbell',
  'Campbell County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Campbell%20County%20Kentucky&format=rss',
  'KY',
  'Campbell',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-carlisle',
  'Carlisle County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Carlisle%20County%20Kentucky&format=rss',
  'KY',
  'Carlisle',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-carroll',
  'Carroll County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Carroll%20County%20Kentucky&format=rss',
  'KY',
  'Carroll',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-carter',
  'Carter County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Carter%20County%20Kentucky&format=rss',
  'KY',
  'Carter',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-casey',
  'Casey County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Casey%20County%20Kentucky&format=rss',
  'KY',
  'Casey',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-christian',
  'Christian County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Christian%20County%20Kentucky&format=rss',
  'KY',
  'Christian',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-clark',
  'Clark County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Clark%20County%20Kentucky&format=rss',
  'KY',
  'Clark',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-clay',
  'Clay County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Clay%20County%20Kentucky&format=rss',
  'KY',
  'Clay',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-clinton',
  'Clinton County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Clinton%20County%20Kentucky&format=rss',
  'KY',
  'Clinton',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-crittenden',
  'Crittenden County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Crittenden%20County%20Kentucky&format=rss',
  'KY',
  'Crittenden',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-cumberland',
  'Cumberland County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Cumberland%20County%20Kentucky&format=rss',
  'KY',
  'Cumberland',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-daviess',
  'Daviess County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Daviess%20County%20Kentucky&format=rss',
  'KY',
  'Daviess',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-edmonson',
  'Edmonson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Edmonson%20County%20Kentucky&format=rss',
  'KY',
  'Edmonson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-elliott',
  'Elliott County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Elliott%20County%20Kentucky&format=rss',
  'KY',
  'Elliott',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-estill',
  'Estill County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Estill%20County%20Kentucky&format=rss',
  'KY',
  'Estill',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-fayette',
  'Fayette County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Fayette%20County%20Kentucky&format=rss',
  'KY',
  'Fayette',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-fleming',
  'Fleming County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Fleming%20County%20Kentucky&format=rss',
  'KY',
  'Fleming',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-floyd',
  'Floyd County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Floyd%20County%20Kentucky&format=rss',
  'KY',
  'Floyd',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-franklin',
  'Franklin County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Franklin%20County%20Kentucky&format=rss',
  'KY',
  'Franklin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-fulton',
  'Fulton County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Fulton%20County%20Kentucky&format=rss',
  'KY',
  'Fulton',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-gallatin',
  'Gallatin County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Gallatin%20County%20Kentucky&format=rss',
  'KY',
  'Gallatin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-garrard',
  'Garrard County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Garrard%20County%20Kentucky&format=rss',
  'KY',
  'Garrard',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-grant',
  'Grant County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Grant%20County%20Kentucky&format=rss',
  'KY',
  'Grant',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-graves',
  'Graves County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Graves%20County%20Kentucky&format=rss',
  'KY',
  'Graves',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-grayson',
  'Grayson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Grayson%20County%20Kentucky&format=rss',
  'KY',
  'Grayson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-green',
  'Green County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Green%20County%20Kentucky&format=rss',
  'KY',
  'Green',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-greenup',
  'Greenup County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Greenup%20County%20Kentucky&format=rss',
  'KY',
  'Greenup',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-hancock',
  'Hancock County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Hancock%20County%20Kentucky&format=rss',
  'KY',
  'Hancock',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-hardin',
  'Hardin County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Hardin%20County%20Kentucky&format=rss',
  'KY',
  'Hardin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-harlan',
  'Harlan County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Harlan%20County%20Kentucky&format=rss',
  'KY',
  'Harlan',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-harrison',
  'Harrison County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Harrison%20County%20Kentucky&format=rss',
  'KY',
  'Harrison',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-hart',
  'Hart County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Hart%20County%20Kentucky&format=rss',
  'KY',
  'Hart',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-henderson',
  'Henderson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Henderson%20County%20Kentucky&format=rss',
  'KY',
  'Henderson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-henry',
  'Henry County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Henry%20County%20Kentucky&format=rss',
  'KY',
  'Henry',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-hickman',
  'Hickman County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Hickman%20County%20Kentucky&format=rss',
  'KY',
  'Hickman',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-hopkins',
  'Hopkins County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Hopkins%20County%20Kentucky&format=rss',
  'KY',
  'Hopkins',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-jackson',
  'Jackson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Jackson%20County%20Kentucky&format=rss',
  'KY',
  'Jackson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-jefferson',
  'Jefferson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Jefferson%20County%20Kentucky&format=rss',
  'KY',
  'Jefferson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-jessamine',
  'Jessamine County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Jessamine%20County%20Kentucky&format=rss',
  'KY',
  'Jessamine',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-johnson',
  'Johnson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Johnson%20County%20Kentucky&format=rss',
  'KY',
  'Johnson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-kenton',
  'Kenton County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Kenton%20County%20Kentucky&format=rss',
  'KY',
  'Kenton',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-knott',
  'Knott County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Knott%20County%20Kentucky&format=rss',
  'KY',
  'Knott',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-knox',
  'Knox County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Knox%20County%20Kentucky&format=rss',
  'KY',
  'Knox',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-larue',
  'Larue County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Larue%20County%20Kentucky&format=rss',
  'KY',
  'Larue',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-laurel',
  'Laurel County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Laurel%20County%20Kentucky&format=rss',
  'KY',
  'Laurel',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-lawrence',
  'Lawrence County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Lawrence%20County%20Kentucky&format=rss',
  'KY',
  'Lawrence',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-lee',
  'Lee County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Lee%20County%20Kentucky&format=rss',
  'KY',
  'Lee',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-leslie',
  'Leslie County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Leslie%20County%20Kentucky&format=rss',
  'KY',
  'Leslie',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-letcher',
  'Letcher County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Letcher%20County%20Kentucky&format=rss',
  'KY',
  'Letcher',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-lewis',
  'Lewis County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Lewis%20County%20Kentucky&format=rss',
  'KY',
  'Lewis',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-lincoln',
  'Lincoln County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Lincoln%20County%20Kentucky&format=rss',
  'KY',
  'Lincoln',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-livingston',
  'Livingston County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Livingston%20County%20Kentucky&format=rss',
  'KY',
  'Livingston',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-logan',
  'Logan County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Logan%20County%20Kentucky&format=rss',
  'KY',
  'Logan',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-lyon',
  'Lyon County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Lyon%20County%20Kentucky&format=rss',
  'KY',
  'Lyon',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-madison',
  'Madison County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Madison%20County%20Kentucky&format=rss',
  'KY',
  'Madison',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-magoffin',
  'Magoffin County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Magoffin%20County%20Kentucky&format=rss',
  'KY',
  'Magoffin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-marion',
  'Marion County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Marion%20County%20Kentucky&format=rss',
  'KY',
  'Marion',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-marshall',
  'Marshall County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Marshall%20County%20Kentucky&format=rss',
  'KY',
  'Marshall',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-martin',
  'Martin County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Martin%20County%20Kentucky&format=rss',
  'KY',
  'Martin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-mason',
  'Mason County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Mason%20County%20Kentucky&format=rss',
  'KY',
  'Mason',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-mccracken',
  'McCracken County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=McCracken%20County%20Kentucky&format=rss',
  'KY',
  'McCracken',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-mccreary',
  'McCreary County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=McCreary%20County%20Kentucky&format=rss',
  'KY',
  'McCreary',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-mclean',
  'McLean County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=McLean%20County%20Kentucky&format=rss',
  'KY',
  'McLean',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-meade',
  'Meade County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Meade%20County%20Kentucky&format=rss',
  'KY',
  'Meade',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-menifee',
  'Menifee County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Menifee%20County%20Kentucky&format=rss',
  'KY',
  'Menifee',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-mercer',
  'Mercer County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Mercer%20County%20Kentucky&format=rss',
  'KY',
  'Mercer',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-metcalfe',
  'Metcalfe County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Metcalfe%20County%20Kentucky&format=rss',
  'KY',
  'Metcalfe',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-monroe',
  'Monroe County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Monroe%20County%20Kentucky&format=rss',
  'KY',
  'Monroe',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-montgomery',
  'Montgomery County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Montgomery%20County%20Kentucky&format=rss',
  'KY',
  'Montgomery',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-morgan',
  'Morgan County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Morgan%20County%20Kentucky&format=rss',
  'KY',
  'Morgan',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-muhlenberg',
  'Muhlenberg County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Muhlenberg%20County%20Kentucky&format=rss',
  'KY',
  'Muhlenberg',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-nelson',
  'Nelson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Nelson%20County%20Kentucky&format=rss',
  'KY',
  'Nelson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-nicholas',
  'Nicholas County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Nicholas%20County%20Kentucky&format=rss',
  'KY',
  'Nicholas',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-ohio',
  'Ohio County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Ohio%20County%20Kentucky&format=rss',
  'KY',
  'Ohio',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-oldham',
  'Oldham County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Oldham%20County%20Kentucky&format=rss',
  'KY',
  'Oldham',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-owen',
  'Owen County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Owen%20County%20Kentucky&format=rss',
  'KY',
  'Owen',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-owsley',
  'Owsley County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Owsley%20County%20Kentucky&format=rss',
  'KY',
  'Owsley',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-pendleton',
  'Pendleton County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Pendleton%20County%20Kentucky&format=rss',
  'KY',
  'Pendleton',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-perry',
  'Perry County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Perry%20County%20Kentucky&format=rss',
  'KY',
  'Perry',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-pike',
  'Pike County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Pike%20County%20Kentucky&format=rss',
  'KY',
  'Pike',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-powell',
  'Powell County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Powell%20County%20Kentucky&format=rss',
  'KY',
  'Powell',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-pulaski',
  'Pulaski County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Pulaski%20County%20Kentucky&format=rss',
  'KY',
  'Pulaski',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-robertson',
  'Robertson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Robertson%20County%20Kentucky&format=rss',
  'KY',
  'Robertson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-rockcastle',
  'Rockcastle County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Rockcastle%20County%20Kentucky&format=rss',
  'KY',
  'Rockcastle',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-rowan',
  'Rowan County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Rowan%20County%20Kentucky&format=rss',
  'KY',
  'Rowan',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-russell',
  'Russell County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Russell%20County%20Kentucky&format=rss',
  'KY',
  'Russell',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-scott',
  'Scott County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Scott%20County%20Kentucky&format=rss',
  'KY',
  'Scott',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-shelby',
  'Shelby County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Shelby%20County%20Kentucky&format=rss',
  'KY',
  'Shelby',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-simpson',
  'Simpson County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Simpson%20County%20Kentucky&format=rss',
  'KY',
  'Simpson',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-spencer',
  'Spencer County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Spencer%20County%20Kentucky&format=rss',
  'KY',
  'Spencer',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-taylor',
  'Taylor County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Taylor%20County%20Kentucky&format=rss',
  'KY',
  'Taylor',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-todd',
  'Todd County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Todd%20County%20Kentucky&format=rss',
  'KY',
  'Todd',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-trigg',
  'Trigg County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Trigg%20County%20Kentucky&format=rss',
  'KY',
  'Trigg',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-trimble',
  'Trimble County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Trimble%20County%20Kentucky&format=rss',
  'KY',
  'Trimble',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-union',
  'Union County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Union%20County%20Kentucky&format=rss',
  'KY',
  'Union',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-warren',
  'Warren County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Warren%20County%20Kentucky&format=rss',
  'KY',
  'Warren',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-washington',
  'Washington County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Washington%20County%20Kentucky&format=rss',
  'KY',
  'Washington',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-wayne',
  'Wayne County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Wayne%20County%20Kentucky&format=rss',
  'KY',
  'Wayne',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-webster',
  'Webster County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Webster%20County%20Kentucky&format=rss',
  'KY',
  'Webster',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-whitley',
  'Whitley County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Whitley%20County%20Kentucky&format=rss',
  'KY',
  'Whitley',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-wolfe',
  'Wolfe County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Wolfe%20County%20Kentucky&format=rss',
  'KY',
  'Wolfe',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-woodford',
  'Woodford County Watch',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Woodford%20County%20Kentucky&format=rss',
  'KY',
  'Woodford',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-kentuckylantern-latest',
  'Kentucky Lantern Latest',
  'Kentucky - Statewide',
  'https://kentuckylantern.com/feed/',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wave3-arc',
  'WAVE 3 News',
  'Kentucky - TV',
  'https://www.wave3.com/arc/outboundfeeds/rss/?outputType=xml',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wkyt-arc',
  'WKYT News',
  'Kentucky - TV',
  'https://www.wkyt.com/arc/outboundfeeds/rss/?outputType=xml',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wymt-arc',
  'WYMT News',
  'Kentucky - Regional',
  'https://www.wymt.com/arc/outboundfeeds/rss/?outputType=xml',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wbko-arc',
  'WBKO News',
  'Kentucky - TV',
  'https://www.wbko.com/arc/outboundfeeds/rss/?outputType=xml',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wkms-regional-news',
  'WKMS Regional News',
  'Kentucky - Radio',
  'https://www.wkms.org/rss.xml',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-nkytribune',
  'NKyTribune',
  'Kentucky - Local',
  'https://www.nkytribune.com/feed/',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-lane-report',
  'Lane Report',
  'Kentucky - Business',
  'https://www.lanereport.com/feed/',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-kentuckycom-homepage',
  'Kentucky.com Headlines',
  'Kentucky - Statewide',
  'https://feeds.mcclatchy.com/kentucky/stories',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-messenger-inquirer',
  'Messenger-Inquirer',
  'Kentucky - Local',
  'https://www.messenger-inquirer.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-shelby-sentinel-news',
  'Sentinel-News',
  'Kentucky - County Papers',
  'https://www.pmg-ky1.com/search/?f=rss&t=article&c=sentinel_news&l=50&s=start_time&sd=desc',
  'KY',
  'Shelby',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-oldham-oldham-era',
  'Oldham Era',
  'Kentucky - County Papers',
  'https://www.pmg-ky1.com/search/?f=rss&t=article&c=oldham_era&l=50&s=start_time&sd=desc',
  'KY',
  'Oldham',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-grant-grant-county-news',
  'Grant County News',
  'Kentucky - County Papers',
  'https://www.pmg-ky3.com/search/?f=rss&t=article&c=grantco&l=50&s=start_time&sd=desc',
  'KY',
  'Grant',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-pike-appalachian-news-express',
  'Appalachian News-Express',
  'Kentucky - County Papers',
  'https://www.news-expressky.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc&k%5B%5D=%23topstory',
  'KY',
  'Pike',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wsaz-arc',
  'WSAZ Tri-State News',
  'Kentucky - Regional',
  'https://www.wsaz.com/arc/outboundfeeds/rss/?outputType=xml',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-lpm-news-rss',
  'LPM News',
  'Kentucky - Radio',
  'https://www.lpm.org/news.rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-county-trigg-cadiz-record',
  'Cadiz Record',
  'Kentucky - County Papers',
  'https://www.kentuckynewera.com/search/?f=rss&t=article&c=cadiz_record&l=50&s=start_time&sd=desc',
  'KY',
  'Trigg',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-obits-statewide-watch',
  'Kentucky Obituaries Watch',
  'Kentucky - Obituaries',
  'https://www.bing.com/news/search?q=Kentucky%20obituaries&format=rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-obits-dailyindependent',
  'Daily Independent Obituaries',
  'Kentucky - Obituaries',
  'https://www.dailyindependent.com/search/?f=rss&t=article&c=obituaries&l=50&s=start_time&sd=desc',
  'KY',
  'Boyd',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-obits-paducahsun',
  'Paducah Sun Obituaries',
  'Kentucky - Obituaries',
  'https://www.paducahsun.com/search/?f=rss&t=article&c=obituaries&l=50&s=start_time&sd=desc',
  'KY',
  'McCracken',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-obits-newsenterprise',
  'News-Enterprise Obituaries',
  'Kentucky - Obituaries',
  'https://www.thenewsenterprise.com/search/?f=rss&t=article&c=obituaries&l=50&s=start_time&sd=desc',
  'KY',
  'Hardin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-obits-messenger-inquirer',
  'Messenger-Inquirer Obituaries',
  'Kentucky - Obituaries',
  'https://www.messenger-inquirer.com/search/?f=rss&t=article&c=obituaries&l=50&s=start_time&sd=desc',
  'KY',
  'Daviess',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-obits-kentuckynewera',
  'Kentucky New Era Obituaries',
  'Kentucky - Obituaries',
  'https://www.kentuckynewera.com/search/?f=rss&t=article&c=obituaries&l=50&s=start_time&sd=desc',
  'KY',
  'Christian',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-obits-richmondregister',
  'Richmond Register Obituaries',
  'Kentucky - Obituaries',
  'https://www.richmondregister.com/search/?f=rss&t=article&c=obituaries&l=50&s=start_time&sd=desc',
  'KY',
  'Madison',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-obits-news-expressky',
  'News-Express Obituaries',
  'Kentucky - Obituaries',
  'https://www.news-expressky.com/search/?f=rss&t=article&c=obituaries&l=50&s=start_time&sd=desc',
  'KY',
  'Pike',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-ballard-wickliffe',
  'Ballard County Watch (Wickliffe)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Wickliffe%20Kentucky%20news&format=rss',
  'KY',
  'Ballard',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-elliott-sandy-hook',
  'Elliott County Watch (Sandy Hook)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Sandy%20Hook%20Kentucky%20news&format=rss',
  'KY',
  'Elliott',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-gallatin-warsaw',
  'Gallatin County Watch (Warsaw)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Warsaw%20Kentucky%20news&format=rss',
  'KY',
  'Gallatin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-garrard-lancaster',
  'Garrard County Watch (Lancaster)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Lancaster%20Kentucky%20news&format=rss',
  'KY',
  'Garrard',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-marion-lebanon',
  'Marion County Watch (Lebanon)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Lebanon%20Kentucky%20news&format=rss',
  'KY',
  'Marion',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-trimble-bedford',
  'Trimble County Watch (Bedford)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Bedford%20Kentucky%20news&format=rss',
  'KY',
  'Trimble',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-ballard-lacenter',
  'Ballard County Watch (La Center)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=La%20Center%20Kentucky%20news&format=rss',
  'KY',
  'Ballard',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-elliott-isonville',
  'Elliott County Watch (Isonville)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Isonville%20Kentucky%20news&format=rss',
  'KY',
  'Elliott',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-gallatin-sparta',
  'Gallatin County Watch (Sparta)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Sparta%20Kentucky%20news&format=rss',
  'KY',
  'Gallatin',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-watch-garrard-paint-lick',
  'Garrard County Watch (Paint Lick)',
  'Kentucky - County Watch',
  'https://www.bing.com/news/search?q=Paint%20Lick%20Kentucky%20news&format=rss',
  'KY',
  'Garrard',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-wbontv',
  'WBONTV Local News',
  'Kentucky - Local',
  'https://wbontv.com/feed/',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-mclean-county-journal',
  'McLean County Journal',
  'Kentucky - County Papers',
  'https://www.messenger-inquirer.com/search/?f=rss&t=article&c=mclean_county&l=50&s=start_time&sd=desc',
  'KY',
  'McLean',
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES (
  'ky-business-lexington',
  'Business Lexington',
  'Kentucky - Business',
  'https://smileypete.com/business/index.rss',
  'KY',
  NULL,
  'ky',
  1
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  enabled=excluded.enabled;

```

# ky-news-worker\migrations\0003_admin_observability_perf_security.sql

```sql
PRAGMA foreign_keys = ON;

CREATE TABLE IF NOT EXISTS summary_review_queue (
  item_id TEXT PRIMARY KEY,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'edited')),
  queue_reason TEXT,
  reviewer_email TEXT,
  reviewed_at TEXT,
  reviewed_summary TEXT,
  note TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS item_tag_corrections (
  id TEXT PRIMARY KEY,
  item_id TEXT NOT NULL,
  actor_email TEXT NOT NULL,
  previous_tags_json TEXT,
  new_tags_json TEXT NOT NULL,
  note TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS feed_run_metrics (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  run_id INTEGER,
  feed_id TEXT NOT NULL,
  source TEXT,
  status TEXT NOT NULL,
  http_status INTEGER,
  duration_ms INTEGER,
  items_seen INTEGER NOT NULL DEFAULT 0,
  items_upserted INTEGER NOT NULL DEFAULT 0,
  error_message TEXT,
  checked_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (run_id) REFERENCES fetch_runs(id) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS ingestion_metrics (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  run_id INTEGER,
  source TEXT,
  status TEXT NOT NULL,
  feeds_processed INTEGER NOT NULL DEFAULT 0,
  feeds_updated INTEGER NOT NULL DEFAULT 0,
  items_seen INTEGER NOT NULL DEFAULT 0,
  items_upserted INTEGER NOT NULL DEFAULT 0,
  summaries_generated INTEGER NOT NULL DEFAULT 0,
  images_mirrored INTEGER NOT NULL DEFAULT 0,
  errors INTEGER NOT NULL DEFAULT 0,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (run_id) REFERENCES fetch_runs(id) ON DELETE SET NULL
);

CREATE TABLE IF NOT EXISTS app_error_events (
  id TEXT PRIMARY KEY,
  request_id TEXT,
  route TEXT,
  method TEXT,
  status_code INTEGER,
  actor_email TEXT,
  error_message TEXT NOT NULL,
  error_stack TEXT,
  meta_json TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  expires_at TEXT
);

CREATE INDEX IF NOT EXISTS idx_items_published_id ON items(published_at, id);
CREATE INDEX IF NOT EXISTS idx_items_fetched_id ON items(fetched_at, id);
CREATE INDEX IF NOT EXISTS idx_summary_review_status_created ON summary_review_queue(status, created_at);
CREATE INDEX IF NOT EXISTS idx_tag_corrections_item_created ON item_tag_corrections(item_id, created_at);
CREATE INDEX IF NOT EXISTS idx_feed_run_metrics_feed_checked ON feed_run_metrics(feed_id, checked_at);
CREATE INDEX IF NOT EXISTS idx_feed_run_metrics_status_checked ON feed_run_metrics(status, checked_at);
CREATE INDEX IF NOT EXISTS idx_ingestion_metrics_created ON ingestion_metrics(created_at);
CREATE INDEX IF NOT EXISTS idx_app_error_events_created ON app_error_events(created_at);
CREATE INDEX IF NOT EXISTS idx_app_error_events_route_created ON app_error_events(route, created_at);

```

# ky-news-worker\migrations\0004_admin_auth.sql

```sql
CREATE TABLE IF NOT EXISTS admins (
  id TEXT PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  role TEXT NOT NULL,
  token TEXT NOT NULL,
  created_at TEXT NOT NULL
);
```

# ky-news-worker\migrations\0005_feed_quality_and_direct_sources.sql

```sql
-- Disable aggregator-based feeds so ingestion prefers direct publisher/government sources.
UPDATE feeds
SET enabled = 0
WHERE url LIKE 'https://www.bing.com/news/search%'
   OR url LIKE 'https://news.google.com/rss/search%';

-- Add high-signal direct national, government, and Kentucky sources.
INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES
  ('nat-pbs-politics', 'PBS NewsHour Politics', 'National - Politics', 'https://www.pbs.org/newshour/feeds/rss/politics', 'US', NULL, 'national', 1),
  ('nat-abc-topstories', 'ABC News Top Stories', 'National - General', 'https://abcnews.go.com/abcnews/topstories', 'US', NULL, 'national', 1),
  ('nat-nbc-topstories', 'NBC News Top Stories', 'National - General', 'https://feeds.nbcnews.com/nbcnews/public/news', 'US', NULL, 'national', 1),
  ('nat-propublica-main', 'ProPublica Main Feed', 'National - Investigative', 'https://www.propublica.org/feeds/propublica/main', 'US', NULL, 'national', 1),
  ('nat-guardian-us', 'The Guardian US News', 'National - General', 'https://www.theguardian.com/us-news/rss', 'US', NULL, 'national', 1),
  ('nat-aljazeera-all', 'Al Jazeera - All News', 'National - World', 'https://www.aljazeera.com/xml/rss/all.xml', 'US', NULL, 'national', 1),
  ('nat-atlantic-all', 'The Atlantic - All Stories', 'National - Analysis', 'https://www.theatlantic.com/feed/all/', 'US', NULL, 'national', 1),
  ('nat-thehill', 'The Hill', 'National - Politics', 'https://thehill.com/feed/', 'US', NULL, 'national', 1),
  ('gov-doj-news', 'U.S. Department of Justice News', 'Government - Justice', 'https://www.justice.gov/feeds/justice-news.xml', 'US', NULL, 'national', 1),
  ('gov-doe-news', 'U.S. Department of Energy News', 'Government - Energy', 'https://www.energy.gov/rss.xml', 'US', NULL, 'national', 1),
  ('gov-fda-press', 'FDA Press Releases', 'Government - Health', 'https://www.fda.gov/about-fda/contact-fda/stay-informed/rss-feeds/press-releases/rss.xml', 'US', NULL, 'national', 1),
  ('gov-fda-recalls', 'FDA Recalls', 'Government - Public Safety', 'https://www.fda.gov/about-fda/contact-fda/stay-informed/rss-feeds/recalls/rss.xml', 'US', NULL, 'national', 1),
  ('gov-sec-press', 'SEC Press Releases', 'Government - Markets', 'https://www.sec.gov/news/pressreleases.rss', 'US', NULL, 'national', 1),
  ('gov-nasa-breaking', 'NASA Breaking News', 'Government - Science', 'https://www.nasa.gov/rss/dyn/breaking_news.rss', 'US', NULL, 'national', 1),
  ('gov-fed-press', 'Federal Reserve Press Releases', 'Government - Economy', 'https://www.federalreserve.gov/feeds/press_all.xml', 'US', NULL, 'national', 1),
  ('gov-nist-news', 'NIST News', 'Government - Science', 'https://www.nist.gov/news-events/news/rss.xml', 'US', NULL, 'national', 1),
  ('gov-cdc-travel-notices', 'CDC Travel Health Notices', 'Government - Health', 'https://wwwnc.cdc.gov/travel/rss/notices.xml', 'US', NULL, 'national', 1),
  ('ky-weku-news', 'WEKU News', 'Kentucky - Radio', 'https://www.weku.org/news.rss', 'KY', NULL, 'ky', 1),
  ('ky-wuky-news', 'WUKY News', 'Kentucky - Radio', 'https://www.wuky.org/wuky-news.rss', 'KY', NULL, 'ky', 1)
ON CONFLICT(id) DO UPDATE SET
  name = excluded.name,
  category = excluded.category,
  url = excluded.url,
  state_code = excluded.state_code,
  default_county = excluded.default_county,
  region_scope = excluded.region_scope,
  enabled = excluded.enabled;

```

# ky-news-worker\migrations\0006_sports_and_source_expansion.sql

```sql
-- Add missing direct Kentucky sources and sports-focused feeds.
INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, enabled)
VALUES
  ('ky-leo-weekly', 'LEO Weekly', 'Kentucky - Culture', 'https://www.leoweekly.com/feed/', 'KY', NULL, 'ky', 1),
  ('ky-hazard-herald', 'Hazard Herald', 'Kentucky - Local', 'https://www.hazard-herald.com/search/?f=rss&t=article&l=50&s=start_time&sd=desc&k%5B%5D=%23topstory', 'KY', 'Perry', 'ky', 1),
  ('ky-weku-news', 'WEKU News', 'Kentucky - Radio', 'https://www.weku.org/news.rss', 'KY', NULL, 'ky', 1),
  ('ky-wnky-news', 'WNKY News', 'Kentucky - TV', 'https://www.wnky.com/feed/', 'KY', NULL, 'ky', 1),
  ('ky-sports-lex18', 'LEX18 Sports', 'Kentucky - Sports', 'https://www.lex18.com/sports.rss', 'KY', NULL, 'ky', 1),
  ('ky-sports-abc36', 'ABC36 Sports', 'Kentucky - Sports', 'https://www.wtvq.com/category/sports/feed/', 'KY', NULL, 'ky', 1),
  ('ky-sports-ukathletics', 'UK Athletics', 'Kentucky - Sports', 'https://ukathletics.com/feed/', 'KY', NULL, 'ky', 1),
  ('ky-sports-gocards', 'Louisville Cardinals Athletics', 'Kentucky - Sports', 'https://gocards.com/rss', 'KY', NULL, 'ky', 1),
  ('nat-sports-espn', 'ESPN Headlines', 'National - Sports', 'https://www.espn.com/espn/rss/news', 'US', NULL, 'national', 1),
  ('nat-sports-cbssports', 'CBS Sports Headlines', 'National - Sports', 'https://www.cbssports.com/rss/headlines/', 'US', NULL, 'national', 1),
  ('nat-sports-yahoo', 'Yahoo Sports', 'National - Sports', 'https://sports.yahoo.com/rss/', 'US', NULL, 'national', 1)
ON CONFLICT(id) DO UPDATE SET
  name = excluded.name,
  category = excluded.category,
  url = excluded.url,
  state_code = excluded.state_code,
  default_county = excluded.default_county,
  region_scope = excluded.region_scope,
  enabled = excluded.enabled;

```

# ky-news-worker\migrations\0007_feed_scraper_support.sql

```sql
-- Feed-level scraper mode support for outlets without stable RSS.
ALTER TABLE feeds ADD COLUMN fetch_mode TEXT NOT NULL DEFAULT 'rss';
ALTER TABLE feeds ADD COLUMN scraper_id TEXT;

UPDATE feeds
SET fetch_mode = 'rss'
WHERE fetch_mode IS NULL OR trim(fetch_mode) = '';

CREATE INDEX IF NOT EXISTS idx_feeds_fetch_mode_enabled ON feeds(fetch_mode, enabled);

-- Non-RSS / bot-fragile outlet entries powered by custom scraper handlers.
INSERT INTO feeds (
  id,
  name,
  category,
  url,
  state_code,
  default_county,
  region_scope,
  fetch_mode,
  scraper_id,
  enabled
)
VALUES
  (
    'ky-courier-journal-news-scrape',
    'Courier Journal News (Scrape)',
    'Kentucky - Statewide',
    'https://www.courier-journal.com/news/',
    'KY',
    NULL,
    'ky',
    'scrape',
    'gannett-story',
    1
  ),
  (
    'ky-courier-journal-politics-scrape',
    'Courier Journal Politics (Scrape)',
    'Kentucky - Politics',
    'https://www.courier-journal.com/news/politics/',
    'KY',
    NULL,
    'ky',
    'scrape',
    'gannett-story',
    1
  ),
  (
    'ky-commonwealth-journal-scrape',
    'Commonwealth Journal (Scrape)',
    'Kentucky - Local',
    'https://www.somerset-kentucky.com/news/',
    'KY',
    'Pulaski',
    'ky',
    'scrape',
    'townnews-article',
    1
  ),
  (
    'ky-kentucky-standard-scrape',
    'Kentucky Standard (Scrape)',
    'Kentucky - Local',
    'https://www.kystandard.com/news/',
    'KY',
    'Nelson',
    'ky',
    'scrape',
    'townnews-article',
    1
  ),
  (
    'ky-kentuckycom-news-scrape',
    'Kentucky.com News (Scrape)',
    'Kentucky - Statewide',
    'https://www.kentucky.com/news/',
    'KY',
    NULL,
    'ky',
    'scrape',
    'mcclatchy-article',
    0
  )
ON CONFLICT(id) DO UPDATE SET
  name = excluded.name,
  category = excluded.category,
  url = excluded.url,
  state_code = excluded.state_code,
  default_county = excluded.default_county,
  region_scope = excluded.region_scope,
  fetch_mode = excluded.fetch_mode,
  scraper_id = excluded.scraper_id,
  enabled = excluded.enabled;

```

# ky-news-worker\migrations\0008_fix_feed_error_rates.sql

```sql
-- =============================================================================
-- 0008_fix_feed_error_rates.sql
--
-- Fixes the feeds reported as "critical" in the Feed Health panel (48h window).
-- Changes:
--   1. CNN RSS deprecated → replace with AP News Top News
--   2. Kentucky.com via McClatchy service → try direct Herald-Leader RSS
--   3. PMG internal routing domains (pmg-ky1/2/3.com) → disable; add Oldham Era
--      with actual public domain
--   4. TownNews CMS papers: switch search-RSS feeds to scrape mode
--   5. TownNews obituary feeds: switch to scrape mode
--   6. Other search-RSS feeds: try standard /feed/ endpoint
--   7. Clear feed_run_metrics + fetch_errors for affected feeds so the admin
--      health dashboard starts with a clean slate (shows "unknown" status until
--      the next successful ingestion run).
--
-- Apply with:
--   npx wrangler d1 execute ky_news_db --file=./migrations/0008_fix_feed_error_rates.sql --remote
-- =============================================================================

-- -----------------------------------------------------------------------------
-- 1. CNN Top Stories — CNN formally deprecated their public RSS feeds in 2024.
--    Replace with AP News Top News, which is a stable public RSS feed.
-- -----------------------------------------------------------------------------
UPDATE feeds
SET name       = 'AP News - Top Stories',
    url        = 'https://feeds.apnews.com/rss/apf-topnews',
    fetch_mode = 'rss'
WHERE id = 'nat-cnn-top';

-- Disable any other feeds still pointing to rss.cnn.com (e.g. a manually-added
-- "CNN News" feed with category "local").  The AP News feed above covers that slot.
UPDATE feeds
SET enabled = 0
WHERE url LIKE '%rss.cnn.com%' AND id != 'nat-cnn-top';

-- -----------------------------------------------------------------------------
-- 2. Kentucky.com via McClatchy aggregation service
--    feeds.mcclatchy.com is frequently unreliable.  Try the direct
--    Kentucky.com (Lexington Herald-Leader) RSS endpoint instead.
-- -----------------------------------------------------------------------------
UPDATE feeds
SET url = 'https://www.kentucky.com/latest-news/rss/'
WHERE id = 'ky-kentuckycom-homepage';

-- -----------------------------------------------------------------------------
-- 3. Paxton Media Group internal routing domains
--    pmg-ky1.com / pmg-ky2.com / pmg-ky3.com are PMG's private LAN-routing
--    domains and are NOT reachable from public internet / Cloudflare Workers.
--    Disable them all; the Oldham Era is re-added with its actual public domain.
-- -----------------------------------------------------------------------------
UPDATE feeds
SET enabled = 0
WHERE (   url LIKE 'https://www.pmg-ky1.com/%'
       OR url LIKE 'https://www.pmg-ky2.com/%'
       OR url LIKE 'https://www.pmg-ky3.com/%')
  AND enabled = 1;

-- Oldham Era: restore with its real public domain.
UPDATE feeds
SET url     = 'https://www.oldhamera.com/feed/',
    enabled = 1
WHERE id = 'ky-county-oldham-oldham-era';

-- -----------------------------------------------------------------------------
-- 4. Switch TownNews CMS papers from broken search-RSS to scrape mode.
--    The townnews-article scraper has dedicated support (article_XXXX.html URLs,
--    /news/, /sports/, /obituaries/ section crawling).
-- -----------------------------------------------------------------------------

-- Messenger-Inquirer (Owensboro, Daviess County)
UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.messenger-inquirer.com/news/'
WHERE id = 'ky-messenger-inquirer';

-- Paducah Sun (McCracken County)
UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.paducahsun.com/news/'
WHERE id = 'ky-county-mccracken-paducah-sun';

-- Richmond Register (Madison County)
UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.richmondregister.com/news/'
WHERE id = 'ky-county-madison-richmond-register';

-- Kentucky New Era (Hopkinsville, Christian County; also source for Cadiz Record)
UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.kentuckynewera.com/news/'
WHERE id = 'ky-kentuckynewera';

-- Daily Independent (Ashland, Boyd County)
UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.dailyindependent.com/news/'
WHERE id = 'ky-dailyindependent';

-- Floyd County Chronicle and Times (Floyd County)
UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.floydct.com/news/'
WHERE id = 'ky-county-floyd-floyd-county-chronicle';

-- Appalachian News-Express (Pike County)
UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.news-expressky.com/news/'
WHERE id = 'ky-county-pike-appalachian-news-express';

-- Cadiz Record (Trigg County) — published as a section of Kentucky New Era;
-- switch to scrape mode on its KNE section page.
UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.kentuckynewera.com/cadiz_record/'
WHERE id = 'ky-county-trigg-cadiz-record';

-- -----------------------------------------------------------------------------
-- 5. Switch TownNews obituary feeds to scrape mode.
--    The townnews-article scraper crawls /obituaries/ automatically.
-- -----------------------------------------------------------------------------

UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.messenger-inquirer.com/obituaries/'
WHERE id = 'ky-obits-messenger-inquirer';

UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.paducahsun.com/obituaries/'
WHERE id = 'ky-obits-paducahsun';

UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.richmondregister.com/obituaries/'
WHERE id = 'ky-obits-richmondregister';

UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.kentuckynewera.com/obituaries/'
WHERE id = 'ky-obits-kentuckynewera';

UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.dailyindependent.com/obituaries/'
WHERE id = 'ky-obits-dailyindependent';

UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.news-expressky.com/obituaries/'
WHERE id = 'ky-obits-news-expressky';

UPDATE feeds
SET fetch_mode = 'scrape',
    scraper_id = 'townnews-article',
    url        = 'https://www.thenewsenterprise.com/obituaries/'
WHERE id = 'ky-obits-newsenterprise';

-- -----------------------------------------------------------------------------
-- 6. Other search-RSS feeds: try standard WordPress /feed/ endpoints.
--    These sites may have migrated their CMS away from the Lee/Civitas search RSS.
-- -----------------------------------------------------------------------------

-- Franklin Favorite (Simpson County)
UPDATE feeds
SET url = 'https://www.franklinfavorite.com/feed'
WHERE id = 'ky-county-simpson-franklin-favorite';

-- WDRB Louisville — search-RSS may have changed with station CMS migration
UPDATE feeds
SET url = 'https://www.wdrb.com/news/feed/'
WHERE id = 'ky-wdrb-search';

-- Kentucky Today (Baptist newspaper, statewide)
UPDATE feeds
SET url = 'https://www.kentuckytoday.com/feed'
WHERE id = 'ky-kentuckytoday';

-- The Times Leader (Pikeville)
UPDATE feeds
SET url = 'https://www.timesleader.net/feed'
WHERE id = 'ky-timesleader';

-- -----------------------------------------------------------------------------
-- 7. Reset metrics for all changed feeds so the health dashboard starts fresh.
--    Feeds will show "unknown" status until their next successful ingestion run,
--    which is far preferable to carrying forward stale 80–100 % error rates.
-- -----------------------------------------------------------------------------

DELETE FROM feed_run_metrics
WHERE feed_id IN (
  'nat-cnn-top',
  'ky-kentuckycom-homepage',
  'ky-messenger-inquirer',
  'ky-county-mccracken-paducah-sun',
  'ky-county-madison-richmond-register',
  'ky-kentuckynewera',
  'ky-dailyindependent',
  'ky-county-floyd-floyd-county-chronicle',
  'ky-county-pike-appalachian-news-express',
  'ky-county-trigg-cadiz-record',
  'ky-county-larue-larue-county-herald-ne',
  'ky-county-marion-lebanon-enterprise',
  'ky-county-oldham-oldham-era',
  'ky-county-simpson-franklin-favorite',
  'ky-wdrb-search',
  'ky-kentuckytoday',
  'ky-timesleader',
  'ky-nkytribune',
  'ky-obits-messenger-inquirer',
  'ky-obits-paducahsun',
  'ky-obits-richmondregister',
  'ky-obits-kentuckynewera',
  'ky-obits-dailyindependent',
  'ky-obits-news-expressky',
  'ky-obits-newsenterprise'
);

DELETE FROM fetch_errors
WHERE feed_id IN (
  'nat-cnn-top',
  'ky-kentuckycom-homepage',
  'ky-messenger-inquirer',
  'ky-county-mccracken-paducah-sun',
  'ky-county-madison-richmond-register',
  'ky-kentuckynewera',
  'ky-dailyindependent',
  'ky-county-floyd-floyd-county-chronicle',
  'ky-county-pike-appalachian-news-express',
  'ky-county-trigg-cadiz-record',
  'ky-county-larue-larue-county-herald-ne',
  'ky-county-marion-lebanon-enterprise',
  'ky-county-oldham-oldham-era',
  'ky-county-simpson-franklin-favorite',
  'ky-wdrb-search',
  'ky-kentuckytoday',
  'ky-timesleader',
  'ky-nkytribune',
  'ky-obits-messenger-inquirer',
  'ky-obits-paducahsun',
  'ky-obits-richmondregister',
  'ky-obits-kentuckynewera',
  'ky-obits-dailyindependent',
  'ky-obits-news-expresky',
  'ky-obits-newsenterprise'
);

```

# ky-news-worker\migrations\0009_summary_seo_descriptions.sql

```sql
ALTER TABLE items ADD COLUMN seo_description TEXT;
ALTER TABLE item_ai_summaries ADD COLUMN seo_description TEXT;

```

# ky-news-worker\migrations\0010_facebook_schools.sql

```sql
-- Migration 0010: Add Kentucky county school Facebook page feeds and Perry Advocate Facebook news feed.
-- fetch_mode = 'facebook-page' uses the mbasic.facebook.com scraper.
-- Posts are short by design; the word-count minimum is skipped for these feeds.
-- Each feed is pinned to its county via default_county so items are always
-- tagged to the correct county without relying on article-text detection.

INSERT OR IGNORE INTO feeds (id, name, category, url, state_code, default_county, region_scope, fetch_mode, scraper_id, enabled) VALUES
  ('ky-fb-school-adair', 'Adair County Schools', 'Kentucky - Schools', 'https://www.facebook.com/adaircoschools/', 'KY', 'Adair', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-allen', 'Allen County-Scottsville High School', 'Kentucky - Schools', 'https://www.facebook.com/allencountyscottsvillehighschool/', 'KY', 'Allen', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-anderson', 'Anderson County Schools', 'Kentucky - Schools', 'https://www.facebook.com/acboe/', 'KY', 'Anderson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-ballard', 'Ballard County Schools', 'Kentucky - Schools', 'https://www.facebook.com/100063755730159/', 'KY', 'Ballard', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-barren', 'Barren County Schools', 'Kentucky - Schools', 'https://www.facebook.com/barrenschools/', 'KY', 'Barren', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-bath', 'Bath County Schools', 'Kentucky - Schools', 'https://www.facebook.com/BathCountySchoolsKY/', 'KY', 'Bath', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-bell', 'Bell County School District', 'Kentucky - Schools', 'https://www.facebook.com/BellCountySchoolDistrict/', 'KY', 'Bell', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-boone', 'Boone County Schools', 'Kentucky - Schools', 'https://www.facebook.com/TheBooneCountySchools/', 'KY', 'Boone', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-bourbon', 'Bourbon County School District', 'Kentucky - Schools', 'https://www.facebook.com/BourbonCountySchools/', 'KY', 'Bourbon', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-boyd', 'Boyd County Public School District', 'Kentucky - Schools', 'https://www.facebook.com/100065164023982/', 'KY', 'Boyd', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-boyle', 'Boyle County Schools', 'Kentucky - Schools', 'https://www.facebook.com/boylecounty/', 'KY', 'Boyle', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-bracken', 'Bracken County Schools', 'Kentucky - Schools', 'https://www.facebook.com/BrackenCountySchools/', 'KY', 'Bracken', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-breathitt', 'Breathitt County Schools', 'Kentucky - Schools', 'https://www.facebook.com/BreathittCountySchools/', 'KY', 'Breathitt', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-breckinridge', 'Breckinridge County School District', 'Kentucky - Schools', 'https://www.facebook.com/breckinridgecountyschools/', 'KY', 'Breckinridge', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-butler', 'Butler County Schools', 'Kentucky - Schools', 'https://www.facebook.com/ButlerCountySchools/', 'KY', 'Butler', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-caldwell', 'Caldwell County Schools', 'Kentucky - Schools', 'https://www.facebook.com/CaldwellCountySchools/', 'KY', 'Caldwell', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-calloway', 'Calloway County Schools', 'Kentucky - Schools', 'https://www.facebook.com/callowaycoschools/', 'KY', 'Calloway', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-campbell', 'Campbell County Schools', 'Kentucky - Schools', 'https://www.facebook.com/ccschoo1s/', 'KY', 'Campbell', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-carlisle', 'Carlisle County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/carlislecountypublicschools/', 'KY', 'Carlisle', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-carroll', 'Carroll County Schools', 'Kentucky - Schools', 'https://www.facebook.com/CarrollCountySchoolsKY/', 'KY', 'Carroll', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-carter', 'Carter County Schools', 'Kentucky - Schools', 'https://www.facebook.com/CarterCountySchoolsKY/', 'KY', 'Carter', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-casey', 'Casey County Schools', 'Kentucky - Schools', 'https://www.facebook.com/CaseyCountySchools/', 'KY', 'Casey', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-christian', 'Christian County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/ChristianCountyPublicSchools/', 'KY', 'Christian', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-clark', 'Clark County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/ClarkCountyPublicSchoolsKY/', 'KY', 'Clark', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-clay', 'Clay County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/ClayCountyPublicSchools/', 'KY', 'Clay', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-clinton', 'Clinton County Schools', 'Kentucky - Schools', 'https://www.facebook.com/ClintonCountySchoolsKY/', 'KY', 'Clinton', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-crittenden', 'Crittenden County Schools', 'Kentucky - Schools', 'https://www.facebook.com/CrittendenCountySchools/', 'KY', 'Crittenden', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-cumberland', 'Cumberland County Schools', 'Kentucky - Schools', 'https://www.facebook.com/CumberlandCountySchoolsKY/', 'KY', 'Cumberland', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-daviess', 'Daviess County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/DCPSchools/', 'KY', 'Daviess', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-edmonson', 'Edmonson County Schools', 'Kentucky - Schools', 'https://www.facebook.com/EdmonsonCoSchools/', 'KY', 'Edmonson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-elliott', 'Elliott County Schools', 'Kentucky - Schools', 'https://www.facebook.com/ElliottCoSchools/', 'KY', 'Elliott', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-estill', 'Estill County Schools', 'Kentucky - Schools', 'https://www.facebook.com/EstillCountySchools/', 'KY', 'Estill', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-fayette', 'Fayette County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/fayettecountyschools/', 'KY', 'Fayette', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-fleming', 'Fleming County Schools', 'Kentucky - Schools', 'https://www.facebook.com/FlemingCountySchools/', 'KY', 'Fleming', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-floyd', 'Floyd County Schools', 'Kentucky - Schools', 'https://www.facebook.com/floydcountyschools/', 'KY', 'Floyd', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-franklin', 'Franklin County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/FranklinCountySchoolsKY/', 'KY', 'Franklin', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-fulton', 'Fulton County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/FultonCountySchoolDistrict/', 'KY', 'Fulton', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-gallatin', 'Gallatin County Schools', 'Kentucky - Schools', 'https://www.facebook.com/GallatinCountySchoolsKY/', 'KY', 'Gallatin', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-garrard', 'Garrard County Schools', 'Kentucky - Schools', 'https://www.facebook.com/GarrardCountySchools/', 'KY', 'Garrard', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-grant', 'Grant County Schools', 'Kentucky - Schools', 'https://www.facebook.com/GrantCountySchoolsKY/', 'KY', 'Grant', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-graves', 'Graves County Schools', 'Kentucky - Schools', 'https://www.facebook.com/GravesCountySchoolsKY/', 'KY', 'Graves', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-grayson', 'Grayson County Schools', 'Kentucky - Schools', 'https://www.facebook.com/GraysonCountySchools/', 'KY', 'Grayson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-green', 'Green County Schools', 'Kentucky - Schools', 'https://www.facebook.com/GreenCountySchoolsKY/', 'KY', 'Green', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-greenup', 'Greenup County Schools', 'Kentucky - Schools', 'https://www.facebook.com/GreenupCountySchoolsKY/', 'KY', 'Greenup', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-hancock', 'Hancock County Schools', 'Kentucky - Schools', 'https://www.facebook.com/HancockCoSchoolsKY/', 'KY', 'Hancock', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-hardin', 'Hardin County Schools', 'Kentucky - Schools', 'https://www.facebook.com/HardinCountySchoolsKY/', 'KY', 'Hardin', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-harlan', 'Harlan County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/HarlanCountyPublicSchools/', 'KY', 'Harlan', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-harrison', 'Harrison County Schools', 'Kentucky - Schools', 'https://www.facebook.com/HarrisonCountySchoolsKY/', 'KY', 'Harrison', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-hart', 'Hart County Schools', 'Kentucky - Schools', 'https://www.facebook.com/HartCountySchoolsKY/', 'KY', 'Hart', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-henderson', 'Henderson County Schools', 'Kentucky - Schools', 'https://www.facebook.com/HendersonCountySchoolsKY/', 'KY', 'Henderson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-henry', 'Henry County Schools', 'Kentucky - Schools', 'https://www.facebook.com/HenryCountySchools/', 'KY', 'Henry', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-hickman', 'Hickman County Schools', 'Kentucky - Schools', 'https://www.facebook.com/HickmanCountySchoolsKY/', 'KY', 'Hickman', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-hopkins', 'Hopkins County Schools', 'Kentucky - Schools', 'https://www.facebook.com/hopkinscountyschools/', 'KY', 'Hopkins', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-jackson', 'Jackson County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/JacksonCountyPublicSchoolsKY/', 'KY', 'Jackson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-jefferson', 'Jefferson County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/JCPSKY/', 'KY', 'Jefferson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-jessamine', 'Jessamine County Schools', 'Kentucky - Schools', 'https://www.facebook.com/JessamineCountyKY/', 'KY', 'Jessamine', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-johnson', 'Johnson County Schools', 'Kentucky - Schools', 'https://www.facebook.com/JohnsonCountySchoolsKY/', 'KY', 'Johnson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-kenton', 'Kenton County School District', 'Kentucky - Schools', 'https://www.facebook.com/KentonCountySchoolDistrict/', 'KY', 'Kenton', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-knott', 'Knott County Schools', 'Kentucky - Schools', 'https://www.facebook.com/KnottCountySchools/', 'KY', 'Knott', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-knox', 'Knox County Schools', 'Kentucky - Schools', 'https://www.facebook.com/KnoxCountySchoolDistrictKY/', 'KY', 'Knox', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-larue', 'LaRue County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LaRueCountySchools/', 'KY', 'Larue', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-laurel', 'Laurel County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/LaurelCountyPublicSchoolsKY/', 'KY', 'Laurel', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-lawrence', 'Lawrence County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LawrenceCountySchoolsKY/', 'KY', 'Lawrence', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-lee', 'Lee County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LeeCountySchoolsKY/', 'KY', 'Lee', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-leslie', 'Leslie County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LeslieCountySchools/', 'KY', 'Leslie', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-letcher', 'Letcher County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LetcherCountySchools/', 'KY', 'Letcher', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-lewis', 'Lewis County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LewisCoSchools/', 'KY', 'Lewis', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-lincoln', 'Lincoln County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LincolnCountySchoolsKY/', 'KY', 'Lincoln', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-livingston', 'Livingston County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LivingstonCountyKY/', 'KY', 'Livingston', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-logan', 'Logan County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LoganCountySchoolsKY/', 'KY', 'Logan', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-lyon', 'Lyon County Schools', 'Kentucky - Schools', 'https://www.facebook.com/LyonCountySchoolsKY/', 'KY', 'Lyon', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-mccracken', 'McCracken County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/McCrackenCountyPublicSchools/', 'KY', 'McCracken', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-mccreary', 'McCreary County Schools', 'Kentucky - Schools', 'https://www.facebook.com/McCrearyCountySchools/', 'KY', 'McCreary', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-metcalfe', 'Metcalfe County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MetcalfeCountySchoolsKY/', 'KY', 'Metcalfe', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-monroe', 'Monroe County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MonroeCountySchoolsKY/', 'KY', 'Monroe', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-montgomery', 'Montgomery County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MontgomeryCountyKYSchools/', 'KY', 'Montgomery', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-morgan', 'Morgan County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MorganCountySchoolsKY/', 'KY', 'Morgan', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-muhlenberg', 'Muhlenberg County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MuhlenbergCountySchools/', 'KY', 'Muhlenberg', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-nelson', 'Nelson County Schools', 'Kentucky - Schools', 'https://www.facebook.com/NelsonCountyKySchools/', 'KY', 'Nelson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-nicholas', 'Nicholas County Schools', 'Kentucky - Schools', 'https://www.facebook.com/NicholasCountySchoolsKY/', 'KY', 'Nicholas', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-ohio', 'Ohio County Schools', 'Kentucky - Schools', 'https://www.facebook.com/OhioCountySchoolsKY/', 'KY', 'Ohio', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-oldham', 'Oldham County Schools', 'Kentucky - Schools', 'https://www.facebook.com/OldhamCountySchools/', 'KY', 'Oldham', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-owen', 'Owen County Schools', 'Kentucky - Schools', 'https://www.facebook.com/OwenCountySchoolsKY/', 'KY', 'Owen', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-owsley', 'Owsley County Schools', 'Kentucky - Schools', 'https://www.facebook.com/OwsleyCountySchoolsKY/', 'KY', 'Owsley', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-pendleton', 'Pendleton County Schools', 'Kentucky - Schools', 'https://www.facebook.com/PendletonCountySchoolsKY/', 'KY', 'Pendleton', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-perry', 'Perry County Schools', 'Kentucky - Schools', 'https://www.facebook.com/PerryCountySchoolsKY/', 'KY', 'Perry', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-pike', 'Pike County Schools', 'Kentucky - Schools', 'https://www.facebook.com/PikeCountySchoolsKY/', 'KY', 'Pike', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-powell', 'Powell County Schools', 'Kentucky - Schools', 'https://www.facebook.com/PowellCountySchoolsKY/', 'KY', 'Powell', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-pulaski', 'Pulaski County Schools', 'Kentucky - Schools', 'https://www.facebook.com/pulaskicountyschools/', 'KY', 'Pulaski', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-robertson', 'Robertson County Schools', 'Kentucky - Schools', 'https://www.facebook.com/RobertsonCountySchools/', 'KY', 'Robertson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-rockcastle', 'Rockcastle County Schools', 'Kentucky - Schools', 'https://www.facebook.com/RockcastleCountySchoolsKY/', 'KY', 'Rockcastle', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-rowan', 'Rowan County Schools', 'Kentucky - Schools', 'https://www.facebook.com/RowanCountySchoolsKY/', 'KY', 'Rowan', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-russell', 'Russell County Schools', 'Kentucky - Schools', 'https://www.facebook.com/RussellCountySchoolsKY/', 'KY', 'Russell', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-scott', 'Scott County Schools', 'Kentucky - Schools', 'https://www.facebook.com/scottcountyschools/', 'KY', 'Scott', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-shelby', 'Shelby County Schools', 'Kentucky - Schools', 'https://www.facebook.com/ShelbyCountyPublicSchoolsKY/', 'KY', 'Shelby', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-simpson', 'Simpson County Schools', 'Kentucky - Schools', 'https://www.facebook.com/SimpsonCountySchoolsKY/', 'KY', 'Simpson', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-spencer', 'Spencer County Schools', 'Kentucky - Schools', 'https://www.facebook.com/SpencerCoKYSchools/', 'KY', 'Spencer', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-taylor', 'Taylor County Schools', 'Kentucky - Schools', 'https://www.facebook.com/TaylorCountySchoolsKY/', 'KY', 'Taylor', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-todd', 'Todd County Schools', 'Kentucky - Schools', 'https://www.facebook.com/toddcountyschools/', 'KY', 'Todd', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-trigg', 'Trigg County Schools', 'Kentucky - Schools', 'https://www.facebook.com/TriggCountySchools/', 'KY', 'Trigg', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-trimble', 'Trimble County Schools', 'Kentucky - Schools', 'https://www.facebook.com/TrimbleCountySchoolsKY/', 'KY', 'Trimble', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-union', 'Union County Schools', 'Kentucky - Schools', 'https://www.facebook.com/UnionCountySchoolDistrict/', 'KY', 'Union', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-warren', 'Warren County Public Schools', 'Kentucky - Schools', 'https://www.facebook.com/WarrenCountySchools/', 'KY', 'Warren', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-washington', 'Washington County Schools', 'Kentucky - Schools', 'https://www.facebook.com/WashingtonCountyKYSchools/', 'KY', 'Washington', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-wayne', 'Wayne County Schools', 'Kentucky - Schools', 'https://www.facebook.com/WayneCountySchoolDistrict/', 'KY', 'Wayne', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-webster', 'Webster County Schools', 'Kentucky - Schools', 'https://www.facebook.com/WebsterCountySchoolsKY/', 'KY', 'Webster', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-whitley', 'Whitley County School District', 'Kentucky - Schools', 'https://www.facebook.com/WhitleyCountySchoolDistrict/', 'KY', 'Whitley', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-wolfe', 'Wolfe County Schools', 'Kentucky - Schools', 'https://www.facebook.com/WolfeCountyKYSchools/', 'KY', 'Wolfe', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-woodford', 'Woodford County Schools', 'Kentucky - Schools', 'https://www.facebook.com/WoodfordCountySchools/', 'KY', 'Woodford', 'ky', 'facebook-page', NULL, 1);

-- Missing counties not in original MD file
INSERT OR IGNORE INTO feeds (id, name, category, url, state_code, default_county, region_scope, fetch_mode, scraper_id, enabled) VALUES
  ('ky-fb-school-bullitt', 'Bullitt County Schools', 'Kentucky - Schools', 'https://www.facebook.com/BullittCountySchools/', 'KY', 'Bullitt', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-madison', 'Madison County Schools', 'Kentucky - Schools', 'https://www.facebook.com/madisoncoschools/', 'KY', 'Madison', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-magoffin', 'Magoffin County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MagoffinCountySchoolsKY/', 'KY', 'Magoffin', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-marion', 'Marion County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MarionCountyKYSchools/', 'KY', 'Marion', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-marshall', 'Marshall County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MarshallCountySchoolsKY/', 'KY', 'Marshall', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-martin', 'Martin County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MartinCountySchoolsKY/', 'KY', 'Martin', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-mason', 'Mason County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MasonCountySchoolsKY/', 'KY', 'Mason', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-mclean', 'McLean County Schools', 'Kentucky - Schools', 'https://www.facebook.com/McLeanCountySchoolsKY/', 'KY', 'McLean', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-meade', 'Meade County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MeadeCountySchoolsKY/', 'KY', 'Meade', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-menifee', 'Menifee County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MenifeeCountySchoolsKY/', 'KY', 'Menifee', 'ky', 'facebook-page', NULL, 1),
  ('ky-fb-school-mercer', 'Mercer County Schools', 'Kentucky - Schools', 'https://www.facebook.com/MercerCountySchoolsKY/', 'KY', 'Mercer', 'ky', 'facebook-page', NULL, 1);

-- Perry Advocate: local Perry County news via Facebook
INSERT OR IGNORE INTO feeds (id, name, category, url, state_code, default_county, region_scope, fetch_mode, scraper_id, enabled) VALUES
  ('ky-fb-perry-advocate', 'Perry Advocate', 'Kentucky - Local', 'https://www.facebook.com/perryadvocate', 'KY', 'Perry', 'ky', 'facebook-page', NULL, 1);

-- Additional Leslie County search feeds to improve EKY coverage.
-- WYMT ARC tag-based feed for leslie-county labeled stories.
INSERT OR IGNORE INTO feeds (id, name, category, url, state_code, default_county, region_scope, fetch_mode, scraper_id, enabled) VALUES
  ('ky-wymt-leslie', 'WYMT Leslie County News', 'Kentucky - Regional', 'https://www.wymt.com/arc/outboundfeeds/rss/tag/leslie-county/?outputType=xml', 'KY', 'Leslie', 'ky', 'rss', NULL, 1),
  ('ky-wymt-leslie-search', 'WYMT Leslie County Search', 'Kentucky - Regional', 'https://www.bing.com/news/search?q=site%3Awymt.com%20%22Leslie%20County%22&format=rss', 'KY', 'Leslie', 'ky', 'rss', NULL, 1),
  ('ky-leslie-county-news', 'Leslie County News (Hyden)', 'Kentucky - County Watch', 'https://www.bing.com/news/search?q=%22Hyden%22%20Kentucky%20news&format=rss', 'KY', 'Leslie', 'ky', 'rss', NULL, 1);

```

# ky-news-worker\package.json

```json
{
	"name": "ky-news-worker",
	"version": "0.0.0",
	"private": true,
	"scripts": {
		"deploy": "wrangler deploy",
		"dev": "wrangler dev",
		"start": "wrangler dev",
		"typecheck": "tsc --noEmit",
		"generate:feed-seed-sql": "node scripts/generate-feed-seed-sql.mjs",
		"backfill:ky-relevance": "node scripts/backfill-ky-relevance.mjs",
		"test": "vitest",
		"cf-typegen": "wrangler types"
	},
	"dependencies": {
		"@mozilla/readability": "^0.6.0",
		"fast-xml-parser": "^5.3.0",
		"hono": "^4.10.2",
		"linkedom": "^0.18.12",
		"zod": "^4.1.12"
	},
	"devDependencies": {
		"@cloudflare/vitest-pool-workers": "^0.12.4",
		"@types/node": "^25.3.0",
		"typescript": "^5.5.2",
		"vitest": "~3.2.0",
		"wrangler": "^4.67.0"
	}
}

```

# ky-news-worker\README.md

```md
# EKY News Cloudflare Worker Backend

Production Worker backend for EKY News using Hono + D1 + R2 + KV + Workers AI.

## Features

- Frontend-compatible API routes (`/api/*`) from the existing Node backend
- D1-backed queries replacing local SQLite
- Scheduled RSS ingestion every 15 minutes (`cron`)
- AI-generated full summaries using Workers AI
- Summary cache in KV to avoid repeated inference
- Lost/found and article image storage in R2
- Admin dashboard APIs: ingestion logs, feed health, manual triggers, summary review queue, tag corrections
- Structured request/error logging persisted to KV
- Error tracking and ingestion metrics persisted to D1
- Security middleware: global rate limiting, bot protection, role-based admin auth
- Edge caching headers and keyset pagination for high-volume listing endpoints

## Project Structure

\`\`\`text
ky-news-worker/
  migrations/
    0001_initial.sql
    0002_seed_feeds.sql
    0003_admin_observability_perf_security.sql
  scripts/
    generate-feed-seed-sql.mjs
  src/
    index.ts
    types.ts
    ingest/
      ingest.ts
    lib/
      crypto.ts
      errors.ts
      logger.ts
      search.ts
      utils.ts
    routes/
      admin.ts
      lostFound.ts
      news.ts
      weather.ts
    services/
      article.ts
      db.ts
      location.ts
      media.ts
      observability.ts
      rss.ts
      apiCache.ts
      schema.ts
      security.ts
      summary.ts
      weather.ts
    data/
      ky-counties.json
      ky-city-county.json
  wrangler.jsonc
  package.json
\`\`\`

## API Compatibility

Implemented endpoints:

- `GET /api/health`
- `GET /api/feeds`
- `GET /api/items`
- `GET /api/items/:id`
- `GET /api/search`
- `GET /api/counties`
- `GET /api/open-proxy`
- `GET /api/weather/forecast`
- `GET /api/weather/alerts`
- `GET /api/uploads/lost-found/:key`
- `POST /api/uploads/lost-found-url`
- `PUT /api/uploads/lost-found/:key`
- `GET /api/lost-found`
- `POST /api/lost-found/submissions`
- `POST /api/lost-found/:id/report`
- `GET /api/admin/lost-found`
- `POST /api/admin/lost-found/:id/approve`
- `POST /api/admin/lost-found/:id/reject`
- `POST /api/admin/feeds/reload`
- `POST /api/admin/feeds/:id/trigger`
- `GET /api/admin/ingestion/logs`
- `GET /api/admin/feeds/health`
- `GET /api/admin/summaries/review`
- `POST /api/admin/summaries/:itemId/review`
- `GET /api/admin/items/:id/tags`
- `PUT /api/admin/items/:id/tags`
- `GET /api/admin/tags/corrections`
- `GET /api/admin/metrics/ingestion`
- `GET /api/admin/errors`
- `GET /api/admin/logs/kv`

Additional Worker-native endpoint:

- `GET /api/media/:key` (serves mirrored article media from R2)

## Local Development

\`\`\`bash
cd ky-news-worker
npm install
npm run dev
\`\`\`

## Database Setup (D1)

### Fresh D1 setup

\`\`\`bash
cd ky-news-worker
wrangler d1 execute ky-news-db --file=migrations/0001_initial.sql
wrangler d1 execute ky-news-db --file=migrations/0002_seed_feeds.sql
wrangler d1 execute ky-news-db --file=migrations/0003_admin_observability_perf_security.sql
\`\`\`

### If you already imported your local schema

Run only the Worker schema upgrade and feed seed as needed:

\`\`\`bash
cd ky-news-worker
wrangler d1 execute ky-news-db --file=migrations/0001_initial.sql
wrangler d1 execute ky-news-db --file=migrations/0002_seed_feeds.sql
wrangler d1 execute ky-news-db --file=migrations/0003_admin_observability_perf_security.sql
\`\`\`

`0001_initial.sql` is idempotent (`CREATE TABLE IF NOT EXISTS`, `CREATE INDEX IF NOT EXISTS`) and safe to run repeatedly.

## Secrets and Environment

Set secrets before deployment:

\`\`\`bash
cd ky-news-worker
wrangler secret put ADMIN_TOKEN
wrangler secret put DATA_ENCRYPTION_KEY
\`\`\`

Optional:

- `ADMIN_EMAIL` (secret or env var)
- `ADMIN_EMAILS` (comma-separated emails with full admin role)
- `EDITOR_EMAILS` (comma-separated emails with editor role)
- `REQUIRE_TURNSTILE=1` (env var when Turnstile enforcement is enabled)
- `CORS_ORIGINS` (comma-separated list)

Configured bindings in `wrangler.jsonc`:

- D1: `ky_news_db`
- R2: `ky_news_media`
- KV: `CACHE`
- AI: `AI`

## Deploy

\`\`\`bash
cd ky-news-worker
npm run typecheck
npm test
npm run deploy
\`\`\`

Deployment target:

- Worker: `ky-news-worker`
- URL: `https://ky-news-worker.jamesbrock25.workers.dev`

## Operational Notes

- Scheduled ingestion runs every 15 minutes via Wrangler cron.
- Manual ingestion can be triggered via `POST /api/admin/feeds/reload` with admin auth.
- Single-feed ingestion can be triggered via `POST /api/admin/feeds/:id/trigger`.
- One-time KY relevance backfill script:
  - Dry run (recommended first): `npm run backfill:ky-relevance -- --remote --dry-run --limit 2000`
  - Apply changes: `npm run backfill:ky-relevance -- --remote --apply --limit 2000`
  - Rejected KY items linked to national feeds are demoted to `region_scope='national'` (not deleted).
- AI summaries are cached in KV (`summary:v1:<itemId>`) and persisted to D1.
- AI summaries enter `summary_review_queue` for admin/editor review.
- Mirrored article images are saved in R2 under `news/*` and served from `/api/media/*`.
- Lost/found uploads are saved in R2 under `lost-found/*`.

```

# ky-news-worker\scripts.zip

This is a binary file of the type: Compressed Archive

# ky-news-worker\scripts\backfill-ky-relevance.mjs

```mjs
#!/usr/bin/env node
import path from "node:path";
import process from "node:process";
import { spawnSync } from "node:child_process";
import fs from "node:fs";
import os from "node:os";
import { Readability } from "@mozilla/readability";
import { parseHTML } from "linkedom";
import { XMLParser } from "fast-xml-parser";
import kyCounties from "../src/data/ky-counties.json" with { type: "json" };
import kyCityCounty from "../src/data/ky-city-county.json" with { type: "json" };

const DEFAULT_DB_NAME = "ky-news-db";
const DEFAULT_LIMIT = 2000;
const DEFAULT_FEED_TIMEOUT_MS = 15_000;
const DEFAULT_ARTICLE_TIMEOUT_MS = 12_000;
const DEFAULT_ARTICLE_MAX_CHARS = 2_000_000;
const DEFAULT_ARTICLE_EXCERPT_MAX_CHARS = 10_000;
const DEFAULT_FEED_CACHE_ITEMS = 300;
const DEFAULT_PROGRESS_EVERY = 25;

const AMBIGUOUS_CITY_TERMS = ["Lexington", "Louisville", "Georgetown", "Franklin", "Winchester"];
const KY_CITY_REGION_TERMS = [
  "Lexington",
  "Louisville",
  "Frankfort",
  "Bowling Green",
  "Owensboro",
  "Covington",
  "Pikeville",
  "Paducah",
  "Ashland",
  "Elizabethtown",
  "Hopkinsville",
  "Richmond",
  "Florence",
  "Georgetown",
  "Nicholasville",
  "Jeffersontown",
  "Radcliff",
  "Madisonville",
  "Winchester",
  "Erlanger",
  "Franklin",
  "Eastern Kentucky",
  "Western Kentucky",
  "Central Kentucky",
  "Appalachian Kentucky"
];
const EXPLICIT_KY_TERMS = ["Kentucky", "KY"];
const AMBIGUOUS_SET = new Set(AMBIGUOUS_CITY_TERMS.map((term) => term.toLowerCase()));
const NON_AMBIGUOUS_TERMS = KY_CITY_REGION_TERMS.filter((term) => !AMBIGUOUS_SET.has(term.toLowerCase()));

const COUNTY_NAME_BY_NORMALIZED = new Map(
  (Array.isArray(kyCounties) ? kyCounties : [])
    .map((row) => String(row?.name || "").trim())
    .filter(Boolean)
    .map((name) => [
      name.toLowerCase().replace(/\s+county$/i, "").replace(/[^a-z0-9]+/g, " ").trim(),
      name
    ])
);

function usage() {
  console.log(
    [
      "Usage:",
      "  node scripts/backfill-ky-relevance.mjs [options]",
      "",
      "Options:",
      "  --database <name>         D1 database name (default: ky-news-db)",
      "  --local                   Use local D1 database (default)",
      "  --remote                  Use remote D1 database",
      "  --apply                   Apply changes (default is dry run)",
      "  --dry-run                 Force dry-run mode",
      "  --limit <n>               Number of items to scan (default: 2000)",
      "  --feed-cache-items <n>    Max entries cached per feed fetch (default: 300)",
      "  --progress-every <n>      Log progress every N items (default: 25)",
      "  --help                    Show this help message"
    ].join("\n")
  );
}

function parseArgs(argv) {
  const args = {
    database: DEFAULT_DB_NAME,
    remote: false,
    dryRun: true,
    limit: DEFAULT_LIMIT,
    feedCacheItems: DEFAULT_FEED_CACHE_ITEMS,
    progressEvery: DEFAULT_PROGRESS_EVERY
  };

  for (let i = 2; i < argv.length; i += 1) {
    const arg = argv[i];
    if (arg === "--database") {
      args.database = String(argv[i + 1] || "").trim() || DEFAULT_DB_NAME;
      i += 1;
      continue;
    }
    if (arg === "--remote") {
      args.remote = true;
      continue;
    }
    if (arg === "--local") {
      args.remote = false;
      continue;
    }
    if (arg === "--apply") {
      args.dryRun = false;
      continue;
    }
    if (arg === "--dry-run") {
      args.dryRun = true;
      continue;
    }
    if (arg === "--limit") {
      const value = Number(argv[i + 1] || "");
      if (Number.isFinite(value) && value > 0) args.limit = Math.floor(value);
      i += 1;
      continue;
    }
    if (arg === "--feed-cache-items") {
      const value = Number(argv[i + 1] || "");
      if (Number.isFinite(value) && value > 0) args.feedCacheItems = Math.floor(value);
      i += 1;
      continue;
    }
    if (arg === "--progress-every") {
      const value = Number(argv[i + 1] || "");
      if (Number.isFinite(value) && value > 0) args.progressEvery = Math.floor(value);
      i += 1;
      continue;
    }
    if (arg === "--help" || arg === "-h") {
      usage();
      process.exit(0);
    }
  }

  return args;
}

function bumpCounter(obj, key) {
  const safeKey = String(key || "unknown");
  obj[safeKey] = Number(obj[safeKey] || 0) + 1;
}

function classifyErrorReason(err) {
  const msg = String(err instanceof Error ? err.message : err || "")
    .toLowerCase()
    .trim();
  if (!msg) return "unknown";
  if (msg.includes("wrangler d1 execute failed")) return "d1_execute_failed";
  if (msg.includes("required tables are missing")) return "missing_tables";
  if (msg.includes("json")) return "json_parse_error";
  if (msg.includes("fetch")) return "fetch_failed";
  if (msg.includes("timeout")) return "timeout";
  if (msg.includes("readability")) return "readability_error";
  return "unknown";
}

function escapeSql(value) {
  return String(value || "").replace(/'/g, "''");
}

function q(value) {
  if (value == null) return "NULL";
  return `'${escapeSql(value)}'`;
}

function parseWranglerJsonPayload(outputText) {
  const text = String(outputText || "").trim();
  if (!text) return [];

  try {
    return JSON.parse(text);
  } catch {
    // Wrangler can print progress lines before JSON (especially with --file).
  }

  let idx = text.indexOf("[");
  while (idx !== -1) {
    const candidate = text.slice(idx).trim();
    try {
      return JSON.parse(candidate);
    } catch {
      idx = text.indexOf("[", idx + 1);
    }
  }

  throw new Error(`Unexpected Wrangler JSON output: ${text.slice(0, 200)}${text.length > 200 ? "..." : ""}`);
}

function runWranglerD1({ database, remote, sql, useFile = false }) {
  const wranglerEntrypoint = path.join(
    process.cwd(),
    "node_modules",
    "wrangler",
    "bin",
    "wrangler.js"
  );
  const args = ["d1", "execute", database, remote ? "--remote" : "--local", "--json"];

  let tempDir = "";
  if (useFile) {
    tempDir = fs.mkdtempSync(path.join(os.tmpdir(), "ky-news-worker-d1-"));
    const sqlFile = path.join(tempDir, "query.sql");
    fs.writeFileSync(sqlFile, `${String(sql || "").trim()}\n`, "utf8");
    args.push("--file", sqlFile);
  } else {
    args.push("--command", String(sql || ""));
  }

  const out = spawnSync(process.execPath, [wranglerEntrypoint, ...args], {
    cwd: path.resolve(process.cwd()),
    encoding: "utf8",
    maxBuffer: 1024 * 1024 * 32
  });

  if (tempDir) {
    try {
      fs.rmSync(tempDir, { recursive: true, force: true });
    } catch {
      // Best-effort cleanup only.
    }
  }

  if (out.status !== 0) {
    const stderr = String(out.stderr || "").trim();
    const stdout = String(out.stdout || "").trim();
    throw new Error(
      [
        `wrangler d1 execute failed (exit ${out.status || 1})`,
        out.error?.message || "",
        stderr,
        stdout
      ]
        .filter(Boolean)
        .join("\n")
    );
  }

  const parsed = parseWranglerJsonPayload(String(out.stdout || out.stderr || "[]"));
  if (!Array.isArray(parsed) || !parsed.length) return [];
  const first = parsed[0];
  if (!first?.success) {
    throw new Error(`D1 query failed: ${JSON.stringify(first, null, 2)}`);
  }
  return Array.isArray(first.results) ? first.results : [];
}

async function d1Select(config, sql) {
  return runWranglerD1({ ...config, sql, useFile: false });
}

async function d1Execute(config, sql) {
  runWranglerD1({ ...config, sql, useFile: true });
}

function canonicalUrl(url) {
  try {
    const u = new URL(String(url || ""));
    for (const key of [...u.searchParams.keys()]) {
      if (/^(utm_|fbclid$|gclid$|mc_eid$|mkt_tok$)/i.test(key)) {
        u.searchParams.delete(key);
      }
    }
    u.hash = "";
    const nextPath = u.pathname.replace(/\/+$/, "");
    u.pathname = nextPath || "/";
    return u.toString();
  } catch {
    return String(url || "");
  }
}

function textOnly(input) {
  return String(input || "")
    .replace(/<script[\s\S]*?<\/script>/gi, " ")
    .replace(/<style[\s\S]*?<\/style>/gi, " ")
    .replace(/<[^>]+>/g, " ")
    .replace(/&nbsp;/gi, " ")
    .replace(/&amp;/gi, "&")
    .replace(/&quot;/gi, '"')
    .replace(/&#39;/gi, "'")
    .replace(/\s+/g, " ")
    .trim();
}

function escapeRegex(input) {
  return input.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function termPattern(term) {
  return `\\b${escapeRegex(term).replace(/\s+/g, "\\s+")}\\b`;
}

function combinedRegex(terms) {
  if (!terms.length) return null;
  const sorted = [...terms].sort((a, b) => b.length - a.length);
  return new RegExp(`(?:${sorted.map(termPattern).join("|")})`, "gi");
}

const TITLE_EXPLICIT_KY_RE = combinedRegex(EXPLICIT_KY_TERMS);
const TITLE_NON_AMBIGUOUS_RE = combinedRegex(NON_AMBIGUOUS_TERMS);
const TITLE_AMBIGUOUS_RE = combinedRegex(AMBIGUOUS_CITY_TERMS);
const BODY_BASE_TERMS_RE = combinedRegex([...EXPLICIT_KY_TERMS, ...NON_AMBIGUOUS_TERMS]);
const BODY_WITH_AMBIGUOUS_TERMS_RE = combinedRegex([...EXPLICIT_KY_TERMS, ...NON_AMBIGUOUS_TERMS, ...AMBIGUOUS_CITY_TERMS]);
const ANY_AMBIGUOUS_RE = combinedRegex(AMBIGUOUS_CITY_TERMS);

function hasMatch(input, re) {
  if (!re) return false;
  re.lastIndex = 0;
  return re.test(input);
}

function countMentions(input, re) {
  if (!re) return 0;
  re.lastIndex = 0;
  const matches = String(input || "").match(re);
  return matches ? matches.length : 0;
}

function isKentuckyRelevant(title, bodyText) {
  const titleText = String(title || "");
  const body = String(bodyText || "");
  const articleText = `${titleText}\n${body}`;

  const hasArticleKySignal = hasMatch(articleText, TITLE_EXPLICIT_KY_RE);
  const titleHasExplicitKy = hasMatch(titleText, TITLE_EXPLICIT_KY_RE);
  const titleHasUnambiguousTerm = hasMatch(titleText, TITLE_NON_AMBIGUOUS_RE);
  const titleHasAmbiguousTerm = hasMatch(titleText, TITLE_AMBIGUOUS_RE);

  const titleStrongMatch =
    titleHasExplicitKy ||
    titleHasUnambiguousTerm ||
    (titleHasAmbiguousTerm && hasArticleKySignal);

  if (titleStrongMatch) {
    return { relevant: true, matchedTier: "tier1_title", failedTier: null, bodyMentions: 0 };
  }

  const bodyMentions = countMentions(body, hasArticleKySignal ? BODY_WITH_AMBIGUOUS_TERMS_RE : BODY_BASE_TERMS_RE);
  if (bodyMentions >= 2) {
    return { relevant: true, matchedTier: "tier2_body", failedTier: null, bodyMentions };
  }

  const hasAmbiguousWithoutKy = !hasArticleKySignal && hasMatch(articleText, ANY_AMBIGUOUS_RE);
  return {
    relevant: false,
    matchedTier: null,
    failedTier: hasAmbiguousWithoutKy ? "tier3_ambiguous_city" : "tier2_body",
    bodyMentions
  };
}

function norm(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/&amp;/g, "&")
    .replace(/[^a-z0-9]+/g, " ")
    .trim();
}

function normalizeCounty(county) {
  const base = String(county || "")
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ")
    .replace(/\s+county$/i, "")
    .trim();
  if (!base) return "";
  const key = base.toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
  return COUNTY_NAME_BY_NORMALIZED.get(key) || base;
}

const KY_COUNTY_PATTERNS = (() => {
  const names = (Array.isArray(kyCounties) ? kyCounties : []).map((c) => c.name).filter(Boolean);
  names.sort((a, b) => b.length - a.length);
  return names.map((name) => {
    const n = norm(name);
    const re = new RegExp(`\\b${n.replace(/\s+/g, "\\s+")}\\s+(county|co\\.?)(\\b|\\s|,|\\.)`, "i");
    return { name, re };
  });
})();

const KY_CITY_PATTERNS = (() => {
  const rows = Array.isArray(kyCityCounty) ? kyCityCounty : [];
  const cities = rows
    .map((r) => ({ city: String(r.city || "").trim(), county: String(r.county || "").trim() }))
    .filter((r) => r.city && r.county);
  cities.sort((a, b) => b.city.length - a.city.length);
  return cities.map(({ city, county }) => {
    const n = norm(city);
    const re = new RegExp(`\\b${n.replace(/\s+/g, "\\s+")}\\b`, "i");
    return { city, county, re };
  });
})();

function detectKyCounties(text) {
  const t = norm(text);
  if (!t) return [];

  const out = [];
  const raw = String(text || "");
  const hasKyContext = /\bkentucky\b/i.test(raw) || /\bky\b/i.test(raw);

  for (const { name, re } of KY_COUNTY_PATTERNS) {
    if (re.test(t)) out.push(name);
  }

  if (hasKyContext) {
    for (const { county, re } of KY_CITY_PATTERNS) {
      if (re.test(t)) out.push(county);
    }
  }

  return Array.from(new Set(out));
}

const xmlParser = new XMLParser({
  ignoreAttributes: false,
  attributeNamePrefix: "",
  parseTagValue: false,
  trimValues: true,
  processEntities: true,
  removeNSPrefix: false
});

function toArray(value) {
  if (value == null) return [];
  return Array.isArray(value) ? value : [value];
}

function textOf(value) {
  if (value == null) return "";
  if (typeof value === "string") return value;
  if (typeof value === "number" || typeof value === "boolean") return String(value);
  if (typeof value === "object") {
    const obj = value;
    if (typeof obj["#text"] === "string") return obj["#text"];
    if (typeof obj.__cdata === "string") return obj.__cdata;
    if (typeof obj.href === "string") return obj.href;
    if (typeof obj.url === "string") return obj.url;
  }
  return "";
}

function pickLink(link) {
  if (!link) return "";
  if (typeof link === "string") return link;
  if (Array.isArray(link)) {
    const alt = link.find((x) => String(x?.rel || "alternate") === "alternate");
    const candidate = alt || link[0];
    if (candidate && typeof candidate === "object") {
      return textOf(candidate.href || candidate.url || candidate["#text"] || "");
    }
    return textOf(candidate);
  }
  if (typeof link === "object") {
    return textOf(link.href || link.url || link["#text"] || "");
  }
  return "";
}

function parseFeedItems(xml) {
  const doc = xmlParser.parse(xml);
  const out = [];

  const rssItems = toArray(doc?.rss?.channel?.item);
  for (const item of rssItems) {
    out.push({
      title: textOnly(textOf(item.title) || "(untitled)"),
      link: canonicalUrl(pickLink(item.link || item.guid)),
      guid: canonicalUrl(textOf(item.guid)),
      description: textOnly(textOf(item.description || item.summary || item.contentSnippet || item["content:encoded"] || ""))
    });
  }

  const atomEntries = toArray(doc?.feed?.entry);
  for (const entry of atomEntries) {
    out.push({
      title: textOnly(textOf(entry.title) || "(untitled)"),
      link: canonicalUrl(pickLink(entry.link || entry.id)),
      guid: canonicalUrl(textOf(entry.id)),
      description: textOnly(textOf(entry.summary || entry.content || ""))
    });
  }

  return out;
}

async function fetchText(url, timeoutMs, accept, userAgent) {
  const ctrl = new AbortController();
  const timeout = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, {
      redirect: "follow",
      signal: ctrl.signal,
      headers: {
        accept,
        "user-agent": userAgent
      }
    });
    if (!res.ok) return { ok: false, status: res.status, text: "", contentType: "" };
    const contentType = String(res.headers.get("content-type") || "").toLowerCase();
    const text = await res.text();
    return { ok: true, status: res.status, text, contentType };
  } catch {
    return { ok: false, status: 0, text: "", contentType: "" };
  } finally {
    clearTimeout(timeout);
  }
}

async function buildFeedIndex(feedUrl, maxItems) {
  if (!feedUrl) return { index: new Map(), errorReason: "missing_feed_url" };
  const result = await fetchText(
    feedUrl,
    DEFAULT_FEED_TIMEOUT_MS,
    "application/rss+xml, application/atom+xml, application/xml;q=0.9, text/xml;q=0.9, */*;q=0.8",
    "EKY-News-Backfill/1.0 (+https://localkynews.com)"
  );
  if (!result.ok || !result.text) return { index: new Map(), errorReason: "feed_fetch_failed" };

  let entries = [];
  try {
    entries = parseFeedItems(result.text).slice(0, maxItems);
  } catch {
    return { index: new Map(), errorReason: "feed_parse_failed" };
  }
  const byCanonical = new Map();
  for (const entry of entries) {
    if (entry.link) byCanonical.set(entry.link, entry);
    if (entry.guid && !byCanonical.has(entry.guid)) byCanonical.set(entry.guid, entry);
  }
  return { index: byCanonical, errorReason: null };
}

async function fetchReadableArticleText(url) {
  if (!url || !/^https?:\/\//i.test(url)) return { text: "", errorReason: "invalid_url" };
  const fetched = await fetchText(
    url,
    DEFAULT_ARTICLE_TIMEOUT_MS,
    "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
    "Mozilla/5.0 (compatible; EKY-News-Backfill/1.0)"
  );
  if (!fetched.ok || !fetched.text) return { text: "", errorReason: "article_fetch_failed" };
  if (!fetched.contentType.includes("text/html") && !fetched.contentType.includes("application/xhtml")) {
    return { text: "", errorReason: "article_non_html" };
  }

  try {
    let html = fetched.text;
    if (html.length > DEFAULT_ARTICLE_MAX_CHARS) html = html.slice(0, DEFAULT_ARTICLE_MAX_CHARS);
    const { document } = parseHTML(html);
    const reader = new Readability(document);
    const article = reader.parse();
    const cleanText = textOnly([article?.title, article?.textContent].filter(Boolean).join(" "));
    if (!cleanText) return { text: "", errorReason: "readability_empty" };
    return {
      text:
        cleanText.length > DEFAULT_ARTICLE_EXCERPT_MAX_CHARS
          ? cleanText.slice(0, DEFAULT_ARTICLE_EXCERPT_MAX_CHARS)
          : cleanText,
      errorReason: null
    };
  } catch {
    return { text: "", errorReason: "readability_parse_failed" };
  }
}

async function main() {
  const options = parseArgs(process.argv);
  const wranglerConfig = {
    database: options.database,
    remote: options.remote
  };

  console.log(
    [
      "[backfill-ky-relevance] starting",
      `mode=${options.remote ? "remote" : "local"}`,
      `dryRun=${options.dryRun ? "true" : "false"}`,
      `database=${options.database}`,
      `limit=${options.limit}`
    ].join(" ")
  );

  const tableCheck = await d1Select(
    wranglerConfig,
    "SELECT name FROM sqlite_master WHERE type='table' AND name IN ('items','item_locations','feed_items','feeds');"
  );
  const tables = new Set(tableCheck.map((r) => String(r.name || "").trim()).filter(Boolean));
  const missing = ["items", "item_locations", "feed_items", "feeds"].filter((name) => !tables.has(name));
  if (missing.length) {
    throw new Error(
      `Required tables are missing: ${missing.join(", ")}. Run migrations first or use --remote against the deployed D1 database.`
    );
  }

  const rows = await d1Select(
    wranglerConfig,
    `
    SELECT
      i.id,
      i.title,
      i.url,
      i.summary,
      i.content,
      i.article_text_excerpt,
      MIN(f.url) AS feed_url,
      CASE
        WHEN EXISTS (
          SELECT 1
          FROM feed_items fi2
          JOIN feeds f2 ON f2.id = fi2.feed_id
          WHERE fi2.item_id = i.id
            AND COALESCE(f2.region_scope, 'ky') != 'ky'
        ) THEN 1 ELSE 0
      END AS has_non_ky_refs
    FROM items i
    JOIN feed_items fi ON fi.item_id = i.id
    JOIN feeds f ON f.id = fi.feed_id
    WHERE i.region_scope='ky' AND COALESCE(f.region_scope, 'ky')='ky'
    GROUP BY i.id
    ORDER BY COALESCE(i.published_at, i.fetched_at) DESC, i.id DESC
    LIMIT ${Math.max(1, Math.floor(options.limit))}
    `
  );

  const items = rows
    .map((row) => ({
      id: String(row.id || ""),
      title: String(row.title || ""),
      url: canonicalUrl(String(row.url || "")),
      summary: String(row.summary || ""),
      content: String(row.content || ""),
      articleTextExcerpt: String(row.article_text_excerpt || ""),
      feedUrl: String(row.feed_url || ""),
      hasNonKyRefs: Number(row.has_non_ky_refs || 0) > 0
    }))
    .filter((row) => row.id);
  console.log(`[backfill-ky-relevance] loaded ${items.length} unique KY-scope items`);

  const feedCache = new Map();
  const writeStatements = [];
  const summary = {
    scanned: 0,
    kept: 0,
    rejected: 0,
    rejectedRssOnly: 0,
    rejectedReadabilityBody: 0,
    keptViaReadability: 0,
    keptViaRssFallback: 0,
    feedMisses: 0,
    preservedNationalRefs: 0,
    wouldDelete: 0,
    wouldDemoteToNational: 0,
    wouldRetag: 0,
    deleted: 0,
    demotedToNational: 0,
    retagged: 0,
    errors: 0,
    errorReasons: {},
    feedIndexErrors: {},
    readabilityFallbackReasons: {}
  };

  async function flushWrites(force = false) {
    if (options.dryRun) return;
    if (!writeStatements.length) return;
    if (!force && writeStatements.length < 250) return;

    const sql = writeStatements.join("\n");

    await d1Execute(wranglerConfig, sql);
    writeStatements.length = 0;
  }

  for (let idx = 0; idx < items.length; idx += 1) {
    const item = items[idx];
    summary.scanned += 1;

    try {
      const feedKey = item.feedUrl || "__none__";
      if (!feedCache.has(feedKey)) {
        const built = await buildFeedIndex(item.feedUrl, options.feedCacheItems);
        feedCache.set(feedKey, built);
        if (built.errorReason) {
          bumpCounter(summary.feedIndexErrors, built.errorReason);
        }
      }

      const feedData = feedCache.get(feedKey);
      const feedEntry = feedData.index.get(item.url) || null;
      if (!feedEntry) summary.feedMisses += 1;

      const rssTitle = String(feedEntry?.title || item.title || "(untitled)");
      const rssDescription = String(feedEntry?.description || item.content || item.summary || "");
      const textToCheck = [rssTitle, rssDescription].filter(Boolean).join(" ");
      const rssCheck = isKentuckyRelevant(rssTitle, textOnly(textToCheck));

      const rejectOrDemoteSql = item.hasNonKyRefs
        ? [
            `DELETE FROM item_locations WHERE item_id=${q(item.id)} AND state_code='KY';`,
            `DELETE FROM feed_items WHERE item_id=${q(item.id)} AND feed_id IN (
              SELECT fi.feed_id
              FROM feed_items fi
              JOIN feeds f ON f.id = fi.feed_id
              WHERE fi.item_id=${q(item.id)} AND COALESCE(f.region_scope, 'ky')='ky'
            );`,
            `UPDATE items SET region_scope='national' WHERE id=${q(item.id)};`
          ]
        : [`DELETE FROM items WHERE id=${q(item.id)};`];

      if (!rssCheck.relevant) {
        summary.rejected += 1;
        summary.rejectedRssOnly += 1;
        if (item.hasNonKyRefs) {
          summary.wouldDemoteToNational += 1;
          summary.preservedNationalRefs += 1;
        } else {
          summary.wouldDelete += 1;
        }
        console.log(
          `[backfill-ky-relevance] reject stage=rss_only tier=${rssCheck.failedTier || "tier2_body"} action=${item.hasNonKyRefs ? "demote_to_national" : "delete"} title="${rssTitle}"`
        );
        if (!options.dryRun) {
          writeStatements.push(...rejectOrDemoteSql);
          await flushWrites();
        }
        continue;
      }

      const readability = await fetchReadableArticleText(item.url);
      const readabilityText = readability.text;
      const bodyForTagging = readabilityText || textOnly(textToCheck);

      if (readabilityText) {
        const readableCheck = isKentuckyRelevant(rssTitle, readabilityText);
        if (!readableCheck.relevant) {
          summary.rejected += 1;
          summary.rejectedReadabilityBody += 1;
          if (item.hasNonKyRefs) {
            summary.wouldDemoteToNational += 1;
            summary.preservedNationalRefs += 1;
          } else {
            summary.wouldDelete += 1;
          }
          console.log(
            `[backfill-ky-relevance] reject stage=readability_body tier=${readableCheck.failedTier || "tier2_body"} action=${item.hasNonKyRefs ? "demote_to_national" : "delete"} title="${rssTitle}"`
          );
          if (!options.dryRun) {
            writeStatements.push(...rejectOrDemoteSql);
            await flushWrites();
          }
          continue;
        }
        summary.keptViaReadability += 1;
      } else {
        summary.keptViaRssFallback += 1;
        if (readability.errorReason) {
          bumpCounter(summary.readabilityFallbackReasons, readability.errorReason);
        }
      }

      summary.kept += 1;
      summary.wouldRetag += 1;

      if (!options.dryRun) {
        const titleCounties = detectKyCounties(rssTitle);
        const bodyCounties = detectKyCounties(bodyForTagging);
        const taggedCounties = new Set([...titleCounties, ...bodyCounties].map((x) => normalizeCounty(x)).filter(Boolean));

        writeStatements.push(`UPDATE items SET region_scope='ky' WHERE id=${q(item.id)};`);
        writeStatements.push(`DELETE FROM item_locations WHERE item_id=${q(item.id)} AND state_code='KY';`);
        writeStatements.push(
          `INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (${q(item.id)}, 'KY', '');`
        );
        for (const county of taggedCounties) {
          writeStatements.push(
            `INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (${q(item.id)}, 'KY', ${q(county)});`
          );
        }
        await flushWrites();
      }
    } catch (err) {
      summary.errors += 1;
      bumpCounter(summary.errorReasons, classifyErrorReason(err));
      console.error(
        `[backfill-ky-relevance] error item=${item.id} title="${item.title}" error=${err instanceof Error ? err.message : String(err)}`
      );
      if (!options.dryRun && classifyErrorReason(err) === "d1_execute_failed") {
        throw err;
      }
    }

    if (summary.scanned % options.progressEvery === 0 || summary.scanned === items.length) {
      console.log(
        `[backfill-ky-relevance] progress ${summary.scanned}/${items.length} kept=${summary.kept} rejected=${summary.rejected} errors=${summary.errors}`
      );
    }
  }

  if (!options.dryRun) {
    await flushWrites(true);
    summary.demotedToNational = summary.wouldDemoteToNational;
    summary.deleted = summary.wouldDelete;
    summary.retagged = summary.wouldRetag;
  }

  console.log("[backfill-ky-relevance] complete");
  console.log(JSON.stringify(summary, null, 2));
}

main().catch((err) => {
  console.error(`[backfill-ky-relevance] fatal: ${err instanceof Error ? err.message : String(err)}`);
  process.exit(1);
});

```

# ky-news-worker\scripts\generate-feed-seed-sql.mjs

```mjs
import fs from "node:fs";
import path from "node:path";

const workerDir = path.resolve(process.cwd());
const repoRoot = path.resolve(workerDir, "..");
const feedsJsonPath = path.join(repoRoot, "feeds.seed.json");
const outPath = path.join(workerDir, "migrations", "0002_seed_feeds.sql");

if (!fs.existsSync(feedsJsonPath)) {
  console.error(`Missing feeds seed file at ${feedsJsonPath}`);
  process.exit(1);
}

const feeds = JSON.parse(fs.readFileSync(feedsJsonPath, "utf8"));
if (!Array.isArray(feeds)) {
  console.error("feeds.seed.json must be an array");
  process.exit(1);
}

function q(value) {
  if (value == null) return "NULL";
  const str = String(value).replace(/'/g, "''");
  return `'${str}'`;
}

const lines = [];
lines.push("-- Auto-generated by scripts/generate-feed-seed-sql.mjs");
lines.push("BEGIN TRANSACTION;");

for (const feed of feeds) {
  lines.push(`
INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, fetch_mode, scraper_id, enabled)
VALUES (
  ${q(feed.id)},
  ${q(feed.name)},
  ${q(feed.category)},
  ${q(feed.url)},
  ${q(feed.state_code || "KY")},
  ${q(feed.default_county ?? null)},
  ${q(feed.region_scope || "ky")},
  ${q(feed.fetch_mode || "rss")},
  ${q(feed.scraper_id ?? null)},
  ${Number(feed.enabled ?? 1)}
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  fetch_mode=excluded.fetch_mode,
  scraper_id=excluded.scraper_id,
  enabled=excluded.enabled;`);
}

lines.push("COMMIT;");

fs.writeFileSync(outPath, `${lines.join("\n")}\n`, "utf8");
console.log(`Wrote ${outPath} with ${feeds.length} feeds.`);

```

# ky-news-worker\src.zip

This is a binary file of the type: Compressed Archive

# ky-news-worker\src\data\ky-city-county.json

```json
[
  {
    "city": "Columbia",
    "county": "Adair"
  },
  {
    "city": "Scottsville",
    "county": "Allen"
  },
  {
    "city": "Lawrenceburg",
    "county": "Anderson"
  },
  {
    "city": "Barlow",
    "county": "Ballard"
  },
  {
    "city": "Blandville",
    "county": "Ballard"
  },
  {
    "city": "Kevil",
    "county": "Ballard"
  },
  {
    "city": "La Center",
    "county": "Ballard"
  },
  {
    "city": "Wickliffe",
    "county": "Ballard"
  },
  {
    "city": "Cave City",
    "county": "Barren"
  },
  {
    "city": "Glasgow",
    "county": "Barren"
  },
  {
    "city": "Park City",
    "county": "Barren"
  },
  {
    "city": "Owingsville",
    "county": "Bath"
  },
  {
    "city": "Salt Lick",
    "county": "Bath"
  },
  {
    "city": "Sharpsburg",
    "county": "Bath"
  },
  {
    "city": "Middlesboro",
    "county": "Bell"
  },
  {
    "city": "Pineville",
    "county": "Bell"
  },
  {
    "city": "Florence",
    "county": "Boone"
  },
  {
    "city": "Union",
    "county": "Boone"
  },
  {
    "city": "Walton",
    "county": "Boone"
  },
  {
    "city": "Millersburg",
    "county": "Bourbon"
  },
  {
    "city": "North Middletown",
    "county": "Bourbon"
  },
  {
    "city": "Paris",
    "county": "Bourbon"
  },
  {
    "city": "Ashland",
    "county": "Boyd"
  },
  {
    "city": "Catlettsburg",
    "county": "Boyd"
  },
  {
    "city": "Danville",
    "county": "Boyle"
  },
  {
    "city": "Junction City",
    "county": "Boyle"
  },
  {
    "city": "Perryville",
    "county": "Boyle"
  },
  {
    "city": "Augusta",
    "county": "Bracken"
  },
  {
    "city": "Brooksville",
    "county": "Bracken"
  },
  {
    "city": "Germantown",
    "county": "Bracken"
  },
  {
    "city": "Jackson",
    "county": "Breathitt"
  },
  {
    "city": "Cloverport",
    "county": "Breckinridge"
  },
  {
    "city": "Hardinsburg",
    "county": "Breckinridge"
  },
  {
    "city": "Irvington",
    "county": "Breckinridge"
  },
  {
    "city": "Fox Chase",
    "county": "Bullitt"
  },
  {
    "city": "Hebron Estates",
    "county": "Bullitt"
  },
  {
    "city": "Hillview",
    "county": "Bullitt"
  },
  {
    "city": "Huntertown",
    "county": "Bullitt"
  },
  {
    "city": "Lebanon Junction",
    "county": "Bullitt"
  },
  {
    "city": "Mount Washington",
    "county": "Bullitt"
  },
  {
    "city": "Pioneer Village",
    "county": "Bullitt"
  },
  {
    "city": "Shepherdsville",
    "county": "Bullitt"
  },
  {
    "city": "Morgantown",
    "county": "Butler"
  },
  {
    "city": "Rochester",
    "county": "Butler"
  },
  {
    "city": "Woodbury",
    "county": "Butler"
  },
  {
    "city": "Fredonia",
    "county": "Caldwell"
  },
  {
    "city": "Princeton",
    "county": "Caldwell"
  },
  {
    "city": "Hazel",
    "county": "Calloway"
  },
  {
    "city": "Murray",
    "county": "Calloway"
  },
  {
    "city": "Alexandria",
    "county": "Campbell"
  },
  {
    "city": "Bellevue",
    "county": "Campbell"
  },
  {
    "city": "California",
    "county": "Campbell"
  },
  {
    "city": "Cold Spring",
    "county": "Campbell"
  },
  {
    "city": "Crestview",
    "county": "Campbell"
  },
  {
    "city": "Dayton",
    "county": "Campbell"
  },
  {
    "city": "Fort Thomas",
    "county": "Campbell"
  },
  {
    "city": "Highland Heights",
    "county": "Campbell"
  },
  {
    "city": "Melbourne",
    "county": "Campbell"
  },
  {
    "city": "Mentor",
    "county": "Campbell"
  },
  {
    "city": "Newport",
    "county": "Campbell"
  },
  {
    "city": "Silver Grove",
    "county": "Campbell"
  },
  {
    "city": "Southgate",
    "county": "Campbell"
  },
  {
    "city": "Wilder",
    "county": "Campbell"
  },
  {
    "city": "Woodlawn",
    "county": "Campbell"
  },
  {
    "city": "Arlington",
    "county": "Carlisle"
  },
  {
    "city": "Bardwell",
    "county": "Carlisle"
  },
  {
    "city": "Carrollton",
    "county": "Carroll"
  },
  {
    "city": "Ghent",
    "county": "Carroll"
  },
  {
    "city": "Prestonville",
    "county": "Carroll"
  },
  {
    "city": "Sanders",
    "county": "Carroll"
  },
  {
    "city": "Worthville",
    "county": "Carroll"
  },
  {
    "city": "Grayson",
    "county": "Carter"
  },
  {
    "city": "Olive Hill",
    "county": "Carter"
  },
  {
    "city": "Liberty",
    "county": "Casey"
  },
  {
    "city": "Crofton",
    "county": "Christian"
  },
  {
    "city": "Hopkinsville",
    "county": "Christian"
  },
  {
    "city": "Lafayette",
    "county": "Christian"
  },
  {
    "city": "Oak Grove",
    "county": "Christian"
  },
  {
    "city": "Pembroke",
    "county": "Christian"
  },
  {
    "city": "Winchester",
    "county": "Clark"
  },
  {
    "city": "Manchester",
    "county": "Clay"
  },
  {
    "city": "Albany",
    "county": "Clinton"
  },
  {
    "city": "Marion",
    "county": "Crittenden"
  },
  {
    "city": "Burkesville",
    "county": "Cumberland"
  },
  {
    "city": "Owensboro",
    "county": "Daviess"
  },
  {
    "city": "Whitesville",
    "county": "Daviess"
  },
  {
    "city": "Brownsville",
    "county": "Edmonson"
  },
  {
    "city": "Sandy Hook",
    "county": "Elliott"
  },
  {
    "city": "Irvine",
    "county": "Estill"
  },
  {
    "city": "Ravenna",
    "county": "Estill"
  },
  {
    "city": "Lexington",
    "county": "Fayette"
  },
  {
    "city": "Ewing",
    "county": "Fleming"
  },
  {
    "city": "Flemingsburg",
    "county": "Fleming"
  },
  {
    "city": "Nepton",
    "county": "Fleming"
  },
  {
    "city": "Allen",
    "county": "Floyd"
  },
  {
    "city": "Martin",
    "county": "Floyd"
  },
  {
    "city": "Prestonsburg",
    "county": "Floyd"
  },
  {
    "city": "Wayland",
    "county": "Floyd"
  },
  {
    "city": "Wheelwright",
    "county": "Floyd"
  },
  {
    "city": "Frankfort",
    "county": "Franklin"
  },
  {
    "city": "Fulton",
    "county": "Fulton"
  },
  {
    "city": "Hickman",
    "county": "Fulton"
  },
  {
    "city": "Glencoe",
    "county": "Gallatin"
  },
  {
    "city": "Sparta",
    "county": "Gallatin"
  },
  {
    "city": "Warsaw",
    "county": "Gallatin"
  },
  {
    "city": "Lancaster",
    "county": "Garrard"
  },
  {
    "city": "Corinth",
    "county": "Grant"
  },
  {
    "city": "Crittenden",
    "county": "Grant"
  },
  {
    "city": "Dry Ridge",
    "county": "Grant"
  },
  {
    "city": "Williamstown",
    "county": "Grant"
  },
  {
    "city": "Mayfield",
    "county": "Graves"
  },
  {
    "city": "Water Valley",
    "county": "Graves"
  },
  {
    "city": "Wingo",
    "county": "Graves"
  },
  {
    "city": "Caneyville",
    "county": "Grayson"
  },
  {
    "city": "Clarkson",
    "county": "Grayson"
  },
  {
    "city": "Leitchfield",
    "county": "Grayson"
  },
  {
    "city": "Greensburg",
    "county": "Green"
  },
  {
    "city": "Bellefonte",
    "county": "Greenup"
  },
  {
    "city": "Flatwoods",
    "county": "Greenup"
  },
  {
    "city": "Greenup",
    "county": "Greenup"
  },
  {
    "city": "Raceland",
    "county": "Greenup"
  },
  {
    "city": "Russell",
    "county": "Greenup"
  },
  {
    "city": "South Shore",
    "county": "Greenup"
  },
  {
    "city": "Wurtland",
    "county": "Greenup"
  },
  {
    "city": "Hawesville",
    "county": "Hancock"
  },
  {
    "city": "Lewisport",
    "county": "Hancock"
  },
  {
    "city": "Elizabethtown",
    "county": "Hardin"
  },
  {
    "city": "Radcliff",
    "county": "Hardin"
  },
  {
    "city": "Sonora",
    "county": "Hardin"
  },
  {
    "city": "Upton",
    "county": "Hardin"
  },
  {
    "city": "Vine Grove",
    "county": "Hardin"
  },
  {
    "city": "West Point",
    "county": "Hardin"
  },
  {
    "city": "Benham",
    "county": "Harlan"
  },
  {
    "city": "Cumberland",
    "county": "Harlan"
  },
  {
    "city": "Evarts",
    "county": "Harlan"
  },
  {
    "city": "Harlan",
    "county": "Harlan"
  },
  {
    "city": "Loyall",
    "county": "Harlan"
  },
  {
    "city": "Wallins Creek",
    "county": "Harlan"
  },
  {
    "city": "Berry",
    "county": "Harrison"
  },
  {
    "city": "Cynthiana",
    "county": "Harrison"
  },
  {
    "city": "Horse Cave",
    "county": "Hart"
  },
  {
    "city": "Munfordville",
    "county": "Hart"
  },
  {
    "city": "Corydon",
    "county": "Henderson"
  },
  {
    "city": "Henderson",
    "county": "Henderson"
  },
  {
    "city": "Robards",
    "county": "Henderson"
  },
  {
    "city": "Campbellsburg",
    "county": "Henry"
  },
  {
    "city": "Eminence",
    "county": "Henry"
  },
  {
    "city": "New Castle",
    "county": "Henry"
  },
  {
    "city": "Pleasureville",
    "county": "Henry"
  },
  {
    "city": "Smithfield",
    "county": "Henry"
  },
  {
    "city": "Clinton",
    "county": "Hickman"
  },
  {
    "city": "Columbus",
    "county": "Hickman"
  },
  {
    "city": "Dawson Springs",
    "county": "Hopkins"
  },
  {
    "city": "Earlington",
    "county": "Hopkins"
  },
  {
    "city": "Hanson",
    "county": "Hopkins"
  },
  {
    "city": "Madisonville",
    "county": "Hopkins"
  },
  {
    "city": "Mortons Gap",
    "county": "Hopkins"
  },
  {
    "city": "Nebo",
    "county": "Hopkins"
  },
  {
    "city": "Nortonville",
    "county": "Hopkins"
  },
  {
    "city": "St. Charles",
    "county": "Hopkins"
  },
  {
    "city": "White Plains",
    "county": "Hopkins"
  },
  {
    "city": "McKee",
    "county": "Jackson"
  },
  {
    "city": "Louisville",
    "county": "Jefferson"
  },
  {
    "city": "Anchorage",
    "county": "Jefferson"
  },
  {
    "city": "Audubon Park",
    "county": "Jefferson"
  },
  {
    "city": "Bancroft",
    "county": "Jefferson"
  },
  {
    "city": "Barbourmeade",
    "county": "Jefferson"
  },
  {
    "city": "Beechwood",
    "county": "Jefferson"
  },
  {
    "city": "Bellemeade",
    "county": "Jefferson"
  },
  {
    "city": "Bellewood",
    "county": "Jefferson"
  },
  {
    "city": "Blue Ridge Manor",
    "county": "Jefferson"
  },
  {
    "city": "Briarwood",
    "county": "Jefferson"
  },
  {
    "city": "Broeck Pointe",
    "county": "Jefferson"
  },
  {
    "city": "Brownsboro Farm",
    "county": "Jefferson"
  },
  {
    "city": "Brownsboro Village",
    "county": "Jefferson"
  },
  {
    "city": "Cambridge",
    "county": "Jefferson"
  },
  {
    "city": "Coldstream",
    "county": "Jefferson"
  },
  {
    "city": "Creekside",
    "county": "Jefferson"
  },
  {
    "city": "Crossgate",
    "county": "Jefferson"
  },
  {
    "city": "Douglass Hills",
    "county": "Jefferson"
  },
  {
    "city": "Druid Hills",
    "county": "Jefferson"
  },
  {
    "city": "Fincastle",
    "county": "Jefferson"
  },
  {
    "city": "Forest Hills",
    "county": "Jefferson"
  },
  {
    "city": "Glenview",
    "county": "Jefferson"
  },
  {
    "city": "Glenview Hills",
    "county": "Jefferson"
  },
  {
    "city": "Glenview Manor",
    "county": "Jefferson"
  },
  {
    "city": "Goose Creek",
    "county": "Jefferson"
  },
  {
    "city": "Graymoor-Devondale",
    "county": "Jefferson"
  },
  {
    "city": "Green Spring",
    "county": "Jefferson"
  },
  {
    "city": "Heritage Creek",
    "county": "Jefferson"
  },
  {
    "city": "Hickory Hill",
    "county": "Jefferson"
  },
  {
    "city": "Hills and Dales",
    "county": "Jefferson"
  },
  {
    "city": "Hollow Creek",
    "county": "Jefferson"
  },
  {
    "city": "Hollyvilla",
    "county": "Jefferson"
  },
  {
    "city": "Houston Acres",
    "county": "Jefferson"
  },
  {
    "city": "Hurstbourne",
    "county": "Jefferson"
  },
  {
    "city": "Hurstbourne Acres",
    "county": "Jefferson"
  },
  {
    "city": "Indian Hills",
    "county": "Jefferson"
  },
  {
    "city": "Jeffersontown",
    "county": "Jefferson"
  },
  {
    "city": "Kingsley",
    "county": "Jefferson"
  },
  {
    "city": "Langdon Place",
    "county": "Jefferson"
  },
  {
    "city": "Lincolnshire",
    "county": "Jefferson"
  },
  {
    "city": "Lyndon",
    "county": "Jefferson"
  },
  {
    "city": "Lynnview",
    "county": "Jefferson"
  },
  {
    "city": "Manor Creek",
    "county": "Jefferson"
  },
  {
    "city": "Maryhill Estates",
    "county": "Jefferson"
  },
  {
    "city": "Meadow Vale",
    "county": "Jefferson"
  },
  {
    "city": "Meadowbrook Farm",
    "county": "Jefferson"
  },
  {
    "city": "Meadowview Estates",
    "county": "Jefferson"
  },
  {
    "city": "Middletown",
    "county": "Jefferson"
  },
  {
    "city": "Mockingbird Valley",
    "county": "Jefferson"
  },
  {
    "city": "Moorland",
    "county": "Jefferson"
  },
  {
    "city": "Murray Hill",
    "county": "Jefferson"
  },
  {
    "city": "Norbourne Estates",
    "county": "Jefferson"
  },
  {
    "city": "Northfield",
    "county": "Jefferson"
  },
  {
    "city": "Norwood",
    "county": "Jefferson"
  },
  {
    "city": "Old Brownsboro Place",
    "county": "Jefferson"
  },
  {
    "city": "Parkway Village",
    "county": "Jefferson"
  },
  {
    "city": "Plantation",
    "county": "Jefferson"
  },
  {
    "city": "Poplar Hills",
    "county": "Jefferson"
  },
  {
    "city": "Prospect",
    "county": "Jefferson"
  },
  {
    "city": "Richlawn",
    "county": "Jefferson"
  },
  {
    "city": "Riverwood",
    "county": "Jefferson"
  },
  {
    "city": "Rolling Fields",
    "county": "Jefferson"
  },
  {
    "city": "Rolling Hills",
    "county": "Jefferson"
  },
  {
    "city": "St. Matthews",
    "county": "Jefferson"
  },
  {
    "city": "St. Regis Park",
    "county": "Jefferson"
  },
  {
    "city": "Seneca Gardens",
    "county": "Jefferson"
  },
  {
    "city": "Shively",
    "county": "Jefferson"
  },
  {
    "city": "South Park View",
    "county": "Jefferson"
  },
  {
    "city": "Spring Mill",
    "county": "Jefferson"
  },
  {
    "city": "Spring Valley",
    "county": "Jefferson"
  },
  {
    "city": "Strathmoor Manor",
    "county": "Jefferson"
  },
  {
    "city": "Strathmoor Village",
    "county": "Jefferson"
  },
  {
    "city": "Sycamore",
    "county": "Jefferson"
  },
  {
    "city": "Ten Broeck",
    "county": "Jefferson"
  },
  {
    "city": "Thornhill",
    "county": "Jefferson"
  },
  {
    "city": "Watterson Park",
    "county": "Jefferson"
  },
  {
    "city": "Wellington",
    "county": "Jefferson"
  },
  {
    "city": "West Buechel",
    "county": "Jefferson"
  },
  {
    "city": "Westwood",
    "county": "Jefferson"
  },
  {
    "city": "Wildwood",
    "county": "Jefferson"
  },
  {
    "city": "Windy Hills",
    "county": "Jefferson"
  },
  {
    "city": "Woodland Hills",
    "county": "Jefferson"
  },
  {
    "city": "Woodlawn Park",
    "county": "Jefferson"
  },
  {
    "city": "Worthington Hills",
    "county": "Jefferson"
  },
  {
    "city": "Keene",
    "county": "Jessamine"
  },
  {
    "city": "Nicholasville",
    "county": "Jessamine"
  },
  {
    "city": "Wilmore",
    "county": "Jessamine"
  },
  {
    "city": "Paintsville",
    "county": "Johnson"
  },
  {
    "city": "Bromley",
    "county": "Kenton"
  },
  {
    "city": "Covington",
    "county": "Kenton"
  },
  {
    "city": "Crescent Springs",
    "county": "Kenton"
  },
  {
    "city": "Crestview Hills",
    "county": "Kenton"
  },
  {
    "city": "Edgewood",
    "county": "Kenton"
  },
  {
    "city": "Elsmere",
    "county": "Kenton"
  },
  {
    "city": "Erlanger",
    "county": "Kenton"
  },
  {
    "city": "Fairview",
    "county": "Kenton"
  },
  {
    "city": "Fort Mitchell",
    "county": "Kenton"
  },
  {
    "city": "Fort Wright",
    "county": "Kenton"
  },
  {
    "city": "Independence",
    "county": "Kenton"
  },
  {
    "city": "Kenton Vale",
    "county": "Kenton"
  },
  {
    "city": "Lakeside Park",
    "county": "Kenton"
  },
  {
    "city": "Ludlow",
    "county": "Kenton"
  },
  {
    "city": "Park Hills",
    "county": "Kenton"
  },
  {
    "city": "Ryland Heights",
    "county": "Kenton"
  },
  {
    "city": "Taylor Mill",
    "county": "Kenton"
  },
  {
    "city": "Villa Hills",
    "county": "Kenton"
  },
  {
    "city": "Walton",
    "county": "Kenton"
  },
  {
    "city": "Hindman",
    "county": "Knott"
  },
  {
    "city": "Pippa Passes",
    "county": "Knott"
  },
  {
    "city": "Vicco",
    "county": "Knott"
  },
  {
    "city": "Barbourville",
    "county": "Knox"
  },
  {
    "city": "Corbin",
    "county": "Knox"
  },
  {
    "city": "Hodgenville",
    "county": "LaRue"
  },
  {
    "city": "Upton",
    "county": "LaRue"
  },
  {
    "city": "Corbin",
    "county": "Laurel"
  },
  {
    "city": "London",
    "county": "Laurel"
  },
  {
    "city": "Blaine",
    "county": "Lawrence"
  },
  {
    "city": "Louisa",
    "county": "Lawrence"
  },
  {
    "city": "Beattyville",
    "county": "Lee"
  },
  {
    "city": "Hyden",
    "county": "Leslie"
  },
  {
    "city": "Blackey",
    "county": "Letcher"
  },
  {
    "city": "Fleming-Neon",
    "county": "Letcher"
  },
  {
    "city": "Jenkins",
    "county": "Letcher"
  },
  {
    "city": "Whitesburg",
    "county": "Letcher"
  },
  {
    "city": "Concord",
    "county": "Lewis"
  },
  {
    "city": "Vanceburg",
    "county": "Lewis"
  },
  {
    "city": "Crab Orchard",
    "county": "Lincoln"
  },
  {
    "city": "Hustonville",
    "county": "Lincoln"
  },
  {
    "city": "Stanford",
    "county": "Lincoln"
  },
  {
    "city": "Carrsville",
    "county": "Livingston"
  },
  {
    "city": "Grand Rivers",
    "county": "Livingston"
  },
  {
    "city": "Salem",
    "county": "Livingston"
  },
  {
    "city": "Smithland",
    "county": "Livingston"
  },
  {
    "city": "Adairville",
    "county": "Logan"
  },
  {
    "city": "Auburn",
    "county": "Logan"
  },
  {
    "city": "Lewisburg",
    "county": "Logan"
  },
  {
    "city": "Russellville",
    "county": "Logan"
  },
  {
    "city": "Eddyville",
    "county": "Lyon"
  },
  {
    "city": "Kuttawa",
    "county": "Lyon"
  },
  {
    "city": "Berea",
    "county": "Madison"
  },
  {
    "city": "Richmond",
    "county": "Madison"
  },
  {
    "city": "Salyersville",
    "county": "Magoffin"
  },
  {
    "city": "Bradfordsville",
    "county": "Marion"
  },
  {
    "city": "Lebanon",
    "county": "Marion"
  },
  {
    "city": "Loretto",
    "county": "Marion"
  },
  {
    "city": "Raywick",
    "county": "Marion"
  },
  {
    "city": "St. Mary",
    "county": "Marion"
  },
  {
    "city": "Benton",
    "county": "Marshall"
  },
  {
    "city": "Calvert City",
    "county": "Marshall"
  },
  {
    "city": "Hardin",
    "county": "Marshall"
  },
  {
    "city": "Inez",
    "county": "Martin"
  },
  {
    "city": "Warfield",
    "county": "Martin"
  },
  {
    "city": "Dover",
    "county": "Mason"
  },
  {
    "city": "Germantown",
    "county": "Mason"
  },
  {
    "city": "Maysville",
    "county": "Mason"
  },
  {
    "city": "Sardis",
    "county": "Mason"
  },
  {
    "city": "Paducah",
    "county": "McCracken"
  },
  {
    "city": "Calhoun",
    "county": "McLean"
  },
  {
    "city": "Island",
    "county": "McLean"
  },
  {
    "city": "Livermore",
    "county": "McLean"
  },
  {
    "city": "Sacramento",
    "county": "McLean"
  },
  {
    "city": "Brandenburg",
    "county": "Meade"
  },
  {
    "city": "Ekron",
    "county": "Meade"
  },
  {
    "city": "Muldraugh",
    "county": "Meade"
  },
  {
    "city": "Frenchburg",
    "county": "Menifee"
  },
  {
    "city": "Burgin",
    "county": "Mercer"
  },
  {
    "city": "Harrodsburg",
    "county": "Mercer"
  },
  {
    "city": "Edmonton",
    "county": "Metcalfe"
  },
  {
    "city": "Fountain Run",
    "county": "Monroe"
  },
  {
    "city": "Gamaliel",
    "county": "Monroe"
  },
  {
    "city": "Tompkinsville",
    "county": "Monroe"
  },
  {
    "city": "Camargo",
    "county": "Montgomery"
  },
  {
    "city": "Jeffersonville",
    "county": "Montgomery"
  },
  {
    "city": "Mount Sterling",
    "county": "Montgomery"
  },
  {
    "city": "West Liberty",
    "county": "Morgan"
  },
  {
    "city": "Bremen",
    "county": "Muhlenberg"
  },
  {
    "city": "Central City",
    "county": "Muhlenberg"
  },
  {
    "city": "Drakesboro",
    "county": "Muhlenberg"
  },
  {
    "city": "Greenville",
    "county": "Muhlenberg"
  },
  {
    "city": "Powderly",
    "county": "Muhlenberg"
  },
  {
    "city": "South Carrollton",
    "county": "Muhlenberg"
  },
  {
    "city": "Bardstown",
    "county": "Nelson"
  },
  {
    "city": "Bloomfield",
    "county": "Nelson"
  },
  {
    "city": "Fairfield",
    "county": "Nelson"
  },
  {
    "city": "New Haven",
    "county": "Nelson"
  },
  {
    "city": "Carlisle",
    "county": "Nicholas"
  },
  {
    "city": "Beaver Dam",
    "county": "Ohio"
  },
  {
    "city": "Centertown",
    "county": "Ohio"
  },
  {
    "city": "Fordsville",
    "county": "Ohio"
  },
  {
    "city": "Hartford",
    "county": "Ohio"
  },
  {
    "city": "McHenry",
    "county": "Ohio"
  },
  {
    "city": "Rockport",
    "county": "Ohio"
  },
  {
    "city": "Crestwood",
    "county": "Oldham"
  },
  {
    "city": "Goshen",
    "county": "Oldham"
  },
  {
    "city": "La Grange",
    "county": "Oldham"
  },
  {
    "city": "Orchard Grass Hills",
    "county": "Oldham"
  },
  {
    "city": "Pewee Valley",
    "county": "Oldham"
  },
  {
    "city": "Prospect",
    "county": "Oldham"
  },
  {
    "city": "River Bluff",
    "county": "Oldham"
  },
  {
    "city": "Gratz",
    "county": "Owen"
  },
  {
    "city": "Monterey",
    "county": "Owen"
  },
  {
    "city": "Owenton",
    "county": "Owen"
  },
  {
    "city": "Sparta",
    "county": "Owen"
  },
  {
    "city": "Booneville",
    "county": "Owsley"
  },
  {
    "city": "Butler",
    "county": "Pendleton"
  },
  {
    "city": "Falmouth",
    "county": "Pendleton"
  },
  {
    "city": "Buckhorn",
    "county": "Perry"
  },
  {
    "city": "Hazard",
    "county": "Perry"
  },
  {
    "city": "Vicco",
    "county": "Perry"
  },
  {
    "city": "Coal Run Village",
    "county": "Pike"
  },
  {
    "city": "Elkhorn City",
    "county": "Pike"
  },
  {
    "city": "Pikeville",
    "county": "Pike"
  },
  {
    "city": "Clay City",
    "county": "Powell"
  },
  {
    "city": "Stanton",
    "county": "Powell"
  },
  {
    "city": "Burnside",
    "county": "Pulaski"
  },
  {
    "city": "Eubank",
    "county": "Pulaski"
  },
  {
    "city": "Ferguson",
    "county": "Pulaski"
  },
  {
    "city": "Science Hill",
    "county": "Pulaski"
  },
  {
    "city": "Somerset",
    "county": "Pulaski"
  },
  {
    "city": "Mount Olivet",
    "county": "Robertson"
  },
  {
    "city": "Brodhead",
    "county": "Rockcastle"
  },
  {
    "city": "Livingston",
    "county": "Rockcastle"
  },
  {
    "city": "Mount Vernon",
    "county": "Rockcastle"
  },
  {
    "city": "Morehead",
    "county": "Rowan"
  },
  {
    "city": "Jamestown",
    "county": "Russell"
  },
  {
    "city": "Russell Springs",
    "county": "Russell"
  },
  {
    "city": "Georgetown",
    "county": "Scott"
  },
  {
    "city": "Sadieville",
    "county": "Scott"
  },
  {
    "city": "Stamping Ground",
    "county": "Scott"
  },
  {
    "city": "Pleasureville",
    "county": "Shelby"
  },
  {
    "city": "Shelbyville",
    "county": "Shelby"
  },
  {
    "city": "Simpsonville",
    "county": "Shelby"
  },
  {
    "city": "Franklin",
    "county": "Simpson"
  },
  {
    "city": "Taylorsville",
    "county": "Spencer"
  },
  {
    "city": "Campbellsville",
    "county": "Taylor"
  },
  {
    "city": "Elkton",
    "county": "Todd"
  },
  {
    "city": "Guthrie",
    "county": "Todd"
  },
  {
    "city": "Trenton",
    "county": "Todd"
  },
  {
    "city": "Cadiz",
    "county": "Trigg"
  },
  {
    "city": "Bedford",
    "county": "Trimble"
  },
  {
    "city": "Milton",
    "county": "Trimble"
  },
  {
    "city": "Morganfield",
    "county": "Union"
  },
  {
    "city": "Sturgis",
    "county": "Union"
  },
  {
    "city": "Uniontown",
    "county": "Union"
  },
  {
    "city": "Waverly",
    "county": "Union"
  },
  {
    "city": "Bowling Green",
    "county": "Warren"
  },
  {
    "city": "Oakland",
    "county": "Warren"
  },
  {
    "city": "Plum Springs",
    "county": "Warren"
  },
  {
    "city": "Smiths Grove",
    "county": "Warren"
  },
  {
    "city": "Woodburn",
    "county": "Warren"
  },
  {
    "city": "Mackville",
    "county": "Washington"
  },
  {
    "city": "Springfield",
    "county": "Washington"
  },
  {
    "city": "Willisburg",
    "county": "Washington"
  },
  {
    "city": "Monticello",
    "county": "Wayne"
  },
  {
    "city": "Clay",
    "county": "Webster"
  },
  {
    "city": "Dixon",
    "county": "Webster"
  },
  {
    "city": "Providence",
    "county": "Webster"
  },
  {
    "city": "Sebree",
    "county": "Webster"
  },
  {
    "city": "Slaughters",
    "county": "Webster"
  },
  {
    "city": "Wheatcroft",
    "county": "Webster"
  },
  {
    "city": "Corbin",
    "county": "Whitley"
  },
  {
    "city": "Williamsburg",
    "county": "Whitley"
  },
  {
    "city": "Campton",
    "county": "Wolfe"
  },
  {
    "city": "Midway",
    "county": "Woodford"
  },
  {
    "city": "Versailles",
    "county": "Woodford"
  }
]

```

# ky-news-worker\src\data\ky-counties.json

```json
[
  {
    "name": "Adair",
    "full": "Adair County",
    "fips": "21001"
  },
  {
    "name": "Allen",
    "full": "Allen County",
    "fips": "21003"
  },
  {
    "name": "Anderson",
    "full": "Anderson County",
    "fips": "21005"
  },
  {
    "name": "Ballard",
    "full": "Ballard County",
    "fips": "21007"
  },
  {
    "name": "Barren",
    "full": "Barren County",
    "fips": "21009"
  },
  {
    "name": "Bath",
    "full": "Bath County",
    "fips": "21011"
  },
  {
    "name": "Bell",
    "full": "Bell County",
    "fips": "21013"
  },
  {
    "name": "Boone",
    "full": "Boone County",
    "fips": "21015"
  },
  {
    "name": "Bourbon",
    "full": "Bourbon County",
    "fips": "21017"
  },
  {
    "name": "Boyd",
    "full": "Boyd County",
    "fips": "21019"
  },
  {
    "name": "Boyle",
    "full": "Boyle County",
    "fips": "21021"
  },
  {
    "name": "Bracken",
    "full": "Bracken County",
    "fips": "21023"
  },
  {
    "name": "Breathitt",
    "full": "Breathitt County",
    "fips": "21025"
  },
  {
    "name": "Breckinridge",
    "full": "Breckinridge County",
    "fips": "21027"
  },
  {
    "name": "Bullitt",
    "full": "Bullitt County",
    "fips": "21029"
  },
  {
    "name": "Butler",
    "full": "Butler County",
    "fips": "21031"
  },
  {
    "name": "Caldwell",
    "full": "Caldwell County",
    "fips": "21033"
  },
  {
    "name": "Calloway",
    "full": "Calloway County",
    "fips": "21035"
  },
  {
    "name": "Campbell",
    "full": "Campbell County",
    "fips": "21037"
  },
  {
    "name": "Carlisle",
    "full": "Carlisle County",
    "fips": "21039"
  },
  {
    "name": "Carroll",
    "full": "Carroll County",
    "fips": "21041"
  },
  {
    "name": "Carter",
    "full": "Carter County",
    "fips": "21043"
  },
  {
    "name": "Casey",
    "full": "Casey County",
    "fips": "21045"
  },
  {
    "name": "Christian",
    "full": "Christian County",
    "fips": "21047"
  },
  {
    "name": "Clark",
    "full": "Clark County",
    "fips": "21049"
  },
  {
    "name": "Clay",
    "full": "Clay County",
    "fips": "21051"
  },
  {
    "name": "Clinton",
    "full": "Clinton County",
    "fips": "21053"
  },
  {
    "name": "Crittenden",
    "full": "Crittenden County",
    "fips": "21055"
  },
  {
    "name": "Cumberland",
    "full": "Cumberland County",
    "fips": "21057"
  },
  {
    "name": "Daviess",
    "full": "Daviess County",
    "fips": "21059"
  },
  {
    "name": "Edmonson",
    "full": "Edmonson County",
    "fips": "21061"
  },
  {
    "name": "Elliott",
    "full": "Elliott County",
    "fips": "21063"
  },
  {
    "name": "Estill",
    "full": "Estill County",
    "fips": "21065"
  },
  {
    "name": "Fayette",
    "full": "Fayette County",
    "fips": "21067"
  },
  {
    "name": "Fleming",
    "full": "Fleming County",
    "fips": "21069"
  },
  {
    "name": "Floyd",
    "full": "Floyd County",
    "fips": "21071"
  },
  {
    "name": "Franklin",
    "full": "Franklin County",
    "fips": "21073"
  },
  {
    "name": "Fulton",
    "full": "Fulton County",
    "fips": "21075"
  },
  {
    "name": "Gallatin",
    "full": "Gallatin County",
    "fips": "21077"
  },
  {
    "name": "Garrard",
    "full": "Garrard County",
    "fips": "21079"
  },
  {
    "name": "Grant",
    "full": "Grant County",
    "fips": "21081"
  },
  {
    "name": "Graves",
    "full": "Graves County",
    "fips": "21083"
  },
  {
    "name": "Grayson",
    "full": "Grayson County",
    "fips": "21085"
  },
  {
    "name": "Green",
    "full": "Green County",
    "fips": "21087"
  },
  {
    "name": "Greenup",
    "full": "Greenup County",
    "fips": "21089"
  },
  {
    "name": "Hancock",
    "full": "Hancock County",
    "fips": "21091"
  },
  {
    "name": "Hardin",
    "full": "Hardin County",
    "fips": "21093"
  },
  {
    "name": "Harlan",
    "full": "Harlan County",
    "fips": "21095"
  },
  {
    "name": "Harrison",
    "full": "Harrison County",
    "fips": "21097"
  },
  {
    "name": "Hart",
    "full": "Hart County",
    "fips": "21099"
  },
  {
    "name": "Henderson",
    "full": "Henderson County",
    "fips": "21101"
  },
  {
    "name": "Henry",
    "full": "Henry County",
    "fips": "21103"
  },
  {
    "name": "Hickman",
    "full": "Hickman County",
    "fips": "21105"
  },
  {
    "name": "Hopkins",
    "full": "Hopkins County",
    "fips": "21107"
  },
  {
    "name": "Jackson",
    "full": "Jackson County",
    "fips": "21109"
  },
  {
    "name": "Jefferson",
    "full": "Jefferson County",
    "fips": "21111"
  },
  {
    "name": "Jessamine",
    "full": "Jessamine County",
    "fips": "21113"
  },
  {
    "name": "Johnson",
    "full": "Johnson County",
    "fips": "21115"
  },
  {
    "name": "Kenton",
    "full": "Kenton County",
    "fips": "21117"
  },
  {
    "name": "Knott",
    "full": "Knott County",
    "fips": "21119"
  },
  {
    "name": "Knox",
    "full": "Knox County",
    "fips": "21121"
  },
  {
    "name": "Larue",
    "full": "Larue County",
    "fips": "21123"
  },
  {
    "name": "Laurel",
    "full": "Laurel County",
    "fips": "21125"
  },
  {
    "name": "Lawrence",
    "full": "Lawrence County",
    "fips": "21127"
  },
  {
    "name": "Lee",
    "full": "Lee County",
    "fips": "21129"
  },
  {
    "name": "Leslie",
    "full": "Leslie County",
    "fips": "21131"
  },
  {
    "name": "Letcher",
    "full": "Letcher County",
    "fips": "21133"
  },
  {
    "name": "Lewis",
    "full": "Lewis County",
    "fips": "21135"
  },
  {
    "name": "Lincoln",
    "full": "Lincoln County",
    "fips": "21137"
  },
  {
    "name": "Livingston",
    "full": "Livingston County",
    "fips": "21139"
  },
  {
    "name": "Logan",
    "full": "Logan County",
    "fips": "21141"
  },
  {
    "name": "Lyon",
    "full": "Lyon County",
    "fips": "21143"
  },
  {
    "name": "Madison",
    "full": "Madison County",
    "fips": "21151"
  },
  {
    "name": "Magoffin",
    "full": "Magoffin County",
    "fips": "21153"
  },
  {
    "name": "Marion",
    "full": "Marion County",
    "fips": "21155"
  },
  {
    "name": "Marshall",
    "full": "Marshall County",
    "fips": "21157"
  },
  {
    "name": "Martin",
    "full": "Martin County",
    "fips": "21159"
  },
  {
    "name": "Mason",
    "full": "Mason County",
    "fips": "21161"
  },
  {
    "name": "McCracken",
    "full": "McCracken County",
    "fips": "21145"
  },
  {
    "name": "McCreary",
    "full": "McCreary County",
    "fips": "21147"
  },
  {
    "name": "McLean",
    "full": "McLean County",
    "fips": "21149"
  },
  {
    "name": "Meade",
    "full": "Meade County",
    "fips": "21163"
  },
  {
    "name": "Menifee",
    "full": "Menifee County",
    "fips": "21165"
  },
  {
    "name": "Mercer",
    "full": "Mercer County",
    "fips": "21167"
  },
  {
    "name": "Metcalfe",
    "full": "Metcalfe County",
    "fips": "21169"
  },
  {
    "name": "Monroe",
    "full": "Monroe County",
    "fips": "21171"
  },
  {
    "name": "Montgomery",
    "full": "Montgomery County",
    "fips": "21173"
  },
  {
    "name": "Morgan",
    "full": "Morgan County",
    "fips": "21175"
  },
  {
    "name": "Muhlenberg",
    "full": "Muhlenberg County",
    "fips": "21177"
  },
  {
    "name": "Nelson",
    "full": "Nelson County",
    "fips": "21179"
  },
  {
    "name": "Nicholas",
    "full": "Nicholas County",
    "fips": "21181"
  },
  {
    "name": "Ohio",
    "full": "Ohio County",
    "fips": "21183"
  },
  {
    "name": "Oldham",
    "full": "Oldham County",
    "fips": "21185"
  },
  {
    "name": "Owen",
    "full": "Owen County",
    "fips": "21187"
  },
  {
    "name": "Owsley",
    "full": "Owsley County",
    "fips": "21189"
  },
  {
    "name": "Pendleton",
    "full": "Pendleton County",
    "fips": "21191"
  },
  {
    "name": "Perry",
    "full": "Perry County",
    "fips": "21193"
  },
  {
    "name": "Pike",
    "full": "Pike County",
    "fips": "21195"
  },
  {
    "name": "Powell",
    "full": "Powell County",
    "fips": "21197"
  },
  {
    "name": "Pulaski",
    "full": "Pulaski County",
    "fips": "21199"
  },
  {
    "name": "Robertson",
    "full": "Robertson County",
    "fips": "21201"
  },
  {
    "name": "Rockcastle",
    "full": "Rockcastle County",
    "fips": "21203"
  },
  {
    "name": "Rowan",
    "full": "Rowan County",
    "fips": "21205"
  },
  {
    "name": "Russell",
    "full": "Russell County",
    "fips": "21207"
  },
  {
    "name": "Scott",
    "full": "Scott County",
    "fips": "21209"
  },
  {
    "name": "Shelby",
    "full": "Shelby County",
    "fips": "21211"
  },
  {
    "name": "Simpson",
    "full": "Simpson County",
    "fips": "21213"
  },
  {
    "name": "Spencer",
    "full": "Spencer County",
    "fips": "21215"
  },
  {
    "name": "Taylor",
    "full": "Taylor County",
    "fips": "21217"
  },
  {
    "name": "Todd",
    "full": "Todd County",
    "fips": "21219"
  },
  {
    "name": "Trigg",
    "full": "Trigg County",
    "fips": "21221"
  },
  {
    "name": "Trimble",
    "full": "Trimble County",
    "fips": "21223"
  },
  {
    "name": "Union",
    "full": "Union County",
    "fips": "21225"
  },
  {
    "name": "Warren",
    "full": "Warren County",
    "fips": "21227"
  },
  {
    "name": "Washington",
    "full": "Washington County",
    "fips": "21229"
  },
  {
    "name": "Wayne",
    "full": "Wayne County",
    "fips": "21231"
  },
  {
    "name": "Webster",
    "full": "Webster County",
    "fips": "21233"
  },
  {
    "name": "Whitley",
    "full": "Whitley County",
    "fips": "21235"
  },
  {
    "name": "Wolfe",
    "full": "Wolfe County",
    "fips": "21237"
  },
  {
    "name": "Woodford",
    "full": "Woodford County",
    "fips": "21239"
  }
]
```

# ky-news-worker\src\index.ts

```ts
import { Hono } from "hono";
import { cors } from "hono/cors";
import type { AppBindings, Env } from "./types";
import { ApiError } from "./lib/errors";
import { logError, logInfo } from "./lib/logger";
import { ensureSchema } from "./services/schema";
import { registerNewsRoutes } from "./routes/news";
import { registerWeatherRoutes } from "./routes/weather";
import { registerLostFoundRoutes } from "./routes/lostFound";
import { registerAdminRoutes } from "./routes/admin";
import { runScheduledIngest } from "./ingest/ingest";
import { getAdminIdentity, enforceBotProtection, enforceGlobalRequestRateLimit } from "./services/security";
import { incrementDailyMetric, purgeExpiredErrorEvents, recordErrorEvent, writeStructuredLog } from "./services/observability";

const app = new Hono<AppBindings>();

function resolveCorsOrigins(value?: string): string[] {
  if (!value) {
    return ["http://localhost:5173", "http://127.0.0.1:5173", "http://[::1]:5173"];
  }
  return value
    .split(",")
    .map((v) => v.trim())
    .filter(Boolean);
}

app.use("*", async (c, next) => {
  const started = Date.now();
  const requestId = crypto.randomUUID();
  c.set("requestId", requestId);
  c.set("startTime", started);
  const pathname = new URL(c.req.url).pathname;

  const origins = resolveCorsOrigins(c.env.CORS_ORIGINS);
  const corsMiddleware = cors({
    origin: (origin) => {
      if (!origin) return origins[0] || "*";
      return origins.includes(origin) ? origin : origins[0] || "*";
    },
    allowMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allowHeaders: ["content-type", "x-admin-token", "cf-access-authenticated-user-email"],
    exposeHeaders: ["x-request-id"],
    maxAge: 86400
  });

  await corsMiddleware(c, async () => {
    if (pathname !== "/" && pathname !== "/api/health") {
      await ensureSchema(c.env);
    }

    if (c.req.method !== "OPTIONS") {
      const actor = getAdminIdentity(c);
      if (actor) c.set("actorEmail", actor.email);
      await enforceGlobalRequestRateLimit(c);
      enforceBotProtection(c);
    }

    await next();
  });

  c.header("x-request-id", requestId);

  const durationMs = Date.now() - started;
  logInfo("http.request", {
    requestId,
    method: c.req.method,
    path: pathname,
    status: c.res.status,
    durationMs
  });

  c.executionCtx.waitUntil(
    Promise.all([
      writeStructuredLog(c.env, {
        level: c.res.status >= 500 ? "error" : c.res.status >= 400 ? "warn" : "info",
        event: "http.request",
        ts: new Date().toISOString(),
        requestId,
        route: pathname,
        method: c.req.method,
        status: c.res.status,
        actorEmail: c.get("actorEmail"),
        data: { durationMs }
      }),
      incrementDailyMetric(c.env, "http.requests", 1),
      c.res.status >= 500 ? incrementDailyMetric(c.env, "http.server_errors", 1) : Promise.resolve(0),
      c.res.status >= 400 && c.res.status < 500
        ? incrementDailyMetric(c.env, "http.client_errors", 1)
        : Promise.resolve(0)
    ]).then(() => undefined)
  );
});

app.onError((err, c) => {
  const requestId = c.get("requestId");
  const pathname = new URL(c.req.url).pathname;
  const actorEmail = c.get("actorEmail");

  if (err instanceof ApiError) {
    const payload: Record<string, unknown> = { error: err.message };
    if (err.details !== undefined) payload.details = err.details;
    c.executionCtx.waitUntil(
      recordErrorEvent(c.env, {
        requestId,
        route: pathname,
        method: c.req.method,
        statusCode: err.status,
        actorEmail,
        errorMessage: err.message,
        meta: err.details ? { details: err.details } : undefined
      })
    );
    return c.json(payload, { status: err.status as any });
  }

  logError("http.unhandled", err, {
    requestId,
    method: c.req.method,
    path: pathname
  });

  c.executionCtx.waitUntil(
    recordErrorEvent(c.env, {
      requestId,
      route: pathname,
      method: c.req.method,
      statusCode: 500,
      actorEmail,
      errorMessage: err instanceof Error ? err.message : String(err),
      errorStack: err instanceof Error ? err.stack : undefined
    })
  );

  return c.json({ error: "Internal server error" }, 500 as 500);
});

app.notFound((c) => c.json({ error: "Not found" }, 404));

registerNewsRoutes(app);
registerWeatherRoutes(app);
registerLostFoundRoutes(app);
registerAdminRoutes(app);

app.get("/", (c) => c.json({ ok: true, service: c.env.APP_NAME || "EKY News Worker" }));

// Serve robots.txt so crawlers receive valid directives instead of HTML from the SPA
app.get("/robots.txt", (c) => {
  c.header("Content-Type", "text/plain; charset=utf-8");
  c.header("Cache-Control", "public, max-age=86400");
  return c.text("User-agent: *\nAllow: /\n");
});

export default {
  fetch: (request: Request, env: Env, ctx: ExecutionContext) => app.fetch(request, env, ctx),
  scheduled: async (_event: ScheduledController, env: Env, ctx: ExecutionContext) => {
    await ensureSchema(env);
    ctx.waitUntil(
      Promise.all([
        runScheduledIngest(env),
        purgeExpiredErrorEvents(env),
        incrementDailyMetric(env, "scheduler.ticks", 1)
      ]).then(() => undefined)
    );
  }
} satisfies ExportedHandler<Env>;

```

# ky-news-worker\src\ingest\ingest.ts

```ts
import { d1All, d1First, d1Run } from "../services/db";
import { parseFeedItems } from "../services/rss";
import { scrapeFeedItems, scrapeFacebookPageItems } from "../services/scrapers";
import { detectKyCounties, detectKyCountiesFromCityHints } from "../services/location";
import { fetchArticle } from "../services/article";
import { getCachedSeoDescription, getCachedSummary, generateSummaryWithAI } from "../services/summary";
import { mirrorArticleImageToR2 } from "../services/media";
import { isKentuckyRelevant } from "../services/relevance";
import { makeItemId, stableHash } from "../lib/crypto";
import { normalizeCounty } from "../lib/utils";
import { decodeHtmlEntities, toHttpsUrl } from "../lib/text";
import { logError, logInfo, logWarn } from "../lib/logger";
import type { Env } from "../types";
import { incrementMetricGroup, writeStructuredLog } from "../services/observability";

const FEED_TIMEOUT_MS = 15_000;
const MIN_ARTICLE_WORDS = 50;
const LOCATION_TAG_CHAR_LIMIT = 3_500;

type FeedRow = {
  id: string;
  name: string;
  url: string;
  fetch_mode: string | null;
  scraper_id: string | null;
  etag: string | null;
  last_modified: string | null;
  state_code: string | null;
  region_scope: string | null;
  default_county: string | null;
};

type IngestOptions = {
  source: "cron" | "manual" | "manual-feed";
  force?: boolean;
  maxFeeds?: number;
  maxItemsPerFeed?: number;
  feedIds?: string[];
};

export type IngestRunResult = {
  runId: number | null;
  source: "cron" | "manual" | "manual-feed";
  status: "ok" | "failed";
  startedAt: string;
  finishedAt: string;
  feedsProcessed: number;
  feedsUpdated: number;
  itemsSeen: number;
  itemsUpserted: number;
  summariesGenerated: number;
  imagesMirrored: number;
  errors: number;
  feedErrors: Array<{ feedId: string; error: string }>;
  feedMetrics: Array<{
    feedId: string;
    status: "ok" | "error" | "not_modified";
    httpStatus: number | null;
    durationMs: number;
    itemsSeen: number;
    itemsUpserted: number;
    errorMessage?: string;
  }>;
};

function toIsoOrNull(dateLike: string | null | undefined): string | null {
  if (!dateLike) return null;
  const d = new Date(dateLike);
  if (Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}

function canonicalUrl(url: string): string {
  try {
    const u = new URL(url);
    for (const key of [...u.searchParams.keys()]) {
      if (/^(utm_|fbclid$|gclid$|mc_eid$|mkt_tok$)/i.test(key)) {
        u.searchParams.delete(key);
      }
    }
    u.hash = "";
    const path = u.pathname.replace(/\/+$/, "");
    u.pathname = path || "/";
    return u.toString();
  } catch {
    return url;
  }
}

function textOnly(input: string | null | undefined): string {
  return decodeHtmlEntities(String(input || ""))
    .replace(/<script[\s\S]*?<\/script>/gi, " ")
    .replace(/<style[\s\S]*?<\/style>/gi, " ")
    .replace(/<[^>]+>/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function textWordCount(input: string | null | undefined): number {
  return String(input || "")
    .trim()
    .split(/\s+/)
    .filter(Boolean).length;
}

async function removeLowWordItem(
  env: Env,
  feedId: string,
  itemId: string
): Promise<void> {
  await d1Run(env.ky_news_db, "DELETE FROM feed_items WHERE feed_id=? AND item_id=?", [feedId, itemId]);
  const remaining = await d1First<{ refs: number }>(
    env.ky_news_db,
    "SELECT COUNT(1) AS refs FROM feed_items WHERE item_id=?",
    [itemId]
  );
  if (Number(remaining?.refs || 0) <= 0) {
    await d1Run(env.ky_news_db, "DELETE FROM items WHERE id=?", [itemId]);
  }
}

async function fetchWithConditional(
  url: string,
  etag: string | null,
  lastModified: string | null,
  force: boolean,
  userAgent: string
): Promise<{ status: number; etag: string | null; lastModified: string | null; text: string | null }> {
  const headers = new Headers();
  headers.set("accept", "application/rss+xml, application/atom+xml, application/xml;q=0.9, text/xml;q=0.9, */*;q=0.8");
  headers.set("user-agent", userAgent);

  if (!force) {
    if (etag) headers.set("If-None-Match", etag);
    if (lastModified) headers.set("If-Modified-Since", lastModified);
  }

  const ctrl = new AbortController();
  const timeout = setTimeout(() => ctrl.abort(), FEED_TIMEOUT_MS);

  try {
    const res = await fetch(url, {
      headers,
      signal: ctrl.signal,
      redirect: "follow",
      cf: { cacheTtl: 0 }
    });

    if (res.status === 304) {
      return { status: 304, etag, lastModified, text: null };
    }

    if (res.status < 200 || res.status >= 300) {
      const body = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} for ${url} :: ${body.slice(0, 220)}`);
    }

    const nextEtag = res.headers.get("etag") || etag || null;
    const nextLast = res.headers.get("last-modified") || lastModified || null;
    const text = await res.text();

    return { status: res.status, etag: nextEtag, lastModified: nextLast, text };
  } finally {
    clearTimeout(timeout);
  }
}

async function recordError(env: Env, feedId: string, err: unknown): Promise<void> {
  const message = err instanceof Error ? `${err.message}\n${err.stack || ""}` : String(err);
  await d1Run(env.ky_news_db, "INSERT INTO fetch_errors (feed_id, at, error) VALUES (?, datetime('now'), ?)", [
    feedId,
    message.slice(0, 4000)
  ]);
}

async function startRun(env: Env, source: "cron" | "manual" | "manual-feed"): Promise<number | null> {
  const run = await d1Run(
    env.ky_news_db,
    "INSERT INTO fetch_runs (started_at, status, source) VALUES (datetime('now'), 'running', ?)",
    [source]
  );

  const runId = (run.meta as any)?.last_row_id;
  return typeof runId === "number" ? runId : null;
}

async function finishRun(env: Env, runId: number | null, status: "ok" | "failed", details: unknown): Promise<void> {
  if (runId == null) return;
  await d1Run(
    env.ky_news_db,
    "UPDATE fetch_runs SET finished_at=datetime('now'), status=?, details_json=? WHERE id=?",
    [status, JSON.stringify(details), runId]
  );
}

async function recordFeedMetric(
  env: Env,
  input: {
    runId: number | null;
    source: string;
    feedId: string;
    status: "ok" | "error" | "not_modified";
    httpStatus: number | null;
    durationMs: number;
    itemsSeen: number;
    itemsUpserted: number;
    errorMessage?: string;
  }
): Promise<void> {
  await d1Run(
    env.ky_news_db,
    `
    INSERT INTO feed_run_metrics (
      run_id, feed_id, source, status, http_status, duration_ms, items_seen, items_upserted, error_message, checked_at
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `,
    [
      input.runId,
      input.feedId,
      input.source,
      input.status,
      input.httpStatus,
      input.durationMs,
      input.itemsSeen,
      input.itemsUpserted,
      input.errorMessage || null
    ]
  );
}

async function recordRunMetrics(env: Env, result: IngestRunResult): Promise<void> {
  await d1Run(
    env.ky_news_db,
    `
    INSERT INTO ingestion_metrics (
      run_id, source, status, feeds_processed, feeds_updated, items_seen, items_upserted,
      summaries_generated, images_mirrored, errors, created_at
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `,
    [
      result.runId,
      result.source,
      result.status,
      result.feedsProcessed,
      result.feedsUpdated,
      result.itemsSeen,
      result.itemsUpserted,
      result.summariesGenerated,
      result.imagesMirrored,
      result.errors
    ]
  );

  await incrementMetricGroup(env, "ingestion", {
    runs: 1,
    feedsProcessed: result.feedsProcessed,
    feedsUpdated: result.feedsUpdated,
    itemsSeen: result.itemsSeen,
    itemsUpserted: result.itemsUpserted,
    summariesGenerated: result.summariesGenerated,
    imagesMirrored: result.imagesMirrored,
    errors: result.errors
  });
}

async function upsertItemAndLink(
  env: Env,
  feedId: string,
  row: {
    id: string;
    title: string;
    url: string;
    guid: string | null;
    author: string | null;
    region_scope: "ky" | "national";
    published_at: string | null;
    summary: string | null;
    content: string | null;
    image_url: string | null;
    hash: string;
  }
): Promise<"inserted" | "updated" | "unchanged"> {
  const existing = await d1First<{ hash: string | null }>(env.ky_news_db, "SELECT hash FROM items WHERE id=?", [row.id]);

  if (existing?.hash && existing.hash === row.hash) {
    await d1Run(env.ky_news_db, "INSERT OR IGNORE INTO feed_items (feed_id, item_id) VALUES (?, ?)", [feedId, row.id]);
    return "unchanged";
  }

  await d1Run(
    env.ky_news_db,
    `
    INSERT INTO items (id, title, url, guid, author, region_scope, published_at, summary, content, image_url, hash)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ON CONFLICT(id) DO UPDATE SET
      title=excluded.title,
      author=excluded.author,
      region_scope=excluded.region_scope,
      published_at=excluded.published_at,
      summary=COALESCE(excluded.summary, items.summary),
      content=COALESCE(excluded.content, items.content),
      image_url=COALESCE(excluded.image_url, items.image_url),
      hash=excluded.hash
    `,
    [
      row.id,
      row.title,
      row.url,
      row.guid,
      row.author,
      row.region_scope,
      row.published_at,
      row.summary,
      row.content,
      row.image_url,
      row.hash
    ]
  );

  await d1Run(env.ky_news_db, "INSERT OR IGNORE INTO feed_items (feed_id, item_id) VALUES (?, ?)", [feedId, row.id]);
  return existing ? "updated" : "inserted";
}

type PreparedKyRelevance = {
  relevant: boolean;
  failedTier: string | null;
  failedStage: "rss_only" | "readability_body" | null;
  excerpt: string;
  imageCandidate: string | null;
  publishedAt: string | null;
  fetchStatus: string | null;
  locationBodyText: string;
};

async function prepareKentuckyRelevance(
  env: Env,
  input: {
    itemId: string;
    stateCode: string;
    title: string;
    description: string | null;
    url: string;
  }
): Promise<PreparedKyRelevance> {
  const st = (input.stateCode || "KY").toUpperCase();
  const textToCheck = [input.title, input.description].filter(Boolean).join(" ");
  const normalizedRssText = textOnly(textToCheck);

  if (st !== "KY") {
    return {
      relevant: true,
      failedTier: null,
      failedStage: null,
      excerpt: "",
      imageCandidate: null,
      publishedAt: null,
      fetchStatus: null,
      locationBodyText: normalizedRssText
    };
  }

  const rssRelevance = isKentuckyRelevant(input.title, normalizedRssText);
  if (!rssRelevance.relevant) {
    return {
      relevant: false,
      failedTier: rssRelevance.failedTier,
      failedStage: "rss_only",
      excerpt: "",
      imageCandidate: null,
      publishedAt: null,
      fetchStatus: null,
      locationBodyText: normalizedRssText
    };
  }

  const meta = await d1First<{
    article_checked_at: string | null;
    article_text_excerpt: string | null;
    image_url: string | null;
    published_at: string | null;
  }>(
    env.ky_news_db,
    "SELECT article_checked_at, article_text_excerpt, image_url, published_at FROM items WHERE id=?",
    [input.itemId]
  );

  const alreadyChecked = Boolean(meta?.article_checked_at);
  const existingExcerpt = textOnly(meta?.article_text_excerpt || "");
  const needsImage = !String(meta?.image_url || "").trim() || /^https?:\/\//i.test(String(meta?.image_url || ""));
  const needsPublishedDate = !String(meta?.published_at || "").trim();
  const shouldFetchArticle = Boolean(input.url && !alreadyChecked && (needsImage || existingExcerpt.length < 300 || needsPublishedDate));

  let excerpt = existingExcerpt;
  let imageCandidate: string | null = null;
  let publishedAt: string | null = null;
  let fetchStatus: string | null = null;

  if (shouldFetchArticle) {
    const fetched = await fetchArticle(input.url);
    fetchStatus = fetched.status;
    const cleanText = textOnly(fetched.text || "");
    if (cleanText) {
      const readableRelevance = isKentuckyRelevant(input.title, cleanText);
      if (!readableRelevance.relevant) {
        return {
          relevant: false,
          failedTier: readableRelevance.failedTier,
          failedStage: "readability_body",
          excerpt: cleanText,
          imageCandidate: fetched.ogImage || null,
          publishedAt: fetched.publishedAt || null,
          fetchStatus,
          locationBodyText: cleanText
        };
      }
      excerpt = cleanText;
    }
    imageCandidate = fetched.ogImage || null;
    publishedAt = fetched.publishedAt || null;
  }

  return {
    relevant: true,
    failedTier: null,
    failedStage: null,
    excerpt,
    imageCandidate,
    publishedAt,
    fetchStatus,
    locationBodyText: textOnly(excerpt || normalizedRssText)
  };
}

async function persistFetchedArticleData(
  env: Env,
  input: {
    itemId: string;
    fetchStatus: string | null;
    excerpt: string;
    imageCandidate: string | null;
    publishedAt: string | null;
  }
): Promise<void> {
  if (!input.fetchStatus) return;

  const excerpt = input.excerpt ? input.excerpt : null;
  await d1Run(
    env.ky_news_db,
    `
    UPDATE items
    SET
      article_checked_at = datetime('now'),
      article_fetch_status = ?,
      article_text_excerpt = COALESCE(?, article_text_excerpt),
      published_at = COALESCE(published_at, ?),
      content = COALESCE(content, ?),
      image_url = COALESCE(image_url, ?)
    WHERE id=?
    `,
    [input.fetchStatus, excerpt, input.publishedAt || null, excerpt, input.imageCandidate || null, input.itemId]
  );
}

async function writeItemLocations(
  env: Env,
  input: {
    itemId: string;
    stateCode: string;
    title: string;
    bodyText: string;
    shouldTagState: boolean;
    /** When set, always tag this county regardless of article text analysis. */
    defaultCounty?: string | null;
    /**
     * When true, skip body-text county analysis entirely and rely only on
     * defaultCounty + title detection. Used for Facebook-page feeds where the
     * post body text is written from the school page's perspective and has no
     * location signals.
     */
    skipBodyAnalysis?: boolean;
  }
): Promise<void> {
  const st = (input.stateCode || "KY").toUpperCase();
  await d1Run(env.ky_news_db, "DELETE FROM item_locations WHERE item_id=? AND state_code=?", [input.itemId, st]);

  if (!input.shouldTagState) return;

  await d1Run(env.ky_news_db, "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, ?, '')", [
    input.itemId,
    st
  ]);

  if (st !== "KY") return;

  // Title counties are always reliable — include all of them.
  const titleCountyNames = detectKyCounties(input.title);
  const titleCountySet = new Set<string>(
    titleCountyNames.map((c) => normalizeCounty(c)).filter(Boolean)
  );

  const taggedCounties = new Set<string>(titleCountySet);

  // Always include the feed's default county if supplied (the feed is explicitly
  // scoped to that county so every article from it belongs there).
  if (input.defaultCounty) {
    const dc = normalizeCounty(input.defaultCounty);
    if (dc) taggedCounties.add(dc);
  }

  if (!input.skipBodyAnalysis) {
    const normalizedBody = textOnly(input.bodyText);
    const articleText = normalizedBody.length > LOCATION_TAG_CHAR_LIMIT
      ? normalizedBody.slice(0, LOCATION_TAG_CHAR_LIMIT)
      : normalizedBody;
    const bodyCountyCandidates = detectKyCounties(articleText);

    for (const county of bodyCountyCandidates) {
      const n = normalizeCounty(county);
      if (!n) continue;

      // Counties already confirmed by title or default_county are fine.
      if (taggedCounties.has(n)) continue;

      // For body-only detection: require 2+ explicit "County" mentions to avoid
      // false positives from passing references (e.g. sports schedules that list
      // other teams' counties).  City-name hints (one-mention) are intentionally
      // excluded here; they can produce false positives for common names.
      const countRe = new RegExp(
        `\\b${n.replace(/\s+/g, "\\\\s+")}\\s+(?:county|co\\.?)\\b`,
        "gi"
      );
      const mCount = (articleText.match(countRe) || []).length;
      if (mCount >= 2) {
        taggedCounties.add(n);
      }
    }

    // Additional city-based county tagging: when KY context is confirmed in the body,
    // map city mentions directly to their counties (single occurrence is sufficient).
    // This catches articles that mention e.g. "Hazard" or "Pikeville" without ever
    // writing "Perry County" or "Pike County" explicitly.
    const cityBasedCounties = detectKyCountiesFromCityHints(articleText);
    for (const county of cityBasedCounties) {
      const n = normalizeCounty(county);
      if (n && !taggedCounties.has(n)) {
        taggedCounties.add(n);
      }
    }
  }

  for (const county of taggedCounties) {
    await d1Run(
      env.ky_news_db,
      "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, ?, ?)",
      [input.itemId, st, county]
    );
  }
}

export async function ingestFeeds(env: Env, options: IngestOptions): Promise<IngestRunResult> {
  const startedAt = new Date().toISOString();
  const maxFeeds = Number(options.maxFeeds || env.MAX_FEEDS_PER_RUN || 200);
  const maxItemsPerFeed = Number(options.maxItemsPerFeed || env.MAX_INGEST_ITEMS_PER_FEED || 60);

  const summary: IngestRunResult = {
    runId: null,
    source: options.source,
    status: "ok",
    startedAt,
    finishedAt: startedAt,
    feedsProcessed: 0,
    feedsUpdated: 0,
    itemsSeen: 0,
    itemsUpserted: 0,
    summariesGenerated: 0,
    imagesMirrored: 0,
    errors: 0,
    feedErrors: [],
    feedMetrics: []
  };

  summary.runId = await startRun(env, options.source);

  try {
    const constrainedFeedIds = Array.isArray(options.feedIds) ? options.feedIds.filter(Boolean) : [];
    const rssUserAgent = env.RSS_USER_AGENT || "EKY-News-Bot/1.0 (+https://localkynews.com)";
    const feeds = constrainedFeedIds.length
      ? await d1All<FeedRow>(
          env.ky_news_db,
          `
          SELECT id, name, url, fetch_mode, scraper_id, etag, last_modified, state_code, region_scope, default_county
          FROM feeds
          WHERE enabled=1 AND id IN (${constrainedFeedIds.map(() => "?").join(",")})
          ORDER BY name
          `,
          constrainedFeedIds
        )
      : await d1All<FeedRow>(
          env.ky_news_db,
          `
          SELECT id, name, url, fetch_mode, scraper_id, etag, last_modified, state_code, region_scope, default_county
          FROM feeds
          WHERE enabled=1
          ORDER BY COALESCE(last_checked_at, '1970-01-01 00:00:00') ASC, name
          LIMIT ?
          `,
          [Number.isFinite(maxFeeds) ? maxFeeds : 200]
        );

    for (const feed of feeds) {
      summary.feedsProcessed += 1;
      const feedStarted = Date.now();
      let feedItemsSeen = 0;
      let feedItemsUpserted = 0;
      let feedHttpStatus: number | null = null;
      let feedStatus: "ok" | "error" | "not_modified" = "ok";
      let feedErrorMessage: string | undefined;
      try {
      const fetchMode = String(feed.fetch_mode || "rss").trim().toLowerCase();
        const safeMaxItems = Number.isFinite(maxItemsPerFeed) ? maxItemsPerFeed : 60;
        let parsedItems: ReturnType<typeof parseFeedItems> = [];
        // facebook-page feeds skip KY relevance + word-count checks — posts are
        // inherently local (county-scoped) and can be legitimately short.
        const isFacebookFeed = fetchMode === "facebook-page";

        if (isFacebookFeed) {
          const scraped = await scrapeFacebookPageItems({
            feedId: feed.id,
            feedName: feed.name,
            url: feed.url,
            scraperId: null,
            maxItems: safeMaxItems,
            userAgent: rssUserAgent,
            // Pass session cookie from env when configured for authenticated access.
            sessionCookie: env.FACEBOOK_SESSION_COOKIE || undefined
          });
          feedHttpStatus = scraped.status;
          parsedItems = scraped.items.slice(0, safeMaxItems);
          if (parsedItems.length > 0) {
            summary.feedsUpdated += 1;
          }
        } else if (fetchMode === "scrape") {
          const scraped = await scrapeFeedItems({
            feedId: feed.id,
            url: feed.url,
            scraperId: feed.scraper_id,
            maxItems: safeMaxItems,
            userAgent: rssUserAgent
          });
          feedHttpStatus = scraped.status;
          parsedItems = scraped.items.slice(0, safeMaxItems);
          if (parsedItems.length > 0) {
            summary.feedsUpdated += 1;
          }
        } else {
          const fetched = await fetchWithConditional(
            feed.url,
            feed.etag,
            feed.last_modified,
            Boolean(options.force),
            rssUserAgent
          );
          feedHttpStatus = fetched.status;

          await d1Run(
            env.ky_news_db,
            "UPDATE feeds SET etag=?, last_modified=?, last_checked_at=datetime('now') WHERE id=?",
            [fetched.etag, fetched.lastModified, feed.id]
          );

          if (fetched.status === 304 || !fetched.text) {
            feedStatus = "not_modified";
            continue;
          }

          summary.feedsUpdated += 1;
          parsedItems = parseFeedItems(fetched.text).slice(0, safeMaxItems);
        }

        for (const it of parsedItems) {
          summary.itemsSeen += 1;
          feedItemsSeen += 1;

          const publishedAt = toIsoOrNull(it.isoDate || it.pubDate);
          const link = canonicalUrl(it.link || it.guid || "");
          const title = (it.title || "").trim() || "(untitled)";
          const summaryText = textOnly(it.contentSnippet || "") || null;
          const contentText = textOnly(it.content || "") || null;
          const author = (it.author || "").trim() || null;
          const imageUrl = toHttpsUrl(it.imageUrl);

          const itemId = await makeItemId({ url: link, guid: it.guid, title, published_at: publishedAt });
          const hash = await stableHash(
            [title, link, summaryText || "", contentText || "", author || "", publishedAt || ""].join("|")
          );

          const isKyScope = (feed.region_scope || "ky") === "ky";
          let kyRelevance: PreparedKyRelevance | null = null;
          if (isKyScope && !isFacebookFeed) {
            // NOTE: Items tagged before this ingest-time relevance gate may need a one-time
            // backfill script to re-run isKentuckyRelevant() and refresh item_locations.
            // Facebook-page feeds are already county-scoped; skip relevance gating.
            kyRelevance = await prepareKentuckyRelevance(env, {
              itemId,
              stateCode: feed.state_code || "KY",
              title,
              description: summaryText,
              url: link
            });

            if (!kyRelevance.relevant) {
              logInfo("ingest.item.rejected_ky_relevance", {
                feedId: feed.id,
                itemId,
                title,
                failedTier: kyRelevance.failedTier || "tier2_body",
                failedStage: kyRelevance.failedStage || "rss_only"
              });
              await removeLowWordItem(env, feed.id, itemId);
              continue;
            }
          }

          const upserted = await upsertItemAndLink(env, feed.id, {
            id: itemId,
            title,
            url: link,
            guid: it.guid,
            author,
            region_scope: feed.region_scope === "national" ? "national" : "ky",
            published_at: publishedAt,
            summary: summaryText,
            content: contentText,
            image_url: imageUrl,
            hash
          });

          if (isKyScope) {
            if (kyRelevance) {
              await persistFetchedArticleData(env, {
                itemId,
                fetchStatus: kyRelevance.fetchStatus,
                excerpt: kyRelevance.excerpt,
                imageCandidate: kyRelevance.imageCandidate,
                publishedAt: kyRelevance.publishedAt
              });
            }
            await writeItemLocations(env, {
              itemId,
              stateCode: feed.state_code || "KY",
              title,
              bodyText: kyRelevance?.locationBodyText ?? (contentText || summaryText || ""),
              shouldTagState: true,
              defaultCounty: feed.default_county || null,
              skipBodyAnalysis: isFacebookFeed
            });
          }

          if (upserted === "unchanged") {
            // For Facebook-page feeds, never remove for low word count — posts are intentionally short.
            if (!isFacebookFeed) {
              const existingQuality = await d1First<{
                article_text_excerpt: string | null;
                content: string | null;
                summary: string | null;
              }>(
                env.ky_news_db,
                "SELECT article_text_excerpt, content, summary FROM items WHERE id=? LIMIT 1",
                [itemId]
              );
              const existingQualityText =
                kyRelevance?.excerpt ||
                existingQuality?.article_text_excerpt ||
                existingQuality?.content ||
                existingQuality?.summary ||
                "";
              if (textWordCount(existingQualityText) < MIN_ARTICLE_WORDS) {
                await removeLowWordItem(env, feed.id, itemId);
              }
            }
            continue;
          }

          let articleExcerpt = contentText || "";
          let articleImageCandidate = imageUrl;

          if (kyRelevance) {
            if (kyRelevance.excerpt && kyRelevance.excerpt.length > articleExcerpt.length) {
              articleExcerpt = kyRelevance.excerpt;
            }
            if (kyRelevance.imageCandidate) {
              articleImageCandidate = kyRelevance.imageCandidate;
            }
          }

          // Facebook-page posts are intentionally short; skip the word-count gate.
          const qualityText = articleExcerpt || contentText || summaryText || "";
          if (!isFacebookFeed && textWordCount(qualityText) < MIN_ARTICLE_WORDS) {
            await removeLowWordItem(env, feed.id, itemId);
            continue;
          }

          summary.itemsUpserted += 1;
          feedItemsUpserted += 1;

          const cachedSummary = await getCachedSummary(env, itemId);
          if (cachedSummary) {
            const cachedSeoDescription = await getCachedSeoDescription(env, itemId);
            await d1Run(env.ky_news_db, "UPDATE items SET summary=?, seo_description=COALESCE(?, seo_description) WHERE id=?", [
              cachedSummary,
              cachedSeoDescription,
              itemId
            ]);
          } else {
            const aiSummary = await generateSummaryWithAI(env, {
              itemId,
              title,
              url: link,
              articleText: articleExcerpt || `${title}\n${summaryText || ""}\n${contentText || ""}`
            });

            if (aiSummary) {
              summary.summariesGenerated += 1;
            }
          }

          const mirrorSource = articleImageCandidate || imageUrl;
          if (mirrorSource && /^https?:\/\//i.test(mirrorSource)) {
            const mirrored = await mirrorArticleImageToR2(env, {
              itemId,
              sourceUrl: mirrorSource
            });
            if (mirrored) summary.imagesMirrored += 1;
          }
        }
      } catch (err) {
        feedStatus = "error";
        feedErrorMessage = err instanceof Error ? err.message : String(err);
        summary.errors += 1;
        summary.feedErrors.push({
          feedId: feed.id,
          error: feedErrorMessage
        });
        await recordError(env, feed.id, err);
        logWarn("ingest.feed.failed", {
          feedId: feed.id,
          name: feed.name,
          error: feedErrorMessage
        });
      } finally {
        await d1Run(env.ky_news_db, "UPDATE feeds SET last_checked_at=datetime('now') WHERE id=?", [feed.id]);

        const feedMetric = {
          feedId: feed.id,
          status: feedStatus,
          httpStatus: feedHttpStatus,
          durationMs: Date.now() - feedStarted,
          itemsSeen: feedItemsSeen,
          itemsUpserted: feedItemsUpserted,
          errorMessage: feedErrorMessage
        };
        summary.feedMetrics.push(feedMetric);
        await recordFeedMetric(env, {
          runId: summary.runId,
          source: summary.source,
          ...feedMetric
        });
      }
    }

    summary.status = "ok";
    return summary;
  } catch (err) {
    summary.status = "failed";
    summary.errors += 1;
    logError("ingest.run.failed", err, { runId: summary.runId, source: options.source });
    throw err;
  } finally {
    summary.finishedAt = new Date().toISOString();
    await finishRun(env, summary.runId, summary.status, summary);
    await recordRunMetrics(env, summary);
    await writeStructuredLog(env, {
      level: summary.status === "ok" ? "info" : "error",
      event: "ingest.run.complete",
      ts: new Date().toISOString(),
      data: {
        runId: summary.runId,
        source: summary.source,
        status: summary.status,
        feedsProcessed: summary.feedsProcessed,
        itemsUpserted: summary.itemsUpserted,
        errors: summary.errors
      }
    });
    logInfo("ingest.run.complete", {
      runId: summary.runId,
      source: summary.source,
      status: summary.status,
      feedsProcessed: summary.feedsProcessed,
      itemsUpserted: summary.itemsUpserted,
      errors: summary.errors
    });
  }
}

export async function runManualIngest(env: Env): Promise<{ ok: boolean; code: number; stdout: string; stderr: string }> {
  try {
    const result = await ingestFeeds(env, { source: "manual", force: true });
    return {
      ok: true,
      code: 0,
      stdout: JSON.stringify(result),
      stderr: ""
    };
  } catch (err) {
    return {
      ok: false,
      code: 1,
      stdout: "",
      stderr: err instanceof Error ? `${err.message}\n${err.stack || ""}` : String(err)
    };
  }
}

export async function runManualFeedIngest(
  env: Env,
  feedIds: string[]
): Promise<{ ok: boolean; code: number; stdout: string; stderr: string }> {
  try {
    const result = await ingestFeeds(env, { source: "manual-feed", force: true, feedIds });
    return {
      ok: true,
      code: 0,
      stdout: JSON.stringify(result),
      stderr: ""
    };
  } catch (err) {
    return {
      ok: false,
      code: 1,
      stdout: "",
      stderr: err instanceof Error ? `${err.message}\n${err.stack || ""}` : String(err)
    };
  }
}

export async function runScheduledIngest(env: Env): Promise<void> {
  try {
    await ingestFeeds(env, { source: "cron" });
  } catch (err) {
    logError("ingest.cron.failed", err);
  }
}

```

# ky-news-worker\src\lib\crypto.ts

```ts
import type { Env } from "../types";

const encoder = new TextEncoder();
const decoder = new TextDecoder();

let cachedSecret = "";
let cachedKeyPromise: Promise<CryptoKey> | null = null;

function toBase64(bytes: Uint8Array): string {
  let binary = "";
  const chunk = 0x8000;
  for (let i = 0; i < bytes.length; i += chunk) {
    const slice = bytes.subarray(i, i + chunk);
    binary += String.fromCharCode(...slice);
  }
  return btoa(binary);
}

function fromBase64(input: string): Uint8Array {
  const binary = atob(input);
  const out = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i += 1) {
    out[i] = binary.charCodeAt(i);
  }
  return out;
}

async function getEncryptionKey(secret: string): Promise<CryptoKey> {
  if (!cachedKeyPromise || cachedSecret !== secret) {
    cachedSecret = secret;
    cachedKeyPromise = crypto.subtle
      .digest("SHA-256", encoder.encode(secret))
      .then((hash) => crypto.subtle.importKey("raw", hash, { name: "AES-GCM" }, false, ["encrypt", "decrypt"]));
  }
  return cachedKeyPromise;
}

export async function sha256Hex(input: string): Promise<string> {
  const hash = await crypto.subtle.digest("SHA-256", encoder.encode(input));
  return [...new Uint8Array(hash)].map((b) => b.toString(16).padStart(2, "0")).join("");
}

export async function stableHash(input: string): Promise<string> {
  return sha256Hex(input);
}

export async function makeItemId(input: {
  url: string;
  guid?: string | null;
  title?: string | null;
  published_at?: string | null;
}): Promise<string> {
  const base = input.url || input.guid || `${input.title || ""}__${input.published_at || ""}`;
  const hash = await stableHash(base);
  return hash.slice(0, 24);
}

async function tryDecrypt(key: CryptoKey, iv: Uint8Array, cipherAndTag: Uint8Array): Promise<string | null> {
  try {
    const out = await crypto.subtle.decrypt({ name: "AES-GCM", iv, tagLength: 128 }, key, cipherAndTag);
    return decoder.decode(out);
  } catch {
    return null;
  }
}

export async function encryptText(env: Env, value: string): Promise<string> {
  const secret = env.DATA_ENCRYPTION_KEY || "dev-only-change-me";
  const key = await getEncryptionKey(secret);

  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = new Uint8Array(
    await crypto.subtle.encrypt({ name: "AES-GCM", iv, tagLength: 128 }, key, encoder.encode(String(value)))
  );

  const tag = encrypted.slice(encrypted.length - 16);
  const cipher = encrypted.slice(0, encrypted.length - 16);

  const packed = new Uint8Array(12 + 16 + cipher.length);
  packed.set(iv, 0);
  packed.set(tag, 12);
  packed.set(cipher, 28);

  return toBase64(packed);
}

export async function decryptText(env: Env, cipherText: string | null | undefined): Promise<string | null> {
  if (!cipherText) return null;

  try {
    const data = fromBase64(String(cipherText));
    if (data.length < 28) return null;

    const secret = env.DATA_ENCRYPTION_KEY || "dev-only-change-me";
    const key = await getEncryptionKey(secret);

    const iv = data.slice(0, 12);

    // Legacy node format: iv(12) + tag(16) + cipher
    const tag = data.slice(12, 28);
    const cipher = data.slice(28);
    const legacyPayload = new Uint8Array(cipher.length + tag.length);
    legacyPayload.set(cipher, 0);
    legacyPayload.set(tag, cipher.length);

    const legacy = await tryDecrypt(key, iv, legacyPayload);
    if (legacy != null) return legacy;

    // Alternate format: iv(12) + cipher+tag
    const alt = await tryDecrypt(key, iv, data.slice(12));
    return alt;
  } catch {
    return null;
  }
}

export async function hashIp(ip: string): Promise<string> {
  return sha256Hex(ip);
}

```

# ky-news-worker\src\lib\errors.ts

```ts
export class ApiError extends Error {
  status: number;
  details?: unknown;

  constructor(status: number, message: string, details?: unknown) {
    super(message);
    this.status = status;
    this.details = details;
  }
}

export function badRequest(message: string, details?: unknown): never {
  throw new ApiError(400, message, details);
}

export function unauthorized(message = "Unauthorized"): never {
  throw new ApiError(401, message);
}

export function forbidden(message = "Forbidden"): never {
  throw new ApiError(403, message);
}

export function notFound(message = "Not found"): never {
  throw new ApiError(404, message);
}

export function tooManyRequests(message = "Too many requests"): never {
  throw new ApiError(429, message);
}

export function badGateway(message = "Bad gateway"): never {
  throw new ApiError(502, message);
}

export function unsupportedMedia(message = "Unsupported media type"): never {
  throw new ApiError(415, message);
}

```

# ky-news-worker\src\lib\logger.ts

```ts
export function logInfo(event: string, data: Record<string, unknown> = {}): void {
  console.log(JSON.stringify({ level: "info", event, ts: new Date().toISOString(), ...data }));
}

export function logWarn(event: string, data: Record<string, unknown> = {}): void {
  console.warn(JSON.stringify({ level: "warn", event, ts: new Date().toISOString(), ...data }));
}

export function logError(event: string, err: unknown, data: Record<string, unknown> = {}): void {
  const message = err instanceof Error ? err.message : String(err);
  const stack = err instanceof Error ? err.stack : undefined;
  console.error(
    JSON.stringify({ level: "error", event, ts: new Date().toISOString(), message, stack, ...data })
  );
}

```

# ky-news-worker\src\lib\search.ts

```ts
export function escapeLike(input: string): string {
  return input.replace(/[\\%_]/g, "\\$&");
}

type ParsedToken =
  | { kind: "op"; op: "AND" | "OR" }
  | { kind: "term"; value: string; negated: boolean };

type ParsedGroup = {
  include: string[];
  exclude: string[];
};

export function parseSearchQuery(input: unknown): ParsedGroup[] {
  const q = String(input || "");
  const tokens: ParsedToken[] = [];
  let i = 0;

  while (i < q.length) {
    while (i < q.length && /\s/.test(q[i])) i += 1;
    if (i >= q.length) break;

    let negated = false;
    if (q[i] === "-") {
      negated = true;
      i += 1;
      while (i < q.length && /\s/.test(q[i])) i += 1;
    }
    if (i >= q.length) break;

    let value = "";
    let quoted = false;

    if (q[i] === '"') {
      quoted = true;
      i += 1;
      const start = i;
      while (i < q.length && q[i] !== '"') i += 1;
      value = q.slice(start, i);
      if (i < q.length && q[i] === '"') i += 1;
    } else {
      const start = i;
      while (i < q.length && !/\s/.test(q[i])) i += 1;
      value = q.slice(start, i);
    }

    value = value.trim();
    if (!value) continue;

    if (!quoted && !negated) {
      const upper = value.toUpperCase();
      if (upper === "AND" || upper === "OR") {
        tokens.push({ kind: "op", op: upper });
        continue;
      }
    }

    tokens.push({ kind: "term", value, negated });
  }

  const groups: ParsedGroup[] = [{ include: [], exclude: [] }];

  for (const token of tokens) {
    const current = groups[groups.length - 1];
    if (token.kind === "op") {
      if (token.op === "OR") {
        if (current.include.length || current.exclude.length) groups.push({ include: [], exclude: [] });
      }
      continue;
    }

    if (token.negated) current.exclude.push(token.value);
    else current.include.push(token.value);
  }

  return groups.filter((g) => g.include.length || g.exclude.length);
}

export function buildSearchClause(rawQuery: unknown): { clause: string; binds: string[] } {
  const searchableDoc = "LOWER(COALESCE(i.title, '') || ' ' || COALESCE(i.summary, '') || ' ' || COALESCE(i.content, ''))";
  const groups = parseSearchQuery(rawQuery);
  if (!groups.length) return { clause: "1=0", binds: [] };

  const binds: string[] = [];
  const orBlocks: string[] = [];

  for (const group of groups) {
    const andParts: string[] = [];

    for (const term of group.include) {
      andParts.push(`${searchableDoc} LIKE ? ESCAPE '\\'`);
      binds.push(`%${escapeLike(term.toLowerCase())}%`);
    }

    for (const term of group.exclude) {
      andParts.push(`${searchableDoc} NOT LIKE ? ESCAPE '\\'`);
      binds.push(`%${escapeLike(term.toLowerCase())}%`);
    }

    if (andParts.length) {
      orBlocks.push(`(${andParts.join(" AND ")})`);
    }
  }

  if (!orBlocks.length) return { clause: "1=0", binds: [] };
  return { clause: `(${orBlocks.join(" OR ")})`, binds };
}

```

# ky-news-worker\src\lib\text.ts

```ts
const NAMED_HTML_ENTITIES: Record<string, string> = {
  amp: "&",
  lt: "<",
  gt: ">",
  quot: "\"",
  apos: "'",
  nbsp: " ",
  ndash: "-",
  mdash: "-",
  hellip: "...",
  rsquo: "'",
  lsquo: "'",
  rdquo: "\"",
  ldquo: "\""
};

function decodeNumericEntity(raw: string): string | null {
  const value = raw.trim().toLowerCase();
  const isHex = value.startsWith("x");
  const num = Number.parseInt(isHex ? value.slice(1) : value, isHex ? 16 : 10);
  if (!Number.isFinite(num) || num <= 0 || num > 0x10ffff) return null;
  try {
    return String.fromCodePoint(num);
  } catch {
    return null;
  }
}

export function decodeHtmlEntities(input: string): string {
  if (!input) return "";
  return input.replace(/&(#x?[0-9a-fA-F]+|[a-zA-Z]{2,16});/g, (match, inner) => {
    const key = String(inner || "");
    if (!key) return match;
    if (key.startsWith("#")) {
      const decoded = decodeNumericEntity(key.slice(1));
      return decoded ?? match;
    }
    const named = NAMED_HTML_ENTITIES[key.toLowerCase()];
    return named ?? match;
  });
}

export function normalizeWhitespace(input: string): string {
  return String(input || "")
    .replace(/\r\n/g, "\n")
    .replace(/[ \t]+\n/g, "\n")
    .replace(/\n{3,}/g, "\n\n")
    .replace(/[ \t]{2,}/g, " ")
    .trim();
}

export function toHttpsUrl(input: string | null | undefined): string | null {
  const raw = String(input || "").trim();
  if (!raw) return null;
  if (raw.startsWith("//")) return `https:${raw}`;

  try {
    const url = new URL(raw);
    if (url.protocol === "http:") url.protocol = "https:";
    if (url.protocol !== "https:") return null;
    return url.toString();
  } catch {
    return null;
  }
}

```

# ky-news-worker\src\lib\utils.ts

```ts
import { decodeHtmlEntities, normalizeWhitespace, toHttpsUrl } from "./text";
import kyCounties from "../data/ky-counties.json";

export const NEWS_SCOPES = ["ky", "national", "all"] as const;
export const LOST_FOUND_TYPES = ["lost", "found"] as const;
export const LOST_FOUND_STATUSES = ["pending", "approved", "rejected", "published", "resolved"] as const;

const PAID_SOURCE_DOMAINS = [
  "bizjournals.com",
  "courier-journal.com",
  "dailyindependent.com",
  "franklinfavorite.com",
  "kentucky.com",
  "kentuckynewera.com",
  "messenger-inquirer.com",
  "news-expressky.com",
  "paducahsun.com",
  "richmondregister.com",
  "salyersvilleindependent.com",
  "state-journal.com",
  "thenewsenterprise.com",
  "timesleader.net"
];
const HEAVY_DEPRIORITIZED_PAID_DOMAINS = ["dailyindependent.com"];
const PAID_FALLBACK_LIMIT = 2;
const PAID_FALLBACK_WHEN_EMPTY_LIMIT = 3;
const MIN_ITEM_WORDS = 50;
const OUTPUT_NAV_CLUSTER_RE =
  /\b(?:home|news|sports|opinion|obituaries|features|classifieds|public notices|contests|calendar|services|about us|policies|news tip|submit photo|engagement announcement|wedding announcement|anniversary announcement|letter to editor|submit an obituary|pay subscription|e-edition)(?:\s+\b(?:home|news|sports|opinion|obituaries|features|classifieds|public notices|contests|calendar|services|about us|policies|news tip|submit photo|engagement announcement|wedding announcement|anniversary announcement|letter to editor|submit an obituary|pay subscription|e-edition)\b){4,}/gi;

const COUNTY_NAME_BY_NORMALIZED = new Map(
  (Array.isArray(kyCounties) ? (kyCounties as Array<{ name?: string }>) : [])
    .map((row) => String(row?.name || "").trim())
    .filter(Boolean)
    .map((name) => [
      name.toLowerCase().replace(/\s+county$/i, "").replace(/[^a-z0-9]+/g, " ").trim(),
      name
    ])
);

function sanitizeSummaryForOutput(input: unknown): string | null {
  const raw = String(input || "").trim();
  if (!raw) return null;
  const cleaned = normalizeWhitespace(
    decodeHtmlEntities(raw)
      .replace(/\*\*([^*]+)\*\*/g, "$1")
      .replace(/`{1,3}/g, "")
  );
  return cleaned || null;
}

function sanitizeExcerptForOutput(input: unknown): string | null {
  const raw = String(input || "").trim();
  if (!raw) return null;
  const cleaned = normalizeWhitespace(
    decodeHtmlEntities(raw)
      .replace(/\bYou are using an outdated browser[\s\S]{0,260}?experience\.\s*/gi, " ")
      .replace(/\bSubscribe\b[\s\S]{0,500}?\bE-Edition\b/gi, " ")
      .replace(OUTPUT_NAV_CLUSTER_RE, " ")
  );
  return cleaned || null;
}

export function csvToArray(csv: unknown): string[] {
  if (!csv) return [];
  return String(csv)
    .split(",")
    .map((x) => x.trim())
    .filter(Boolean);
}

export function mapItemRow<T extends Record<string, unknown>>(row: T): T & { states: string[]; counties: string[] } {
  const states = csvToArray(row.states_csv);
  const counties = csvToArray(row.counties_csv);
  const feedModes = csvToArray(row.feed_modes_csv);
  const feedCategories = csvToArray(row.feed_categories_csv);
  const next = { ...row } as Record<string, unknown>;
  delete next.states_csv;
  delete next.counties_csv;
  delete next.feed_modes_csv;
  delete next.feed_categories_csv;
  const rawImageUrl = String(next.image_url || "").trim();
  if (rawImageUrl.startsWith("http://") || rawImageUrl.startsWith("//")) {
    next.image_url = toHttpsUrl(rawImageUrl);
  }
  if ("title" in next) {
    next.title = decodeHtmlEntities(String(next.title || "")).trim();
  }
  if ("author" in next) {
    const author = decodeHtmlEntities(String(next.author || "")).trim();
    next.author = author || null;
  }
  if ("summary" in next) {
    next.summary = sanitizeSummaryForOutput(next.summary);
  }
  if ("content" in next) {
    next.content = sanitizeExcerptForOutput(next.content);
  }
  if (feedModes.length) {
    next.feed_modes = feedModes;
  }
  if (feedCategories.length) {
    next.feed_categories = feedCategories;
  }
  return { ...(next as T), states, counties };
}

export function safeJsonParse<T>(input: unknown, fallback: T): T {
  try {
    if (typeof input !== "string") return fallback;
    return JSON.parse(input) as T;
  } catch {
    return fallback;
  }
}

export function normalizeCounty(county: unknown): string {
  const base = String(county || "")
    .trim()
    .replace(/[-_]+/g, " ")
    .replace(/\s+/g, " ")
    .replace(/\s+county$/i, "")
    .trim();
  if (!base) return "";
  const key = base.toLowerCase().replace(/[^a-z0-9]+/g, " ").trim();
  return COUNTY_NAME_BY_NORMALIZED.get(key) || base;
}

export function parseCountyList(input: unknown): string[] {
  if (!input) return [];
  const raw = Array.isArray(input) ? input : String(input).split(",");
  const out: string[] = [];
  for (const value of raw) {
    const county = normalizeCounty(value);
    if (!county) continue;
    if (!out.includes(county)) out.push(county);
  }
  return out;
}

export function isKy(stateCode: unknown): boolean {
  return String(stateCode || "").toUpperCase() === "KY";
}

export function sourceHost(url: unknown): string {
  try {
    return new URL(String(url || "")).hostname.replace(/^www\./, "").toLowerCase();
  } catch {
    return "";
  }
}

export function canonicalUrl(url: unknown): string {
  try {
    const u = new URL(String(url || ""));
    for (const key of [...u.searchParams.keys()]) {
      if (/^(utm_|fbclid$|gclid$|mc_eid$|mkt_tok$)/i.test(key)) {
        u.searchParams.delete(key);
      }
    }
    u.hash = "";
    const pathname = u.pathname.replace(/\/+$/, "");
    u.pathname = pathname || "/";
    return u.toString();
  } catch {
    return "";
  }
}

export function titleFingerprint(title: unknown): string {
  const norm = String(title || "")
    .toLowerCase()
    .replace(/[^a-z0-9 ]+/g, " ")
    .replace(/\b(the|a|an|and|or|for|to|of|in|on|at|from|with|by|as|is|was|are|were)\b/g, " ")
    .replace(/\s+/g, " ")
    .trim();
  // Also store a sorted-token variant so "flooding Leslie County" and
  // "Leslie County flooding" produce the same fingerprint key when lookups
  // use sortedTitleFingerprint().
  return norm;
}

export function sortedTitleFingerprint(title: unknown): string {
  return titleFingerprint(title).split(" ").filter(Boolean).sort().join(" ");
}

export function isPaidSource(url: unknown): boolean {
  const host = sourceHost(url);
  if (!host) return false;
  return PAID_SOURCE_DOMAINS.some((d) => host === d || host.endsWith(`.${d}`));
}

function countWords(input: unknown): number {
  return String(input || "")
    .trim()
    .split(/\s+/)
    .filter(Boolean).length;
}

function itemHasMinimumWords(item: Record<string, unknown>): boolean {
  const modes = Array.isArray(item.feed_modes) ? item.feed_modes.map((x) => String(x || "").toLowerCase()) : [];
  const categories = Array.isArray(item.feed_categories)
    ? item.feed_categories.map((x) => String(x || "").toLowerCase())
    : [];
  const isFacebookFeed = modes.includes("facebook-page");
  const isSchoolsFeed = categories.some((x) => x.includes("schools"));
  if (isFacebookFeed || isSchoolsFeed) {
    return true;
  }
  const summaryWords = countWords(item.summary);
  const contentWords = countWords(item.content);
  return Math.max(summaryWords, contentWords) >= MIN_ITEM_WORDS;
}

function isHeavyDeprioritizedPaidSource(url: unknown): boolean {
  const host = sourceHost(url);
  if (!host) return false;
  return HEAVY_DEPRIORITIZED_PAID_DOMAINS.some((d) => host === d || host.endsWith(`.${d}`));
}

type RankedItem = Record<string, unknown> & {
  id: string;
  title: string;
  url: string;
  sort_ts?: string;
};

export function rankAndFilterItems(
  items: RankedItem[],
  limit: number,
  options?: {
    includeAll?: boolean;
  }
): RankedItem[] {
  const includeAll = Boolean(options?.includeAll);
  const ranked = items.map((item) => ({
    ...item,
    _isPaid: isPaidSource(item.url),
    _isHeavyPaid: isHeavyDeprioritizedPaidSource(item.url),
    _fp: titleFingerprint(item.title),
    _sfp: sortedTitleFingerprint(item.title),
    _canonicalUrl: canonicalUrl(item.url),
    _source: sourceHost(item.url),
    _sortTs: String(item.sort_ts || "")
  }));

  ranked.sort((a, b) => {
    if (includeAll) {
      return b._sortTs.localeCompare(a._sortTs);
    }
    if (a._isPaid !== b._isPaid) return a._isPaid ? 1 : -1;
    if (a._isHeavyPaid !== b._isHeavyPaid) return a._isHeavyPaid ? 1 : -1;
    return b._sortTs.localeCompare(a._sortTs);
  });

  const nonPaidFingerprints = new Set(ranked.filter((x) => !x._isPaid && x._fp).map((x) => x._fp));
  const nonPaidSortedFPs = new Set(ranked.filter((x) => !x._isPaid && x._sfp).map((x) => x._sfp));
  const seenTitle = new Set<string>();
  const seenSortedTitle = new Set<string>();
  const seenCanonicalUrl = new Set<string>();
  const seenSourceTitle = new Set<string>();
  const filtered: typeof ranked = [];

  for (const item of ranked) {
    if (!includeAll && !itemHasMinimumWords(item)) continue;
    if (!includeAll && item._isPaid && item._fp && nonPaidFingerprints.has(item._fp)) continue;
    if (!includeAll && item._isPaid && item._sfp && nonPaidSortedFPs.has(item._sfp)) continue;
    if (item._canonicalUrl && seenCanonicalUrl.has(item._canonicalUrl)) continue;
    if (item._fp && seenTitle.has(item._fp)) continue;
    if (item._sfp && seenSortedTitle.has(item._sfp)) continue;
    const sourceTitleKey = item._fp ? `${item._fp}|${item._source}` : String(item.id);
    if (seenSourceTitle.has(sourceTitleKey)) continue;
    if (item._canonicalUrl) seenCanonicalUrl.add(item._canonicalUrl);
    if (item._fp) seenTitle.add(item._fp);
    if (item._sfp) seenSortedTitle.add(item._sfp);
    seenSourceTitle.add(sourceTitleKey);
    filtered.push(item);
  }

  if (includeAll) {
    return filtered
      .slice(0, limit)
      .map(({ _isPaid, _isHeavyPaid, _fp, _sfp, _canonicalUrl, _source, _sortTs, ...rest }) => rest as RankedItem);
  }

  const nonPaid = filtered.filter((item) => !item._isPaid);
  const paid = filtered.filter((item) => item._isPaid && !item._isHeavyPaid);
  const heavyPaid = filtered.filter((item) => item._isHeavyPaid);
  const pickedNonPaid = nonPaid.slice(0, limit);
  const paidAllowance =
    pickedNonPaid.length === 0
      ? Math.min(limit, PAID_FALLBACK_WHEN_EMPTY_LIMIT)
      : Math.min(PAID_FALLBACK_LIMIT, Math.max(1, Math.floor(limit * 0.1)));
  const pickedPaid = paid.slice(0, paidAllowance);
  const heavyPaidAllowance = pickedNonPaid.length === 0 && pickedPaid.length === 0 ? Math.min(1, limit) : 0;
  const pickedHeavyPaid = heavyPaid.slice(0, heavyPaidAllowance);

  return [...pickedNonPaid, ...pickedPaid, ...pickedHeavyPaid]
    .slice(0, limit)
    .map(({ _isPaid, _isHeavyPaid, _fp, _sfp, _canonicalUrl, _source, _sortTs, ...rest }) => rest as RankedItem);
}

export function isPrivateHost(hostname: unknown): boolean {
  const host = String(hostname || "").toLowerCase();
  if (!host) return true;
  if (host === "localhost" || host === "127.0.0.1" || host === "::1") return true;
  if (host.startsWith("10.")) return true;
  if (host.startsWith("192.168.")) return true;
  if (/^172\.(1[6-9]|2\d|3[0-1])\./.test(host)) return true;
  return false;
}

export function stripExecutableHtml(html: unknown): string {
  return String(html || "")
    .replace(/<script[\s\S]*?<\/script>/gi, "")
    .replace(/<noscript[\s\S]*?<\/noscript>/gi, "")
    .replace(/<style[\s\S]*?<\/style>/gi, "")
    .replace(/<iframe[\s\S]*?<\/iframe>/gi, "")
    .replace(/<object[\s\S]*?<\/object>/gi, "")
    .replace(/<embed[\s\S]*?>/gi, "")
    .replace(/<link[^>]+rel=["'][^"']*stylesheet[^"']*["'][^>]*>/gi, "")
    .replace(/<meta[^>]+http-equiv=["']content-security-policy["'][^>]*>/gi, "")
    .replace(/\son\w+="[^"]*"/gi, "")
    .replace(/\son\w+='[^']*'/gi, "");
}

export function clampInt(value: unknown, min: number, max: number, fallback: number): number {
  const parsed = Number(value);
  if (!Number.isFinite(parsed)) return fallback;
  return Math.max(min, Math.min(max, Math.floor(parsed)));
}

export function decodeCsvParam(values: string | string[] | undefined): string[] {
  if (!values) return [];
  return Array.isArray(values) ? values : [values];
}

```

# ky-news-worker\src\routes\admin.ts

```ts
import { randomUUID } from "node:crypto";
import { Hono } from "hono";
import { z } from "zod";
import type { AppBindings } from "../types";
import { badRequest, notFound } from "../lib/errors";
import { normalizeCounty, safeJsonParse } from "../lib/utils";
import { runManualFeedIngest, runManualIngest } from "../ingest/ingest";
import { d1All, d1First, d1Run, tableHasColumn } from "../services/db";
import { insertAdminLog, requireRole } from "../services/security";
import { detectKyCounties } from "../services/location";
import { isKentuckyRelevant } from "../services/relevance";
import { summaryCacheKey, summarySeoCacheKey } from "../services/summary";

const IngestionLogsQuery = z.object({
  limit: z.coerce.number().min(1).max(200).default(50),
  cursor: z.coerce.number().int().positive().optional()
});

const FeedHealthQuery = z.object({
  hours: z.coerce.number().min(1).max(24 * 14).default(48),
  limit: z.coerce.number().min(1).max(500).default(300)
});

const SummaryQueueQuery = z.object({
  status: z.enum(["pending", "approved", "rejected", "edited", "all"]).default("pending"),
  limit: z.coerce.number().min(1).max(200).default(50),
  cursor: z.string().optional()
});

const SummaryReviewBody = z.object({
  action: z.enum(["approve", "reject", "edit"]),
  summary: z.string().min(80).max(12000).optional(),
  note: z.string().max(1000).optional()
});

const TagCorrectionBody = z.object({
  state: z.string().length(2).default("KY"),
  counties: z.array(z.string().min(1).max(80)).max(20).default([]),
  note: z.string().max(500).optional()
});

const TagCorrectionQuery = z.object({
  itemId: z.string().optional(),
  limit: z.coerce.number().min(1).max(200).default(50)
});

const IngestionMetricsQuery = z.object({
  days: z.coerce.number().min(1).max(90).default(7)
});

const ErrorQuery = z.object({
  limit: z.coerce.number().min(1).max(200).default(50),
  route: z.string().max(300).optional()
});

const KvLogQuery = z.object({
  day: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).default(new Date().toISOString().slice(0, 10)),
  event: z.string().max(120).optional(),
  limit: z.coerce.number().min(1).max(100).default(30),
  cursor: z.string().optional()
});

const RevalidateItemsBody = z.object({
  hours: z.coerce.number().min(1).max(24 * 90).default(72),
  limit: z.coerce.number().min(1).max(3000).default(800),
  minWords: z.coerce.number().min(1).max(1000).default(50),
  dryRun: z.boolean().default(true),
  includeNational: z.boolean().default(false)
});

function queryInput(c: any): Record<string, unknown> {
  const params = new URL(c.req.url).searchParams;
  return Object.fromEntries(params.entries());
}

function parseCompositeCursor(cursor: string | undefined): { ts: string; itemId: string } | null {
  if (!cursor) return null;
  const [ts, itemId] = cursor.split("|");
  if (!ts || !itemId) return null;
  return { ts, itemId };
}

function chunkArray<T>(values: T[], chunkSize: number): T[][] {
  const size = Math.max(1, Math.floor(chunkSize));
  const out: T[][] = [];
  for (let i = 0; i < values.length; i += size) {
    out.push(values.slice(i, i + size));
  }
  return out;
}

function wordCount(input: unknown): number {
  return String(input || "")
    .trim()
    .split(/\s+/)
    .filter(Boolean).length;
}

function locationSet(rows: Array<{ state_code: string; county: string }>): Set<string> {
  return new Set(rows.map((r) => `${String(r.state_code || "").toUpperCase()}|${normalizeCounty(r.county || "")}`));
}

function sameSet(a: Set<string>, b: Set<string>): boolean {
  if (a.size !== b.size) return false;
  for (const v of a) {
    if (!b.has(v)) return false;
  }
  return true;
}

export function registerAdminRoutes(app: Hono<AppBindings>): void {
  app.post("/api/admin/feeds/reload", async (c) => {
    const admin = requireRole(c, "editor");
    const requestRunId = randomUUID();

    await insertAdminLog(c.env, admin.email, "feeds.reload.accepted", "ingester", "manual", {
      runId: requestRunId
    });

    c.executionCtx.waitUntil(
      (async () => {
        const run = await runManualIngest(c.env);
        await insertAdminLog(c.env, admin.email, "feeds.reload.completed", "ingester", "manual", {
          runId: requestRunId,
          ok: run.ok,
          code: run.code,
          stderr: run.stderr.slice(-1200),
          stdout: run.stdout.slice(-1200)
        });
      })()
    );

    return c.json(
      {
        ok: true,
        accepted: true,
        runId: requestRunId,
        message: "Ingestion started. Check ingestion logs/health for progress."
      },
      202
    );
  });

  app.post("/api/admin/feeds/:id/trigger", async (c) => {
    const admin = requireRole(c, "editor");
    const feedId = String(c.req.param("id") || "").trim();
    if (!feedId) badRequest("Feed id is required");

    const feed = await d1First<{ id: string; name: string }>(
      c.env.ky_news_db,
      "SELECT id, name FROM feeds WHERE id=? AND enabled=1",
      [feedId]
    );
    if (!feed) notFound("Feed not found or disabled");

    const run = await runManualFeedIngest(c.env, [feedId]);

    await insertAdminLog(c.env, admin.email, "feeds.trigger", "feed", feedId, {
      code: run.code,
      stderr: run.stderr.slice(-500)
    });

    if (!run.ok) {
      return c.json({ ok: false, code: run.code, stderr: run.stderr, stdout: run.stdout }, 500);
    }

    return c.json({ ok: true, code: run.code, feedId, feedName: feed.name, stdout: run.stdout, stderr: run.stderr });
  });

  app.post("/api/admin/items/revalidate", async (c) => {
    const admin = requireRole(c, "editor");
    const payload = await c.req.json().catch(() => null);
    const parsed = RevalidateItemsBody.safeParse(payload || {});
    if (!parsed.success) badRequest("Invalid payload");

    const options = parsed.data;
    const window = `-${options.hours} hours`;
    const [hasArticleExcerpt, hasRegionScope] = await Promise.all([
      tableHasColumn(c.env.ky_news_db, "items", "article_text_excerpt"),
      tableHasColumn(c.env.ky_news_db, "items", "region_scope")
    ]);
    const excerptSelect = hasArticleExcerpt
      ? "i.article_text_excerpt AS article_text_excerpt"
      : "'' AS article_text_excerpt";
    const scopeWhere = options.includeNational || !hasRegionScope ? "" : "AND i.region_scope='ky'";

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        i.id,
        i.title,
        i.summary,
        i.content,
        ${excerptSelect}
      FROM items i
      WHERE COALESCE(i.published_at, i.fetched_at) >= datetime('now', ?)
        ${scopeWhere}
      ORDER BY COALESCE(i.published_at, i.fetched_at) DESC
      LIMIT ?
      `,
      [window, options.limit]
    );

    const summary = {
      scanned: rows.length,
      dryRun: options.dryRun,
      hours: options.hours,
      limit: options.limit,
      minWords: options.minWords,
      includeNational: options.includeNational,
      unchanged: 0,
      wouldRetag: 0,
      retagged: 0,
      wouldPrune: 0,
      pruned: 0,
      prunedFeedLinks: 0,
      samples: [] as Array<Record<string, unknown>>
    };

    if (!rows.length) {
      await insertAdminLog(c.env, admin.email, "items.revalidate", "items", "batch", summary);
      return c.json({ ok: true, summary });
    }

    const itemIds = rows.map((r) => String(r.id || "")).filter(Boolean);
    const tagRows: Array<{ item_id: string; state_code: string; county: string }> = [];
    // D1 limits bind parameters to ~100 per statement; use 99 to stay safely under the limit
    for (const batch of chunkArray(itemIds, 99)) {
      if (!batch.length) continue;
      const partial = await d1All<{ item_id: string; state_code: string; county: string }>(
        c.env.ky_news_db,
        `
        SELECT item_id, state_code, county
        FROM item_locations
        WHERE item_id IN (${batch.map(() => "?").join(",")})
        `,
        batch
      );
      tagRows.push(...partial);
    }

    const tagsByItem = new Map<string, Array<{ state_code: string; county: string }>>();
    for (const row of tagRows) {
      const id = String(row.item_id || "");
      if (!id) continue;
      const next = tagsByItem.get(id) || [];
      next.push({
        state_code: String(row.state_code || "").toUpperCase(),
        county: normalizeCounty(row.county || "")
      });
      tagsByItem.set(id, next);
    }

    for (const row of rows) {
      const itemId = String(row.id || "");
      if (!itemId) continue;

      const title = String(row.title || "");
      const summaryText = String(row.summary || "");
      const content = String(row.content || "");
      const excerpt = String(row.article_text_excerpt || "");
      const articleText = excerpt || content || "";
      const qualityText = articleText || summaryText || "";
      const words = wordCount(qualityText);

      if (words < options.minWords) {
        summary.wouldPrune += 1;
        if (summary.samples.length < 20) {
          summary.samples.push({
            item_id: itemId,
            action: "prune",
            words,
            title
          });
        }
        if (!options.dryRun) {
          const refs = await d1First<{ refs: number }>(
            c.env.ky_news_db,
            "SELECT COUNT(1) AS refs FROM feed_items WHERE item_id=?",
            [itemId]
          );
          await d1Run(c.env.ky_news_db, "DELETE FROM feed_items WHERE item_id=?", [itemId]);
          await d1Run(c.env.ky_news_db, "DELETE FROM item_locations WHERE item_id=?", [itemId]);
          await d1Run(c.env.ky_news_db, "DELETE FROM items WHERE id=?", [itemId]);
          summary.pruned += 1;
          summary.prunedFeedLinks += Number(refs?.refs || 0);
        }
        continue;
      }

      const rssTextToCheck = [title, summaryText].filter(Boolean).join(" ");
      const fullText = articleText || rssTextToCheck;
      const relevance = isKentuckyRelevant(title, fullText);
      const titleCounties = detectKyCounties(title);
      const bodyCounties = detectKyCounties(fullText);
      const taggedCounties = new Set([...titleCounties, ...bodyCounties].map((x) => normalizeCounty(x)).filter(Boolean));
      const shouldTagAsKy = relevance.relevant;

      const existing = tagsByItem.get(itemId) || [];
      const nonKy = existing.filter((x) => x.state_code !== "KY");
      const desired = [...nonKy];

      if (shouldTagAsKy) {
        desired.push({ state_code: "KY", county: "" });
        for (const county of Array.from(taggedCounties).sort((a, b) => a.localeCompare(b))) {
          desired.push({ state_code: "KY", county });
        }
      }

      const currentSet = locationSet(existing);
      const desiredSet = locationSet(desired);
      if (sameSet(currentSet, desiredSet)) {
        summary.unchanged += 1;
        continue;
      }

      summary.wouldRetag += 1;
      if (summary.samples.length < 20) {
        summary.samples.push({
          item_id: itemId,
          action: "retag",
          title,
          counties: Array.from(taggedCounties).sort((a, b) => a.localeCompare(b)),
          should_tag_ky: shouldTagAsKy,
          failed_tier: relevance.failedTier
        });
      }

      if (!options.dryRun) {
        await d1Run(c.env.ky_news_db, "DELETE FROM item_locations WHERE item_id=? AND state_code='KY'", [itemId]);
        if (shouldTagAsKy) {
          await d1Run(
            c.env.ky_news_db,
            "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, 'KY', '')",
            [itemId]
          );
          for (const county of Array.from(taggedCounties)) {
            await d1Run(
              c.env.ky_news_db,
              "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, 'KY', ?)",
              [itemId, county]
            );
          }
        }
        summary.retagged += 1;
      }
    }

    await insertAdminLog(c.env, admin.email, "items.revalidate", "items", "batch", summary);
    return c.json({ ok: true, summary });
  });

  app.get("/api/admin/ingestion/logs", async (c) => {
    requireRole(c, "editor");
    const parsed = IngestionLogsQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const { limit, cursor } = parsed.data;

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        fr.id,
        fr.started_at,
        fr.finished_at,
        fr.status,
        fr.source,
        fr.details_json,
        (
          SELECT COUNT(*)
          FROM feed_run_metrics frm
          WHERE frm.run_id = fr.id AND frm.status = 'error'
        ) AS feed_errors
      FROM fetch_runs fr
      ${cursor ? "WHERE fr.id < ?" : ""}
      ORDER BY fr.id DESC
      LIMIT ?
      `,
      cursor ? [cursor, limit] : [limit]
    );

    const logs = rows.map((row) => ({
      id: row.id,
      started_at: row.started_at,
      finished_at: row.finished_at,
      status: row.status,
      source: row.source,
      feed_errors: Number(row.feed_errors || 0),
      details: safeJsonParse<Record<string, unknown> | null>(row.details_json, null)
    }));

    const nextCursor = logs.length ? Number(logs[logs.length - 1].id) : null;
    return c.json({ logs, nextCursor });
  });

  app.get("/api/admin/feeds/health", async (c) => {
    requireRole(c, "editor");
    const parsed = FeedHealthQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const window = `-${parsed.data.hours} hours`;
    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        f.id,
        f.name,
        f.url,
        f.category,
        f.region_scope,
        f.fetch_mode,
        f.scraper_id,
        f.enabled,
        f.last_checked_at,
        (
          SELECT frm.status FROM feed_run_metrics frm
          WHERE frm.feed_id=f.id
          ORDER BY frm.checked_at DESC
          LIMIT 1
        ) AS last_status,
        (
          SELECT frm.checked_at FROM feed_run_metrics frm
          WHERE frm.feed_id=f.id
          ORDER BY frm.checked_at DESC
          LIMIT 1
        ) AS last_metric_at,
        (
          SELECT frm.duration_ms FROM feed_run_metrics frm
          WHERE frm.feed_id=f.id
          ORDER BY frm.checked_at DESC
          LIMIT 1
        ) AS last_duration_ms,
        (
          SELECT frm.items_upserted FROM feed_run_metrics frm
          WHERE frm.feed_id=f.id
          ORDER BY frm.checked_at DESC
          LIMIT 1
        ) AS last_items_upserted,
        (
          SELECT COUNT(*) FROM feed_run_metrics frm
          WHERE frm.feed_id=f.id AND frm.status='error' AND frm.checked_at >= datetime('now', ?)
        ) AS errors_window,
        (
          SELECT COUNT(*) FROM feed_run_metrics frm
          WHERE frm.feed_id=f.id AND frm.checked_at >= datetime('now', ?)
        ) AS checks_window,
        (
          SELECT COUNT(*)
          FROM feed_items fi
          JOIN items i ON i.id = fi.item_id
          WHERE fi.feed_id=f.id
            AND COALESCE(i.published_at, i.fetched_at) >= datetime('now', ?)
        ) AS recent_items
      FROM feeds f
      WHERE f.enabled=1
      ORDER BY errors_window DESC, f.last_checked_at ASC
      LIMIT ?
      `,
      [window, window, window, parsed.data.limit]
    );

    const health = rows.map((row) => {
      const checks = Number(row.checks_window || 0);
      const errors = Number(row.errors_window || 0);
      const errorRate = checks > 0 ? errors / checks : 0;
      const lastStatus = String(row.last_status || "unknown");
      const status =
        checks === 0
          ? "unknown"
          : lastStatus === "error" || errorRate > 0.4
            ? "critical"
            : errorRate > 0.15
              ? "degraded"
              : "healthy";

      return {
        id: row.id,
        name: row.name,
        url: row.url,
        category: row.category,
        region_scope: row.region_scope,
        fetch_mode: row.fetch_mode,
        scraper_id: row.scraper_id,
        enabled: Number(row.enabled) === 1,
        last_checked_at: row.last_checked_at,
        last_metric_at: row.last_metric_at,
        last_status: lastStatus,
        last_duration_ms: Number(row.last_duration_ms || 0),
        last_items_upserted: Number(row.last_items_upserted || 0),
        recent_items: Number(row.recent_items || 0),
        checks_window: checks,
        errors_window: errors,
        error_rate: Number(errorRate.toFixed(3)),
        health_status: status
      };
    });

    return c.json({ hours: parsed.data.hours, feeds: health });
  });

  app.get("/api/admin/summaries/review", async (c) => {
    requireRole(c, "editor");
    const parsed = SummaryQueueQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const cursor = parseCompositeCursor(parsed.data.cursor);
    const where: string[] = [];
    const binds: unknown[] = [];

    if (parsed.data.status !== "all") {
      where.push("q.status = ?");
      binds.push(parsed.data.status);
    }

    if (cursor) {
      where.push("(q.updated_at < ? OR (q.updated_at = ? AND q.item_id < ?))");
      binds.push(cursor.ts, cursor.ts, cursor.itemId);
    }

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        q.item_id,
        q.status,
        q.queue_reason,
        q.reviewer_email,
        q.reviewed_at,
        q.note,
        q.created_at,
        q.updated_at,
        i.title,
        i.url,
        i.published_at,
        i.summary,
        i.region_scope,
        ais.model,
        ais.generated_at
      FROM summary_review_queue q
      JOIN items i ON i.id = q.item_id
      LEFT JOIN item_ai_summaries ais ON ais.item_id = q.item_id
      ${where.length ? `WHERE ${where.join(" AND ")}` : ""}
      ORDER BY q.updated_at DESC, q.item_id DESC
      LIMIT ?
      `,
      [...binds, parsed.data.limit]
    );

    const queue = rows.map((row) => ({
      item_id: row.item_id,
      status: row.status,
      queue_reason: row.queue_reason,
      reviewer_email: row.reviewer_email,
      reviewed_at: row.reviewed_at,
      note: row.note,
      created_at: row.created_at,
      updated_at: row.updated_at,
      item: {
        title: row.title,
        url: row.url,
        published_at: row.published_at,
        summary: row.summary,
        region_scope: row.region_scope
      },
      ai: {
        model: row.model,
        generated_at: row.generated_at
      }
    }));

    const tail = queue[queue.length - 1];
    const nextCursor = tail ? `${tail.updated_at}|${tail.item_id}` : null;

    return c.json({ queue, nextCursor });
  });

  app.post("/api/admin/summaries/:itemId/review", async (c) => {
    const admin = requireRole(c, "editor");
    const itemId = String(c.req.param("itemId") || "");
    if (!itemId) badRequest("Item id is required");

    const payload = await c.req.json().catch(() => null);
    const parsed = SummaryReviewBody.safeParse(payload || {});
    if (!parsed.success) badRequest("Invalid payload");

    const item = await d1First<{ id: string; summary: string | null; seo_description: string | null }>(
      c.env.ky_news_db,
      "SELECT id, summary, seo_description FROM items WHERE id=?",
      [itemId]
    );
    if (!item) notFound("Item not found");

    if (parsed.data.action === "edit" && !parsed.data.summary) {
      badRequest("Edited summary is required");
    }

    let reviewedSummary = parsed.data.summary || item.summary || null;
    let status = parsed.data.action === "approve" ? "approved" : parsed.data.action === "reject" ? "rejected" : "edited";

    if ((parsed.data.action === "edit" || parsed.data.action === "approve") && reviewedSummary) {
      await d1Run(c.env.ky_news_db, "UPDATE items SET summary=? WHERE id=?", [reviewedSummary, itemId]);
      await d1Run(
        c.env.ky_news_db,
        `
        INSERT INTO item_ai_summaries (item_id, summary, seo_description, model, source_hash, generated_at)
        VALUES (?, ?, ?, 'human-reviewed', NULL, datetime('now'))
        ON CONFLICT(item_id) DO UPDATE SET
          summary=excluded.summary,
          seo_description=COALESCE(excluded.seo_description, item_ai_summaries.seo_description),
          model=excluded.model,
          generated_at=excluded.generated_at
        `,
        [itemId, reviewedSummary, item.seo_description]
      );
      const ttl = Number(c.env.SUMMARY_CACHE_TTL_SECONDS || 30 * 24 * 60 * 60);
      const cacheWrites = [
        c.env.CACHE.put(summaryCacheKey(itemId), reviewedSummary, {
          expirationTtl: ttl
        }),
        // Legacy cache keys kept to avoid stale reads during rollout.
        c.env.CACHE.put(`summary:v2:${itemId}`, reviewedSummary, {
          expirationTtl: ttl
        }),
        c.env.CACHE.put(`summary:v1:${itemId}`, reviewedSummary, {
          expirationTtl: ttl
        })
      ];

      const seoDescription = (item.seo_description || "").trim();
      if (seoDescription) {
        cacheWrites.push(
          c.env.CACHE.put(summarySeoCacheKey(itemId), seoDescription, {
            expirationTtl: ttl
          })
        );
      }

      await Promise.all(cacheWrites);
    }

    await d1Run(
      c.env.ky_news_db,
      `
      INSERT INTO summary_review_queue (
        item_id, status, queue_reason, reviewer_email, reviewed_at, reviewed_summary, note, created_at, updated_at
      ) VALUES (?, ?, 'manual_review', ?, datetime('now'), ?, ?, datetime('now'), datetime('now'))
      ON CONFLICT(item_id) DO UPDATE SET
        status=excluded.status,
        reviewer_email=excluded.reviewer_email,
        reviewed_at=excluded.reviewed_at,
        reviewed_summary=excluded.reviewed_summary,
        note=excluded.note,
        updated_at=excluded.updated_at
      `,
      [itemId, status, admin.email, reviewedSummary, parsed.data.note || null]
    );

    await insertAdminLog(c.env, admin.email, "summary.review", "item", itemId, {
      action: parsed.data.action,
      note: parsed.data.note || null
    });

    return c.json({ ok: true, itemId, status });
  });

  app.get("/api/admin/items/:id/tags", async (c) => {
    requireRole(c, "editor");
    const id = String(c.req.param("id") || "");

    const item = await d1First<{ id: string; title: string; url: string }>(
      c.env.ky_news_db,
      "SELECT id, title, url FROM items WHERE id=?",
      [id]
    );
    if (!item) notFound("Item not found");

    const tags = await d1All<{ state_code: string; county: string }>(
      c.env.ky_news_db,
      "SELECT state_code, county FROM item_locations WHERE item_id=? ORDER BY state_code, county",
      [id]
    );

    const states = Array.from(new Set(tags.filter((t) => !t.county).map((t) => t.state_code)));
    const counties = tags.filter((t) => t.county).map((t) => t.county);

    return c.json({
      item,
      tags: {
        states,
        counties
      }
    });
  });

  app.put("/api/admin/items/:id/tags", async (c) => {
    const admin = requireRole(c, "editor");
    const itemId = String(c.req.param("id") || "");

    const payload = await c.req.json().catch(() => null);
    const parsed = TagCorrectionBody.safeParse(payload || {});
    if (!parsed.success) badRequest("Invalid payload");

    const item = await d1First<{ id: string }>(c.env.ky_news_db, "SELECT id FROM items WHERE id=?", [itemId]);
    if (!item) notFound("Item not found");

    const previousRows = await d1All<{ state_code: string; county: string }>(
      c.env.ky_news_db,
      "SELECT state_code, county FROM item_locations WHERE item_id=? ORDER BY state_code, county",
      [itemId]
    );

    const previous = {
      states: Array.from(new Set(previousRows.filter((r) => !r.county).map((r) => r.state_code))),
      counties: previousRows.filter((r) => r.county).map((r) => r.county)
    };

    const state = parsed.data.state.toUpperCase();
    const counties = Array.from(new Set(parsed.data.counties.map((c) => normalizeCounty(c)).filter(Boolean))).slice(0, 20);

    await d1Run(c.env.ky_news_db, "DELETE FROM item_locations WHERE item_id=?", [itemId]);
    await d1Run(c.env.ky_news_db, "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, ?, '')", [
      itemId,
      state
    ]);

    for (const county of counties) {
      await d1Run(
        c.env.ky_news_db,
        "INSERT OR IGNORE INTO item_locations (item_id, state_code, county) VALUES (?, ?, ?)",
        [itemId, state, county]
      );
    }

    const nextTags = { states: [state], counties };

    await d1Run(
      c.env.ky_news_db,
      `
      INSERT INTO item_tag_corrections (
        id, item_id, actor_email, previous_tags_json, new_tags_json, note, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
      `,
      [
        randomUUID(),
        itemId,
        admin.email,
        JSON.stringify(previous),
        JSON.stringify(nextTags),
        parsed.data.note || null
      ]
    );

    await insertAdminLog(c.env, admin.email, "tags.correct", "item", itemId, {
      previous,
      next: nextTags,
      note: parsed.data.note || null
    });

    return c.json({ ok: true, itemId, tags: nextTags });
  });

  app.get("/api/admin/tags/corrections", async (c) => {
    requireRole(c, "editor");
    const parsed = TagCorrectionQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        tc.id,
        tc.item_id,
        tc.actor_email,
        tc.previous_tags_json,
        tc.new_tags_json,
        tc.note,
        tc.created_at,
        i.title,
        i.url
      FROM item_tag_corrections tc
      JOIN items i ON i.id = tc.item_id
      ${parsed.data.itemId ? "WHERE tc.item_id = ?" : ""}
      ORDER BY tc.created_at DESC
      LIMIT ?
      `,
      parsed.data.itemId ? [parsed.data.itemId, parsed.data.limit] : [parsed.data.limit]
    );

    const corrections = rows.map((r) => ({
      id: r.id,
      item_id: r.item_id,
      actor_email: r.actor_email,
      previous_tags: safeJsonParse<Record<string, unknown>>(r.previous_tags_json, {}),
      new_tags: safeJsonParse<Record<string, unknown>>(r.new_tags_json, {}),
      note: r.note,
      created_at: r.created_at,
      item: {
        title: r.title,
        url: r.url
      }
    }));

    return c.json({ corrections });
  });

  app.get("/api/admin/metrics/ingestion", async (c) => {
    requireRole(c, "editor");
    const parsed = IngestionMetricsQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const window = `-${parsed.data.days} days`;
    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        date(created_at) AS day,
        COUNT(*) AS runs,
        SUM(feeds_processed) AS feeds_processed,
        SUM(feeds_updated) AS feeds_updated,
        SUM(items_seen) AS items_seen,
        SUM(items_upserted) AS items_upserted,
        SUM(summaries_generated) AS summaries_generated,
        SUM(images_mirrored) AS images_mirrored,
        SUM(errors) AS errors
      FROM ingestion_metrics
      WHERE created_at >= datetime('now', ?)
      GROUP BY date(created_at)
      ORDER BY day DESC
      `,
      [window]
    );

    return c.json({ days: parsed.data.days, metrics: rows });
  });

  app.get("/api/admin/errors", async (c) => {
    requireRole(c, "editor");
    const parsed = ErrorQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT id, request_id, route, method, status_code, actor_email, error_message, error_stack, meta_json, created_at
      FROM app_error_events
      ${parsed.data.route ? "WHERE route = ?" : ""}
      ORDER BY created_at DESC
      LIMIT ?
      `,
      parsed.data.route ? [parsed.data.route, parsed.data.limit] : [parsed.data.limit]
    );

    const errors = rows.map((r) => ({
      id: r.id,
      request_id: r.request_id,
      route: r.route,
      method: r.method,
      status_code: r.status_code,
      actor_email: r.actor_email,
      error_message: r.error_message,
      error_stack: r.error_stack,
      meta: safeJsonParse<Record<string, unknown> | null>(r.meta_json, null),
      created_at: r.created_at
    }));

    return c.json({ errors });
  });

  app.get("/api/admin/logs/kv", async (c) => {
    requireRole(c, "editor");
    const parsed = KvLogQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const prefix = parsed.data.event
      ? `log:v1:${parsed.data.day}:${parsed.data.event}:`
      : `log:v1:${parsed.data.day}:`;

    const listed = await c.env.CACHE.list({
      prefix,
      limit: parsed.data.limit,
      cursor: parsed.data.cursor
    });

    const pairs = await Promise.all(
      listed.keys.map(async (k) => {
        const value = await c.env.CACHE.get(k.name);
        return value ? safeJsonParse<Record<string, unknown>>(value, { raw: value }) : null;
      })
    );

    const logs = pairs.filter(Boolean);
    return c.json({
      day: parsed.data.day,
      event: parsed.data.event || null,
      logs,
      cursor: listed.list_complete ? null : listed.cursor
    });
  });
}

```

# ky-news-worker\src\routes\lostFound.ts

```ts
import { randomUUID } from "node:crypto";
import { Hono } from "hono";
import { z } from "zod";
import type { AppBindings } from "../types";
import { badRequest, forbidden, notFound, tooManyRequests, unauthorized } from "../lib/errors";
import { LOST_FOUND_STATUSES, LOST_FOUND_TYPES, normalizeCounty } from "../lib/utils";
import { d1All, d1First, d1Run } from "../services/db";
import { decryptText, encryptText, hashIp } from "../lib/crypto";
import {
  enforceRateLimit,
  enforceSubmissionRateLimit,
  getAdminIdentity,
  getClientIp,
  insertAdminLog,
  requireAdmin
} from "../services/security";

const COMMENT_URL_RE = /(?:https?:\/\/|www\.)\S+/gi;
const COMMENT_MAX_URLS = 1;
const COMMENT_RATE_LIMIT = 8;
const COMMENT_RATE_WINDOW_SECONDS = 60 * 60;
const COMMENT_BLOCKLIST = [
  /\bfuck(?:ing|ed|er|s)?\b/i,
  /\bshit(?:ty|ting|ted|s)?\b/i,
  /\basshole(?:s)?\b/i,
  /\bbitch(?:es|y)?\b/i,
  /\bbastard(?:s)?\b/i,
  /\bkill\s+yourself\b/i,
  /\bi\s+will\s+kill\s+you\b/i
];

function deriveExt(mimeType: string): string | null {
  const map: Record<string, string> = {
    "image/jpeg": "jpg",
    "image/jpg": "jpg",
    "image/png": "png",
    "image/webp": "webp",
    "image/gif": "gif",
    "image/avif": "avif"
  };
  return map[String(mimeType || "").toLowerCase()] || null;
}

function assertSafeKey(raw: string): string {
  const key = decodeURIComponent(String(raw || ""));
  if (!/^[a-zA-Z0-9/_\-.]+$/.test(key) || key.includes("..")) {
    badRequest("Invalid object key");
  }
  return key;
}

function queryInput(c: any): Record<string, unknown> {
  const params = new URL(c.req.url).searchParams;
  return Object.fromEntries(params.entries());
}

function countCommentUrls(text: string): number {
  const matches = String(text || "").match(COMMENT_URL_RE);
  return matches ? matches.length : 0;
}

function hasBlockedCommentLanguage(text: string): boolean {
  const value = String(text || "");
  return COMMENT_BLOCKLIST.some((re) => re.test(value));
}

function normalizeCommentText(text: string): string {
  return String(text || "").replace(/\s+/g, " ").trim();
}

async function mapLostFoundRow(
  env: AppBindings["Bindings"],
  row: Record<string, any>,
  includeContact = false
): Promise<Record<string, unknown>> {
  const images = String(row.images_csv || "")
    .split(",")
    .map((v) => v.trim())
    .filter(Boolean);

  const contact = includeContact || Number(row.show_contact) === 1 ? await decryptText(env, row.contact_email_encrypted) : null;

  return {
    id: row.id,
    type: row.type,
    title: row.title,
    description: row.description,
    county: row.county,
    state_code: row.state_code,
    status: row.status,
    show_contact: Number(row.show_contact) === 1,
    contact_email: contact,
    submitted_at: row.submitted_at,
    approved_at: row.approved_at,
    rejected_at: row.rejected_at,
    is_resolved: Number(row.is_resolved) === 1,
    resolved_at: row.resolved_at,
    resolved_note: row.resolved_note,
    comment_count: Number(row.comment_count || 0),
    expires_at: row.expires_at,
    moderation_note: row.moderation_note,
    images
  };
}

function mapCommentRow(row: Record<string, any>): Record<string, unknown> {
  return {
    id: row.id,
    post_id: row.post_id,
    name: row.commenter_name,
    comment: row.comment_text,
    created_at: row.created_at
  };
}

function mapAdminCommentRow(row: Record<string, any>): Record<string, unknown> {
  return {
    id: row.id,
    post_id: row.post_id,
    post_title: row.post_title || null,
    name: row.commenter_name,
    comment: row.comment_text,
    created_at: row.created_at,
    commenter_email_hash: row.commenter_email_hash,
    commenter_ip_hash: row.commenter_ip_hash
  };
}

function mapCommentBanRow(row: Record<string, any>): Record<string, unknown> {
  return {
    id: row.id,
    target_type: row.target_type,
    reason: row.reason || null,
    banned_by_email: row.banned_by_email,
    source_comment_id: row.source_comment_id || null,
    created_at: row.created_at
  };
}

async function findLostFoundCommentBan(
  env: AppBindings["Bindings"],
  emailHash: string,
  ipHash: string
): Promise<{ id: string; target_type: string; reason: string | null } | null> {
  return d1First<{ id: string; target_type: string; reason: string | null }>(
    env.ky_news_db,
    `
    SELECT id, target_type, reason
    FROM lost_found_comment_bans
    WHERE (target_type='email' AND target_hash=?)
       OR (target_type='ip' AND target_hash=?)
    ORDER BY created_at DESC
    LIMIT 1
    `,
    [emailHash, ipHash]
  );
}

export function registerLostFoundRoutes(app: Hono<AppBindings>): void {
  app.get("/api/uploads/lost-found/:key{.+}", async (c) => {
    const key = assertSafeKey(c.req.param("key"));
    const object = await c.env.ky_news_media.get(`lost-found/${key}`);
    if (!object) notFound("Image not found");

    const headers = new Headers();
    object.writeHttpMetadata(headers);
    headers.set("etag", object.httpEtag);
    if (!headers.has("cache-control")) {
      headers.set("cache-control", "public, max-age=604800");
    }

    return new Response(object.body, { headers });
  });

  const UploadUrlBody = z.object({
    filename: z.string().min(1).max(180),
    mimeType: z.string().min(3).max(80)
  });

  app.post("/api/uploads/lost-found-url", async (c) => {
    const body = await c.req.json().catch(() => null);
    const parsed = UploadUrlBody.safeParse(body || {});
    if (!parsed.success) badRequest("Invalid payload");

    const ext = deriveExt(parsed.data.mimeType);
    if (!ext) badRequest("Unsupported file type");

    const objectKey = `${new Date().toISOString().slice(0, 10)}-${randomUUID()}.${ext}`;

    return c.json({
      objectKey,
      uploadUrl: `/api/uploads/lost-found/${encodeURIComponent(objectKey)}`,
      method: "PUT",
      headers: {
        "content-type": parsed.data.mimeType
      },
      maxBytes: 8 * 1024 * 1024
    });
  });

  app.put("/api/uploads/lost-found/:key{.+}", async (c) => {
    const key = assertSafeKey(c.req.param("key"));

    const contentType = (c.req.header("content-type") || "application/octet-stream").toLowerCase();
    const ext = deriveExt(contentType);
    if (!ext) badRequest("Unsupported file type");

    const bytes = new Uint8Array(await c.req.arrayBuffer());
    if (bytes.length > 8 * 1024 * 1024) {
      badRequest("File too large");
    }

    await c.env.ky_news_media.put(`lost-found/${key}`, bytes, {
      httpMetadata: {
        contentType,
        cacheControl: "public, max-age=604800"
      },
      customMetadata: {
        key,
        uploaded_at: new Date().toISOString()
      }
    });

    return c.json({ ok: true, objectKey: key, bytes: bytes.length });
  });

  const ListQuery = z.object({
    type: z.enum(LOST_FOUND_TYPES).optional(),
    county: z.string().min(2).max(80).optional(),
    status: z.enum(LOST_FOUND_STATUSES).default("published"),
    limit: z.coerce.number().min(1).max(100).default(40)
  });

  app.get("/api/lost-found", async (c) => {
    const parsed = ListQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const admin = getAdminIdentity(c);
    const where = ["datetime(p.expires_at) > datetime('now')"];
    const binds: unknown[] = [];

    if (!admin && parsed.data.status !== "published") unauthorized("Only published lost-and-found posts are public");

    if (parsed.data.status === "published") {
      where.push("p.status = 'approved'");
      where.push("COALESCE(p.is_resolved, 0) = 0");
    } else if (parsed.data.status === "resolved") {
      where.push("p.status = 'approved'");
      where.push("COALESCE(p.is_resolved, 0) = 1");
    } else {
      where.push("p.status = ?");
      binds.push(parsed.data.status);
    }

    if (parsed.data.type) {
      where.push("p.type = ?");
      binds.push(parsed.data.type);
    }

    if (parsed.data.county) {
      where.push("p.county = ?");
      binds.push(normalizeCounty(parsed.data.county));
    }

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        p.*,
        (
          SELECT group_concat(i.r2_key)
          FROM lost_found_images i
          WHERE i.post_id = p.id
        ) AS images_csv,
        (
          SELECT COUNT(1)
          FROM lost_found_comments c
          WHERE c.post_id = p.id
        ) AS comment_count
      FROM lost_found_posts p
      WHERE ${where.join(" AND ")}
      ORDER BY p.submitted_at DESC
      LIMIT ?
      `,
      [...binds, parsed.data.limit]
    );

    const posts = await Promise.all(rows.map((r) => mapLostFoundRow(c.env, r, Boolean(admin))));
    c.header("Cache-Control", "public, max-age=30, s-maxage=60, stale-while-revalidate=120");
    return c.json({
      posts,
      status: parsed.data.status,
      county: parsed.data.county ? normalizeCounty(parsed.data.county) : null
    });
  });

  const CommentListQuery = z.object({
    limit: z.coerce.number().min(1).max(200).default(80)
  });

  app.get("/api/lost-found/:id/comments", async (c) => {
    const id = String(c.req.param("id") || "");
    const parsed = CommentListQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const post = await d1First<{ id: string }>(
      c.env.ky_news_db,
      `
      SELECT id
      FROM lost_found_posts
      WHERE id=? AND status='approved' AND datetime(expires_at) > datetime('now')
      LIMIT 1
      `,
      [id]
    );
    if (!post) notFound("Post not found");

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT id, post_id, commenter_name, comment_text, created_at
      FROM lost_found_comments
      WHERE post_id=?
      ORDER BY created_at ASC
      LIMIT ?
      `,
      [id, parsed.data.limit]
    );

    return c.json({ comments: rows.map((row) => mapCommentRow(row)) });
  });

  const CommentBody = z.object({
    name: z.string().min(2).max(80),
    email: z.string().email(),
    comment: z.string().min(2).max(1500),
    acceptTerms: z.literal(true)
  });

  app.post("/api/lost-found/:id/comments", async (c) => {
    const id = String(c.req.param("id") || "");
    const body = await c.req.json().catch(() => null);
    const parsed = CommentBody.safeParse(body || {});
    if (!parsed.success) badRequest("Invalid payload");

    const ip = getClientIp(c);
    const email = parsed.data.email.trim().toLowerCase();
    const emailHash = await hashIp(email);
    const ipHash = await hashIp(ip);

    const ban = await findLostFoundCommentBan(c.env, emailHash, ipHash);
    if (ban) {
      forbidden("You are not allowed to comment at this time.");
    }

    const rl = await enforceRateLimit(c.env, `lf-comment:${ip}`, COMMENT_RATE_LIMIT, COMMENT_RATE_WINDOW_SECONDS);
    if (!rl.allowed) tooManyRequests("Comment rate limit exceeded. Try again later.");

    const post = await d1First<{ id: string }>(
      c.env.ky_news_db,
      `
      SELECT id
      FROM lost_found_posts
      WHERE id=? AND status='approved' AND datetime(expires_at) > datetime('now')
      LIMIT 1
      `,
      [id]
    );
    if (!post) notFound("Post not found");

    const name = normalizeCommentText(parsed.data.name);
    const comment = normalizeCommentText(parsed.data.comment);
    if (!name || !comment) badRequest("Name and comment are required");

    if (hasBlockedCommentLanguage(name) || hasBlockedCommentLanguage(comment)) {
      badRequest("Comment violates the community policy.");
    }

    const urlCount = countCommentUrls(comment);
    if (urlCount > COMMENT_MAX_URLS) {
      badRequest(`Comments are limited to ${COMMENT_MAX_URLS} URL.`);
    }

    const commentId = randomUUID();
    const emailEncrypted = await encryptText(c.env, email);

    await d1Run(
      c.env.ky_news_db,
      `
      INSERT INTO lost_found_comments (
        id, post_id, commenter_name, commenter_email_encrypted, commenter_email_hash,
        comment_text, url_count, commenter_ip_hash
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `,
      [commentId, id, name, emailEncrypted, emailHash, comment, urlCount, ipHash]
    );

    const inserted = await d1First<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT id, post_id, commenter_name, comment_text, created_at
      FROM lost_found_comments
      WHERE id=?
      LIMIT 1
      `,
      [commentId]
    );
    if (!inserted) notFound("Comment not found after insert");

    return c.json({ ok: true, comment: mapCommentRow(inserted) });
  });

  const SubmissionBody = z.object({
    type: z.enum(LOST_FOUND_TYPES),
    title: z.string().min(2).max(120),
    description: z.string().min(4).max(2000),
    county: z.string().min(2).max(80),
    state: z.string().length(2).default("KY"),
    contactEmail: z.string().email(),
    showContact: z.boolean().default(false),
    imageKeys: z.array(z.string().min(1).max(320)).max(5).default([]),
    turnstileToken: z.string().optional()
  });

  app.post("/api/lost-found/submissions", async (c) => {
    const body = await c.req.json().catch(() => null);
    const parsed = SubmissionBody.safeParse(body || {});
    if (!parsed.success) {
      return c.json(
        {
          error: "Invalid payload",
          details: parsed.error.flatten()
        },
        400
      );
    }

    if (c.env.REQUIRE_TURNSTILE === "1" && !parsed.data.turnstileToken) {
      badRequest("Turnstile token is required");
    }

    const ip = getClientIp(c);
    const contactEmail = parsed.data.contactEmail.trim().toLowerCase();
    const emailHash = await hashIp(contactEmail);
    const ipHash = await hashIp(ip);
    const ban = await findLostFoundCommentBan(c.env, emailHash, ipHash);
    if (ban) {
      forbidden("You are not allowed to submit listings at this time.");
    }

    const allowed = await enforceSubmissionRateLimit(c.env, ip);
    if (!allowed) tooManyRequests("Rate limit exceeded. Try again later.");

    if (String(parsed.data.state).toUpperCase() !== "KY") {
      badRequest("Only KY submissions are accepted at this time");
    }

    const id = randomUUID();
    const county = normalizeCounty(parsed.data.county);
    const encryptedContact = await encryptText(c.env, contactEmail);
    const initialStatus = c.env.LOST_FOUND_AUTO_APPROVE === "1" ? "approved" : "pending";

    await d1Run(
      c.env.ky_news_db,
      `
      INSERT INTO lost_found_posts (
        id, type, title, description, county, state_code,
        contact_email_encrypted, show_contact, status, expires_at
      ) VALUES (?, ?, ?, ?, ?, 'KY', ?, ?, ?, datetime('now', '+30 days'))
      `,
      [
        id,
        parsed.data.type,
        parsed.data.title.trim(),
        parsed.data.description.trim(),
        county,
        encryptedContact,
        parsed.data.showContact ? 1 : 0,
        initialStatus
      ]
    );

    if (initialStatus === "approved") {
      await d1Run(c.env.ky_news_db, "UPDATE lost_found_posts SET approved_at=datetime('now') WHERE id=?", [id]);
    }

    for (const imageKey of parsed.data.imageKeys) {
      await d1Run(c.env.ky_news_db, "INSERT INTO lost_found_images (id, post_id, r2_key) VALUES (?, ?, ?)", [
        randomUUID(),
        id,
        imageKey
      ]);
    }

    return c.json({ ok: true, id, status: initialStatus });
  });

  const ReportBody = z.object({
    reason: z.string().min(4).max(400)
  });

  app.post("/api/lost-found/:id/report", async (c) => {
    const id = String(c.req.param("id") || "");
    const body = await c.req.json().catch(() => null);
    const parsed = ReportBody.safeParse(body || {});
    if (!parsed.success) badRequest("Invalid payload");

    const exists = await d1First<{ id: string }>(c.env.ky_news_db, "SELECT id FROM lost_found_posts WHERE id=?", [id]);
    if (!exists) notFound("Post not found");

    const ipHash = await hashIp(getClientIp(c));
    await d1Run(
      c.env.ky_news_db,
      "INSERT INTO lost_found_reports (id, post_id, reason, reporter_ip_hash) VALUES (?, ?, ?, ?)",
      [randomUUID(), id, parsed.data.reason.trim(), ipHash]
    );

    return c.json({ ok: true });
  });

  const MarkFoundBody = z.object({
    contactEmail: z.string().email(),
    note: z.string().max(500).optional()
  });

  app.post("/api/lost-found/:id/mark-found", async (c) => {
    const id = String(c.req.param("id") || "");
    const body = await c.req.json().catch(() => null);
    const parsed = MarkFoundBody.safeParse(body || {});
    if (!parsed.success) badRequest("Invalid payload");

    const ip = getClientIp(c);
    const rl = await enforceRateLimit(c.env, `lf-mark-found:${ip}`, 12, 60 * 60);
    if (!rl.allowed) tooManyRequests("Rate limit exceeded. Try again later.");

    const post = await d1First<{
      id: string;
      type: string;
      status: string;
      is_resolved: number;
      contact_email_encrypted: string;
    }>(
      c.env.ky_news_db,
      `
      SELECT id, type, status, is_resolved, contact_email_encrypted
      FROM lost_found_posts
      WHERE id=? AND datetime(expires_at) > datetime('now')
      LIMIT 1
      `,
      [id]
    );
    if (!post) {
      const exists = await d1First<{ id: string }>(c.env.ky_news_db, "SELECT id FROM lost_found_posts WHERE id=?", [id]);
      if (!exists) notFound("Post not found");
      badRequest("This listing has expired");
    }

    if (post.type !== "lost" || post.status !== "approved") {
      badRequest("Only active lost posts can be marked found");
    }
    if (Number(post.is_resolved || 0) === 1) {
      return c.json({ ok: true, id, status: "resolved" });
    }

    const submittedEmail = parsed.data.contactEmail.trim().toLowerCase();
    const ownerEmail = String((await decryptText(c.env, post.contact_email_encrypted)) || "")
      .trim()
      .toLowerCase();
    if (!ownerEmail || ownerEmail !== submittedEmail) {
      unauthorized("Contact email verification failed");
    }

    const info = await d1Run(
      c.env.ky_news_db,
      `
      UPDATE lost_found_posts
      SET
        is_resolved=1,
        resolved_at=datetime('now'),
        resolved_note=?
      WHERE id=? AND status='approved' AND COALESCE(is_resolved, 0)=0
      `,
      [parsed.data.note || null, id]
    );

    const changed = Number((info.meta as any)?.changes || 0);
    if (!changed) {
      return c.json({ ok: true, id, status: "resolved" });
    }

    return c.json({ ok: true, id, status: "resolved" });
  });

  const AdminListQuery = z.object({
    status: z.enum(["pending", "approved", "rejected", "resolved", "all"]).default("pending"),
    limit: z.coerce.number().min(1).max(200).default(100)
  });
  const AdminCommentListQuery = z.object({
    postId: z.string().min(1).optional(),
    limit: z.coerce.number().min(1).max(300).default(200)
  });
  const AdminBanBody = z.object({
    banUser: z.boolean().default(true),
    banIp: z.boolean().default(true),
    reason: z.string().max(300).optional()
  });
  const AdminBanListQuery = z.object({
    limit: z.coerce.number().min(1).max(300).default(200)
  });

  app.get("/api/admin/lost-found", async (c) => {
    const admin = requireAdmin(c);
    const parsed = AdminListQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const where: string[] = [];
    const binds: unknown[] = [];

    if (parsed.data.status === "resolved") {
      where.push("p.status = 'approved'");
      where.push("COALESCE(p.is_resolved, 0) = 1");
    } else if (parsed.data.status !== "all") {
      where.push("p.status = ?");
      binds.push(parsed.data.status);
    }

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        p.*,
        (
          SELECT group_concat(i.r2_key)
          FROM lost_found_images i
          WHERE i.post_id = p.id
        ) AS images_csv,
        (
          SELECT COUNT(1)
          FROM lost_found_comments c
          WHERE c.post_id = p.id
        ) AS comment_count
      FROM lost_found_posts p
      ${where.length ? `WHERE ${where.join(" AND ")}` : ""}
      ORDER BY p.submitted_at DESC
      LIMIT ?
      `,
      [...binds, parsed.data.limit]
    );

    const posts = await Promise.all(rows.map((r) => mapLostFoundRow(c.env, r, true)));
    return c.json({ admin: admin.email, posts });
  });

  const ApproveBody = z.object({
    showContact: z.boolean().optional(),
    note: z.string().max(500).optional()
  });

  app.post("/api/admin/lost-found/:id/approve", async (c) => {
    const admin = requireAdmin(c);
    const id = String(c.req.param("id") || "");
    const body = await c.req.json().catch(() => null);
    const parsed = ApproveBody.safeParse(body || {});
    if (!parsed.success) badRequest("Invalid payload");

    const info = await d1Run(
      c.env.ky_news_db,
      `
      UPDATE lost_found_posts
      SET
        status='approved',
        approved_at=datetime('now'),
        rejected_at=NULL,
        show_contact=COALESCE(?, show_contact),
        moderation_note=?
      WHERE id=? AND status='pending'
      `,
      [parsed.data.showContact == null ? null : parsed.data.showContact ? 1 : 0, parsed.data.note || null, id]
    );

    const changed = Number((info.meta as any)?.changes || 0);
    if (!changed) notFound("Pending post not found");

    await insertAdminLog(c.env, admin.email, "lost_found.approve", "lost_found_post", id, parsed.data);
    return c.json({ ok: true, id, status: "approved" });
  });

  const RejectBody = z.object({
    reason: z.string().min(3).max(500)
  });

  app.post("/api/admin/lost-found/:id/reject", async (c) => {
    const admin = requireAdmin(c);
    const id = String(c.req.param("id") || "");
    const body = await c.req.json().catch(() => null);
    const parsed = RejectBody.safeParse(body || {});
    if (!parsed.success) badRequest("Invalid payload");

    const info = await d1Run(
      c.env.ky_news_db,
      `
      UPDATE lost_found_posts
      SET
        status='rejected',
        rejected_at=datetime('now'),
        moderation_note=?
      WHERE id=? AND status='pending'
      `,
      [parsed.data.reason.trim(), id]
    );

    const changed = Number((info.meta as any)?.changes || 0);
    if (!changed) notFound("Pending post not found");

    await insertAdminLog(c.env, admin.email, "lost_found.reject", "lost_found_post", id, parsed.data);
    return c.json({ ok: true, id, status: "rejected" });
  });

  app.delete("/api/admin/lost-found/:id", async (c) => {
    const admin = requireAdmin(c);
    const id = String(c.req.param("id") || "");

    const row = await d1First<{ id: string; images_csv: string | null }>(
      c.env.ky_news_db,
      `
      SELECT
        p.id,
        (
          SELECT group_concat(i.r2_key)
          FROM lost_found_images i
          WHERE i.post_id = p.id
        ) AS images_csv
      FROM lost_found_posts p
      WHERE p.id=?
      LIMIT 1
      `,
      [id]
    );
    if (!row) notFound("Post not found");

    const imageKeys = String(row.images_csv || "")
      .split(",")
      .map((v) => v.trim())
      .filter(Boolean);

    await d1Run(c.env.ky_news_db, "DELETE FROM lost_found_images WHERE post_id=?", [id]);
    await d1Run(c.env.ky_news_db, "DELETE FROM lost_found_reports WHERE post_id=?", [id]);
    await d1Run(c.env.ky_news_db, "DELETE FROM lost_found_comments WHERE post_id=?", [id]);
    await d1Run(c.env.ky_news_db, "DELETE FROM lost_found_posts WHERE id=?", [id]);

    await Promise.all(
      imageKeys.map(async (key) => {
        try {
          await c.env.ky_news_media.delete(`lost-found/${key}`);
        } catch {
          // Ignore media delete failures; DB record is source of truth for visibility.
        }
      })
    );

    await insertAdminLog(c.env, admin.email, "lost_found.delete", "lost_found_post", id, {
      deleted_images: imageKeys.length
    });

    return c.json({ ok: true, id, deletedImages: imageKeys.length });
  });

  app.get("/api/admin/lost-found/comments", async (c) => {
    requireAdmin(c);
    const parsed = AdminCommentListQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const where: string[] = [];
    const binds: unknown[] = [];
    if (parsed.data.postId) {
      where.push("c.post_id=?");
      binds.push(parsed.data.postId);
    }

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT
        c.id,
        c.post_id,
        c.commenter_name,
        c.comment_text,
        c.commenter_email_hash,
        c.commenter_ip_hash,
        c.created_at,
        p.title AS post_title
      FROM lost_found_comments c
      JOIN lost_found_posts p ON p.id = c.post_id
      ${where.length ? `WHERE ${where.join(" AND ")}` : ""}
      ORDER BY c.created_at DESC
      LIMIT ?
      `,
      [...binds, parsed.data.limit]
    );

    return c.json({ comments: rows.map((row) => mapAdminCommentRow(row)) });
  });

  app.post("/api/admin/lost-found/comments/:commentId/ban", async (c) => {
    const admin = requireAdmin(c);
    const commentId = String(c.req.param("commentId") || "");
    const body = await c.req.json().catch(() => null);
    const parsed = AdminBanBody.safeParse(body || {});
    if (!parsed.success) badRequest("Invalid payload");

    if (!parsed.data.banUser && !parsed.data.banIp) {
      badRequest("At least one ban target is required");
    }

    const row = await d1First<{
      id: string;
      post_id: string;
      commenter_email_hash: string;
      commenter_ip_hash: string;
    }>(
      c.env.ky_news_db,
      `
      SELECT id, post_id, commenter_email_hash, commenter_ip_hash
      FROM lost_found_comments
      WHERE id=?
      LIMIT 1
      `,
      [commentId]
    );
    if (!row) notFound("Comment not found");

    const targets: Array<{ targetType: "email" | "ip"; targetHash: string }> = [];
    if (parsed.data.banUser && String(row.commenter_email_hash || "").trim()) {
      targets.push({ targetType: "email", targetHash: String(row.commenter_email_hash) });
    }
    if (parsed.data.banIp && String(row.commenter_ip_hash || "").trim()) {
      targets.push({ targetType: "ip", targetHash: String(row.commenter_ip_hash) });
    }
    if (!targets.length) badRequest("Unable to derive ban target from this comment");

    const reason = parsed.data.reason?.trim() || null;
    for (const target of targets) {
      await d1Run(
        c.env.ky_news_db,
        `
        INSERT INTO lost_found_comment_bans (
          id, target_type, target_hash, reason, banned_by_email, source_comment_id
        ) VALUES (?, ?, ?, ?, ?, ?)
        ON CONFLICT(target_type, target_hash) DO UPDATE SET
          reason=excluded.reason,
          banned_by_email=excluded.banned_by_email,
          source_comment_id=excluded.source_comment_id,
          created_at=datetime('now')
        `,
        [randomUUID(), target.targetType, target.targetHash, reason, admin.email, commentId]
      );
    }

    await insertAdminLog(c.env, admin.email, "lost_found.comment.ban", "lost_found_comment", commentId, {
      banUser: parsed.data.banUser,
      banIp: parsed.data.banIp,
      reason
    });

    return c.json({ ok: true, id: commentId, bansApplied: targets.length });
  });

  app.get("/api/admin/lost-found/bans", async (c) => {
    requireAdmin(c);
    const parsed = AdminBanListQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const rows = await d1All<Record<string, unknown>>(
      c.env.ky_news_db,
      `
      SELECT id, target_type, reason, banned_by_email, source_comment_id, created_at
      FROM lost_found_comment_bans
      ORDER BY created_at DESC
      LIMIT ?
      `,
      [parsed.data.limit]
    );

    return c.json({ bans: rows.map((row) => mapCommentBanRow(row)) });
  });

  app.delete("/api/admin/lost-found/bans/:banId", async (c) => {
    const admin = requireAdmin(c);
    const banId = String(c.req.param("banId") || "");

    const row = await d1First<{ id: string; target_type: string; source_comment_id: string | null }>(
      c.env.ky_news_db,
      "SELECT id, target_type, source_comment_id FROM lost_found_comment_bans WHERE id=? LIMIT 1",
      [banId]
    );
    if (!row) notFound("Ban not found");

    await d1Run(c.env.ky_news_db, "DELETE FROM lost_found_comment_bans WHERE id=?", [banId]);
    await insertAdminLog(c.env, admin.email, "lost_found.comment.unban", "lost_found_comment_ban", banId, {
      target_type: row.target_type,
      source_comment_id: row.source_comment_id
    });

    return c.json({ ok: true, id: banId });
  });

  app.delete("/api/admin/lost-found/comments/:commentId", async (c) => {
    const admin = requireAdmin(c);
    const commentId = String(c.req.param("commentId") || "");

    const row = await d1First<{ id: string; post_id: string }>(
      c.env.ky_news_db,
      "SELECT id, post_id FROM lost_found_comments WHERE id=? LIMIT 1",
      [commentId]
    );
    if (!row) notFound("Comment not found");

    await d1Run(c.env.ky_news_db, "DELETE FROM lost_found_comments WHERE id=?", [commentId]);
    await insertAdminLog(c.env, admin.email, "lost_found.comment.delete", "lost_found_comment", commentId, {
      post_id: row.post_id
    });

    return c.json({ ok: true, id: commentId });
  });
}

```

# ky-news-worker\src\routes\news.ts

```ts
import { Hono } from "hono";
import { z } from "zod";
import type { AppBindings } from "../types";
import { badGateway, badRequest, notFound, unsupportedMedia } from "../lib/errors";
import { buildSearchClause } from "../lib/search";
import {
  NEWS_SCOPES,
  isKy,
  isPrivateHost,
  mapItemRow,
  normalizeCounty,
  parseCountyList,
  rankAndFilterItems,
  stripExecutableHtml
} from "../lib/utils";
import { d1All, d1First } from "../services/db";
import { respondCachedJson } from "../services/apiCache";
import { detectKyQueryCounties } from "../services/location";

const ItemsQuery = z.object({
  feedId: z.string().optional(),
  category: z.string().min(1).max(80).optional(),
  scope: z.enum(NEWS_SCOPES).default("ky"),
  state: z.string().length(2).optional(),
  county: z.string().min(1).max(80).optional(),
  counties: z.union([z.string(), z.array(z.string())]).optional(),
  unfiltered: z.string().optional(),
  includeAll: z.string().optional(),
  hours: z.coerce.number().min(0).max(24 * 365).default(2),
  cursor: z.string().optional(),
  limit: z.coerce.number().min(1).max(100).default(30)
});

const SearchQuery = z.object({
  q: z.string().min(1).max(200),
  scope: z.enum(NEWS_SCOPES).default("ky"),
  state: z.string().length(2).optional(),
  county: z.string().min(1).max(80).optional(),
  counties: z.union([z.string(), z.array(z.string())]).optional(),
  hours: z.coerce.number().min(1).max(24 * 365).optional(),
  sort: z.enum(["newest", "oldest"]).default("newest"),
  cursor: z.string().optional(),
  limit: z.coerce.number().min(1).max(100).default(30)
});

const CountiesQuery = z.object({
  state: z.string().length(2).default("KY"),
  hours: z.coerce.number().min(0).max(24 * 365).default(2)
});

const OpenProxyQuery = z.object({
  url: z.string().url()
});

function queryInput(c: any): Record<string, unknown> {
  const url = new URL(c.req.url);
  const countyList = url.searchParams.getAll("counties");

  return {
    ...Object.fromEntries(url.searchParams.entries()),
    counties: countyList.length > 1 ? countyList : countyList[0] || undefined
  };
}

function parseKeysetCursor(cursor: string | undefined): { ts: string; id: string | null } | null {
  if (!cursor) return null;
  const [ts, id] = cursor.split("|");
  if (!ts) return null;
  return { ts, id: id || null };
}

function categoryStrictMatch(category: string | undefined, item: Record<string, unknown>): boolean {
  if (!category) return true;
  const c = category.trim().toLowerCase();
  const title = String(item.title || "");
  const summary = String(item.summary || "");
  const content = String(item.content || "");
  const url = String(item.url || "");
  const haystack = `${title} ${summary} ${content} ${url}`.toLowerCase();

  if (c === "kentucky - weather") {
    return /\b(weather|forecast|storm|storms|tornado|tornadoes|flood|flooding|rain|snow|ice|freeze|warning|watch|advisory|thunderstorm|wind chill|heat advisory)\b/i.test(
      haystack
    );
  }

  if (c === "kentucky - obituaries") {
    // If the item already came from an obituaries-categorized feed (confirmed by DB join),
    // trust the feed categorization — the DB already filtered to obituary feeds.
    const feedCats = Array.isArray(item.feed_categories)
      ? (item.feed_categories as unknown[]).map((x) => String(x || "").toLowerCase())
      : [];
    if (feedCats.some((cat) => cat.includes("obituar"))) return true;

    // For items that arrived via broader queries, require strong obituary signals.
    // Removed standalone 'funeral' and 'visitation' — too broad (e.g. funeral home events).
    return /\b(obituar(y|ies|ied)|obit\b|passed away|in loving memory|in memoriam|survived by|predeceased|laid to rest|celebration of life|death notice|funeral arrangements?|memorial services? (for|of)|graveside service|interment|condolences to the family|passed from this (life|world))\b/i.test(haystack);
  }

  if (c === "kentucky - sports") {
    // Items from sports-categorized feeds always pass; otherwise require sports keywords.
    const feedCats = Array.isArray(item.feed_categories)
      ? (item.feed_categories as unknown[]).map((x) => String(x || "").toLowerCase())
      : [];
    if (feedCats.some((cat) => cat.includes("sport"))) return true;
    return /\b(sport|football|basketball|baseball|soccer|volleyball|softball|wrestling|track|cross country|swimming|tennis|golf|lacrosse|cheerleading|athletics|game|score|stats|playoff|tournament|championship|league|team|coach|athlete|player|roster|draft|season)\b/i.test(haystack);
  }

  if (c === "kentucky - schools") {
    // Trust items from school-categorized feeds (Facebook pages, school RSS).
    const feedCats = Array.isArray(item.feed_categories)
      ? (item.feed_categories as unknown[]).map((x) => String(x || "").toLowerCase())
      : [];
    if (feedCats.some((cat) => cat.includes("school"))) return true;
    return /\b(school|district|student|teacher|classroom|principal|superintendent|curriculum|graduation|enrollment|education|faculty|campus|academy|university|college|kindergarten|elementary|middle school|high school|board of education)\b/i.test(haystack);
  }

  return true;
}

export function registerNewsRoutes(app: Hono<AppBindings>): void {
  app.get("/api/health", (c) => c.json({ ok: true, now: new Date().toISOString() }));

  app.get("/api/feeds", async (c) => {
    const parsed = z.object({ scope: z.enum(NEWS_SCOPES).default("all") }).safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const scope = parsed.data.scope;
    const cacheTtl = Math.max(120, Number(c.env.API_CACHE_TTL_SECONDS || "120"));
    return respondCachedJson(c, {
      ttlSeconds: cacheTtl,
      producer: async () => {
        const rows = await d1All(
          c.env.ky_news_db,
          `
          SELECT id, name, category, url, state_code, region_scope, enabled
          FROM feeds
          WHERE enabled=1
            AND (?='all' OR region_scope=?)
          ORDER BY CASE region_scope WHEN 'ky' THEN 0 ELSE 1 END, category, name
          `,
          [scope, scope]
        );
        return { feeds: rows };
      }
    });
  });

  const handleItemsRequest = async (c: any) => {
    const parsed = ItemsQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const { feedId, category, scope, state, county, counties, unfiltered, includeAll, hours, cursor, limit } = parsed.data;
    const countyList = county ? [normalizeCounty(county)] : parseCountyList(counties);
    const includeUnfiltered = ["1", "true", "yes"].includes(String(unfiltered || "").toLowerCase());
    const includeAllItems = ["1", "true", "yes"].includes(String(includeAll || "").toLowerCase());

    if ((state || countyList.length) && scope === "national") {
      badRequest("State/county filters only apply to KY scope");
    }

    const where: string[] = [];
    const binds: unknown[] = [];

    if (hours > 0) {
      where.push("COALESCE(i.published_at, i.fetched_at) >= datetime('now', ?)");
      binds.push(`-${hours} hours`);
    }

    if (scope !== "all") {
      where.push("i.region_scope = ?");
      binds.push(scope);
    }

    const needsFi = Boolean(feedId || category);
    if (feedId) {
      where.push("fi.feed_id = ?");
      binds.push(feedId);
    }
    if (category) {
      where.push("f.category = ?");
      binds.push(category);
    }

    const stateCode = (state || "KY").toUpperCase();
    const needsLoc = scope !== "national" && Boolean(state || countyList.length);

    if (needsLoc) {
      where.push("i.region_scope = 'ky'");
      if (countyList.length) {
        where.push(`il.state_code = ? AND il.county IN (${countyList.map(() => "?").join(",")})`);
        binds.push(stateCode, ...countyList);
      } else {
        where.push("il.state_code = ? AND il.county = ''");
        binds.push(stateCode);
      }
    }

    const parsedCursor = parseKeysetCursor(cursor);
    if (parsedCursor) {
      if (parsedCursor.id) {
        where.push("(COALESCE(i.published_at, i.fetched_at) < ? OR (COALESCE(i.published_at, i.fetched_at) = ? AND i.id < ?))");
        binds.push(parsedCursor.ts, parsedCursor.ts, parsedCursor.id);
      } else {
        where.push("COALESCE(i.published_at, i.fetched_at) < ?");
        binds.push(parsedCursor.ts);
      }
    }

    const whereSql = where.length ? where.join(" AND ") : "1=1";

    const sql = `
      SELECT DISTINCT
        i.id, i.title, i.url, i.author, i.region_scope, i.published_at, i.summary, i.seo_description, i.content, i.image_url,
        COALESCE(i.published_at, i.fetched_at) AS sort_ts,
        (
          SELECT group_concat(DISTINCT ilx.state_code)
          FROM item_locations ilx
          WHERE ilx.item_id = i.id AND ilx.county = ''
        ) AS states_csv,
        (
          SELECT group_concat(DISTINCT ily.county)
          FROM item_locations ily
          WHERE ily.item_id = i.id AND ily.county != ''
        ) AS counties_csv,
        (
          SELECT group_concat(DISTINCT lower(COALESCE(fm.fetch_mode, 'rss')))
          FROM feed_items fim
          JOIN feeds fm ON fm.id = fim.feed_id
          WHERE fim.item_id = i.id
        ) AS feed_modes_csv,
        (
          SELECT group_concat(DISTINCT COALESCE(fc.category, ''))
          FROM feed_items fic
          JOIN feeds fc ON fc.id = fic.feed_id
          WHERE fic.item_id = i.id
        ) AS feed_categories_csv
      FROM items i
      ${needsFi ? "JOIN feed_items fi ON fi.item_id = i.id" : ""}
      ${category ? "JOIN feeds f ON f.id = fi.feed_id" : ""}
      ${needsLoc ? "JOIN item_locations il ON il.item_id = i.id" : ""}
      WHERE ${whereSql}
      ORDER BY sort_ts DESC, i.id DESC
      LIMIT ?
    `;

    binds.push(includeUnfiltered ? limit : Math.min(limit * 4, 400));

    const rows = await d1All<Record<string, unknown>>(c.env.ky_news_db, sql, binds);
    const mapped = rows.map((row) => mapItemRow(row as Record<string, unknown>)) as unknown as Array<
      Record<string, unknown> & { id: string; title: string; url: string; sort_ts?: string }
    >;
    const strictMapped = mapped.filter((item) => categoryStrictMatch(category, item));
    const items = includeUnfiltered
      ? strictMapped.slice(0, limit)
      : rankAndFilterItems(strictMapped, limit, { includeAll: includeAllItems });
    const tail = items[items.length - 1] as any;
    const nextCursor = items.length ? `${String(tail.sort_ts || "")}|${String(tail.id || "")}` : null;
    c.header("cache-control", "public, max-age=20, s-maxage=45, stale-while-revalidate=90");
    return c.json({ items, nextCursor });
  };

  app.get("/api/items", handleItemsRequest);
  app.get("/api/articles", handleItemsRequest);

  app.get("/api/counties", async (c) => {
    const parsed = CountiesQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const { state, hours } = parsed.data;
    if (!isKy(state)) badRequest("Only KY county counts are supported currently");

    const cacheTtl = Math.max(60, Number(c.env.API_CACHE_TTL_SECONDS || "120"));
    return respondCachedJson(c, {
      ttlSeconds: cacheTtl,
      producer: async () => {
        const where = [
          "il.state_code = ?",
          "il.county != ''",
          "i.region_scope = 'ky'"
        ];
        const binds: unknown[] = [state.toUpperCase()];
        if (hours > 0) {
          where.push("COALESCE(i.published_at, i.fetched_at) >= datetime('now', ?)");
          binds.push(`-${hours} hours`);
        }

        const rows = await d1All<{ county: string; count: number }>(
          c.env.ky_news_db,
          `
          SELECT il.county AS county, COUNT(DISTINCT il.item_id) AS count
          FROM item_locations il
          JOIN items i ON i.id = il.item_id
          WHERE ${where.join(" AND ")}
          GROUP BY il.county
          ORDER BY il.county
          `,
          binds
        );
        return { state: state.toUpperCase(), hours, counties: rows };
      }
    });
  });

  app.get("/api/search", async (c) => {
    const parsed = SearchQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const { q, scope, state, county, counties, hours, sort, cursor, limit } = parsed.data;
    const countyList = county ? [normalizeCounty(county)] : parseCountyList(counties);

    if ((state || countyList.length) && scope === "national") {
      badRequest("State/county filters only apply to KY scope");
    }

    const where: string[] = [];
    const binds: unknown[] = [];

    const search = buildSearchClause(q);
    const hintedCounties =
      scope === "national"
        ? []
        : Array.from(new Set(detectKyQueryCounties(q).map((x) => normalizeCounty(x)).filter(Boolean)));
    if (hintedCounties.length) {
      where.push(
        `(${search.clause} OR EXISTS (
          SELECT 1
          FROM item_locations ilh
          WHERE ilh.item_id = i.id
            AND ilh.state_code = 'KY'
            AND ilh.county IN (${hintedCounties.map(() => "?").join(",")})
        ))`
      );
      binds.push(...search.binds, ...hintedCounties);
    } else {
      where.push(search.clause);
      binds.push(...search.binds);
    }

    if (hours != null) {
      where.push("COALESCE(i.published_at, i.fetched_at) >= datetime('now', ?)");
      binds.push(`-${hours} hours`);
    }

    if (scope !== "all") {
      where.push("i.region_scope = ?");
      binds.push(scope);
    }

    const needsLoc = scope !== "national" && Boolean(state || countyList.length);
    if (needsLoc) {
      const stateCode = (state || "KY").toUpperCase();
      where.push("i.region_scope = 'ky'");

      if (countyList.length) {
        where.push(`il.state_code = ? AND il.county IN (${countyList.map(() => "?").join(",")})`);
        binds.push(stateCode, ...countyList);
      } else {
        where.push("il.state_code = ? AND il.county = ''");
        binds.push(stateCode);
      }
    }

    const parsedCursor = parseKeysetCursor(cursor);
    if (parsedCursor) {
      if (sort === "oldest") {
        if (parsedCursor.id) {
          where.push(
            "(COALESCE(i.published_at, i.fetched_at) > ? OR (COALESCE(i.published_at, i.fetched_at) = ? AND i.id > ?))"
          );
          binds.push(parsedCursor.ts, parsedCursor.ts, parsedCursor.id);
        } else {
          where.push("COALESCE(i.published_at, i.fetched_at) > ?");
          binds.push(parsedCursor.ts);
        }
      } else {
        if (parsedCursor.id) {
          where.push(
            "(COALESCE(i.published_at, i.fetched_at) < ? OR (COALESCE(i.published_at, i.fetched_at) = ? AND i.id < ?))"
          );
          binds.push(parsedCursor.ts, parsedCursor.ts, parsedCursor.id);
        } else {
          where.push("COALESCE(i.published_at, i.fetched_at) < ?");
          binds.push(parsedCursor.ts);
        }
      }
    }

    const sql = `
      SELECT DISTINCT
        i.id, i.title, i.url, i.author, i.region_scope, i.published_at, i.summary, i.seo_description, i.content, i.image_url,
        COALESCE(i.published_at, i.fetched_at) AS sort_ts,
        (
          SELECT group_concat(DISTINCT ilx.state_code)
          FROM item_locations ilx
          WHERE ilx.item_id = i.id AND ilx.county = ''
        ) AS states_csv,
        (
          SELECT group_concat(DISTINCT ily.county)
          FROM item_locations ily
          WHERE ily.item_id = i.id AND ily.county != ''
        ) AS counties_csv,
        (
          SELECT group_concat(DISTINCT lower(COALESCE(fm.fetch_mode, 'rss')))
          FROM feed_items fim
          JOIN feeds fm ON fm.id = fim.feed_id
          WHERE fim.item_id = i.id
        ) AS feed_modes_csv,
        (
          SELECT group_concat(DISTINCT COALESCE(fc.category, ''))
          FROM feed_items fic
          JOIN feeds fc ON fc.id = fic.feed_id
          WHERE fic.item_id = i.id
        ) AS feed_categories_csv
      FROM items i
      ${needsLoc ? "JOIN item_locations il ON il.item_id = i.id" : ""}
      WHERE ${where.join(" AND ")}
      ORDER BY sort_ts ${sort === "oldest" ? "ASC" : "DESC"}, i.id ${sort === "oldest" ? "ASC" : "DESC"}
      LIMIT ?
    `;

    binds.push(Math.min(limit * 4, 400));

    const rows = await d1All<Record<string, unknown>>(c.env.ky_news_db, sql, binds);
    const mapped = rows.map((row) => mapItemRow(row as Record<string, unknown>)) as unknown as Array<
      Record<string, unknown> & { id: string; title: string; url: string; sort_ts?: string }
    >;
    const items = rankAndFilterItems(mapped, limit);
    const tail = items[items.length - 1] as any;
    const nextCursor = items.length ? `${String(tail.sort_ts || "")}|${String(tail.id || "")}` : null;
    c.header("cache-control", "public, max-age=15, s-maxage=30, stale-while-revalidate=60");
    return c.json({ items, nextCursor });
  });

  app.get("/api/items/:id", async (c) => {
    const id = c.req.param("id");
    const cacheTtl = Math.max(60, Number(c.env.API_CACHE_TTL_SECONDS || "120"));
    return respondCachedJson(c, {
      ttlSeconds: cacheTtl,
      producer: async () => {
        const row = await d1First<Record<string, unknown>>(
          c.env.ky_news_db,
          `
          SELECT
            id, title, url, author, region_scope, published_at, summary, seo_description, content, image_url,
            (
              SELECT group_concat(DISTINCT state_code)
              FROM item_locations
              WHERE item_id=items.id AND county=''
            ) AS states_csv,
            (
              SELECT group_concat(DISTINCT county)
              FROM item_locations
              WHERE item_id=items.id AND county!=''
            ) AS counties_csv
          FROM items
          WHERE id=?
          `,
          [id]
        );

        if (!row) notFound("Not found");
        return { item: mapItemRow(row) };
      }
    });
  });

  app.get("/api/open-proxy", async (c) => {
    const parsed = OpenProxyQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid URL");

    let target: URL;
    try {
      target = new URL(parsed.data.url);
    } catch {
      badRequest("Invalid URL");
    }

    if (!["http:", "https:"].includes(target.protocol)) {
      badRequest("Only HTTP(S) URLs are allowed");
    }
    if (isPrivateHost(target.hostname)) {
      badRequest("Private/local hosts are not allowed");
    }

    const ctrl = new AbortController();
    const timeout = setTimeout(() => ctrl.abort(), 15_000);

    try {
      const upstream = await fetch(target.toString(), {
        redirect: "follow",
        signal: ctrl.signal,
        headers: {
          "user-agent": "Mozilla/5.0 (compatible; KentuckyNewsApp/1.0)",
          accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
        }
      });

      if (!upstream.ok) {
        badGateway(`Upstream returned ${upstream.status}`);
      }

      const contentType = (upstream.headers.get("content-type") || "").toLowerCase();
      if (!contentType.includes("text/html") && !contentType.includes("application/xhtml")) {
        unsupportedMedia("Upstream content is not HTML");
      }

      const finalUrl = upstream.url || target.toString();
      let html = await upstream.text();
      if (html.length > 1_500_000) html = html.slice(0, 1_500_000);

      const safeHtml = stripExecutableHtml(html);
      const titleMatch = safeHtml.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
      const title = titleMatch ? titleMatch[1].replace(/\s+/g, " ").trim() : "";

      const framedHtml = [
        "<!doctype html><html><head>",
        `<base href=\"${finalUrl.replace(/\"/g, "&quot;")}\">`,
        '<meta charset="utf-8"/>',
        '<meta name="viewport" content="width=device-width, initial-scale=1"/>',
        "<style>html,body{margin:0;padding:0;background:#fff;color:#111;font-family:Roboto,Arial,sans-serif}img,video,iframe{max-width:100%;height:auto}body{padding:10px}</style>",
        "</head><body>",
        safeHtml,
        "</body></html>"
      ].join("");

      return c.json({ url: target.toString(), finalUrl, title, html: framedHtml });
    } catch (err) {
      badGateway(err instanceof Error ? err.message : String(err));
    } finally {
      clearTimeout(timeout);
    }
  });

  app.get("/api/media/:key{.+}", async (c) => {
    const rawKey = c.req.param("key") || "";
    let key = "";
    try {
      key = decodeURIComponent(rawKey);
    } catch {
      badRequest("Invalid object key");
    }
    if (!/^[a-zA-Z0-9/_\-.]+$/.test(key) || key.includes("..")) {
      badRequest("Invalid object key");
    }

    let obj = await c.env.ky_news_media.get(key);
    if (!obj) {
      const keyMatch = key.match(/^news\/([a-f0-9]{24})\.[a-z0-9]+$/i);
      if (keyMatch) {
        const mapped = await d1First<{ r2_key: string }>(
          c.env.ky_news_db,
          "SELECT r2_key FROM item_media WHERE item_id=? LIMIT 1",
          [keyMatch[1]]
        );
        if (mapped?.r2_key && mapped.r2_key !== key) {
          return c.redirect(`/api/media/${encodeURIComponent(mapped.r2_key)}`, 302);
        }
      }
      notFound("Media not found");
    }

    const headers = new Headers();
    obj.writeHttpMetadata(headers);
    headers.set("etag", obj.httpEtag);
    if (!headers.has("cache-control")) {
      headers.set("cache-control", "public, max-age=2592000, immutable");
    }

    if (c.req.method === "HEAD") {
      return new Response(null, { headers });
    }
    return new Response(obj.body, { headers });
  });
}

```

# ky-news-worker\src\routes\weather.ts

```ts
import { Hono } from "hono";
import { z } from "zod";
import type { AppBindings } from "../types";
import { badRequest } from "../lib/errors";
import { getWeatherAlerts, getWeatherForecast } from "../services/weather";

const WeatherForecastQuery = z.object({
  state: z.string().length(2).default("KY"),
  county: z.string().min(2).max(80)
});

const WeatherAlertsQuery = z.object({
  state: z.string().length(2).default("KY"),
  county: z.string().min(2).max(80).optional()
});

function queryInput(c: any): Record<string, unknown> {
  const params = new URL(c.req.url).searchParams;
  return Object.fromEntries(params.entries());
}

export function registerWeatherRoutes(app: Hono<AppBindings>): void {
  app.get("/api/weather/forecast", async (c) => {
    const parsed = WeatherForecastQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const out = await getWeatherForecast(c.env, {
      state: parsed.data.state,
      county: parsed.data.county
    });
    c.header("Cache-Control", "public, max-age=120, s-maxage=300, stale-while-revalidate=300");
    return c.json(out);
  });

  app.get("/api/weather/alerts", async (c) => {
    const parsed = WeatherAlertsQuery.safeParse(queryInput(c));
    if (!parsed.success) badRequest("Invalid query");

    const out = await getWeatherAlerts(c.env, {
      state: parsed.data.state,
      county: parsed.data.county
    });
    c.header("Cache-Control", "public, max-age=60, s-maxage=120, stale-while-revalidate=180");
    return c.json(out);
  });
}

```

# ky-news-worker\src\services\apiCache.ts

```ts
import type { AppContext } from "../types";
import { sha256Hex } from "../lib/crypto";

type CachedEnvelope = {
  etag: string;
  payload: string;
  cachedAt: string;
};

function isCacheBypass(c: AppContext): boolean {
  if (c.req.method !== "GET") return true;
  if (c.req.header("x-admin-token")) return true;
  if (c.req.header("cf-access-authenticated-user-email")) return true;
  return false;
}

function makeCacheKey(url: URL): string {
  const sorted = [...url.searchParams.entries()]
    .sort(([ak, av], [bk, bv]) => (ak === bk ? av.localeCompare(bv) : ak.localeCompare(bk)))
    .map(([k, v]) => `${k}=${v}`)
    .join("&");

  return `api-cache:v2:${url.pathname}?${sorted}`;
}

function setSharedHeaders(c: AppContext, etag: string, ttlSeconds: number, staleSeconds: number): void {
  c.header("etag", etag);
  c.header("cache-control", `public, max-age=${Math.min(ttlSeconds, 60)}, s-maxage=${ttlSeconds}, stale-while-revalidate=${staleSeconds}`);
}

export async function respondCachedJson(
  c: AppContext,
  options: {
    ttlSeconds: number;
    staleSeconds?: number;
    cacheKey?: string;
    producer: () => Promise<Record<string, unknown>>;
  }
): Promise<Response> {
  const staleSeconds = options.staleSeconds ?? Math.max(60, Math.floor(options.ttlSeconds / 2));
  const url = new URL(c.req.url);
  const cacheKey = options.cacheKey || makeCacheKey(url);
  const bypass = isCacheBypass(c);

  if (!bypass) {
    const existingRaw = await c.env.CACHE.get(cacheKey);
    if (existingRaw) {
      try {
        const existing = JSON.parse(existingRaw) as CachedEnvelope;
        const ifNoneMatch = c.req.header("if-none-match");
        if (ifNoneMatch && ifNoneMatch === existing.etag) {
          setSharedHeaders(c, existing.etag, options.ttlSeconds, staleSeconds);
          return c.body(null, 304);
        }

        setSharedHeaders(c, existing.etag, options.ttlSeconds, staleSeconds);
        c.header("x-cache", "HIT");
        return c.json(JSON.parse(existing.payload));
      } catch {
        // fall through to regenerate
      }
    }
  }

  const data = await options.producer();
  const payload = JSON.stringify(data);
  const etag = `"${(await sha256Hex(payload)).slice(0, 32)}"`;

  setSharedHeaders(c, etag, options.ttlSeconds, staleSeconds);
  c.header("x-cache", "MISS");

  if (!bypass) {
    const env: CachedEnvelope = { etag, payload, cachedAt: new Date().toISOString() };
    await c.env.CACHE.put(cacheKey, JSON.stringify(env), {
      expirationTtl: Math.max(options.ttlSeconds + staleSeconds, options.ttlSeconds + 60)
    });
  }

  return c.body(payload, 200, { "content-type": "application/json; charset=utf-8" });
}

```

# ky-news-worker\src\services\article.ts

```ts
import { Readability } from "@mozilla/readability";
import { parseHTML } from "linkedom";
import { decodeHtmlEntities, normalizeWhitespace, toHttpsUrl } from "../lib/text";

export interface ArticleFetchResult {
  status: string;
  text: string;
  ogImage: string | null;
  publishedAt: string | null;
}

const ARTICLE_TIMEOUT_MS = 12_000;
const ARTICLE_MAX_CHARS = 2_000_000;
const EXCERPT_MAX_CHARS = 10_000;

function firstMatch(html: string, re: RegExp): string | null {
  const match = html.match(re);
  const value = match?.[1]?.trim();
  return value || null;
}

function pickOgImage(html: string): string | null {
  const fromOg = firstMatch(html, /<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["'][^>]*>/i);
  const ogUrl = toHttpsUrl(fromOg);
  if (ogUrl) return ogUrl;

  const fromOgName = firstMatch(html, /<meta[^>]+name=["']og:image["'][^>]+content=["']([^"']+)["'][^>]*>/i);
  const ogNameUrl = toHttpsUrl(fromOgName);
  if (ogNameUrl) return ogNameUrl;

  const fromTw = firstMatch(html, /<meta[^>]+property=["']twitter:image["'][^>]+content=["']([^"']+)["'][^>]*>/i);
  const twUrl = toHttpsUrl(fromTw);
  if (twUrl) return twUrl;

  const fromTwName = firstMatch(html, /<meta[^>]+name=["']twitter:image["'][^>]+content=["']([^"']+)["'][^>]*>/i);
  const twNameUrl = toHttpsUrl(fromTwName);
  if (twNameUrl) return twNameUrl;

  return null;
}

function pickInlineImage(html: string, pageUrl: string): string | null {
  const imgRegex = /<img[^>]+(?:src|data-src|data-lazy-src|data-original)=["']([^"']+)["'][^>]*>/gi;
  let match: RegExpExecArray | null = null;

  while ((match = imgRegex.exec(html))) {
    const src = String(match[1] || "").trim();
    if (!src || src.startsWith("data:")) continue;
    if (/\b(sprite|logo|icon|avatar)\b/i.test(src)) continue;

    try {
      const abs = new URL(src, pageUrl).toString();
      const https = toHttpsUrl(abs);
      if (https) return https;
    } catch {
      // continue
    }
  }

  return null;
}

function toIsoOrNull(input: string | null | undefined): string | null {
  if (!input) return null;
  const dt = new Date(input);
  if (Number.isNaN(dt.getTime())) return null;
  return dt.toISOString();
}

function pickPublishedAt(html: string): string | null {
  const fields = [
    /<meta[^>]+property=["']article:published_time["'][^>]+content=["']([^"']+)["'][^>]*>/i,
    /<meta[^>]+name=["']article:published_time["'][^>]+content=["']([^"']+)["'][^>]*>/i,
    /<meta[^>]+property=["']og:article:published_time["'][^>]+content=["']([^"']+)["'][^>]*>/i,
    /<meta[^>]+name=["']parsely-pub-date["'][^>]+content=["']([^"']+)["'][^>]*>/i,
    /<meta[^>]+itemprop=["']datePublished["'][^>]+content=["']([^"']+)["'][^>]*>/i,
    /<time[^>]+datetime=["']([^"']+)["'][^>]*>/i
  ];
  for (const pattern of fields) {
    const value = firstMatch(html, pattern);
    const iso = toIsoOrNull(value);
    if (iso) return iso;
  }
  return null;
}

function extractReadableText(html: string): string {
  try {
    const { document } = parseHTML(html);
    const reader = new Readability(document);
    const article = reader.parse();
    const cleanText = normalizeWhitespace(
      decodeHtmlEntities([article?.title, article?.textContent].filter(Boolean).join(" "))
    );
    if (!cleanText) return "";
    return cleanText.length > EXCERPT_MAX_CHARS ? cleanText.slice(0, EXCERPT_MAX_CHARS) : cleanText;
  } catch {
    return "";
  }
}

export async function fetchArticle(url: string): Promise<ArticleFetchResult> {
  if (!url || !/^https?:\/\//i.test(url)) {
    return { status: "skip", text: "", ogImage: null, publishedAt: null };
  }

  const ctrl = new AbortController();
  const timeout = setTimeout(() => ctrl.abort(), ARTICLE_TIMEOUT_MS);

  try {
    const res = await fetch(url, {
      redirect: "follow",
      signal: ctrl.signal,
      headers: {
        "user-agent": "Mozilla/5.0 (compatible; EKY-News-Worker/1.0)",
        accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
      }
    });

    if (res.status < 200 || res.status >= 300) {
      return { status: `http_${res.status}`, text: "", ogImage: null, publishedAt: null };
    }

    const contentType = (res.headers.get("content-type") || "").toLowerCase();
    if (!contentType.includes("text/html") && !contentType.includes("application/xhtml")) {
      return { status: "non_html", text: "", ogImage: null, publishedAt: null };
    }

    let html = await res.text();
    if (html.length > ARTICLE_MAX_CHARS) html = html.slice(0, ARTICLE_MAX_CHARS);

    const ogImage = pickOgImage(html) || pickInlineImage(html, url);
    const publishedAt = pickPublishedAt(html);
    const text = extractReadableText(html);
    return { status: "ok", text, ogImage, publishedAt };
  } catch {
    return { status: "error", text: "", ogImage: null, publishedAt: null };
  } finally {
    clearTimeout(timeout);
  }
}

```

# ky-news-worker\src\services\db.ts

```ts
export async function d1All<T = Record<string, unknown>>(
  db: D1Database,
  sql: string,
  binds: unknown[] = []
): Promise<T[]> {
  const res = await db.prepare(sql).bind(...binds).all<T>();
  return (res.results || []) as T[];
}

export async function d1First<T = Record<string, unknown>>(
  db: D1Database,
  sql: string,
  binds: unknown[] = []
): Promise<T | null> {
  const row = await db.prepare(sql).bind(...binds).first<T>();
  return row || null;
}

export async function d1Run(db: D1Database, sql: string, binds: unknown[] = []): Promise<D1Result> {
  return db.prepare(sql).bind(...binds).run();
}

export async function d1ExecMany(db: D1Database, statements: Array<{ sql: string; binds?: unknown[] }>): Promise<void> {
  if (!statements.length) return;
  await db.batch(statements.map((s) => db.prepare(s.sql).bind(...(s.binds || []))));
}

export async function tableHasColumn(db: D1Database, table: string, column: string): Promise<boolean> {
  const rows = await d1All<{ name: string }>(db, `PRAGMA table_info(${table})`);
  return rows.some((r) => r.name === column);
}

```

# ky-news-worker\src\services\location.ts

```ts
import kyCounties from "../data/ky-counties.json";
import kyCityCounty from "../data/ky-city-county.json";

function norm(s: string): string {
  return String(s || "")
    .toLowerCase()
    .replace(/&amp;/g, "&")
    .replace(/[^a-z0-9]+/g, " ")
    .trim();
}

const KY_COUNTY_PATTERNS = (() => {
  const names = (kyCounties as Array<{ name: string }>).map((c) => c.name).filter(Boolean);
  names.sort((a, b) => b.length - a.length);

  return names.map((name) => {
    const n = norm(name);
    const re = new RegExp(`\\b${n.replace(/\s+/g, "\\s+")}\\s+(county|co\\.?)(\\b|\\s|,|\\.)`, "i");
    return { name, re };
  });
})();

const KY_CITY_PATTERNS = (() => {
  const rows = Array.isArray(kyCityCounty) ? (kyCityCounty as Array<{ city: string; county: string }>) : [];
  const cities = rows
    .map((r) => ({ city: String(r.city || "").trim(), county: String(r.county || "").trim() }))
    .filter((r) => r.city && r.county);

  cities.sort((a, b) => b.city.length - a.city.length);

  return cities.map(({ city, county }) => {
    const n = norm(city);
    const re = new RegExp(`\\b${n.replace(/\s+/g, "\\s+")}\\b`, "i");
    return { city, county, re };
  });
})();

const KY_QUERY_COUNTY_PATTERNS = (() => {
  const names = (kyCounties as Array<{ name: string }>).map((c) => c.name).filter(Boolean);
  names.sort((a, b) => b.length - a.length);
  return names.map((name) => {
    const n = norm(name);
    const re = new RegExp(`\\b${n.replace(/\s+/g, "\\s+")}(?:\\s+(?:county|co\\.?))?\\b`, "i");
    return { name, re };
  });
})();

const OTHER_STATE_NAME_PATTERNS = [
  "Alabama",
  "Alaska",
  "Arizona",
  "Arkansas",
  "California",
  "Colorado",
  "Connecticut",
  "Delaware",
  "Florida",
  "Georgia",
  "Hawaii",
  "Idaho",
  "Illinois",
  "Indiana",
  "Iowa",
  "Kansas",
  "Louisiana",
  "Maine",
  "Maryland",
  "Massachusetts",
  "Michigan",
  "Minnesota",
  "Mississippi",
  "Missouri",
  "Montana",
  "Nebraska",
  "Nevada",
  "New Hampshire",
  "New Jersey",
  "New Mexico",
  "New York",
  "North Carolina",
  "North Dakota",
  "Ohio",
  "Oklahoma",
  "Oregon",
  "Pennsylvania",
  "Rhode Island",
  "South Carolina",
  "South Dakota",
  "Tennessee",
  "Texas",
  "Utah",
  "Vermont",
  "Virginia",
  "Washington",
  "West Virginia",
  "Wisconsin",
  "Wyoming",
  "District of Columbia"
].map((name) => ({ name, re: new RegExp(`\\b${norm(name).replace(/\s+/g, "\\s+")}\\b`, "i") }));

export function detectOtherStateNames(text: string): string[] {
  const t = norm(text);
  if (!t) return [];
  const out: string[] = [];
  for (const { name, re } of OTHER_STATE_NAME_PATTERNS) {
    if (re.test(t)) out.push(name);
  }
  return Array.from(new Set(out));
}

export function detectKyCounties(text: string, opts: { includeCityHints?: boolean } = {}): string[] {
  const t = norm(text);
  if (!t) return [];

  const includeCityHints = opts.includeCityHints !== false;
  const out: string[] = [];
  const raw = String(text || "");
  const hasKyContext = /\bkentucky\b/i.test(raw) || /\bky\b/i.test(raw);

  for (const { name, re } of KY_COUNTY_PATTERNS) {
    if (re.test(t)) out.push(name);
  }

  if (includeCityHints && hasKyContext) {
    for (const { county, re } of KY_CITY_PATTERNS) {
      if (re.test(t)) out.push(county);
    }
  }

  return Array.from(new Set(out));
}

/**
 * Returns counties inferred solely from KY city-name matches in the text.
 * Requires explicit KY context ("Kentucky" or "KY") to avoid false positives.
 * Used for body-text tagging where city mentions should map directly to counties.
 */
export function detectKyCountiesFromCityHints(text: string): string[] {
  const raw = String(text || "");
  const hasKyContext = /\bkentucky\b/i.test(raw) || /\bky\b/i.test(raw);
  if (!hasKyContext) return [];

  const t = norm(raw);
  if (!t) return [];

  const out: string[] = [];
  for (const { county, re } of KY_CITY_PATTERNS) {
    if (re.test(t)) out.push(county);
  }
  return Array.from(new Set(out));
}

export function hasKySignal(text: string, counties: string[]): boolean {
  if (counties.length) return true;
  const raw = String(text || "");
  return /\bkentucky\b/i.test(raw) || /\bky\b/i.test(raw);
}

export function detectKyQueryCounties(text: string): string[] {
  const t = norm(text);
  if (!t) return [];

  const out: string[] = [];
  for (const { name, re } of KY_QUERY_COUNTY_PATTERNS) {
    if (re.test(t)) out.push(name);
  }

  for (const { city, county, re } of KY_CITY_PATTERNS) {
    // City name lookup for search should not require explicit KY context.
    if (city.length < 4) continue;
    if (re.test(t)) out.push(county);
  }

  return Array.from(new Set(out));
}

```

# ky-news-worker\src\services\media.ts

```ts
import { d1First, d1Run } from "./db";
import { badRequest } from "../lib/errors";
import { logWarn } from "../lib/logger";
import { toHttpsUrl } from "../lib/text";
import type { Env } from "../types";

const IMAGE_TIMEOUT_MS = 12_000;
const IMAGE_MAX_BYTES = 10 * 1024 * 1024;

function extFromContentType(contentType: string): string {
  const ct = contentType.toLowerCase();
  if (ct.includes("image/jpeg") || ct.includes("image/jpg")) return "jpg";
  if (ct.includes("image/png")) return "png";
  if (ct.includes("image/webp")) return "webp";
  if (ct.includes("image/gif")) return "gif";
  if (ct.includes("image/avif")) return "avif";
  return "bin";
}

function extFromUrl(url: string): string {
  const lower = url.toLowerCase();
  if (lower.includes(".jpg") || lower.includes(".jpeg")) return "jpg";
  if (lower.includes(".png")) return "png";
  if (lower.includes(".webp")) return "webp";
  if (lower.includes(".gif")) return "gif";
  if (lower.includes(".avif")) return "avif";
  return "jpg";
}

export function toMediaPath(key: string): string {
  return `/api/media/${encodeURIComponent(key)}`;
}

export async function mirrorArticleImageToR2(
  env: Env,
  input: { itemId: string; sourceUrl: string | null | undefined }
): Promise<string | null> {
  const sourceUrl = toHttpsUrl(input.sourceUrl);
  if (!sourceUrl) return null;

  const existing = await d1First<{ source_url: string; r2_key: string }>(
    env.ky_news_db,
    "SELECT source_url, r2_key FROM item_media WHERE item_id=? LIMIT 1",
    [input.itemId]
  );
  if (existing?.r2_key && existing.source_url === sourceUrl) {
    return toMediaPath(existing.r2_key);
  }

  const ctrl = new AbortController();
  const timeout = setTimeout(() => ctrl.abort(), IMAGE_TIMEOUT_MS);

  try {
    const res = await fetch(sourceUrl, {
      signal: ctrl.signal,
      redirect: "follow",
      headers: {
        "user-agent": "Mozilla/5.0 (compatible; EKY-News-Worker/1.0)",
        accept: "image/avif,image/webp,image/apng,image/*,*/*;q=0.8"
      }
    });

    if (!res.ok) return null;

    const contentType = (res.headers.get("content-type") || "").toLowerCase();
    if (!contentType.startsWith("image/")) return null;

    const bytes = new Uint8Array(await res.arrayBuffer());
    if (!bytes.length || bytes.length > IMAGE_MAX_BYTES) return null;

    const ext = extFromContentType(contentType) || extFromUrl(sourceUrl);
    const key = `news/${input.itemId}.${ext}`;

    await env.ky_news_media.put(key, bytes, {
      httpMetadata: {
        contentType,
        cacheControl: "public, max-age=2592000, immutable"
      },
      customMetadata: {
        item_id: input.itemId,
        source_url: sourceUrl
      }
    });

    await d1Run(
      env.ky_news_db,
      `INSERT INTO item_media (item_id, source_url, r2_key, content_type, bytes, updated_at)
       VALUES (?, ?, ?, ?, ?, datetime('now'))
       ON CONFLICT(item_id) DO UPDATE SET
         source_url=excluded.source_url,
         r2_key=excluded.r2_key,
         content_type=excluded.content_type,
         bytes=excluded.bytes,
         updated_at=excluded.updated_at`,
      [input.itemId, sourceUrl, key, contentType, bytes.length]
    );

    await d1Run(env.ky_news_db, "UPDATE items SET image_url=? WHERE id=?", [toMediaPath(key), input.itemId]);

    return toMediaPath(key);
  } catch (err) {
    logWarn("media.mirror.failed", {
      itemId: input.itemId,
      sourceUrl,
      error: err instanceof Error ? err.message : String(err)
    });
    return null;
  } finally {
    clearTimeout(timeout);
  }
}

export function assertSafeObjectKey(rawKey: string): string {
  const key = decodeURIComponent(String(rawKey || ""));
  if (!/^[a-zA-Z0-9/_\-.]+$/.test(key) || key.includes("..")) {
    badRequest("Invalid object key");
  }
  return key;
}

```

# ky-news-worker\src\services\observability.ts

```ts
import { randomUUID } from "node:crypto";
import type { Env } from "../types";
import { d1Run } from "./db";

export type LogLevel = "info" | "warn" | "error";

export type StructuredLog = {
  level: LogLevel;
  event: string;
  ts: string;
  requestId?: string;
  route?: string;
  method?: string;
  status?: number;
  actorEmail?: string;
  data?: Record<string, unknown>;
};

function dayStamp(ts: string): string {
  return ts.slice(0, 10);
}

function logTtlSeconds(env: Env): number {
  const configured = Number(env.LOG_TTL_SECONDS || "1209600");
  return Number.isFinite(configured) && configured > 0 ? configured : 14 * 24 * 60 * 60;
}

function metricTtlSeconds(): number {
  return 60 * 24 * 60 * 60;
}

function makeLogKey(event: string, ts: string): string {
  return `log:v1:${dayStamp(ts)}:${event}:${Date.now()}:${randomUUID()}`;
}

export async function writeStructuredLog(env: Env, log: StructuredLog): Promise<void> {
  const key = makeLogKey(log.event, log.ts);
  await env.CACHE.put(key, JSON.stringify(log), { expirationTtl: logTtlSeconds(env) });
}

export async function recordErrorEvent(
  env: Env,
  input: {
    requestId?: string;
    route?: string;
    method?: string;
    statusCode?: number;
    actorEmail?: string;
    errorMessage: string;
    errorStack?: string;
    meta?: Record<string, unknown>;
  }
): Promise<void> {
  const retentionDaysRaw = Number(env.ERROR_EVENT_TTL_DAYS || "30");
  const retentionDays = Number.isFinite(retentionDaysRaw) && retentionDaysRaw > 0 ? retentionDaysRaw : 30;

  await d1Run(
    env.ky_news_db,
    `
    INSERT INTO app_error_events (
      id, request_id, route, method, status_code, actor_email, error_message, error_stack, meta_json, created_at, expires_at
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'), datetime('now', ?))
    `,
    [
      randomUUID(),
      input.requestId || null,
      input.route || null,
      input.method || null,
      input.statusCode || null,
      input.actorEmail || null,
      input.errorMessage.slice(0, 4000),
      input.errorStack ? input.errorStack.slice(0, 12_000) : null,
      input.meta ? JSON.stringify(input.meta) : null,
      `+${retentionDays} days`
    ]
  );

  await writeStructuredLog(env, {
    level: "error",
    event: "app.error",
    ts: new Date().toISOString(),
    requestId: input.requestId,
    route: input.route,
    method: input.method,
    status: input.statusCode,
    actorEmail: input.actorEmail,
    data: {
      message: input.errorMessage,
      stack: input.errorStack,
      ...(input.meta || {})
    }
  });
}

export async function incrementDailyMetric(
  env: Env,
  metric: string,
  delta = 1,
  day = new Date().toISOString().slice(0, 10)
): Promise<number> {
  const key = `metric:v1:${day}:${metric}`;
  const currentRaw = await env.CACHE.get(key);
  const current = Number(currentRaw);
  const next = (Number.isFinite(current) ? current : 0) + delta;
  await env.CACHE.put(key, String(next), { expirationTtl: metricTtlSeconds() });
  return next;
}

export async function incrementMetricGroup(
  env: Env,
  group: string,
  fields: Record<string, number>,
  day = new Date().toISOString().slice(0, 10)
): Promise<void> {
  const entries = Object.entries(fields);
  await Promise.all(entries.map(([field, delta]) => incrementDailyMetric(env, `${group}.${field}`, delta, day)));
}

export async function purgeExpiredErrorEvents(env: Env): Promise<void> {
  await d1Run(env.ky_news_db, "DELETE FROM app_error_events WHERE expires_at IS NOT NULL AND datetime(expires_at) < datetime('now')");
}

```

# ky-news-worker\src\services\relevance.ts

```ts
type RelevanceTier = "tier1_title" | "tier2_body";
type FailureTier = "tier2_body" | "tier3_ambiguous_city";

export type KentuckyRelevanceResult = {
  relevant: boolean;
  matchedTier: RelevanceTier | null;
  failedTier: FailureTier | null;
  bodyMentions: number;
};

const AMBIGUOUS_CITY_TERMS = ["Lexington", "Louisville", "Georgetown", "Franklin", "Winchester"] as const;

const KY_CITY_REGION_TERMS = [
  "Lexington",
  "Louisville",
  "Frankfort",
  "Bowling Green",
  "Owensboro",
  "Covington",
  "Pikeville",
  "Paducah",
  "Ashland",
  "Elizabethtown",
  "Hopkinsville",
  "Richmond",
  "Florence",
  "Georgetown",
  "Nicholasville",
  "Jeffersontown",
  "Radcliff",
  "Madisonville",
  "Winchester",
  "Erlanger",
  "Franklin",
  "Eastern Kentucky",
  "Western Kentucky",
  "Central Kentucky",
  "Appalachian Kentucky"
] as const;

const EXPLICIT_KY_TERMS = ["Kentucky", "KY"] as const;

const AMBIGUOUS_SET = new Set<string>(AMBIGUOUS_CITY_TERMS.map((term) => term.toLowerCase()));
const NON_AMBIGUOUS_TERMS = KY_CITY_REGION_TERMS.filter((term) => !AMBIGUOUS_SET.has(term.toLowerCase()));

function escapeRegex(input: string): string {
  return input.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function termPattern(term: string): string {
  return `\\b${escapeRegex(term).replace(/\s+/g, "\\s+")}\\b`;
}

function combinedRegex(terms: readonly string[]): RegExp | null {
  if (!terms.length) return null;
  const sorted = [...terms].sort((a, b) => b.length - a.length);
  return new RegExp(`(?:${sorted.map(termPattern).join("|")})`, "gi");
}

const TITLE_EXPLICIT_KY_RE = combinedRegex(EXPLICIT_KY_TERMS) as RegExp;
const TITLE_NON_AMBIGUOUS_RE = combinedRegex(NON_AMBIGUOUS_TERMS) as RegExp;
const TITLE_AMBIGUOUS_RE = combinedRegex(AMBIGUOUS_CITY_TERMS) as RegExp;
const BODY_BASE_TERMS_RE = combinedRegex([...EXPLICIT_KY_TERMS, ...NON_AMBIGUOUS_TERMS]) as RegExp;
const BODY_WITH_AMBIGUOUS_TERMS_RE = combinedRegex([
  ...EXPLICIT_KY_TERMS,
  ...NON_AMBIGUOUS_TERMS,
  ...AMBIGUOUS_CITY_TERMS
]) as RegExp;
const ANY_AMBIGUOUS_RE = combinedRegex(AMBIGUOUS_CITY_TERMS) as RegExp;

function hasMatch(input: string, re: RegExp): boolean {
  re.lastIndex = 0;
  return re.test(input);
}

function countMentions(input: string, re: RegExp): number {
  re.lastIndex = 0;
  const matches = input.match(re);
  return matches ? matches.length : 0;
}

export function isKentuckyRelevant(title: string, bodyText: string): KentuckyRelevanceResult {
  const titleText = String(title || "");
  const body = String(bodyText || "");
  const articleText = `${titleText}\n${body}`;

  const hasArticleKySignal = hasMatch(articleText, TITLE_EXPLICIT_KY_RE);
  const titleHasExplicitKy = hasMatch(titleText, TITLE_EXPLICIT_KY_RE);
  const titleHasUnambiguousTerm = hasMatch(titleText, TITLE_NON_AMBIGUOUS_RE);
  const titleHasAmbiguousTerm = hasMatch(titleText, TITLE_AMBIGUOUS_RE);

  const titleStrongMatch =
    titleHasExplicitKy ||
    titleHasUnambiguousTerm ||
    (titleHasAmbiguousTerm && hasArticleKySignal);

  if (titleStrongMatch) {
    return {
      relevant: true,
      matchedTier: "tier1_title",
      failedTier: null,
      bodyMentions: 0
    };
  }

  const bodyMentions = countMentions(
    body,
    hasArticleKySignal ? BODY_WITH_AMBIGUOUS_TERMS_RE : BODY_BASE_TERMS_RE
  );

  if (bodyMentions >= 2) {
    return {
      relevant: true,
      matchedTier: "tier2_body",
      failedTier: null,
      bodyMentions
    };
  }

  const hasAmbiguousWithoutKy = !hasArticleKySignal && hasMatch(articleText, ANY_AMBIGUOUS_RE);

  return {
    relevant: false,
    matchedTier: null,
    failedTier: hasAmbiguousWithoutKy ? "tier3_ambiguous_city" : "tier2_body",
    bodyMentions
  };
}

```

# ky-news-worker\src\services\rss.ts

```ts
import { XMLParser } from "fast-xml-parser";
import { toHttpsUrl } from "../lib/text";

export interface ParsedFeedItem {
  title: string;
  link: string;
  guid: string | null;
  isoDate: string | null;
  pubDate: string | null;
  contentSnippet: string | null;
  content: string | null;
  author: string | null;
  imageUrl: string | null;
}

const parser = new XMLParser({
  ignoreAttributes: false,
  attributeNamePrefix: "",
  parseTagValue: false,
  trimValues: true,
  processEntities: true,
  removeNSPrefix: false
});

function toArray<T>(value: T | T[] | null | undefined): T[] {
  if (value == null) return [];
  return Array.isArray(value) ? value : [value];
}

function textOf(value: unknown): string {
  if (value == null) return "";
  if (typeof value === "string") return value;
  if (typeof value === "number" || typeof value === "boolean") return String(value);
  if (typeof value === "object") {
    const obj = value as Record<string, unknown>;
    if (typeof obj["#text"] === "string") return obj["#text"] as string;
    if (typeof obj["__cdata"] === "string") return obj["__cdata"] as string;
    if (typeof obj.href === "string") return obj.href;
    if (typeof obj.url === "string") return obj.url;
  }
  return "";
}

function pickLink(link: unknown): string {
  if (!link) return "";
  if (typeof link === "string") return link;
  if (Array.isArray(link)) {
    const alt = link.find((x) => String((x as any)?.rel || "alternate") === "alternate");
    const candidate = alt || link[0];
    if (candidate && typeof candidate === "object") {
      return textOf((candidate as any).href || (candidate as any).url || (candidate as any)["#text"] || "");
    }
    return textOf(candidate);
  }
  if (typeof link === "object") {
    return textOf((link as any).href || (link as any).url || (link as any)["#text"] || "");
  }
  return "";
}

function extractImageFromHtml(html: string): string | null {
  if (!html) return null;
  const match = html.match(/<img[^>]+src=["']([^"']+)["']/i);
  const src = match?.[1]?.trim();
  if (!src) return null;
  return toHttpsUrl(src);
}

function stripHtml(html: string): string {
  return html
    .replace(/<script[\s\S]*?<\/script>/gi, " ")
    .replace(/<style[\s\S]*?<\/style>/gi, " ")
    .replace(/<[^>]+>/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function normalizeDate(value: string | null): string | null {
  if (!value) return null;
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return null;
  return d.toISOString();
}

function pickDate(values: Array<string | null | undefined>): { iso: string | null; raw: string | null } {
  for (const value of values) {
    const raw = String(value || "").trim();
    if (!raw) continue;
    const iso = normalizeDate(raw);
    if (iso) return { iso, raw };
  }
  return { iso: null, raw: null };
}

function pickImage(item: Record<string, unknown>): string | null {
  const enclosures = toArray(item.enclosure as Record<string, unknown> | Array<Record<string, unknown>> | undefined);
  for (const enclosure of enclosures) {
    const mediaUrl = toHttpsUrl(String(enclosure?.url || ""));
    if (mediaUrl) return mediaUrl;
  }

  const mediaContent = item["media:content"] as Record<string, unknown> | Array<Record<string, unknown>> | undefined;
  for (const media of toArray(mediaContent)) {
    const mediaUrl = toHttpsUrl(String(media?.url || ""));
    if (mediaUrl) return mediaUrl;
  }

  const mediaThumb = item["media:thumbnail"] as Record<string, unknown> | Array<Record<string, unknown>> | undefined;
  for (const media of toArray(mediaThumb)) {
    const mediaUrl = toHttpsUrl(String(media?.url || ""));
    if (mediaUrl) return mediaUrl;
  }

  const itunes = item["itunes:image"] as Record<string, unknown> | undefined;
  const itunesUrl = toHttpsUrl(String(itunes?.href || ""));
  if (itunesUrl) return itunesUrl;

  const content = textOf(item["content:encoded"] || item.content || item.description || "");
  return extractImageFromHtml(content);
}

function mapRssItem(item: Record<string, unknown>): ParsedFeedItem {
  const content = textOf(item["content:encoded"] || item.content || item.description || "") || null;
  const snippet = textOf(item.description || item.summary || item.contentSnippet || "") || null;
  const date = pickDate([
    textOf(item.isoDate),
    textOf(item.pubDate),
    textOf(item["dc:date"]),
    textOf(item.published),
    textOf(item.updated),
    textOf(item.date)
  ]);

  return {
    title: textOf(item.title) || "(untitled)",
    link: pickLink(item.link || item.guid),
    guid: textOf(item.guid) || null,
    isoDate: date.iso,
    pubDate: date.raw,
    contentSnippet: snippet ? stripHtml(snippet).slice(0, 2000) : null,
    content: content ? content.slice(0, 50_000) : null,
    author: textOf(item["dc:creator"] || item.creator || item.author) || null,
    imageUrl: pickImage(item)
  };
}

function mapAtomItem(entry: Record<string, unknown>): ParsedFeedItem {
  const content = textOf(entry.content || "") || null;
  const summary = textOf(entry.summary || "") || null;
  const date = pickDate([
    textOf(entry.updated),
    textOf(entry.published),
    textOf(entry["dc:date"]),
    textOf(entry.date)
  ]);

  return {
    title: textOf(entry.title) || "(untitled)",
    link: pickLink(entry.link || entry.id),
    guid: textOf(entry.id) || null,
    isoDate: date.iso,
    pubDate: date.raw,
    contentSnippet: summary ? stripHtml(summary).slice(0, 2000) : null,
    content: content ? content.slice(0, 50_000) : summary,
    author: textOf((entry.author as any)?.name || entry.author) || null,
    imageUrl: pickImage(entry)
  };
}

export function parseFeedItems(xml: string): ParsedFeedItem[] {
  const doc = parser.parse(xml) as Record<string, unknown>;

  const rssItems = toArray((doc.rss as any)?.channel?.item);
  if (rssItems.length) {
    return rssItems
      .map((item) => mapRssItem(item as Record<string, unknown>))
      .filter((item) => item.link || item.guid || item.title);
  }

  const atomEntries = toArray((doc.feed as any)?.entry);
  if (atomEntries.length) {
    return atomEntries
      .map((entry) => mapAtomItem(entry as Record<string, unknown>))
      .filter((item) => item.link || item.guid || item.title);
  }

  return [];
}

```

# ky-news-worker\src\services\schema.ts

```ts
import { d1ExecMany, d1Run, tableHasColumn } from "./db";
import { logError } from "../lib/logger";
import type { Env } from "../types";

let schemaReady: Promise<void> | null = null;

async function addColumnIfMissing(db: D1Database, table: string, column: string, sqlType: string): Promise<void> {
  const has = await tableHasColumn(db, table, column);
  if (has) return;
  await d1Run(db, `ALTER TABLE ${table} ADD COLUMN ${column} ${sqlType}`);
}

async function createCoreSchema(env: Env): Promise<void> {
  const db = env.ky_news_db;

  await d1ExecMany(db, [
    {
      sql: `CREATE TABLE IF NOT EXISTS feeds (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL,
        category TEXT NOT NULL,
        url TEXT NOT NULL,
        state_code TEXT NOT NULL DEFAULT 'KY',
        default_county TEXT,
        region_scope TEXT NOT NULL DEFAULT 'ky',
        fetch_mode TEXT NOT NULL DEFAULT 'rss',
        scraper_id TEXT,
        enabled INTEGER NOT NULL DEFAULT 1,
        etag TEXT,
        last_modified TEXT,
        last_checked_at TEXT,
        created_at TEXT NOT NULL DEFAULT (datetime('now'))
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS items (
        id TEXT PRIMARY KEY,
        title TEXT NOT NULL,
        url TEXT NOT NULL,
        guid TEXT,
        author TEXT,
        region_scope TEXT NOT NULL DEFAULT 'ky',
        published_at TEXT,
        summary TEXT,
        seo_description TEXT,
        content TEXT,
        image_url TEXT,
        fetched_at TEXT NOT NULL DEFAULT (datetime('now')),
        hash TEXT,
        article_checked_at TEXT,
        article_fetch_status TEXT,
        article_text_excerpt TEXT
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS feed_items (
        feed_id TEXT NOT NULL,
        item_id TEXT NOT NULL,
        PRIMARY KEY (feed_id, item_id),
        FOREIGN KEY (feed_id) REFERENCES feeds(id) ON DELETE CASCADE,
        FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS item_locations (
        item_id TEXT NOT NULL,
        state_code TEXT NOT NULL,
        county TEXT NOT NULL DEFAULT '',
        PRIMARY KEY (item_id, state_code, county),
        FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS fetch_runs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        started_at TEXT NOT NULL,
        finished_at TEXT,
        status TEXT NOT NULL,
        source TEXT,
        details_json TEXT
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS fetch_errors (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        feed_id TEXT,
        at TEXT NOT NULL,
        error TEXT NOT NULL
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS weather_forecasts (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        state_code TEXT NOT NULL,
        county TEXT NOT NULL,
        forecast_json TEXT NOT NULL,
        fetched_at TEXT NOT NULL DEFAULT (datetime('now')),
        expires_at TEXT NOT NULL
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS weather_alerts (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        alert_id TEXT NOT NULL,
        state_code TEXT NOT NULL,
        county TEXT NOT NULL,
        severity TEXT,
        event TEXT,
        headline TEXT,
        starts_at TEXT,
        ends_at TEXT,
        raw_json TEXT NOT NULL,
        fetched_at TEXT NOT NULL DEFAULT (datetime('now'))
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS lost_found_posts (
        id TEXT PRIMARY KEY,
        type TEXT NOT NULL CHECK (type IN ('lost', 'found')),
        title TEXT NOT NULL,
        description TEXT NOT NULL,
        county TEXT NOT NULL,
        state_code TEXT NOT NULL DEFAULT 'KY',
        contact_email_encrypted TEXT NOT NULL,
        show_contact INTEGER NOT NULL DEFAULT 0,
        status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
        submitted_at TEXT NOT NULL DEFAULT (datetime('now')),
        approved_at TEXT,
        rejected_at TEXT,
        is_resolved INTEGER NOT NULL DEFAULT 0,
        resolved_at TEXT,
        resolved_note TEXT,
        expires_at TEXT NOT NULL,
        moderation_note TEXT
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS lost_found_images (
        id TEXT PRIMARY KEY,
        post_id TEXT NOT NULL,
        r2_key TEXT NOT NULL,
        width INTEGER,
        height INTEGER,
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS lost_found_reports (
        id TEXT PRIMARY KEY,
        post_id TEXT NOT NULL,
        reason TEXT NOT NULL,
        reporter_ip_hash TEXT NOT NULL,
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS lost_found_comments (
        id TEXT PRIMARY KEY,
        post_id TEXT NOT NULL,
        commenter_name TEXT NOT NULL,
        commenter_email_encrypted TEXT NOT NULL,
        commenter_email_hash TEXT NOT NULL,
        comment_text TEXT NOT NULL,
        url_count INTEGER NOT NULL DEFAULT 0,
        commenter_ip_hash TEXT NOT NULL,
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS lost_found_comment_bans (
        id TEXT PRIMARY KEY,
        target_type TEXT NOT NULL CHECK (target_type IN ('email', 'ip')),
        target_hash TEXT NOT NULL,
        reason TEXT,
        banned_by_email TEXT NOT NULL,
        source_comment_id TEXT,
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        UNIQUE(target_type, target_hash),
        FOREIGN KEY (source_comment_id) REFERENCES lost_found_comments(id) ON DELETE SET NULL
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS admin_audit_log (
        id TEXT PRIMARY KEY,
        actor_email TEXT NOT NULL,
        action TEXT NOT NULL,
        entity_type TEXT NOT NULL,
        entity_id TEXT NOT NULL,
        payload_json TEXT,
        created_at TEXT NOT NULL DEFAULT (datetime('now'))
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS item_ai_summaries (
        item_id TEXT PRIMARY KEY,
        summary TEXT NOT NULL,
        seo_description TEXT,
        model TEXT,
        source_hash TEXT,
        generated_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS item_media (
        item_id TEXT PRIMARY KEY,
        source_url TEXT NOT NULL,
        r2_key TEXT NOT NULL,
        content_type TEXT,
        bytes INTEGER,
        updated_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS summary_review_queue (
        item_id TEXT PRIMARY KEY,
        status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'edited')),
        queue_reason TEXT,
        reviewer_email TEXT,
        reviewed_at TEXT,
        reviewed_summary TEXT,
        note TEXT,
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        updated_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS item_tag_corrections (
        id TEXT PRIMARY KEY,
        item_id TEXT NOT NULL,
        actor_email TEXT NOT NULL,
        previous_tags_json TEXT,
        new_tags_json TEXT NOT NULL,
        note TEXT,
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS feed_run_metrics (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        run_id INTEGER,
        feed_id TEXT NOT NULL,
        source TEXT,
        status TEXT NOT NULL,
        http_status INTEGER,
        duration_ms INTEGER,
        items_seen INTEGER NOT NULL DEFAULT 0,
        items_upserted INTEGER NOT NULL DEFAULT 0,
        error_message TEXT,
        checked_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (run_id) REFERENCES fetch_runs(id) ON DELETE SET NULL
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS ingestion_metrics (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        run_id INTEGER,
        source TEXT,
        status TEXT NOT NULL,
        feeds_processed INTEGER NOT NULL DEFAULT 0,
        feeds_updated INTEGER NOT NULL DEFAULT 0,
        items_seen INTEGER NOT NULL DEFAULT 0,
        items_upserted INTEGER NOT NULL DEFAULT 0,
        summaries_generated INTEGER NOT NULL DEFAULT 0,
        images_mirrored INTEGER NOT NULL DEFAULT 0,
        errors INTEGER NOT NULL DEFAULT 0,
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        FOREIGN KEY (run_id) REFERENCES fetch_runs(id) ON DELETE SET NULL
      )`
    },
    {
      sql: `CREATE TABLE IF NOT EXISTS app_error_events (
        id TEXT PRIMARY KEY,
        request_id TEXT,
        route TEXT,
        method TEXT,
        status_code INTEGER,
        actor_email TEXT,
        error_message TEXT NOT NULL,
        error_stack TEXT,
        meta_json TEXT,
        created_at TEXT NOT NULL DEFAULT (datetime('now')),
        expires_at TEXT
      )`
    },
    { sql: "CREATE INDEX IF NOT EXISTS idx_items_published_at ON items(published_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_items_url ON items(url)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_items_region_scope ON items(region_scope)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_items_published_id ON items(published_at, id)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_feed_items_feed ON feed_items(feed_id)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_feed_items_item ON feed_items(item_id)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_item_locations_state ON item_locations(state_code)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_item_locations_county ON item_locations(state_code, county)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_item_locations_item ON item_locations(item_id)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_feeds_region_scope ON feeds(region_scope)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_weather_forecasts_county ON weather_forecasts(state_code, county, fetched_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_weather_alerts_state_county ON weather_alerts(state_code, county, fetched_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_weather_alerts_alert_id ON weather_alerts(alert_id)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_lost_found_posts_status ON lost_found_posts(status, submitted_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_lost_found_posts_county ON lost_found_posts(state_code, county, status)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_lost_found_images_post_id ON lost_found_images(post_id)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_lost_found_reports_post_id ON lost_found_reports(post_id, created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_lost_found_comments_post_created ON lost_found_comments(post_id, created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_lost_found_comments_ip_created ON lost_found_comments(commenter_ip_hash, created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_lost_found_comment_bans_created ON lost_found_comment_bans(created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_admin_audit_created ON admin_audit_log(created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_item_ai_generated ON item_ai_summaries(generated_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_summary_review_status_created ON summary_review_queue(status, created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_tag_corrections_item_created ON item_tag_corrections(item_id, created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_feed_run_metrics_feed_checked ON feed_run_metrics(feed_id, checked_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_feed_run_metrics_status_checked ON feed_run_metrics(status, checked_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_ingestion_metrics_created ON ingestion_metrics(created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_app_error_events_created ON app_error_events(created_at)" },
    { sql: "CREATE INDEX IF NOT EXISTS idx_app_error_events_route_created ON app_error_events(route, created_at)" }
  ]);

  await addColumnIfMissing(db, "feeds", "region_scope", "TEXT NOT NULL DEFAULT 'ky'");
  await addColumnIfMissing(db, "feeds", "default_county", "TEXT");
  await addColumnIfMissing(db, "feeds", "fetch_mode", "TEXT NOT NULL DEFAULT 'rss'");
  await addColumnIfMissing(db, "feeds", "scraper_id", "TEXT");
  await d1Run(
    db,
    "UPDATE feeds SET fetch_mode='rss' WHERE fetch_mode IS NULL OR trim(fetch_mode)=''"
  );
  await d1Run(db, "CREATE INDEX IF NOT EXISTS idx_feeds_fetch_mode_enabled ON feeds(fetch_mode, enabled)");
  await addColumnIfMissing(db, "items", "region_scope", "TEXT NOT NULL DEFAULT 'ky'");
  await addColumnIfMissing(db, "items", "fetched_at", "TEXT");
  await d1Run(db, "UPDATE items SET fetched_at=datetime('now') WHERE fetched_at IS NULL OR trim(fetched_at)=''");
  await d1Run(db, "CREATE INDEX IF NOT EXISTS idx_items_fetched_id ON items(fetched_at, id)");
  await addColumnIfMissing(db, "items", "article_checked_at", "TEXT");
  await addColumnIfMissing(db, "items", "article_fetch_status", "TEXT");
  await addColumnIfMissing(db, "items", "article_text_excerpt", "TEXT");
  await addColumnIfMissing(db, "items", "seo_description", "TEXT");
  await addColumnIfMissing(db, "item_ai_summaries", "seo_description", "TEXT");
  await addColumnIfMissing(db, "admin_audit_log", "payload_json", "TEXT");
  await addColumnIfMissing(db, "feed_run_metrics", "run_id", "INTEGER");
  await addColumnIfMissing(db, "feed_run_metrics", "source", "TEXT");
  await addColumnIfMissing(db, "feed_run_metrics", "status", "TEXT");
  await addColumnIfMissing(db, "feed_run_metrics", "http_status", "INTEGER");
  await addColumnIfMissing(db, "feed_run_metrics", "duration_ms", "INTEGER");
  await addColumnIfMissing(db, "feed_run_metrics", "items_seen", "INTEGER NOT NULL DEFAULT 0");
  await addColumnIfMissing(db, "feed_run_metrics", "items_upserted", "INTEGER NOT NULL DEFAULT 0");
  await addColumnIfMissing(db, "feed_run_metrics", "error_message", "TEXT");
  await addColumnIfMissing(db, "feed_run_metrics", "checked_at", "TEXT");
  await d1Run(db, "UPDATE feed_run_metrics SET checked_at=datetime('now') WHERE checked_at IS NULL OR trim(checked_at)=''");
  await addColumnIfMissing(db, "lost_found_posts", "is_resolved", "INTEGER NOT NULL DEFAULT 0");
  await addColumnIfMissing(db, "lost_found_posts", "resolved_at", "TEXT");
  await addColumnIfMissing(db, "lost_found_posts", "resolved_note", "TEXT");
  await d1Run(db, "CREATE INDEX IF NOT EXISTS idx_lost_found_posts_resolved ON lost_found_posts(is_resolved, submitted_at)");
}

export function ensureSchema(env: Env): Promise<void> {
  if (!schemaReady) {
    schemaReady = createCoreSchema(env).catch((err) => {
      schemaReady = null;
      logError("schema.init.failed", err);
      throw err;
    });
  }
  return schemaReady;
}

export async function ensureSchemaFresh(env: Env): Promise<void> {
  schemaReady = null;
  await ensureSchema(env);
}

```

# ky-news-worker\src\services\scrapers.ts

```ts
import type { ParsedFeedItem } from "./rss";
import { decodeHtmlEntities, normalizeWhitespace, toHttpsUrl } from "../lib/text";
import { logWarn } from "../lib/logger";

const LIST_TIMEOUT_MS = 15_000;
const META_TIMEOUT_MS = 9_000;
const LIST_MAX_CHARS = 2_000_000;
const META_MAX_CHARS = 1_200_000;
const MAX_META_FETCHES = 16;
const META_CONCURRENCY = 4;
const MIN_TITLE_CHARS = 12;

type ScraperKind = "generic-news" | "gannett-story" | "townnews-article" | "mcclatchy-article";

export type ScrapeFeedInput = {
  feedId: string;
  /** Display name of the feed (used as post title for facebook-page mode). */
  feedName?: string;
  url: string;
  scraperId: string | null;
  maxItems: number;
  userAgent: string;
  /**
   * Optional Facebook session cookie (xs, c_user, datr, etc.) to authenticate
   * mbasic.facebook.com requests when the page requires login.
   * Configure via FACEBOOK_SESSION_COOKIE env var in wrangler.jsonc secrets.
   */
  sessionCookie?: string;
};

export type ScrapeFeedResult = {
  status: number;
  items: ParsedFeedItem[];
};

type Candidate = {
  link: string;
  title: string;
  isoDate: string | null;
  snippet: string | null;
  imageUrl: string | null;
  author: string | null;
  score: number;
};

type ArticleMeta = {
  title: string | null;
  snippet: string | null;
  isoDate: string | null;
  author: string | null;
  imageUrl: string | null;
  canonicalUrl: string | null;
};

const SCRAPER_BY_ID: Record<string, ScraperKind> = {
  "generic-news": "generic-news",
  "gannett-story": "gannett-story",
  "townnews-article": "townnews-article",
  "mcclatchy-article": "mcclatchy-article"
};

const HOST_SCRAPER_HINTS: Array<{ host: string; kind: ScraperKind }> = [
  { host: "courier-journal.com", kind: "gannett-story" },
  { host: "cincinnati.com", kind: "gannett-story" },
  { host: "messenger-inquirer.com", kind: "townnews-article" },
  { host: "paducahsun.com", kind: "townnews-article" },
  { host: "kentuckynewera.com", kind: "townnews-article" },
  { host: "hazard-herald.com", kind: "townnews-article" },
  { host: "dailyindependent.com", kind: "townnews-article" },
  { host: "state-journal.com", kind: "townnews-article" },
  // Added: additional TownNews CMS papers switched to scrape mode
  { host: "richmondregister.com", kind: "townnews-article" },
  { host: "floydct.com", kind: "townnews-article" },
  { host: "news-expressky.com", kind: "townnews-article" },
  { host: "thenewsenterprise.com", kind: "townnews-article" },
  { host: "kentucky.com", kind: "mcclatchy-article" }
];

const META_PATTERNS = {
  ogTitle: /<meta[^>]+property=["']og:title["'][^>]+content=["']([^"']+)["'][^>]*>/i,
  twTitle: /<meta[^>]+name=["']twitter:title["'][^>]+content=["']([^"']+)["'][^>]*>/i,
  description: /<meta[^>]+name=["']description["'][^>]+content=["']([^"']+)["'][^>]*>/i,
  ogDescription: /<meta[^>]+property=["']og:description["'][^>]+content=["']([^"']+)["'][^>]*>/i,
  author: /<meta[^>]+name=["']author["'][^>]+content=["']([^"']+)["'][^>]*>/i,
  articleAuthor: /<meta[^>]+property=["']article:author["'][^>]+content=["']([^"']+)["'][^>]*>/i,
  published: /<meta[^>]+property=["']article:published_time["'][^>]+content=["']([^"']+)["'][^>]*>/i,
  ogImage: /<meta[^>]+property=["']og:image["'][^>]+content=["']([^"']+)["'][^>]*>/i,
  canonical: /<link[^>]+rel=["']canonical["'][^>]+href=["']([^"']+)["'][^>]*>/i,
  title: /<title[^>]*>([\s\S]*?)<\/title>/i,
  timeTag: /<time[^>]+datetime=["']([^"']+)["'][^>]*>/i
};

const LINK_ATTR_RE = /<a\b[^>]*\bhref\s*=\s*(?:"([^"]+)"|'([^']+)'|([^\s>]+))[^>]*>([\s\S]*?)<\/a>/gi;
const LINK_URL_RE = /https?:\/\/[^\s"'<>]+/gi;
const SCRIPT_JSONLD_RE = /<script[^>]+type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi;

function toIsoOrNull(input: string | null | undefined): string | null {
  if (!input) return null;
  const dt = new Date(input);
  if (Number.isNaN(dt.getTime())) return null;
  return dt.toISOString();
}

function cleanText(input: string | null | undefined): string {
  return normalizeWhitespace(
    decodeHtmlEntities(String(input || ""))
      .replace(/<script[\s\S]*?<\/script>/gi, " ")
      .replace(/<style[\s\S]*?<\/style>/gi, " ")
      .replace(/<[^>]+>/g, " ")
      .replace(/\s+/g, " ")
  );
}

function cleanTitle(input: string | null | undefined): string {
  return cleanText(input).replace(/\s+\|\s+.*$/, "").trim();
}

function extractFirst(html: string, pattern: RegExp): string | null {
  const match = html.match(pattern);
  const raw = match?.[1]?.trim();
  if (!raw) return null;
  return decodeHtmlEntities(raw).trim() || null;
}

function decodePossiblyEscaped(input: string): string {
  const decoded = decodeHtmlEntities(input);
  try {
    return JSON.parse(`"${decoded.replace(/\\/g, "\\\\").replace(/"/g, '\\"')}"`);
  } catch {
    return decoded;
  }
}

function canonicalizeUrl(rawUrl: string, baseUrl: string): string | null {
  try {
    const absolute = new URL(rawUrl, baseUrl);
    if (absolute.protocol === "http:") absolute.protocol = "https:";
    if (absolute.protocol !== "https:") return null;
    absolute.hash = "";
    for (const key of [...absolute.searchParams.keys()]) {
      if (/^(utm_|gclid$|fbclid$|mc_eid$|mkt_tok$|outputType$|output$)/i.test(key)) {
        absolute.searchParams.delete(key);
      }
    }
    const path = absolute.pathname.replace(/\/+$/, "");
    absolute.pathname = path || "/";
    return absolute.toString();
  } catch {
    return null;
  }
}

function normalizeHost(host: string): string {
  return host.trim().toLowerCase().replace(/^www\./, "");
}

function hostMatches(urlHost: string, sourceHost: string): boolean {
  const a = normalizeHost(urlHost);
  const b = normalizeHost(sourceHost);
  return a === b || a.endsWith(`.${b}`) || b.endsWith(`.${a}`);
}

function resolveScraperKind(feedUrl: string, scraperId: string | null): ScraperKind {
  const explicit = scraperId ? SCRAPER_BY_ID[scraperId.trim().toLowerCase()] : null;
  if (explicit) return explicit;

  try {
    const host = normalizeHost(new URL(feedUrl).hostname);
    const matched = HOST_SCRAPER_HINTS.find((entry) => host === entry.host || host.endsWith(`.${entry.host}`));
    if (matched) return matched.kind;
  } catch {
    // Ignore and use generic fallback.
  }

  return "generic-news";
}

function scoreCandidate(kind: ScraperKind, url: URL, title: string): number {
  const path = `${url.pathname}${url.search}`.toLowerCase();
  let score = 0;

  if (title.length >= MIN_TITLE_CHARS) score += Math.min(20, Math.floor(title.length / 8));
  if (/\/20\d{2}\/\d{2}\/\d{2}\//.test(path)) score += 20;
  if (/\/(news|local|state|politics|business|education|sports|weather|obituaries|crime|government)\//.test(path)) {
    score += 24;
  }
  if ((path.match(/\//g) || []).length >= 4) score += 10;

  if (kind === "gannett-story") {
    if (/\/story\//.test(path)) score += 80;
    else score -= 35;
  } else if (kind === "townnews-article") {
    if (/article_[a-z0-9-]+\.html/.test(path)) score += 85;
    else score -= 30;
  } else if (kind === "mcclatchy-article") {
    if (/\/article\d+\.html/.test(path)) score += 85;
    else if (/\/news\//.test(path) && /\.html/.test(path)) score += 40;
    else score -= 25;
  } else {
    if (/\/story\//.test(path) || /article_[a-z0-9-]+\.html/.test(path) || /\/article\d+\.html/.test(path)) {
      score += 55;
    }
  }

  if (/\.(jpg|jpeg|png|gif|svg|webp|pdf)$/i.test(path)) score -= 250;
  if (/\/(video|videos|photos?|galleries?|podcasts?)\//.test(path)) score -= 35;
  if (/\/(tag|tags|topic|topics|author|authors|about|contact|privacy|terms|sitemap|account|subscribe)\b/.test(path)) {
    score -= 140;
  }
  if (/\/ap\//.test(path)) score -= 25;
  if (/\/search\//.test(path)) score -= 60;
  if (url.searchParams.has("output") || url.searchParams.has("outputType")) score -= 20;

  return score;
}

function isLikelyArticleCandidate(kind: ScraperKind, url: URL, sourceHost: string): boolean {
  if (!hostMatches(url.hostname, sourceHost)) return false;
  const path = `${url.pathname}${url.search}`.toLowerCase();
  if (!path || path === "/" || path.length < 8) return false;
  if (/\.(jpg|jpeg|png|gif|svg|webp|pdf)$/i.test(path)) return false;
  if (/#/.test(path)) return false;
  if (/\/(subscribe|account|login|privacy|terms|contact|about|staff|sitemap)\b/.test(path)) return false;

  if (kind === "gannett-story") return /\/story\//.test(path);
  if (kind === "townnews-article") {
    return /article_[a-z0-9-]+\.html/.test(path) && !/\/ap\//.test(path);
  }
  if (kind === "mcclatchy-article") return /\/article\d+\.html/.test(path) || (/\/news\//.test(path) && /\.html/.test(path));

  return /\/story\//.test(path) || /article_[a-z0-9-]+\.html/.test(path) || /\/article\d+\.html/.test(path) || /\/20\d{2}\//.test(path);
}

function parseJsonLdBlock(raw: string): unknown | null {
  const stripped = raw.trim().replace(/^<!--/, "").replace(/-->$/, "").trim();
  if (!stripped) return null;
  try {
    return JSON.parse(stripped);
  } catch {
    try {
      return JSON.parse(decodePossiblyEscaped(stripped));
    } catch {
      return null;
    }
  }
}

function walkJson(value: unknown, fn: (node: Record<string, unknown>) => void, depth = 0): void {
  if (depth > 8 || value == null) return;
  if (Array.isArray(value)) {
    for (const item of value) walkJson(item, fn, depth + 1);
    return;
  }
  if (typeof value !== "object") return;

  const node = value as Record<string, unknown>;
  fn(node);

  for (const key of ["@graph", "mainEntity", "mainEntityOfPage", "itemListElement", "hasPart", "about"]) {
    if (key in node) walkJson(node[key], fn, depth + 1);
  }
}

function readJsonUrl(node: Record<string, unknown>): string | null {
  const direct = node.url;
  if (typeof direct === "string" && direct.trim()) return direct.trim();

  const id = node["@id"];
  if (typeof id === "string" && id.trim()) return id.trim();

  const mainEntity = node.mainEntity as Record<string, unknown> | undefined;
  if (mainEntity && typeof mainEntity === "object") {
    const nested = readJsonUrl(mainEntity);
    if (nested) return nested;
  }

  const item = node.item as Record<string, unknown> | undefined;
  if (item && typeof item === "object") {
    const nested = readJsonUrl(item);
    if (nested) return nested;
  }

  return null;
}

function readJsonImage(node: Record<string, unknown>): string | null {
  const image = node.image;
  if (typeof image === "string") return image;
  if (Array.isArray(image)) {
    const first = image.find((entry) => typeof entry === "string") as string | undefined;
    if (first) return first;
    const obj = image.find((entry) => entry && typeof entry === "object") as Record<string, unknown> | undefined;
    if (obj && typeof obj.url === "string") return obj.url;
  }
  if (image && typeof image === "object" && typeof (image as Record<string, unknown>).url === "string") {
    return String((image as Record<string, unknown>).url);
  }
  return null;
}

function readJsonAuthor(node: Record<string, unknown>): string | null {
  const author = node.author;
  if (typeof author === "string") return cleanText(author);
  if (Array.isArray(author)) {
    for (const entry of author) {
      if (typeof entry === "string") {
        const cleaned = cleanText(entry);
        if (cleaned) return cleaned;
      }
      if (entry && typeof entry === "object" && typeof (entry as Record<string, unknown>).name === "string") {
        const cleaned = cleanText(String((entry as Record<string, unknown>).name));
        if (cleaned) return cleaned;
      }
    }
  }
  if (author && typeof author === "object" && typeof (author as Record<string, unknown>).name === "string") {
    return cleanText(String((author as Record<string, unknown>).name));
  }
  return null;
}

function candidateFromJsonLd(node: Record<string, unknown>, baseUrl: string, kind: ScraperKind, sourceHost: string): Candidate | null {
  const typeRaw = node["@type"];
  const types = Array.isArray(typeRaw) ? typeRaw.map((v) => String(v || "").toLowerCase()) : [String(typeRaw || "").toLowerCase()];

  const isArticle =
    types.some((t) =>
      [
        "newsarticle",
        "article",
        "reportagenewsarticle",
        "blogposting",
        "liveblogposting",
        "analysisnewsarticle"
      ].includes(t)
    ) || types.some((t) => t.includes("article"));

  if (!isArticle && !types.includes("itemlist")) return null;

  if (types.includes("itemlist")) {
    return null;
  }

  const linkRaw = readJsonUrl(node);
  if (!linkRaw) return null;
  const link = canonicalizeUrl(linkRaw, baseUrl);
  if (!link) return null;

  let parsedUrl: URL;
  try {
    parsedUrl = new URL(link);
  } catch {
    return null;
  }

  if (!isLikelyArticleCandidate(kind, parsedUrl, sourceHost)) return null;

  const title = cleanTitle(String(node.headline || node.name || ""));
  if (title.length < MIN_TITLE_CHARS) return null;

  return {
    link,
    title,
    isoDate: toIsoOrNull(String(node.datePublished || node.dateCreated || node.dateModified || "")),
    snippet: cleanText(String(node.description || "")) || null,
    imageUrl: toHttpsUrl(readJsonImage(node)),
    author: readJsonAuthor(node),
    score: scoreCandidate(kind, parsedUrl, title) + 15
  };
}

function extractJsonLdCandidates(html: string, baseUrl: string, kind: ScraperKind, sourceHost: string): Candidate[] {
  const out: Candidate[] = [];

  for (const match of html.matchAll(SCRIPT_JSONLD_RE)) {
    const raw = String(match[1] || "").trim();
    if (!raw) continue;

    const parsed = parseJsonLdBlock(raw);
    if (!parsed) continue;

    walkJson(parsed, (node) => {
      const candidate = candidateFromJsonLd(node, baseUrl, kind, sourceHost);
      if (candidate) out.push(candidate);

      const typeRaw = node["@type"];
      const types = Array.isArray(typeRaw) ? typeRaw.map((v) => String(v || "").toLowerCase()) : [String(typeRaw || "").toLowerCase()];
      if (!types.includes("itemlist")) return;

      const items = node.itemListElement;
      if (!Array.isArray(items)) return;
      for (const item of items) {
        if (!item || typeof item !== "object") continue;
        const entry = item as Record<string, unknown>;
        const urlRaw = readJsonUrl(entry);
        if (!urlRaw) continue;
        const link = canonicalizeUrl(urlRaw, baseUrl);
        if (!link) continue;
        let parsedUrl: URL;
        try {
          parsedUrl = new URL(link);
        } catch {
          continue;
        }
        if (!isLikelyArticleCandidate(kind, parsedUrl, sourceHost)) continue;

        const title = cleanTitle(String(entry.name || entry.headline || ""));
        if (title.length < MIN_TITLE_CHARS) continue;

        out.push({
          link,
          title,
          isoDate: toIsoOrNull(String(entry.datePublished || entry.dateCreated || "")),
          snippet: cleanText(String(entry.description || "")) || null,
          imageUrl: toHttpsUrl(readJsonImage(entry)),
          author: readJsonAuthor(entry),
          score: scoreCandidate(kind, parsedUrl, title) + 10
        });
      }
    });
  }

  return out;
}

function extractAnchorCandidates(html: string, baseUrl: string, kind: ScraperKind, sourceHost: string): Candidate[] {
  const out: Candidate[] = [];

  for (const match of html.matchAll(LINK_ATTR_RE)) {
    const href = String(match[1] || match[2] || match[3] || "").trim();
    const link = canonicalizeUrl(href, baseUrl);
    if (!link) continue;

    let parsedUrl: URL;
    try {
      parsedUrl = new URL(link);
    } catch {
      continue;
    }

    if (!isLikelyArticleCandidate(kind, parsedUrl, sourceHost)) continue;

    const title = cleanTitle(String(match[4] || ""));
    if (title.length < MIN_TITLE_CHARS) continue;

    const score = scoreCandidate(kind, parsedUrl, title);
    if (score < 30) continue;

    out.push({
      link,
      title,
      isoDate: null,
      snippet: null,
      imageUrl: null,
      author: null,
      score
    });
  }

  return out;
}

function extractLooseUrlCandidates(html: string, baseUrl: string, kind: ScraperKind, sourceHost: string): Candidate[] {
  const out: Candidate[] = [];
  for (const match of html.matchAll(LINK_URL_RE)) {
    const link = canonicalizeUrl(match[0], baseUrl);
    if (!link) continue;

    let parsedUrl: URL;
    try {
      parsedUrl = new URL(link);
    } catch {
      continue;
    }

    if (!isLikelyArticleCandidate(kind, parsedUrl, sourceHost)) continue;

    const derivedTitle = cleanTitle(
      parsedUrl.pathname
        .split("/")
        .filter(Boolean)
        .slice(-2)
        .join(" ")
        .replace(/[-_]/g, " ")
    );
    if (derivedTitle.length < MIN_TITLE_CHARS) continue;

    const score = scoreCandidate(kind, parsedUrl, derivedTitle) - 8;
    if (score < 30) continue;

    out.push({
      link,
      title: derivedTitle,
      isoDate: null,
      snippet: null,
      imageUrl: null,
      author: null,
      score
    });
  }
  return out;
}

function mergeCandidates(candidates: Candidate[]): Candidate[] {
  const map = new Map<string, Candidate>();
  for (const candidate of candidates) {
    const key = candidate.link;
    const prev = map.get(key);
    if (!prev) {
      map.set(key, candidate);
      continue;
    }

    map.set(key, {
      link: key,
      title: prev.title.length >= candidate.title.length ? prev.title : candidate.title,
      isoDate: prev.isoDate || candidate.isoDate,
      snippet: prev.snippet || candidate.snippet,
      imageUrl: prev.imageUrl || candidate.imageUrl,
      author: prev.author || candidate.author,
      score: Math.max(prev.score, candidate.score)
    });
  }

  return [...map.values()].sort((a, b) => b.score - a.score);
}

function listingFallbackPaths(kind: ScraperKind): string[] {
  if (kind === "gannett-story") return ["/news/", "/news/local/", "/news/politics/"];
  if (kind === "townnews-article") return ["/news/", "/sports/", "/obituaries/"];
  if (kind === "mcclatchy-article") return ["/news/", "/news/politics-government/"];
  return ["/news/"];
}

function buildListingUrls(feedUrl: string, kind: ScraperKind): string[] {
  const out = new Set<string>();
  const primary = canonicalizeUrl(feedUrl, feedUrl);
  if (primary) out.add(primary);

  let origin: string | null = null;
  try {
    const base = new URL(feedUrl);
    origin = `${base.protocol}//${base.host}`;
  } catch {
    origin = null;
  }

  if (origin) {
    for (const path of listingFallbackPaths(kind)) {
      const combined = canonicalizeUrl(path, origin);
      if (combined) out.add(combined);
      if (out.size >= 3) break;
    }
  }

  return [...out];
}

async function fetchHtml(
  url: string,
  userAgent: string,
  timeoutMs: number,
  maxChars: number
): Promise<{ status: number; html: string; finalUrl: string }> {
  const ctrl = new AbortController();
  const timeout = setTimeout(() => ctrl.abort(), timeoutMs);

  try {
    const response = await fetch(url, {
      redirect: "follow",
      signal: ctrl.signal,
      headers: {
        "user-agent": userAgent,
        accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
        "accept-language": "en-US,en;q=0.9",
        "cache-control": "no-cache",
        pragma: "no-cache"
      },
      cf: { cacheTtl: 0 }
    });

    const status = response.status;
    if (status < 200 || status >= 300) {
      throw new Error(`HTTP ${status} from ${url}`);
    }

    let html = await response.text();
    if (html.length > maxChars) html = html.slice(0, maxChars);
    return { status, html, finalUrl: response.url || url };
  } finally {
    clearTimeout(timeout);
  }
}

async function fetchArticleMeta(url: string, userAgent: string): Promise<ArticleMeta | null> {
  try {
    const fetched = await fetchHtml(url, userAgent, META_TIMEOUT_MS, META_MAX_CHARS);
    const html = fetched.html;

    const title = cleanTitle(extractFirst(html, META_PATTERNS.ogTitle) || extractFirst(html, META_PATTERNS.twTitle) || extractFirst(html, META_PATTERNS.title) || "");
    const snippet =
      cleanText(extractFirst(html, META_PATTERNS.ogDescription) || extractFirst(html, META_PATTERNS.description) || "") ||
      null;
    const isoDate = toIsoOrNull(extractFirst(html, META_PATTERNS.published) || extractFirst(html, META_PATTERNS.timeTag) || "");
    const author = cleanText(extractFirst(html, META_PATTERNS.author) || extractFirst(html, META_PATTERNS.articleAuthor) || "") || null;
    const imageUrl = toHttpsUrl(extractFirst(html, META_PATTERNS.ogImage));
    const canonicalUrl = canonicalizeUrl(extractFirst(html, META_PATTERNS.canonical) || fetched.finalUrl, fetched.finalUrl);

    return {
      title: title || null,
      snippet,
      isoDate,
      author,
      imageUrl,
      canonicalUrl
    };
  } catch {
    return null;
  }
}

async function mapWithConcurrency<T, R>(items: T[], concurrency: number, mapper: (item: T, index: number) => Promise<R>): Promise<R[]> {
  if (items.length === 0) return [];
  const max = Math.max(1, Math.min(concurrency, items.length));
  const results = new Array<R>(items.length);
  let cursor = 0;

  async function worker(): Promise<void> {
    for (;;) {
      const index = cursor++;
      if (index >= items.length) return;
      results[index] = await mapper(items[index], index);
    }
  }

  await Promise.all(Array.from({ length: max }, () => worker()));
  return results;
}

function toParsedFeedItem(candidate: Candidate): ParsedFeedItem {
  return {
    title: candidate.title || "(untitled)",
    link: candidate.link,
    guid: candidate.link,
    isoDate: candidate.isoDate,
    pubDate: candidate.isoDate,
    contentSnippet: candidate.snippet,
    content: candidate.snippet,
    author: candidate.author,
    imageUrl: candidate.imageUrl
  };
}

// ─── Facebook public-page scraper ───────────────────────────────────────────
/**
 * Scrape a public Facebook page via mbasic.facebook.com (server-rendered, no JS required).
 * Returns posts as feed items: page name = title, post text = content, first image = imageUrl.
 * No minimum word count is enforced – school/community posts are typically short.
 *
 * Falls back gracefully (returns 0 items) when Facebook blocks the request or
 * requires login.
 */
export async function scrapeFacebookPageItems(input: ScrapeFeedInput): Promise<ScrapeFeedResult> {
  // Extract page slug from Facebook URL (https://www.facebook.com/{slug}/)
  let pageSlug = "";
  let numericId = false;
  try {
    const u = new URL(input.url);
    const firstSegment = u.pathname.replace(/^\/+/, "").split("/")[0] || "";
    pageSlug = firstSegment;
    numericId = /^\d+$/.test(pageSlug);
  } catch {
    throw new Error(`Invalid Facebook page URL: ${input.url}`);
  }

  if (!pageSlug) {
    throw new Error(`Could not extract page slug from Facebook URL: ${input.url}`);
  }

  // Use mbasic (server-rendered, no JS) for public pages
  const mbasicUrl = numericId
    ? `https://mbasic.facebook.com/profile.php?id=${pageSlug}`
    : `https://mbasic.facebook.com/${pageSlug}`;

  const ctrl = new AbortController();
  const timeout = setTimeout(() => ctrl.abort(), LIST_TIMEOUT_MS);

  let html = "";
  let status = 0;
  try {
    const reqHeaders: Record<string, string> = {
      // Mobile Safari UA encourages mbasic rendering path
      "User-Agent":
        "Mozilla/5.0 (iPhone; CPU iPhone OS 16_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Mobile/15E148 Safari/604.1",
      Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
      "Accept-Language": "en-US,en;q=0.5",
    };
    // Include session cookie if configured — required for pages that Facebook
    // has restricted to logged-in users. Configure FACEBOOK_SESSION_COOKIE in env.
    if (input.sessionCookie) {
      reqHeaders["Cookie"] = input.sessionCookie;
    }
    const res = await fetch(mbasicUrl, {
      signal: ctrl.signal,
      headers: reqHeaders,
      redirect: "follow",
    });
    status = res.status;
    if (status === 200) {
      html = await res.text();
      if (html.length > LIST_MAX_CHARS) html = html.slice(0, LIST_MAX_CHARS);
    }
  } finally {
    clearTimeout(timeout);
  }

  if (status !== 200) {
    // Non-200 is a soft failure — log and return empty rather than throwing,
    // so one blocked page doesn't abort the entire ingest run.
    logWarn("ingest.facebook.http_error", {
      feedId: input.feedId,
      url: mbasicUrl,
      status
    });
    return { status, items: [] };
  }

  // Detect login-wall redirect (Facebook blocks unauthenticated bots for some pages)
  const isLoginPage =
    html.includes('id="login_form"') ||
    (html.includes('name="email"') && html.includes('name="pass"')) ||
    html.includes("/login/?next=");
  if (isLoginPage) {
    // Return gracefully instead of throwing — if no session cookie is configured,
    // all Facebook feeds would otherwise error out on every ingest cycle.
    // To restore Facebook content: set FACEBOOK_SESSION_COOKIE in wrangler secrets.
    logWarn("ingest.facebook.login_wall", {
      feedId: input.feedId,
      url: mbasicUrl,
      hint: "Set FACEBOOK_SESSION_COOKIE in wrangler.jsonc secrets to enable Facebook scraping"
    });
    return { status: 403, items: [] };
  }

  // Derive page display name from og:title, <title>, or feed name
  const pageName =
    input.feedName ||
    extractFirst(html, /<meta[^>]+property=["']og:title["'][^>]+content=["']([^"']+)["'][^>]*>/i) ||
    extractFirst(html, /<title[^>]*>([\s\S]*?)<\/title>/i) ||
    pageSlug;

  const maxItems = Number.isFinite(input.maxItems) ? Math.max(1, Math.min(input.maxItems, 60)) : 20;
  const items: ParsedFeedItem[] = [];

  // ── Strategy 1: <article> elements (mbasic wraps each story in <article>) ──
  const articleMatches = [...html.matchAll(/<article\b[^>]*>([\s\S]*?)<\/article>/gi)];
  for (const match of articleMatches) {
    if (items.length >= maxItems) break;
    const articleHtml = match[1] || "";

    // Skip comment/reaction blocks
    if (/data-sigil="comment"/.test(articleHtml) || /data-ft="{[^}]*\"type\":\s*27/.test(articleHtml)) continue;

    // Extract post permalink
    const postLinkMatch =
      articleHtml.match(/href="(\/[^"]+\/posts\/[^"?#]+[^"]*?)"/) ||
      articleHtml.match(/href="(\/story\.php\?[^"]+)"/) ||
      articleHtml.match(/href="(\/permalink\/\d+\/?)"/);
    const rawPostLink = postLinkMatch
      ? postLinkMatch[1].replace(/&amp;/g, "&")
      : null;
    const postLink = rawPostLink
      ? `https://www.facebook.com${rawPostLink}`
      : input.url.replace(/\/$/, "");

    // Strip HTML and decode entities to get readable text
    const text = cleanText(articleHtml);
    if (!text || text.length < 15) continue;

    // Remove Facebook engagement noise (Like · Comment · Share etc.)
    const cleaned = text
      .replace(/\s*\b(Like|Comment|Share|Reply|See more|See less|Translated|Turn off translations?)\b\s*/gi, " ")
      .replace(/\s{2,}/g, " ")
      .trim();
    if (!cleaned || cleaned.length < 10) continue;

    // First image from the article block
    const imgMatch = articleHtml.match(/<img\b[^>]+src="([^"]+)"/i);
    const imageUrl = imgMatch ? toHttpsUrl(imgMatch[1]) : null;

    // Timestamp from <abbr title="...">
    const abbrMatch = articleHtml.match(/<abbr[^>]+title="([^"]+)"/i);
    const isoDate = abbrMatch ? toIsoOrNull(abbrMatch[1]) : null;

    items.push({
      title: pageName,
      link: postLink,
      guid: postLink !== input.url.replace(/\/$/, "") ? postLink : `${input.url}#fb-post-${items.length}`,
      isoDate,
      pubDate: isoDate,
      contentSnippet: cleaned.slice(0, 500),
      content: cleaned,
      author: pageName,
      imageUrl,
    });
  }

  // ── Strategy 2: story-permalink divs (older mbasic layout) ──
  if (items.length === 0) {
    const storyDivMatches = [
      ...html.matchAll(/<div[^>]+id="m_story_permalink_view[^"]*"[^>]*>([\s\S]*?)<\/div>\s*<\/div>/gi)
    ];
    for (const match of storyDivMatches) {
      if (items.length >= maxItems) break;
      const divHtml = match[1] || "";
      const text = cleanText(divHtml).trim();
      if (!text || text.length < 15) continue;
      const cleaned = text
        .replace(/\s*\b(Like|Comment|Share|Reply|See more|See less)\b\s*/gi, " ")
        .replace(/\s{2,}/g, " ")
        .trim();
      if (!cleaned || cleaned.length < 10) continue;
      // Build a stable content-based suffix so each post gets a unique URL
      const contentKey = cleaned.slice(0, 48).replace(/[^a-z0-9]+/gi, "-").toLowerCase().replace(/^-+|-+$/g, "");
      const postLink = `${input.url.replace(/\/?$/, "")}?p=${encodeURIComponent(contentKey)}_${items.length}`;
      const imgMatch = divHtml.match(/<img\b[^>]+src="([^"]+)"/i);
      items.push({
        title: pageName,
        link: postLink,
        guid: postLink,
        isoDate: null,
        pubDate: null,
        contentSnippet: cleaned.slice(0, 500),
        content: cleaned,
        author: pageName,
        imageUrl: imgMatch ? toHttpsUrl(imgMatch[1]) : null,
      });
    }
  }

  if (items.length === 0) {
    logWarn("ingest.facebook.no_posts", {
      feedId: input.feedId,
      url: mbasicUrl,
      htmlLength: html.length,
    });
  }

  return { status, items };
}

export async function scrapeFeedItems(input: ScrapeFeedInput): Promise<ScrapeFeedResult> {
  const kind = resolveScraperKind(input.url, input.scraperId);
  const maxItems = Number.isFinite(input.maxItems) ? Math.max(1, Math.min(input.maxItems, 120)) : 60;
  const listingUrls = buildListingUrls(input.url, kind);

  let bestStatus = 200;
  const discovered: Candidate[] = [];

  for (const listUrl of listingUrls) {
    try {
      const fetched = await fetchHtml(listUrl, input.userAgent, LIST_TIMEOUT_MS, LIST_MAX_CHARS);
      bestStatus = fetched.status;
      const sourceHost = new URL(fetched.finalUrl).hostname;

      const fromJsonLd = extractJsonLdCandidates(fetched.html, fetched.finalUrl, kind, sourceHost);
      const fromAnchors = extractAnchorCandidates(fetched.html, fetched.finalUrl, kind, sourceHost);
      const fromLoose = extractLooseUrlCandidates(fetched.html, fetched.finalUrl, kind, sourceHost);
      discovered.push(...fromJsonLd, ...fromAnchors, ...fromLoose);

      if (discovered.length >= maxItems * 3) break;
    } catch (err) {
      logWarn("ingest.scrape.list.fetch_failed", {
        feedId: input.feedId,
        scraper: kind,
        listUrl,
        error: err instanceof Error ? err.message : String(err)
      });
    }
  }

  const merged = mergeCandidates(discovered).slice(0, Math.max(maxItems * 3, 48));
  if (!merged.length) {
    throw new Error(`Scraper ${kind} found no candidates for ${input.url}`);
  }

  const metaTargets = merged.slice(0, Math.min(MAX_META_FETCHES, Math.max(maxItems, 8)));
  const metaResults = await mapWithConcurrency(metaTargets, META_CONCURRENCY, async (candidate) => {
    const meta = await fetchArticleMeta(candidate.link, input.userAgent);
    return { candidate, meta };
  });

  const metaByLink = new Map<string, ArticleMeta>();
  for (const entry of metaResults) {
    if (entry.meta) metaByLink.set(entry.candidate.link, entry.meta);
  }

  const normalized = merged.map((candidate) => {
    const meta = metaByLink.get(candidate.link);
    const canonical = meta?.canonicalUrl ? canonicalizeUrl(meta.canonicalUrl, candidate.link) : null;
    const link = canonical || candidate.link;
    return {
      link,
      title: cleanTitle(candidate.title || meta?.title || "(untitled)"),
      isoDate: candidate.isoDate || meta?.isoDate || null,
      snippet: candidate.snippet || meta?.snippet || null,
      imageUrl: candidate.imageUrl || meta?.imageUrl || null,
      author: candidate.author || meta?.author || null,
      score: candidate.score
    } satisfies Candidate;
  });

  const finalCandidates = mergeCandidates(normalized).slice(0, maxItems);
  const items = finalCandidates.map(toParsedFeedItem);
  return { status: bestStatus, items };
}

```

# ky-news-worker\src\services\security.ts

```ts
import { randomUUID } from "node:crypto";
import type { AppContext, AdminIdentity, Env } from "../types";
import { forbidden, tooManyRequests, unauthorized } from "../lib/errors";
import { d1Run } from "./db";
import { hashIp } from "../lib/crypto";
import { logWarn } from "../lib/logger";

type AdminRole = "admin" | "editor";

function parseCsvSet(value: string | undefined): Set<string> {
  return new Set(
    String(value || "")
      .split(",")
      .map((v) => v.trim().toLowerCase())
      .filter(Boolean)
  );
}

function roleRank(role: AdminRole): number {
  return role === "admin" ? 2 : 1;
}

export function getAdminIdentity(c: AppContext): AdminIdentity | null {
  const cfEmail = c.req.header("cf-access-authenticated-user-email");
  if (cfEmail) {
    const normalized = String(cfEmail).trim().toLowerCase();
    const admins = parseCsvSet(c.env.ADMIN_EMAILS);
    const editors = parseCsvSet(c.env.EDITOR_EMAILS);

    if (admins.has(normalized)) {
      return { email: normalized, source: "cloudflare-access", role: "admin" };
    }
    if (editors.has(normalized)) {
      return { email: normalized, source: "cloudflare-access", role: "editor" };
    }
    return null;
  }

  const headerToken = c.req.header("x-admin-token");
  const adminToken = c.env.ADMIN_TOKEN;
  if (adminToken && headerToken && headerToken === adminToken) {
    return { email: c.env.ADMIN_EMAIL || "worker-admin", source: "admin-token", role: "admin" };
  }

  return null;
}

export function requireAdmin(c: AppContext): AdminIdentity {
  const identity = getAdminIdentity(c);
  if (!identity) unauthorized("Admin authentication required");
  return identity;
}

export function requireRole(c: AppContext, role: AdminRole): AdminIdentity {
  const identity = requireAdmin(c);
  if (roleRank(identity.role) < roleRank(role)) {
    forbidden("Insufficient role");
  }
  return identity;
}

export async function insertAdminLog(
  env: Env,
  actorEmail: string,
  action: string,
  entityType: string,
  entityId: string,
  payload: unknown = null
): Promise<void> {
  try {
    await d1Run(
      env.ky_news_db,
      "INSERT INTO admin_audit_log (id, actor_email, action, entity_type, entity_id, payload_json) VALUES (?, ?, ?, ?, ?, ?)",
      [randomUUID(), actorEmail, action, entityType, entityId, payload == null ? null : JSON.stringify(payload)]
    );
  } catch (err) {
    logWarn("admin.audit.log_failed", {
      action,
      entityType,
      entityId,
      error: err instanceof Error ? err.message : String(err)
    });
  }
}

export function getClientIp(c: AppContext): string {
  return (
    c.req.header("cf-connecting-ip") ||
    c.req.header("x-forwarded-for")?.split(",")[0]?.trim() ||
    "unknown"
  );
}

export async function enforceRateLimit(
  env: Env,
  key: string,
  limit: number,
  windowSeconds: number
): Promise<{ allowed: boolean; remaining: number; resetInSec: number }> {
  const bucket = Math.floor(Date.now() / (windowSeconds * 1000));
  const cacheKey = `rl:v2:${key}:${bucket}`;
  const current = Number(await env.CACHE.get(cacheKey));
  const used = Number.isFinite(current) ? current : 0;

  if (used >= limit) {
    return { allowed: false, remaining: 0, resetInSec: windowSeconds };
  }

  const next = used + 1;
  await env.CACHE.put(cacheKey, String(next), { expirationTtl: windowSeconds + 30 });
  return { allowed: true, remaining: Math.max(0, limit - next), resetInSec: windowSeconds };
}

export async function enforceGlobalRequestRateLimit(c: AppContext): Promise<void> {
  const ip = getClientIp(c);
  const path = new URL(c.req.url).pathname;
  const isAdmin = path.startsWith("/api/admin/");
  const isWrite = c.req.method !== "GET" && c.req.method !== "HEAD" && c.req.method !== "OPTIONS";

  const readLimit = Number(c.env.RATE_LIMIT_READ_PER_MIN || "240");
  const writeLimit = Number(c.env.RATE_LIMIT_WRITE_PER_MIN || "60");
  const adminLimit = Number(c.env.RATE_LIMIT_ADMIN_PER_MIN || "90");

  const bucketType = isAdmin ? "admin" : isWrite ? "write" : "read";
  const limit = bucketType === "admin" ? adminLimit : bucketType === "write" ? writeLimit : readLimit;

  const result = await enforceRateLimit(c.env, `${bucketType}:${ip}`, Number.isFinite(limit) ? limit : 120, 60);
  c.header("x-ratelimit-remaining", String(result.remaining));
  c.header("x-ratelimit-reset-sec", String(result.resetInSec));

  if (!result.allowed) {
    tooManyRequests("Rate limit exceeded");
  }
}

export function enforceBotProtection(c: AppContext): void {
  const path = new URL(c.req.url).pathname;
  const method = c.req.method.toUpperCase();
  const guarded = path.startsWith("/api/admin/") || method !== "GET" || path === "/api/open-proxy";
  if (!guarded) return;

  const cf = (c.req.raw as any)?.cf;
  const verifiedBot = Boolean(cf?.botManagement?.verifiedBot);
  if (verifiedBot) return;

  const headerScore = Number(c.req.header("cf-bot-score"));
  const cfScoreRaw = cf?.botManagement?.score;
  const cfScore = Number.isFinite(Number(cfScoreRaw)) ? Number(cfScoreRaw) : headerScore;

  const thresholdRaw = Number(c.env.BOT_SCORE_MIN || "18");
  const threshold = Number.isFinite(thresholdRaw) ? thresholdRaw : 18;
  if (Number.isFinite(cfScore) && cfScore < threshold) {
    logWarn("security.bot.blocked", { path, method, score: cfScore, threshold });
    forbidden("Request blocked by bot protection");
  }

  const userAgent = c.req.header("user-agent") || "";
  if (!userAgent.trim() && guarded) {
    forbidden("Missing user-agent");
  }
}

export async function enforceSubmissionRateLimit(env: Env, ip: string): Promise<boolean> {
  const ipKey = await hashIp(ip || "unknown");
  const bucket = Math.floor(Date.now() / (60 * 60 * 1000));
  const key = `rl:lost-found:${ipKey}:${bucket}`;
  const current = Number(await env.CACHE.get(key));
  if (Number.isFinite(current) && current >= 5) {
    return false;
  }

  const next = Number.isFinite(current) ? current + 1 : 1;
  await env.CACHE.put(key, String(next), { expirationTtl: 2 * 60 * 60 });
  return true;
}

```

# ky-news-worker\src\services\summary.ts

```ts
import { d1First, d1Run } from "./db";
import { logError } from "../lib/logger";
import { sha256Hex } from "../lib/crypto";
import { decodeHtmlEntities, normalizeWhitespace } from "../lib/text";
import type { Env } from "../types";

const SUMMARY_PROMPT_VERSION = "v4";
const SUMMARY_TARGET_MIN_RATIO = 0.55;
const SUMMARY_TARGET_MAX_RATIO = 0.65;
const SUMMARY_TARGET_RATIO = 0.6;
const SUMMARY_ABSOLUTE_MIN_WORDS = 40;
const SUMMARY_ABSOLUTE_MAX_WORDS = 900;
const SEO_DESCRIPTION_MAX_CHARS = 160;
const SUMMARY_BOILERPLATE_RE =
  /you are using an outdated browser|subscribe home news sports opinion obituaries features|submit an obituary|engagement announcement|wedding announcement/i;

type SummaryLengthBounds = {
  sourceWords: number;
  minWords: number;
  maxWords: number;
  targetWords: number;
};

type AiRewriteOutput = {
  summary: string;
  seoDescription: string;
};

type AiMessage = {
  role: "system" | "user";
  content: string;
};

export function summaryCacheKey(itemId: string): string {
  return `summary:${SUMMARY_PROMPT_VERSION}:${itemId}`;
}

export function summarySeoCacheKey(itemId: string): string {
  return `summary-seo:${SUMMARY_PROMPT_VERSION}:${itemId}`;
}

function parseAiText(response: unknown): string {
  if (typeof response === "string") return response.trim();
  if (!response || typeof response !== "object") return "";

  const res = response as Record<string, unknown>;
  if (typeof res.response === "string") return res.response.trim();
  if (typeof (res.result as any)?.response === "string") return String((res.result as any).response).trim();

  const openAiStyle = (res as any)?.choices?.[0]?.message?.content;
  if (typeof openAiStyle === "string") return openAiStyle.trim();
  if (Array.isArray(openAiStyle)) {
    const joined = openAiStyle
      .map((part: unknown) => {
        if (typeof part === "string") return part;
        if (part && typeof part === "object" && typeof (part as any).text === "string") return (part as any).text;
        return "";
      })
      .join("\n")
      .trim();
    if (joined) return joined;
  }

  if (Array.isArray(res.content)) {
    const joined = res.content
      .map((part) => {
        if (typeof part === "string") return part;
        if (part && typeof part === "object" && typeof (part as any).text === "string") return (part as any).text;
        return "";
      })
      .join("\n")
      .trim();
    if (joined) return joined;
  }

  if (Array.isArray((res.result as any)?.content)) {
    const joined = (res.result as any).content
      .map((part: unknown) => {
        if (typeof part === "string") return part;
        if (part && typeof part === "object" && typeof (part as any).text === "string") return (part as any).text;
        return "";
      })
      .join("\n")
      .trim();
    if (joined) return joined;
  }

  return "";
}

function splitWords(input: string): string[] {
  return input
    .trim()
    .split(/\s+/)
    .map((word) => word.trim())
    .filter(Boolean);
}

function wordCount(input: string): number {
  return splitWords(input).length;
}

function summaryLengthBounds(articleText: string): SummaryLengthBounds {
  const sourceWords = Math.max(1, wordCount(normalizeWhitespace(articleText)));
  const ratioMin = Math.floor(sourceWords * SUMMARY_TARGET_MIN_RATIO);
  const ratioMax = Math.ceil(sourceWords * SUMMARY_TARGET_MAX_RATIO);
  const ratioTarget = Math.floor(sourceWords * SUMMARY_TARGET_RATIO);

  let minWords = Math.max(SUMMARY_ABSOLUTE_MIN_WORDS, ratioMin);
  let maxWords = Math.max(minWords + 20, Math.min(SUMMARY_ABSOLUTE_MAX_WORDS, ratioMax));
  if (maxWords <= minWords) maxWords = minWords + 20;

  const targetWords = Math.max(minWords, Math.min(maxWords, ratioTarget));
  return { sourceWords, minWords, maxWords, targetWords };
}

function stripCodeFences(input: string): string {
  const trimmed = input.trim();
  const fenced = trimmed.match(/^\`\`\`(?:json|text)?\s*([\s\S]*?)\s*\`\`\`$/i);
  return fenced ? fenced[1].trim() : trimmed;
}

function normalizeSummary(text: string): string {
  const withLines = decodeHtmlEntities(stripCodeFences(text))
    .replace(/^\s*(here(?:'s| is)\s+(?:a|the)\s+(?:rewritten\s+)?summary[:\-\s]*)/i, "")
    .replace(/\r\n?/g, "\n")
    .replace(/\*\*([^*]+)\*\*/g, "$1")
    .replace(/`{1,3}/g, "")
    .replace(/[ \t]+\n/g, "\n")
    .replace(/\n{3,}/g, "\n\n")
    .trim();

  const cleaned = withLines
    .split("\n")
    .map((line) => line.trimEnd())
    .join("\n")
    .trim();

  return cleaned;
}

function normalizeSeoDescription(text: string): string {
  const cleaned = decodeHtmlEntities(stripCodeFences(text))
    .replace(/^\s*(seo(?:\s+meta)?\s+description)\s*:\s*/i, "")
    .replace(/\r\n?/g, " ")
    .replace(/\s+/g, " ")
    .replace(/^[`"'“”‘’]+|[`"'“”‘’]+$/g, "")
    .trim();

  if (!cleaned) return "";
  if (cleaned.length <= SEO_DESCRIPTION_MAX_CHARS) return cleaned;

  let clipped = cleaned.slice(0, SEO_DESCRIPTION_MAX_CHARS).trim();
  clipped = clipped.replace(/\s+\S*$/, "").trim();
  if (!/[.!?]$/.test(clipped)) clipped = `${clipped}.`;
  return clipped.slice(0, SEO_DESCRIPTION_MAX_CHARS).trim();
}

function deriveSeoDescription(summary: string): string {
  const compact = normalizeSummary(summary)
    .replace(/^\s*(overview|key details|background|why it matters)\s*:?\s*/gim, "")
    .replace(/^\s*[-*•]\s+/gm, "")
    .replace(/\n+/g, " ")
    .replace(/\s+/g, " ")
    .trim();
  return normalizeSeoDescription(compact);
}

function hasRequiredSections(summary: string): boolean {
  const text = summary || "";
  return (
    /^\s*Overview\s*:?\s*/im.test(text) &&
    /^\s*Key Details\s*:?\s*/im.test(text) &&
    /^\s*Background\s*:?\s*/im.test(text) &&
    /^\s*Why It Matters\s*:?\s*/im.test(text)
  );
}

function isSummaryUsable(text: string, bounds?: SummaryLengthBounds): boolean {
  if (!text) return false;
  if (SUMMARY_BOILERPLATE_RE.test(text)) return false;
  if (!hasRequiredSections(text)) return false;
  const words = wordCount(text);
  const minWords = bounds?.minWords ?? SUMMARY_ABSOLUTE_MIN_WORDS;
  const maxWords = bounds?.maxWords ?? SUMMARY_ABSOLUTE_MAX_WORDS;
  return words >= minWords && words <= maxWords;
}

function buildSummaryMessages(
  input: { title: string; url: string; articleText: string },
  bounds: SummaryLengthBounds
): AiMessage[] {
  return [
    {
      role: "system",
      content: [
        "You are a neutral news editor.",
        "Write factually and objectively.",
        "Do not speculate.",
        "Do not reference the original publication.",
        "Do not copy phrasing directly.",
        "Do not reproduce quotes verbatim unless a quote is essential.",
        "Rewrite fully in fresh wording."
      ].join(" ")
    },
    {
      role: "user",
      content: [
        "Rewrite the following article into a comprehensive neutral summary.",
        "",
        "Requirements:",
        `- Approximately ${bounds.targetWords} words (must be between ${bounds.minWords} and ${bounds.maxWords}, about 55-65% of source length)`,
        "- Preserve all key facts, names, dates, locations, and numbers",
        "- Fully self-contained so readers do not need the original article",
        "- Do not invent any details",
        "- Use this exact section order with subheadings:",
        "  1) Overview",
        "  2) Key Details",
        "  3) Background",
        "  4) Why It Matters",
        "- Under Key Details, use concise bullet points",
        "- Do not include markdown code fences",
        "- Also generate a 160-character SEO meta description",
        "",
        "Return ONLY valid JSON with this shape:",
        '{"summary":"<structured summary text>","seo_description":"<160-char SEO meta description>"}',
        "",
        `TITLE: ${input.title}`,
        `URL: ${input.url}`,
        "",
        "ARTICLE:",
        input.articleText.slice(0, 22_000)
      ].join("\n")
    }
  ];
}

function buildRepairMessages(input: {
  title: string;
  url: string;
  articleText: string;
  currentSummary: string;
  currentSeoDescription: string;
  bounds: SummaryLengthBounds;
}): AiMessage[] {
  return [
    {
      role: "system",
      content: [
        "You are a neutral news editor.",
        "Write factually and objectively.",
        "Do not speculate.",
        "Do not copy phrasing directly.",
        "Do not reproduce quotes verbatim unless essential.",
        "Rewrite fully in fresh wording."
      ].join(" ")
    },
    {
      role: "user",
      content: [
        "Repair the draft so it strictly meets every rule.",
        "",
        "Hard constraints:",
        `- Summary must be between ${input.bounds.minWords} and ${input.bounds.maxWords} words (target about ${input.bounds.targetWords})`,
        "- Must include these section headings exactly: Overview, Key Details, Background, Why It Matters",
        "- Key Details must include bullet points",
        "- Preserve all source facts, names, dates, locations, and numbers",
        "- Fully rewritten wording; no publication references",
        "- SEO meta description must be 160 characters or fewer",
        "",
        "Return ONLY valid JSON with this shape:",
        '{"summary":"<structured summary text>","seo_description":"<160-char SEO meta description>"}',
        "",
        `TITLE: ${input.title}`,
        `URL: ${input.url}`,
        "",
        "CURRENT SUMMARY:",
        input.currentSummary.slice(0, 12_000),
        "",
        "CURRENT SEO DESCRIPTION:",
        input.currentSeoDescription.slice(0, 500),
        "",
        "ARTICLE:",
        input.articleText.slice(0, 22_000)
      ].join("\n")
    }
  ];
}

function extractJsonCandidate(input: string): string | null {
  const stripped = stripCodeFences(input);
  const firstBrace = stripped.indexOf("{");
  const lastBrace = stripped.lastIndexOf("}");
  if (firstBrace === -1 || lastBrace === -1 || lastBrace <= firstBrace) return null;
  return stripped.slice(firstBrace, lastBrace + 1).trim();
}

function parseAiRewriteOutput(raw: string): AiRewriteOutput | null {
  const text = (raw || "").trim();
  if (!text) return null;

  const jsonCandidate = extractJsonCandidate(text);
  if (jsonCandidate) {
    try {
      const parsed = JSON.parse(jsonCandidate) as Record<string, unknown>;
      const summary = normalizeSummary(String(parsed.summary || ""));
      const seoDescription = normalizeSeoDescription(
        String(parsed.seo_description || parsed.seoDescription || "")
      );
      if (summary) {
        return {
          summary,
          seoDescription: seoDescription || deriveSeoDescription(summary)
        };
      }
    } catch {
      // fallback parsing below
    }
  }

  const metaLine = text.match(/(?:^|\n)\s*seo(?:\s+meta)?\s+description\s*:\s*(.+)$/im);
  const summary = normalizeSummary(
    metaLine ? text.replace(metaLine[0], "").trim() : text
  );
  if (!summary) return null;

  const seoDescription = normalizeSeoDescription(metaLine?.[1] || "") || deriveSeoDescription(summary);
  return { summary, seoDescription };
}

async function runAiRewrite(
  env: Env,
  model: string,
  messages: AiMessage[],
  maxTokens = 1800
): Promise<AiRewriteOutput | null> {
  try {
    const chatResponse = await env.AI.run(model, {
      messages,
      max_tokens: maxTokens,
      temperature: 0.2
    });
    const parsedChat = parseAiRewriteOutput(parseAiText(chatResponse));
    if (parsedChat) return parsedChat;
  } catch {
    // Some model bindings still expect prompt-style input.
  }

  const prompt = messages.map((message) => `${message.role.toUpperCase()}:\n${message.content}`).join("\n\n");
  const promptResponse = await env.AI.run(model, {
    prompt,
    max_tokens: maxTokens,
    temperature: 0.2
  });

  return parseAiRewriteOutput(parseAiText(promptResponse));
}

export async function getCachedSummary(env: Env, itemId: string): Promise<string | null> {
  const cached = await env.CACHE.get(summaryCacheKey(itemId));
  if (!cached) return null;
  const out = normalizeSummary(cached);
  if (!out) return null;

  if (!isSummaryUsable(out)) return null;
  if (out !== cached.trim()) {
    const ttl = Number(env.SUMMARY_CACHE_TTL_SECONDS || 30 * 24 * 60 * 60);
    await env.CACHE.put(summaryCacheKey(itemId), out, {
      expirationTtl: Number.isFinite(ttl) ? ttl : 30 * 24 * 60 * 60
    });
  }
  return out;
}

export async function getCachedSeoDescription(env: Env, itemId: string): Promise<string | null> {
  const cached = await env.CACHE.get(summarySeoCacheKey(itemId));
  if (!cached) return null;
  const out = normalizeSeoDescription(cached);
  if (!out) return null;

  const ttl = Number(env.SUMMARY_CACHE_TTL_SECONDS || 30 * 24 * 60 * 60);
  if (out !== cached.trim()) {
    await env.CACHE.put(summarySeoCacheKey(itemId), out, {
      expirationTtl: Number.isFinite(ttl) ? ttl : 30 * 24 * 60 * 60
    });
  }
  return out;
}

export async function generateSummaryWithAI(
  env: Env,
  input: {
    itemId: string;
    title: string;
    url: string;
    articleText: string;
  }
): Promise<string | null> {
  if (!input.articleText || input.articleText.trim().length < 300) return null;
  const bounds = summaryLengthBounds(input.articleText);

  const sourceHash = await sha256Hex(`${SUMMARY_PROMPT_VERSION}:${input.articleText.slice(0, 22_000)}`);
  const existing = await d1First<{ summary: string; seo_description: string | null }>(
    env.ky_news_db,
    "SELECT summary, seo_description FROM item_ai_summaries WHERE item_id=? AND source_hash=? LIMIT 1",
    [input.itemId, sourceHash]
  );
  if (existing?.summary) {
    const cleanedSummary = normalizeSummary(existing.summary);
    const cleanedSeo = normalizeSeoDescription(existing.seo_description || "") || deriveSeoDescription(cleanedSummary);
    if (isSummaryUsable(cleanedSummary, bounds)) {
      if (cleanedSummary !== existing.summary || cleanedSeo !== normalizeSeoDescription(existing.seo_description || "")) {
        await d1Run(
          env.ky_news_db,
          "UPDATE item_ai_summaries SET summary=?, seo_description=?, generated_at=datetime('now') WHERE item_id=?",
          [cleanedSummary, cleanedSeo || null, input.itemId]
        );
        await d1Run(env.ky_news_db, "UPDATE items SET summary=?, seo_description=? WHERE id=?", [
          cleanedSummary,
          cleanedSeo || null,
          input.itemId
        ]);
      }
      return cleanedSummary;
    }
  }

  const model = env.AI_MODEL || "@cf/zai-org/glm-4.7-flash";

  try {
    let rewrite = await runAiRewrite(env, model, buildSummaryMessages(input, bounds), 1800);
    if (!rewrite) return null;

    if (!isSummaryUsable(rewrite.summary, bounds)) {
      rewrite = await runAiRewrite(
        env,
        model,
        buildRepairMessages({
          title: input.title,
          url: input.url,
          articleText: input.articleText,
          currentSummary: rewrite.summary,
          currentSeoDescription: rewrite.seoDescription,
          bounds
        }),
        1800
      ) || rewrite;
    }

    const summary = normalizeSummary(rewrite.summary);
    const words = wordCount(summary);
    if (!isSummaryUsable(summary, bounds)) {
      return null;
    }

    const seoDescription = normalizeSeoDescription(rewrite.seoDescription) || deriveSeoDescription(summary);
    const ttl = Number(env.SUMMARY_CACHE_TTL_SECONDS || 30 * 24 * 60 * 60);
    const safeTtl = Number.isFinite(ttl) ? ttl : 30 * 24 * 60 * 60;

    await env.CACHE.put(summaryCacheKey(input.itemId), summary, {
      expirationTtl: safeTtl
    });
    await env.CACHE.put(summarySeoCacheKey(input.itemId), seoDescription, {
      expirationTtl: safeTtl
    });

    await d1Run(
      env.ky_news_db,
      `INSERT INTO item_ai_summaries (item_id, summary, seo_description, model, source_hash, generated_at)
       VALUES (?, ?, ?, ?, ?, datetime('now'))
       ON CONFLICT(item_id) DO UPDATE SET
         summary=excluded.summary,
         seo_description=excluded.seo_description,
         model=excluded.model,
         source_hash=excluded.source_hash,
         generated_at=excluded.generated_at`,
      [input.itemId, summary, seoDescription || null, model, sourceHash]
    );

    await d1Run(env.ky_news_db, "UPDATE items SET summary=?, seo_description=? WHERE id=?", [
      summary,
      seoDescription || null,
      input.itemId
    ]);
    await d1Run(
      env.ky_news_db,
      `
      INSERT INTO summary_review_queue (
        item_id, status, queue_reason, reviewer_email, reviewed_at, reviewed_summary, note, created_at, updated_at
      ) VALUES (?, 'pending', ?, NULL, NULL, NULL, NULL, datetime('now'), datetime('now'))
      ON CONFLICT(item_id) DO UPDATE SET
        status='pending',
        queue_reason=excluded.queue_reason,
        reviewer_email=NULL,
        reviewed_at=NULL,
        reviewed_summary=NULL,
        note=NULL,
        updated_at=datetime('now')
      `,
      [
        input.itemId,
        words < bounds.minWords ? "summary_too_short" : words > bounds.maxWords ? "summary_too_long" : "auto_generated"
      ]
    );

    return summary;
  } catch (err) {
    logError("ai.summary.failed", err, { itemId: input.itemId, model });
    return null;
  }
}

```

# ky-news-worker\src\services\weather.ts

```ts
import { d1All, d1First, d1Run } from "./db";
import { normalizeCounty, safeJsonParse } from "../lib/utils";
import { badGateway, badRequest } from "../lib/errors";
import type { Env } from "../types";

const WEATHER_STATES = ["KY"];

let kyZoneCache: { loadedAt: number; zones: Map<string, string> } = {
  loadedAt: 0,
  zones: new Map<string, string>()
};

async function nwsFetchJson(url: string, userAgent: string): Promise<any> {
  const res = await fetch(url, {
    headers: {
      Accept: "application/geo+json",
      "User-Agent": userAgent
    }
  });

  if (!res.ok) {
    const body = await res.text().catch(() => "");
    throw new Error(`NWS request failed (${res.status}): ${body.slice(0, 240)}`);
  }

  return res.json();
}

function getGeometryCentroid(geometry: any): { lon: number; lat: number } | null {
  const points: Array<[number, number]> = [];

  if (!geometry || !geometry.type || !Array.isArray(geometry.coordinates)) return null;

  if (geometry.type === "Polygon") {
    for (const ring of geometry.coordinates) {
      for (const pair of ring) points.push(pair);
    }
  }

  if (geometry.type === "MultiPolygon") {
    for (const polygon of geometry.coordinates) {
      for (const ring of polygon) {
        for (const pair of ring) points.push(pair);
      }
    }
  }

  const valid = points.filter((pair) => Array.isArray(pair) && pair.length >= 2);
  if (!valid.length) return null;

  let lon = 0;
  let lat = 0;
  for (const [x, y] of valid) {
    lon += Number(x);
    lat += Number(y);
  }

  return { lon: lon / valid.length, lat: lat / valid.length };
}

async function getKyCountyZoneMap(userAgent: string): Promise<Map<string, string>> {
  const now = Date.now();
  if (now - kyZoneCache.loadedAt < 6 * 60 * 60 * 1000 && kyZoneCache.zones.size) {
    return kyZoneCache.zones;
  }

  const zones = new Map<string, string>();
  let nextUrl: string | null = "https://api.weather.gov/zones?type=county&area=KY";
  let guard = 0;

  while (nextUrl && guard < 10) {
    guard += 1;
    const payload = await nwsFetchJson(nextUrl, userAgent);
    const features = Array.isArray(payload?.features) ? payload.features : [];

    for (const feature of features) {
      const props = feature?.properties || {};
      const zoneId = props.id;
      const zoneName = normalizeCounty(props.name || "");
      if (!zoneId || !zoneName) continue;
      zones.set(zoneName.toLowerCase(), zoneId);
    }

    nextUrl = payload?.pagination?.next || null;
  }

  kyZoneCache = { loadedAt: now, zones };
  return zones;
}

async function fetchCountyForecast(county: string, userAgent: string): Promise<Record<string, unknown>> {
  const countyKey = normalizeCounty(county).toLowerCase();
  if (!countyKey) throw new Error("County is required");

  const zones = await getKyCountyZoneMap(userAgent);
  const countyZoneId = zones.get(countyKey);
  if (!countyZoneId) throw new Error(`No NWS county zone found for ${county}`);

  const countyZone = await nwsFetchJson(`https://api.weather.gov/zones/county/${countyZoneId}`, userAgent);
  const geometry = countyZone?.geometry;
  const centroid = getGeometryCentroid(geometry);
  if (!centroid) throw new Error(`No geometry centroid for county zone ${countyZoneId}`);

  const points = await nwsFetchJson(
    `https://api.weather.gov/points/${centroid.lat.toFixed(4)},${centroid.lon.toFixed(4)}`,
    userAgent
  );

  const forecastUrl = String(points?.properties?.forecast || "");
  if (!forecastUrl) throw new Error(`No forecast URL returned for county zone ${countyZoneId}`);

  const forecastZoneUri = String(points?.properties?.forecastZone || "");
  const forecastZoneId = forecastZoneUri.split("/").filter(Boolean).pop() || countyZoneId;

  const payload = await nwsFetchJson(forecastUrl, userAgent);
  const props = payload?.properties || {};
  const periodsRaw = Array.isArray(props.periods) ? props.periods : [];

  const periods = periodsRaw.slice(0, 14).map((p: any) => ({
    name: p.name,
    startTime: p.startTime,
    endTime: p.endTime,
    temperature: p.temperature,
    temperatureUnit: p.temperatureUnit,
    windSpeed: p.windSpeed,
    windDirection: p.windDirection,
    shortForecast: p.shortForecast,
    detailedForecast: p.detailedForecast,
    icon: p.icon
  }));

  return {
    state: "KY",
    county: normalizeCounty(county),
    zoneId: forecastZoneId,
    countyZoneId,
    updatedAt: props.updated || new Date().toISOString(),
    periods,
    source: "api.weather.gov"
  };
}

async function fetchCountyAlerts(stateCode: string, county: string | null, userAgent: string): Promise<any[]> {
  const payload = await nwsFetchJson(`https://api.weather.gov/alerts/active?area=${encodeURIComponent(stateCode)}`, userAgent);
  const features = Array.isArray(payload?.features) ? payload.features : [];
  const countyFilter = county ? normalizeCounty(county).toLowerCase() : null;

  const alerts: any[] = [];
  for (const feature of features) {
    const props = feature?.properties || {};
    const areaDesc = String(props.areaDesc || "").toLowerCase();
    if (countyFilter && !areaDesc.includes(countyFilter)) continue;

    alerts.push({
      id: String(feature.id || props.id || ""),
      event: props.event || "Unknown",
      severity: props.severity || "Unknown",
      headline: props.headline || props.event || "Alert",
      description: props.description || "",
      instruction: props.instruction || "",
      starts_at: props.onset || props.effective || null,
      ends_at: props.ends || props.expires || null,
      sent_at: props.sent || null,
      status: props.status || null,
      url: props.url || null,
      area_desc: props.areaDesc || ""
    });
  }

  return alerts;
}

export async function getWeatherForecast(
  env: Env,
  input: { state: string; county: string }
): Promise<Record<string, unknown>> {
  const stateCode = input.state.toUpperCase();
  if (!WEATHER_STATES.includes(stateCode)) {
    badRequest("Weather forecast currently supports KY only");
  }

  const county = normalizeCounty(input.county);
  const userAgent = env.NWS_USER_AGENT || "EasternKentuckyNews/1.0 (ops@example.com)";

  const cached = await d1First<{ forecast_json: string; fetched_at: string; expires_at: string }>(
    env.ky_news_db,
    `
    SELECT forecast_json, fetched_at, expires_at
    FROM weather_forecasts
    WHERE state_code=? AND county=?
    ORDER BY fetched_at DESC
    LIMIT 1
    `,
    ["KY", county]
  );

  const now = Date.now();
  const cachedExpiry = cached?.expires_at ? new Date(cached.expires_at).getTime() : 0;
  if (cached && Number.isFinite(cachedExpiry) && cachedExpiry > now) {
    return {
      ...safeJsonParse(cached.forecast_json, {}),
      fetchedAt: cached.fetched_at,
      expiresAt: cached.expires_at,
      cached: true
    };
  }

  try {
    const live = await fetchCountyForecast(county, userAgent);
    const expiresAt = new Date(Date.now() + 60 * 60 * 1000).toISOString();

    await d1Run(
      env.ky_news_db,
      "INSERT INTO weather_forecasts (state_code, county, forecast_json, expires_at) VALUES (?, ?, ?, ?)",
      ["KY", county, JSON.stringify(live), expiresAt]
    );

    await d1Run(env.ky_news_db, "DELETE FROM weather_forecasts WHERE fetched_at < datetime('now', '-7 days')");

    return {
      ...live,
      fetchedAt: new Date().toISOString(),
      expiresAt,
      cached: false
    };
  } catch (err) {
    if (cached) {
      return {
        ...safeJsonParse(cached.forecast_json, {}),
        fetchedAt: cached.fetched_at,
        expiresAt: cached.expires_at,
        cached: true,
        stale: true,
        warning: err instanceof Error ? err.message : String(err)
      };
    }

    badGateway(err instanceof Error ? err.message : String(err));
  }
}

export async function getWeatherAlerts(
  env: Env,
  input: { state: string; county?: string }
): Promise<Record<string, unknown>> {
  const stateCode = input.state.toUpperCase();
  const normalizedCounty = input.county ? normalizeCounty(input.county) : "";

  if (!WEATHER_STATES.includes(stateCode)) {
    badRequest("Weather alerts currently support KY only");
  }

  const userAgent = env.NWS_USER_AGENT || "EasternKentuckyNews/1.0 (ops@example.com)";

  try {
    const liveAlerts = await fetchCountyAlerts(stateCode, normalizedCounty || null, userAgent);

    await d1Run(env.ky_news_db, "DELETE FROM weather_alerts WHERE state_code=? AND county=?", [stateCode, normalizedCounty]);

    for (const alert of liveAlerts) {
      await d1Run(
        env.ky_news_db,
        `
        INSERT INTO weather_alerts (
          alert_id, state_code, county, severity, event, headline, starts_at, ends_at, raw_json
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        `,
        [
          alert.id,
          stateCode,
          normalizedCounty,
          alert.severity,
          alert.event,
          alert.headline,
          alert.starts_at,
          alert.ends_at,
          JSON.stringify(alert)
        ]
      );
    }

    await d1Run(env.ky_news_db, "DELETE FROM weather_alerts WHERE fetched_at < datetime('now', '-48 hours')");

    return {
      state: stateCode,
      county: normalizedCounty || null,
      alerts: liveAlerts,
      fetchedAt: new Date().toISOString(),
      source: "api.weather.gov"
    };
  } catch (err) {
    const rows = await d1All<{ raw_json: string }>(
      env.ky_news_db,
      `
      SELECT raw_json
      FROM weather_alerts
      WHERE state_code=? AND county=?
      ORDER BY fetched_at DESC
      LIMIT 100
      `,
      [stateCode, normalizedCounty]
    );

    if (rows.length) {
      return {
        state: stateCode,
        county: normalizedCounty || null,
        alerts: rows.map((r) => safeJsonParse(r.raw_json, null)).filter(Boolean),
        stale: true,
        warning: err instanceof Error ? err.message : String(err)
      };
    }

    badGateway(err instanceof Error ? err.message : String(err));
  }
}

```

# ky-news-worker\src\types.ts

```ts
import type { Context } from "hono";

export type NewsScope = "ky" | "national" | "all";

export interface WorkersAI {
  run(model: string, inputs: Record<string, unknown>): Promise<unknown>;
}

export interface Env {
  ky_news_db: D1Database;
  ky_news_media: R2Bucket;
  CACHE: KVNamespace;
  AI: WorkersAI;
  APP_NAME?: string;
  NWS_USER_AGENT?: string;
  ADMIN_TOKEN?: string;
  ADMIN_EMAIL?: string;
  DATA_ENCRYPTION_KEY?: string;
  REQUIRE_TURNSTILE?: string;
  LOST_FOUND_AUTO_APPROVE?: string;
  RSS_USER_AGENT?: string;
  AI_MODEL?: string;
  SUMMARY_CACHE_TTL_SECONDS?: string;
  MAX_INGEST_ITEMS_PER_FEED?: string;
  MAX_FEEDS_PER_RUN?: string;
  CORS_ORIGINS?: string;
  API_CACHE_TTL_SECONDS?: string;
  LOG_TTL_SECONDS?: string;
  ERROR_EVENT_TTL_DAYS?: string;
  RATE_LIMIT_READ_PER_MIN?: string;
  RATE_LIMIT_WRITE_PER_MIN?: string;
  RATE_LIMIT_ADMIN_PER_MIN?: string;
  BOT_SCORE_MIN?: string;
  ADMIN_EMAILS?: string;
  EDITOR_EMAILS?: string;
  // Optional Facebook session cookie to authenticate mbasic.facebook.com scraping.
  // Set this in wrangler.jsonc secrets when Facebook pages require a logged-in session.
  FACEBOOK_SESSION_COOKIE?: string;
}

export type AppBindings = {
  Bindings: Env;
  Variables: {
    requestId: string;
    startTime: number;
    actorEmail?: string;
  };
};

export type AppContext = Context<AppBindings>;

export interface AdminIdentity {
  email: string;
  source: "cloudflare-access" | "admin-token";
  role: "admin" | "editor";
}

```

# ky-news-worker\test\env.d.ts

```ts
declare module 'cloudflare:test' {
	interface ProvidedEnv extends Env {}
}

```

# ky-news-worker\test\index.spec.ts

```ts
import { env, createExecutionContext, waitOnExecutionContext, SELF } from 'cloudflare:test';
import { describe, it, expect } from 'vitest';
import worker from '../src/index';

// For now, you'll need to do something like this to get a correctly-typed
// `Request` to pass to `worker.fetch()`.
const IncomingRequest = Request<unknown, IncomingRequestCfProperties>;

describe('EKY News worker', () => {
	it('responds with health payload (unit style)', async () => {
		const request = new IncomingRequest('http://example.com/api/health');
		// Create an empty context to pass to `worker.fetch()`.
		const ctx = createExecutionContext();
		const response = await worker.fetch(request, env, ctx);
		// Wait for all `Promise`s passed to `ctx.waitUntil()` to settle before running test assertions
		await waitOnExecutionContext(ctx);
		const data = await response.json();
		expect(response.status).toBe(200);
		expect(data.ok).toBe(true);
		expect(typeof data.now).toBe('string');
	});

	it('responds with health payload (integration style)', async () => {
		const response = await SELF.fetch('https://example.com/api/health');
		const data = await response.json();
		expect(response.status).toBe(200);
		expect(data.ok).toBe(true);
	});
});

```

# ky-news-worker\test\relevance.spec.ts

```ts
import { describe, expect, it } from "vitest";
import { isKentuckyRelevant } from "../src/services/relevance";

describe("isKentuckyRelevant", () => {
  it("passes Tier 1 when title has strong Kentucky signal", () => {
    const result = isKentuckyRelevant("Kentucky lawmakers debate school funding", "");
    expect(result.relevant).toBe(true);
    expect(result.matchedTier).toBe("tier1_title");
  });

  it("fails Tier 3 for ambiguous city without Kentucky context", () => {
    const result = isKentuckyRelevant("Lexington city council vote", "Council members met Tuesday.");
    expect(result.relevant).toBe(false);
    expect(result.failedTier).toBe("tier3_ambiguous_city");
  });

  it("passes Tier 2 with at least two Kentucky-related body mentions", () => {
    const result = isKentuckyRelevant("Regional update", "Frankfort officials joined Kentucky emergency teams.");
    expect(result.relevant).toBe(true);
    expect(result.matchedTier).toBe("tier2_body");
  });

  it("fails Tier 2 with only one body mention", () => {
    const result = isKentuckyRelevant("Regional update", "Officials in Frankfort met Tuesday.");
    expect(result.relevant).toBe(false);
    expect(result.failedTier).toBe("tier2_body");
  });
});

```

# ky-news-worker\test\tsconfig.json

```json
{
	"extends": "../tsconfig.json",
	"compilerOptions": {
		"types": ["@cloudflare/vitest-pool-workers"]
	},
	"include": ["./**/*.ts", "../worker-configuration.d.ts"],
	"exclude": []
}

```

# ky-news-worker\tsconfig.json

```json
{
	"compilerOptions": {
		/* Visit https://aka.ms/tsconfig.json to read more about this file */

		/* Set the JavaScript language version for emitted JavaScript and include compatible library declarations. */
		"target": "es2024",
		/* Specify a set of bundled library declaration files that describe the target runtime environment. */
		"lib": ["es2024"],
		/* Specify what JSX code is generated. */
		"jsx": "react-jsx",

		/* Specify what module code is generated. */
		"module": "es2022",
		/* Specify how TypeScript looks up a file from a given module specifier. */
		"moduleResolution": "Bundler",
		/* Enable importing .json files */
		"resolveJsonModule": true,

		/* Allow JavaScript files to be a part of your program. Use the `checkJS` option to get errors from these files. */
		"allowJs": true,
		/* Enable error reporting in type-checked JavaScript files. */
		"checkJs": false,

		/* Disable emitting files from a compilation. */
		"noEmit": true,

		/* Ensure that each file can be safely transpiled without relying on other imports. */
		"isolatedModules": true,
		/* Allow 'import x from y' when a module doesn't have a default export. */
		"allowSyntheticDefaultImports": true,
		/* Ensure that casing is correct in imports. */
		"forceConsistentCasingInFileNames": true,

		/* Enable all strict type-checking options. */
		"strict": true,

		/* Skip type checking all .d.ts files. */
		"skipLibCheck": true,
		"types": [
			"./worker-configuration.d.ts",
			"node"
		]
	},
	"exclude": ["test"],
	"include": ["worker-configuration.d.ts", "src/**/*.ts"]
}

```

# ky-news-worker\vitest.config.mts

```mts
import { defineWorkersConfig } from '@cloudflare/vitest-pool-workers/config';

export default defineWorkersConfig({
	test: {
		poolOptions: {
			workers: {
				wrangler: { configPath: './wrangler.jsonc' },
			},
		},
	},
});

```

# ky-news-worker\worker-configuration.d.ts

```ts
/* eslint-disable */
// Generated by Wrangler by running `wrangler types` (hash: c47419062cb5f531b4eabdea1f4cd37d)
// Runtime types generated with workerd@1.20260219.0 2026-02-19 nodejs_compat
declare namespace Cloudflare {
	interface GlobalProps {
		mainModule: typeof import("./src/index");
	}
	interface Env {
		CACHE: KVNamespace;
		ky_news_media: R2Bucket;
		ky_news_db: D1Database;
		AI: Ai;
		APP_NAME: "EKY News";
		NWS_USER_AGENT: "EKY-News-Worker/1.0 (ops@example.com)";
		AI_MODEL: "@cf/zai-org/glm-4.7-flash";
		SUMMARY_CACHE_TTL_SECONDS: "2592000";
		MAX_INGEST_ITEMS_PER_FEED: "60";
		MAX_FEEDS_PER_RUN: "200";
		API_CACHE_TTL_SECONDS: "120";
		LOG_TTL_SECONDS: "1209600";
		ERROR_EVENT_TTL_DAYS: "30";
		RATE_LIMIT_READ_PER_MIN: "240";
		RATE_LIMIT_WRITE_PER_MIN: "60";
		RATE_LIMIT_ADMIN_PER_MIN: "90";
		BOT_SCORE_MIN: "18";
	}
}
interface Env extends Cloudflare.Env {}
type StringifyValues<EnvType extends Record<string, unknown>> = {
	[Binding in keyof EnvType]: EnvType[Binding] extends string ? EnvType[Binding] : string;
};
declare namespace NodeJS {
	interface ProcessEnv extends StringifyValues<Pick<Cloudflare.Env, "APP_NAME" | "NWS_USER_AGENT" | "AI_MODEL" | "SUMMARY_CACHE_TTL_SECONDS" | "MAX_INGEST_ITEMS_PER_FEED" | "MAX_FEEDS_PER_RUN" | "API_CACHE_TTL_SECONDS" | "LOG_TTL_SECONDS" | "ERROR_EVENT_TTL_DAYS" | "RATE_LIMIT_READ_PER_MIN" | "RATE_LIMIT_WRITE_PER_MIN" | "RATE_LIMIT_ADMIN_PER_MIN" | "BOT_SCORE_MIN">> {}
}

// Begin runtime types
/*! *****************************************************************************
Copyright (c) Cloudflare. All rights reserved.
Copyright (c) Microsoft Corporation. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0
THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.
See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
/* eslint-disable */
// noinspection JSUnusedGlobalSymbols
declare var onmessage: never;
/**
 * The **`DOMException`** interface represents an abnormal event (called an **exception**) that occurs as a result of calling a method or accessing a property of a web API.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/DOMException)
 */
declare class DOMException extends Error {
    constructor(message?: string, name?: string);
    /**
     * The **`message`** read-only property of the a message or description associated with the given error name.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/DOMException/message)
     */
    readonly message: string;
    /**
     * The **`name`** read-only property of the one of the strings associated with an error name.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/DOMException/name)
     */
    readonly name: string;
    /**
     * The **`code`** read-only property of the DOMException interface returns one of the legacy error code constants, or `0` if none match.
     * @deprecated
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/DOMException/code)
     */
    readonly code: number;
    static readonly INDEX_SIZE_ERR: number;
    static readonly DOMSTRING_SIZE_ERR: number;
    static readonly HIERARCHY_REQUEST_ERR: number;
    static readonly WRONG_DOCUMENT_ERR: number;
    static readonly INVALID_CHARACTER_ERR: number;
    static readonly NO_DATA_ALLOWED_ERR: number;
    static readonly NO_MODIFICATION_ALLOWED_ERR: number;
    static readonly NOT_FOUND_ERR: number;
    static readonly NOT_SUPPORTED_ERR: number;
    static readonly INUSE_ATTRIBUTE_ERR: number;
    static readonly INVALID_STATE_ERR: number;
    static readonly SYNTAX_ERR: number;
    static readonly INVALID_MODIFICATION_ERR: number;
    static readonly NAMESPACE_ERR: number;
    static readonly INVALID_ACCESS_ERR: number;
    static readonly VALIDATION_ERR: number;
    static readonly TYPE_MISMATCH_ERR: number;
    static readonly SECURITY_ERR: number;
    static readonly NETWORK_ERR: number;
    static readonly ABORT_ERR: number;
    static readonly URL_MISMATCH_ERR: number;
    static readonly QUOTA_EXCEEDED_ERR: number;
    static readonly TIMEOUT_ERR: number;
    static readonly INVALID_NODE_TYPE_ERR: number;
    static readonly DATA_CLONE_ERR: number;
    get stack(): any;
    set stack(value: any);
}
type WorkerGlobalScopeEventMap = {
    fetch: FetchEvent;
    scheduled: ScheduledEvent;
    queue: QueueEvent;
    unhandledrejection: PromiseRejectionEvent;
    rejectionhandled: PromiseRejectionEvent;
};
declare abstract class WorkerGlobalScope extends EventTarget<WorkerGlobalScopeEventMap> {
    EventTarget: typeof EventTarget;
}
/* The **`console`** object provides access to the debugging console (e.g., the Web console in Firefox). *
 * The **`console`** object provides access to the debugging console (e.g., the Web console in Firefox).
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console)
 */
interface Console {
    "assert"(condition?: boolean, ...data: any[]): void;
    /**
     * The **`console.clear()`** static method clears the console if possible.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/clear_static)
     */
    clear(): void;
    /**
     * The **`console.count()`** static method logs the number of times that this particular call to `count()` has been called.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/count_static)
     */
    count(label?: string): void;
    /**
     * The **`console.countReset()`** static method resets counter used with console/count_static.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/countReset_static)
     */
    countReset(label?: string): void;
    /**
     * The **`console.debug()`** static method outputs a message to the console at the 'debug' log level.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/debug_static)
     */
    debug(...data: any[]): void;
    /**
     * The **`console.dir()`** static method displays a list of the properties of the specified JavaScript object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/dir_static)
     */
    dir(item?: any, options?: any): void;
    /**
     * The **`console.dirxml()`** static method displays an interactive tree of the descendant elements of the specified XML/HTML element.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/dirxml_static)
     */
    dirxml(...data: any[]): void;
    /**
     * The **`console.error()`** static method outputs a message to the console at the 'error' log level.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/error_static)
     */
    error(...data: any[]): void;
    /**
     * The **`console.group()`** static method creates a new inline group in the Web console log, causing any subsequent console messages to be indented by an additional level, until console/groupEnd_static is called.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/group_static)
     */
    group(...data: any[]): void;
    /**
     * The **`console.groupCollapsed()`** static method creates a new inline group in the console.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/groupCollapsed_static)
     */
    groupCollapsed(...data: any[]): void;
    /**
     * The **`console.groupEnd()`** static method exits the current inline group in the console.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/groupEnd_static)
     */
    groupEnd(): void;
    /**
     * The **`console.info()`** static method outputs a message to the console at the 'info' log level.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/info_static)
     */
    info(...data: any[]): void;
    /**
     * The **`console.log()`** static method outputs a message to the console.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/log_static)
     */
    log(...data: any[]): void;
    /**
     * The **`console.table()`** static method displays tabular data as a table.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/table_static)
     */
    table(tabularData?: any, properties?: string[]): void;
    /**
     * The **`console.time()`** static method starts a timer you can use to track how long an operation takes.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/time_static)
     */
    time(label?: string): void;
    /**
     * The **`console.timeEnd()`** static method stops a timer that was previously started by calling console/time_static.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/timeEnd_static)
     */
    timeEnd(label?: string): void;
    /**
     * The **`console.timeLog()`** static method logs the current value of a timer that was previously started by calling console/time_static.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/timeLog_static)
     */
    timeLog(label?: string, ...data: any[]): void;
    timeStamp(label?: string): void;
    /**
     * The **`console.trace()`** static method outputs a stack trace to the console.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/trace_static)
     */
    trace(...data: any[]): void;
    /**
     * The **`console.warn()`** static method outputs a warning message to the console at the 'warning' log level.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/console/warn_static)
     */
    warn(...data: any[]): void;
}
declare const console: Console;
type BufferSource = ArrayBufferView | ArrayBuffer;
type TypedArray = Int8Array | Uint8Array | Uint8ClampedArray | Int16Array | Uint16Array | Int32Array | Uint32Array | Float32Array | Float64Array | BigInt64Array | BigUint64Array;
declare namespace WebAssembly {
    class CompileError extends Error {
        constructor(message?: string);
    }
    class RuntimeError extends Error {
        constructor(message?: string);
    }
    type ValueType = "anyfunc" | "externref" | "f32" | "f64" | "i32" | "i64" | "v128";
    interface GlobalDescriptor {
        value: ValueType;
        mutable?: boolean;
    }
    class Global {
        constructor(descriptor: GlobalDescriptor, value?: any);
        value: any;
        valueOf(): any;
    }
    type ImportValue = ExportValue | number;
    type ModuleImports = Record<string, ImportValue>;
    type Imports = Record<string, ModuleImports>;
    type ExportValue = Function | Global | Memory | Table;
    type Exports = Record<string, ExportValue>;
    class Instance {
        constructor(module: Module, imports?: Imports);
        readonly exports: Exports;
    }
    interface MemoryDescriptor {
        initial: number;
        maximum?: number;
        shared?: boolean;
    }
    class Memory {
        constructor(descriptor: MemoryDescriptor);
        readonly buffer: ArrayBuffer;
        grow(delta: number): number;
    }
    type ImportExportKind = "function" | "global" | "memory" | "table";
    interface ModuleExportDescriptor {
        kind: ImportExportKind;
        name: string;
    }
    interface ModuleImportDescriptor {
        kind: ImportExportKind;
        module: string;
        name: string;
    }
    abstract class Module {
        static customSections(module: Module, sectionName: string): ArrayBuffer[];
        static exports(module: Module): ModuleExportDescriptor[];
        static imports(module: Module): ModuleImportDescriptor[];
    }
    type TableKind = "anyfunc" | "externref";
    interface TableDescriptor {
        element: TableKind;
        initial: number;
        maximum?: number;
    }
    class Table {
        constructor(descriptor: TableDescriptor, value?: any);
        readonly length: number;
        get(index: number): any;
        grow(delta: number, value?: any): number;
        set(index: number, value?: any): void;
    }
    function instantiate(module: Module, imports?: Imports): Promise<Instance>;
    function validate(bytes: BufferSource): boolean;
}
/**
 * The **`ServiceWorkerGlobalScope`** interface of the Service Worker API represents the global execution context of a service worker.
 * Available only in secure contexts.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ServiceWorkerGlobalScope)
 */
interface ServiceWorkerGlobalScope extends WorkerGlobalScope {
    DOMException: typeof DOMException;
    WorkerGlobalScope: typeof WorkerGlobalScope;
    btoa(data: string): string;
    atob(data: string): string;
    setTimeout(callback: (...args: any[]) => void, msDelay?: number): number;
    setTimeout<Args extends any[]>(callback: (...args: Args) => void, msDelay?: number, ...args: Args): number;
    clearTimeout(timeoutId: number | null): void;
    setInterval(callback: (...args: any[]) => void, msDelay?: number): number;
    setInterval<Args extends any[]>(callback: (...args: Args) => void, msDelay?: number, ...args: Args): number;
    clearInterval(timeoutId: number | null): void;
    queueMicrotask(task: Function): void;
    structuredClone<T>(value: T, options?: StructuredSerializeOptions): T;
    reportError(error: any): void;
    fetch(input: RequestInfo | URL, init?: RequestInit<RequestInitCfProperties>): Promise<Response>;
    self: ServiceWorkerGlobalScope;
    crypto: Crypto;
    caches: CacheStorage;
    scheduler: Scheduler;
    performance: Performance;
    Cloudflare: Cloudflare;
    readonly origin: string;
    Event: typeof Event;
    ExtendableEvent: typeof ExtendableEvent;
    CustomEvent: typeof CustomEvent;
    PromiseRejectionEvent: typeof PromiseRejectionEvent;
    FetchEvent: typeof FetchEvent;
    TailEvent: typeof TailEvent;
    TraceEvent: typeof TailEvent;
    ScheduledEvent: typeof ScheduledEvent;
    MessageEvent: typeof MessageEvent;
    CloseEvent: typeof CloseEvent;
    ReadableStreamDefaultReader: typeof ReadableStreamDefaultReader;
    ReadableStreamBYOBReader: typeof ReadableStreamBYOBReader;
    ReadableStream: typeof ReadableStream;
    WritableStream: typeof WritableStream;
    WritableStreamDefaultWriter: typeof WritableStreamDefaultWriter;
    TransformStream: typeof TransformStream;
    ByteLengthQueuingStrategy: typeof ByteLengthQueuingStrategy;
    CountQueuingStrategy: typeof CountQueuingStrategy;
    ErrorEvent: typeof ErrorEvent;
    MessageChannel: typeof MessageChannel;
    MessagePort: typeof MessagePort;
    EventSource: typeof EventSource;
    ReadableStreamBYOBRequest: typeof ReadableStreamBYOBRequest;
    ReadableStreamDefaultController: typeof ReadableStreamDefaultController;
    ReadableByteStreamController: typeof ReadableByteStreamController;
    WritableStreamDefaultController: typeof WritableStreamDefaultController;
    TransformStreamDefaultController: typeof TransformStreamDefaultController;
    CompressionStream: typeof CompressionStream;
    DecompressionStream: typeof DecompressionStream;
    TextEncoderStream: typeof TextEncoderStream;
    TextDecoderStream: typeof TextDecoderStream;
    Headers: typeof Headers;
    Body: typeof Body;
    Request: typeof Request;
    Response: typeof Response;
    WebSocket: typeof WebSocket;
    WebSocketPair: typeof WebSocketPair;
    WebSocketRequestResponsePair: typeof WebSocketRequestResponsePair;
    AbortController: typeof AbortController;
    AbortSignal: typeof AbortSignal;
    TextDecoder: typeof TextDecoder;
    TextEncoder: typeof TextEncoder;
    navigator: Navigator;
    Navigator: typeof Navigator;
    URL: typeof URL;
    URLSearchParams: typeof URLSearchParams;
    URLPattern: typeof URLPattern;
    Blob: typeof Blob;
    File: typeof File;
    FormData: typeof FormData;
    Crypto: typeof Crypto;
    SubtleCrypto: typeof SubtleCrypto;
    CryptoKey: typeof CryptoKey;
    CacheStorage: typeof CacheStorage;
    Cache: typeof Cache;
    FixedLengthStream: typeof FixedLengthStream;
    IdentityTransformStream: typeof IdentityTransformStream;
    HTMLRewriter: typeof HTMLRewriter;
}
declare function addEventListener<Type extends keyof WorkerGlobalScopeEventMap>(type: Type, handler: EventListenerOrEventListenerObject<WorkerGlobalScopeEventMap[Type]>, options?: EventTargetAddEventListenerOptions | boolean): void;
declare function removeEventListener<Type extends keyof WorkerGlobalScopeEventMap>(type: Type, handler: EventListenerOrEventListenerObject<WorkerGlobalScopeEventMap[Type]>, options?: EventTargetEventListenerOptions | boolean): void;
/**
 * The **`dispatchEvent()`** method of the EventTarget sends an Event to the object, (synchronously) invoking the affected event listeners in the appropriate order.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventTarget/dispatchEvent)
 */
declare function dispatchEvent(event: WorkerGlobalScopeEventMap[keyof WorkerGlobalScopeEventMap]): boolean;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/btoa) */
declare function btoa(data: string): string;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/atob) */
declare function atob(data: string): string;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/setTimeout) */
declare function setTimeout(callback: (...args: any[]) => void, msDelay?: number): number;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/setTimeout) */
declare function setTimeout<Args extends any[]>(callback: (...args: Args) => void, msDelay?: number, ...args: Args): number;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/clearTimeout) */
declare function clearTimeout(timeoutId: number | null): void;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/setInterval) */
declare function setInterval(callback: (...args: any[]) => void, msDelay?: number): number;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/setInterval) */
declare function setInterval<Args extends any[]>(callback: (...args: Args) => void, msDelay?: number, ...args: Args): number;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/clearInterval) */
declare function clearInterval(timeoutId: number | null): void;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/queueMicrotask) */
declare function queueMicrotask(task: Function): void;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/structuredClone) */
declare function structuredClone<T>(value: T, options?: StructuredSerializeOptions): T;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/reportError) */
declare function reportError(error: any): void;
/* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Window/fetch) */
declare function fetch(input: RequestInfo | URL, init?: RequestInit<RequestInitCfProperties>): Promise<Response>;
declare const self: ServiceWorkerGlobalScope;
/**
* The Web Crypto API provides a set of low-level functions for common cryptographic tasks.
* The Workers runtime implements the full surface of this API, but with some differences in
* the [supported algorithms](https://developers.cloudflare.com/workers/runtime-apis/web-crypto/#supported-algorithms)
* compared to those implemented in most browsers.
*
* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/web-crypto/)
*/
declare const crypto: Crypto;
/**
* The Cache API allows fine grained control of reading and writing from the Cloudflare global network cache.
*
* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/cache/)
*/
declare const caches: CacheStorage;
declare const scheduler: Scheduler;
/**
* The Workers runtime supports a subset of the Performance API, used to measure timing and performance,
* as well as timing of subrequests and other operations.
*
* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/performance/)
*/
declare const performance: Performance;
declare const Cloudflare: Cloudflare;
declare const origin: string;
declare const navigator: Navigator;
interface TestController {
}
interface ExecutionContext<Props = unknown> {
    waitUntil(promise: Promise<any>): void;
    passThroughOnException(): void;
    readonly exports: Cloudflare.Exports;
    readonly props: Props;
}
type ExportedHandlerFetchHandler<Env = unknown, CfHostMetadata = unknown> = (request: Request<CfHostMetadata, IncomingRequestCfProperties<CfHostMetadata>>, env: Env, ctx: ExecutionContext) => Response | Promise<Response>;
type ExportedHandlerTailHandler<Env = unknown> = (events: TraceItem[], env: Env, ctx: ExecutionContext) => void | Promise<void>;
type ExportedHandlerTraceHandler<Env = unknown> = (traces: TraceItem[], env: Env, ctx: ExecutionContext) => void | Promise<void>;
type ExportedHandlerTailStreamHandler<Env = unknown> = (event: TailStream.TailEvent<TailStream.Onset>, env: Env, ctx: ExecutionContext) => TailStream.TailEventHandlerType | Promise<TailStream.TailEventHandlerType>;
type ExportedHandlerScheduledHandler<Env = unknown> = (controller: ScheduledController, env: Env, ctx: ExecutionContext) => void | Promise<void>;
type ExportedHandlerQueueHandler<Env = unknown, Message = unknown> = (batch: MessageBatch<Message>, env: Env, ctx: ExecutionContext) => void | Promise<void>;
type ExportedHandlerTestHandler<Env = unknown> = (controller: TestController, env: Env, ctx: ExecutionContext) => void | Promise<void>;
interface ExportedHandler<Env = unknown, QueueHandlerMessage = unknown, CfHostMetadata = unknown> {
    fetch?: ExportedHandlerFetchHandler<Env, CfHostMetadata>;
    tail?: ExportedHandlerTailHandler<Env>;
    trace?: ExportedHandlerTraceHandler<Env>;
    tailStream?: ExportedHandlerTailStreamHandler<Env>;
    scheduled?: ExportedHandlerScheduledHandler<Env>;
    test?: ExportedHandlerTestHandler<Env>;
    email?: EmailExportedHandler<Env>;
    queue?: ExportedHandlerQueueHandler<Env, QueueHandlerMessage>;
}
interface StructuredSerializeOptions {
    transfer?: any[];
}
declare abstract class Navigator {
    sendBeacon(url: string, body?: BodyInit): boolean;
    readonly userAgent: string;
    readonly hardwareConcurrency: number;
    readonly language: string;
    readonly languages: string[];
}
interface AlarmInvocationInfo {
    readonly isRetry: boolean;
    readonly retryCount: number;
}
interface Cloudflare {
    readonly compatibilityFlags: Record<string, boolean>;
}
interface DurableObject {
    fetch(request: Request): Response | Promise<Response>;
    alarm?(alarmInfo?: AlarmInvocationInfo): void | Promise<void>;
    webSocketMessage?(ws: WebSocket, message: string | ArrayBuffer): void | Promise<void>;
    webSocketClose?(ws: WebSocket, code: number, reason: string, wasClean: boolean): void | Promise<void>;
    webSocketError?(ws: WebSocket, error: unknown): void | Promise<void>;
}
type DurableObjectStub<T extends Rpc.DurableObjectBranded | undefined = undefined> = Fetcher<T, "alarm" | "webSocketMessage" | "webSocketClose" | "webSocketError"> & {
    readonly id: DurableObjectId;
    readonly name?: string;
};
interface DurableObjectId {
    toString(): string;
    equals(other: DurableObjectId): boolean;
    readonly name?: string;
}
declare abstract class DurableObjectNamespace<T extends Rpc.DurableObjectBranded | undefined = undefined> {
    newUniqueId(options?: DurableObjectNamespaceNewUniqueIdOptions): DurableObjectId;
    idFromName(name: string): DurableObjectId;
    idFromString(id: string): DurableObjectId;
    get(id: DurableObjectId, options?: DurableObjectNamespaceGetDurableObjectOptions): DurableObjectStub<T>;
    getByName(name: string, options?: DurableObjectNamespaceGetDurableObjectOptions): DurableObjectStub<T>;
    jurisdiction(jurisdiction: DurableObjectJurisdiction): DurableObjectNamespace<T>;
}
type DurableObjectJurisdiction = "eu" | "fedramp" | "fedramp-high";
interface DurableObjectNamespaceNewUniqueIdOptions {
    jurisdiction?: DurableObjectJurisdiction;
}
type DurableObjectLocationHint = "wnam" | "enam" | "sam" | "weur" | "eeur" | "apac" | "oc" | "afr" | "me";
type DurableObjectRoutingMode = "primary-only";
interface DurableObjectNamespaceGetDurableObjectOptions {
    locationHint?: DurableObjectLocationHint;
    routingMode?: DurableObjectRoutingMode;
}
interface DurableObjectClass<_T extends Rpc.DurableObjectBranded | undefined = undefined> {
}
interface DurableObjectState<Props = unknown> {
    waitUntil(promise: Promise<any>): void;
    readonly exports: Cloudflare.Exports;
    readonly props: Props;
    readonly id: DurableObjectId;
    readonly storage: DurableObjectStorage;
    container?: Container;
    blockConcurrencyWhile<T>(callback: () => Promise<T>): Promise<T>;
    acceptWebSocket(ws: WebSocket, tags?: string[]): void;
    getWebSockets(tag?: string): WebSocket[];
    setWebSocketAutoResponse(maybeReqResp?: WebSocketRequestResponsePair): void;
    getWebSocketAutoResponse(): WebSocketRequestResponsePair | null;
    getWebSocketAutoResponseTimestamp(ws: WebSocket): Date | null;
    setHibernatableWebSocketEventTimeout(timeoutMs?: number): void;
    getHibernatableWebSocketEventTimeout(): number | null;
    getTags(ws: WebSocket): string[];
    abort(reason?: string): void;
}
interface DurableObjectTransaction {
    get<T = unknown>(key: string, options?: DurableObjectGetOptions): Promise<T | undefined>;
    get<T = unknown>(keys: string[], options?: DurableObjectGetOptions): Promise<Map<string, T>>;
    list<T = unknown>(options?: DurableObjectListOptions): Promise<Map<string, T>>;
    put<T>(key: string, value: T, options?: DurableObjectPutOptions): Promise<void>;
    put<T>(entries: Record<string, T>, options?: DurableObjectPutOptions): Promise<void>;
    delete(key: string, options?: DurableObjectPutOptions): Promise<boolean>;
    delete(keys: string[], options?: DurableObjectPutOptions): Promise<number>;
    rollback(): void;
    getAlarm(options?: DurableObjectGetAlarmOptions): Promise<number | null>;
    setAlarm(scheduledTime: number | Date, options?: DurableObjectSetAlarmOptions): Promise<void>;
    deleteAlarm(options?: DurableObjectSetAlarmOptions): Promise<void>;
}
interface DurableObjectStorage {
    get<T = unknown>(key: string, options?: DurableObjectGetOptions): Promise<T | undefined>;
    get<T = unknown>(keys: string[], options?: DurableObjectGetOptions): Promise<Map<string, T>>;
    list<T = unknown>(options?: DurableObjectListOptions): Promise<Map<string, T>>;
    put<T>(key: string, value: T, options?: DurableObjectPutOptions): Promise<void>;
    put<T>(entries: Record<string, T>, options?: DurableObjectPutOptions): Promise<void>;
    delete(key: string, options?: DurableObjectPutOptions): Promise<boolean>;
    delete(keys: string[], options?: DurableObjectPutOptions): Promise<number>;
    deleteAll(options?: DurableObjectPutOptions): Promise<void>;
    transaction<T>(closure: (txn: DurableObjectTransaction) => Promise<T>): Promise<T>;
    getAlarm(options?: DurableObjectGetAlarmOptions): Promise<number | null>;
    setAlarm(scheduledTime: number | Date, options?: DurableObjectSetAlarmOptions): Promise<void>;
    deleteAlarm(options?: DurableObjectSetAlarmOptions): Promise<void>;
    sync(): Promise<void>;
    sql: SqlStorage;
    kv: SyncKvStorage;
    transactionSync<T>(closure: () => T): T;
    getCurrentBookmark(): Promise<string>;
    getBookmarkForTime(timestamp: number | Date): Promise<string>;
    onNextSessionRestoreBookmark(bookmark: string): Promise<string>;
}
interface DurableObjectListOptions {
    start?: string;
    startAfter?: string;
    end?: string;
    prefix?: string;
    reverse?: boolean;
    limit?: number;
    allowConcurrency?: boolean;
    noCache?: boolean;
}
interface DurableObjectGetOptions {
    allowConcurrency?: boolean;
    noCache?: boolean;
}
interface DurableObjectGetAlarmOptions {
    allowConcurrency?: boolean;
}
interface DurableObjectPutOptions {
    allowConcurrency?: boolean;
    allowUnconfirmed?: boolean;
    noCache?: boolean;
}
interface DurableObjectSetAlarmOptions {
    allowConcurrency?: boolean;
    allowUnconfirmed?: boolean;
}
declare class WebSocketRequestResponsePair {
    constructor(request: string, response: string);
    get request(): string;
    get response(): string;
}
interface AnalyticsEngineDataset {
    writeDataPoint(event?: AnalyticsEngineDataPoint): void;
}
interface AnalyticsEngineDataPoint {
    indexes?: ((ArrayBuffer | string) | null)[];
    doubles?: number[];
    blobs?: ((ArrayBuffer | string) | null)[];
}
/**
 * The **`Event`** interface represents an event which takes place on an `EventTarget`.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event)
 */
declare class Event {
    constructor(type: string, init?: EventInit);
    /**
     * The **`type`** read-only property of the Event interface returns a string containing the event's type.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/type)
     */
    get type(): string;
    /**
     * The **`eventPhase`** read-only property of the being evaluated.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/eventPhase)
     */
    get eventPhase(): number;
    /**
     * The read-only **`composed`** property of the or not the event will propagate across the shadow DOM boundary into the standard DOM.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/composed)
     */
    get composed(): boolean;
    /**
     * The **`bubbles`** read-only property of the Event interface indicates whether the event bubbles up through the DOM tree or not.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/bubbles)
     */
    get bubbles(): boolean;
    /**
     * The **`cancelable`** read-only property of the Event interface indicates whether the event can be canceled, and therefore prevented as if the event never happened.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/cancelable)
     */
    get cancelable(): boolean;
    /**
     * The **`defaultPrevented`** read-only property of the Event interface returns a boolean value indicating whether or not the call to Event.preventDefault() canceled the event.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/defaultPrevented)
     */
    get defaultPrevented(): boolean;
    /**
     * The Event property **`returnValue`** indicates whether the default action for this event has been prevented or not.
     * @deprecated
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/returnValue)
     */
    get returnValue(): boolean;
    /**
     * The **`currentTarget`** read-only property of the Event interface identifies the element to which the event handler has been attached.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/currentTarget)
     */
    get currentTarget(): EventTarget | undefined;
    /**
     * The read-only **`target`** property of the dispatched.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/target)
     */
    get target(): EventTarget | undefined;
    /**
     * The deprecated **`Event.srcElement`** is an alias for the Event.target property.
     * @deprecated
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/srcElement)
     */
    get srcElement(): EventTarget | undefined;
    /**
     * The **`timeStamp`** read-only property of the Event interface returns the time (in milliseconds) at which the event was created.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/timeStamp)
     */
    get timeStamp(): number;
    /**
     * The **`isTrusted`** read-only property of the when the event was generated by the user agent (including via user actions and programmatic methods such as HTMLElement.focus()), and `false` when the event was dispatched via The only exception is the `click` event, which initializes the `isTrusted` property to `false` in user agents.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/isTrusted)
     */
    get isTrusted(): boolean;
    /**
     * The **`cancelBubble`** property of the Event interface is deprecated.
     * @deprecated
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/cancelBubble)
     */
    get cancelBubble(): boolean;
    /**
     * The **`cancelBubble`** property of the Event interface is deprecated.
     * @deprecated
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/cancelBubble)
     */
    set cancelBubble(value: boolean);
    /**
     * The **`stopImmediatePropagation()`** method of the If several listeners are attached to the same element for the same event type, they are called in the order in which they were added.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/stopImmediatePropagation)
     */
    stopImmediatePropagation(): void;
    /**
     * The **`preventDefault()`** method of the Event interface tells the user agent that if the event does not get explicitly handled, its default action should not be taken as it normally would be.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/preventDefault)
     */
    preventDefault(): void;
    /**
     * The **`stopPropagation()`** method of the Event interface prevents further propagation of the current event in the capturing and bubbling phases.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/stopPropagation)
     */
    stopPropagation(): void;
    /**
     * The **`composedPath()`** method of the Event interface returns the event's path which is an array of the objects on which listeners will be invoked.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Event/composedPath)
     */
    composedPath(): EventTarget[];
    static readonly NONE: number;
    static readonly CAPTURING_PHASE: number;
    static readonly AT_TARGET: number;
    static readonly BUBBLING_PHASE: number;
}
interface EventInit {
    bubbles?: boolean;
    cancelable?: boolean;
    composed?: boolean;
}
type EventListener<EventType extends Event = Event> = (event: EventType) => void;
interface EventListenerObject<EventType extends Event = Event> {
    handleEvent(event: EventType): void;
}
type EventListenerOrEventListenerObject<EventType extends Event = Event> = EventListener<EventType> | EventListenerObject<EventType>;
/**
 * The **`EventTarget`** interface is implemented by objects that can receive events and may have listeners for them.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventTarget)
 */
declare class EventTarget<EventMap extends Record<string, Event> = Record<string, Event>> {
    constructor();
    /**
     * The **`addEventListener()`** method of the EventTarget interface sets up a function that will be called whenever the specified event is delivered to the target.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventTarget/addEventListener)
     */
    addEventListener<Type extends keyof EventMap>(type: Type, handler: EventListenerOrEventListenerObject<EventMap[Type]>, options?: EventTargetAddEventListenerOptions | boolean): void;
    /**
     * The **`removeEventListener()`** method of the EventTarget interface removes an event listener previously registered with EventTarget.addEventListener() from the target.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventTarget/removeEventListener)
     */
    removeEventListener<Type extends keyof EventMap>(type: Type, handler: EventListenerOrEventListenerObject<EventMap[Type]>, options?: EventTargetEventListenerOptions | boolean): void;
    /**
     * The **`dispatchEvent()`** method of the EventTarget sends an Event to the object, (synchronously) invoking the affected event listeners in the appropriate order.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventTarget/dispatchEvent)
     */
    dispatchEvent(event: EventMap[keyof EventMap]): boolean;
}
interface EventTargetEventListenerOptions {
    capture?: boolean;
}
interface EventTargetAddEventListenerOptions {
    capture?: boolean;
    passive?: boolean;
    once?: boolean;
    signal?: AbortSignal;
}
interface EventTargetHandlerObject {
    handleEvent: (event: Event) => any | undefined;
}
/**
 * The **`AbortController`** interface represents a controller object that allows you to abort one or more Web requests as and when desired.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortController)
 */
declare class AbortController {
    constructor();
    /**
     * The **`signal`** read-only property of the AbortController interface returns an AbortSignal object instance, which can be used to communicate with/abort an asynchronous operation as desired.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortController/signal)
     */
    get signal(): AbortSignal;
    /**
     * The **`abort()`** method of the AbortController interface aborts an asynchronous operation before it has completed.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortController/abort)
     */
    abort(reason?: any): void;
}
/**
 * The **`AbortSignal`** interface represents a signal object that allows you to communicate with an asynchronous operation (such as a fetch request) and abort it if required via an AbortController object.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal)
 */
declare abstract class AbortSignal extends EventTarget {
    /**
     * The **`AbortSignal.abort()`** static method returns an AbortSignal that is already set as aborted (and which does not trigger an AbortSignal/abort_event event).
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal/abort_static)
     */
    static abort(reason?: any): AbortSignal;
    /**
     * The **`AbortSignal.timeout()`** static method returns an AbortSignal that will automatically abort after a specified time.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal/timeout_static)
     */
    static timeout(delay: number): AbortSignal;
    /**
     * The **`AbortSignal.any()`** static method takes an iterable of abort signals and returns an AbortSignal.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal/any_static)
     */
    static any(signals: AbortSignal[]): AbortSignal;
    /**
     * The **`aborted`** read-only property returns a value that indicates whether the asynchronous operations the signal is communicating with are aborted (`true`) or not (`false`).
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal/aborted)
     */
    get aborted(): boolean;
    /**
     * The **`reason`** read-only property returns a JavaScript value that indicates the abort reason.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal/reason)
     */
    get reason(): any;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal/abort_event) */
    get onabort(): any | null;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal/abort_event) */
    set onabort(value: any | null);
    /**
     * The **`throwIfAborted()`** method throws the signal's abort AbortSignal.reason if the signal has been aborted; otherwise it does nothing.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/AbortSignal/throwIfAborted)
     */
    throwIfAborted(): void;
}
interface Scheduler {
    wait(delay: number, maybeOptions?: SchedulerWaitOptions): Promise<void>;
}
interface SchedulerWaitOptions {
    signal?: AbortSignal;
}
/**
 * The **`ExtendableEvent`** interface extends the lifetime of the `install` and `activate` events dispatched on the global scope as part of the service worker lifecycle.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ExtendableEvent)
 */
declare abstract class ExtendableEvent extends Event {
    /**
     * The **`ExtendableEvent.waitUntil()`** method tells the event dispatcher that work is ongoing.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ExtendableEvent/waitUntil)
     */
    waitUntil(promise: Promise<any>): void;
}
/**
 * The **`CustomEvent`** interface represents events initialized by an application for any purpose.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CustomEvent)
 */
declare class CustomEvent<T = any> extends Event {
    constructor(type: string, init?: CustomEventCustomEventInit);
    /**
     * The read-only **`detail`** property of the CustomEvent interface returns any data passed when initializing the event.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CustomEvent/detail)
     */
    get detail(): T;
}
interface CustomEventCustomEventInit {
    bubbles?: boolean;
    cancelable?: boolean;
    composed?: boolean;
    detail?: any;
}
/**
 * The **`Blob`** interface represents a blob, which is a file-like object of immutable, raw data; they can be read as text or binary data, or converted into a ReadableStream so its methods can be used for processing the data.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Blob)
 */
declare class Blob {
    constructor(type?: ((ArrayBuffer | ArrayBufferView) | string | Blob)[], options?: BlobOptions);
    /**
     * The **`size`** read-only property of the Blob interface returns the size of the Blob or File in bytes.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Blob/size)
     */
    get size(): number;
    /**
     * The **`type`** read-only property of the Blob interface returns the MIME type of the file.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Blob/type)
     */
    get type(): string;
    /**
     * The **`slice()`** method of the Blob interface creates and returns a new `Blob` object which contains data from a subset of the blob on which it's called.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Blob/slice)
     */
    slice(start?: number, end?: number, type?: string): Blob;
    /**
     * The **`arrayBuffer()`** method of the Blob interface returns a Promise that resolves with the contents of the blob as binary data contained in an ArrayBuffer.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Blob/arrayBuffer)
     */
    arrayBuffer(): Promise<ArrayBuffer>;
    /**
     * The **`bytes()`** method of the Blob interface returns a Promise that resolves with a Uint8Array containing the contents of the blob as an array of bytes.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Blob/bytes)
     */
    bytes(): Promise<Uint8Array>;
    /**
     * The **`text()`** method of the string containing the contents of the blob, interpreted as UTF-8.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Blob/text)
     */
    text(): Promise<string>;
    /**
     * The **`stream()`** method of the Blob interface returns a ReadableStream which upon reading returns the data contained within the `Blob`.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Blob/stream)
     */
    stream(): ReadableStream;
}
interface BlobOptions {
    type?: string;
}
/**
 * The **`File`** interface provides information about files and allows JavaScript in a web page to access their content.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/File)
 */
declare class File extends Blob {
    constructor(bits: ((ArrayBuffer | ArrayBufferView) | string | Blob)[] | undefined, name: string, options?: FileOptions);
    /**
     * The **`name`** read-only property of the File interface returns the name of the file represented by a File object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/File/name)
     */
    get name(): string;
    /**
     * The **`lastModified`** read-only property of the File interface provides the last modified date of the file as the number of milliseconds since the Unix epoch (January 1, 1970 at midnight).
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/File/lastModified)
     */
    get lastModified(): number;
}
interface FileOptions {
    type?: string;
    lastModified?: number;
}
/**
* The Cache API allows fine grained control of reading and writing from the Cloudflare global network cache.
*
* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/cache/)
*/
declare abstract class CacheStorage {
    /**
     * The **`open()`** method of the the Cache object matching the `cacheName`.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CacheStorage/open)
     */
    open(cacheName: string): Promise<Cache>;
    readonly default: Cache;
}
/**
* The Cache API allows fine grained control of reading and writing from the Cloudflare global network cache.
*
* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/cache/)
*/
declare abstract class Cache {
    /* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/cache/#delete) */
    delete(request: RequestInfo | URL, options?: CacheQueryOptions): Promise<boolean>;
    /* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/cache/#match) */
    match(request: RequestInfo | URL, options?: CacheQueryOptions): Promise<Response | undefined>;
    /* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/cache/#put) */
    put(request: RequestInfo | URL, response: Response): Promise<void>;
}
interface CacheQueryOptions {
    ignoreMethod?: boolean;
}
/**
* The Web Crypto API provides a set of low-level functions for common cryptographic tasks.
* The Workers runtime implements the full surface of this API, but with some differences in
* the [supported algorithms](https://developers.cloudflare.com/workers/runtime-apis/web-crypto/#supported-algorithms)
* compared to those implemented in most browsers.
*
* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/web-crypto/)
*/
declare abstract class Crypto {
    /**
     * The **`Crypto.subtle`** read-only property returns a cryptographic operations.
     * Available only in secure contexts.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Crypto/subtle)
     */
    get subtle(): SubtleCrypto;
    /**
     * The **`Crypto.getRandomValues()`** method lets you get cryptographically strong random values.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Crypto/getRandomValues)
     */
    getRandomValues<T extends Int8Array | Uint8Array | Int16Array | Uint16Array | Int32Array | Uint32Array | BigInt64Array | BigUint64Array>(buffer: T): T;
    /**
     * The **`randomUUID()`** method of the Crypto interface is used to generate a v4 UUID using a cryptographically secure random number generator.
     * Available only in secure contexts.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Crypto/randomUUID)
     */
    randomUUID(): string;
    DigestStream: typeof DigestStream;
}
/**
 * The **`SubtleCrypto`** interface of the Web Crypto API provides a number of low-level cryptographic functions.
 * Available only in secure contexts.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto)
 */
declare abstract class SubtleCrypto {
    /**
     * The **`encrypt()`** method of the SubtleCrypto interface encrypts data.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/encrypt)
     */
    encrypt(algorithm: string | SubtleCryptoEncryptAlgorithm, key: CryptoKey, plainText: ArrayBuffer | ArrayBufferView): Promise<ArrayBuffer>;
    /**
     * The **`decrypt()`** method of the SubtleCrypto interface decrypts some encrypted data.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/decrypt)
     */
    decrypt(algorithm: string | SubtleCryptoEncryptAlgorithm, key: CryptoKey, cipherText: ArrayBuffer | ArrayBufferView): Promise<ArrayBuffer>;
    /**
     * The **`sign()`** method of the SubtleCrypto interface generates a digital signature.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/sign)
     */
    sign(algorithm: string | SubtleCryptoSignAlgorithm, key: CryptoKey, data: ArrayBuffer | ArrayBufferView): Promise<ArrayBuffer>;
    /**
     * The **`verify()`** method of the SubtleCrypto interface verifies a digital signature.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/verify)
     */
    verify(algorithm: string | SubtleCryptoSignAlgorithm, key: CryptoKey, signature: ArrayBuffer | ArrayBufferView, data: ArrayBuffer | ArrayBufferView): Promise<boolean>;
    /**
     * The **`digest()`** method of the SubtleCrypto interface generates a _digest_ of the given data, using the specified hash function.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/digest)
     */
    digest(algorithm: string | SubtleCryptoHashAlgorithm, data: ArrayBuffer | ArrayBufferView): Promise<ArrayBuffer>;
    /**
     * The **`generateKey()`** method of the SubtleCrypto interface is used to generate a new key (for symmetric algorithms) or key pair (for public-key algorithms).
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/generateKey)
     */
    generateKey(algorithm: string | SubtleCryptoGenerateKeyAlgorithm, extractable: boolean, keyUsages: string[]): Promise<CryptoKey | CryptoKeyPair>;
    /**
     * The **`deriveKey()`** method of the SubtleCrypto interface can be used to derive a secret key from a master key.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/deriveKey)
     */
    deriveKey(algorithm: string | SubtleCryptoDeriveKeyAlgorithm, baseKey: CryptoKey, derivedKeyAlgorithm: string | SubtleCryptoImportKeyAlgorithm, extractable: boolean, keyUsages: string[]): Promise<CryptoKey>;
    /**
     * The **`deriveBits()`** method of the key.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/deriveBits)
     */
    deriveBits(algorithm: string | SubtleCryptoDeriveKeyAlgorithm, baseKey: CryptoKey, length?: number | null): Promise<ArrayBuffer>;
    /**
     * The **`importKey()`** method of the SubtleCrypto interface imports a key: that is, it takes as input a key in an external, portable format and gives you a CryptoKey object that you can use in the Web Crypto API.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/importKey)
     */
    importKey(format: string, keyData: (ArrayBuffer | ArrayBufferView) | JsonWebKey, algorithm: string | SubtleCryptoImportKeyAlgorithm, extractable: boolean, keyUsages: string[]): Promise<CryptoKey>;
    /**
     * The **`exportKey()`** method of the SubtleCrypto interface exports a key: that is, it takes as input a CryptoKey object and gives you the key in an external, portable format.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/exportKey)
     */
    exportKey(format: string, key: CryptoKey): Promise<ArrayBuffer | JsonWebKey>;
    /**
     * The **`wrapKey()`** method of the SubtleCrypto interface 'wraps' a key.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/wrapKey)
     */
    wrapKey(format: string, key: CryptoKey, wrappingKey: CryptoKey, wrapAlgorithm: string | SubtleCryptoEncryptAlgorithm): Promise<ArrayBuffer>;
    /**
     * The **`unwrapKey()`** method of the SubtleCrypto interface 'unwraps' a key.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/SubtleCrypto/unwrapKey)
     */
    unwrapKey(format: string, wrappedKey: ArrayBuffer | ArrayBufferView, unwrappingKey: CryptoKey, unwrapAlgorithm: string | SubtleCryptoEncryptAlgorithm, unwrappedKeyAlgorithm: string | SubtleCryptoImportKeyAlgorithm, extractable: boolean, keyUsages: string[]): Promise<CryptoKey>;
    timingSafeEqual(a: ArrayBuffer | ArrayBufferView, b: ArrayBuffer | ArrayBufferView): boolean;
}
/**
 * The **`CryptoKey`** interface of the Web Crypto API represents a cryptographic key obtained from one of the SubtleCrypto methods SubtleCrypto.generateKey, SubtleCrypto.deriveKey, SubtleCrypto.importKey, or SubtleCrypto.unwrapKey.
 * Available only in secure contexts.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CryptoKey)
 */
declare abstract class CryptoKey {
    /**
     * The read-only **`type`** property of the CryptoKey interface indicates which kind of key is represented by the object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CryptoKey/type)
     */
    readonly type: string;
    /**
     * The read-only **`extractable`** property of the CryptoKey interface indicates whether or not the key may be extracted using `SubtleCrypto.exportKey()` or `SubtleCrypto.wrapKey()`.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CryptoKey/extractable)
     */
    readonly extractable: boolean;
    /**
     * The read-only **`algorithm`** property of the CryptoKey interface returns an object describing the algorithm for which this key can be used, and any associated extra parameters.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CryptoKey/algorithm)
     */
    readonly algorithm: CryptoKeyKeyAlgorithm | CryptoKeyAesKeyAlgorithm | CryptoKeyHmacKeyAlgorithm | CryptoKeyRsaKeyAlgorithm | CryptoKeyEllipticKeyAlgorithm | CryptoKeyArbitraryKeyAlgorithm;
    /**
     * The read-only **`usages`** property of the CryptoKey interface indicates what can be done with the key.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CryptoKey/usages)
     */
    readonly usages: string[];
}
interface CryptoKeyPair {
    publicKey: CryptoKey;
    privateKey: CryptoKey;
}
interface JsonWebKey {
    kty: string;
    use?: string;
    key_ops?: string[];
    alg?: string;
    ext?: boolean;
    crv?: string;
    x?: string;
    y?: string;
    d?: string;
    n?: string;
    e?: string;
    p?: string;
    q?: string;
    dp?: string;
    dq?: string;
    qi?: string;
    oth?: RsaOtherPrimesInfo[];
    k?: string;
}
interface RsaOtherPrimesInfo {
    r?: string;
    d?: string;
    t?: string;
}
interface SubtleCryptoDeriveKeyAlgorithm {
    name: string;
    salt?: (ArrayBuffer | ArrayBufferView);
    iterations?: number;
    hash?: (string | SubtleCryptoHashAlgorithm);
    $public?: CryptoKey;
    info?: (ArrayBuffer | ArrayBufferView);
}
interface SubtleCryptoEncryptAlgorithm {
    name: string;
    iv?: (ArrayBuffer | ArrayBufferView);
    additionalData?: (ArrayBuffer | ArrayBufferView);
    tagLength?: number;
    counter?: (ArrayBuffer | ArrayBufferView);
    length?: number;
    label?: (ArrayBuffer | ArrayBufferView);
}
interface SubtleCryptoGenerateKeyAlgorithm {
    name: string;
    hash?: (string | SubtleCryptoHashAlgorithm);
    modulusLength?: number;
    publicExponent?: (ArrayBuffer | ArrayBufferView);
    length?: number;
    namedCurve?: string;
}
interface SubtleCryptoHashAlgorithm {
    name: string;
}
interface SubtleCryptoImportKeyAlgorithm {
    name: string;
    hash?: (string | SubtleCryptoHashAlgorithm);
    length?: number;
    namedCurve?: string;
    compressed?: boolean;
}
interface SubtleCryptoSignAlgorithm {
    name: string;
    hash?: (string | SubtleCryptoHashAlgorithm);
    dataLength?: number;
    saltLength?: number;
}
interface CryptoKeyKeyAlgorithm {
    name: string;
}
interface CryptoKeyAesKeyAlgorithm {
    name: string;
    length: number;
}
interface CryptoKeyHmacKeyAlgorithm {
    name: string;
    hash: CryptoKeyKeyAlgorithm;
    length: number;
}
interface CryptoKeyRsaKeyAlgorithm {
    name: string;
    modulusLength: number;
    publicExponent: ArrayBuffer | ArrayBufferView;
    hash?: CryptoKeyKeyAlgorithm;
}
interface CryptoKeyEllipticKeyAlgorithm {
    name: string;
    namedCurve: string;
}
interface CryptoKeyArbitraryKeyAlgorithm {
    name: string;
    hash?: CryptoKeyKeyAlgorithm;
    namedCurve?: string;
    length?: number;
}
declare class DigestStream extends WritableStream<ArrayBuffer | ArrayBufferView> {
    constructor(algorithm: string | SubtleCryptoHashAlgorithm);
    readonly digest: Promise<ArrayBuffer>;
    get bytesWritten(): number | bigint;
}
/**
 * The **`TextDecoder`** interface represents a decoder for a specific text encoding, such as `UTF-8`, `ISO-8859-2`, `KOI8-R`, `GBK`, etc.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TextDecoder)
 */
declare class TextDecoder {
    constructor(label?: string, options?: TextDecoderConstructorOptions);
    /**
     * The **`TextDecoder.decode()`** method returns a string containing text decoded from the buffer passed as a parameter.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TextDecoder/decode)
     */
    decode(input?: (ArrayBuffer | ArrayBufferView), options?: TextDecoderDecodeOptions): string;
    get encoding(): string;
    get fatal(): boolean;
    get ignoreBOM(): boolean;
}
/**
 * The **`TextEncoder`** interface takes a stream of code points as input and emits a stream of UTF-8 bytes.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TextEncoder)
 */
declare class TextEncoder {
    constructor();
    /**
     * The **`TextEncoder.encode()`** method takes a string as input, and returns a Global_Objects/Uint8Array containing the text given in parameters encoded with the specific method for that TextEncoder object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TextEncoder/encode)
     */
    encode(input?: string): Uint8Array;
    /**
     * The **`TextEncoder.encodeInto()`** method takes a string to encode and a destination Uint8Array to put resulting UTF-8 encoded text into, and returns a dictionary object indicating the progress of the encoding.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TextEncoder/encodeInto)
     */
    encodeInto(input: string, buffer: Uint8Array): TextEncoderEncodeIntoResult;
    get encoding(): string;
}
interface TextDecoderConstructorOptions {
    fatal: boolean;
    ignoreBOM: boolean;
}
interface TextDecoderDecodeOptions {
    stream: boolean;
}
interface TextEncoderEncodeIntoResult {
    read: number;
    written: number;
}
/**
 * The **`ErrorEvent`** interface represents events providing information related to errors in scripts or in files.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ErrorEvent)
 */
declare class ErrorEvent extends Event {
    constructor(type: string, init?: ErrorEventErrorEventInit);
    /**
     * The **`filename`** read-only property of the ErrorEvent interface returns a string containing the name of the script file in which the error occurred.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ErrorEvent/filename)
     */
    get filename(): string;
    /**
     * The **`message`** read-only property of the ErrorEvent interface returns a string containing a human-readable error message describing the problem.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ErrorEvent/message)
     */
    get message(): string;
    /**
     * The **`lineno`** read-only property of the ErrorEvent interface returns an integer containing the line number of the script file on which the error occurred.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ErrorEvent/lineno)
     */
    get lineno(): number;
    /**
     * The **`colno`** read-only property of the ErrorEvent interface returns an integer containing the column number of the script file on which the error occurred.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ErrorEvent/colno)
     */
    get colno(): number;
    /**
     * The **`error`** read-only property of the ErrorEvent interface returns a JavaScript value, such as an Error or DOMException, representing the error associated with this event.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ErrorEvent/error)
     */
    get error(): any;
}
interface ErrorEventErrorEventInit {
    message?: string;
    filename?: string;
    lineno?: number;
    colno?: number;
    error?: any;
}
/**
 * The **`MessageEvent`** interface represents a message received by a target object.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageEvent)
 */
declare class MessageEvent extends Event {
    constructor(type: string, initializer: MessageEventInit);
    /**
     * The **`data`** read-only property of the The data sent by the message emitter; this can be any data type, depending on what originated this event.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageEvent/data)
     */
    readonly data: any;
    /**
     * The **`origin`** read-only property of the origin of the message emitter.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageEvent/origin)
     */
    readonly origin: string | null;
    /**
     * The **`lastEventId`** read-only property of the unique ID for the event.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageEvent/lastEventId)
     */
    readonly lastEventId: string;
    /**
     * The **`source`** read-only property of the a WindowProxy, MessagePort, or a `MessageEventSource` (which can be a WindowProxy, message emitter.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageEvent/source)
     */
    readonly source: MessagePort | null;
    /**
     * The **`ports`** read-only property of the containing all MessagePort objects sent with the message, in order.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageEvent/ports)
     */
    readonly ports: MessagePort[];
}
interface MessageEventInit {
    data: ArrayBuffer | string;
}
/**
 * The **`PromiseRejectionEvent`** interface represents events which are sent to the global script context when JavaScript Promises are rejected.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/PromiseRejectionEvent)
 */
declare abstract class PromiseRejectionEvent extends Event {
    /**
     * The PromiseRejectionEvent interface's **`promise`** read-only property indicates the JavaScript rejected.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/PromiseRejectionEvent/promise)
     */
    readonly promise: Promise<any>;
    /**
     * The PromiseRejectionEvent **`reason`** read-only property is any JavaScript value or Object which provides the reason passed into Promise.reject().
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/PromiseRejectionEvent/reason)
     */
    readonly reason: any;
}
/**
 * The **`FormData`** interface provides a way to construct a set of key/value pairs representing form fields and their values, which can be sent using the Window/fetch, XMLHttpRequest.send() or navigator.sendBeacon() methods.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData)
 */
declare class FormData {
    constructor();
    /**
     * The **`append()`** method of the FormData interface appends a new value onto an existing key inside a `FormData` object, or adds the key if it does not already exist.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/append)
     */
    append(name: string, value: string | Blob): void;
    /**
     * The **`append()`** method of the FormData interface appends a new value onto an existing key inside a `FormData` object, or adds the key if it does not already exist.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/append)
     */
    append(name: string, value: string): void;
    /**
     * The **`append()`** method of the FormData interface appends a new value onto an existing key inside a `FormData` object, or adds the key if it does not already exist.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/append)
     */
    append(name: string, value: Blob, filename?: string): void;
    /**
     * The **`delete()`** method of the FormData interface deletes a key and its value(s) from a `FormData` object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/delete)
     */
    delete(name: string): void;
    /**
     * The **`get()`** method of the FormData interface returns the first value associated with a given key from within a `FormData` object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/get)
     */
    get(name: string): (File | string) | null;
    /**
     * The **`getAll()`** method of the FormData interface returns all the values associated with a given key from within a `FormData` object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/getAll)
     */
    getAll(name: string): (File | string)[];
    /**
     * The **`has()`** method of the FormData interface returns whether a `FormData` object contains a certain key.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/has)
     */
    has(name: string): boolean;
    /**
     * The **`set()`** method of the FormData interface sets a new value for an existing key inside a `FormData` object, or adds the key/value if it does not already exist.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/set)
     */
    set(name: string, value: string | Blob): void;
    /**
     * The **`set()`** method of the FormData interface sets a new value for an existing key inside a `FormData` object, or adds the key/value if it does not already exist.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/set)
     */
    set(name: string, value: string): void;
    /**
     * The **`set()`** method of the FormData interface sets a new value for an existing key inside a `FormData` object, or adds the key/value if it does not already exist.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FormData/set)
     */
    set(name: string, value: Blob, filename?: string): void;
    /* Returns an array of key, value pairs for every entry in the list. */
    entries(): IterableIterator<[
        key: string,
        value: File | string
    ]>;
    /* Returns a list of keys in the list. */
    keys(): IterableIterator<string>;
    /* Returns a list of values in the list. */
    values(): IterableIterator<(File | string)>;
    forEach<This = unknown>(callback: (this: This, value: File | string, key: string, parent: FormData) => void, thisArg?: This): void;
    [Symbol.iterator](): IterableIterator<[
        key: string,
        value: File | string
    ]>;
}
interface ContentOptions {
    html?: boolean;
}
declare class HTMLRewriter {
    constructor();
    on(selector: string, handlers: HTMLRewriterElementContentHandlers): HTMLRewriter;
    onDocument(handlers: HTMLRewriterDocumentContentHandlers): HTMLRewriter;
    transform(response: Response): Response;
}
interface HTMLRewriterElementContentHandlers {
    element?(element: Element): void | Promise<void>;
    comments?(comment: Comment): void | Promise<void>;
    text?(element: Text): void | Promise<void>;
}
interface HTMLRewriterDocumentContentHandlers {
    doctype?(doctype: Doctype): void | Promise<void>;
    comments?(comment: Comment): void | Promise<void>;
    text?(text: Text): void | Promise<void>;
    end?(end: DocumentEnd): void | Promise<void>;
}
interface Doctype {
    readonly name: string | null;
    readonly publicId: string | null;
    readonly systemId: string | null;
}
interface Element {
    tagName: string;
    readonly attributes: IterableIterator<string[]>;
    readonly removed: boolean;
    readonly namespaceURI: string;
    getAttribute(name: string): string | null;
    hasAttribute(name: string): boolean;
    setAttribute(name: string, value: string): Element;
    removeAttribute(name: string): Element;
    before(content: string | ReadableStream | Response, options?: ContentOptions): Element;
    after(content: string | ReadableStream | Response, options?: ContentOptions): Element;
    prepend(content: string | ReadableStream | Response, options?: ContentOptions): Element;
    append(content: string | ReadableStream | Response, options?: ContentOptions): Element;
    replace(content: string | ReadableStream | Response, options?: ContentOptions): Element;
    remove(): Element;
    removeAndKeepContent(): Element;
    setInnerContent(content: string | ReadableStream | Response, options?: ContentOptions): Element;
    onEndTag(handler: (tag: EndTag) => void | Promise<void>): void;
}
interface EndTag {
    name: string;
    before(content: string | ReadableStream | Response, options?: ContentOptions): EndTag;
    after(content: string | ReadableStream | Response, options?: ContentOptions): EndTag;
    remove(): EndTag;
}
interface Comment {
    text: string;
    readonly removed: boolean;
    before(content: string, options?: ContentOptions): Comment;
    after(content: string, options?: ContentOptions): Comment;
    replace(content: string, options?: ContentOptions): Comment;
    remove(): Comment;
}
interface Text {
    readonly text: string;
    readonly lastInTextNode: boolean;
    readonly removed: boolean;
    before(content: string | ReadableStream | Response, options?: ContentOptions): Text;
    after(content: string | ReadableStream | Response, options?: ContentOptions): Text;
    replace(content: string | ReadableStream | Response, options?: ContentOptions): Text;
    remove(): Text;
}
interface DocumentEnd {
    append(content: string, options?: ContentOptions): DocumentEnd;
}
/**
 * This is the event type for `fetch` events dispatched on the ServiceWorkerGlobalScope.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FetchEvent)
 */
declare abstract class FetchEvent extends ExtendableEvent {
    /**
     * The **`request`** read-only property of the the event handler.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FetchEvent/request)
     */
    readonly request: Request;
    /**
     * The **`respondWith()`** method of allows you to provide a promise for a Response yourself.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/FetchEvent/respondWith)
     */
    respondWith(promise: Response | Promise<Response>): void;
    passThroughOnException(): void;
}
type HeadersInit = Headers | Iterable<Iterable<string>> | Record<string, string>;
/**
 * The **`Headers`** interface of the Fetch API allows you to perform various actions on HTTP request and response headers.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Headers)
 */
declare class Headers {
    constructor(init?: HeadersInit);
    /**
     * The **`get()`** method of the Headers interface returns a byte string of all the values of a header within a `Headers` object with a given name.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Headers/get)
     */
    get(name: string): string | null;
    getAll(name: string): string[];
    /**
     * The **`getSetCookie()`** method of the Headers interface returns an array containing the values of all Set-Cookie headers associated with a response.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Headers/getSetCookie)
     */
    getSetCookie(): string[];
    /**
     * The **`has()`** method of the Headers interface returns a boolean stating whether a `Headers` object contains a certain header.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Headers/has)
     */
    has(name: string): boolean;
    /**
     * The **`set()`** method of the Headers interface sets a new value for an existing header inside a `Headers` object, or adds the header if it does not already exist.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Headers/set)
     */
    set(name: string, value: string): void;
    /**
     * The **`append()`** method of the Headers interface appends a new value onto an existing header inside a `Headers` object, or adds the header if it does not already exist.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Headers/append)
     */
    append(name: string, value: string): void;
    /**
     * The **`delete()`** method of the Headers interface deletes a header from the current `Headers` object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Headers/delete)
     */
    delete(name: string): void;
    forEach<This = unknown>(callback: (this: This, value: string, key: string, parent: Headers) => void, thisArg?: This): void;
    /* Returns an iterator allowing to go through all key/value pairs contained in this object. */
    entries(): IterableIterator<[
        key: string,
        value: string
    ]>;
    /* Returns an iterator allowing to go through all keys of the key/value pairs contained in this object. */
    keys(): IterableIterator<string>;
    /* Returns an iterator allowing to go through all values of the key/value pairs contained in this object. */
    values(): IterableIterator<string>;
    [Symbol.iterator](): IterableIterator<[
        key: string,
        value: string
    ]>;
}
type BodyInit = ReadableStream<Uint8Array> | string | ArrayBuffer | ArrayBufferView | Blob | URLSearchParams | FormData | Iterable<ArrayBuffer | ArrayBufferView> | AsyncIterable<ArrayBuffer | ArrayBufferView>;
declare abstract class Body {
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/body) */
    get body(): ReadableStream | null;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/bodyUsed) */
    get bodyUsed(): boolean;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/arrayBuffer) */
    arrayBuffer(): Promise<ArrayBuffer>;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/bytes) */
    bytes(): Promise<Uint8Array>;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/text) */
    text(): Promise<string>;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/json) */
    json<T>(): Promise<T>;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/formData) */
    formData(): Promise<FormData>;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/blob) */
    blob(): Promise<Blob>;
}
/**
 * The **`Response`** interface of the Fetch API represents the response to a request.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response)
 */
declare var Response: {
    prototype: Response;
    new (body?: BodyInit | null, init?: ResponseInit): Response;
    error(): Response;
    redirect(url: string, status?: number): Response;
    json(any: any, maybeInit?: (ResponseInit | Response)): Response;
};
/**
 * The **`Response`** interface of the Fetch API represents the response to a request.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response)
 */
interface Response extends Body {
    /**
     * The **`clone()`** method of the Response interface creates a clone of a response object, identical in every way, but stored in a different variable.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response/clone)
     */
    clone(): Response;
    /**
     * The **`status`** read-only property of the Response interface contains the HTTP status codes of the response.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response/status)
     */
    status: number;
    /**
     * The **`statusText`** read-only property of the Response interface contains the status message corresponding to the HTTP status code in Response.status.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response/statusText)
     */
    statusText: string;
    /**
     * The **`headers`** read-only property of the with the response.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response/headers)
     */
    headers: Headers;
    /**
     * The **`ok`** read-only property of the Response interface contains a Boolean stating whether the response was successful (status in the range 200-299) or not.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response/ok)
     */
    ok: boolean;
    /**
     * The **`redirected`** read-only property of the Response interface indicates whether or not the response is the result of a request you made which was redirected.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response/redirected)
     */
    redirected: boolean;
    /**
     * The **`url`** read-only property of the Response interface contains the URL of the response.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response/url)
     */
    url: string;
    webSocket: WebSocket | null;
    cf: any | undefined;
    /**
     * The **`type`** read-only property of the Response interface contains the type of the response.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Response/type)
     */
    type: "default" | "error";
}
interface ResponseInit {
    status?: number;
    statusText?: string;
    headers?: HeadersInit;
    cf?: any;
    webSocket?: (WebSocket | null);
    encodeBody?: "automatic" | "manual";
}
type RequestInfo<CfHostMetadata = unknown, Cf = CfProperties<CfHostMetadata>> = Request<CfHostMetadata, Cf> | string;
/**
 * The **`Request`** interface of the Fetch API represents a resource request.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request)
 */
declare var Request: {
    prototype: Request;
    new <CfHostMetadata = unknown, Cf = CfProperties<CfHostMetadata>>(input: RequestInfo<CfProperties> | URL, init?: RequestInit<Cf>): Request<CfHostMetadata, Cf>;
};
/**
 * The **`Request`** interface of the Fetch API represents a resource request.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request)
 */
interface Request<CfHostMetadata = unknown, Cf = CfProperties<CfHostMetadata>> extends Body {
    /**
     * The **`clone()`** method of the Request interface creates a copy of the current `Request` object.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/clone)
     */
    clone(): Request<CfHostMetadata, Cf>;
    /**
     * The **`method`** read-only property of the `POST`, etc.) A String indicating the method of the request.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/method)
     */
    method: string;
    /**
     * The **`url`** read-only property of the Request interface contains the URL of the request.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/url)
     */
    url: string;
    /**
     * The **`headers`** read-only property of the with the request.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/headers)
     */
    headers: Headers;
    /**
     * The **`redirect`** read-only property of the Request interface contains the mode for how redirects are handled.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/redirect)
     */
    redirect: string;
    fetcher: Fetcher | null;
    /**
     * The read-only **`signal`** property of the Request interface returns the AbortSignal associated with the request.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/signal)
     */
    signal: AbortSignal;
    cf?: Cf;
    /**
     * The **`integrity`** read-only property of the Request interface contains the subresource integrity value of the request.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/integrity)
     */
    integrity: string;
    /**
     * The **`keepalive`** read-only property of the Request interface contains the request's `keepalive` setting (`true` or `false`), which indicates whether the browser will keep the associated request alive if the page that initiated it is unloaded before the request is complete.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/keepalive)
     */
    keepalive: boolean;
    /**
     * The **`cache`** read-only property of the Request interface contains the cache mode of the request.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/Request/cache)
     */
    cache?: "no-store" | "no-cache";
}
interface RequestInit<Cf = CfProperties> {
    /* A string to set request's method. */
    method?: string;
    /* A Headers object, an object literal, or an array of two-item arrays to set request's headers. */
    headers?: HeadersInit;
    /* A BodyInit object or null to set request's body. */
    body?: BodyInit | null;
    /* A string indicating whether request follows redirects, results in an error upon encountering a redirect, or returns the redirect (in an opaque fashion). Sets request's redirect. */
    redirect?: string;
    fetcher?: (Fetcher | null);
    cf?: Cf;
    /* A string indicating how the request will interact with the browser's cache to set request's cache. */
    cache?: "no-store" | "no-cache";
    /* A cryptographic hash of the resource to be fetched by request. Sets request's integrity. */
    integrity?: string;
    /* An AbortSignal to set request's signal. */
    signal?: (AbortSignal | null);
    encodeResponseBody?: "automatic" | "manual";
}
type Service<T extends (new (...args: any[]) => Rpc.WorkerEntrypointBranded) | Rpc.WorkerEntrypointBranded | ExportedHandler<any, any, any> | undefined = undefined> = T extends new (...args: any[]) => Rpc.WorkerEntrypointBranded ? Fetcher<InstanceType<T>> : T extends Rpc.WorkerEntrypointBranded ? Fetcher<T> : T extends Exclude<Rpc.EntrypointBranded, Rpc.WorkerEntrypointBranded> ? never : Fetcher<undefined>;
type Fetcher<T extends Rpc.EntrypointBranded | undefined = undefined, Reserved extends string = never> = (T extends Rpc.EntrypointBranded ? Rpc.Provider<T, Reserved | "fetch" | "connect"> : unknown) & {
    fetch(input: RequestInfo | URL, init?: RequestInit): Promise<Response>;
    connect(address: SocketAddress | string, options?: SocketOptions): Socket;
};
interface KVNamespaceListKey<Metadata, Key extends string = string> {
    name: Key;
    expiration?: number;
    metadata?: Metadata;
}
type KVNamespaceListResult<Metadata, Key extends string = string> = {
    list_complete: false;
    keys: KVNamespaceListKey<Metadata, Key>[];
    cursor: string;
    cacheStatus: string | null;
} | {
    list_complete: true;
    keys: KVNamespaceListKey<Metadata, Key>[];
    cacheStatus: string | null;
};
interface KVNamespace<Key extends string = string> {
    get(key: Key, options?: Partial<KVNamespaceGetOptions<undefined>>): Promise<string | null>;
    get(key: Key, type: "text"): Promise<string | null>;
    get<ExpectedValue = unknown>(key: Key, type: "json"): Promise<ExpectedValue | null>;
    get(key: Key, type: "arrayBuffer"): Promise<ArrayBuffer | null>;
    get(key: Key, type: "stream"): Promise<ReadableStream | null>;
    get(key: Key, options?: KVNamespaceGetOptions<"text">): Promise<string | null>;
    get<ExpectedValue = unknown>(key: Key, options?: KVNamespaceGetOptions<"json">): Promise<ExpectedValue | null>;
    get(key: Key, options?: KVNamespaceGetOptions<"arrayBuffer">): Promise<ArrayBuffer | null>;
    get(key: Key, options?: KVNamespaceGetOptions<"stream">): Promise<ReadableStream | null>;
    get(key: Array<Key>, type: "text"): Promise<Map<string, string | null>>;
    get<ExpectedValue = unknown>(key: Array<Key>, type: "json"): Promise<Map<string, ExpectedValue | null>>;
    get(key: Array<Key>, options?: Partial<KVNamespaceGetOptions<undefined>>): Promise<Map<string, string | null>>;
    get(key: Array<Key>, options?: KVNamespaceGetOptions<"text">): Promise<Map<string, string | null>>;
    get<ExpectedValue = unknown>(key: Array<Key>, options?: KVNamespaceGetOptions<"json">): Promise<Map<string, ExpectedValue | null>>;
    list<Metadata = unknown>(options?: KVNamespaceListOptions): Promise<KVNamespaceListResult<Metadata, Key>>;
    put(key: Key, value: string | ArrayBuffer | ArrayBufferView | ReadableStream, options?: KVNamespacePutOptions): Promise<void>;
    getWithMetadata<Metadata = unknown>(key: Key, options?: Partial<KVNamespaceGetOptions<undefined>>): Promise<KVNamespaceGetWithMetadataResult<string, Metadata>>;
    getWithMetadata<Metadata = unknown>(key: Key, type: "text"): Promise<KVNamespaceGetWithMetadataResult<string, Metadata>>;
    getWithMetadata<ExpectedValue = unknown, Metadata = unknown>(key: Key, type: "json"): Promise<KVNamespaceGetWithMetadataResult<ExpectedValue, Metadata>>;
    getWithMetadata<Metadata = unknown>(key: Key, type: "arrayBuffer"): Promise<KVNamespaceGetWithMetadataResult<ArrayBuffer, Metadata>>;
    getWithMetadata<Metadata = unknown>(key: Key, type: "stream"): Promise<KVNamespaceGetWithMetadataResult<ReadableStream, Metadata>>;
    getWithMetadata<Metadata = unknown>(key: Key, options: KVNamespaceGetOptions<"text">): Promise<KVNamespaceGetWithMetadataResult<string, Metadata>>;
    getWithMetadata<ExpectedValue = unknown, Metadata = unknown>(key: Key, options: KVNamespaceGetOptions<"json">): Promise<KVNamespaceGetWithMetadataResult<ExpectedValue, Metadata>>;
    getWithMetadata<Metadata = unknown>(key: Key, options: KVNamespaceGetOptions<"arrayBuffer">): Promise<KVNamespaceGetWithMetadataResult<ArrayBuffer, Metadata>>;
    getWithMetadata<Metadata = unknown>(key: Key, options: KVNamespaceGetOptions<"stream">): Promise<KVNamespaceGetWithMetadataResult<ReadableStream, Metadata>>;
    getWithMetadata<Metadata = unknown>(key: Array<Key>, type: "text"): Promise<Map<string, KVNamespaceGetWithMetadataResult<string, Metadata>>>;
    getWithMetadata<ExpectedValue = unknown, Metadata = unknown>(key: Array<Key>, type: "json"): Promise<Map<string, KVNamespaceGetWithMetadataResult<ExpectedValue, Metadata>>>;
    getWithMetadata<Metadata = unknown>(key: Array<Key>, options?: Partial<KVNamespaceGetOptions<undefined>>): Promise<Map<string, KVNamespaceGetWithMetadataResult<string, Metadata>>>;
    getWithMetadata<Metadata = unknown>(key: Array<Key>, options?: KVNamespaceGetOptions<"text">): Promise<Map<string, KVNamespaceGetWithMetadataResult<string, Metadata>>>;
    getWithMetadata<ExpectedValue = unknown, Metadata = unknown>(key: Array<Key>, options?: KVNamespaceGetOptions<"json">): Promise<Map<string, KVNamespaceGetWithMetadataResult<ExpectedValue, Metadata>>>;
    delete(key: Key): Promise<void>;
}
interface KVNamespaceListOptions {
    limit?: number;
    prefix?: (string | null);
    cursor?: (string | null);
}
interface KVNamespaceGetOptions<Type> {
    type: Type;
    cacheTtl?: number;
}
interface KVNamespacePutOptions {
    expiration?: number;
    expirationTtl?: number;
    metadata?: (any | null);
}
interface KVNamespaceGetWithMetadataResult<Value, Metadata> {
    value: Value | null;
    metadata: Metadata | null;
    cacheStatus: string | null;
}
type QueueContentType = "text" | "bytes" | "json" | "v8";
interface Queue<Body = unknown> {
    send(message: Body, options?: QueueSendOptions): Promise<void>;
    sendBatch(messages: Iterable<MessageSendRequest<Body>>, options?: QueueSendBatchOptions): Promise<void>;
}
interface QueueSendOptions {
    contentType?: QueueContentType;
    delaySeconds?: number;
}
interface QueueSendBatchOptions {
    delaySeconds?: number;
}
interface MessageSendRequest<Body = unknown> {
    body: Body;
    contentType?: QueueContentType;
    delaySeconds?: number;
}
interface QueueRetryOptions {
    delaySeconds?: number;
}
interface Message<Body = unknown> {
    readonly id: string;
    readonly timestamp: Date;
    readonly body: Body;
    readonly attempts: number;
    retry(options?: QueueRetryOptions): void;
    ack(): void;
}
interface QueueEvent<Body = unknown> extends ExtendableEvent {
    readonly messages: readonly Message<Body>[];
    readonly queue: string;
    retryAll(options?: QueueRetryOptions): void;
    ackAll(): void;
}
interface MessageBatch<Body = unknown> {
    readonly messages: readonly Message<Body>[];
    readonly queue: string;
    retryAll(options?: QueueRetryOptions): void;
    ackAll(): void;
}
interface R2Error extends Error {
    readonly name: string;
    readonly code: number;
    readonly message: string;
    readonly action: string;
    readonly stack: any;
}
interface R2ListOptions {
    limit?: number;
    prefix?: string;
    cursor?: string;
    delimiter?: string;
    startAfter?: string;
    include?: ("httpMetadata" | "customMetadata")[];
}
declare abstract class R2Bucket {
    head(key: string): Promise<R2Object | null>;
    get(key: string, options: R2GetOptions & {
        onlyIf: R2Conditional | Headers;
    }): Promise<R2ObjectBody | R2Object | null>;
    get(key: string, options?: R2GetOptions): Promise<R2ObjectBody | null>;
    put(key: string, value: ReadableStream | ArrayBuffer | ArrayBufferView | string | null | Blob, options?: R2PutOptions & {
        onlyIf: R2Conditional | Headers;
    }): Promise<R2Object | null>;
    put(key: string, value: ReadableStream | ArrayBuffer | ArrayBufferView | string | null | Blob, options?: R2PutOptions): Promise<R2Object>;
    createMultipartUpload(key: string, options?: R2MultipartOptions): Promise<R2MultipartUpload>;
    resumeMultipartUpload(key: string, uploadId: string): R2MultipartUpload;
    delete(keys: string | string[]): Promise<void>;
    list(options?: R2ListOptions): Promise<R2Objects>;
}
interface R2MultipartUpload {
    readonly key: string;
    readonly uploadId: string;
    uploadPart(partNumber: number, value: ReadableStream | (ArrayBuffer | ArrayBufferView) | string | Blob, options?: R2UploadPartOptions): Promise<R2UploadedPart>;
    abort(): Promise<void>;
    complete(uploadedParts: R2UploadedPart[]): Promise<R2Object>;
}
interface R2UploadedPart {
    partNumber: number;
    etag: string;
}
declare abstract class R2Object {
    readonly key: string;
    readonly version: string;
    readonly size: number;
    readonly etag: string;
    readonly httpEtag: string;
    readonly checksums: R2Checksums;
    readonly uploaded: Date;
    readonly httpMetadata?: R2HTTPMetadata;
    readonly customMetadata?: Record<string, string>;
    readonly range?: R2Range;
    readonly storageClass: string;
    readonly ssecKeyMd5?: string;
    writeHttpMetadata(headers: Headers): void;
}
interface R2ObjectBody extends R2Object {
    get body(): ReadableStream;
    get bodyUsed(): boolean;
    arrayBuffer(): Promise<ArrayBuffer>;
    bytes(): Promise<Uint8Array>;
    text(): Promise<string>;
    json<T>(): Promise<T>;
    blob(): Promise<Blob>;
}
type R2Range = {
    offset: number;
    length?: number;
} | {
    offset?: number;
    length: number;
} | {
    suffix: number;
};
interface R2Conditional {
    etagMatches?: string;
    etagDoesNotMatch?: string;
    uploadedBefore?: Date;
    uploadedAfter?: Date;
    secondsGranularity?: boolean;
}
interface R2GetOptions {
    onlyIf?: (R2Conditional | Headers);
    range?: (R2Range | Headers);
    ssecKey?: (ArrayBuffer | string);
}
interface R2PutOptions {
    onlyIf?: (R2Conditional | Headers);
    httpMetadata?: (R2HTTPMetadata | Headers);
    customMetadata?: Record<string, string>;
    md5?: ((ArrayBuffer | ArrayBufferView) | string);
    sha1?: ((ArrayBuffer | ArrayBufferView) | string);
    sha256?: ((ArrayBuffer | ArrayBufferView) | string);
    sha384?: ((ArrayBuffer | ArrayBufferView) | string);
    sha512?: ((ArrayBuffer | ArrayBufferView) | string);
    storageClass?: string;
    ssecKey?: (ArrayBuffer | string);
}
interface R2MultipartOptions {
    httpMetadata?: (R2HTTPMetadata | Headers);
    customMetadata?: Record<string, string>;
    storageClass?: string;
    ssecKey?: (ArrayBuffer | string);
}
interface R2Checksums {
    readonly md5?: ArrayBuffer;
    readonly sha1?: ArrayBuffer;
    readonly sha256?: ArrayBuffer;
    readonly sha384?: ArrayBuffer;
    readonly sha512?: ArrayBuffer;
    toJSON(): R2StringChecksums;
}
interface R2StringChecksums {
    md5?: string;
    sha1?: string;
    sha256?: string;
    sha384?: string;
    sha512?: string;
}
interface R2HTTPMetadata {
    contentType?: string;
    contentLanguage?: string;
    contentDisposition?: string;
    contentEncoding?: string;
    cacheControl?: string;
    cacheExpiry?: Date;
}
type R2Objects = {
    objects: R2Object[];
    delimitedPrefixes: string[];
} & ({
    truncated: true;
    cursor: string;
} | {
    truncated: false;
});
interface R2UploadPartOptions {
    ssecKey?: (ArrayBuffer | string);
}
declare abstract class ScheduledEvent extends ExtendableEvent {
    readonly scheduledTime: number;
    readonly cron: string;
    noRetry(): void;
}
interface ScheduledController {
    readonly scheduledTime: number;
    readonly cron: string;
    noRetry(): void;
}
interface QueuingStrategy<T = any> {
    highWaterMark?: (number | bigint);
    size?: (chunk: T) => number | bigint;
}
interface UnderlyingSink<W = any> {
    type?: string;
    start?: (controller: WritableStreamDefaultController) => void | Promise<void>;
    write?: (chunk: W, controller: WritableStreamDefaultController) => void | Promise<void>;
    abort?: (reason: any) => void | Promise<void>;
    close?: () => void | Promise<void>;
}
interface UnderlyingByteSource {
    type: "bytes";
    autoAllocateChunkSize?: number;
    start?: (controller: ReadableByteStreamController) => void | Promise<void>;
    pull?: (controller: ReadableByteStreamController) => void | Promise<void>;
    cancel?: (reason: any) => void | Promise<void>;
}
interface UnderlyingSource<R = any> {
    type?: "" | undefined;
    start?: (controller: ReadableStreamDefaultController<R>) => void | Promise<void>;
    pull?: (controller: ReadableStreamDefaultController<R>) => void | Promise<void>;
    cancel?: (reason: any) => void | Promise<void>;
    expectedLength?: (number | bigint);
}
interface Transformer<I = any, O = any> {
    readableType?: string;
    writableType?: string;
    start?: (controller: TransformStreamDefaultController<O>) => void | Promise<void>;
    transform?: (chunk: I, controller: TransformStreamDefaultController<O>) => void | Promise<void>;
    flush?: (controller: TransformStreamDefaultController<O>) => void | Promise<void>;
    cancel?: (reason: any) => void | Promise<void>;
    expectedLength?: number;
}
interface StreamPipeOptions {
    preventAbort?: boolean;
    preventCancel?: boolean;
    /**
     * Pipes this readable stream to a given writable stream destination. The way in which the piping process behaves under various error conditions can be customized with a number of passed options. It returns a promise that fulfills when the piping process completes successfully, or rejects if any errors were encountered.
     *
     * Piping a stream will lock it for the duration of the pipe, preventing any other consumer from acquiring a reader.
     *
     * Errors and closures of the source and destination streams propagate as follows:
     *
     * An error in this source readable stream will abort destination, unless preventAbort is truthy. The returned promise will be rejected with the source's error, or with any error that occurs during aborting the destination.
     *
     * An error in destination will cancel this source readable stream, unless preventCancel is truthy. The returned promise will be rejected with the destination's error, or with any error that occurs during canceling the source.
     *
     * When this source readable stream closes, destination will be closed, unless preventClose is truthy. The returned promise will be fulfilled once this process completes, unless an error is encountered while closing the destination, in which case it will be rejected with that error.
     *
     * If destination starts out closed or closing, this source readable stream will be canceled, unless preventCancel is true. The returned promise will be rejected with an error indicating piping to a closed stream failed, or with any error that occurs during canceling the source.
     *
     * The signal option can be set to an AbortSignal to allow aborting an ongoing pipe operation via the corresponding AbortController. In this case, this source readable stream will be canceled, and destination aborted, unless the respective options preventCancel or preventAbort are set.
     */
    preventClose?: boolean;
    signal?: AbortSignal;
}
type ReadableStreamReadResult<R = any> = {
    done: false;
    value: R;
} | {
    done: true;
    value?: undefined;
};
/**
 * The `ReadableStream` interface of the Streams API represents a readable stream of byte data.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream)
 */
interface ReadableStream<R = any> {
    /**
     * The **`locked`** read-only property of the ReadableStream interface returns whether or not the readable stream is locked to a reader.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream/locked)
     */
    get locked(): boolean;
    /**
     * The **`cancel()`** method of the ReadableStream interface returns a Promise that resolves when the stream is canceled.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream/cancel)
     */
    cancel(reason?: any): Promise<void>;
    /**
     * The **`getReader()`** method of the ReadableStream interface creates a reader and locks the stream to it.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream/getReader)
     */
    getReader(): ReadableStreamDefaultReader<R>;
    /**
     * The **`getReader()`** method of the ReadableStream interface creates a reader and locks the stream to it.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream/getReader)
     */
    getReader(options: ReadableStreamGetReaderOptions): ReadableStreamBYOBReader;
    /**
     * The **`pipeThrough()`** method of the ReadableStream interface provides a chainable way of piping the current stream through a transform stream or any other writable/readable pair.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream/pipeThrough)
     */
    pipeThrough<T>(transform: ReadableWritablePair<T, R>, options?: StreamPipeOptions): ReadableStream<T>;
    /**
     * The **`pipeTo()`** method of the ReadableStream interface pipes the current `ReadableStream` to a given WritableStream and returns a Promise that fulfills when the piping process completes successfully, or rejects if any errors were encountered.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream/pipeTo)
     */
    pipeTo(destination: WritableStream<R>, options?: StreamPipeOptions): Promise<void>;
    /**
     * The **`tee()`** method of the two-element array containing the two resulting branches as new ReadableStream instances.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream/tee)
     */
    tee(): [
        ReadableStream<R>,
        ReadableStream<R>
    ];
    values(options?: ReadableStreamValuesOptions): AsyncIterableIterator<R>;
    [Symbol.asyncIterator](options?: ReadableStreamValuesOptions): AsyncIterableIterator<R>;
}
/**
 * The `ReadableStream` interface of the Streams API represents a readable stream of byte data.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStream)
 */
declare const ReadableStream: {
    prototype: ReadableStream;
    new (underlyingSource: UnderlyingByteSource, strategy?: QueuingStrategy<Uint8Array>): ReadableStream<Uint8Array>;
    new <R = any>(underlyingSource?: UnderlyingSource<R>, strategy?: QueuingStrategy<R>): ReadableStream<R>;
};
/**
 * The **`ReadableStreamDefaultReader`** interface of the Streams API represents a default reader that can be used to read stream data supplied from a network (such as a fetch request).
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultReader)
 */
declare class ReadableStreamDefaultReader<R = any> {
    constructor(stream: ReadableStream);
    get closed(): Promise<void>;
    cancel(reason?: any): Promise<void>;
    /**
     * The **`read()`** method of the ReadableStreamDefaultReader interface returns a Promise providing access to the next chunk in the stream's internal queue.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultReader/read)
     */
    read(): Promise<ReadableStreamReadResult<R>>;
    /**
     * The **`releaseLock()`** method of the ReadableStreamDefaultReader interface releases the reader's lock on the stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultReader/releaseLock)
     */
    releaseLock(): void;
}
/**
 * The `ReadableStreamBYOBReader` interface of the Streams API defines a reader for a ReadableStream that supports zero-copy reading from an underlying byte source.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamBYOBReader)
 */
declare class ReadableStreamBYOBReader {
    constructor(stream: ReadableStream);
    get closed(): Promise<void>;
    cancel(reason?: any): Promise<void>;
    /**
     * The **`read()`** method of the ReadableStreamBYOBReader interface is used to read data into a view on a user-supplied buffer from an associated readable byte stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamBYOBReader/read)
     */
    read<T extends ArrayBufferView>(view: T): Promise<ReadableStreamReadResult<T>>;
    /**
     * The **`releaseLock()`** method of the ReadableStreamBYOBReader interface releases the reader's lock on the stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamBYOBReader/releaseLock)
     */
    releaseLock(): void;
    readAtLeast<T extends ArrayBufferView>(minElements: number, view: T): Promise<ReadableStreamReadResult<T>>;
}
interface ReadableStreamBYOBReaderReadableStreamBYOBReaderReadOptions {
    min?: number;
}
interface ReadableStreamGetReaderOptions {
    /**
     * Creates a ReadableStreamBYOBReader and locks the stream to the new reader.
     *
     * This call behaves the same way as the no-argument variant, except that it only works on readable byte streams, i.e. streams which were constructed specifically with the ability to handle "bring your own buffer" reading. The returned BYOB reader provides the ability to directly read individual chunks from the stream via its read() method, into developer-supplied buffers, allowing more precise control over allocation.
     */
    mode: "byob";
}
/**
 * The **`ReadableStreamBYOBRequest`** interface of the Streams API represents a 'pull request' for data from an underlying source that will made as a zero-copy transfer to a consumer (bypassing the stream's internal queues).
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamBYOBRequest)
 */
declare abstract class ReadableStreamBYOBRequest {
    /**
     * The **`view`** getter property of the ReadableStreamBYOBRequest interface returns the current view.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamBYOBRequest/view)
     */
    get view(): Uint8Array | null;
    /**
     * The **`respond()`** method of the ReadableStreamBYOBRequest interface is used to signal to the associated readable byte stream that the specified number of bytes were written into the ReadableStreamBYOBRequest.view.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamBYOBRequest/respond)
     */
    respond(bytesWritten: number): void;
    /**
     * The **`respondWithNewView()`** method of the ReadableStreamBYOBRequest interface specifies a new view that the consumer of the associated readable byte stream should write to instead of ReadableStreamBYOBRequest.view.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamBYOBRequest/respondWithNewView)
     */
    respondWithNewView(view: ArrayBuffer | ArrayBufferView): void;
    get atLeast(): number | null;
}
/**
 * The **`ReadableStreamDefaultController`** interface of the Streams API represents a controller allowing control of a ReadableStream's state and internal queue.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController)
 */
declare abstract class ReadableStreamDefaultController<R = any> {
    /**
     * The **`desiredSize`** read-only property of the required to fill the stream's internal queue.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController/desiredSize)
     */
    get desiredSize(): number | null;
    /**
     * The **`close()`** method of the ReadableStreamDefaultController interface closes the associated stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController/close)
     */
    close(): void;
    /**
     * The **`enqueue()`** method of the \`\`\`js-nolint enqueue(chunk) \`\`\` - `chunk` - : The chunk to enqueue.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController/enqueue)
     */
    enqueue(chunk?: R): void;
    /**
     * The **`error()`** method of the with the associated stream to error.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableStreamDefaultController/error)
     */
    error(reason: any): void;
}
/**
 * The **`ReadableByteStreamController`** interface of the Streams API represents a controller for a readable byte stream.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableByteStreamController)
 */
declare abstract class ReadableByteStreamController {
    /**
     * The **`byobRequest`** read-only property of the ReadableByteStreamController interface returns the current BYOB request, or `null` if there are no pending requests.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableByteStreamController/byobRequest)
     */
    get byobRequest(): ReadableStreamBYOBRequest | null;
    /**
     * The **`desiredSize`** read-only property of the ReadableByteStreamController interface returns the number of bytes required to fill the stream's internal queue to its 'desired size'.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableByteStreamController/desiredSize)
     */
    get desiredSize(): number | null;
    /**
     * The **`close()`** method of the ReadableByteStreamController interface closes the associated stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableByteStreamController/close)
     */
    close(): void;
    /**
     * The **`enqueue()`** method of the ReadableByteStreamController interface enqueues a given chunk on the associated readable byte stream (the chunk is copied into the stream's internal queues).
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableByteStreamController/enqueue)
     */
    enqueue(chunk: ArrayBuffer | ArrayBufferView): void;
    /**
     * The **`error()`** method of the ReadableByteStreamController interface causes any future interactions with the associated stream to error with the specified reason.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ReadableByteStreamController/error)
     */
    error(reason: any): void;
}
/**
 * The **`WritableStreamDefaultController`** interface of the Streams API represents a controller allowing control of a WritableStream's state.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultController)
 */
declare abstract class WritableStreamDefaultController {
    /**
     * The read-only **`signal`** property of the WritableStreamDefaultController interface returns the AbortSignal associated with the controller.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultController/signal)
     */
    get signal(): AbortSignal;
    /**
     * The **`error()`** method of the with the associated stream to error.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultController/error)
     */
    error(reason?: any): void;
}
/**
 * The **`TransformStreamDefaultController`** interface of the Streams API provides methods to manipulate the associated ReadableStream and WritableStream.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TransformStreamDefaultController)
 */
declare abstract class TransformStreamDefaultController<O = any> {
    /**
     * The **`desiredSize`** read-only property of the TransformStreamDefaultController interface returns the desired size to fill the queue of the associated ReadableStream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TransformStreamDefaultController/desiredSize)
     */
    get desiredSize(): number | null;
    /**
     * The **`enqueue()`** method of the TransformStreamDefaultController interface enqueues the given chunk in the readable side of the stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TransformStreamDefaultController/enqueue)
     */
    enqueue(chunk?: O): void;
    /**
     * The **`error()`** method of the TransformStreamDefaultController interface errors both sides of the stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TransformStreamDefaultController/error)
     */
    error(reason: any): void;
    /**
     * The **`terminate()`** method of the TransformStreamDefaultController interface closes the readable side and errors the writable side of the stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TransformStreamDefaultController/terminate)
     */
    terminate(): void;
}
interface ReadableWritablePair<R = any, W = any> {
    readable: ReadableStream<R>;
    /**
     * Provides a convenient, chainable way of piping this readable stream through a transform stream (or any other { writable, readable } pair). It simply pipes the stream into the writable side of the supplied pair, and returns the readable side for further use.
     *
     * Piping a stream will lock it for the duration of the pipe, preventing any other consumer from acquiring a reader.
     */
    writable: WritableStream<W>;
}
/**
 * The **`WritableStream`** interface of the Streams API provides a standard abstraction for writing streaming data to a destination, known as a sink.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStream)
 */
declare class WritableStream<W = any> {
    constructor(underlyingSink?: UnderlyingSink, queuingStrategy?: QueuingStrategy);
    /**
     * The **`locked`** read-only property of the WritableStream interface returns a boolean indicating whether the `WritableStream` is locked to a writer.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStream/locked)
     */
    get locked(): boolean;
    /**
     * The **`abort()`** method of the WritableStream interface aborts the stream, signaling that the producer can no longer successfully write to the stream and it is to be immediately moved to an error state, with any queued writes discarded.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStream/abort)
     */
    abort(reason?: any): Promise<void>;
    /**
     * The **`close()`** method of the WritableStream interface closes the associated stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStream/close)
     */
    close(): Promise<void>;
    /**
     * The **`getWriter()`** method of the WritableStream interface returns a new instance of WritableStreamDefaultWriter and locks the stream to that instance.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStream/getWriter)
     */
    getWriter(): WritableStreamDefaultWriter<W>;
}
/**
 * The **`WritableStreamDefaultWriter`** interface of the Streams API is the object returned by WritableStream.getWriter() and once created locks the writer to the `WritableStream` ensuring that no other streams can write to the underlying sink.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter)
 */
declare class WritableStreamDefaultWriter<W = any> {
    constructor(stream: WritableStream);
    /**
     * The **`closed`** read-only property of the the stream errors or the writer's lock is released.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter/closed)
     */
    get closed(): Promise<void>;
    /**
     * The **`ready`** read-only property of the that resolves when the desired size of the stream's internal queue transitions from non-positive to positive, signaling that it is no longer applying backpressure.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter/ready)
     */
    get ready(): Promise<void>;
    /**
     * The **`desiredSize`** read-only property of the to fill the stream's internal queue.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter/desiredSize)
     */
    get desiredSize(): number | null;
    /**
     * The **`abort()`** method of the the producer can no longer successfully write to the stream and it is to be immediately moved to an error state, with any queued writes discarded.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter/abort)
     */
    abort(reason?: any): Promise<void>;
    /**
     * The **`close()`** method of the stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter/close)
     */
    close(): Promise<void>;
    /**
     * The **`write()`** method of the operation.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter/write)
     */
    write(chunk?: W): Promise<void>;
    /**
     * The **`releaseLock()`** method of the corresponding stream.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WritableStreamDefaultWriter/releaseLock)
     */
    releaseLock(): void;
}
/**
 * The **`TransformStream`** interface of the Streams API represents a concrete implementation of the pipe chain _transform stream_ concept.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TransformStream)
 */
declare class TransformStream<I = any, O = any> {
    constructor(transformer?: Transformer<I, O>, writableStrategy?: QueuingStrategy<I>, readableStrategy?: QueuingStrategy<O>);
    /**
     * The **`readable`** read-only property of the TransformStream interface returns the ReadableStream instance controlled by this `TransformStream`.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TransformStream/readable)
     */
    get readable(): ReadableStream<O>;
    /**
     * The **`writable`** read-only property of the TransformStream interface returns the WritableStream instance controlled by this `TransformStream`.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TransformStream/writable)
     */
    get writable(): WritableStream<I>;
}
declare class FixedLengthStream extends IdentityTransformStream {
    constructor(expectedLength: number | bigint, queuingStrategy?: IdentityTransformStreamQueuingStrategy);
}
declare class IdentityTransformStream extends TransformStream<ArrayBuffer | ArrayBufferView, Uint8Array> {
    constructor(queuingStrategy?: IdentityTransformStreamQueuingStrategy);
}
interface IdentityTransformStreamQueuingStrategy {
    highWaterMark?: (number | bigint);
}
interface ReadableStreamValuesOptions {
    preventCancel?: boolean;
}
/**
 * The **`CompressionStream`** interface of the Compression Streams API is an API for compressing a stream of data.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CompressionStream)
 */
declare class CompressionStream extends TransformStream<ArrayBuffer | ArrayBufferView, Uint8Array> {
    constructor(format: "gzip" | "deflate" | "deflate-raw");
}
/**
 * The **`DecompressionStream`** interface of the Compression Streams API is an API for decompressing a stream of data.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/DecompressionStream)
 */
declare class DecompressionStream extends TransformStream<ArrayBuffer | ArrayBufferView, Uint8Array> {
    constructor(format: "gzip" | "deflate" | "deflate-raw");
}
/**
 * The **`TextEncoderStream`** interface of the Encoding API converts a stream of strings into bytes in the UTF-8 encoding.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TextEncoderStream)
 */
declare class TextEncoderStream extends TransformStream<string, Uint8Array> {
    constructor();
    get encoding(): string;
}
/**
 * The **`TextDecoderStream`** interface of the Encoding API converts a stream of text in a binary encoding, such as UTF-8 etc., to a stream of strings.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/TextDecoderStream)
 */
declare class TextDecoderStream extends TransformStream<ArrayBuffer | ArrayBufferView, string> {
    constructor(label?: string, options?: TextDecoderStreamTextDecoderStreamInit);
    get encoding(): string;
    get fatal(): boolean;
    get ignoreBOM(): boolean;
}
interface TextDecoderStreamTextDecoderStreamInit {
    fatal?: boolean;
    ignoreBOM?: boolean;
}
/**
 * The **`ByteLengthQueuingStrategy`** interface of the Streams API provides a built-in byte length queuing strategy that can be used when constructing streams.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ByteLengthQueuingStrategy)
 */
declare class ByteLengthQueuingStrategy implements QueuingStrategy<ArrayBufferView> {
    constructor(init: QueuingStrategyInit);
    /**
     * The read-only **`ByteLengthQueuingStrategy.highWaterMark`** property returns the total number of bytes that can be contained in the internal queue before backpressure is applied.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/ByteLengthQueuingStrategy/highWaterMark)
     */
    get highWaterMark(): number;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/ByteLengthQueuingStrategy/size) */
    get size(): (chunk?: any) => number;
}
/**
 * The **`CountQueuingStrategy`** interface of the Streams API provides a built-in chunk counting queuing strategy that can be used when constructing streams.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CountQueuingStrategy)
 */
declare class CountQueuingStrategy implements QueuingStrategy {
    constructor(init: QueuingStrategyInit);
    /**
     * The read-only **`CountQueuingStrategy.highWaterMark`** property returns the total number of chunks that can be contained in the internal queue before backpressure is applied.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CountQueuingStrategy/highWaterMark)
     */
    get highWaterMark(): number;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/CountQueuingStrategy/size) */
    get size(): (chunk?: any) => number;
}
interface QueuingStrategyInit {
    /**
     * Creates a new ByteLengthQueuingStrategy with the provided high water mark.
     *
     * Note that the provided high water mark will not be validated ahead of time. Instead, if it is negative, NaN, or not a number, the resulting ByteLengthQueuingStrategy will cause the corresponding stream constructor to throw.
     */
    highWaterMark: number;
}
interface ScriptVersion {
    id?: string;
    tag?: string;
    message?: string;
}
declare abstract class TailEvent extends ExtendableEvent {
    readonly events: TraceItem[];
    readonly traces: TraceItem[];
}
interface TraceItem {
    readonly event: (TraceItemFetchEventInfo | TraceItemJsRpcEventInfo | TraceItemScheduledEventInfo | TraceItemAlarmEventInfo | TraceItemQueueEventInfo | TraceItemEmailEventInfo | TraceItemTailEventInfo | TraceItemCustomEventInfo | TraceItemHibernatableWebSocketEventInfo) | null;
    readonly eventTimestamp: number | null;
    readonly logs: TraceLog[];
    readonly exceptions: TraceException[];
    readonly diagnosticsChannelEvents: TraceDiagnosticChannelEvent[];
    readonly scriptName: string | null;
    readonly entrypoint?: string;
    readonly scriptVersion?: ScriptVersion;
    readonly dispatchNamespace?: string;
    readonly scriptTags?: string[];
    readonly durableObjectId?: string;
    readonly outcome: string;
    readonly executionModel: string;
    readonly truncated: boolean;
    readonly cpuTime: number;
    readonly wallTime: number;
}
interface TraceItemAlarmEventInfo {
    readonly scheduledTime: Date;
}
interface TraceItemCustomEventInfo {
}
interface TraceItemScheduledEventInfo {
    readonly scheduledTime: number;
    readonly cron: string;
}
interface TraceItemQueueEventInfo {
    readonly queue: string;
    readonly batchSize: number;
}
interface TraceItemEmailEventInfo {
    readonly mailFrom: string;
    readonly rcptTo: string;
    readonly rawSize: number;
}
interface TraceItemTailEventInfo {
    readonly consumedEvents: TraceItemTailEventInfoTailItem[];
}
interface TraceItemTailEventInfoTailItem {
    readonly scriptName: string | null;
}
interface TraceItemFetchEventInfo {
    readonly response?: TraceItemFetchEventInfoResponse;
    readonly request: TraceItemFetchEventInfoRequest;
}
interface TraceItemFetchEventInfoRequest {
    readonly cf?: any;
    readonly headers: Record<string, string>;
    readonly method: string;
    readonly url: string;
    getUnredacted(): TraceItemFetchEventInfoRequest;
}
interface TraceItemFetchEventInfoResponse {
    readonly status: number;
}
interface TraceItemJsRpcEventInfo {
    readonly rpcMethod: string;
}
interface TraceItemHibernatableWebSocketEventInfo {
    readonly getWebSocketEvent: TraceItemHibernatableWebSocketEventInfoMessage | TraceItemHibernatableWebSocketEventInfoClose | TraceItemHibernatableWebSocketEventInfoError;
}
interface TraceItemHibernatableWebSocketEventInfoMessage {
    readonly webSocketEventType: string;
}
interface TraceItemHibernatableWebSocketEventInfoClose {
    readonly webSocketEventType: string;
    readonly code: number;
    readonly wasClean: boolean;
}
interface TraceItemHibernatableWebSocketEventInfoError {
    readonly webSocketEventType: string;
}
interface TraceLog {
    readonly timestamp: number;
    readonly level: string;
    readonly message: any;
}
interface TraceException {
    readonly timestamp: number;
    readonly message: string;
    readonly name: string;
    readonly stack?: string;
}
interface TraceDiagnosticChannelEvent {
    readonly timestamp: number;
    readonly channel: string;
    readonly message: any;
}
interface TraceMetrics {
    readonly cpuTime: number;
    readonly wallTime: number;
}
interface UnsafeTraceMetrics {
    fromTrace(item: TraceItem): TraceMetrics;
}
/**
 * The **`URL`** interface is used to parse, construct, normalize, and encode URL.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL)
 */
declare class URL {
    constructor(url: string | URL, base?: string | URL);
    /**
     * The **`origin`** read-only property of the URL interface returns a string containing the Unicode serialization of the origin of the represented URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/origin)
     */
    get origin(): string;
    /**
     * The **`href`** property of the URL interface is a string containing the whole URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/href)
     */
    get href(): string;
    /**
     * The **`href`** property of the URL interface is a string containing the whole URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/href)
     */
    set href(value: string);
    /**
     * The **`protocol`** property of the URL interface is a string containing the protocol or scheme of the URL, including the final `':'`.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/protocol)
     */
    get protocol(): string;
    /**
     * The **`protocol`** property of the URL interface is a string containing the protocol or scheme of the URL, including the final `':'`.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/protocol)
     */
    set protocol(value: string);
    /**
     * The **`username`** property of the URL interface is a string containing the username component of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/username)
     */
    get username(): string;
    /**
     * The **`username`** property of the URL interface is a string containing the username component of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/username)
     */
    set username(value: string);
    /**
     * The **`password`** property of the URL interface is a string containing the password component of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/password)
     */
    get password(): string;
    /**
     * The **`password`** property of the URL interface is a string containing the password component of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/password)
     */
    set password(value: string);
    /**
     * The **`host`** property of the URL interface is a string containing the host, which is the URL.hostname, and then, if the port of the URL is nonempty, a `':'`, followed by the URL.port of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/host)
     */
    get host(): string;
    /**
     * The **`host`** property of the URL interface is a string containing the host, which is the URL.hostname, and then, if the port of the URL is nonempty, a `':'`, followed by the URL.port of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/host)
     */
    set host(value: string);
    /**
     * The **`hostname`** property of the URL interface is a string containing either the domain name or IP address of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/hostname)
     */
    get hostname(): string;
    /**
     * The **`hostname`** property of the URL interface is a string containing either the domain name or IP address of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/hostname)
     */
    set hostname(value: string);
    /**
     * The **`port`** property of the URL interface is a string containing the port number of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/port)
     */
    get port(): string;
    /**
     * The **`port`** property of the URL interface is a string containing the port number of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/port)
     */
    set port(value: string);
    /**
     * The **`pathname`** property of the URL interface represents a location in a hierarchical structure.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/pathname)
     */
    get pathname(): string;
    /**
     * The **`pathname`** property of the URL interface represents a location in a hierarchical structure.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/pathname)
     */
    set pathname(value: string);
    /**
     * The **`search`** property of the URL interface is a search string, also called a _query string_, that is a string containing a `'?'` followed by the parameters of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/search)
     */
    get search(): string;
    /**
     * The **`search`** property of the URL interface is a search string, also called a _query string_, that is a string containing a `'?'` followed by the parameters of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/search)
     */
    set search(value: string);
    /**
     * The **`hash`** property of the URL interface is a string containing a `'#'` followed by the fragment identifier of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/hash)
     */
    get hash(): string;
    /**
     * The **`hash`** property of the URL interface is a string containing a `'#'` followed by the fragment identifier of the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/hash)
     */
    set hash(value: string);
    /**
     * The **`searchParams`** read-only property of the access to the [MISSING: httpmethod('GET')] decoded query arguments contained in the URL.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/searchParams)
     */
    get searchParams(): URLSearchParams;
    /**
     * The **`toJSON()`** method of the URL interface returns a string containing a serialized version of the URL, although in practice it seems to have the same effect as \`\`\`js-nolint toJSON() \`\`\` None.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/toJSON)
     */
    toJSON(): string;
    /*function toString() { [native code] }*/
    toString(): string;
    /**
     * The **`URL.canParse()`** static method of the URL interface returns a boolean indicating whether or not an absolute URL, or a relative URL combined with a base URL, are parsable and valid.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/canParse_static)
     */
    static canParse(url: string, base?: string): boolean;
    /**
     * The **`URL.parse()`** static method of the URL interface returns a newly created URL object representing the URL defined by the parameters.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/parse_static)
     */
    static parse(url: string, base?: string): URL | null;
    /**
     * The **`createObjectURL()`** static method of the URL interface creates a string containing a URL representing the object given in the parameter.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/createObjectURL_static)
     */
    static createObjectURL(object: File | Blob): string;
    /**
     * The **`revokeObjectURL()`** static method of the URL interface releases an existing object URL which was previously created by calling Call this method when you've finished using an object URL to let the browser know not to keep the reference to the file any longer.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URL/revokeObjectURL_static)
     */
    static revokeObjectURL(object_url: string): void;
}
/**
 * The **`URLSearchParams`** interface defines utility methods to work with the query string of a URL.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams)
 */
declare class URLSearchParams {
    constructor(init?: (Iterable<Iterable<string>> | Record<string, string> | string));
    /**
     * The **`size`** read-only property of the URLSearchParams interface indicates the total number of search parameter entries.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams/size)
     */
    get size(): number;
    /**
     * The **`append()`** method of the URLSearchParams interface appends a specified key/value pair as a new search parameter.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams/append)
     */
    append(name: string, value: string): void;
    /**
     * The **`delete()`** method of the URLSearchParams interface deletes specified parameters and their associated value(s) from the list of all search parameters.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams/delete)
     */
    delete(name: string, value?: string): void;
    /**
     * The **`get()`** method of the URLSearchParams interface returns the first value associated to the given search parameter.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams/get)
     */
    get(name: string): string | null;
    /**
     * The **`getAll()`** method of the URLSearchParams interface returns all the values associated with a given search parameter as an array.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams/getAll)
     */
    getAll(name: string): string[];
    /**
     * The **`has()`** method of the URLSearchParams interface returns a boolean value that indicates whether the specified parameter is in the search parameters.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams/has)
     */
    has(name: string, value?: string): boolean;
    /**
     * The **`set()`** method of the URLSearchParams interface sets the value associated with a given search parameter to the given value.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams/set)
     */
    set(name: string, value: string): void;
    /**
     * The **`URLSearchParams.sort()`** method sorts all key/value pairs contained in this object in place and returns `undefined`.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/URLSearchParams/sort)
     */
    sort(): void;
    /* Returns an array of key, value pairs for every entry in the search params. */
    entries(): IterableIterator<[
        key: string,
        value: string
    ]>;
    /* Returns a list of keys in the search params. */
    keys(): IterableIterator<string>;
    /* Returns a list of values in the search params. */
    values(): IterableIterator<string>;
    forEach<This = unknown>(callback: (this: This, value: string, key: string, parent: URLSearchParams) => void, thisArg?: This): void;
    /*function toString() { [native code] }*/
    toString(): string;
    [Symbol.iterator](): IterableIterator<[
        key: string,
        value: string
    ]>;
}
declare class URLPattern {
    constructor(input?: (string | URLPatternInit), baseURL?: (string | URLPatternOptions), patternOptions?: URLPatternOptions);
    get protocol(): string;
    get username(): string;
    get password(): string;
    get hostname(): string;
    get port(): string;
    get pathname(): string;
    get search(): string;
    get hash(): string;
    get hasRegExpGroups(): boolean;
    test(input?: (string | URLPatternInit), baseURL?: string): boolean;
    exec(input?: (string | URLPatternInit), baseURL?: string): URLPatternResult | null;
}
interface URLPatternInit {
    protocol?: string;
    username?: string;
    password?: string;
    hostname?: string;
    port?: string;
    pathname?: string;
    search?: string;
    hash?: string;
    baseURL?: string;
}
interface URLPatternComponentResult {
    input: string;
    groups: Record<string, string>;
}
interface URLPatternResult {
    inputs: (string | URLPatternInit)[];
    protocol: URLPatternComponentResult;
    username: URLPatternComponentResult;
    password: URLPatternComponentResult;
    hostname: URLPatternComponentResult;
    port: URLPatternComponentResult;
    pathname: URLPatternComponentResult;
    search: URLPatternComponentResult;
    hash: URLPatternComponentResult;
}
interface URLPatternOptions {
    ignoreCase?: boolean;
}
/**
 * A `CloseEvent` is sent to clients using WebSockets when the connection is closed.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CloseEvent)
 */
declare class CloseEvent extends Event {
    constructor(type: string, initializer?: CloseEventInit);
    /**
     * The **`code`** read-only property of the CloseEvent interface returns a WebSocket connection close code indicating the reason the connection was closed.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CloseEvent/code)
     */
    readonly code: number;
    /**
     * The **`reason`** read-only property of the CloseEvent interface returns the WebSocket connection close reason the server gave for closing the connection; that is, a concise human-readable prose explanation for the closure.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CloseEvent/reason)
     */
    readonly reason: string;
    /**
     * The **`wasClean`** read-only property of the CloseEvent interface returns `true` if the connection closed cleanly.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/CloseEvent/wasClean)
     */
    readonly wasClean: boolean;
}
interface CloseEventInit {
    code?: number;
    reason?: string;
    wasClean?: boolean;
}
type WebSocketEventMap = {
    close: CloseEvent;
    message: MessageEvent;
    open: Event;
    error: ErrorEvent;
};
/**
 * The `WebSocket` object provides the API for creating and managing a WebSocket connection to a server, as well as for sending and receiving data on the connection.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WebSocket)
 */
declare var WebSocket: {
    prototype: WebSocket;
    new (url: string, protocols?: (string[] | string)): WebSocket;
    readonly READY_STATE_CONNECTING: number;
    readonly CONNECTING: number;
    readonly READY_STATE_OPEN: number;
    readonly OPEN: number;
    readonly READY_STATE_CLOSING: number;
    readonly CLOSING: number;
    readonly READY_STATE_CLOSED: number;
    readonly CLOSED: number;
};
/**
 * The `WebSocket` object provides the API for creating and managing a WebSocket connection to a server, as well as for sending and receiving data on the connection.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WebSocket)
 */
interface WebSocket extends EventTarget<WebSocketEventMap> {
    accept(): void;
    /**
     * The **`WebSocket.send()`** method enqueues the specified data to be transmitted to the server over the WebSocket connection, increasing the value of `bufferedAmount` by the number of bytes needed to contain the data.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WebSocket/send)
     */
    send(message: (ArrayBuffer | ArrayBufferView) | string): void;
    /**
     * The **`WebSocket.close()`** method closes the already `CLOSED`, this method does nothing.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WebSocket/close)
     */
    close(code?: number, reason?: string): void;
    serializeAttachment(attachment: any): void;
    deserializeAttachment(): any | null;
    /**
     * The **`WebSocket.readyState`** read-only property returns the current state of the WebSocket connection.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WebSocket/readyState)
     */
    readyState: number;
    /**
     * The **`WebSocket.url`** read-only property returns the absolute URL of the WebSocket as resolved by the constructor.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WebSocket/url)
     */
    url: string | null;
    /**
     * The **`WebSocket.protocol`** read-only property returns the name of the sub-protocol the server selected; this will be one of the strings specified in the `protocols` parameter when creating the WebSocket object, or the empty string if no connection is established.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WebSocket/protocol)
     */
    protocol: string | null;
    /**
     * The **`WebSocket.extensions`** read-only property returns the extensions selected by the server.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/WebSocket/extensions)
     */
    extensions: string | null;
}
declare const WebSocketPair: {
    new (): {
        0: WebSocket;
        1: WebSocket;
    };
};
interface SqlStorage {
    exec<T extends Record<string, SqlStorageValue>>(query: string, ...bindings: any[]): SqlStorageCursor<T>;
    get databaseSize(): number;
    Cursor: typeof SqlStorageCursor;
    Statement: typeof SqlStorageStatement;
}
declare abstract class SqlStorageStatement {
}
type SqlStorageValue = ArrayBuffer | string | number | null;
declare abstract class SqlStorageCursor<T extends Record<string, SqlStorageValue>> {
    next(): {
        done?: false;
        value: T;
    } | {
        done: true;
        value?: never;
    };
    toArray(): T[];
    one(): T;
    raw<U extends SqlStorageValue[]>(): IterableIterator<U>;
    columnNames: string[];
    get rowsRead(): number;
    get rowsWritten(): number;
    [Symbol.iterator](): IterableIterator<T>;
}
interface Socket {
    get readable(): ReadableStream;
    get writable(): WritableStream;
    get closed(): Promise<void>;
    get opened(): Promise<SocketInfo>;
    get upgraded(): boolean;
    get secureTransport(): "on" | "off" | "starttls";
    close(): Promise<void>;
    startTls(options?: TlsOptions): Socket;
}
interface SocketOptions {
    secureTransport?: string;
    allowHalfOpen: boolean;
    highWaterMark?: (number | bigint);
}
interface SocketAddress {
    hostname: string;
    port: number;
}
interface TlsOptions {
    expectedServerHostname?: string;
}
interface SocketInfo {
    remoteAddress?: string;
    localAddress?: string;
}
/**
 * The **`EventSource`** interface is web content's interface to server-sent events.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource)
 */
declare class EventSource extends EventTarget {
    constructor(url: string, init?: EventSourceEventSourceInit);
    /**
     * The **`close()`** method of the EventSource interface closes the connection, if one is made, and sets the \`\`\`js-nolint close() \`\`\` None.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/close)
     */
    close(): void;
    /**
     * The **`url`** read-only property of the URL of the source.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/url)
     */
    get url(): string;
    /**
     * The **`withCredentials`** read-only property of the the `EventSource` object was instantiated with CORS credentials set.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/withCredentials)
     */
    get withCredentials(): boolean;
    /**
     * The **`readyState`** read-only property of the connection.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/readyState)
     */
    get readyState(): number;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/open_event) */
    get onopen(): any | null;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/open_event) */
    set onopen(value: any | null);
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/message_event) */
    get onmessage(): any | null;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/message_event) */
    set onmessage(value: any | null);
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/error_event) */
    get onerror(): any | null;
    /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/EventSource/error_event) */
    set onerror(value: any | null);
    static readonly CONNECTING: number;
    static readonly OPEN: number;
    static readonly CLOSED: number;
    static from(stream: ReadableStream): EventSource;
}
interface EventSourceEventSourceInit {
    withCredentials?: boolean;
    fetcher?: Fetcher;
}
interface Container {
    get running(): boolean;
    start(options?: ContainerStartupOptions): void;
    monitor(): Promise<void>;
    destroy(error?: any): Promise<void>;
    signal(signo: number): void;
    getTcpPort(port: number): Fetcher;
    setInactivityTimeout(durationMs: number | bigint): Promise<void>;
}
interface ContainerStartupOptions {
    entrypoint?: string[];
    enableInternet: boolean;
    env?: Record<string, string>;
    hardTimeout?: (number | bigint);
}
/**
 * The **`MessagePort`** interface of the Channel Messaging API represents one of the two ports of a MessageChannel, allowing messages to be sent from one port and listening out for them arriving at the other.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessagePort)
 */
declare abstract class MessagePort extends EventTarget {
    /**
     * The **`postMessage()`** method of the transfers ownership of objects to other browsing contexts.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessagePort/postMessage)
     */
    postMessage(data?: any, options?: (any[] | MessagePortPostMessageOptions)): void;
    /**
     * The **`close()`** method of the MessagePort interface disconnects the port, so it is no longer active.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessagePort/close)
     */
    close(): void;
    /**
     * The **`start()`** method of the MessagePort interface starts the sending of messages queued on the port.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessagePort/start)
     */
    start(): void;
    get onmessage(): any | null;
    set onmessage(value: any | null);
}
/**
 * The **`MessageChannel`** interface of the Channel Messaging API allows us to create a new message channel and send data through it via its two MessagePort properties.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageChannel)
 */
declare class MessageChannel {
    constructor();
    /**
     * The **`port1`** read-only property of the the port attached to the context that originated the channel.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageChannel/port1)
     */
    readonly port1: MessagePort;
    /**
     * The **`port2`** read-only property of the the port attached to the context at the other end of the channel, which the message is initially sent to.
     *
     * [MDN Reference](https://developer.mozilla.org/docs/Web/API/MessageChannel/port2)
     */
    readonly port2: MessagePort;
}
interface MessagePortPostMessageOptions {
    transfer?: any[];
}
type LoopbackForExport<T extends (new (...args: any[]) => Rpc.EntrypointBranded) | ExportedHandler<any, any, any> | undefined = undefined> = T extends new (...args: any[]) => Rpc.WorkerEntrypointBranded ? LoopbackServiceStub<InstanceType<T>> : T extends new (...args: any[]) => Rpc.DurableObjectBranded ? LoopbackDurableObjectClass<InstanceType<T>> : T extends ExportedHandler<any, any, any> ? LoopbackServiceStub<undefined> : undefined;
type LoopbackServiceStub<T extends Rpc.WorkerEntrypointBranded | undefined = undefined> = Fetcher<T> & (T extends CloudflareWorkersModule.WorkerEntrypoint<any, infer Props> ? (opts: {
    props?: Props;
}) => Fetcher<T> : (opts: {
    props?: any;
}) => Fetcher<T>);
type LoopbackDurableObjectClass<T extends Rpc.DurableObjectBranded | undefined = undefined> = DurableObjectClass<T> & (T extends CloudflareWorkersModule.DurableObject<any, infer Props> ? (opts: {
    props?: Props;
}) => DurableObjectClass<T> : (opts: {
    props?: any;
}) => DurableObjectClass<T>);
interface SyncKvStorage {
    get<T = unknown>(key: string): T | undefined;
    list<T = unknown>(options?: SyncKvListOptions): Iterable<[
        string,
        T
    ]>;
    put<T>(key: string, value: T): void;
    delete(key: string): boolean;
}
interface SyncKvListOptions {
    start?: string;
    startAfter?: string;
    end?: string;
    prefix?: string;
    reverse?: boolean;
    limit?: number;
}
interface WorkerStub {
    getEntrypoint<T extends Rpc.WorkerEntrypointBranded | undefined>(name?: string, options?: WorkerStubEntrypointOptions): Fetcher<T>;
}
interface WorkerStubEntrypointOptions {
    props?: any;
}
interface WorkerLoader {
    get(name: string | null, getCode: () => WorkerLoaderWorkerCode | Promise<WorkerLoaderWorkerCode>): WorkerStub;
}
interface WorkerLoaderModule {
    js?: string;
    cjs?: string;
    text?: string;
    data?: ArrayBuffer;
    json?: any;
    py?: string;
    wasm?: ArrayBuffer;
}
interface WorkerLoaderWorkerCode {
    compatibilityDate: string;
    compatibilityFlags?: string[];
    allowExperimental?: boolean;
    mainModule: string;
    modules: Record<string, WorkerLoaderModule | string>;
    env?: any;
    globalOutbound?: (Fetcher | null);
    tails?: Fetcher[];
    streamingTails?: Fetcher[];
}
/**
* The Workers runtime supports a subset of the Performance API, used to measure timing and performance,
* as well as timing of subrequests and other operations.
*
* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/performance/)
*/
declare abstract class Performance {
    /* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/performance/#performancetimeorigin) */
    get timeOrigin(): number;
    /* [Cloudflare Docs Reference](https://developers.cloudflare.com/workers/runtime-apis/performance/#performancenow) */
    now(): number;
}
type AiImageClassificationInput = {
    image: number[];
};
type AiImageClassificationOutput = {
    score?: number;
    label?: string;
}[];
declare abstract class BaseAiImageClassification {
    inputs: AiImageClassificationInput;
    postProcessedOutputs: AiImageClassificationOutput;
}
type AiImageToTextInput = {
    image: number[];
    prompt?: string;
    max_tokens?: number;
    temperature?: number;
    top_p?: number;
    top_k?: number;
    seed?: number;
    repetition_penalty?: number;
    frequency_penalty?: number;
    presence_penalty?: number;
    raw?: boolean;
    messages?: RoleScopedChatInput[];
};
type AiImageToTextOutput = {
    description: string;
};
declare abstract class BaseAiImageToText {
    inputs: AiImageToTextInput;
    postProcessedOutputs: AiImageToTextOutput;
}
type AiImageTextToTextInput = {
    image: string;
    prompt?: string;
    max_tokens?: number;
    temperature?: number;
    ignore_eos?: boolean;
    top_p?: number;
    top_k?: number;
    seed?: number;
    repetition_penalty?: number;
    frequency_penalty?: number;
    presence_penalty?: number;
    raw?: boolean;
    messages?: RoleScopedChatInput[];
};
type AiImageTextToTextOutput = {
    description: string;
};
declare abstract class BaseAiImageTextToText {
    inputs: AiImageTextToTextInput;
    postProcessedOutputs: AiImageTextToTextOutput;
}
type AiMultimodalEmbeddingsInput = {
    image: string;
    text: string[];
};
type AiIMultimodalEmbeddingsOutput = {
    data: number[][];
    shape: number[];
};
declare abstract class BaseAiMultimodalEmbeddings {
    inputs: AiImageTextToTextInput;
    postProcessedOutputs: AiImageTextToTextOutput;
}
type AiObjectDetectionInput = {
    image: number[];
};
type AiObjectDetectionOutput = {
    score?: number;
    label?: string;
}[];
declare abstract class BaseAiObjectDetection {
    inputs: AiObjectDetectionInput;
    postProcessedOutputs: AiObjectDetectionOutput;
}
type AiSentenceSimilarityInput = {
    source: string;
    sentences: string[];
};
type AiSentenceSimilarityOutput = number[];
declare abstract class BaseAiSentenceSimilarity {
    inputs: AiSentenceSimilarityInput;
    postProcessedOutputs: AiSentenceSimilarityOutput;
}
type AiAutomaticSpeechRecognitionInput = {
    audio: number[];
};
type AiAutomaticSpeechRecognitionOutput = {
    text?: string;
    words?: {
        word: string;
        start: number;
        end: number;
    }[];
    vtt?: string;
};
declare abstract class BaseAiAutomaticSpeechRecognition {
    inputs: AiAutomaticSpeechRecognitionInput;
    postProcessedOutputs: AiAutomaticSpeechRecognitionOutput;
}
type AiSummarizationInput = {
    input_text: string;
    max_length?: number;
};
type AiSummarizationOutput = {
    summary: string;
};
declare abstract class BaseAiSummarization {
    inputs: AiSummarizationInput;
    postProcessedOutputs: AiSummarizationOutput;
}
type AiTextClassificationInput = {
    text: string;
};
type AiTextClassificationOutput = {
    score?: number;
    label?: string;
}[];
declare abstract class BaseAiTextClassification {
    inputs: AiTextClassificationInput;
    postProcessedOutputs: AiTextClassificationOutput;
}
type AiTextEmbeddingsInput = {
    text: string | string[];
};
type AiTextEmbeddingsOutput = {
    shape: number[];
    data: number[][];
};
declare abstract class BaseAiTextEmbeddings {
    inputs: AiTextEmbeddingsInput;
    postProcessedOutputs: AiTextEmbeddingsOutput;
}
type RoleScopedChatInput = {
    role: "user" | "assistant" | "system" | "tool" | (string & NonNullable<unknown>);
    content: string;
    name?: string;
};
type AiTextGenerationToolLegacyInput = {
    name: string;
    description: string;
    parameters?: {
        type: "object" | (string & NonNullable<unknown>);
        properties: {
            [key: string]: {
                type: string;
                description?: string;
            };
        };
        required: string[];
    };
};
type AiTextGenerationToolInput = {
    type: "function" | (string & NonNullable<unknown>);
    function: {
        name: string;
        description: string;
        parameters?: {
            type: "object" | (string & NonNullable<unknown>);
            properties: {
                [key: string]: {
                    type: string;
                    description?: string;
                };
            };
            required: string[];
        };
    };
};
type AiTextGenerationFunctionsInput = {
    name: string;
    code: string;
};
type AiTextGenerationResponseFormat = {
    type: string;
    json_schema?: any;
};
type AiTextGenerationInput = {
    prompt?: string;
    raw?: boolean;
    stream?: boolean;
    max_tokens?: number;
    temperature?: number;
    top_p?: number;
    top_k?: number;
    seed?: number;
    repetition_penalty?: number;
    frequency_penalty?: number;
    presence_penalty?: number;
    messages?: RoleScopedChatInput[];
    response_format?: AiTextGenerationResponseFormat;
    tools?: AiTextGenerationToolInput[] | AiTextGenerationToolLegacyInput[] | (object & NonNullable<unknown>);
    functions?: AiTextGenerationFunctionsInput[];
};
type AiTextGenerationToolLegacyOutput = {
    name: string;
    arguments: unknown;
};
type AiTextGenerationToolOutput = {
    id: string;
    type: "function";
    function: {
        name: string;
        arguments: string;
    };
};
type UsageTags = {
    prompt_tokens: number;
    completion_tokens: number;
    total_tokens: number;
};
type AiTextGenerationOutput = {
    response?: string;
    tool_calls?: AiTextGenerationToolLegacyOutput[] & AiTextGenerationToolOutput[];
    usage?: UsageTags;
};
declare abstract class BaseAiTextGeneration {
    inputs: AiTextGenerationInput;
    postProcessedOutputs: AiTextGenerationOutput;
}
type AiTextToSpeechInput = {
    prompt: string;
    lang?: string;
};
type AiTextToSpeechOutput = Uint8Array | {
    audio: string;
};
declare abstract class BaseAiTextToSpeech {
    inputs: AiTextToSpeechInput;
    postProcessedOutputs: AiTextToSpeechOutput;
}
type AiTextToImageInput = {
    prompt: string;
    negative_prompt?: string;
    height?: number;
    width?: number;
    image?: number[];
    image_b64?: string;
    mask?: number[];
    num_steps?: number;
    strength?: number;
    guidance?: number;
    seed?: number;
};
type AiTextToImageOutput = ReadableStream<Uint8Array>;
declare abstract class BaseAiTextToImage {
    inputs: AiTextToImageInput;
    postProcessedOutputs: AiTextToImageOutput;
}
type AiTranslationInput = {
    text: string;
    target_lang: string;
    source_lang?: string;
};
type AiTranslationOutput = {
    translated_text?: string;
};
declare abstract class BaseAiTranslation {
    inputs: AiTranslationInput;
    postProcessedOutputs: AiTranslationOutput;
}
/**
 * Workers AI support for OpenAI's Responses API
 * Reference: https://github.com/openai/openai-node/blob/master/src/resources/responses/responses.ts
 *
 * It's a stripped down version from its source.
 * It currently supports basic function calling, json mode and accepts images as input.
 *
 * It does not include types for WebSearch, CodeInterpreter, FileInputs, MCP, CustomTools.
 * We plan to add those incrementally as model + platform capabilities evolve.
 */
type ResponsesInput = {
    background?: boolean | null;
    conversation?: string | ResponseConversationParam | null;
    include?: Array<ResponseIncludable> | null;
    input?: string | ResponseInput;
    instructions?: string | null;
    max_output_tokens?: number | null;
    parallel_tool_calls?: boolean | null;
    previous_response_id?: string | null;
    prompt_cache_key?: string;
    reasoning?: Reasoning | null;
    safety_identifier?: string;
    service_tier?: "auto" | "default" | "flex" | "scale" | "priority" | null;
    stream?: boolean | null;
    stream_options?: StreamOptions | null;
    temperature?: number | null;
    text?: ResponseTextConfig;
    tool_choice?: ToolChoiceOptions | ToolChoiceFunction;
    tools?: Array<Tool>;
    top_p?: number | null;
    truncation?: "auto" | "disabled" | null;
};
type ResponsesOutput = {
    id?: string;
    created_at?: number;
    output_text?: string;
    error?: ResponseError | null;
    incomplete_details?: ResponseIncompleteDetails | null;
    instructions?: string | Array<ResponseInputItem> | null;
    object?: "response";
    output?: Array<ResponseOutputItem>;
    parallel_tool_calls?: boolean;
    temperature?: number | null;
    tool_choice?: ToolChoiceOptions | ToolChoiceFunction;
    tools?: Array<Tool>;
    top_p?: number | null;
    max_output_tokens?: number | null;
    previous_response_id?: string | null;
    prompt?: ResponsePrompt | null;
    reasoning?: Reasoning | null;
    safety_identifier?: string;
    service_tier?: "auto" | "default" | "flex" | "scale" | "priority" | null;
    status?: ResponseStatus;
    text?: ResponseTextConfig;
    truncation?: "auto" | "disabled" | null;
    usage?: ResponseUsage;
};
type EasyInputMessage = {
    content: string | ResponseInputMessageContentList;
    role: "user" | "assistant" | "system" | "developer";
    type?: "message";
};
type ResponsesFunctionTool = {
    name: string;
    parameters: {
        [key: string]: unknown;
    } | null;
    strict: boolean | null;
    type: "function";
    description?: string | null;
};
type ResponseIncompleteDetails = {
    reason?: "max_output_tokens" | "content_filter";
};
type ResponsePrompt = {
    id: string;
    variables?: {
        [key: string]: string | ResponseInputText | ResponseInputImage;
    } | null;
    version?: string | null;
};
type Reasoning = {
    effort?: ReasoningEffort | null;
    generate_summary?: "auto" | "concise" | "detailed" | null;
    summary?: "auto" | "concise" | "detailed" | null;
};
type ResponseContent = ResponseInputText | ResponseInputImage | ResponseOutputText | ResponseOutputRefusal | ResponseContentReasoningText;
type ResponseContentReasoningText = {
    text: string;
    type: "reasoning_text";
};
type ResponseConversationParam = {
    id: string;
};
type ResponseCreatedEvent = {
    response: Response;
    sequence_number: number;
    type: "response.created";
};
type ResponseCustomToolCallOutput = {
    call_id: string;
    output: string | Array<ResponseInputText | ResponseInputImage>;
    type: "custom_tool_call_output";
    id?: string;
};
type ResponseError = {
    code: "server_error" | "rate_limit_exceeded" | "invalid_prompt" | "vector_store_timeout" | "invalid_image" | "invalid_image_format" | "invalid_base64_image" | "invalid_image_url" | "image_too_large" | "image_too_small" | "image_parse_error" | "image_content_policy_violation" | "invalid_image_mode" | "image_file_too_large" | "unsupported_image_media_type" | "empty_image_file" | "failed_to_download_image" | "image_file_not_found";
    message: string;
};
type ResponseErrorEvent = {
    code: string | null;
    message: string;
    param: string | null;
    sequence_number: number;
    type: "error";
};
type ResponseFailedEvent = {
    response: Response;
    sequence_number: number;
    type: "response.failed";
};
type ResponseFormatText = {
    type: "text";
};
type ResponseFormatJSONObject = {
    type: "json_object";
};
type ResponseFormatTextConfig = ResponseFormatText | ResponseFormatTextJSONSchemaConfig | ResponseFormatJSONObject;
type ResponseFormatTextJSONSchemaConfig = {
    name: string;
    schema: {
        [key: string]: unknown;
    };
    type: "json_schema";
    description?: string;
    strict?: boolean | null;
};
type ResponseFunctionCallArgumentsDeltaEvent = {
    delta: string;
    item_id: string;
    output_index: number;
    sequence_number: number;
    type: "response.function_call_arguments.delta";
};
type ResponseFunctionCallArgumentsDoneEvent = {
    arguments: string;
    item_id: string;
    name: string;
    output_index: number;
    sequence_number: number;
    type: "response.function_call_arguments.done";
};
type ResponseFunctionCallOutputItem = ResponseInputTextContent | ResponseInputImageContent;
type ResponseFunctionCallOutputItemList = Array<ResponseFunctionCallOutputItem>;
type ResponseFunctionToolCall = {
    arguments: string;
    call_id: string;
    name: string;
    type: "function_call";
    id?: string;
    status?: "in_progress" | "completed" | "incomplete";
};
interface ResponseFunctionToolCallItem extends ResponseFunctionToolCall {
    id: string;
}
type ResponseFunctionToolCallOutputItem = {
    id: string;
    call_id: string;
    output: string | Array<ResponseInputText | ResponseInputImage>;
    type: "function_call_output";
    status?: "in_progress" | "completed" | "incomplete";
};
type ResponseIncludable = "message.input_image.image_url" | "message.output_text.logprobs";
type ResponseIncompleteEvent = {
    response: Response;
    sequence_number: number;
    type: "response.incomplete";
};
type ResponseInput = Array<ResponseInputItem>;
type ResponseInputContent = ResponseInputText | ResponseInputImage;
type ResponseInputImage = {
    detail: "low" | "high" | "auto";
    type: "input_image";
    /**
     * Base64 encoded image
     */
    image_url?: string | null;
};
type ResponseInputImageContent = {
    type: "input_image";
    detail?: "low" | "high" | "auto" | null;
    /**
     * Base64 encoded image
     */
    image_url?: string | null;
};
type ResponseInputItem = EasyInputMessage | ResponseInputItemMessage | ResponseOutputMessage | ResponseFunctionToolCall | ResponseInputItemFunctionCallOutput | ResponseReasoningItem;
type ResponseInputItemFunctionCallOutput = {
    call_id: string;
    output: string | ResponseFunctionCallOutputItemList;
    type: "function_call_output";
    id?: string | null;
    status?: "in_progress" | "completed" | "incomplete" | null;
};
type ResponseInputItemMessage = {
    content: ResponseInputMessageContentList;
    role: "user" | "system" | "developer";
    status?: "in_progress" | "completed" | "incomplete";
    type?: "message";
};
type ResponseInputMessageContentList = Array<ResponseInputContent>;
type ResponseInputMessageItem = {
    id: string;
    content: ResponseInputMessageContentList;
    role: "user" | "system" | "developer";
    status?: "in_progress" | "completed" | "incomplete";
    type?: "message";
};
type ResponseInputText = {
    text: string;
    type: "input_text";
};
type ResponseInputTextContent = {
    text: string;
    type: "input_text";
};
type ResponseItem = ResponseInputMessageItem | ResponseOutputMessage | ResponseFunctionToolCallItem | ResponseFunctionToolCallOutputItem;
type ResponseOutputItem = ResponseOutputMessage | ResponseFunctionToolCall | ResponseReasoningItem;
type ResponseOutputItemAddedEvent = {
    item: ResponseOutputItem;
    output_index: number;
    sequence_number: number;
    type: "response.output_item.added";
};
type ResponseOutputItemDoneEvent = {
    item: ResponseOutputItem;
    output_index: number;
    sequence_number: number;
    type: "response.output_item.done";
};
type ResponseOutputMessage = {
    id: string;
    content: Array<ResponseOutputText | ResponseOutputRefusal>;
    role: "assistant";
    status: "in_progress" | "completed" | "incomplete";
    type: "message";
};
type ResponseOutputRefusal = {
    refusal: string;
    type: "refusal";
};
type ResponseOutputText = {
    text: string;
    type: "output_text";
    logprobs?: Array<Logprob>;
};
type ResponseReasoningItem = {
    id: string;
    summary: Array<ResponseReasoningSummaryItem>;
    type: "reasoning";
    content?: Array<ResponseReasoningContentItem>;
    encrypted_content?: string | null;
    status?: "in_progress" | "completed" | "incomplete";
};
type ResponseReasoningSummaryItem = {
    text: string;
    type: "summary_text";
};
type ResponseReasoningContentItem = {
    text: string;
    type: "reasoning_text";
};
type ResponseReasoningTextDeltaEvent = {
    content_index: number;
    delta: string;
    item_id: string;
    output_index: number;
    sequence_number: number;
    type: "response.reasoning_text.delta";
};
type ResponseReasoningTextDoneEvent = {
    content_index: number;
    item_id: string;
    output_index: number;
    sequence_number: number;
    text: string;
    type: "response.reasoning_text.done";
};
type ResponseRefusalDeltaEvent = {
    content_index: number;
    delta: string;
    item_id: string;
    output_index: number;
    sequence_number: number;
    type: "response.refusal.delta";
};
type ResponseRefusalDoneEvent = {
    content_index: number;
    item_id: string;
    output_index: number;
    refusal: string;
    sequence_number: number;
    type: "response.refusal.done";
};
type ResponseStatus = "completed" | "failed" | "in_progress" | "cancelled" | "queued" | "incomplete";
type ResponseStreamEvent = ResponseCompletedEvent | ResponseCreatedEvent | ResponseErrorEvent | ResponseFunctionCallArgumentsDeltaEvent | ResponseFunctionCallArgumentsDoneEvent | ResponseFailedEvent | ResponseIncompleteEvent | ResponseOutputItemAddedEvent | ResponseOutputItemDoneEvent | ResponseReasoningTextDeltaEvent | ResponseReasoningTextDoneEvent | ResponseRefusalDeltaEvent | ResponseRefusalDoneEvent | ResponseTextDeltaEvent | ResponseTextDoneEvent;
type ResponseCompletedEvent = {
    response: Response;
    sequence_number: number;
    type: "response.completed";
};
type ResponseTextConfig = {
    format?: ResponseFormatTextConfig;
    verbosity?: "low" | "medium" | "high" | null;
};
type ResponseTextDeltaEvent = {
    content_index: number;
    delta: string;
    item_id: string;
    logprobs: Array<Logprob>;
    output_index: number;
    sequence_number: number;
    type: "response.output_text.delta";
};
type ResponseTextDoneEvent = {
    content_index: number;
    item_id: string;
    logprobs: Array<Logprob>;
    output_index: number;
    sequence_number: number;
    text: string;
    type: "response.output_text.done";
};
type Logprob = {
    token: string;
    logprob: number;
    top_logprobs?: Array<TopLogprob>;
};
type TopLogprob = {
    token?: string;
    logprob?: number;
};
type ResponseUsage = {
    input_tokens: number;
    output_tokens: number;
    total_tokens: number;
};
type Tool = ResponsesFunctionTool;
type ToolChoiceFunction = {
    name: string;
    type: "function";
};
type ToolChoiceOptions = "none";
type ReasoningEffort = "minimal" | "low" | "medium" | "high" | null;
type StreamOptions = {
    include_obfuscation?: boolean;
};
type Ai_Cf_Baai_Bge_Base_En_V1_5_Input = {
    text: string | string[];
    /**
     * The pooling method used in the embedding process. `cls` pooling will generate more accurate embeddings on larger inputs - however, embeddings created with cls pooling are not compatible with embeddings generated with mean pooling. The default pooling method is `mean` in order for this to not be a breaking change, but we highly suggest using the new `cls` pooling for better accuracy.
     */
    pooling?: "mean" | "cls";
} | {
    /**
     * Batch of the embeddings requests to run using async-queue
     */
    requests: {
        text: string | string[];
        /**
         * The pooling method used in the embedding process. `cls` pooling will generate more accurate embeddings on larger inputs - however, embeddings created with cls pooling are not compatible with embeddings generated with mean pooling. The default pooling method is `mean` in order for this to not be a breaking change, but we highly suggest using the new `cls` pooling for better accuracy.
         */
        pooling?: "mean" | "cls";
    }[];
};
type Ai_Cf_Baai_Bge_Base_En_V1_5_Output = {
    shape?: number[];
    /**
     * Embeddings of the requested text values
     */
    data?: number[][];
    /**
     * The pooling method used in the embedding process.
     */
    pooling?: "mean" | "cls";
} | Ai_Cf_Baai_Bge_Base_En_V1_5_AsyncResponse;
interface Ai_Cf_Baai_Bge_Base_En_V1_5_AsyncResponse {
    /**
     * The async request id that can be used to obtain the results.
     */
    request_id?: string;
}
declare abstract class Base_Ai_Cf_Baai_Bge_Base_En_V1_5 {
    inputs: Ai_Cf_Baai_Bge_Base_En_V1_5_Input;
    postProcessedOutputs: Ai_Cf_Baai_Bge_Base_En_V1_5_Output;
}
type Ai_Cf_Openai_Whisper_Input = string | {
    /**
     * An array of integers that represent the audio data constrained to 8-bit unsigned integer values
     */
    audio: number[];
};
interface Ai_Cf_Openai_Whisper_Output {
    /**
     * The transcription
     */
    text: string;
    word_count?: number;
    words?: {
        word?: string;
        /**
         * The second this word begins in the recording
         */
        start?: number;
        /**
         * The ending second when the word completes
         */
        end?: number;
    }[];
    vtt?: string;
}
declare abstract class Base_Ai_Cf_Openai_Whisper {
    inputs: Ai_Cf_Openai_Whisper_Input;
    postProcessedOutputs: Ai_Cf_Openai_Whisper_Output;
}
type Ai_Cf_Meta_M2M100_1_2B_Input = {
    /**
     * The text to be translated
     */
    text: string;
    /**
     * The language code of the source text (e.g., 'en' for English). Defaults to 'en' if not specified
     */
    source_lang?: string;
    /**
     * The language code to translate the text into (e.g., 'es' for Spanish)
     */
    target_lang: string;
} | {
    /**
     * Batch of the embeddings requests to run using async-queue
     */
    requests: {
        /**
         * The text to be translated
         */
        text: string;
        /**
         * The language code of the source text (e.g., 'en' for English). Defaults to 'en' if not specified
         */
        source_lang?: string;
        /**
         * The language code to translate the text into (e.g., 'es' for Spanish)
         */
        target_lang: string;
    }[];
};
type Ai_Cf_Meta_M2M100_1_2B_Output = {
    /**
     * The translated text in the target language
     */
    translated_text?: string;
} | Ai_Cf_Meta_M2M100_1_2B_AsyncResponse;
interface Ai_Cf_Meta_M2M100_1_2B_AsyncResponse {
    /**
     * The async request id that can be used to obtain the results.
     */
    request_id?: string;
}
declare abstract class Base_Ai_Cf_Meta_M2M100_1_2B {
    inputs: Ai_Cf_Meta_M2M100_1_2B_Input;
    postProcessedOutputs: Ai_Cf_Meta_M2M100_1_2B_Output;
}
type Ai_Cf_Baai_Bge_Small_En_V1_5_Input = {
    text: string | string[];
    /**
     * The pooling method used in the embedding process. `cls` pooling will generate more accurate embeddings on larger inputs - however, embeddings created with cls pooling are not compatible with embeddings generated with mean pooling. The default pooling method is `mean` in order for this to not be a breaking change, but we highly suggest using the new `cls` pooling for better accuracy.
     */
    pooling?: "mean" | "cls";
} | {
    /**
     * Batch of the embeddings requests to run using async-queue
     */
    requests: {
        text: string | string[];
        /**
         * The pooling method used in the embedding process. `cls` pooling will generate more accurate embeddings on larger inputs - however, embeddings created with cls pooling are not compatible with embeddings generated with mean pooling. The default pooling method is `mean` in order for this to not be a breaking change, but we highly suggest using the new `cls` pooling for better accuracy.
         */
        pooling?: "mean" | "cls";
    }[];
};
type Ai_Cf_Baai_Bge_Small_En_V1_5_Output = {
    shape?: number[];
    /**
     * Embeddings of the requested text values
     */
    data?: number[][];
    /**
     * The pooling method used in the embedding process.
     */
    pooling?: "mean" | "cls";
} | Ai_Cf_Baai_Bge_Small_En_V1_5_AsyncResponse;
interface Ai_Cf_Baai_Bge_Small_En_V1_5_AsyncResponse {
    /**
     * The async request id that can be used to obtain the results.
     */
    request_id?: string;
}
declare abstract class Base_Ai_Cf_Baai_Bge_Small_En_V1_5 {
    inputs: Ai_Cf_Baai_Bge_Small_En_V1_5_Input;
    postProcessedOutputs: Ai_Cf_Baai_Bge_Small_En_V1_5_Output;
}
type Ai_Cf_Baai_Bge_Large_En_V1_5_Input = {
    text: string | string[];
    /**
     * The pooling method used in the embedding process. `cls` pooling will generate more accurate embeddings on larger inputs - however, embeddings created with cls pooling are not compatible with embeddings generated with mean pooling. The default pooling method is `mean` in order for this to not be a breaking change, but we highly suggest using the new `cls` pooling for better accuracy.
     */
    pooling?: "mean" | "cls";
} | {
    /**
     * Batch of the embeddings requests to run using async-queue
     */
    requests: {
        text: string | string[];
        /**
         * The pooling method used in the embedding process. `cls` pooling will generate more accurate embeddings on larger inputs - however, embeddings created with cls pooling are not compatible with embeddings generated with mean pooling. The default pooling method is `mean` in order for this to not be a breaking change, but we highly suggest using the new `cls` pooling for better accuracy.
         */
        pooling?: "mean" | "cls";
    }[];
};
type Ai_Cf_Baai_Bge_Large_En_V1_5_Output = {
    shape?: number[];
    /**
     * Embeddings of the requested text values
     */
    data?: number[][];
    /**
     * The pooling method used in the embedding process.
     */
    pooling?: "mean" | "cls";
} | Ai_Cf_Baai_Bge_Large_En_V1_5_AsyncResponse;
interface Ai_Cf_Baai_Bge_Large_En_V1_5_AsyncResponse {
    /**
     * The async request id that can be used to obtain the results.
     */
    request_id?: string;
}
declare abstract class Base_Ai_Cf_Baai_Bge_Large_En_V1_5 {
    inputs: Ai_Cf_Baai_Bge_Large_En_V1_5_Input;
    postProcessedOutputs: Ai_Cf_Baai_Bge_Large_En_V1_5_Output;
}
type Ai_Cf_Unum_Uform_Gen2_Qwen_500M_Input = string | {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt?: string;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * Controls the creativity of the AI's responses by adjusting how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
    image: number[] | (string & NonNullable<unknown>);
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
};
interface Ai_Cf_Unum_Uform_Gen2_Qwen_500M_Output {
    description?: string;
}
declare abstract class Base_Ai_Cf_Unum_Uform_Gen2_Qwen_500M {
    inputs: Ai_Cf_Unum_Uform_Gen2_Qwen_500M_Input;
    postProcessedOutputs: Ai_Cf_Unum_Uform_Gen2_Qwen_500M_Output;
}
type Ai_Cf_Openai_Whisper_Tiny_En_Input = string | {
    /**
     * An array of integers that represent the audio data constrained to 8-bit unsigned integer values
     */
    audio: number[];
};
interface Ai_Cf_Openai_Whisper_Tiny_En_Output {
    /**
     * The transcription
     */
    text: string;
    word_count?: number;
    words?: {
        word?: string;
        /**
         * The second this word begins in the recording
         */
        start?: number;
        /**
         * The ending second when the word completes
         */
        end?: number;
    }[];
    vtt?: string;
}
declare abstract class Base_Ai_Cf_Openai_Whisper_Tiny_En {
    inputs: Ai_Cf_Openai_Whisper_Tiny_En_Input;
    postProcessedOutputs: Ai_Cf_Openai_Whisper_Tiny_En_Output;
}
interface Ai_Cf_Openai_Whisper_Large_V3_Turbo_Input {
    /**
     * Base64 encoded value of the audio data.
     */
    audio: string;
    /**
     * Supported tasks are 'translate' or 'transcribe'.
     */
    task?: string;
    /**
     * The language of the audio being transcribed or translated.
     */
    language?: string;
    /**
     * Preprocess the audio with a voice activity detection model.
     */
    vad_filter?: boolean;
    /**
     * A text prompt to help provide context to the model on the contents of the audio.
     */
    initial_prompt?: string;
    /**
     * The prefix it appended the the beginning of the output of the transcription and can guide the transcription result.
     */
    prefix?: string;
}
interface Ai_Cf_Openai_Whisper_Large_V3_Turbo_Output {
    transcription_info?: {
        /**
         * The language of the audio being transcribed or translated.
         */
        language?: string;
        /**
         * The confidence level or probability of the detected language being accurate, represented as a decimal between 0 and 1.
         */
        language_probability?: number;
        /**
         * The total duration of the original audio file, in seconds.
         */
        duration?: number;
        /**
         * The duration of the audio after applying Voice Activity Detection (VAD) to remove silent or irrelevant sections, in seconds.
         */
        duration_after_vad?: number;
    };
    /**
     * The complete transcription of the audio.
     */
    text: string;
    /**
     * The total number of words in the transcription.
     */
    word_count?: number;
    segments?: {
        /**
         * The starting time of the segment within the audio, in seconds.
         */
        start?: number;
        /**
         * The ending time of the segment within the audio, in seconds.
         */
        end?: number;
        /**
         * The transcription of the segment.
         */
        text?: string;
        /**
         * The temperature used in the decoding process, controlling randomness in predictions. Lower values result in more deterministic outputs.
         */
        temperature?: number;
        /**
         * The average log probability of the predictions for the words in this segment, indicating overall confidence.
         */
        avg_logprob?: number;
        /**
         * The compression ratio of the input to the output, measuring how much the text was compressed during the transcription process.
         */
        compression_ratio?: number;
        /**
         * The probability that the segment contains no speech, represented as a decimal between 0 and 1.
         */
        no_speech_prob?: number;
        words?: {
            /**
             * The individual word transcribed from the audio.
             */
            word?: string;
            /**
             * The starting time of the word within the audio, in seconds.
             */
            start?: number;
            /**
             * The ending time of the word within the audio, in seconds.
             */
            end?: number;
        }[];
    }[];
    /**
     * The transcription in WebVTT format, which includes timing and text information for use in subtitles.
     */
    vtt?: string;
}
declare abstract class Base_Ai_Cf_Openai_Whisper_Large_V3_Turbo {
    inputs: Ai_Cf_Openai_Whisper_Large_V3_Turbo_Input;
    postProcessedOutputs: Ai_Cf_Openai_Whisper_Large_V3_Turbo_Output;
}
type Ai_Cf_Baai_Bge_M3_Input = Ai_Cf_Baai_Bge_M3_Input_QueryAnd_Contexts | Ai_Cf_Baai_Bge_M3_Input_Embedding | {
    /**
     * Batch of the embeddings requests to run using async-queue
     */
    requests: (Ai_Cf_Baai_Bge_M3_Input_QueryAnd_Contexts_1 | Ai_Cf_Baai_Bge_M3_Input_Embedding_1)[];
};
interface Ai_Cf_Baai_Bge_M3_Input_QueryAnd_Contexts {
    /**
     * A query you wish to perform against the provided contexts. If no query is provided the model with respond with embeddings for contexts
     */
    query?: string;
    /**
     * List of provided contexts. Note that the index in this array is important, as the response will refer to it.
     */
    contexts: {
        /**
         * One of the provided context content
         */
        text?: string;
    }[];
    /**
     * When provided with too long context should the model error out or truncate the context to fit?
     */
    truncate_inputs?: boolean;
}
interface Ai_Cf_Baai_Bge_M3_Input_Embedding {
    text: string | string[];
    /**
     * When provided with too long context should the model error out or truncate the context to fit?
     */
    truncate_inputs?: boolean;
}
interface Ai_Cf_Baai_Bge_M3_Input_QueryAnd_Contexts_1 {
    /**
     * A query you wish to perform against the provided contexts. If no query is provided the model with respond with embeddings for contexts
     */
    query?: string;
    /**
     * List of provided contexts. Note that the index in this array is important, as the response will refer to it.
     */
    contexts: {
        /**
         * One of the provided context content
         */
        text?: string;
    }[];
    /**
     * When provided with too long context should the model error out or truncate the context to fit?
     */
    truncate_inputs?: boolean;
}
interface Ai_Cf_Baai_Bge_M3_Input_Embedding_1 {
    text: string | string[];
    /**
     * When provided with too long context should the model error out or truncate the context to fit?
     */
    truncate_inputs?: boolean;
}
type Ai_Cf_Baai_Bge_M3_Output = Ai_Cf_Baai_Bge_M3_Ouput_Query | Ai_Cf_Baai_Bge_M3_Output_EmbeddingFor_Contexts | Ai_Cf_Baai_Bge_M3_Ouput_Embedding | Ai_Cf_Baai_Bge_M3_AsyncResponse;
interface Ai_Cf_Baai_Bge_M3_Ouput_Query {
    response?: {
        /**
         * Index of the context in the request
         */
        id?: number;
        /**
         * Score of the context under the index.
         */
        score?: number;
    }[];
}
interface Ai_Cf_Baai_Bge_M3_Output_EmbeddingFor_Contexts {
    response?: number[][];
    shape?: number[];
    /**
     * The pooling method used in the embedding process.
     */
    pooling?: "mean" | "cls";
}
interface Ai_Cf_Baai_Bge_M3_Ouput_Embedding {
    shape?: number[];
    /**
     * Embeddings of the requested text values
     */
    data?: number[][];
    /**
     * The pooling method used in the embedding process.
     */
    pooling?: "mean" | "cls";
}
interface Ai_Cf_Baai_Bge_M3_AsyncResponse {
    /**
     * The async request id that can be used to obtain the results.
     */
    request_id?: string;
}
declare abstract class Base_Ai_Cf_Baai_Bge_M3 {
    inputs: Ai_Cf_Baai_Bge_M3_Input;
    postProcessedOutputs: Ai_Cf_Baai_Bge_M3_Output;
}
interface Ai_Cf_Black_Forest_Labs_Flux_1_Schnell_Input {
    /**
     * A text description of the image you want to generate.
     */
    prompt: string;
    /**
     * The number of diffusion steps; higher values can improve quality but take longer.
     */
    steps?: number;
}
interface Ai_Cf_Black_Forest_Labs_Flux_1_Schnell_Output {
    /**
     * The generated image in Base64 format.
     */
    image?: string;
}
declare abstract class Base_Ai_Cf_Black_Forest_Labs_Flux_1_Schnell {
    inputs: Ai_Cf_Black_Forest_Labs_Flux_1_Schnell_Input;
    postProcessedOutputs: Ai_Cf_Black_Forest_Labs_Flux_1_Schnell_Output;
}
type Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct_Input = Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct_Prompt | Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct_Messages;
interface Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    image?: number[] | (string & NonNullable<unknown>);
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
    /**
     * Name of the LoRA (Low-Rank Adaptation) model to fine-tune the base model.
     */
    lora?: string;
}
interface Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role?: string;
        /**
         * The tool call id. Must be supplied for tool calls for Mistral-3. If you don't know what to put here you can fall back to 000000001
         */
        tool_call_id?: string;
        content?: string | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        }[] | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        };
    }[];
    image?: number[] | (string & NonNullable<unknown>);
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    /**
     * If true, the response will be streamed back incrementally.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Controls the creativity of the AI's responses by adjusting how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
type Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct_Output = {
    /**
     * The generated text response from the model
     */
    response?: string;
    /**
     * An array of tool calls requests made during the response generation
     */
    tool_calls?: {
        /**
         * The arguments passed to be passed to the tool call request
         */
        arguments?: object;
        /**
         * The name of the tool to be called
         */
        name?: string;
    }[];
};
declare abstract class Base_Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct {
    inputs: Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct_Input;
    postProcessedOutputs: Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct_Output;
}
type Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Input = Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Prompt | Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Messages | Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Async_Batch;
interface Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * Name of the LoRA (Low-Rank Adaptation) model to fine-tune the base model.
     */
    lora?: string;
    response_format?: Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_JSON_Mode;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_JSON_Mode {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role: string;
        /**
         * The content of the message as a string.
         */
        content: string;
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    response_format?: Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_JSON_Mode_1;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_JSON_Mode_1 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Async_Batch {
    requests?: {
        /**
         * User-supplied reference. This field will be present in the response as well it can be used to reference the request and response. It's NOT validated to be unique.
         */
        external_reference?: string;
        /**
         * Prompt for the text generation model
         */
        prompt?: string;
        /**
         * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
         */
        stream?: boolean;
        /**
         * The maximum number of tokens to generate in the response.
         */
        max_tokens?: number;
        /**
         * Controls the randomness of the output; higher values produce more random results.
         */
        temperature?: number;
        /**
         * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
         */
        top_p?: number;
        /**
         * Random seed for reproducibility of the generation.
         */
        seed?: number;
        /**
         * Penalty for repeated tokens; higher values discourage repetition.
         */
        repetition_penalty?: number;
        /**
         * Decreases the likelihood of the model repeating the same lines verbatim.
         */
        frequency_penalty?: number;
        /**
         * Increases the likelihood of the model introducing new topics.
         */
        presence_penalty?: number;
        response_format?: Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_JSON_Mode_2;
    }[];
}
interface Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_JSON_Mode_2 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
type Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Output = {
    /**
     * The generated text response from the model
     */
    response: string;
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
    /**
     * An array of tool calls requests made during the response generation
     */
    tool_calls?: {
        /**
         * The arguments passed to be passed to the tool call request
         */
        arguments?: object;
        /**
         * The name of the tool to be called
         */
        name?: string;
    }[];
} | string | Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_AsyncResponse;
interface Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_AsyncResponse {
    /**
     * The async request id that can be used to obtain the results.
     */
    request_id?: string;
}
declare abstract class Base_Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast {
    inputs: Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Input;
    postProcessedOutputs: Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast_Output;
}
interface Ai_Cf_Meta_Llama_Guard_3_8B_Input {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender must alternate between 'user' and 'assistant'.
         */
        role: "user" | "assistant";
        /**
         * The content of the message as a string.
         */
        content: string;
    }[];
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Dictate the output format of the generated response.
     */
    response_format?: {
        /**
         * Set to json_object to process and output generated text as JSON.
         */
        type?: string;
    };
}
interface Ai_Cf_Meta_Llama_Guard_3_8B_Output {
    response?: string | {
        /**
         * Whether the conversation is safe or not.
         */
        safe?: boolean;
        /**
         * A list of what hazard categories predicted for the conversation, if the conversation is deemed unsafe.
         */
        categories?: string[];
    };
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
}
declare abstract class Base_Ai_Cf_Meta_Llama_Guard_3_8B {
    inputs: Ai_Cf_Meta_Llama_Guard_3_8B_Input;
    postProcessedOutputs: Ai_Cf_Meta_Llama_Guard_3_8B_Output;
}
interface Ai_Cf_Baai_Bge_Reranker_Base_Input {
    /**
     * A query you wish to perform against the provided contexts.
     */
    /**
     * Number of returned results starting with the best score.
     */
    top_k?: number;
    /**
     * List of provided contexts. Note that the index in this array is important, as the response will refer to it.
     */
    contexts: {
        /**
         * One of the provided context content
         */
        text?: string;
    }[];
}
interface Ai_Cf_Baai_Bge_Reranker_Base_Output {
    response?: {
        /**
         * Index of the context in the request
         */
        id?: number;
        /**
         * Score of the context under the index.
         */
        score?: number;
    }[];
}
declare abstract class Base_Ai_Cf_Baai_Bge_Reranker_Base {
    inputs: Ai_Cf_Baai_Bge_Reranker_Base_Input;
    postProcessedOutputs: Ai_Cf_Baai_Bge_Reranker_Base_Output;
}
type Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_Input = Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_Prompt | Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_Messages;
interface Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * Name of the LoRA (Low-Rank Adaptation) model to fine-tune the base model.
     */
    lora?: string;
    response_format?: Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_JSON_Mode;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_JSON_Mode {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role: string;
        /**
         * The content of the message as a string.
         */
        content: string;
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    response_format?: Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_JSON_Mode_1;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_JSON_Mode_1 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
type Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_Output = {
    /**
     * The generated text response from the model
     */
    response: string;
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
    /**
     * An array of tool calls requests made during the response generation
     */
    tool_calls?: {
        /**
         * The arguments passed to be passed to the tool call request
         */
        arguments?: object;
        /**
         * The name of the tool to be called
         */
        name?: string;
    }[];
};
declare abstract class Base_Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct {
    inputs: Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_Input;
    postProcessedOutputs: Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct_Output;
}
type Ai_Cf_Qwen_Qwq_32B_Input = Ai_Cf_Qwen_Qwq_32B_Prompt | Ai_Cf_Qwen_Qwq_32B_Messages;
interface Ai_Cf_Qwen_Qwq_32B_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Qwen_Qwq_32B_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role?: string;
        /**
         * The tool call id. Must be supplied for tool calls for Mistral-3. If you don't know what to put here you can fall back to 000000001
         */
        tool_call_id?: string;
        content?: string | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        }[] | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        };
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
type Ai_Cf_Qwen_Qwq_32B_Output = {
    /**
     * The generated text response from the model
     */
    response: string;
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
    /**
     * An array of tool calls requests made during the response generation
     */
    tool_calls?: {
        /**
         * The arguments passed to be passed to the tool call request
         */
        arguments?: object;
        /**
         * The name of the tool to be called
         */
        name?: string;
    }[];
};
declare abstract class Base_Ai_Cf_Qwen_Qwq_32B {
    inputs: Ai_Cf_Qwen_Qwq_32B_Input;
    postProcessedOutputs: Ai_Cf_Qwen_Qwq_32B_Output;
}
type Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct_Input = Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct_Prompt | Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct_Messages;
interface Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role?: string;
        /**
         * The tool call id. Must be supplied for tool calls for Mistral-3. If you don't know what to put here you can fall back to 000000001
         */
        tool_call_id?: string;
        content?: string | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        }[] | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        };
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
type Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct_Output = {
    /**
     * The generated text response from the model
     */
    response: string;
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
    /**
     * An array of tool calls requests made during the response generation
     */
    tool_calls?: {
        /**
         * The arguments passed to be passed to the tool call request
         */
        arguments?: object;
        /**
         * The name of the tool to be called
         */
        name?: string;
    }[];
};
declare abstract class Base_Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct {
    inputs: Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct_Input;
    postProcessedOutputs: Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct_Output;
}
type Ai_Cf_Google_Gemma_3_12B_It_Input = Ai_Cf_Google_Gemma_3_12B_It_Prompt | Ai_Cf_Google_Gemma_3_12B_It_Messages;
interface Ai_Cf_Google_Gemma_3_12B_It_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Google_Gemma_3_12B_It_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role?: string;
        content?: string | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        }[];
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
type Ai_Cf_Google_Gemma_3_12B_It_Output = {
    /**
     * The generated text response from the model
     */
    response: string;
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
    /**
     * An array of tool calls requests made during the response generation
     */
    tool_calls?: {
        /**
         * The arguments passed to be passed to the tool call request
         */
        arguments?: object;
        /**
         * The name of the tool to be called
         */
        name?: string;
    }[];
};
declare abstract class Base_Ai_Cf_Google_Gemma_3_12B_It {
    inputs: Ai_Cf_Google_Gemma_3_12B_It_Input;
    postProcessedOutputs: Ai_Cf_Google_Gemma_3_12B_It_Output;
}
type Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Input = Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Prompt | Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Messages | Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Async_Batch;
interface Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    response_format?: Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_JSON_Mode;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_JSON_Mode {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role?: string;
        /**
         * The tool call id. If you don't know what to put here you can fall back to 000000001
         */
        tool_call_id?: string;
        content?: string | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        }[] | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        };
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    response_format?: Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_JSON_Mode;
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Async_Batch {
    requests: (Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Prompt_Inner | Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Messages_Inner)[];
}
interface Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Prompt_Inner {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    response_format?: Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_JSON_Mode;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Messages_Inner {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role?: string;
        /**
         * The tool call id. If you don't know what to put here you can fall back to 000000001
         */
        tool_call_id?: string;
        content?: string | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        }[] | {
            /**
             * Type of the content provided
             */
            type?: string;
            text?: string;
            image_url?: {
                /**
                 * image uri with data (e.g. data:image/jpeg;base64,/9j/...). HTTP URL will not be accepted
                 */
                url?: string;
            };
        };
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    response_format?: Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_JSON_Mode;
    /**
     * JSON schema that should be fulfilled for the response.
     */
    guided_json?: object;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
type Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Output = {
    /**
     * The generated text response from the model
     */
    response: string;
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
    /**
     * An array of tool calls requests made during the response generation
     */
    tool_calls?: {
        /**
         * The tool call id.
         */
        id?: string;
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type?: string;
        /**
         * Details of the function tool.
         */
        function?: {
            /**
             * The name of the tool to be called
             */
            name?: string;
            /**
             * The arguments passed to be passed to the tool call request
             */
            arguments?: object;
        };
    }[];
};
declare abstract class Base_Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct {
    inputs: Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Input;
    postProcessedOutputs: Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct_Output;
}
type Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Input = Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Prompt | Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Messages | Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Async_Batch;
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * Name of the LoRA (Low-Rank Adaptation) model to fine-tune the base model.
     */
    lora?: string;
    response_format?: Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_JSON_Mode;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_JSON_Mode {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role: string;
        /**
         * The content of the message as a string.
         */
        content: string;
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    response_format?: Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_JSON_Mode_1;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_JSON_Mode_1 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Async_Batch {
    requests: (Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Prompt_1 | Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Messages_1)[];
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Prompt_1 {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * Name of the LoRA (Low-Rank Adaptation) model to fine-tune the base model.
     */
    lora?: string;
    response_format?: Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_JSON_Mode_2;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_JSON_Mode_2 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Messages_1 {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role: string;
        /**
         * The content of the message as a string.
         */
        content: string;
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    response_format?: Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_JSON_Mode_3;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_JSON_Mode_3 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
type Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Output = Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Chat_Completion_Response | Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Text_Completion_Response | string | Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_AsyncResponse;
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Chat_Completion_Response {
    /**
     * Unique identifier for the completion
     */
    id?: string;
    /**
     * Object type identifier
     */
    object?: "chat.completion";
    /**
     * Unix timestamp of when the completion was created
     */
    created?: number;
    /**
     * Model used for the completion
     */
    model?: string;
    /**
     * List of completion choices
     */
    choices?: {
        /**
         * Index of the choice in the list
         */
        index?: number;
        /**
         * The message generated by the model
         */
        message?: {
            /**
             * Role of the message author
             */
            role: string;
            /**
             * The content of the message
             */
            content: string;
            /**
             * Internal reasoning content (if available)
             */
            reasoning_content?: string;
            /**
             * Tool calls made by the assistant
             */
            tool_calls?: {
                /**
                 * Unique identifier for the tool call
                 */
                id: string;
                /**
                 * Type of tool call
                 */
                type: "function";
                function: {
                    /**
                     * Name of the function to call
                     */
                    name: string;
                    /**
                     * JSON string of arguments for the function
                     */
                    arguments: string;
                };
            }[];
        };
        /**
         * Reason why the model stopped generating
         */
        finish_reason?: string;
        /**
         * Stop reason (may be null)
         */
        stop_reason?: string | null;
        /**
         * Log probabilities (if requested)
         */
        logprobs?: {} | null;
    }[];
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
    /**
     * Log probabilities for the prompt (if requested)
     */
    prompt_logprobs?: {} | null;
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Text_Completion_Response {
    /**
     * Unique identifier for the completion
     */
    id?: string;
    /**
     * Object type identifier
     */
    object?: "text_completion";
    /**
     * Unix timestamp of when the completion was created
     */
    created?: number;
    /**
     * Model used for the completion
     */
    model?: string;
    /**
     * List of completion choices
     */
    choices?: {
        /**
         * Index of the choice in the list
         */
        index: number;
        /**
         * The generated text completion
         */
        text: string;
        /**
         * Reason why the model stopped generating
         */
        finish_reason: string;
        /**
         * Stop reason (may be null)
         */
        stop_reason?: string | null;
        /**
         * Log probabilities (if requested)
         */
        logprobs?: {} | null;
        /**
         * Log probabilities for the prompt (if requested)
         */
        prompt_logprobs?: {} | null;
    }[];
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
}
interface Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_AsyncResponse {
    /**
     * The async request id that can be used to obtain the results.
     */
    request_id?: string;
}
declare abstract class Base_Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8 {
    inputs: Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Input;
    postProcessedOutputs: Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8_Output;
}
interface Ai_Cf_Deepgram_Nova_3_Input {
    audio: {
        body: object;
        contentType: string;
    };
    /**
     * Sets how the model will interpret strings submitted to the custom_topic param. When strict, the model will only return topics submitted using the custom_topic param. When extended, the model will return its own detected topics in addition to those submitted using the custom_topic param.
     */
    custom_topic_mode?: "extended" | "strict";
    /**
     * Custom topics you want the model to detect within your input audio or text if present Submit up to 100
     */
    custom_topic?: string;
    /**
     * Sets how the model will interpret intents submitted to the custom_intent param. When strict, the model will only return intents submitted using the custom_intent param. When extended, the model will return its own detected intents in addition those submitted using the custom_intents param
     */
    custom_intent_mode?: "extended" | "strict";
    /**
     * Custom intents you want the model to detect within your input audio if present
     */
    custom_intent?: string;
    /**
     * Identifies and extracts key entities from content in submitted audio
     */
    detect_entities?: boolean;
    /**
     * Identifies the dominant language spoken in submitted audio
     */
    detect_language?: boolean;
    /**
     * Recognize speaker changes. Each word in the transcript will be assigned a speaker number starting at 0
     */
    diarize?: boolean;
    /**
     * Identify and extract key entities from content in submitted audio
     */
    dictation?: boolean;
    /**
     * Specify the expected encoding of your submitted audio
     */
    encoding?: "linear16" | "flac" | "mulaw" | "amr-nb" | "amr-wb" | "opus" | "speex" | "g729";
    /**
     * Arbitrary key-value pairs that are attached to the API response for usage in downstream processing
     */
    extra?: string;
    /**
     * Filler Words can help transcribe interruptions in your audio, like 'uh' and 'um'
     */
    filler_words?: boolean;
    /**
     * Key term prompting can boost or suppress specialized terminology and brands.
     */
    keyterm?: string;
    /**
     * Keywords can boost or suppress specialized terminology and brands.
     */
    keywords?: string;
    /**
     * The BCP-47 language tag that hints at the primary spoken language. Depending on the Model and API endpoint you choose only certain languages are available.
     */
    language?: string;
    /**
     * Spoken measurements will be converted to their corresponding abbreviations.
     */
    measurements?: boolean;
    /**
     * Opts out requests from the Deepgram Model Improvement Program. Refer to our Docs for pricing impacts before setting this to true. https://dpgr.am/deepgram-mip.
     */
    mip_opt_out?: boolean;
    /**
     * Mode of operation for the model representing broad area of topic that will be talked about in the supplied audio
     */
    mode?: "general" | "medical" | "finance";
    /**
     * Transcribe each audio channel independently.
     */
    multichannel?: boolean;
    /**
     * Numerals converts numbers from written format to numerical format.
     */
    numerals?: boolean;
    /**
     * Splits audio into paragraphs to improve transcript readability.
     */
    paragraphs?: boolean;
    /**
     * Profanity Filter looks for recognized profanity and converts it to the nearest recognized non-profane word or removes it from the transcript completely.
     */
    profanity_filter?: boolean;
    /**
     * Add punctuation and capitalization to the transcript.
     */
    punctuate?: boolean;
    /**
     * Redaction removes sensitive information from your transcripts.
     */
    redact?: string;
    /**
     * Search for terms or phrases in submitted audio and replaces them.
     */
    replace?: string;
    /**
     * Search for terms or phrases in submitted audio.
     */
    search?: string;
    /**
     * Recognizes the sentiment throughout a transcript or text.
     */
    sentiment?: boolean;
    /**
     * Apply formatting to transcript output. When set to true, additional formatting will be applied to transcripts to improve readability.
     */
    smart_format?: boolean;
    /**
     * Detect topics throughout a transcript or text.
     */
    topics?: boolean;
    /**
     * Segments speech into meaningful semantic units.
     */
    utterances?: boolean;
    /**
     * Seconds to wait before detecting a pause between words in submitted audio.
     */
    utt_split?: number;
    /**
     * The number of channels in the submitted audio
     */
    channels?: number;
    /**
     * Specifies whether the streaming endpoint should provide ongoing transcription updates as more audio is received. When set to true, the endpoint sends continuous updates, meaning transcription results may evolve over time. Note: Supported only for webosockets.
     */
    interim_results?: boolean;
    /**
     * Indicates how long model will wait to detect whether a speaker has finished speaking or pauses for a significant period of time. When set to a value, the streaming endpoint immediately finalizes the transcription for the processed time range and returns the transcript with a speech_final parameter set to true. Can also be set to false to disable endpointing
     */
    endpointing?: string;
    /**
     * Indicates that speech has started. You'll begin receiving Speech Started messages upon speech starting. Note: Supported only for webosockets.
     */
    vad_events?: boolean;
    /**
     * Indicates how long model will wait to send an UtteranceEnd message after a word has been transcribed. Use with interim_results. Note: Supported only for webosockets.
     */
    utterance_end_ms?: boolean;
}
interface Ai_Cf_Deepgram_Nova_3_Output {
    results?: {
        channels?: {
            alternatives?: {
                confidence?: number;
                transcript?: string;
                words?: {
                    confidence?: number;
                    end?: number;
                    start?: number;
                    word?: string;
                }[];
            }[];
        }[];
        summary?: {
            result?: string;
            short?: string;
        };
        sentiments?: {
            segments?: {
                text?: string;
                start_word?: number;
                end_word?: number;
                sentiment?: string;
                sentiment_score?: number;
            }[];
            average?: {
                sentiment?: string;
                sentiment_score?: number;
            };
        };
    };
}
declare abstract class Base_Ai_Cf_Deepgram_Nova_3 {
    inputs: Ai_Cf_Deepgram_Nova_3_Input;
    postProcessedOutputs: Ai_Cf_Deepgram_Nova_3_Output;
}
interface Ai_Cf_Qwen_Qwen3_Embedding_0_6B_Input {
    queries?: string | string[];
    /**
     * Optional instruction for the task
     */
    instruction?: string;
    documents?: string | string[];
    text?: string | string[];
}
interface Ai_Cf_Qwen_Qwen3_Embedding_0_6B_Output {
    data?: number[][];
    shape?: number[];
}
declare abstract class Base_Ai_Cf_Qwen_Qwen3_Embedding_0_6B {
    inputs: Ai_Cf_Qwen_Qwen3_Embedding_0_6B_Input;
    postProcessedOutputs: Ai_Cf_Qwen_Qwen3_Embedding_0_6B_Output;
}
type Ai_Cf_Pipecat_Ai_Smart_Turn_V2_Input = {
    /**
     * readable stream with audio data and content-type specified for that data
     */
    audio: {
        body: object;
        contentType: string;
    };
    /**
     * type of data PCM data that's sent to the inference server as raw array
     */
    dtype?: "uint8" | "float32" | "float64";
} | {
    /**
     * base64 encoded audio data
     */
    audio: string;
    /**
     * type of data PCM data that's sent to the inference server as raw array
     */
    dtype?: "uint8" | "float32" | "float64";
};
interface Ai_Cf_Pipecat_Ai_Smart_Turn_V2_Output {
    /**
     * if true, end-of-turn was detected
     */
    is_complete?: boolean;
    /**
     * probability of the end-of-turn detection
     */
    probability?: number;
}
declare abstract class Base_Ai_Cf_Pipecat_Ai_Smart_Turn_V2 {
    inputs: Ai_Cf_Pipecat_Ai_Smart_Turn_V2_Input;
    postProcessedOutputs: Ai_Cf_Pipecat_Ai_Smart_Turn_V2_Output;
}
declare abstract class Base_Ai_Cf_Openai_Gpt_Oss_120B {
    inputs: ResponsesInput;
    postProcessedOutputs: ResponsesOutput;
}
declare abstract class Base_Ai_Cf_Openai_Gpt_Oss_20B {
    inputs: ResponsesInput;
    postProcessedOutputs: ResponsesOutput;
}
interface Ai_Cf_Leonardo_Phoenix_1_0_Input {
    /**
     * A text description of the image you want to generate.
     */
    prompt: string;
    /**
     * Controls how closely the generated image should adhere to the prompt; higher values make the image more aligned with the prompt
     */
    guidance?: number;
    /**
     * Random seed for reproducibility of the image generation
     */
    seed?: number;
    /**
     * The height of the generated image in pixels
     */
    height?: number;
    /**
     * The width of the generated image in pixels
     */
    width?: number;
    /**
     * The number of diffusion steps; higher values can improve quality but take longer
     */
    num_steps?: number;
    /**
     * Specify what to exclude from the generated images
     */
    negative_prompt?: string;
}
/**
 * The generated image in JPEG format
 */
type Ai_Cf_Leonardo_Phoenix_1_0_Output = string;
declare abstract class Base_Ai_Cf_Leonardo_Phoenix_1_0 {
    inputs: Ai_Cf_Leonardo_Phoenix_1_0_Input;
    postProcessedOutputs: Ai_Cf_Leonardo_Phoenix_1_0_Output;
}
interface Ai_Cf_Leonardo_Lucid_Origin_Input {
    /**
     * A text description of the image you want to generate.
     */
    prompt: string;
    /**
     * Controls how closely the generated image should adhere to the prompt; higher values make the image more aligned with the prompt
     */
    guidance?: number;
    /**
     * Random seed for reproducibility of the image generation
     */
    seed?: number;
    /**
     * The height of the generated image in pixels
     */
    height?: number;
    /**
     * The width of the generated image in pixels
     */
    width?: number;
    /**
     * The number of diffusion steps; higher values can improve quality but take longer
     */
    num_steps?: number;
    /**
     * The number of diffusion steps; higher values can improve quality but take longer
     */
    steps?: number;
}
interface Ai_Cf_Leonardo_Lucid_Origin_Output {
    /**
     * The generated image in Base64 format.
     */
    image?: string;
}
declare abstract class Base_Ai_Cf_Leonardo_Lucid_Origin {
    inputs: Ai_Cf_Leonardo_Lucid_Origin_Input;
    postProcessedOutputs: Ai_Cf_Leonardo_Lucid_Origin_Output;
}
interface Ai_Cf_Deepgram_Aura_1_Input {
    /**
     * Speaker used to produce the audio.
     */
    speaker?: "angus" | "asteria" | "arcas" | "orion" | "orpheus" | "athena" | "luna" | "zeus" | "perseus" | "helios" | "hera" | "stella";
    /**
     * Encoding of the output audio.
     */
    encoding?: "linear16" | "flac" | "mulaw" | "alaw" | "mp3" | "opus" | "aac";
    /**
     * Container specifies the file format wrapper for the output audio. The available options depend on the encoding type..
     */
    container?: "none" | "wav" | "ogg";
    /**
     * The text content to be converted to speech
     */
    text: string;
    /**
     * Sample Rate specifies the sample rate for the output audio. Based on the encoding, different sample rates are supported. For some encodings, the sample rate is not configurable
     */
    sample_rate?: number;
    /**
     * The bitrate of the audio in bits per second. Choose from predefined ranges or specific values based on the encoding type.
     */
    bit_rate?: number;
}
/**
 * The generated audio in MP3 format
 */
type Ai_Cf_Deepgram_Aura_1_Output = string;
declare abstract class Base_Ai_Cf_Deepgram_Aura_1 {
    inputs: Ai_Cf_Deepgram_Aura_1_Input;
    postProcessedOutputs: Ai_Cf_Deepgram_Aura_1_Output;
}
interface Ai_Cf_Ai4Bharat_Indictrans2_En_Indic_1B_Input {
    /**
     * Input text to translate. Can be a single string or a list of strings.
     */
    text: string | string[];
    /**
     * Target language to translate to
     */
    target_language: "asm_Beng" | "awa_Deva" | "ben_Beng" | "bho_Deva" | "brx_Deva" | "doi_Deva" | "eng_Latn" | "gom_Deva" | "gon_Deva" | "guj_Gujr" | "hin_Deva" | "hne_Deva" | "kan_Knda" | "kas_Arab" | "kas_Deva" | "kha_Latn" | "lus_Latn" | "mag_Deva" | "mai_Deva" | "mal_Mlym" | "mar_Deva" | "mni_Beng" | "mni_Mtei" | "npi_Deva" | "ory_Orya" | "pan_Guru" | "san_Deva" | "sat_Olck" | "snd_Arab" | "snd_Deva" | "tam_Taml" | "tel_Telu" | "urd_Arab" | "unr_Deva";
}
interface Ai_Cf_Ai4Bharat_Indictrans2_En_Indic_1B_Output {
    /**
     * Translated texts
     */
    translations: string[];
}
declare abstract class Base_Ai_Cf_Ai4Bharat_Indictrans2_En_Indic_1B {
    inputs: Ai_Cf_Ai4Bharat_Indictrans2_En_Indic_1B_Input;
    postProcessedOutputs: Ai_Cf_Ai4Bharat_Indictrans2_En_Indic_1B_Output;
}
type Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Input = Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Prompt | Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Messages | Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Async_Batch;
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Prompt {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * Name of the LoRA (Low-Rank Adaptation) model to fine-tune the base model.
     */
    lora?: string;
    response_format?: Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_JSON_Mode;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_JSON_Mode {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Messages {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role: string;
        /**
         * The content of the message as a string.
         */
        content: string;
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    response_format?: Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_JSON_Mode_1;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_JSON_Mode_1 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Async_Batch {
    requests: (Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Prompt_1 | Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Messages_1)[];
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Prompt_1 {
    /**
     * The input text prompt for the model to generate a response.
     */
    prompt: string;
    /**
     * Name of the LoRA (Low-Rank Adaptation) model to fine-tune the base model.
     */
    lora?: string;
    response_format?: Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_JSON_Mode_2;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_JSON_Mode_2 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Messages_1 {
    /**
     * An array of message objects representing the conversation history.
     */
    messages: {
        /**
         * The role of the message sender (e.g., 'user', 'assistant', 'system', 'tool').
         */
        role: string;
        /**
         * The content of the message as a string.
         */
        content: string;
    }[];
    functions?: {
        name: string;
        code: string;
    }[];
    /**
     * A list of tools available for the assistant to use.
     */
    tools?: ({
        /**
         * The name of the tool. More descriptive the better.
         */
        name: string;
        /**
         * A brief description of what the tool does.
         */
        description: string;
        /**
         * Schema defining the parameters accepted by the tool.
         */
        parameters: {
            /**
             * The type of the parameters object (usually 'object').
             */
            type: string;
            /**
             * List of required parameter names.
             */
            required?: string[];
            /**
             * Definitions of each parameter.
             */
            properties: {
                [k: string]: {
                    /**
                     * The data type of the parameter.
                     */
                    type: string;
                    /**
                     * A description of the expected parameter.
                     */
                    description: string;
                };
            };
        };
    } | {
        /**
         * Specifies the type of tool (e.g., 'function').
         */
        type: string;
        /**
         * Details of the function tool.
         */
        function: {
            /**
             * The name of the function.
             */
            name: string;
            /**
             * A brief description of what the function does.
             */
            description: string;
            /**
             * Schema defining the parameters accepted by the function.
             */
            parameters: {
                /**
                 * The type of the parameters object (usually 'object').
                 */
                type: string;
                /**
                 * List of required parameter names.
                 */
                required?: string[];
                /**
                 * Definitions of each parameter.
                 */
                properties: {
                    [k: string]: {
                        /**
                         * The data type of the parameter.
                         */
                        type: string;
                        /**
                         * A description of the expected parameter.
                         */
                        description: string;
                    };
                };
            };
        };
    })[];
    response_format?: Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_JSON_Mode_3;
    /**
     * If true, a chat template is not applied and you must adhere to the specific model's expected formatting.
     */
    raw?: boolean;
    /**
     * If true, the response will be streamed back incrementally using SSE, Server Sent Events.
     */
    stream?: boolean;
    /**
     * The maximum number of tokens to generate in the response.
     */
    max_tokens?: number;
    /**
     * Controls the randomness of the output; higher values produce more random results.
     */
    temperature?: number;
    /**
     * Adjusts the creativity of the AI's responses by controlling how many possible words it considers. Lower values make outputs more predictable; higher values allow for more varied and creative responses.
     */
    top_p?: number;
    /**
     * Limits the AI to choose from the top 'k' most probable words. Lower values make responses more focused; higher values introduce more variety and potential surprises.
     */
    top_k?: number;
    /**
     * Random seed for reproducibility of the generation.
     */
    seed?: number;
    /**
     * Penalty for repeated tokens; higher values discourage repetition.
     */
    repetition_penalty?: number;
    /**
     * Decreases the likelihood of the model repeating the same lines verbatim.
     */
    frequency_penalty?: number;
    /**
     * Increases the likelihood of the model introducing new topics.
     */
    presence_penalty?: number;
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_JSON_Mode_3 {
    type?: "json_object" | "json_schema";
    json_schema?: unknown;
}
type Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Output = Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Chat_Completion_Response | Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Text_Completion_Response | string | Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_AsyncResponse;
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Chat_Completion_Response {
    /**
     * Unique identifier for the completion
     */
    id?: string;
    /**
     * Object type identifier
     */
    object?: "chat.completion";
    /**
     * Unix timestamp of when the completion was created
     */
    created?: number;
    /**
     * Model used for the completion
     */
    model?: string;
    /**
     * List of completion choices
     */
    choices?: {
        /**
         * Index of the choice in the list
         */
        index?: number;
        /**
         * The message generated by the model
         */
        message?: {
            /**
             * Role of the message author
             */
            role: string;
            /**
             * The content of the message
             */
            content: string;
            /**
             * Internal reasoning content (if available)
             */
            reasoning_content?: string;
            /**
             * Tool calls made by the assistant
             */
            tool_calls?: {
                /**
                 * Unique identifier for the tool call
                 */
                id: string;
                /**
                 * Type of tool call
                 */
                type: "function";
                function: {
                    /**
                     * Name of the function to call
                     */
                    name: string;
                    /**
                     * JSON string of arguments for the function
                     */
                    arguments: string;
                };
            }[];
        };
        /**
         * Reason why the model stopped generating
         */
        finish_reason?: string;
        /**
         * Stop reason (may be null)
         */
        stop_reason?: string | null;
        /**
         * Log probabilities (if requested)
         */
        logprobs?: {} | null;
    }[];
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
    /**
     * Log probabilities for the prompt (if requested)
     */
    prompt_logprobs?: {} | null;
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Text_Completion_Response {
    /**
     * Unique identifier for the completion
     */
    id?: string;
    /**
     * Object type identifier
     */
    object?: "text_completion";
    /**
     * Unix timestamp of when the completion was created
     */
    created?: number;
    /**
     * Model used for the completion
     */
    model?: string;
    /**
     * List of completion choices
     */
    choices?: {
        /**
         * Index of the choice in the list
         */
        index: number;
        /**
         * The generated text completion
         */
        text: string;
        /**
         * Reason why the model stopped generating
         */
        finish_reason: string;
        /**
         * Stop reason (may be null)
         */
        stop_reason?: string | null;
        /**
         * Log probabilities (if requested)
         */
        logprobs?: {} | null;
        /**
         * Log probabilities for the prompt (if requested)
         */
        prompt_logprobs?: {} | null;
    }[];
    /**
     * Usage statistics for the inference request
     */
    usage?: {
        /**
         * Total number of tokens in input
         */
        prompt_tokens?: number;
        /**
         * Total number of tokens in output
         */
        completion_tokens?: number;
        /**
         * Total number of input and output tokens
         */
        total_tokens?: number;
    };
}
interface Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_AsyncResponse {
    /**
     * The async request id that can be used to obtain the results.
     */
    request_id?: string;
}
declare abstract class Base_Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It {
    inputs: Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Input;
    postProcessedOutputs: Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It_Output;
}
interface Ai_Cf_Pfnet_Plamo_Embedding_1B_Input {
    /**
     * Input text to embed. Can be a single string or a list of strings.
     */
    text: string | string[];
}
interface Ai_Cf_Pfnet_Plamo_Embedding_1B_Output {
    /**
     * Embedding vectors, where each vector is a list of floats.
     */
    data: number[][];
    /**
     * Shape of the embedding data as [number_of_embeddings, embedding_dimension].
     *
     * @minItems 2
     * @maxItems 2
     */
    shape: [
        number,
        number
    ];
}
declare abstract class Base_Ai_Cf_Pfnet_Plamo_Embedding_1B {
    inputs: Ai_Cf_Pfnet_Plamo_Embedding_1B_Input;
    postProcessedOutputs: Ai_Cf_Pfnet_Plamo_Embedding_1B_Output;
}
interface Ai_Cf_Deepgram_Flux_Input {
    /**
     * Encoding of the audio stream. Currently only supports raw signed little-endian 16-bit PCM.
     */
    encoding: "linear16";
    /**
     * Sample rate of the audio stream in Hz.
     */
    sample_rate: string;
    /**
     * End-of-turn confidence required to fire an eager end-of-turn event. When set, enables EagerEndOfTurn and TurnResumed events. Valid Values 0.3 - 0.9.
     */
    eager_eot_threshold?: string;
    /**
     * End-of-turn confidence required to finish a turn. Valid Values 0.5 - 0.9.
     */
    eot_threshold?: string;
    /**
     * A turn will be finished when this much time has passed after speech, regardless of EOT confidence.
     */
    eot_timeout_ms?: string;
    /**
     * Keyterm prompting can improve recognition of specialized terminology. Pass multiple keyterm query parameters to boost multiple keyterms.
     */
    keyterm?: string;
    /**
     * Opts out requests from the Deepgram Model Improvement Program. Refer to Deepgram Docs for pricing impacts before setting this to true. https://dpgr.am/deepgram-mip
     */
    mip_opt_out?: "true" | "false";
    /**
     * Label your requests for the purpose of identification during usage reporting
     */
    tag?: string;
}
/**
 * Output will be returned as websocket messages.
 */
interface Ai_Cf_Deepgram_Flux_Output {
    /**
     * The unique identifier of the request (uuid)
     */
    request_id?: string;
    /**
     * Starts at 0 and increments for each message the server sends to the client.
     */
    sequence_id?: number;
    /**
     * The type of event being reported.
     */
    event?: "Update" | "StartOfTurn" | "EagerEndOfTurn" | "TurnResumed" | "EndOfTurn";
    /**
     * The index of the current turn
     */
    turn_index?: number;
    /**
     * Start time in seconds of the audio range that was transcribed
     */
    audio_window_start?: number;
    /**
     * End time in seconds of the audio range that was transcribed
     */
    audio_window_end?: number;
    /**
     * Text that was said over the course of the current turn
     */
    transcript?: string;
    /**
     * The words in the transcript
     */
    words?: {
        /**
         * The individual punctuated, properly-cased word from the transcript
         */
        word: string;
        /**
         * Confidence that this word was transcribed correctly
         */
        confidence: number;
    }[];
    /**
     * Confidence that no more speech is coming in this turn
     */
    end_of_turn_confidence?: number;
}
declare abstract class Base_Ai_Cf_Deepgram_Flux {
    inputs: Ai_Cf_Deepgram_Flux_Input;
    postProcessedOutputs: Ai_Cf_Deepgram_Flux_Output;
}
interface Ai_Cf_Deepgram_Aura_2_En_Input {
    /**
     * Speaker used to produce the audio.
     */
    speaker?: "amalthea" | "andromeda" | "apollo" | "arcas" | "aries" | "asteria" | "athena" | "atlas" | "aurora" | "callista" | "cora" | "cordelia" | "delia" | "draco" | "electra" | "harmonia" | "helena" | "hera" | "hermes" | "hyperion" | "iris" | "janus" | "juno" | "jupiter" | "luna" | "mars" | "minerva" | "neptune" | "odysseus" | "ophelia" | "orion" | "orpheus" | "pandora" | "phoebe" | "pluto" | "saturn" | "thalia" | "theia" | "vesta" | "zeus";
    /**
     * Encoding of the output audio.
     */
    encoding?: "linear16" | "flac" | "mulaw" | "alaw" | "mp3" | "opus" | "aac";
    /**
     * Container specifies the file format wrapper for the output audio. The available options depend on the encoding type..
     */
    container?: "none" | "wav" | "ogg";
    /**
     * The text content to be converted to speech
     */
    text: string;
    /**
     * Sample Rate specifies the sample rate for the output audio. Based on the encoding, different sample rates are supported. For some encodings, the sample rate is not configurable
     */
    sample_rate?: number;
    /**
     * The bitrate of the audio in bits per second. Choose from predefined ranges or specific values based on the encoding type.
     */
    bit_rate?: number;
}
/**
 * The generated audio in MP3 format
 */
type Ai_Cf_Deepgram_Aura_2_En_Output = string;
declare abstract class Base_Ai_Cf_Deepgram_Aura_2_En {
    inputs: Ai_Cf_Deepgram_Aura_2_En_Input;
    postProcessedOutputs: Ai_Cf_Deepgram_Aura_2_En_Output;
}
interface Ai_Cf_Deepgram_Aura_2_Es_Input {
    /**
     * Speaker used to produce the audio.
     */
    speaker?: "sirio" | "nestor" | "carina" | "celeste" | "alvaro" | "diana" | "aquila" | "selena" | "estrella" | "javier";
    /**
     * Encoding of the output audio.
     */
    encoding?: "linear16" | "flac" | "mulaw" | "alaw" | "mp3" | "opus" | "aac";
    /**
     * Container specifies the file format wrapper for the output audio. The available options depend on the encoding type..
     */
    container?: "none" | "wav" | "ogg";
    /**
     * The text content to be converted to speech
     */
    text: string;
    /**
     * Sample Rate specifies the sample rate for the output audio. Based on the encoding, different sample rates are supported. For some encodings, the sample rate is not configurable
     */
    sample_rate?: number;
    /**
     * The bitrate of the audio in bits per second. Choose from predefined ranges or specific values based on the encoding type.
     */
    bit_rate?: number;
}
/**
 * The generated audio in MP3 format
 */
type Ai_Cf_Deepgram_Aura_2_Es_Output = string;
declare abstract class Base_Ai_Cf_Deepgram_Aura_2_Es {
    inputs: Ai_Cf_Deepgram_Aura_2_Es_Input;
    postProcessedOutputs: Ai_Cf_Deepgram_Aura_2_Es_Output;
}
interface AiModels {
    "@cf/huggingface/distilbert-sst-2-int8": BaseAiTextClassification;
    "@cf/stabilityai/stable-diffusion-xl-base-1.0": BaseAiTextToImage;
    "@cf/runwayml/stable-diffusion-v1-5-inpainting": BaseAiTextToImage;
    "@cf/runwayml/stable-diffusion-v1-5-img2img": BaseAiTextToImage;
    "@cf/lykon/dreamshaper-8-lcm": BaseAiTextToImage;
    "@cf/bytedance/stable-diffusion-xl-lightning": BaseAiTextToImage;
    "@cf/myshell-ai/melotts": BaseAiTextToSpeech;
    "@cf/google/embeddinggemma-300m": BaseAiTextEmbeddings;
    "@cf/microsoft/resnet-50": BaseAiImageClassification;
    "@cf/meta/llama-2-7b-chat-int8": BaseAiTextGeneration;
    "@cf/mistral/mistral-7b-instruct-v0.1": BaseAiTextGeneration;
    "@cf/meta/llama-2-7b-chat-fp16": BaseAiTextGeneration;
    "@hf/thebloke/llama-2-13b-chat-awq": BaseAiTextGeneration;
    "@hf/thebloke/mistral-7b-instruct-v0.1-awq": BaseAiTextGeneration;
    "@hf/thebloke/zephyr-7b-beta-awq": BaseAiTextGeneration;
    "@hf/thebloke/openhermes-2.5-mistral-7b-awq": BaseAiTextGeneration;
    "@hf/thebloke/neural-chat-7b-v3-1-awq": BaseAiTextGeneration;
    "@hf/thebloke/llamaguard-7b-awq": BaseAiTextGeneration;
    "@hf/thebloke/deepseek-coder-6.7b-base-awq": BaseAiTextGeneration;
    "@hf/thebloke/deepseek-coder-6.7b-instruct-awq": BaseAiTextGeneration;
    "@cf/deepseek-ai/deepseek-math-7b-instruct": BaseAiTextGeneration;
    "@cf/defog/sqlcoder-7b-2": BaseAiTextGeneration;
    "@cf/openchat/openchat-3.5-0106": BaseAiTextGeneration;
    "@cf/tiiuae/falcon-7b-instruct": BaseAiTextGeneration;
    "@cf/thebloke/discolm-german-7b-v1-awq": BaseAiTextGeneration;
    "@cf/qwen/qwen1.5-0.5b-chat": BaseAiTextGeneration;
    "@cf/qwen/qwen1.5-7b-chat-awq": BaseAiTextGeneration;
    "@cf/qwen/qwen1.5-14b-chat-awq": BaseAiTextGeneration;
    "@cf/tinyllama/tinyllama-1.1b-chat-v1.0": BaseAiTextGeneration;
    "@cf/microsoft/phi-2": BaseAiTextGeneration;
    "@cf/qwen/qwen1.5-1.8b-chat": BaseAiTextGeneration;
    "@cf/mistral/mistral-7b-instruct-v0.2-lora": BaseAiTextGeneration;
    "@hf/nousresearch/hermes-2-pro-mistral-7b": BaseAiTextGeneration;
    "@hf/nexusflow/starling-lm-7b-beta": BaseAiTextGeneration;
    "@hf/google/gemma-7b-it": BaseAiTextGeneration;
    "@cf/meta-llama/llama-2-7b-chat-hf-lora": BaseAiTextGeneration;
    "@cf/google/gemma-2b-it-lora": BaseAiTextGeneration;
    "@cf/google/gemma-7b-it-lora": BaseAiTextGeneration;
    "@hf/mistral/mistral-7b-instruct-v0.2": BaseAiTextGeneration;
    "@cf/meta/llama-3-8b-instruct": BaseAiTextGeneration;
    "@cf/fblgit/una-cybertron-7b-v2-bf16": BaseAiTextGeneration;
    "@cf/meta/llama-3-8b-instruct-awq": BaseAiTextGeneration;
    "@cf/meta/llama-3.1-8b-instruct-fp8": BaseAiTextGeneration;
    "@cf/meta/llama-3.1-8b-instruct-awq": BaseAiTextGeneration;
    "@cf/meta/llama-3.2-3b-instruct": BaseAiTextGeneration;
    "@cf/meta/llama-3.2-1b-instruct": BaseAiTextGeneration;
    "@cf/deepseek-ai/deepseek-r1-distill-qwen-32b": BaseAiTextGeneration;
    "@cf/ibm-granite/granite-4.0-h-micro": BaseAiTextGeneration;
    "@cf/facebook/bart-large-cnn": BaseAiSummarization;
    "@cf/llava-hf/llava-1.5-7b-hf": BaseAiImageToText;
    "@cf/baai/bge-base-en-v1.5": Base_Ai_Cf_Baai_Bge_Base_En_V1_5;
    "@cf/openai/whisper": Base_Ai_Cf_Openai_Whisper;
    "@cf/meta/m2m100-1.2b": Base_Ai_Cf_Meta_M2M100_1_2B;
    "@cf/baai/bge-small-en-v1.5": Base_Ai_Cf_Baai_Bge_Small_En_V1_5;
    "@cf/baai/bge-large-en-v1.5": Base_Ai_Cf_Baai_Bge_Large_En_V1_5;
    "@cf/unum/uform-gen2-qwen-500m": Base_Ai_Cf_Unum_Uform_Gen2_Qwen_500M;
    "@cf/openai/whisper-tiny-en": Base_Ai_Cf_Openai_Whisper_Tiny_En;
    "@cf/openai/whisper-large-v3-turbo": Base_Ai_Cf_Openai_Whisper_Large_V3_Turbo;
    "@cf/baai/bge-m3": Base_Ai_Cf_Baai_Bge_M3;
    "@cf/black-forest-labs/flux-1-schnell": Base_Ai_Cf_Black_Forest_Labs_Flux_1_Schnell;
    "@cf/meta/llama-3.2-11b-vision-instruct": Base_Ai_Cf_Meta_Llama_3_2_11B_Vision_Instruct;
    "@cf/meta/llama-3.3-70b-instruct-fp8-fast": Base_Ai_Cf_Meta_Llama_3_3_70B_Instruct_Fp8_Fast;
    "@cf/meta/llama-guard-3-8b": Base_Ai_Cf_Meta_Llama_Guard_3_8B;
    "@cf/baai/bge-reranker-base": Base_Ai_Cf_Baai_Bge_Reranker_Base;
    "@cf/qwen/qwen2.5-coder-32b-instruct": Base_Ai_Cf_Qwen_Qwen2_5_Coder_32B_Instruct;
    "@cf/qwen/qwq-32b": Base_Ai_Cf_Qwen_Qwq_32B;
    "@cf/mistralai/mistral-small-3.1-24b-instruct": Base_Ai_Cf_Mistralai_Mistral_Small_3_1_24B_Instruct;
    "@cf/google/gemma-3-12b-it": Base_Ai_Cf_Google_Gemma_3_12B_It;
    "@cf/meta/llama-4-scout-17b-16e-instruct": Base_Ai_Cf_Meta_Llama_4_Scout_17B_16E_Instruct;
    "@cf/qwen/qwen3-30b-a3b-fp8": Base_Ai_Cf_Qwen_Qwen3_30B_A3B_Fp8;
    "@cf/deepgram/nova-3": Base_Ai_Cf_Deepgram_Nova_3;
    "@cf/qwen/qwen3-embedding-0.6b": Base_Ai_Cf_Qwen_Qwen3_Embedding_0_6B;
    "@cf/pipecat-ai/smart-turn-v2": Base_Ai_Cf_Pipecat_Ai_Smart_Turn_V2;
    "@cf/openai/gpt-oss-120b": Base_Ai_Cf_Openai_Gpt_Oss_120B;
    "@cf/openai/gpt-oss-20b": Base_Ai_Cf_Openai_Gpt_Oss_20B;
    "@cf/leonardo/phoenix-1.0": Base_Ai_Cf_Leonardo_Phoenix_1_0;
    "@cf/leonardo/lucid-origin": Base_Ai_Cf_Leonardo_Lucid_Origin;
    "@cf/deepgram/aura-1": Base_Ai_Cf_Deepgram_Aura_1;
    "@cf/ai4bharat/indictrans2-en-indic-1B": Base_Ai_Cf_Ai4Bharat_Indictrans2_En_Indic_1B;
    "@cf/aisingapore/gemma-sea-lion-v4-27b-it": Base_Ai_Cf_Aisingapore_Gemma_Sea_Lion_V4_27B_It;
    "@cf/pfnet/plamo-embedding-1b": Base_Ai_Cf_Pfnet_Plamo_Embedding_1B;
    "@cf/deepgram/flux": Base_Ai_Cf_Deepgram_Flux;
    "@cf/deepgram/aura-2-en": Base_Ai_Cf_Deepgram_Aura_2_En;
    "@cf/deepgram/aura-2-es": Base_Ai_Cf_Deepgram_Aura_2_Es;
}
type AiOptions = {
    /**
     * Send requests as an asynchronous batch job, only works for supported models
     * https://developers.cloudflare.com/workers-ai/features/batch-api
     */
    queueRequest?: boolean;
    /**
     * Establish websocket connections, only works for supported models
     */
    websocket?: boolean;
    /**
     * Tag your requests to group and view them in Cloudflare dashboard.
     *
     * Rules:
     * Tags must only contain letters, numbers, and the symbols: : - . / @
     * Each tag can have maximum 50 characters.
     * Maximum 5 tags are allowed each request.
     * Duplicate tags will removed.
     */
    tags?: string[];
    gateway?: GatewayOptions;
    returnRawResponse?: boolean;
    prefix?: string;
    extraHeaders?: object;
};
type AiModelsSearchParams = {
    author?: string;
    hide_experimental?: boolean;
    page?: number;
    per_page?: number;
    search?: string;
    source?: number;
    task?: string;
};
type AiModelsSearchObject = {
    id: string;
    source: number;
    name: string;
    description: string;
    task: {
        id: string;
        name: string;
        description: string;
    };
    tags: string[];
    properties: {
        property_id: string;
        value: string;
    }[];
};
interface InferenceUpstreamError extends Error {
}
interface AiInternalError extends Error {
}
type AiModelListType = Record<string, any>;
declare abstract class Ai<AiModelList extends AiModelListType = AiModels> {
    aiGatewayLogId: string | null;
    gateway(gatewayId: string): AiGateway;
    autorag(autoragId: string): AutoRAG;
    run<Name extends keyof AiModelList, Options extends AiOptions, InputOptions extends AiModelList[Name]["inputs"]>(model: Name, inputs: InputOptions, options?: Options): Promise<Options extends {
        returnRawResponse: true;
    } | {
        websocket: true;
    } ? Response : InputOptions extends {
        stream: true;
    } ? ReadableStream : AiModelList[Name]["postProcessedOutputs"]>;
    models(params?: AiModelsSearchParams): Promise<AiModelsSearchObject[]>;
    toMarkdown(): ToMarkdownService;
    toMarkdown(files: MarkdownDocument[], options?: ConversionRequestOptions): Promise<ConversionResponse[]>;
    toMarkdown(files: MarkdownDocument, options?: ConversionRequestOptions): Promise<ConversionResponse>;
}
type GatewayRetries = {
    maxAttempts?: 1 | 2 | 3 | 4 | 5;
    retryDelayMs?: number;
    backoff?: 'constant' | 'linear' | 'exponential';
};
type GatewayOptions = {
    id: string;
    cacheKey?: string;
    cacheTtl?: number;
    skipCache?: boolean;
    metadata?: Record<string, number | string | boolean | null | bigint>;
    collectLog?: boolean;
    eventId?: string;
    requestTimeoutMs?: number;
    retries?: GatewayRetries;
};
type UniversalGatewayOptions = Exclude<GatewayOptions, 'id'> & {
    /**
     ** @deprecated
     */
    id?: string;
};
type AiGatewayPatchLog = {
    score?: number | null;
    feedback?: -1 | 1 | null;
    metadata?: Record<string, number | string | boolean | null | bigint> | null;
};
type AiGatewayLog = {
    id: string;
    provider: string;
    model: string;
    model_type?: string;
    path: string;
    duration: number;
    request_type?: string;
    request_content_type?: string;
    status_code: number;
    response_content_type?: string;
    success: boolean;
    cached: boolean;
    tokens_in?: number;
    tokens_out?: number;
    metadata?: Record<string, number | string | boolean | null | bigint>;
    step?: number;
    cost?: number;
    custom_cost?: boolean;
    request_size: number;
    request_head?: string;
    request_head_complete: boolean;
    response_size: number;
    response_head?: string;
    response_head_complete: boolean;
    created_at: Date;
};
type AIGatewayProviders = 'workers-ai' | 'anthropic' | 'aws-bedrock' | 'azure-openai' | 'google-vertex-ai' | 'huggingface' | 'openai' | 'perplexity-ai' | 'replicate' | 'groq' | 'cohere' | 'google-ai-studio' | 'mistral' | 'grok' | 'openrouter' | 'deepseek' | 'cerebras' | 'cartesia' | 'elevenlabs' | 'adobe-firefly';
type AIGatewayHeaders = {
    'cf-aig-metadata': Record<string, number | string | boolean | null | bigint> | string;
    'cf-aig-custom-cost': {
        per_token_in?: number;
        per_token_out?: number;
    } | {
        total_cost?: number;
    } | string;
    'cf-aig-cache-ttl': number | string;
    'cf-aig-skip-cache': boolean | string;
    'cf-aig-cache-key': string;
    'cf-aig-event-id': string;
    'cf-aig-request-timeout': number | string;
    'cf-aig-max-attempts': number | string;
    'cf-aig-retry-delay': number | string;
    'cf-aig-backoff': string;
    'cf-aig-collect-log': boolean | string;
    Authorization: string;
    'Content-Type': string;
    [key: string]: string | number | boolean | object;
};
type AIGatewayUniversalRequest = {
    provider: AIGatewayProviders | string; // eslint-disable-line
    endpoint: string;
    headers: Partial<AIGatewayHeaders>;
    query: unknown;
};
interface AiGatewayInternalError extends Error {
}
interface AiGatewayLogNotFound extends Error {
}
declare abstract class AiGateway {
    patchLog(logId: string, data: AiGatewayPatchLog): Promise<void>;
    getLog(logId: string): Promise<AiGatewayLog>;
    run(data: AIGatewayUniversalRequest | AIGatewayUniversalRequest[], options?: {
        gateway?: UniversalGatewayOptions;
        extraHeaders?: object;
    }): Promise<Response>;
    getUrl(provider?: AIGatewayProviders | string): Promise<string>; // eslint-disable-line
}
interface AutoRAGInternalError extends Error {
}
interface AutoRAGNotFoundError extends Error {
}
interface AutoRAGUnauthorizedError extends Error {
}
interface AutoRAGNameNotSetError extends Error {
}
type ComparisonFilter = {
    key: string;
    type: 'eq' | 'ne' | 'gt' | 'gte' | 'lt' | 'lte';
    value: string | number | boolean;
};
type CompoundFilter = {
    type: 'and' | 'or';
    filters: ComparisonFilter[];
};
type AutoRagSearchRequest = {
    query: string;
    filters?: CompoundFilter | ComparisonFilter;
    max_num_results?: number;
    ranking_options?: {
        ranker?: string;
        score_threshold?: number;
    };
    reranking?: {
        enabled?: boolean;
        model?: string;
    };
    rewrite_query?: boolean;
};
type AutoRagAiSearchRequest = AutoRagSearchRequest & {
    stream?: boolean;
    system_prompt?: string;
};
type AutoRagAiSearchRequestStreaming = Omit<AutoRagAiSearchRequest, 'stream'> & {
    stream: true;
};
type AutoRagSearchResponse = {
    object: 'vector_store.search_results.page';
    search_query: string;
    data: {
        file_id: string;
        filename: string;
        score: number;
        attributes: Record<string, string | number | boolean | null>;
        content: {
            type: 'text';
            text: string;
        }[];
    }[];
    has_more: boolean;
    next_page: string | null;
};
type AutoRagListResponse = {
    id: string;
    enable: boolean;
    type: string;
    source: string;
    vectorize_name: string;
    paused: boolean;
    status: string;
}[];
type AutoRagAiSearchResponse = AutoRagSearchResponse & {
    response: string;
};
declare abstract class AutoRAG {
    list(): Promise<AutoRagListResponse>;
    search(params: AutoRagSearchRequest): Promise<AutoRagSearchResponse>;
    aiSearch(params: AutoRagAiSearchRequestStreaming): Promise<Response>;
    aiSearch(params: AutoRagAiSearchRequest): Promise<AutoRagAiSearchResponse>;
    aiSearch(params: AutoRagAiSearchRequest): Promise<AutoRagAiSearchResponse | Response>;
}
interface BasicImageTransformations {
    /**
     * Maximum width in image pixels. The value must be an integer.
     */
    width?: number;
    /**
     * Maximum height in image pixels. The value must be an integer.
     */
    height?: number;
    /**
     * Resizing mode as a string. It affects interpretation of width and height
     * options:
     *  - scale-down: Similar to contain, but the image is never enlarged. If
     *    the image is larger than given width or height, it will be resized.
     *    Otherwise its original size will be kept.
     *  - contain: Resizes to maximum size that fits within the given width and
     *    height. If only a single dimension is given (e.g. only width), the
     *    image will be shrunk or enlarged to exactly match that dimension.
     *    Aspect ratio is always preserved.
     *  - cover: Resizes (shrinks or enlarges) to fill the entire area of width
     *    and height. If the image has an aspect ratio different from the ratio
     *    of width and height, it will be cropped to fit.
     *  - crop: The image will be shrunk and cropped to fit within the area
     *    specified by width and height. The image will not be enlarged. For images
     *    smaller than the given dimensions it's the same as scale-down. For
     *    images larger than the given dimensions, it's the same as cover.
     *    See also trim.
     *  - pad: Resizes to the maximum size that fits within the given width and
     *    height, and then fills the remaining area with a background color
     *    (white by default). Use of this mode is not recommended, as the same
     *    effect can be more efficiently achieved with the contain mode and the
     *    CSS object-fit: contain property.
     *  - squeeze: Stretches and deforms to the width and height given, even if it
     *    breaks aspect ratio
     */
    fit?: "scale-down" | "contain" | "cover" | "crop" | "pad" | "squeeze";
    /**
     * Image segmentation using artificial intelligence models. Sets pixels not
     * within selected segment area to transparent e.g "foreground" sets every
     * background pixel as transparent.
     */
    segment?: "foreground";
    /**
     * When cropping with fit: "cover", this defines the side or point that should
     * be left uncropped. The value is either a string
     * "left", "right", "top", "bottom", "auto", or "center" (the default),
     * or an object {x, y} containing focal point coordinates in the original
     * image expressed as fractions ranging from 0.0 (top or left) to 1.0
     * (bottom or right), 0.5 being the center. {fit: "cover", gravity: "top"} will
     * crop bottom or left and right sides as necessary, but won’t crop anything
     * from the top. {fit: "cover", gravity: {x:0.5, y:0.2}} will crop each side to
     * preserve as much as possible around a point at 20% of the height of the
     * source image.
     */
    gravity?: 'face' | 'left' | 'right' | 'top' | 'bottom' | 'center' | 'auto' | 'entropy' | BasicImageTransformationsGravityCoordinates;
    /**
     * Background color to add underneath the image. Applies only to images with
     * transparency (such as PNG). Accepts any CSS color (#RRGGBB, rgba(…),
     * hsl(…), etc.)
     */
    background?: string;
    /**
     * Number of degrees (90, 180, 270) to rotate the image by. width and height
     * options refer to axes after rotation.
     */
    rotate?: 0 | 90 | 180 | 270 | 360;
}
interface BasicImageTransformationsGravityCoordinates {
    x?: number;
    y?: number;
    mode?: 'remainder' | 'box-center';
}
/**
 * In addition to the properties you can set in the RequestInit dict
 * that you pass as an argument to the Request constructor, you can
 * set certain properties of a `cf` object to control how Cloudflare
 * features are applied to that new Request.
 *
 * Note: Currently, these properties cannot be tested in the
 * playground.
 */
interface RequestInitCfProperties extends Record<string, unknown> {
    cacheEverything?: boolean;
    /**
     * A request's cache key is what determines if two requests are
     * "the same" for caching purposes. If a request has the same cache key
     * as some previous request, then we can serve the same cached response for
     * both. (e.g. 'some-key')
     *
     * Only available for Enterprise customers.
     */
    cacheKey?: string;
    /**
     * This allows you to append additional Cache-Tag response headers
     * to the origin response without modifications to the origin server.
     * This will allow for greater control over the Purge by Cache Tag feature
     * utilizing changes only in the Workers process.
     *
     * Only available for Enterprise customers.
     */
    cacheTags?: string[];
    /**
     * Force response to be cached for a given number of seconds. (e.g. 300)
     */
    cacheTtl?: number;
    /**
     * Force response to be cached for a given number of seconds based on the Origin status code.
     * (e.g. { '200-299': 86400, '404': 1, '500-599': 0 })
     */
    cacheTtlByStatus?: Record<string, number>;
    scrapeShield?: boolean;
    apps?: boolean;
    image?: RequestInitCfPropertiesImage;
    minify?: RequestInitCfPropertiesImageMinify;
    mirage?: boolean;
    polish?: "lossy" | "lossless" | "off";
    r2?: RequestInitCfPropertiesR2;
    /**
     * Redirects the request to an alternate origin server. You can use this,
     * for example, to implement load balancing across several origins.
     * (e.g.us-east.example.com)
     *
     * Note - For security reasons, the hostname set in resolveOverride must
     * be proxied on the same Cloudflare zone of the incoming request.
     * Otherwise, the setting is ignored. CNAME hosts are allowed, so to
     * resolve to a host under a different domain or a DNS only domain first
     * declare a CNAME record within your own zone’s DNS mapping to the
     * external hostname, set proxy on Cloudflare, then set resolveOverride
     * to point to that CNAME record.
     */
    resolveOverride?: string;
}
interface RequestInitCfPropertiesImageDraw extends BasicImageTransformations {
    /**
     * Absolute URL of the image file to use for the drawing. It can be any of
     * the supported file formats. For drawing of watermarks or non-rectangular
     * overlays we recommend using PNG or WebP images.
     */
    url: string;
    /**
     * Floating-point number between 0 (transparent) and 1 (opaque).
     * For example, opacity: 0.5 makes overlay semitransparent.
     */
    opacity?: number;
    /**
     * - If set to true, the overlay image will be tiled to cover the entire
     *   area. This is useful for stock-photo-like watermarks.
     * - If set to "x", the overlay image will be tiled horizontally only
     *   (form a line).
     * - If set to "y", the overlay image will be tiled vertically only
     *   (form a line).
     */
    repeat?: true | "x" | "y";
    /**
     * Position of the overlay image relative to a given edge. Each property is
     * an offset in pixels. 0 aligns exactly to the edge. For example, left: 10
     * positions left side of the overlay 10 pixels from the left edge of the
     * image it's drawn over. bottom: 0 aligns bottom of the overlay with bottom
     * of the background image.
     *
     * Setting both left & right, or both top & bottom is an error.
     *
     * If no position is specified, the image will be centered.
     */
    top?: number;
    left?: number;
    bottom?: number;
    right?: number;
}
interface RequestInitCfPropertiesImage extends BasicImageTransformations {
    /**
     * Device Pixel Ratio. Default 1. Multiplier for width/height that makes it
     * easier to specify higher-DPI sizes in <img srcset>.
     */
    dpr?: number;
    /**
     * Allows you to trim your image. Takes dpr into account and is performed before
     * resizing or rotation.
     *
     * It can be used as:
     * - left, top, right, bottom - it will specify the number of pixels to cut
     *   off each side
     * - width, height - the width/height you'd like to end up with - can be used
     *   in combination with the properties above
     * - border - this will automatically trim the surroundings of an image based on
     *   it's color. It consists of three properties:
     *    - color: rgb or hex representation of the color you wish to trim (todo: verify the rgba bit)
     *    - tolerance: difference from color to treat as color
     *    - keep: the number of pixels of border to keep
     */
    trim?: "border" | {
        top?: number;
        bottom?: number;
        left?: number;
        right?: number;
        width?: number;
        height?: number;
        border?: boolean | {
            color?: string;
            tolerance?: number;
            keep?: number;
        };
    };
    /**
     * Quality setting from 1-100 (useful values are in 60-90 range). Lower values
     * make images look worse, but load faster. The default is 85. It applies only
     * to JPEG and WebP images. It doesn’t have any effect on PNG.
     */
    quality?: number | "low" | "medium-low" | "medium-high" | "high";
    /**
     * Output format to generate. It can be:
     *  - avif: generate images in AVIF format.
     *  - webp: generate images in Google WebP format. Set quality to 100 to get
     *    the WebP-lossless format.
     *  - json: instead of generating an image, outputs information about the
     *    image, in JSON format. The JSON object will contain image size
     *    (before and after resizing), source image’s MIME type, file size, etc.
     * - jpeg: generate images in JPEG format.
     * - png: generate images in PNG format.
     */
    format?: "avif" | "webp" | "json" | "jpeg" | "png" | "baseline-jpeg" | "png-force" | "svg";
    /**
     * Whether to preserve animation frames from input files. Default is true.
     * Setting it to false reduces animations to still images. This setting is
     * recommended when enlarging images or processing arbitrary user content,
     * because large GIF animations can weigh tens or even hundreds of megabytes.
     * It is also useful to set anim:false when using format:"json" to get the
     * response quicker without the number of frames.
     */
    anim?: boolean;
    /**
     * What EXIF data should be preserved in the output image. Note that EXIF
     * rotation and embedded color profiles are always applied ("baked in" into
     * the image), and aren't affected by this option. Note that if the Polish
     * feature is enabled, all metadata may have been removed already and this
     * option may have no effect.
     *  - keep: Preserve most of EXIF metadata, including GPS location if there's
     *    any.
     *  - copyright: Only keep the copyright tag, and discard everything else.
     *    This is the default behavior for JPEG files.
     *  - none: Discard all invisible EXIF metadata. Currently WebP and PNG
     *    output formats always discard metadata.
     */
    metadata?: "keep" | "copyright" | "none";
    /**
     * Strength of sharpening filter to apply to the image. Floating-point
     * number between 0 (no sharpening, default) and 10 (maximum). 1.0 is a
     * recommended value for downscaled images.
     */
    sharpen?: number;
    /**
     * Radius of a blur filter (approximate gaussian). Maximum supported radius
     * is 250.
     */
    blur?: number;
    /**
     * Overlays are drawn in the order they appear in the array (last array
     * entry is the topmost layer).
     */
    draw?: RequestInitCfPropertiesImageDraw[];
    /**
     * Fetching image from authenticated origin. Setting this property will
     * pass authentication headers (Authorization, Cookie, etc.) through to
     * the origin.
     */
    "origin-auth"?: "share-publicly";
    /**
     * Adds a border around the image. The border is added after resizing. Border
     * width takes dpr into account, and can be specified either using a single
     * width property, or individually for each side.
     */
    border?: {
        color: string;
        width: number;
    } | {
        color: string;
        top: number;
        right: number;
        bottom: number;
        left: number;
    };
    /**
     * Increase brightness by a factor. A value of 1.0 equals no change, a value
     * of 0.5 equals half brightness, and a value of 2.0 equals twice as bright.
     * 0 is ignored.
     */
    brightness?: number;
    /**
     * Increase contrast by a factor. A value of 1.0 equals no change, a value of
     * 0.5 equals low contrast, and a value of 2.0 equals high contrast. 0 is
     * ignored.
     */
    contrast?: number;
    /**
     * Increase exposure by a factor. A value of 1.0 equals no change, a value of
     * 0.5 darkens the image, and a value of 2.0 lightens the image. 0 is ignored.
     */
    gamma?: number;
    /**
     * Increase contrast by a factor. A value of 1.0 equals no change, a value of
     * 0.5 equals low contrast, and a value of 2.0 equals high contrast. 0 is
     * ignored.
     */
    saturation?: number;
    /**
     * Flips the images horizontally, vertically, or both. Flipping is applied before
     * rotation, so if you apply flip=h,rotate=90 then the image will be flipped
     * horizontally, then rotated by 90 degrees.
     */
    flip?: 'h' | 'v' | 'hv';
    /**
     * Slightly reduces latency on a cache miss by selecting a
     * quickest-to-compress file format, at a cost of increased file size and
     * lower image quality. It will usually override the format option and choose
     * JPEG over WebP or AVIF. We do not recommend using this option, except in
     * unusual circumstances like resizing uncacheable dynamically-generated
     * images.
     */
    compression?: "fast";
}
interface RequestInitCfPropertiesImageMinify {
    javascript?: boolean;
    css?: boolean;
    html?: boolean;
}
interface RequestInitCfPropertiesR2 {
    /**
     * Colo id of bucket that an object is stored in
     */
    bucketColoId?: number;
}
/**
 * Request metadata provided by Cloudflare's edge.
 */
type IncomingRequestCfProperties<HostMetadata = unknown> = IncomingRequestCfPropertiesBase & IncomingRequestCfPropertiesBotManagementEnterprise & IncomingRequestCfPropertiesCloudflareForSaaSEnterprise<HostMetadata> & IncomingRequestCfPropertiesGeographicInformation & IncomingRequestCfPropertiesCloudflareAccessOrApiShield;
interface IncomingRequestCfPropertiesBase extends Record<string, unknown> {
    /**
     * [ASN](https://www.iana.org/assignments/as-numbers/as-numbers.xhtml) of the incoming request.
     *
     * @example 395747
     */
    asn?: number;
    /**
     * The organization which owns the ASN of the incoming request.
     *
     * @example "Google Cloud"
     */
    asOrganization?: string;
    /**
     * The original value of the `Accept-Encoding` header if Cloudflare modified it.
     *
     * @example "gzip, deflate, br"
     */
    clientAcceptEncoding?: string;
    /**
     * The number of milliseconds it took for the request to reach your worker.
     *
     * @example 22
     */
    clientTcpRtt?: number;
    /**
     * The three-letter [IATA](https://en.wikipedia.org/wiki/IATA_airport_code)
     * airport code of the data center that the request hit.
     *
     * @example "DFW"
     */
    colo: string;
    /**
     * Represents the upstream's response to a
     * [TCP `keepalive` message](https://tldp.org/HOWTO/TCP-Keepalive-HOWTO/overview.html)
     * from cloudflare.
     *
     * For workers with no upstream, this will always be `1`.
     *
     * @example 3
     */
    edgeRequestKeepAliveStatus: IncomingRequestCfPropertiesEdgeRequestKeepAliveStatus;
    /**
     * The HTTP Protocol the request used.
     *
     * @example "HTTP/2"
     */
    httpProtocol: string;
    /**
     * The browser-requested prioritization information in the request object.
     *
     * If no information was set, defaults to the empty string `""`
     *
     * @example "weight=192;exclusive=0;group=3;group-weight=127"
     * @default ""
     */
    requestPriority: string;
    /**
     * The TLS version of the connection to Cloudflare.
     * In requests served over plaintext (without TLS), this property is the empty string `""`.
     *
     * @example "TLSv1.3"
     */
    tlsVersion: string;
    /**
     * The cipher for the connection to Cloudflare.
     * In requests served over plaintext (without TLS), this property is the empty string `""`.
     *
     * @example "AEAD-AES128-GCM-SHA256"
     */
    tlsCipher: string;
    /**
     * Metadata containing the [`HELLO`](https://www.rfc-editor.org/rfc/rfc5246#section-7.4.1.2) and [`FINISHED`](https://www.rfc-editor.org/rfc/rfc5246#section-7.4.9) messages from this request's TLS handshake.
     *
     * If the incoming request was served over plaintext (without TLS) this field is undefined.
     */
    tlsExportedAuthenticator?: IncomingRequestCfPropertiesExportedAuthenticatorMetadata;
}
interface IncomingRequestCfPropertiesBotManagementBase {
    /**
     * Cloudflare’s [level of certainty](https://developers.cloudflare.com/bots/concepts/bot-score/) that a request comes from a bot,
     * represented as an integer percentage between `1` (almost certainly a bot) and `99` (almost certainly human).
     *
     * @example 54
     */
    score: number;
    /**
     * A boolean value that is true if the request comes from a good bot, like Google or Bing.
     * Most customers choose to allow this traffic. For more details, see [Traffic from known bots](https://developers.cloudflare.com/firewall/known-issues-and-faq/#how-does-firewall-rules-handle-traffic-from-known-bots).
     */
    verifiedBot: boolean;
    /**
     * A boolean value that is true if the request originates from a
     * Cloudflare-verified proxy service.
     */
    corporateProxy: boolean;
    /**
     * A boolean value that's true if the request matches [file extensions](https://developers.cloudflare.com/bots/reference/static-resources/) for many types of static resources.
     */
    staticResource: boolean;
    /**
     * List of IDs that correlate to the Bot Management heuristic detections made on a request (you can have multiple heuristic detections on the same request).
     */
    detectionIds: number[];
}
interface IncomingRequestCfPropertiesBotManagement {
    /**
     * Results of Cloudflare's Bot Management analysis
     */
    botManagement: IncomingRequestCfPropertiesBotManagementBase;
    /**
     * Duplicate of `botManagement.score`.
     *
     * @deprecated
     */
    clientTrustScore: number;
}
interface IncomingRequestCfPropertiesBotManagementEnterprise extends IncomingRequestCfPropertiesBotManagement {
    /**
     * Results of Cloudflare's Bot Management analysis
     */
    botManagement: IncomingRequestCfPropertiesBotManagementBase & {
        /**
         * A [JA3 Fingerprint](https://developers.cloudflare.com/bots/concepts/ja3-fingerprint/) to help profile specific SSL/TLS clients
         * across different destination IPs, Ports, and X509 certificates.
         */
        ja3Hash: string;
    };
}
interface IncomingRequestCfPropertiesCloudflareForSaaSEnterprise<HostMetadata> {
    /**
     * Custom metadata set per-host in [Cloudflare for SaaS](https://developers.cloudflare.com/cloudflare-for-platforms/cloudflare-for-saas/).
     *
     * This field is only present if you have Cloudflare for SaaS enabled on your account
     * and you have followed the [required steps to enable it]((https://developers.cloudflare.com/cloudflare-for-platforms/cloudflare-for-saas/domain-support/custom-metadata/)).
     */
    hostMetadata?: HostMetadata;
}
interface IncomingRequestCfPropertiesCloudflareAccessOrApiShield {
    /**
     * Information about the client certificate presented to Cloudflare.
     *
     * This is populated when the incoming request is served over TLS using
     * either Cloudflare Access or API Shield (mTLS)
     * and the presented SSL certificate has a valid
     * [Certificate Serial Number](https://ldapwiki.com/wiki/Certificate%20Serial%20Number)
     * (i.e., not `null` or `""`).
     *
     * Otherwise, a set of placeholder values are used.
     *
     * The property `certPresented` will be set to `"1"` when
     * the object is populated (i.e. the above conditions were met).
     */
    tlsClientAuth: IncomingRequestCfPropertiesTLSClientAuth | IncomingRequestCfPropertiesTLSClientAuthPlaceholder;
}
/**
 * Metadata about the request's TLS handshake
 */
interface IncomingRequestCfPropertiesExportedAuthenticatorMetadata {
    /**
     * The client's [`HELLO` message](https://www.rfc-editor.org/rfc/rfc5246#section-7.4.1.2), encoded in hexadecimal
     *
     * @example "44372ba35fa1270921d318f34c12f155dc87b682cf36a790cfaa3ba8737a1b5d"
     */
    clientHandshake: string;
    /**
     * The server's [`HELLO` message](https://www.rfc-editor.org/rfc/rfc5246#section-7.4.1.2), encoded in hexadecimal
     *
     * @example "44372ba35fa1270921d318f34c12f155dc87b682cf36a790cfaa3ba8737a1b5d"
     */
    serverHandshake: string;
    /**
     * The client's [`FINISHED` message](https://www.rfc-editor.org/rfc/rfc5246#section-7.4.9), encoded in hexadecimal
     *
     * @example "084ee802fe1348f688220e2a6040a05b2199a761f33cf753abb1b006792d3f8b"
     */
    clientFinished: string;
    /**
     * The server's [`FINISHED` message](https://www.rfc-editor.org/rfc/rfc5246#section-7.4.9), encoded in hexadecimal
     *
     * @example "084ee802fe1348f688220e2a6040a05b2199a761f33cf753abb1b006792d3f8b"
     */
    serverFinished: string;
}
/**
 * Geographic data about the request's origin.
 */
interface IncomingRequestCfPropertiesGeographicInformation {
    /**
     * The [ISO 3166-1 Alpha 2](https://www.iso.org/iso-3166-country-codes.html) country code the request originated from.
     *
     * If your worker is [configured to accept TOR connections](https://support.cloudflare.com/hc/en-us/articles/203306930-Understanding-Cloudflare-Tor-support-and-Onion-Routing), this may also be `"T1"`, indicating a request that originated over TOR.
     *
     * If Cloudflare is unable to determine where the request originated this property is omitted.
     *
     * The country code `"T1"` is used for requests originating on TOR.
     *
     * @example "GB"
     */
    country?: Iso3166Alpha2Code | "T1";
    /**
     * If present, this property indicates that the request originated in the EU
     *
     * @example "1"
     */
    isEUCountry?: "1";
    /**
     * A two-letter code indicating the continent the request originated from.
     *
     * @example "AN"
     */
    continent?: ContinentCode;
    /**
     * The city the request originated from
     *
     * @example "Austin"
     */
    city?: string;
    /**
     * Postal code of the incoming request
     *
     * @example "78701"
     */
    postalCode?: string;
    /**
     * Latitude of the incoming request
     *
     * @example "30.27130"
     */
    latitude?: string;
    /**
     * Longitude of the incoming request
     *
     * @example "-97.74260"
     */
    longitude?: string;
    /**
     * Timezone of the incoming request
     *
     * @example "America/Chicago"
     */
    timezone?: string;
    /**
     * If known, the ISO 3166-2 name for the first level region associated with
     * the IP address of the incoming request
     *
     * @example "Texas"
     */
    region?: string;
    /**
     * If known, the ISO 3166-2 code for the first-level region associated with
     * the IP address of the incoming request
     *
     * @example "TX"
     */
    regionCode?: string;
    /**
     * Metro code (DMA) of the incoming request
     *
     * @example "635"
     */
    metroCode?: string;
}
/** Data about the incoming request's TLS certificate */
interface IncomingRequestCfPropertiesTLSClientAuth {
    /** Always `"1"`, indicating that the certificate was presented */
    certPresented: "1";
    /**
     * Result of certificate verification.
     *
     * @example "FAILED:self signed certificate"
     */
    certVerified: Exclude<CertVerificationStatus, "NONE">;
    /** The presented certificate's revokation status.
     *
     * - A value of `"1"` indicates the certificate has been revoked
     * - A value of `"0"` indicates the certificate has not been revoked
     */
    certRevoked: "1" | "0";
    /**
     * The certificate issuer's [distinguished name](https://knowledge.digicert.com/generalinformation/INFO1745.html)
     *
     * @example "CN=cloudflareaccess.com, C=US, ST=Texas, L=Austin, O=Cloudflare"
     */
    certIssuerDN: string;
    /**
     * The certificate subject's [distinguished name](https://knowledge.digicert.com/generalinformation/INFO1745.html)
     *
     * @example "CN=*.cloudflareaccess.com, C=US, ST=Texas, L=Austin, O=Cloudflare"
     */
    certSubjectDN: string;
    /**
     * The certificate issuer's [distinguished name](https://knowledge.digicert.com/generalinformation/INFO1745.html) ([RFC 2253](https://www.rfc-editor.org/rfc/rfc2253.html) formatted)
     *
     * @example "CN=cloudflareaccess.com, C=US, ST=Texas, L=Austin, O=Cloudflare"
     */
    certIssuerDNRFC2253: string;
    /**
     * The certificate subject's [distinguished name](https://knowledge.digicert.com/generalinformation/INFO1745.html) ([RFC 2253](https://www.rfc-editor.org/rfc/rfc2253.html) formatted)
     *
     * @example "CN=*.cloudflareaccess.com, C=US, ST=Texas, L=Austin, O=Cloudflare"
     */
    certSubjectDNRFC2253: string;
    /** The certificate issuer's distinguished name (legacy policies) */
    certIssuerDNLegacy: string;
    /** The certificate subject's distinguished name (legacy policies) */
    certSubjectDNLegacy: string;
    /**
     * The certificate's serial number
     *
     * @example "00936EACBE07F201DF"
     */
    certSerial: string;
    /**
     * The certificate issuer's serial number
     *
     * @example "2489002934BDFEA34"
     */
    certIssuerSerial: string;
    /**
     * The certificate's Subject Key Identifier
     *
     * @example "BB:AF:7E:02:3D:FA:A6:F1:3C:84:8E:AD:EE:38:98:EC:D9:32:32:D4"
     */
    certSKI: string;
    /**
     * The certificate issuer's Subject Key Identifier
     *
     * @example "BB:AF:7E:02:3D:FA:A6:F1:3C:84:8E:AD:EE:38:98:EC:D9:32:32:D4"
     */
    certIssuerSKI: string;
    /**
     * The certificate's SHA-1 fingerprint
     *
     * @example "6b9109f323999e52259cda7373ff0b4d26bd232e"
     */
    certFingerprintSHA1: string;
    /**
     * The certificate's SHA-256 fingerprint
     *
     * @example "acf77cf37b4156a2708e34c4eb755f9b5dbbe5ebb55adfec8f11493438d19e6ad3f157f81fa3b98278453d5652b0c1fd1d71e5695ae4d709803a4d3f39de9dea"
     */
    certFingerprintSHA256: string;
    /**
     * The effective starting date of the certificate
     *
     * @example "Dec 22 19:39:00 2018 GMT"
     */
    certNotBefore: string;
    /**
     * The effective expiration date of the certificate
     *
     * @example "Dec 22 19:39:00 2018 GMT"
     */
    certNotAfter: string;
}
/** Placeholder values for TLS Client Authorization */
interface IncomingRequestCfPropertiesTLSClientAuthPlaceholder {
    certPresented: "0";
    certVerified: "NONE";
    certRevoked: "0";
    certIssuerDN: "";
    certSubjectDN: "";
    certIssuerDNRFC2253: "";
    certSubjectDNRFC2253: "";
    certIssuerDNLegacy: "";
    certSubjectDNLegacy: "";
    certSerial: "";
    certIssuerSerial: "";
    certSKI: "";
    certIssuerSKI: "";
    certFingerprintSHA1: "";
    certFingerprintSHA256: "";
    certNotBefore: "";
    certNotAfter: "";
}
/** Possible outcomes of TLS verification */
declare type CertVerificationStatus = 
/** Authentication succeeded */
"SUCCESS"
/** No certificate was presented */
 | "NONE"
/** Failed because the certificate was self-signed */
 | "FAILED:self signed certificate"
/** Failed because the certificate failed a trust chain check */
 | "FAILED:unable to verify the first certificate"
/** Failed because the certificate not yet valid */
 | "FAILED:certificate is not yet valid"
/** Failed because the certificate is expired */
 | "FAILED:certificate has expired"
/** Failed for another unspecified reason */
 | "FAILED";
/**
 * An upstream endpoint's response to a TCP `keepalive` message from Cloudflare.
 */
declare type IncomingRequestCfPropertiesEdgeRequestKeepAliveStatus = 0 /** Unknown */ | 1 /** no keepalives (not found) */ | 2 /** no connection re-use, opening keepalive connection failed */ | 3 /** no connection re-use, keepalive accepted and saved */ | 4 /** connection re-use, refused by the origin server (`TCP FIN`) */ | 5; /** connection re-use, accepted by the origin server */
/** ISO 3166-1 Alpha-2 codes */
declare type Iso3166Alpha2Code = "AD" | "AE" | "AF" | "AG" | "AI" | "AL" | "AM" | "AO" | "AQ" | "AR" | "AS" | "AT" | "AU" | "AW" | "AX" | "AZ" | "BA" | "BB" | "BD" | "BE" | "BF" | "BG" | "BH" | "BI" | "BJ" | "BL" | "BM" | "BN" | "BO" | "BQ" | "BR" | "BS" | "BT" | "BV" | "BW" | "BY" | "BZ" | "CA" | "CC" | "CD" | "CF" | "CG" | "CH" | "CI" | "CK" | "CL" | "CM" | "CN" | "CO" | "CR" | "CU" | "CV" | "CW" | "CX" | "CY" | "CZ" | "DE" | "DJ" | "DK" | "DM" | "DO" | "DZ" | "EC" | "EE" | "EG" | "EH" | "ER" | "ES" | "ET" | "FI" | "FJ" | "FK" | "FM" | "FO" | "FR" | "GA" | "GB" | "GD" | "GE" | "GF" | "GG" | "GH" | "GI" | "GL" | "GM" | "GN" | "GP" | "GQ" | "GR" | "GS" | "GT" | "GU" | "GW" | "GY" | "HK" | "HM" | "HN" | "HR" | "HT" | "HU" | "ID" | "IE" | "IL" | "IM" | "IN" | "IO" | "IQ" | "IR" | "IS" | "IT" | "JE" | "JM" | "JO" | "JP" | "KE" | "KG" | "KH" | "KI" | "KM" | "KN" | "KP" | "KR" | "KW" | "KY" | "KZ" | "LA" | "LB" | "LC" | "LI" | "LK" | "LR" | "LS" | "LT" | "LU" | "LV" | "LY" | "MA" | "MC" | "MD" | "ME" | "MF" | "MG" | "MH" | "MK" | "ML" | "MM" | "MN" | "MO" | "MP" | "MQ" | "MR" | "MS" | "MT" | "MU" | "MV" | "MW" | "MX" | "MY" | "MZ" | "NA" | "NC" | "NE" | "NF" | "NG" | "NI" | "NL" | "NO" | "NP" | "NR" | "NU" | "NZ" | "OM" | "PA" | "PE" | "PF" | "PG" | "PH" | "PK" | "PL" | "PM" | "PN" | "PR" | "PS" | "PT" | "PW" | "PY" | "QA" | "RE" | "RO" | "RS" | "RU" | "RW" | "SA" | "SB" | "SC" | "SD" | "SE" | "SG" | "SH" | "SI" | "SJ" | "SK" | "SL" | "SM" | "SN" | "SO" | "SR" | "SS" | "ST" | "SV" | "SX" | "SY" | "SZ" | "TC" | "TD" | "TF" | "TG" | "TH" | "TJ" | "TK" | "TL" | "TM" | "TN" | "TO" | "TR" | "TT" | "TV" | "TW" | "TZ" | "UA" | "UG" | "UM" | "US" | "UY" | "UZ" | "VA" | "VC" | "VE" | "VG" | "VI" | "VN" | "VU" | "WF" | "WS" | "YE" | "YT" | "ZA" | "ZM" | "ZW";
/** The 2-letter continent codes Cloudflare uses */
declare type ContinentCode = "AF" | "AN" | "AS" | "EU" | "NA" | "OC" | "SA";
type CfProperties<HostMetadata = unknown> = IncomingRequestCfProperties<HostMetadata> | RequestInitCfProperties;
interface D1Meta {
    duration: number;
    size_after: number;
    rows_read: number;
    rows_written: number;
    last_row_id: number;
    changed_db: boolean;
    changes: number;
    /**
     * The region of the database instance that executed the query.
     */
    served_by_region?: string;
    /**
     * The three letters airport code of the colo that executed the query.
     */
    served_by_colo?: string;
    /**
     * True if-and-only-if the database instance that executed the query was the primary.
     */
    served_by_primary?: boolean;
    timings?: {
        /**
         * The duration of the SQL query execution by the database instance. It doesn't include any network time.
         */
        sql_duration_ms: number;
    };
    /**
     * Number of total attempts to execute the query, due to automatic retries.
     * Note: All other fields in the response like `timings` only apply to the last attempt.
     */
    total_attempts?: number;
}
interface D1Response {
    success: true;
    meta: D1Meta & Record<string, unknown>;
    error?: never;
}
type D1Result<T = unknown> = D1Response & {
    results: T[];
};
interface D1ExecResult {
    count: number;
    duration: number;
}
type D1SessionConstraint = 
// Indicates that the first query should go to the primary, and the rest queries
// using the same D1DatabaseSession will go to any replica that is consistent with
// the bookmark maintained by the session (returned by the first query).
'first-primary'
// Indicates that the first query can go anywhere (primary or replica), and the rest queries
// using the same D1DatabaseSession will go to any replica that is consistent with
// the bookmark maintained by the session (returned by the first query).
 | 'first-unconstrained';
type D1SessionBookmark = string;
declare abstract class D1Database {
    prepare(query: string): D1PreparedStatement;
    batch<T = unknown>(statements: D1PreparedStatement[]): Promise<D1Result<T>[]>;
    exec(query: string): Promise<D1ExecResult>;
    /**
     * Creates a new D1 Session anchored at the given constraint or the bookmark.
     * All queries executed using the created session will have sequential consistency,
     * meaning that all writes done through the session will be visible in subsequent reads.
     *
     * @param constraintOrBookmark Either the session constraint or the explicit bookmark to anchor the created session.
     */
    withSession(constraintOrBookmark?: D1SessionBookmark | D1SessionConstraint): D1DatabaseSession;
    /**
     * @deprecated dump() will be removed soon, only applies to deprecated alpha v1 databases.
     */
    dump(): Promise<ArrayBuffer>;
}
declare abstract class D1DatabaseSession {
    prepare(query: string): D1PreparedStatement;
    batch<T = unknown>(statements: D1PreparedStatement[]): Promise<D1Result<T>[]>;
    /**
     * @returns The latest session bookmark across all executed queries on the session.
     *          If no query has been executed yet, `null` is returned.
     */
    getBookmark(): D1SessionBookmark | null;
}
declare abstract class D1PreparedStatement {
    bind(...values: unknown[]): D1PreparedStatement;
    first<T = unknown>(colName: string): Promise<T | null>;
    first<T = Record<string, unknown>>(): Promise<T | null>;
    run<T = Record<string, unknown>>(): Promise<D1Result<T>>;
    all<T = Record<string, unknown>>(): Promise<D1Result<T>>;
    raw<T = unknown[]>(options: {
        columnNames: true;
    }): Promise<[
        string[],
        ...T[]
    ]>;
    raw<T = unknown[]>(options?: {
        columnNames?: false;
    }): Promise<T[]>;
}
// `Disposable` was added to TypeScript's standard lib types in version 5.2.
// To support older TypeScript versions, define an empty `Disposable` interface.
// Users won't be able to use `using`/`Symbol.dispose` without upgrading to 5.2,
// but this will ensure type checking on older versions still passes.
// TypeScript's interface merging will ensure our empty interface is effectively
// ignored when `Disposable` is included in the standard lib.
interface Disposable {
}
/**
 * The returned data after sending an email
 */
interface EmailSendResult {
    /**
     * The Email Message ID
     */
    messageId: string;
}
/**
 * An email message that can be sent from a Worker.
 */
interface EmailMessage {
    /**
     * Envelope From attribute of the email message.
     */
    readonly from: string;
    /**
     * Envelope To attribute of the email message.
     */
    readonly to: string;
}
/**
 * An email message that is sent to a consumer Worker and can be rejected/forwarded.
 */
interface ForwardableEmailMessage extends EmailMessage {
    /**
     * Stream of the email message content.
     */
    readonly raw: ReadableStream<Uint8Array>;
    /**
     * An [Headers object](https://developer.mozilla.org/en-US/docs/Web/API/Headers).
     */
    readonly headers: Headers;
    /**
     * Size of the email message content.
     */
    readonly rawSize: number;
    /**
     * Reject this email message by returning a permanent SMTP error back to the connecting client including the given reason.
     * @param reason The reject reason.
     * @returns void
     */
    setReject(reason: string): void;
    /**
     * Forward this email message to a verified destination address of the account.
     * @param rcptTo Verified destination address.
     * @param headers A [Headers object](https://developer.mozilla.org/en-US/docs/Web/API/Headers).
     * @returns A promise that resolves when the email message is forwarded.
     */
    forward(rcptTo: string, headers?: Headers): Promise<EmailSendResult>;
    /**
     * Reply to the sender of this email message with a new EmailMessage object.
     * @param message The reply message.
     * @returns A promise that resolves when the email message is replied.
     */
    reply(message: EmailMessage): Promise<EmailSendResult>;
}
/** A file attachment for an email message */
type EmailAttachment = {
    disposition: 'inline';
    contentId: string;
    filename: string;
    type: string;
    content: string | ArrayBuffer | ArrayBufferView;
} | {
    disposition: 'attachment';
    contentId?: undefined;
    filename: string;
    type: string;
    content: string | ArrayBuffer | ArrayBufferView;
};
/** An Email Address */
interface EmailAddress {
    name: string;
    email: string;
}
/**
 * A binding that allows a Worker to send email messages.
 */
interface SendEmail {
    send(message: EmailMessage): Promise<EmailSendResult>;
    send(builder: {
        from: string | EmailAddress;
        to: string | string[];
        subject: string;
        replyTo?: string | EmailAddress;
        cc?: string | string[];
        bcc?: string | string[];
        headers?: Record<string, string>;
        text?: string;
        html?: string;
        attachments?: EmailAttachment[];
    }): Promise<EmailSendResult>;
}
declare abstract class EmailEvent extends ExtendableEvent {
    readonly message: ForwardableEmailMessage;
}
declare type EmailExportedHandler<Env = unknown> = (message: ForwardableEmailMessage, env: Env, ctx: ExecutionContext) => void | Promise<void>;
declare module "cloudflare:email" {
    let _EmailMessage: {
        prototype: EmailMessage;
        new (from: string, to: string, raw: ReadableStream | string): EmailMessage;
    };
    export { _EmailMessage as EmailMessage };
}
/**
 * Hello World binding to serve as an explanatory example. DO NOT USE
 */
interface HelloWorldBinding {
    /**
     * Retrieve the current stored value
     */
    get(): Promise<{
        value: string;
        ms?: number;
    }>;
    /**
     * Set a new stored value
     */
    set(value: string): Promise<void>;
}
interface Hyperdrive {
    /**
     * Connect directly to Hyperdrive as if it's your database, returning a TCP socket.
     *
     * Calling this method returns an identical socket to if you call
     * `connect("host:port")` using the `host` and `port` fields from this object.
     * Pick whichever approach works better with your preferred DB client library.
     *
     * Note that this socket is not yet authenticated -- it's expected that your
     * code (or preferably, the client library of your choice) will authenticate
     * using the information in this class's readonly fields.
     */
    connect(): Socket;
    /**
     * A valid DB connection string that can be passed straight into the typical
     * client library/driver/ORM. This will typically be the easiest way to use
     * Hyperdrive.
     */
    readonly connectionString: string;
    /*
     * A randomly generated hostname that is only valid within the context of the
     * currently running Worker which, when passed into `connect()` function from
     * the "cloudflare:sockets" module, will connect to the Hyperdrive instance
     * for your database.
     */
    readonly host: string;
    /*
     * The port that must be paired the the host field when connecting.
     */
    readonly port: number;
    /*
     * The username to use when authenticating to your database via Hyperdrive.
     * Unlike the host and password, this will be the same every time
     */
    readonly user: string;
    /*
     * The randomly generated password to use when authenticating to your
     * database via Hyperdrive. Like the host field, this password is only valid
     * within the context of the currently running Worker instance from which
     * it's read.
     */
    readonly password: string;
    /*
     * The name of the database to connect to.
     */
    readonly database: string;
}
// Copyright (c) 2024 Cloudflare, Inc.
// Licensed under the Apache 2.0 license found in the LICENSE file or at:
//     https://opensource.org/licenses/Apache-2.0
type ImageInfoResponse = {
    format: 'image/svg+xml';
} | {
    format: string;
    fileSize: number;
    width: number;
    height: number;
};
type ImageTransform = {
    width?: number;
    height?: number;
    background?: string;
    blur?: number;
    border?: {
        color?: string;
        width?: number;
    } | {
        top?: number;
        bottom?: number;
        left?: number;
        right?: number;
    };
    brightness?: number;
    contrast?: number;
    fit?: 'scale-down' | 'contain' | 'pad' | 'squeeze' | 'cover' | 'crop';
    flip?: 'h' | 'v' | 'hv';
    gamma?: number;
    segment?: 'foreground';
    gravity?: 'face' | 'left' | 'right' | 'top' | 'bottom' | 'center' | 'auto' | 'entropy' | {
        x?: number;
        y?: number;
        mode: 'remainder' | 'box-center';
    };
    rotate?: 0 | 90 | 180 | 270;
    saturation?: number;
    sharpen?: number;
    trim?: 'border' | {
        top?: number;
        bottom?: number;
        left?: number;
        right?: number;
        width?: number;
        height?: number;
        border?: boolean | {
            color?: string;
            tolerance?: number;
            keep?: number;
        };
    };
};
type ImageDrawOptions = {
    opacity?: number;
    repeat?: boolean | string;
    top?: number;
    left?: number;
    bottom?: number;
    right?: number;
};
type ImageInputOptions = {
    encoding?: 'base64';
};
type ImageOutputOptions = {
    format: 'image/jpeg' | 'image/png' | 'image/gif' | 'image/webp' | 'image/avif' | 'rgb' | 'rgba';
    quality?: number;
    background?: string;
    anim?: boolean;
};
interface ImagesBinding {
    /**
     * Get image metadata (type, width and height)
     * @throws {@link ImagesError} with code 9412 if input is not an image
     * @param stream The image bytes
     */
    info(stream: ReadableStream<Uint8Array>, options?: ImageInputOptions): Promise<ImageInfoResponse>;
    /**
     * Begin applying a series of transformations to an image
     * @param stream The image bytes
     * @returns A transform handle
     */
    input(stream: ReadableStream<Uint8Array>, options?: ImageInputOptions): ImageTransformer;
}
interface ImageTransformer {
    /**
     * Apply transform next, returning a transform handle.
     * You can then apply more transformations, draw, or retrieve the output.
     * @param transform
     */
    transform(transform: ImageTransform): ImageTransformer;
    /**
     * Draw an image on this transformer, returning a transform handle.
     * You can then apply more transformations, draw, or retrieve the output.
     * @param image The image (or transformer that will give the image) to draw
     * @param options The options configuring how to draw the image
     */
    draw(image: ReadableStream<Uint8Array> | ImageTransformer, options?: ImageDrawOptions): ImageTransformer;
    /**
     * Retrieve the image that results from applying the transforms to the
     * provided input
     * @param options Options that apply to the output e.g. output format
     */
    output(options: ImageOutputOptions): Promise<ImageTransformationResult>;
}
type ImageTransformationOutputOptions = {
    encoding?: 'base64';
};
interface ImageTransformationResult {
    /**
     * The image as a response, ready to store in cache or return to users
     */
    response(): Response;
    /**
     * The content type of the returned image
     */
    contentType(): string;
    /**
     * The bytes of the response
     */
    image(options?: ImageTransformationOutputOptions): ReadableStream<Uint8Array>;
}
interface ImagesError extends Error {
    readonly code: number;
    readonly message: string;
    readonly stack?: string;
}
/**
 * Media binding for transforming media streams.
 * Provides the entry point for media transformation operations.
 */
interface MediaBinding {
    /**
     * Creates a media transformer from an input stream.
     * @param media - The input media bytes
     * @returns A MediaTransformer instance for applying transformations
     */
    input(media: ReadableStream<Uint8Array>): MediaTransformer;
}
/**
 * Media transformer for applying transformation operations to media content.
 * Handles sizing, fitting, and other input transformation parameters.
 */
interface MediaTransformer {
    /**
     * Applies transformation options to the media content.
     * @param transform - Configuration for how the media should be transformed
     * @returns A generator for producing the transformed media output
     */
    transform(transform: MediaTransformationInputOptions): MediaTransformationGenerator;
}
/**
 * Generator for producing media transformation results.
 * Configures the output format and parameters for the transformed media.
 */
interface MediaTransformationGenerator {
    /**
     * Generates the final media output with specified options.
     * @param output - Configuration for the output format and parameters
     * @returns The final transformation result containing the transformed media
     */
    output(output: MediaTransformationOutputOptions): MediaTransformationResult;
}
/**
 * Result of a media transformation operation.
 * Provides multiple ways to access the transformed media content.
 */
interface MediaTransformationResult {
    /**
     * Returns the transformed media as a readable stream of bytes.
     * @returns A stream containing the transformed media data
     */
    media(): ReadableStream<Uint8Array>;
    /**
     * Returns the transformed media as an HTTP response object.
     * @returns The transformed media as a Response, ready to store in cache or return to users
     */
    response(): Response;
    /**
     * Returns the MIME type of the transformed media.
     * @returns The content type string (e.g., 'image/jpeg', 'video/mp4')
     */
    contentType(): string;
}
/**
 * Configuration options for transforming media input.
 * Controls how the media should be resized and fitted.
 */
type MediaTransformationInputOptions = {
    /** How the media should be resized to fit the specified dimensions */
    fit?: 'contain' | 'cover' | 'scale-down';
    /** Target width in pixels */
    width?: number;
    /** Target height in pixels */
    height?: number;
};
/**
 * Configuration options for Media Transformations output.
 * Controls the format, timing, and type of the generated output.
 */
type MediaTransformationOutputOptions = {
    /**
     * Output mode determining the type of media to generate
     */
    mode?: 'video' | 'spritesheet' | 'frame' | 'audio';
    /** Whether to include audio in the output */
    audio?: boolean;
    /**
     * Starting timestamp for frame extraction or start time for clips. (e.g. '2s').
     */
    time?: string;
    /**
     * Duration for video clips, audio extraction, and spritesheet generation (e.g. '5s').
     */
    duration?: string;
    /**
     * Number of frames in the spritesheet.
     */
    imageCount?: number;
    /**
     * Output format for the generated media.
     */
    format?: 'jpg' | 'png' | 'm4a';
};
/**
 * Error object for media transformation operations.
 * Extends the standard Error interface with additional media-specific information.
 */
interface MediaError extends Error {
    readonly code: number;
    readonly message: string;
    readonly stack?: string;
}
declare module 'cloudflare:node' {
    interface NodeStyleServer {
        listen(...args: unknown[]): this;
        address(): {
            port?: number | null | undefined;
        };
    }
    export function httpServerHandler(port: number): ExportedHandler;
    export function httpServerHandler(options: {
        port: number;
    }): ExportedHandler;
    export function httpServerHandler(server: NodeStyleServer): ExportedHandler;
}
type Params<P extends string = any> = Record<P, string | string[]>;
type EventContext<Env, P extends string, Data> = {
    request: Request<unknown, IncomingRequestCfProperties<unknown>>;
    functionPath: string;
    waitUntil: (promise: Promise<any>) => void;
    passThroughOnException: () => void;
    next: (input?: Request | string, init?: RequestInit) => Promise<Response>;
    env: Env & {
        ASSETS: {
            fetch: typeof fetch;
        };
    };
    params: Params<P>;
    data: Data;
};
type PagesFunction<Env = unknown, Params extends string = any, Data extends Record<string, unknown> = Record<string, unknown>> = (context: EventContext<Env, Params, Data>) => Response | Promise<Response>;
type EventPluginContext<Env, P extends string, Data, PluginArgs> = {
    request: Request<unknown, IncomingRequestCfProperties<unknown>>;
    functionPath: string;
    waitUntil: (promise: Promise<any>) => void;
    passThroughOnException: () => void;
    next: (input?: Request | string, init?: RequestInit) => Promise<Response>;
    env: Env & {
        ASSETS: {
            fetch: typeof fetch;
        };
    };
    params: Params<P>;
    data: Data;
    pluginArgs: PluginArgs;
};
type PagesPluginFunction<Env = unknown, Params extends string = any, Data extends Record<string, unknown> = Record<string, unknown>, PluginArgs = unknown> = (context: EventPluginContext<Env, Params, Data, PluginArgs>) => Response | Promise<Response>;
declare module "assets:*" {
    export const onRequest: PagesFunction;
}
// Copyright (c) 2022-2023 Cloudflare, Inc.
// Licensed under the Apache 2.0 license found in the LICENSE file or at:
//     https://opensource.org/licenses/Apache-2.0
declare module "cloudflare:pipelines" {
    export abstract class PipelineTransformationEntrypoint<Env = unknown, I extends PipelineRecord = PipelineRecord, O extends PipelineRecord = PipelineRecord> {
        protected env: Env;
        protected ctx: ExecutionContext;
        constructor(ctx: ExecutionContext, env: Env);
        /**
         * run receives an array of PipelineRecord which can be
         * transformed and returned to the pipeline
         * @param records Incoming records from the pipeline to be transformed
         * @param metadata Information about the specific pipeline calling the transformation entrypoint
         * @returns A promise containing the transformed PipelineRecord array
         */
        public run(records: I[], metadata: PipelineBatchMetadata): Promise<O[]>;
    }
    export type PipelineRecord = Record<string, unknown>;
    export type PipelineBatchMetadata = {
        pipelineId: string;
        pipelineName: string;
    };
    export interface Pipeline<T extends PipelineRecord = PipelineRecord> {
        /**
         * The Pipeline interface represents the type of a binding to a Pipeline
         *
         * @param records The records to send to the pipeline
         */
        send(records: T[]): Promise<void>;
    }
}
// PubSubMessage represents an incoming PubSub message.
// The message includes metadata about the broker, the client, and the payload
// itself.
// https://developers.cloudflare.com/pub-sub/
interface PubSubMessage {
    // Message ID
    readonly mid: number;
    // MQTT broker FQDN in the form mqtts://BROKER.NAMESPACE.cloudflarepubsub.com:PORT
    readonly broker: string;
    // The MQTT topic the message was sent on.
    readonly topic: string;
    // The client ID of the client that published this message.
    readonly clientId: string;
    // The unique identifier (JWT ID) used by the client to authenticate, if token
    // auth was used.
    readonly jti?: string;
    // A Unix timestamp (seconds from Jan 1, 1970), set when the Pub/Sub Broker
    // received the message from the client.
    readonly receivedAt: number;
    // An (optional) string with the MIME type of the payload, if set by the
    // client.
    readonly contentType: string;
    // Set to 1 when the payload is a UTF-8 string
    // https://docs.oasis-open.org/mqtt/mqtt/v5.0/os/mqtt-v5.0-os.html#_Toc3901063
    readonly payloadFormatIndicator: number;
    // Pub/Sub (MQTT) payloads can be UTF-8 strings, or byte arrays.
    // You can use payloadFormatIndicator to inspect this before decoding.
    payload: string | Uint8Array;
}
// JsonWebKey extended by kid parameter
interface JsonWebKeyWithKid extends JsonWebKey {
    // Key Identifier of the JWK
    readonly kid: string;
}
interface RateLimitOptions {
    key: string;
}
interface RateLimitOutcome {
    success: boolean;
}
interface RateLimit {
    /**
     * Rate limit a request based on the provided options.
     * @see https://developers.cloudflare.com/workers/runtime-apis/bindings/rate-limit/
     * @returns A promise that resolves with the outcome of the rate limit.
     */
    limit(options: RateLimitOptions): Promise<RateLimitOutcome>;
}
// Namespace for RPC utility types. Unfortunately, we can't use a `module` here as these types need
// to referenced by `Fetcher`. This is included in the "importable" version of the types which
// strips all `module` blocks.
declare namespace Rpc {
    // Branded types for identifying `WorkerEntrypoint`/`DurableObject`/`Target`s.
    // TypeScript uses *structural* typing meaning anything with the same shape as type `T` is a `T`.
    // For the classes exported by `cloudflare:workers` we want *nominal* typing (i.e. we only want to
    // accept `WorkerEntrypoint` from `cloudflare:workers`, not any other class with the same shape)
    export const __RPC_STUB_BRAND: '__RPC_STUB_BRAND';
    export const __RPC_TARGET_BRAND: '__RPC_TARGET_BRAND';
    export const __WORKER_ENTRYPOINT_BRAND: '__WORKER_ENTRYPOINT_BRAND';
    export const __DURABLE_OBJECT_BRAND: '__DURABLE_OBJECT_BRAND';
    export const __WORKFLOW_ENTRYPOINT_BRAND: '__WORKFLOW_ENTRYPOINT_BRAND';
    export interface RpcTargetBranded {
        [__RPC_TARGET_BRAND]: never;
    }
    export interface WorkerEntrypointBranded {
        [__WORKER_ENTRYPOINT_BRAND]: never;
    }
    export interface DurableObjectBranded {
        [__DURABLE_OBJECT_BRAND]: never;
    }
    export interface WorkflowEntrypointBranded {
        [__WORKFLOW_ENTRYPOINT_BRAND]: never;
    }
    export type EntrypointBranded = WorkerEntrypointBranded | DurableObjectBranded | WorkflowEntrypointBranded;
    // Types that can be used through `Stub`s
    export type Stubable = RpcTargetBranded | ((...args: any[]) => any);
    // Types that can be passed over RPC
    // The reason for using a generic type here is to build a serializable subset of structured
    //   cloneable composite types. This allows types defined with the "interface" keyword to pass the
    //   serializable check as well. Otherwise, only types defined with the "type" keyword would pass.
    type Serializable<T> = 
    // Structured cloneables
    BaseType
    // Structured cloneable composites
     | Map<T extends Map<infer U, unknown> ? Serializable<U> : never, T extends Map<unknown, infer U> ? Serializable<U> : never> | Set<T extends Set<infer U> ? Serializable<U> : never> | ReadonlyArray<T extends ReadonlyArray<infer U> ? Serializable<U> : never> | {
        [K in keyof T]: K extends number | string ? Serializable<T[K]> : never;
    }
    // Special types
     | Stub<Stubable>
    // Serialized as stubs, see `Stubify`
     | Stubable;
    // Base type for all RPC stubs, including common memory management methods.
    // `T` is used as a marker type for unwrapping `Stub`s later.
    interface StubBase<T extends Stubable> extends Disposable {
        [__RPC_STUB_BRAND]: T;
        dup(): this;
    }
    export type Stub<T extends Stubable> = Provider<T> & StubBase<T>;
    // This represents all the types that can be sent as-is over an RPC boundary
    type BaseType = void | undefined | null | boolean | number | bigint | string | TypedArray | ArrayBuffer | DataView | Date | Error | RegExp | ReadableStream<Uint8Array> | WritableStream<Uint8Array> | Request | Response | Headers;
    // Recursively rewrite all `Stubable` types with `Stub`s
    // prettier-ignore
    type Stubify<T> = T extends Stubable ? Stub<T> : T extends Map<infer K, infer V> ? Map<Stubify<K>, Stubify<V>> : T extends Set<infer V> ? Set<Stubify<V>> : T extends Array<infer V> ? Array<Stubify<V>> : T extends ReadonlyArray<infer V> ? ReadonlyArray<Stubify<V>> : T extends BaseType ? T : T extends {
        [key: string | number]: any;
    } ? {
        [K in keyof T]: Stubify<T[K]>;
    } : T;
    // Recursively rewrite all `Stub<T>`s with the corresponding `T`s.
    // Note we use `StubBase` instead of `Stub` here to avoid circular dependencies:
    // `Stub` depends on `Provider`, which depends on `Unstubify`, which would depend on `Stub`.
    // prettier-ignore
    type Unstubify<T> = T extends StubBase<infer V> ? V : T extends Map<infer K, infer V> ? Map<Unstubify<K>, Unstubify<V>> : T extends Set<infer V> ? Set<Unstubify<V>> : T extends Array<infer V> ? Array<Unstubify<V>> : T extends ReadonlyArray<infer V> ? ReadonlyArray<Unstubify<V>> : T extends BaseType ? T : T extends {
        [key: string | number]: unknown;
    } ? {
        [K in keyof T]: Unstubify<T[K]>;
    } : T;
    type UnstubifyAll<A extends any[]> = {
        [I in keyof A]: Unstubify<A[I]>;
    };
    // Utility type for adding `Provider`/`Disposable`s to `object` types only.
    // Note `unknown & T` is equivalent to `T`.
    type MaybeProvider<T> = T extends object ? Provider<T> : unknown;
    type MaybeDisposable<T> = T extends object ? Disposable : unknown;
    // Type for method return or property on an RPC interface.
    // - Stubable types are replaced by stubs.
    // - Serializable types are passed by value, with stubable types replaced by stubs
    //   and a top-level `Disposer`.
    // Everything else can't be passed over PRC.
    // Technically, we use custom thenables here, but they quack like `Promise`s.
    // Intersecting with `(Maybe)Provider` allows pipelining.
    // prettier-ignore
    type Result<R> = R extends Stubable ? Promise<Stub<R>> & Provider<R> : R extends Serializable<R> ? Promise<Stubify<R> & MaybeDisposable<R>> & MaybeProvider<R> : never;
    // Type for method or property on an RPC interface.
    // For methods, unwrap `Stub`s in parameters, and rewrite returns to be `Result`s.
    // Unwrapping `Stub`s allows calling with `Stubable` arguments.
    // For properties, rewrite types to be `Result`s.
    // In each case, unwrap `Promise`s.
    type MethodOrProperty<V> = V extends (...args: infer P) => infer R ? (...args: UnstubifyAll<P>) => Result<Awaited<R>> : Result<Awaited<V>>;
    // Type for the callable part of an `Provider` if `T` is callable.
    // This is intersected with methods/properties.
    type MaybeCallableProvider<T> = T extends (...args: any[]) => any ? MethodOrProperty<T> : unknown;
    // Base type for all other types providing RPC-like interfaces.
    // Rewrites all methods/properties to be `MethodOrProperty`s, while preserving callable types.
    // `Reserved` names (e.g. stub method names like `dup()`) and symbols can't be accessed over RPC.
    export type Provider<T extends object, Reserved extends string = never> = MaybeCallableProvider<T> & Pick<{
        [K in keyof T]: MethodOrProperty<T[K]>;
    }, Exclude<keyof T, Reserved | symbol | keyof StubBase<never>>>;
}
declare namespace Cloudflare {
    // Type of `env`.
    //
    // The specific project can extend `Env` by redeclaring it in project-specific files. Typescript
    // will merge all declarations.
    //
    // You can use `wrangler types` to generate the `Env` type automatically.
    interface Env {
    }
    // Project-specific parameters used to inform types.
    //
    // This interface is, again, intended to be declared in project-specific files, and then that
    // declaration will be merged with this one.
    //
    // A project should have a declaration like this:
    //
    //     interface GlobalProps {
    //       // Declares the main module's exports. Used to populate Cloudflare.Exports aka the type
    //       // of `ctx.exports`.
    //       mainModule: typeof import("my-main-module");
    //
    //       // Declares which of the main module's exports are configured with durable storage, and
    //       // thus should behave as Durable Object namsepace bindings.
    //       durableNamespaces: "MyDurableObject" | "AnotherDurableObject";
    //     }
    //
    // You can use `wrangler types` to generate `GlobalProps` automatically.
    interface GlobalProps {
    }
    // Evaluates to the type of a property in GlobalProps, defaulting to `Default` if it is not
    // present.
    type GlobalProp<K extends string, Default> = K extends keyof GlobalProps ? GlobalProps[K] : Default;
    // The type of the program's main module exports, if known. Requires `GlobalProps` to declare the
    // `mainModule` property.
    type MainModule = GlobalProp<"mainModule", {}>;
    // The type of ctx.exports, which contains loopback bindings for all top-level exports.
    type Exports = {
        [K in keyof MainModule]: LoopbackForExport<MainModule[K]>
        // If the export is listed in `durableNamespaces`, then it is also a
        // DurableObjectNamespace.
         & (K extends GlobalProp<"durableNamespaces", never> ? MainModule[K] extends new (...args: any[]) => infer DoInstance ? DoInstance extends Rpc.DurableObjectBranded ? DurableObjectNamespace<DoInstance> : DurableObjectNamespace<undefined> : DurableObjectNamespace<undefined> : {});
    };
}
declare namespace CloudflareWorkersModule {
    export type RpcStub<T extends Rpc.Stubable> = Rpc.Stub<T>;
    export const RpcStub: {
        new <T extends Rpc.Stubable>(value: T): Rpc.Stub<T>;
    };
    export abstract class RpcTarget implements Rpc.RpcTargetBranded {
        [Rpc.__RPC_TARGET_BRAND]: never;
    }
    // `protected` fields don't appear in `keyof`s, so can't be accessed over RPC
    export abstract class WorkerEntrypoint<Env = Cloudflare.Env, Props = {}> implements Rpc.WorkerEntrypointBranded {
        [Rpc.__WORKER_ENTRYPOINT_BRAND]: never;
        protected ctx: ExecutionContext<Props>;
        protected env: Env;
        constructor(ctx: ExecutionContext, env: Env);
        email?(message: ForwardableEmailMessage): void | Promise<void>;
        fetch?(request: Request): Response | Promise<Response>;
        queue?(batch: MessageBatch<unknown>): void | Promise<void>;
        scheduled?(controller: ScheduledController): void | Promise<void>;
        tail?(events: TraceItem[]): void | Promise<void>;
        tailStream?(event: TailStream.TailEvent<TailStream.Onset>): TailStream.TailEventHandlerType | Promise<TailStream.TailEventHandlerType>;
        test?(controller: TestController): void | Promise<void>;
        trace?(traces: TraceItem[]): void | Promise<void>;
    }
    export abstract class DurableObject<Env = Cloudflare.Env, Props = {}> implements Rpc.DurableObjectBranded {
        [Rpc.__DURABLE_OBJECT_BRAND]: never;
        protected ctx: DurableObjectState<Props>;
        protected env: Env;
        constructor(ctx: DurableObjectState, env: Env);
        alarm?(alarmInfo?: AlarmInvocationInfo): void | Promise<void>;
        fetch?(request: Request): Response | Promise<Response>;
        webSocketMessage?(ws: WebSocket, message: string | ArrayBuffer): void | Promise<void>;
        webSocketClose?(ws: WebSocket, code: number, reason: string, wasClean: boolean): void | Promise<void>;
        webSocketError?(ws: WebSocket, error: unknown): void | Promise<void>;
    }
    export type WorkflowDurationLabel = 'second' | 'minute' | 'hour' | 'day' | 'week' | 'month' | 'year';
    export type WorkflowSleepDuration = `${number} ${WorkflowDurationLabel}${'s' | ''}` | number;
    export type WorkflowDelayDuration = WorkflowSleepDuration;
    export type WorkflowTimeoutDuration = WorkflowSleepDuration;
    export type WorkflowRetentionDuration = WorkflowSleepDuration;
    export type WorkflowBackoff = 'constant' | 'linear' | 'exponential';
    export type WorkflowStepConfig = {
        retries?: {
            limit: number;
            delay: WorkflowDelayDuration | number;
            backoff?: WorkflowBackoff;
        };
        timeout?: WorkflowTimeoutDuration | number;
    };
    export type WorkflowEvent<T> = {
        payload: Readonly<T>;
        timestamp: Date;
        instanceId: string;
    };
    export type WorkflowStepEvent<T> = {
        payload: Readonly<T>;
        timestamp: Date;
        type: string;
    };
    export abstract class WorkflowStep {
        do<T extends Rpc.Serializable<T>>(name: string, callback: () => Promise<T>): Promise<T>;
        do<T extends Rpc.Serializable<T>>(name: string, config: WorkflowStepConfig, callback: () => Promise<T>): Promise<T>;
        sleep: (name: string, duration: WorkflowSleepDuration) => Promise<void>;
        sleepUntil: (name: string, timestamp: Date | number) => Promise<void>;
        waitForEvent<T extends Rpc.Serializable<T>>(name: string, options: {
            type: string;
            timeout?: WorkflowTimeoutDuration | number;
        }): Promise<WorkflowStepEvent<T>>;
    }
    export type WorkflowInstanceStatus = 'queued' | 'running' | 'paused' | 'errored' | 'terminated' | 'complete' | 'waiting' | 'waitingForPause' | 'unknown';
    export abstract class WorkflowEntrypoint<Env = unknown, T extends Rpc.Serializable<T> | unknown = unknown> implements Rpc.WorkflowEntrypointBranded {
        [Rpc.__WORKFLOW_ENTRYPOINT_BRAND]: never;
        protected ctx: ExecutionContext;
        protected env: Env;
        constructor(ctx: ExecutionContext, env: Env);
        run(event: Readonly<WorkflowEvent<T>>, step: WorkflowStep): Promise<unknown>;
    }
    export function waitUntil(promise: Promise<unknown>): void;
    export function withEnv(newEnv: unknown, fn: () => unknown): unknown;
    export function withExports(newExports: unknown, fn: () => unknown): unknown;
    export function withEnvAndExports(newEnv: unknown, newExports: unknown, fn: () => unknown): unknown;
    export const env: Cloudflare.Env;
    export const exports: Cloudflare.Exports;
}
declare module 'cloudflare:workers' {
    export = CloudflareWorkersModule;
}
interface SecretsStoreSecret {
    /**
     * Get a secret from the Secrets Store, returning a string of the secret value
     * if it exists, or throws an error if it does not exist
     */
    get(): Promise<string>;
}
declare module "cloudflare:sockets" {
    function _connect(address: string | SocketAddress, options?: SocketOptions): Socket;
    export { _connect as connect };
}
type MarkdownDocument = {
    name: string;
    blob: Blob;
};
type ConversionResponse = {
    id: string;
    name: string;
    mimeType: string;
    format: 'markdown';
    tokens: number;
    data: string;
} | {
    id: string;
    name: string;
    mimeType: string;
    format: 'error';
    error: string;
};
type ImageConversionOptions = {
    descriptionLanguage?: 'en' | 'es' | 'fr' | 'it' | 'pt' | 'de';
};
type EmbeddedImageConversionOptions = ImageConversionOptions & {
    convert?: boolean;
    maxConvertedImages?: number;
};
type ConversionOptions = {
    html?: {
        images?: EmbeddedImageConversionOptions & {
            convertOGImage?: boolean;
        };
        hostname?: string;
    };
    docx?: {
        images?: EmbeddedImageConversionOptions;
    };
    image?: ImageConversionOptions;
    pdf?: {
        images?: EmbeddedImageConversionOptions;
        metadata?: boolean;
    };
};
type ConversionRequestOptions = {
    gateway?: GatewayOptions;
    extraHeaders?: object;
    conversionOptions?: ConversionOptions;
};
type SupportedFileFormat = {
    mimeType: string;
    extension: string;
};
declare abstract class ToMarkdownService {
    transform(files: MarkdownDocument[], options?: ConversionRequestOptions): Promise<ConversionResponse[]>;
    transform(files: MarkdownDocument, options?: ConversionRequestOptions): Promise<ConversionResponse>;
    supported(): Promise<SupportedFileFormat[]>;
}
declare namespace TailStream {
    interface Header {
        readonly name: string;
        readonly value: string;
    }
    interface FetchEventInfo {
        readonly type: "fetch";
        readonly method: string;
        readonly url: string;
        readonly cfJson?: object;
        readonly headers: Header[];
    }
    interface JsRpcEventInfo {
        readonly type: "jsrpc";
    }
    interface ScheduledEventInfo {
        readonly type: "scheduled";
        readonly scheduledTime: Date;
        readonly cron: string;
    }
    interface AlarmEventInfo {
        readonly type: "alarm";
        readonly scheduledTime: Date;
    }
    interface QueueEventInfo {
        readonly type: "queue";
        readonly queueName: string;
        readonly batchSize: number;
    }
    interface EmailEventInfo {
        readonly type: "email";
        readonly mailFrom: string;
        readonly rcptTo: string;
        readonly rawSize: number;
    }
    interface TraceEventInfo {
        readonly type: "trace";
        readonly traces: (string | null)[];
    }
    interface HibernatableWebSocketEventInfoMessage {
        readonly type: "message";
    }
    interface HibernatableWebSocketEventInfoError {
        readonly type: "error";
    }
    interface HibernatableWebSocketEventInfoClose {
        readonly type: "close";
        readonly code: number;
        readonly wasClean: boolean;
    }
    interface HibernatableWebSocketEventInfo {
        readonly type: "hibernatableWebSocket";
        readonly info: HibernatableWebSocketEventInfoClose | HibernatableWebSocketEventInfoError | HibernatableWebSocketEventInfoMessage;
    }
    interface CustomEventInfo {
        readonly type: "custom";
    }
    interface FetchResponseInfo {
        readonly type: "fetch";
        readonly statusCode: number;
    }
    type EventOutcome = "ok" | "canceled" | "exception" | "unknown" | "killSwitch" | "daemonDown" | "exceededCpu" | "exceededMemory" | "loadShed" | "responseStreamDisconnected" | "scriptNotFound";
    interface ScriptVersion {
        readonly id: string;
        readonly tag?: string;
        readonly message?: string;
    }
    interface Onset {
        readonly type: "onset";
        readonly attributes: Attribute[];
        // id for the span being opened by this Onset event.
        readonly spanId: string;
        readonly dispatchNamespace?: string;
        readonly entrypoint?: string;
        readonly executionModel: string;
        readonly scriptName?: string;
        readonly scriptTags?: string[];
        readonly scriptVersion?: ScriptVersion;
        readonly info: FetchEventInfo | JsRpcEventInfo | ScheduledEventInfo | AlarmEventInfo | QueueEventInfo | EmailEventInfo | TraceEventInfo | HibernatableWebSocketEventInfo | CustomEventInfo;
    }
    interface Outcome {
        readonly type: "outcome";
        readonly outcome: EventOutcome;
        readonly cpuTime: number;
        readonly wallTime: number;
    }
    interface SpanOpen {
        readonly type: "spanOpen";
        readonly name: string;
        // id for the span being opened by this SpanOpen event.
        readonly spanId: string;
        readonly info?: FetchEventInfo | JsRpcEventInfo | Attributes;
    }
    interface SpanClose {
        readonly type: "spanClose";
        readonly outcome: EventOutcome;
    }
    interface DiagnosticChannelEvent {
        readonly type: "diagnosticChannel";
        readonly channel: string;
        readonly message: any;
    }
    interface Exception {
        readonly type: "exception";
        readonly name: string;
        readonly message: string;
        readonly stack?: string;
    }
    interface Log {
        readonly type: "log";
        readonly level: "debug" | "error" | "info" | "log" | "warn";
        readonly message: object;
    }
    interface DroppedEventsDiagnostic {
        readonly diagnosticsType: "droppedEvents";
        readonly count: number;
    }
    interface StreamDiagnostic {
        readonly type: 'streamDiagnostic';
        // To add new diagnostic types, define a new interface and add it to this union type.
        readonly diagnostic: DroppedEventsDiagnostic;
    }
    // This marks the worker handler return information.
    // This is separate from Outcome because the worker invocation can live for a long time after
    // returning. For example - Websockets that return an http upgrade response but then continue
    // streaming information or SSE http connections.
    interface Return {
        readonly type: "return";
        readonly info?: FetchResponseInfo;
    }
    interface Attribute {
        readonly name: string;
        readonly value: string | string[] | boolean | boolean[] | number | number[] | bigint | bigint[];
    }
    interface Attributes {
        readonly type: "attributes";
        readonly info: Attribute[];
    }
    type EventType = Onset | Outcome | SpanOpen | SpanClose | DiagnosticChannelEvent | Exception | Log | StreamDiagnostic | Return | Attributes;
    // Context in which this trace event lives.
    interface SpanContext {
        // Single id for the entire top-level invocation
        // This should be a new traceId for the first worker stage invoked in the eyeball request and then
        // same-account service-bindings should reuse the same traceId but cross-account service-bindings
        // should use a new traceId.
        readonly traceId: string;
        // spanId in which this event is handled
        // for Onset and SpanOpen events this would be the parent span id
        // for Outcome and SpanClose these this would be the span id of the opening Onset and SpanOpen events
        // For Hibernate and Mark this would be the span under which they were emitted.
        // spanId is not set ONLY if:
        //  1. This is an Onset event
        //  2. We are not inheriting any SpanContext. (e.g. this is a cross-account service binding or a new top-level invocation)
        readonly spanId?: string;
    }
    interface TailEvent<Event extends EventType> {
        // invocation id of the currently invoked worker stage.
        // invocation id will always be unique to every Onset event and will be the same until the Outcome event.
        readonly invocationId: string;
        // Inherited spanContext for this event.
        readonly spanContext: SpanContext;
        readonly timestamp: Date;
        readonly sequence: number;
        readonly event: Event;
    }
    type TailEventHandler<Event extends EventType = EventType> = (event: TailEvent<Event>) => void | Promise<void>;
    type TailEventHandlerObject = {
        outcome?: TailEventHandler<Outcome>;
        spanOpen?: TailEventHandler<SpanOpen>;
        spanClose?: TailEventHandler<SpanClose>;
        diagnosticChannel?: TailEventHandler<DiagnosticChannelEvent>;
        exception?: TailEventHandler<Exception>;
        log?: TailEventHandler<Log>;
        return?: TailEventHandler<Return>;
        attributes?: TailEventHandler<Attributes>;
    };
    type TailEventHandlerType = TailEventHandler | TailEventHandlerObject;
}
// Copyright (c) 2022-2023 Cloudflare, Inc.
// Licensed under the Apache 2.0 license found in the LICENSE file or at:
//     https://opensource.org/licenses/Apache-2.0
/**
 * Data types supported for holding vector metadata.
 */
type VectorizeVectorMetadataValue = string | number | boolean | string[];
/**
 * Additional information to associate with a vector.
 */
type VectorizeVectorMetadata = VectorizeVectorMetadataValue | Record<string, VectorizeVectorMetadataValue>;
type VectorFloatArray = Float32Array | Float64Array;
interface VectorizeError {
    code?: number;
    error: string;
}
/**
 * Comparison logic/operation to use for metadata filtering.
 *
 * This list is expected to grow as support for more operations are released.
 */
type VectorizeVectorMetadataFilterOp = '$eq' | '$ne' | '$lt' | '$lte' | '$gt' | '$gte';
type VectorizeVectorMetadataFilterCollectionOp = '$in' | '$nin';
/**
 * Filter criteria for vector metadata used to limit the retrieved query result set.
 */
type VectorizeVectorMetadataFilter = {
    [field: string]: Exclude<VectorizeVectorMetadataValue, string[]> | null | {
        [Op in VectorizeVectorMetadataFilterOp]?: Exclude<VectorizeVectorMetadataValue, string[]> | null;
    } | {
        [Op in VectorizeVectorMetadataFilterCollectionOp]?: Exclude<VectorizeVectorMetadataValue, string[]>[];
    };
};
/**
 * Supported distance metrics for an index.
 * Distance metrics determine how other "similar" vectors are determined.
 */
type VectorizeDistanceMetric = "euclidean" | "cosine" | "dot-product";
/**
 * Metadata return levels for a Vectorize query.
 *
 * Default to "none".
 *
 * @property all      Full metadata for the vector return set, including all fields (including those un-indexed) without truncation. This is a more expensive retrieval, as it requires additional fetching & reading of un-indexed data.
 * @property indexed  Return all metadata fields configured for indexing in the vector return set. This level of retrieval is "free" in that no additional overhead is incurred returning this data. However, note that indexed metadata is subject to truncation (especially for larger strings).
 * @property none     No indexed metadata will be returned.
 */
type VectorizeMetadataRetrievalLevel = "all" | "indexed" | "none";
interface VectorizeQueryOptions {
    topK?: number;
    namespace?: string;
    returnValues?: boolean;
    returnMetadata?: boolean | VectorizeMetadataRetrievalLevel;
    filter?: VectorizeVectorMetadataFilter;
}
/**
 * Information about the configuration of an index.
 */
type VectorizeIndexConfig = {
    dimensions: number;
    metric: VectorizeDistanceMetric;
} | {
    preset: string; // keep this generic, as we'll be adding more presets in the future and this is only in a read capacity
};
/**
 * Metadata about an existing index.
 *
 * This type is exclusively for the Vectorize **beta** and will be deprecated once Vectorize RC is released.
 * See {@link VectorizeIndexInfo} for its post-beta equivalent.
 */
interface VectorizeIndexDetails {
    /** The unique ID of the index */
    readonly id: string;
    /** The name of the index. */
    name: string;
    /** (optional) A human readable description for the index. */
    description?: string;
    /** The index configuration, including the dimension size and distance metric. */
    config: VectorizeIndexConfig;
    /** The number of records containing vectors within the index. */
    vectorsCount: number;
}
/**
 * Metadata about an existing index.
 */
interface VectorizeIndexInfo {
    /** The number of records containing vectors within the index. */
    vectorCount: number;
    /** Number of dimensions the index has been configured for. */
    dimensions: number;
    /** ISO 8601 datetime of the last processed mutation on in the index. All changes before this mutation will be reflected in the index state. */
    processedUpToDatetime: number;
    /** UUIDv4 of the last mutation processed by the index. All changes before this mutation will be reflected in the index state. */
    processedUpToMutation: number;
}
/**
 * Represents a single vector value set along with its associated metadata.
 */
interface VectorizeVector {
    /** The ID for the vector. This can be user-defined, and must be unique. It should uniquely identify the object, and is best set based on the ID of what the vector represents. */
    id: string;
    /** The vector values */
    values: VectorFloatArray | number[];
    /** The namespace this vector belongs to. */
    namespace?: string;
    /** Metadata associated with the vector. Includes the values of other fields and potentially additional details. */
    metadata?: Record<string, VectorizeVectorMetadata>;
}
/**
 * Represents a matched vector for a query along with its score and (if specified) the matching vector information.
 */
type VectorizeMatch = Pick<Partial<VectorizeVector>, "values"> & Omit<VectorizeVector, "values"> & {
    /** The score or rank for similarity, when returned as a result */
    score: number;
};
/**
 * A set of matching {@link VectorizeMatch} for a particular query.
 */
interface VectorizeMatches {
    matches: VectorizeMatch[];
    count: number;
}
/**
 * Results of an operation that performed a mutation on a set of vectors.
 * Here, `ids` is a list of vectors that were successfully processed.
 *
 * This type is exclusively for the Vectorize **beta** and will be deprecated once Vectorize RC is released.
 * See {@link VectorizeAsyncMutation} for its post-beta equivalent.
 */
interface VectorizeVectorMutation {
    /* List of ids of vectors that were successfully processed. */
    ids: string[];
    /* Total count of the number of processed vectors. */
    count: number;
}
/**
 * Result type indicating a mutation on the Vectorize Index.
 * Actual mutations are processed async where the `mutationId` is the unique identifier for the operation.
 */
interface VectorizeAsyncMutation {
    /** The unique identifier for the async mutation operation containing the changeset. */
    mutationId: string;
}
/**
 * A Vectorize Vector Search Index for querying vectors/embeddings.
 *
 * This type is exclusively for the Vectorize **beta** and will be deprecated once Vectorize RC is released.
 * See {@link Vectorize} for its new implementation.
 */
declare abstract class VectorizeIndex {
    /**
     * Get information about the currently bound index.
     * @returns A promise that resolves with information about the current index.
     */
    public describe(): Promise<VectorizeIndexDetails>;
    /**
     * Use the provided vector to perform a similarity search across the index.
     * @param vector Input vector that will be used to drive the similarity search.
     * @param options Configuration options to massage the returned data.
     * @returns A promise that resolves with matched and scored vectors.
     */
    public query(vector: VectorFloatArray | number[], options?: VectorizeQueryOptions): Promise<VectorizeMatches>;
    /**
     * Insert a list of vectors into the index dataset. If a provided id exists, an error will be thrown.
     * @param vectors List of vectors that will be inserted.
     * @returns A promise that resolves with the ids & count of records that were successfully processed.
     */
    public insert(vectors: VectorizeVector[]): Promise<VectorizeVectorMutation>;
    /**
     * Upsert a list of vectors into the index dataset. If a provided id exists, it will be replaced with the new values.
     * @param vectors List of vectors that will be upserted.
     * @returns A promise that resolves with the ids & count of records that were successfully processed.
     */
    public upsert(vectors: VectorizeVector[]): Promise<VectorizeVectorMutation>;
    /**
     * Delete a list of vectors with a matching id.
     * @param ids List of vector ids that should be deleted.
     * @returns A promise that resolves with the ids & count of records that were successfully processed (and thus deleted).
     */
    public deleteByIds(ids: string[]): Promise<VectorizeVectorMutation>;
    /**
     * Get a list of vectors with a matching id.
     * @param ids List of vector ids that should be returned.
     * @returns A promise that resolves with the raw unscored vectors matching the id set.
     */
    public getByIds(ids: string[]): Promise<VectorizeVector[]>;
}
/**
 * A Vectorize Vector Search Index for querying vectors/embeddings.
 *
 * Mutations in this version are async, returning a mutation id.
 */
declare abstract class Vectorize {
    /**
     * Get information about the currently bound index.
     * @returns A promise that resolves with information about the current index.
     */
    public describe(): Promise<VectorizeIndexInfo>;
    /**
     * Use the provided vector to perform a similarity search across the index.
     * @param vector Input vector that will be used to drive the similarity search.
     * @param options Configuration options to massage the returned data.
     * @returns A promise that resolves with matched and scored vectors.
     */
    public query(vector: VectorFloatArray | number[], options?: VectorizeQueryOptions): Promise<VectorizeMatches>;
    /**
     * Use the provided vector-id to perform a similarity search across the index.
     * @param vectorId Id for a vector in the index against which the index should be queried.
     * @param options Configuration options to massage the returned data.
     * @returns A promise that resolves with matched and scored vectors.
     */
    public queryById(vectorId: string, options?: VectorizeQueryOptions): Promise<VectorizeMatches>;
    /**
     * Insert a list of vectors into the index dataset. If a provided id exists, an error will be thrown.
     * @param vectors List of vectors that will be inserted.
     * @returns A promise that resolves with a unique identifier of a mutation containing the insert changeset.
     */
    public insert(vectors: VectorizeVector[]): Promise<VectorizeAsyncMutation>;
    /**
     * Upsert a list of vectors into the index dataset. If a provided id exists, it will be replaced with the new values.
     * @param vectors List of vectors that will be upserted.
     * @returns A promise that resolves with a unique identifier of a mutation containing the upsert changeset.
     */
    public upsert(vectors: VectorizeVector[]): Promise<VectorizeAsyncMutation>;
    /**
     * Delete a list of vectors with a matching id.
     * @param ids List of vector ids that should be deleted.
     * @returns A promise that resolves with a unique identifier of a mutation containing the delete changeset.
     */
    public deleteByIds(ids: string[]): Promise<VectorizeAsyncMutation>;
    /**
     * Get a list of vectors with a matching id.
     * @param ids List of vector ids that should be returned.
     * @returns A promise that resolves with the raw unscored vectors matching the id set.
     */
    public getByIds(ids: string[]): Promise<VectorizeVector[]>;
}
/**
 * The interface for "version_metadata" binding
 * providing metadata about the Worker Version using this binding.
 */
type WorkerVersionMetadata = {
    /** The ID of the Worker Version using this binding */
    id: string;
    /** The tag of the Worker Version using this binding */
    tag: string;
    /** The timestamp of when the Worker Version was uploaded */
    timestamp: string;
};
interface DynamicDispatchLimits {
    /**
     * Limit CPU time in milliseconds.
     */
    cpuMs?: number;
    /**
     * Limit number of subrequests.
     */
    subRequests?: number;
}
interface DynamicDispatchOptions {
    /**
     * Limit resources of invoked Worker script.
     */
    limits?: DynamicDispatchLimits;
    /**
     * Arguments for outbound Worker script, if configured.
     */
    outbound?: {
        [key: string]: any;
    };
}
interface DispatchNamespace {
    /**
    * @param name Name of the Worker script.
    * @param args Arguments to Worker script.
    * @param options Options for Dynamic Dispatch invocation.
    * @returns A Fetcher object that allows you to send requests to the Worker script.
    * @throws If the Worker script does not exist in this dispatch namespace, an error will be thrown.
    */
    get(name: string, args?: {
        [key: string]: any;
    }, options?: DynamicDispatchOptions): Fetcher;
}
declare module 'cloudflare:workflows' {
    /**
     * NonRetryableError allows for a user to throw a fatal error
     * that makes a Workflow instance fail immediately without triggering a retry
     */
    export class NonRetryableError extends Error {
        public constructor(message: string, name?: string);
    }
}
declare abstract class Workflow<PARAMS = unknown> {
    /**
     * Get a handle to an existing instance of the Workflow.
     * @param id Id for the instance of this Workflow
     * @returns A promise that resolves with a handle for the Instance
     */
    public get(id: string): Promise<WorkflowInstance>;
    /**
     * Create a new instance and return a handle to it. If a provided id exists, an error will be thrown.
     * @param options Options when creating an instance including id and params
     * @returns A promise that resolves with a handle for the Instance
     */
    public create(options?: WorkflowInstanceCreateOptions<PARAMS>): Promise<WorkflowInstance>;
    /**
     * Create a batch of instances and return handle for all of them. If a provided id exists, an error will be thrown.
     * `createBatch` is limited at 100 instances at a time or when the RPC limit for the batch (1MiB) is reached.
     * @param batch List of Options when creating an instance including name and params
     * @returns A promise that resolves with a list of handles for the created instances.
     */
    public createBatch(batch: WorkflowInstanceCreateOptions<PARAMS>[]): Promise<WorkflowInstance[]>;
}
type WorkflowDurationLabel = 'second' | 'minute' | 'hour' | 'day' | 'week' | 'month' | 'year';
type WorkflowSleepDuration = `${number} ${WorkflowDurationLabel}${'s' | ''}` | number;
type WorkflowRetentionDuration = WorkflowSleepDuration;
interface WorkflowInstanceCreateOptions<PARAMS = unknown> {
    /**
     * An id for your Workflow instance. Must be unique within the Workflow.
     */
    id?: string;
    /**
     * The event payload the Workflow instance is triggered with
     */
    params?: PARAMS;
    /**
     * The retention policy for Workflow instance.
     * Defaults to the maximum retention period available for the owner's account.
     */
    retention?: {
        successRetention?: WorkflowRetentionDuration;
        errorRetention?: WorkflowRetentionDuration;
    };
}
type InstanceStatus = {
    status: 'queued' // means that instance is waiting to be started (see concurrency limits)
     | 'running' | 'paused' | 'errored' | 'terminated' // user terminated the instance while it was running
     | 'complete' | 'waiting' // instance is hibernating and waiting for sleep or event to finish
     | 'waitingForPause' // instance is finishing the current work to pause
     | 'unknown';
    error?: {
        name: string;
        message: string;
    };
    output?: unknown;
};
interface WorkflowError {
    code?: number;
    message: string;
}
declare abstract class WorkflowInstance {
    public id: string;
    /**
     * Pause the instance.
     */
    public pause(): Promise<void>;
    /**
     * Resume the instance. If it is already running, an error will be thrown.
     */
    public resume(): Promise<void>;
    /**
     * Terminate the instance. If it is errored, terminated or complete, an error will be thrown.
     */
    public terminate(): Promise<void>;
    /**
     * Restart the instance.
     */
    public restart(): Promise<void>;
    /**
     * Returns the current status of the instance.
     */
    public status(): Promise<InstanceStatus>;
    /**
     * Send an event to this instance.
     */
    public sendEvent({ type, payload, }: {
        type: string;
        payload: unknown;
    }): Promise<void>;
}

```

# ky-news-worker\wrangler.jsonc

```jsonc
/**
 * For more details on how to configure Wrangler, refer to:
 * https://developers.cloudflare.com/workers/wrangler/configuration/
 */
{
	"$schema": "node_modules/wrangler/config-schema.json",
	"name": "ky-news-worker",
	"main": "src/index.ts",
	"compatibility_date": "2026-02-19",
	"observability": {
		"enabled": true
	},
	"compatibility_flags": [
		"nodejs_compat"
	],
	"triggers": {
		"crons": ["*/15 * * * *"]
	},
	"d1_databases": [
		{
			"binding": "ky_news_db",
			"database_name": "ky-news-db",
			"database_id": "f1669001-2a51-4114-a84e-73cfa7f1c584"
		}
	],
	"r2_buckets": [
		{
			"binding": "ky_news_media",
			"bucket_name": "ky-news-media"
		}
	],
	"kv_namespaces": [
		{
			"binding": "CACHE",
			"id": "bf967297a73b4e9ebc8e473ba5140ab9"
		}
	],
	"ai": {
		"binding": "AI"
	},
	"vars": {
		"APP_NAME": "EKY News",
		"NWS_USER_AGENT": "EKY-News-Worker/1.0 (ops@example.com)",
		"RSS_USER_AGENT": "EKY-News-Bot/1.0 (+https://localkynews.com)",
		"AI_MODEL": "@cf/zai-org/glm-4.7-flash",
		"SUMMARY_CACHE_TTL_SECONDS": "2592000",
		"MAX_INGEST_ITEMS_PER_FEED": "60",
		"MAX_FEEDS_PER_RUN": "200",
		"LOST_FOUND_AUTO_APPROVE": "1",
		"API_CACHE_TTL_SECONDS": "120",
		"LOG_TTL_SECONDS": "1209600",
		"ERROR_EVENT_TTL_DAYS": "30",
		"RATE_LIMIT_READ_PER_MIN": "240",
		"RATE_LIMIT_WRITE_PER_MIN": "60",
		"RATE_LIMIT_ADMIN_PER_MIN": "90",
		"BOT_SCORE_MIN": "18"
	}
	/**
	 * Smart Placement
	 * https://developers.cloudflare.com/workers/configuration/smart-placement/#smart-placement
	 */
	// "placement": {  "mode": "smart" }
	/**
	 * Bindings
	 * Bindings allow your Worker to interact with resources on the Cloudflare Developer Platform, including
	 * databases, object storage, AI inference, real-time communication and more.
	 * https://developers.cloudflare.com/workers/runtime-apis/bindings/
	 */
	/**
	 * Environment Variables
	 * https://developers.cloudflare.com/workers/wrangler/configuration/#environment-variables
	 * Note: Use secrets to store sensitive data.
	 * https://developers.cloudflare.com/workers/configuration/secrets/
	 */
	// "vars": {  "MY_VARIABLE": "production_value" }
	/**
	 * Static Assets
	 * https://developers.cloudflare.com/workers/static-assets/binding/
	 */
	// "assets": {  "directory": "./public/",  "binding": "ASSETS" }
	/**
	 * Service Bindings (communicate between multiple Workers)
	 * https://developers.cloudflare.com/workers/wrangler/configuration/#service-bindings
	 */
	// "services": [  {   "binding": "MY_SERVICE",   "service": "my-service"  } ]
}

```

# LOCATION_TAGGING.md

```md
# Location Tagging

Location tagging is defined in:

- `docs/05_INGESTION_PIPELINE.md`
- `ky-news-worker/src/ingest/ingest.ts` (`writeItemLocations`)
- `ky-news-worker/src/services/location.ts` (`detectKyCounties`)

Current behavior:
- Kentucky feeds receive state + county tags.
- National feeds do not enter county navigation.
- `default_county` on a feed is always tagged for KY-scope items.
- Facebook school feeds (`fetch_mode=facebook-page`) skip body-analysis county extraction and rely on feed scope metadata.

Recent output-policy updates (Feb 2026):
- County pages now use deduped API results (no unfiltered duplicate-prone mode).
- National supports an include-all mode (`/api/items?scope=national&includeAll=1`) that keeps dedupe while bypassing curation gates.
- Weather and Obituaries category feeds are enforced with strict topic filtering at API output.
- Manual admin ingestion (`POST /api/admin/feeds/reload`) now starts asynchronously and should be monitored via ingestion logs/health endpoints.

```

# logo.png

This is a binary file of the type: Image

# package.json

```json
{
  "name": "local-ky-news",
  "private": true,
  "workspaces": [
    "apps/*"
  ],
  "scripts": {
    "dev": "concurrently -n api,ingester,web -c auto \"npm run dev -w apps/api\" \"npm run dev -w apps/ingester\" \"npm run dev -w apps/web\"",
    "db:reset": "node scripts/reset-db.mjs",
    "feeds:seed": "node scripts/seed-feeds.mjs",
    "seed:feeds": "npm run feeds:seed",
    "ingest:once": "node apps/ingester/src/ingester.mjs --once",
    "prod:smoke": "node scripts/prod-smoke-test.mjs",
    "dev:setup": "npm run db:reset && npm run feeds:seed",
    "lint": "echo \"(optional) add eslint later\""
  },
  "devDependencies": {
    "concurrently": "^9.0.0"
  },
  "dependencies": {
    "hono": "^4.12.1",
    "rss-parser": "^3.13.0"
  }
}

```

# PLAN.md

```md
# Kentucky + National FeedReader PWA Completion Plan (Feedly-Style, No Accounts)

## Summary
Goal: finish a production-ready PWA that feels like Feedly, focuses on Kentucky county-level news plus a separate national lane, adds weather and moderated lost-and-found, and migrates from local Node/SQLite to Cloudflare Pages + Workers + D1/R2.  
Success: stable ingest, fast mobile UX, accurate county sorting for Kentucky, working weather hub, safe user submissions, and cloud deployment with admin controls.

## Locked Product Decisions
1. Launch sequence: Kentucky depth first, then national lane.
2. National model: separate National section, not mixed into county navigation.
3. Weather v1: NOAA/NWS forecasts + alerts.
4. Lost & Found moderation: pre-approval required before publish.
5. Lost & Found contact policy: email collected; hidden until approved/public choice.
6. Admin access: Cloudflare Access-protected `/admin`.
7. Delivery pace: single developer, staged MVP increments.

## Documentation Package To Create
1. `docs/00_PROJECT_OVERVIEW.md`: mission, audience, north-star metrics, out-of-scope.
2. `docs/01_PRODUCT_REQUIREMENTS.md`: detailed UX requirements for Home, County, National, Weather, Search, Reader, Lost & Found.
3. `docs/02_INFORMATION_ARCHITECTURE.md`: route map, navigation model, taxonomy (KY county vs national scope).
4. `docs/03_DATA_MODEL.md`: ERD, table schemas, indexes, retention policies.
5. `docs/04_API_SPEC.md`: endpoint contracts, request/response examples, error model, auth model for admin.
6. `docs/05_INGESTION_PIPELINE.md`: feed sourcing, dedupe, tagging, retries, failure handling.
7. `docs/06_PWA_SPEC.md`: offline behavior, cache policies, install/update UX, performance budgets.
8. `docs/07_WEATHER_SPEC.md`: NWS integration, county mapping, alert severity logic, refresh cadence.
9. `docs/08_LOST_FOUND_SPEC.md`: submission workflow, moderation workflow, media handling, safety and abuse controls.
10. `docs/09_CLOUDFLARE_DEPLOYMENT.md`: Pages, Workers, D1, R2, Access, secrets, environments, rollout checklist.
11. `docs/10_ROADMAP.md`: milestone timeline, deliverables, acceptance gates, launch checklist.
12. `docs/11_OPERATIONS_RUNBOOK.md`: monitoring, incident response, feed failures, moderation SOPs.

## Product Scope (Decision Complete)
1. Primary sections: `Today`, `Kentucky`, `My County`, `National`, `Weather`, `Read Later`, `Search`, `Lost & Found`.
2. Feed model: curated feeds only; no user-provided RSS; no end-user accounts.
3. Personalization: device-local preferences only (`My County`, read/saved state, optional push subscription later).
4. Kentucky navigation: state view + all 120 counties.
5. National navigation: one dedicated lane with source/category filters, no county drilldown.
6. Reader behavior: in-app clean read view + open original.
7. Lost & Found behavior: anonymous submission with required email + photo(s), admin review before public listing.

## Target Technical Architecture
1. Frontend: `apps/web` React + TypeScript + Vite PWA kept as canonical client.
2. Local development backend: keep current Fastify API + Node ingester until cloud parity.
3. Cloud production backend: Worker API service + Worker scheduled ingester service.
4. Datastores: D1 for structured data, R2 for lost-and-found images, local Dexie for client read/saved/cache state.
5. Security controls: Turnstile on public submissions, Cloudflare Access for admin, server-side rate limits.
6. Deployment: Pages for web, Workers for API/ingester, separate `dev` and `prod` environments.
7. Repository cleanup: retire root scaffold app (`src/*`, root `index.html`) after migration to avoid dual frontends.

## Public APIs / Interfaces / Types (Additions and Changes)
1. `GET /api/feeds`: add `region_scope` in response (`ky` | `national`).
2. `GET /api/items`: add query `scope=ky|national|all` default `ky`.
3. `GET /api/items`: preserve `state`/`county` filters for KY scope only.
4. `GET /api/weather/forecast?state=KY&county=<name>`: county forecast summary + periods.
5. `GET /api/weather/alerts?state=KY&county=<name>`: active alerts relevant to county.
6. `GET /api/lost-found?type=lost|found&county=&status=published`: public board listing.
7. `POST /api/lost-found/submissions`: create pending submission with metadata and contact email.
8. `POST /api/uploads/lost-found-url`: issue signed upload URL for R2 object key.
9. `GET /api/admin/lost-found?status=pending|approved|rejected`: moderation queue (Access protected).
10. `POST /api/admin/lost-found/:id/approve`: publish pending submission.
11. `POST /api/admin/lost-found/:id/reject`: reject submission with reason.
12. `POST /api/admin/feeds/reload`: force feed reload and ingest health check.
13. New shared TypeScript contracts: `NewsScope`, `LocationTag`, `WeatherForecast`, `WeatherAlert`, `LostFoundSubmission`, `LostFoundPost`, `ModerationDecision`.

## Data Model Changes
1. `feeds`: add `region_scope TEXT NOT NULL DEFAULT 'ky'`.
2. `items`: add `region_scope TEXT NOT NULL DEFAULT 'ky'`.
3. `weather_forecasts`: county, forecast JSON, fetched_at, expires_at.
4. `weather_alerts`: alert_id, county, severity, event, headline, starts_at, ends_at, raw JSON.
5. `lost_found_posts`: id, type, title, description, county, state_code, contact_email_encrypted, status, submitted_at, approved_at, expires_at.
6. `lost_found_images`: id, post_id, r2_key, width, height, created_at.
7. `lost_found_reports`: id, post_id, reason, reporter_ip_hash, created_at.
8. `admin_audit_log`: id, actor_email, action, entity_type, entity_id, payload_json, created_at.
9. Indexes: county + status indexes for weather and lost/found; recency indexes for feeds/items queries.
10. Retention defaults: weather forecasts 7 days, alerts until 48h after end, lost/found auto-expire after 30 days unless renewed.

## Delivery Roadmap (Single-Dev, Staged)
| Milestone | Target | Build Scope | Documentation Output | Exit Criteria |
|---|---|---|---|---|
| M0 Baseline | Week 1 | Canonicalize `apps/web`, inventory feeds, remove duplicate frontend risk, add env matrix | `00`, `09`, `10` first drafts | Local stack stable with one canonical frontend path |
| M1 Kentucky Core Finish | Weeks 2-3 | Feedly-like UI polish, county-first navigation polish, performance pass, API hardening | `01`, `02`, `06` | KY browsing/search/reader/read-later fully reliable on mobile |
| M2 National Lane | Week 4 | Add curated national feeds, `scope` support, National section UI | `01`, `04`, `05` updates | National stories visible in separate lane without breaking KY flows |
| M3 Weather Hub | Week 5 | NWS county forecasts and alerts, Weather section, severe-alert banner on Today/KY | `07`, `04` updates | Weather data refreshes automatically and county weather pages work |
| M4 Lost & Found MVP | Weeks 6-7 | Submission form, image upload, pending moderation queue, approved board pages | `08`, `04`, `11` updates | End-to-end submit → approve → publish flow works safely |
| M5 PWA Hardening | Week 8 | Offline strategy tuning, cache invalidation, install/update UX, Lighthouse fixes | `06`, `11` updates | PWA installable, key screens usable offline, update flow predictable |
| M6 Cloudflare Migration | Weeks 9-10 | Worker API + ingester parity, D1 migration scripts, R2 wiring, Access admin | `09`, `03`, `05` updates | Production stack running on Pages/Workers/D1/R2 with parity |
| M7 Launch Readiness | Week 11 | Ops dashboards, moderation SOP, incident runbooks, content QA | `10`, `11` finalized | Soft launch ready with monitored ingestion and moderation workflows |

## Feature Additions Beyond Request (Planned)
1. Breaking weather banner on `Today` and `Kentucky` when severe alerts exist.
2. County watch shortcut in drawer for one-tap local updates.
3. Source transparency badges (`source`, `published`, `updated`, `region_scope`).
4. Feed health diagnostics in admin (`last_checked_at`, `error streak`, `last success`).
5. Optional post-launch: web push alerts for weather emergencies and major KY headlines.

## Testing and Acceptance Scenarios
1. Ingest dedupe: same article from repeated feed polls does not create duplicate item IDs.
2. KY county tagging: known county and city mentions map correctly to counties.
3. National isolation: `scope=national` results never pollute county-only views.
4. Pagination correctness: cursor-based paging returns stable, non-overlapping sequences.
5. Search correctness: quotes, `AND`, `OR`, and `-exclude` return expected article sets.
6. Weather refresh: forecast and alerts refresh on schedule and honor county filter.
7. Lost submission validation: missing email, invalid image type, or oversized files are rejected.
8. Moderation gate: pending posts are never visible on public endpoints.
9. PWA offline: previously opened Reader pages and last fetched Today list work offline.
10. PWA update: app displays refresh prompt and safely reloads to new service worker.
11. Admin security: `/admin` endpoints blocked without Cloudflare Access identity.
12. Rate-limit behavior: repeated submission attempts from same IP are throttled.
13. Cloud migration parity: Worker endpoints match local API response shapes for core routes.
14. Cross-device smoke: iOS Safari, Android Chrome, desktop Chrome baseline flows pass.

## Rollout and Operations Plan
1. Environments: `local`, `staging`, `production` with separate D1 DBs and R2 buckets.
2. Deployment flow: Pages preview on PR-equivalent branch, promote to production after smoke suite.
3. Scheduled jobs: feed ingest every 15 minutes; weather refresh every 10 minutes.
4. Monitoring metrics: ingest success rate, median API latency, county-tag coverage, moderation queue age.
5. Alerts: notify on ingest failure streaks, zero-new-items anomalies, weather job failures.
6. Manual fallback: admin endpoint to trigger on-demand ingest/weather refresh.
7. Content governance: moderation SLA target under 2 hours daytime for lost-and-found queue.

## Explicit Assumptions and Defaults
1. Existing markdown docs shown in IDE are not present in this workspace and will be recreated under `docs/`.
2. Curated feed sourcing is editorially controlled by admins; no public source submission in MVP.
3. Weather source remains NOAA/NWS only in MVP to avoid paid API dependencies.
4. Lost-and-found submission is anonymous (no user account), with required email and pre-moderation.
5. Admin authentication is handled exclusively by Cloudflare Access, not in-app login.
6. Kentucky remains the only county-level geography in MVP; national has its own non-county lane.
7. Local Node services remain until Worker/D1 parity is verified; then local stack is kept for dev fallback.
8. Initial launch is US English only and mobile-first.
9. Performance targets: LCP under 2.5s on mobile 4G, API P95 under 600ms for list endpoints.
10. Compliance baseline includes Terms, Privacy, moderation policy, and takedown contact pages before launch.

```

# PROJECT_CONTEXT.md

```md
# Project Context

This project now uses the canonical documentation set in `docs/`.

- Overview: `docs/00_PROJECT_OVERVIEW.md`
- Product requirements: `docs/01_PRODUCT_REQUIREMENTS.md`
- Information architecture: `docs/02_INFORMATION_ARCHITECTURE.md`
- Data model: `docs/03_DATA_MODEL.md`
- Roadmap: `docs/10_ROADMAP.md`

```

# scripts\prod-smoke-test.mjs

```mjs
#!/usr/bin/env node

const workerUrl = String(process.env.WORKER_URL || "https://ky-news-worker.jamesbrock25.workers.dev").replace(/\/+$/, "");
const lookbackHours = Number(process.env.LOOKBACK_HOURS || "168");
const maxFreshnessMinutes = Number(process.env.MAX_FRESHNESS_MINUTES || "240");
const adminToken = process.env.ADMIN_TOKEN || "";

function minutesSince(iso) {
  if (!iso) return Number.POSITIVE_INFINITY;
  const ts = new Date(iso).getTime();
  if (!Number.isFinite(ts)) return Number.POSITIVE_INFINITY;
  return Math.floor((Date.now() - ts) / 60000);
}

async function fetchJson(path, init = {}) {
  const res = await fetch(`${workerUrl}${path}`, init);
  const bodyText = await res.text();
  let body;
  try {
    body = bodyText ? JSON.parse(bodyText) : {};
  } catch {
    body = { raw: bodyText };
  }

  if (!res.ok) {
    const message = typeof body?.error === "string" ? body.error : `${res.status} ${res.statusText}`;
    const err = new Error(`${path} failed: ${message}`);
    err.details = body;
    throw err;
  }
  return body;
}

function newestPublishedAt(items) {
  if (!Array.isArray(items) || !items.length) return null;
  const sorted = [...items].sort((a, b) => String(b?.published_at || "").localeCompare(String(a?.published_at || "")));
  return sorted[0]?.published_at || null;
}

function printCheck(name, ok, details) {
  const mark = ok ? "PASS" : "FAIL";
  console.log(`${mark}  ${name} - ${details}`);
}

async function run() {
  let failures = 0;

  const health = await fetchJson("/api/health");
  printCheck("Health", Boolean(health?.ok), `ok=${String(Boolean(health?.ok))}`);
  if (!health?.ok) failures += 1;

  const ky = await fetchJson(`/api/items?scope=ky&limit=10&hours=${lookbackHours}`);
  const nat = await fetchJson(`/api/items?scope=national&limit=10&hours=${lookbackHours}`);
  const feeds = await fetchJson("/api/feeds?scope=ky");

  const newestKy = newestPublishedAt(ky.items);
  const newestNat = newestPublishedAt(nat.items);
  const kyMinutes = minutesSince(newestKy);
  const natMinutes = minutesSince(newestNat);

  const kyFresh = Array.isArray(ky.items) && ky.items.length > 0 && kyMinutes <= maxFreshnessMinutes;
  const natFresh = Array.isArray(nat.items) && nat.items.length > 0 && natMinutes <= maxFreshnessMinutes * 3;
  const feedCount = Array.isArray(feeds.feeds) ? feeds.feeds.length : 0;

  printCheck(
    "KY Articles",
    kyFresh,
    `count=${Array.isArray(ky.items) ? ky.items.length : 0}, newest=${newestKy || "none"}, lag=${Number.isFinite(kyMinutes) ? kyMinutes : "n/a"}m`
  );
  if (!kyFresh) failures += 1;

  printCheck(
    "National Articles",
    natFresh,
    `count=${Array.isArray(nat.items) ? nat.items.length : 0}, newest=${newestNat || "none"}, lag=${Number.isFinite(natMinutes) ? natMinutes : "n/a"}m`
  );
  if (!natFresh) failures += 1;

  printCheck("Feed Seed Coverage", feedCount > 0, `enabled_feeds=${feedCount}`);
  if (feedCount <= 0) failures += 1;

  if (adminToken) {
    const headers = { "x-admin-token": adminToken };
    const logs = await fetchJson("/api/admin/ingestion/logs?limit=1", { headers });
    const latest = Array.isArray(logs.logs) ? logs.logs[0] : null;
    const lastRunAt = latest?.finished_at || latest?.started_at || null;
    const runLag = minutesSince(lastRunAt);
    const runHealthy = Boolean(latest) && runLag <= 30;
    printCheck(
      "Scheduler Freshness",
      runHealthy,
      `last_run=${lastRunAt || "none"}, lag=${Number.isFinite(runLag) ? runLag : "n/a"}m, status=${latest?.status || "unknown"}`
    );
    if (!runHealthy) failures += 1;

    const healthRes = await fetchJson("/api/admin/feeds/health?hours=48&limit=500", { headers });
    const list = Array.isArray(healthRes.feeds) ? healthRes.feeds : [];
    const critical = list.filter((f) => f.health_status === "critical");
    const stale = list.filter((f) => Number(f.recent_items || 0) === 0);
    printCheck(
      "Feed Health",
      critical.length === 0,
      `critical=${critical.length}, stale_48h=${stale.length}, checked=${list.length}`
    );
    if (critical.length > 0) failures += 1;
  } else {
    console.log("INFO  Admin checks skipped (set ADMIN_TOKEN env var to enable feed health and scheduler checks).");
  }

  if (failures > 0) {
    console.error(`\nSmoke test failed with ${failures} failing check(s).`);
    process.exit(1);
  }

  console.log("\nSmoke test passed.");
}

run().catch((err) => {
  console.error("Smoke test crashed:", err?.message || err);
  if (err?.details) {
    console.error("Details:", JSON.stringify(err.details));
  }
  process.exit(1);
});

```

# scripts\reset-db.mjs

```mjs
import fs from "node:fs";
import path from "node:path";
import Database from "better-sqlite3";

const root = path.resolve(process.cwd());
const dataDir = path.join(root, "data");
const dbPath = path.join(dataDir, "dev.sqlite");

fs.mkdirSync(dataDir, { recursive: true });
if (fs.existsSync(dbPath)) fs.unlinkSync(dbPath);

const db = new Database(dbPath);

db.exec(`
PRAGMA journal_mode = WAL;

CREATE TABLE IF NOT EXISTS feeds (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  category TEXT NOT NULL,
  url TEXT NOT NULL,
  state_code TEXT NOT NULL DEFAULT 'KY',
  default_county TEXT,
  region_scope TEXT NOT NULL DEFAULT 'ky',
  fetch_mode TEXT NOT NULL DEFAULT 'rss',
  scraper_id TEXT,
  enabled INTEGER NOT NULL DEFAULT 1,
  etag TEXT,
  last_modified TEXT,
  last_checked_at TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS items (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  url TEXT NOT NULL,
  guid TEXT,
  author TEXT,
  region_scope TEXT NOT NULL DEFAULT 'ky',
  published_at TEXT,
  summary TEXT,
  content TEXT,
  image_url TEXT,
  fetched_at TEXT NOT NULL DEFAULT (datetime('now')),
  hash TEXT,
  article_checked_at TEXT,
  article_fetch_status TEXT,
  article_text_excerpt TEXT
);

CREATE TABLE IF NOT EXISTS feed_items (
  feed_id TEXT NOT NULL,
  item_id TEXT NOT NULL,
  PRIMARY KEY (feed_id, item_id),
  FOREIGN KEY (feed_id) REFERENCES feeds(id) ON DELETE CASCADE,
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

-- Location tags: state_code always present; county = '' means "state-level only"
CREATE TABLE IF NOT EXISTS item_locations (
  item_id TEXT NOT NULL,
  state_code TEXT NOT NULL,
  county TEXT NOT NULL DEFAULT '',
  PRIMARY KEY (item_id, state_code, county),
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_items_published_at ON items(published_at);
CREATE INDEX IF NOT EXISTS idx_items_url ON items(url);
CREATE INDEX IF NOT EXISTS idx_items_region_scope ON items(region_scope);
CREATE INDEX IF NOT EXISTS idx_item_locations_state ON item_locations(state_code);
CREATE INDEX IF NOT EXISTS idx_item_locations_county ON item_locations(state_code, county);
CREATE INDEX IF NOT EXISTS idx_feed_items_feed ON feed_items(feed_id);
CREATE INDEX IF NOT EXISTS idx_feeds_region_scope ON feeds(region_scope);
CREATE INDEX IF NOT EXISTS idx_feeds_fetch_mode_enabled ON feeds(fetch_mode, enabled);

CREATE TABLE IF NOT EXISTS fetch_runs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  started_at TEXT NOT NULL,
  finished_at TEXT,
  status TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS fetch_errors (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  feed_id TEXT,
  at TEXT NOT NULL,
  error TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS weather_forecasts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  state_code TEXT NOT NULL,
  county TEXT NOT NULL,
  forecast_json TEXT NOT NULL,
  fetched_at TEXT NOT NULL DEFAULT (datetime('now')),
  expires_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_weather_forecasts_county ON weather_forecasts(state_code, county, fetched_at);

CREATE TABLE IF NOT EXISTS weather_alerts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  alert_id TEXT NOT NULL,
  state_code TEXT NOT NULL,
  county TEXT NOT NULL,
  severity TEXT,
  event TEXT,
  headline TEXT,
  starts_at TEXT,
  ends_at TEXT,
  raw_json TEXT NOT NULL,
  fetched_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_weather_alerts_state_county ON weather_alerts(state_code, county, fetched_at);
CREATE INDEX IF NOT EXISTS idx_weather_alerts_alert_id ON weather_alerts(alert_id);

CREATE TABLE IF NOT EXISTS lost_found_posts (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL CHECK (type IN ('lost', 'found')),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  county TEXT NOT NULL,
  state_code TEXT NOT NULL DEFAULT 'KY',
  contact_email_encrypted TEXT NOT NULL,
  show_contact INTEGER NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  submitted_at TEXT NOT NULL DEFAULT (datetime('now')),
  approved_at TEXT,
  rejected_at TEXT,
  is_resolved INTEGER NOT NULL DEFAULT 0,
  resolved_at TEXT,
  resolved_note TEXT,
  expires_at TEXT NOT NULL,
  moderation_note TEXT
);

CREATE INDEX IF NOT EXISTS idx_lost_found_posts_status ON lost_found_posts(status, submitted_at);
CREATE INDEX IF NOT EXISTS idx_lost_found_posts_county ON lost_found_posts(state_code, county, status);

CREATE TABLE IF NOT EXISTS lost_found_images (
  id TEXT PRIMARY KEY,
  post_id TEXT NOT NULL,
  r2_key TEXT NOT NULL,
  width INTEGER,
  height INTEGER,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_lost_found_images_post_id ON lost_found_images(post_id);

CREATE TABLE IF NOT EXISTS lost_found_reports (
  id TEXT PRIMARY KEY,
  post_id TEXT NOT NULL,
  reason TEXT NOT NULL,
  reporter_ip_hash TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_lost_found_reports_post_id ON lost_found_reports(post_id, created_at);

CREATE TABLE IF NOT EXISTS lost_found_comments (
  id TEXT PRIMARY KEY,
  post_id TEXT NOT NULL,
  commenter_name TEXT NOT NULL,
  commenter_email_encrypted TEXT NOT NULL,
  commenter_email_hash TEXT NOT NULL,
  comment_text TEXT NOT NULL,
  url_count INTEGER NOT NULL DEFAULT 0,
  commenter_ip_hash TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (post_id) REFERENCES lost_found_posts(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_lost_found_comments_post_created ON lost_found_comments(post_id, created_at);
CREATE INDEX IF NOT EXISTS idx_lost_found_comments_ip_created ON lost_found_comments(commenter_ip_hash, created_at);

CREATE TABLE IF NOT EXISTS lost_found_comment_bans (
  id TEXT PRIMARY KEY,
  target_type TEXT NOT NULL CHECK (target_type IN ('email', 'ip')),
  target_hash TEXT NOT NULL,
  reason TEXT,
  banned_by_email TEXT NOT NULL,
  source_comment_id TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(target_type, target_hash),
  FOREIGN KEY (source_comment_id) REFERENCES lost_found_comments(id) ON DELETE SET NULL
);

CREATE INDEX IF NOT EXISTS idx_lost_found_comment_bans_created ON lost_found_comment_bans(created_at);

CREATE TABLE IF NOT EXISTS admin_audit_log (
  id TEXT PRIMARY KEY,
  actor_email TEXT NOT NULL,
  action TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,
  payload_json TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_admin_audit_created ON admin_audit_log(created_at);
`);

db.close();
console.log("✅ DB reset:", dbPath);

```

# scripts\seed-feeds.mjs

```mjs
import fs from "node:fs";
import path from "node:path";
import Database from "better-sqlite3";

const root = path.resolve(process.cwd());
const seedPath = path.join(root, "feeds.seed.json");
const masterDbPath = path.join(root, "Kentucky News Master Database");
const dbPath = path.join(root, "data", "dev.sqlite");

if (!fs.existsSync(seedPath)) {
  console.error("Missing feeds.seed.json");
  process.exit(1);
}
if (!fs.existsSync(dbPath)) {
  console.error("Missing DB. Run: npm run db:reset");
  process.exit(1);
}

const baseFeeds = JSON.parse(fs.readFileSync(seedPath, "utf-8"));

function slugify(input) {
  return String(input || "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "")
    .slice(0, 96);
}

function canonicalizeSourceUrl(raw) {
  try {
    const u = new URL(String(raw || "").trim());
    u.protocol = "https:";
    u.hash = "";
    u.search = "";
    u.username = "";
    u.password = "";
    u.hostname = u.hostname.toLowerCase().replace(/^www\./, "");
    u.pathname = (u.pathname || "/").replace(/\/+$/, "") || "/";
    return u.toString();
  } catch {
    return null;
  }
}

function canonicalizeFeedUrl(raw) {
  try {
    const u = new URL(String(raw || "").trim());
    u.protocol = "https:";
    u.hash = "";
    u.username = "";
    u.password = "";
    u.hostname = u.hostname.toLowerCase().replace(/^www\./, "");
    if (u.pathname.length > 1) u.pathname = u.pathname.replace(/\/+$/, "");
    return u.toString();
  } catch {
    return String(raw || "").trim();
  }
}

function extractMasterSourceUrls(filePath) {
  if (!fs.existsSync(filePath)) return [];
  const raw = fs.readFileSync(filePath, "utf-8");
  const matches = raw.match(/https?:\/\/[^\s<>"')\]]+/gi) || [];
  const unique = new Set();
  for (const m of matches) {
    const cleaned = String(m || "").replace(/[),.;]+$/, "");
    const canonical = canonicalizeSourceUrl(cleaned);
    if (canonical) unique.add(canonical);
  }
  return [...unique];
}

function buildMasterWatchFeed(sourceUrl) {
  const source = new URL(sourceUrl);
  const host = source.hostname.replace(/^www\./, "");
  const pathPart = source.pathname && source.pathname !== "/" ? source.pathname : "";
  const sourceKey = `${host}${pathPart}`;
  const id = `ky-master-${slugify(sourceKey)}`;
  const searchQuery = `site:${sourceKey} Kentucky`;

  return {
    id,
    name: `Master Watch: ${sourceKey}`,
    category: "Kentucky - Master Sources",
    url: `https://www.bing.com/news/search?q=${encodeURIComponent(searchQuery)}&format=rss`,
    state_code: "KY",
    region_scope: "ky",
    enabled: 1
  };
}

function mergeFeeds(base, masterDerived) {
  const merged = [];
  const seenIds = new Set();
  const seenUrls = new Set();

  function pushFeed(feed) {
    const row = { ...feed };
    let id = String(row.id || "").trim();
    if (!id) return;

    let counter = 2;
    while (seenIds.has(id)) {
      id = `${row.id}-${counter}`;
      counter += 1;
    }
    row.id = id;

    const canonicalUrl = canonicalizeFeedUrl(row.url);
    if (!canonicalUrl || seenUrls.has(canonicalUrl)) return;
    row.url = canonicalUrl;

    seenIds.add(row.id);
    seenUrls.add(canonicalUrl);
    merged.push(row);
  }

  for (const feed of base) pushFeed(feed);
  for (const feed of masterDerived) pushFeed(feed);
  return merged;
}

const masterSourceUrls = extractMasterSourceUrls(masterDbPath);
const masterDerivedFeeds = masterSourceUrls.map(buildMasterWatchFeed);
const feeds = mergeFeeds(baseFeeds, masterDerivedFeeds);
const db = new Database(dbPath);
const feedCols = db.prepare("PRAGMA table_info(feeds)").all().map((r) => r.name);
if (!feedCols.includes("default_county")) {
  db.prepare("ALTER TABLE feeds ADD COLUMN default_county TEXT").run();
}
if (!feedCols.includes("fetch_mode")) {
  db.prepare("ALTER TABLE feeds ADD COLUMN fetch_mode TEXT NOT NULL DEFAULT 'rss'").run();
}
if (!feedCols.includes("scraper_id")) {
  db.prepare("ALTER TABLE feeds ADD COLUMN scraper_id TEXT").run();
}

const upsert = db.prepare(`
INSERT INTO feeds (id, name, category, url, state_code, default_county, region_scope, fetch_mode, scraper_id, enabled)
VALUES (
  @id,
  @name,
  @category,
  @url,
  COALESCE(@state_code, 'KY'),
  @default_county,
  COALESCE(@region_scope, 'ky'),
  COALESCE(@fetch_mode, 'rss'),
  @scraper_id,
  COALESCE(@enabled, 1)
)
ON CONFLICT(id) DO UPDATE SET
  name=excluded.name,
  category=excluded.category,
  url=excluded.url,
  state_code=excluded.state_code,
  default_county=excluded.default_county,
  region_scope=excluded.region_scope,
  fetch_mode=excluded.fetch_mode,
  scraper_id=excluded.scraper_id,
  enabled=excluded.enabled
`);

const seedIds = feeds.map((f) => f.id);
const deleteStale =
  seedIds.length > 0
    ? db.prepare(
        `DELETE FROM feeds WHERE id NOT IN (${seedIds.map((_, idx) => `@id${idx}`).join(", ")})`
      )
    : db.prepare("DELETE FROM feeds");

const tx = db.transaction((rows) => {
  for (const f of rows) {
    upsert.run({
      default_county: null,
      fetch_mode: "rss",
      scraper_id: null,
      ...f
    });
  }
  const staleParams = {};
  seedIds.forEach((id, idx) => {
    staleParams[`id${idx}`] = id;
  });
  deleteStale.run(staleParams);
});

tx(feeds);
db.close();

const derivedAdded = Math.max(0, feeds.length - baseFeeds.length);
console.log(
  `✅ Seeded feeds: ${feeds.length} total (${baseFeeds.length} base + ${derivedAdded} master-derived from ${masterSourceUrls.length} master sources)`
);

```

# src\App.jsx

```jsx
import React from 'react'

export default function App() {
  return (
    <div style={{ fontFamily: 'sans-serif', padding: 20 }}>
      <h1>Local KY News</h1>
      <p>Basic React app scaffold.</p>
    </div>
  )
}

```

# src\index.css

```css
body {
  margin: 0;
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
}

```

# src\main.jsx

```jsx
import React from 'react'
import { createRoot } from 'react-dom/client'
import App from './App'
import './index.css'

createRoot(document.getElementById('root')).render(<App />)

```

# web\ads.txt

```txt
google.com, pub-9584112930078020, DIRECT, f08c47fec0942fa0

```


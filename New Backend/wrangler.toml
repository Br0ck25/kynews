# wrangler.toml — Cloudflare Worker: KY News Ingestion v2
# D1 Database ID: f1669001-2a51-4114-a84e-73cfa7f1c584

name = "ky-news-ingestion"
main = "cf-worker/index.mjs"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]

# ─── D1 Database ─────────────────────────────────────────────────────────────
[[d1_databases]]
binding = "DB"
database_name = "ky-news"
database_id = "f1669001-2a51-4114-a84e-73cfa7f1c584"

# Apply migrations:
#   wrangler d1 migrations apply ky-news
# Or run SQL directly:
#   wrangler d1 execute ky-news --file migrations/ingestion-v3.sql

# ─── Workers AI ──────────────────────────────────────────────────────────────
[ai]
binding = "AI"

# ─── KV: Feed ETag / Last-Modified cache ─────────────────────────────────────
[[kv_namespaces]]
binding = "FEED_CACHE"
id = "YOUR_KV_NAMESPACE_ID"

# ─── KV: Recent MinHash signatures (avoids D1 reads for dedup) ───────────────
[[kv_namespaces]]
binding = "MINHASH_CACHE"
id = "YOUR_MINHASH_KV_ID"

# ─── Environment Variables ────────────────────────────────────────────────────
[vars]
INGEST_CONCURRENCY      = "4"
MAX_ITEMS_PER_FEED      = "50"
CF_SUMMARY_MODEL        = "@cf/zai-org/glm-4.7-flash"
BODY_WORKER_BATCH       = "10"
BODY_WORKER_CONCURRENCY = "3"
ALERT_ON_BREAKING       = "true"
ALERT_COOLDOWN_HOURS    = "6"
COVERAGE_GAP_HOURS      = "48"

# ─── Secrets (set via: wrangler secret put <NAME>) ───────────────────────────
# FB_APP_TOKEN         — Facebook Graph API long-lived token
# SLACK_WEBHOOK_URL    — Slack Incoming Webhook URL
# ALERT_EMAIL_TO       — Alert recipient email
# ALERT_EMAIL_FROM     — Alert sender (must be verified in ESP)
# POSTMARK_API_TOKEN   — Postmark token (for email alerts)
# MAILGUN_API_KEY      — Mailgun key (alternative)
# MAILGUN_DOMAIN       — Mailgun sending domain

# ─── Cron Triggers ───────────────────────────────────────────────────────────
[triggers]
crons = [
  "*/15 * * * *",   # Feed ingestion every 15 min
  "*/5 * * * *",    # Body + AI worker every 5 min
  "0 */6 * * *",    # School calendar sync every 6 hours
  "0 8 * * *",      # Legislature bill scraper daily at 8am UTC
  "0 4 * * *",      # Coverage gap check + alerting daily at 4am UTC
  "0 3 * * 0",      # RSS discovery scan weekly Sunday 3am UTC
  "0 6 * * *",      # Bing fallback feed sync daily at 6am UTC
]

# ─── Observability ───────────────────────────────────────────────────────────
[observability]
enabled = true
